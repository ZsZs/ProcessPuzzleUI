<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
   <title>WebUIcontroller.js test page</title>
   <META http-equiv="Content-Type" content="text/html; charset=UTF-8">
   <META HTTP-EQUIV="CACHE-CONTROL" CONTENT="NO-CACHE">
	   
   <script type="text/javascript">
      var contextRootPrefix = "../../../";
   </script>

   <link rel="stylesheet" type="text/css" href="../../JsUnit/css/jsUnitStyle.css">
   
   <!--[if IE]>
      <script type="text/javascript" src="../../Libraries/MochaUI/excanvas.js"></script>
   <![endif]-->  
   
   <script type="text/javascript" src="../../Libraries/JsHamcrest/jshamcrest.js"></script>
   <script type="text/javascript" src="../../Libraries/JsMockito/JsMockito.js"></script>
   <script type="text/javascript" src="../../Libraries/Log4JavaScript/log4javascript.js"></script>
   <script type="text/javascript" src="../../Libraries/MooTools/mootools-core-1.4.0-full-compat.js"></script>
   <script type="text/javascript" src="../../Libraries/MooTools/mootools-more-1.4.0.1.js"></script>
   <script type="text/javascript" src="../../JsUnit/app/jsUnitCore.js"></script>
   <script type="text/javascript" src="../../JsUnit/app/JsTestCase.js"></script>
   <script type="text/javascript" src="../../JsUnit/app/JsTestFunction.js"></script>

   <script type="text/javascript" src="../../Libraries/MochaUI/Core.js"></script>
   <script type="text/javascript" src="../../Libraries/MochaUI/Dock.js"></script>
   <script type="text/javascript" src="../../Libraries/MochaUI/Layout.js"></script>
   <script type="text/javascript" src="../../Libraries/MochaUI/Tabs.js"></script>
   <script type="text/javascript" src="../../Libraries/MochaUI/Window.js"></script>
   <script type="text/javascript" src="../../Libraries/MochaUI/Modal.js"></script>
   <script type="text/javascript" src="../../Libraries/MooEditable/MooEditable.js"></script>
   <script type="text/javascript" src="../../Libraries/MooEditable/MooEditable.Extras.js"></script>
   <script type="text/javascript" src="../../Libraries/RemoteStyleSheet/RemoteStyleSheet.js"></script>
   <script type="text/javascript" src="../../Libraries/Sarissa/sarissa.js"></script>  
   <script type="text/javascript" src="../../Libraries/Sarissa/sarissa_ieemu_xpath.js"></script>
   <script type="text/javascript" src="../../Libraries/XMLforScript/xmlIO.js"></script>
   <script type="text/javascript" src="../../Libraries/XMLforScript/xmlEscape.js"></script>
   <script type="text/javascript" src="../../Libraries/XMLforScript/xmlsax.js"></script>
   <script type="text/javascript" src="../../Libraries/XMLforScript/preMadeSaxEventHandler.js"></script>

   <script type="text/javascript" src="../../Source/FundamentalTypes/TimeOutBehaviour.js"></script>
   <script type="text/javascript" src="../../Source/FundamentalTypes/WebUIException.js"></script>
   <script type="text/javascript" src="../../Source/Singleton/Singleton.js"></script>
   <script type="text/javascript" src="../../Source/WebUIConfiguration/WebUIConfiguration.js"></script>
   <script type="text/javascript" src="../../Source/WebUIMessageBus/WebUIMessage.js"></script>
    
   <script type="text/javascript" src="../../Source/AbstractDocument/AbstractDocument.js"></script>
   <script type="text/javascript" src="../../Source/BrowserWidget/BrowserWidget.js"></script>
   <script type="text/javascript" src="../../Source/BrowserWidget/WidgetElementFactory.js"></script> 
   <script type="text/javascript" src="../../Source/BrowserWidget/UnconfiguredWidgetException.js"></script>
   <script type="text/javascript" src="../../Source/ComponentStateManager/DefaultStateUriTransformer.js"></script>
   <script type="text/javascript" src="../../Source/ComponentStateManager/ComponentStateManager.js"></script>
   <script type="text/javascript" src="../../Source/Desktop/ComplexContentBehaviour.js"></script>
   <script type="text/javascript" src="../../Source/Desktop/ConfigurationTimeoutException.js"></script>
   <script type="text/javascript" src="../../Source/Desktop/Desktop.js"></script>
   <script type="text/javascript" src="../../Source/Desktop/DesktopElement.js"></script>
   <script type="text/javascript" src="../../Source/Desktop/DesktopElementFactory.js"></script>
   <script type="text/javascript" src="../../Source/Desktop/DesktopDocument.js"></script>
   <script type="text/javascript" src="../../Source/Desktop/DesktopContentArea.js"></script>
   <script type="text/javascript" src="../../Source/Desktop/DesktopColumn.js"></script>
   <script type="text/javascript" src="../../Source/Desktop/DesktopFooter.js"></script>
   <script type="text/javascript" src="../../Source/Desktop/DesktopHeader.js"></script>
   <script type="text/javascript" src="../../Source/Desktop/DesktopPanel.js"></script>
   <script type="text/javascript" src="../../Source/Desktop/DesktopPanelHeader.js"></script>
   <script type="text/javascript" src="../../Source/Desktop/DesktopWindow.js"></script>
   <script type="text/javascript" src="../../Source/Desktop/NoneExistingDesktopContainerElementException.js"></script>
   <script type="text/javascript" src="../../Source/Desktop/plugins/tree/scripts/tree.js"></script>
   <script type="text/javascript" src="../../Source/Desktop/ResourceNotFoundException.js"></script>
   <script type="text/javascript" src="../../Source/Desktop/WindowDocker.js"></script>
   <script type="text/javascript" src="../../Source/DocumentEditor/DocumentEditor.js"></script>
   <script type="text/javascript" src="../../Source/FundamentalTypes/ArrayList.js"></script>
   <script type="text/javascript" src="../../Source/FundamentalTypes/HashMap.js"></script>
   <script type="text/javascript" src="../../Source/FundamentalTypes/IllegalArgumentException.js"></script>
   <script type="text/javascript" src="../../Source/FundamentalTypes/JavaCompatibility.js"></script>
   <script type="text/javascript" src="../../Source/FundamentalTypes/LinkedHashMap.js"></script>
   <script type="text/javascript" src="../../Source/FundamentalTypes/OptionsResource.js"></script>
   <script type="text/javascript" src="../../Source/FundamentalTypes/RemoteResource.js"></script>
   <script type="text/javascript" src="../../Source/FundamentalTypes/StringTokenizer.js"></script>
   <script type="text/javascript" src="../../Source/FundamentalTypes/TimeOutException.js"></script>
   <script type="text/javascript" src="../../Source/FundamentalTypes/UniqueId.js"></script>
   <script type="text/javascript" src="../../Source/FundamentalTypes/XmlResource.js"></script>
   <script type="text/javascript" src="../../Source/HierarchicalMenuWidget/HierarchicalMenuWidget.js"></script>
   <script type="text/javascript" src="../../Source/HierarchicalMenuWidget/MenuSelectedMessage.js"></script>
   <script type="text/javascript" src="../../Source/HtmlDocument/HtmlDocument.js"></script>
   <script type="text/javascript" src="../../Source/Internationalization/Locale.js"></script>
   <script type="text/javascript" src="../../Source/Internationalization/LocaleUtil.js"></script>
   <script type="text/javascript" src="../../Source/Internationalization/ResourceKey.js"></script>
   <script type="text/javascript" src="../../Source/Internationalization/ResourceCache.js"></script>
   <script type="text/javascript" src="../../Source/Internationalization/XMLBundleParser.js"></script>
   <script type="text/javascript" src="../../Source/Internationalization/XMLResourceBundle.js"></script>
   <script type="text/javascript" src="../../Source/LanguageSelectorWidget/LanguageChangedMessage.js"></script>
   <script type="text/javascript" src="../../Source/LanguageSelectorWidget/LanguageSelectorWidget.js"></script>
   <script type="text/javascript" src="../../Source/ResourceManager/DocumentResource.js"></script>
   <script type="text/javascript" src="../../Source/ResourceManager/DocumentImage.js"></script>
   <script type="text/javascript" src="../../Source/ResourceManager/DocumentScript.js"></script>
   <script type="text/javascript" src="../../Source/ResourceManager/DocumentStyleSheet.js"></script>
   <script type="text/javascript" src="../../Source/ResourceManager/ResourceManager.js"></script>
   <script type="text/javascript" src="../../Source/SkinSelectorWidget/SkinChangedMessage.js"></script>
   <script type="text/javascript" src="../../Source/SkinSelectorWidget/SkinSelectorWidget.js"></script>
   <script type="text/javascript" src="../../Source/SmartDocument/DocumentElement.js"></script>
   <script type="text/javascript" src="../../Source/SmartDocument/DocumentElementFactory.js"></script>
   <script type="text/javascript" src="../../Source/SmartDocument/DocumentElementEditor.js"></script>
   <script type="text/javascript" src="../../Source/SmartDocument/DocumentElementEditorFactory.js"></script>
   <script type="text/javascript" src="../../Source/SmartDocument/DataElementBehaviour.js"></script>
   <script type="text/javascript" src="../../Source/SmartDocument/DataElement.js"></script>
   <script type="text/javascript" src="../../Source/SmartDocument/DataElementEditor.js"></script>
   <script type="text/javascript" src="../../Source/SmartDocument/CompositeDocumentElement.js"></script>
   <script type="text/javascript" src="../../Source/SmartDocument/CompositeDataElement.js"></script>
   <script type="text/javascript" src="../../Source/SmartDocument/DocumentBody.js"></script>
   <script type="text/javascript" src="../../Source/SmartDocument/DocumentElementFactory.js"></script>
   <script type="text/javascript" src="../../Source/SmartDocument/DocumentHeader.js"></script>
   <script type="text/javascript" src="../../Source/SmartDocument/DocumentFooter.js"></script>
   <script type="text/javascript" src="../../Source/SmartDocument/DocumentPlugin.js"></script>
   <script type="text/javascript" src="../../Source/SmartDocument/SmartDocument.js"></script>
   <script type="text/javascript" src="../../Source/TabWidget/DuplicatedTabException.js"></script>
   <script type="text/javascript" src="../../Source/TabWidget/Tab.js"></script>
   <script type="text/javascript" src="../../Source/TabWidget/TabSelectedMessage.js"></script>
   <script type="text/javascript" src="../../Source/TabWidget/TabWidget.js"></script>
   <script type="text/javascript" src="../../Source/TextAreaEditor/MooEditableDialog.js"></script>
   <script type="text/javascript" src="../../Source/TextAreaEditor/TextAreaEditor.js"></script>
   <script type="text/javascript" src="../../Source/ToolBarWidget/ToolBarButton.js"></script>
   <script type="text/javascript" src="../../Source/ToolBarWidget/ToolBarDivider.js"></script>
   <script type="text/javascript" src="../../Source/ToolBarWidget/ToolBarButtonFactory.js"></script>
   <script type="text/javascript" src="../../Source/ToolBarWidget/ToolBarWidget.js"></script>
   <script type="text/javascript" src="../../Source/WebUIController/WebUIController.js"></script>
   <script type="text/javascript" src="../../Source/WebUILogger/WebUILogger.js"></script>
   <script type="text/javascript" src="../../Source/WebUIController/WebUIStateRestoredMessage.js"></script>
   <script type="text/javascript" src="../../Source/WebUIMessageBus/TestMessageOne.js"></script>
   <script type="text/javascript" src="../../Source/WebUIMessageBus/TestMessageTwo.js"></script>
   <script type="text/javascript" src="../../Source/WebUIMessageBus/WebUIMessageBus.js"></script>
	
   <script type="text/javascript" >
      window.addEvent('domready', function() {
         //test_changeLanguage_reConstructsTheDesktopWithNewLocale();
      });
  	  
      JsHamcrest.Integration.JsUnit();
		
      var CONFIGURATION_URI = "../WebUIController/SampleConfiguration.xml";
      var DESKTOP_CONTAINER_ELEMENT_ID = "desktopContainer";
      var SAMPLE_DOCUMENT_ONE = "../WebUIController/Content/SampleContentOne.xml";
      var componentStateManager = null;
      var controller;
      var docSelectorDiv = document.getElementById("DocumentSelector");
      var docViewSelectorDiv = document.getElementById("DocumentViewSelector");
      var infoPanelSelectorDiv = document.getElementById("InfoPanelSelector");
      var messageBus = null;
      var menuDiv = document.getElementById("RightMenu");
      var testCaseChain = new Chain();
      var testCaseIsRunning = false;
      var testWindow;
		
      function runTestCase(){
         if( !testCaseIsRunning ) testCaseChain.callChain();
      }
      
      function beforeEachTest() {
         inform( "beforeEachTest" );
			
         messageBus = new WebUIMessageBus();
         controller = new WebUIController({ contextRootPrefix : "../../", configurationUri : CONFIGURATION_URI, onConfigured : onConfigured } );
         componentStateManager = Class.getInstanceOf( ComponentStateManager );
         
         testCaseIsRunning = true;
         testCaseChain.callChain();
      }

      function onConfigured(){
         testCaseChain.callChain();
      }
	      
      function afterEachTest(){
         controller.destroy();
         componentStateManager.reset();
         messageBus.tearDown();
			
         window.location.hash = "";

         inform( "afterEachTest" );
         testCaseIsRunning = false;
         testCaseChain.callChain();
      };
		
      function test_initialize_instantiatesComponents() {
         testCaseChain.chain(
            beforeEachTest,
            function(){
               assertTrue( "WebUIController...", true );
               assertNotNull( "... instantiates WebUIMessageBus.", controller.getMessageBus() );
               assertNotNull( "... instantiates ComponentStateManager.", controller.getStateManager() );
               assertFalse( "... initialization doesn't configure the browser front-end.", controller.getIsConfigured() );
               testCaseChain.callChain();
            },
            afterEachTest
         );
         runTestCase();
      }
		
      function test_configure() {
         testCaseChain.chain(
            beforeEachTest,
            function(){
               controller.configure();
            },
            function(){
               assertTrue( "When WebUIController is configured...", true );
               assertNotNull( "... loads configuration.", controller.getWebUIConfiguration() );
               assertNotNull( "... initializes a logger.", controller.getLogger() );
               assertEquals( "... initializes with default locale.", "hu", controller.getCurrentLocale().getLanguage() );
               assertNotNull( "... loads resource bundles.", controller.getResourceBundle() );
            
               assertTrue( "... the whole browser front-end is configured.", controller.isConfigured );
               assertThat( controller.getDesktop().getState(), equalTo( DesktopElement.States.CONSTRUCTED ) ); 
               assertEquals( "... registers itself to 'SkinChangedMessage'.", controller.webUIMessageHandler, messageBus.getSubscribersToMessage( SkinChangedMessage ).get(0) );
               assertEquals( "... registers itself to 'LanguageChangedMessage'.", controller.webUIMessageHandler, messageBus.getSubscribersToMessage( LanguageChangedMessage ).get(0) );
               testCaseChain.callChain();
            },
            afterEachTest
         );
         runTestCase();
      }
		
      function test_changeLanguage_reConstructsTheDesktopWithNewLocale() {
         testCaseChain.chain(
            beforeEachTest,
            function(){
               controller.configure();
            },
            function(){
               assertThat( controller.getCurrentLocale().getLanguage(), equalTo( 'hu' ));

               var noneDefaultLanguage = new Locale({ language : 'en' });
               controller.changeLanguage( noneDefaultLanguage );
            },
            function(){
               assertThat( controller.getCurrentLocale().getLanguage(), equalTo( 'en' ));
               assertThat( controller.isConfigured, is( true ));
               testCaseChain.callChain();
            },
            afterEachTest
         );
         runTestCase();
      }
		
      function test_changeSkin_reConstructsTheDesktopWithNewSkin() {
         testCaseChain.chain(
            beforeEachTest,
            function(){
               controller.configure();
            },
            function(){
               assertThat( controller.getCurrentSkin(), equalTo( 'ProcessPuzzle' ));

               controller.changeSkin( 'MochaUI' );
            },
            function(){
               assertThat( controller.getCurrentSkin(), equalTo( 'MochaUI' ));
               assertThat( controller.isConfigured, is( true ));
               testCaseChain.callChain();
            },
            afterEachTest
         );
         runTestCase();
      }
      
      function test_destroy_destroysAllHtmlElementsAndEvents(){
         testCaseChain.chain(
            beforeEachTest,
            function(){
               controller.configure();
            },
            function(){
               controller.destroy();
			
               assertTrue( "After WebUIController.destoy()...", true );
               assertFalse( "... not regarded to be configured.", controller.isConfigured );
               assertThat( controller.getDesktop().getState(), equalTo( Desktop.States.INITIALIZED ));
               assertFalse( "... WebUIConfiguration is not loaded.", controller.getWebUIConfiguration().isLoaded );
               assertFalse( "... XMLResourcebundle is not loaded.", controller.getResourceBundle().isLoaded );
               assertEquals( "tears down message bus.", 0, controller.getMessageBus().getMessageListSize() );
               assertThat( $( DESKTOP_CONTAINER_ELEMENT_ID ).getChildren( '*' ).length, equalTo( 0 ));
               testCaseChain.callChain.delay( 1000, this );
            },
            afterEachTest
         );
         runTestCase();
      }
		
      function test_loadDocument_publishesMenuSelectedMessage() {
         testCaseChain.chain(
            beforeEachTest,
            function(){
               controller.configure();
            },
            function(){
               controller.getMessageBus().subscribeToMessage( MenuSelectedMessage, function( webUIMessage ){
                  assertThat( webUIMessage.getDocumentURI(), equalTo( SAMPLE_DOCUMENT_ONE ));
               });
               
               controller.loadDocument( SAMPLE_DOCUMENT_ONE, AbstractDocument.Types.HTML );

               testCaseChain.callChain.delay( 500, this );
            },
            afterEachTest
         );
         runTestCase();
      }
		
      function test_RestoreStateFromUrl() {
         if( Browser.chrome || Browser.safary ) return; //Unfotunatelly Chrome and Safari dosn't handles location.hash of frames well.
         testCaseChain.chain(
            beforeEachTest,
            function(){
               controller.configure();
            },
            function(){
               //EXCERCISE:
               testWindow.location.hash = "!" + "WebUIController: {locale: 'hu'}; HierarchicalMenuWidget: {currentItemId: 'mainItemThree', contextItemId: 'MenuWidget'}";
               controller.restoreStateFromUrl();
			
               //VERIFY:
               assertEquals( "mainItemThree", componentStateManager.retrieveCurrentState( "HierarchicalMenuWidget" )['currentItemId'] );
               assertTrue( instanceOf( messageBus.getLastMessage(), WebUIStateRestoredMessage ));
               testCaseChain.callChain();
            },
            afterEachTest
         );
         runTestCase();
      }
		
      function testStoreStateInUrl() {
         if( Browser.chrome || Browser.safary ) return; //Unfotunatelly Chrome and Safari dosn't handles location.hash of frames well.
         testCaseChain.chain(
            beforeEachTest,
            function(){
               controller.configure();
            },
            function(){
               //EXCERCISE:
               controller.storeStateInUrl();
			
               //VERIFY:
               assertTrue( "storeStateInUrl()...", true );
               assertEquals( "...stores current document (relative) uri in location hash.", testWindow.location.hash.substring(2), controller.getStateManager().toString() );
               testCaseChain.callChain();
            },
            afterEachTest
         );
         runTestCase();
      }
      
      function testWebUIMessageHandler_WhenLanguageChangedMessage_Broadcasted() {
         testCaseChain.chain(
            beforeEachTest,
            function(){
               controller.configure();
            },
            function(){
               controller.loadDocument({ documentURI : 'Content/SampleContentOne' });
			
               //EXCERCISE:
               var previousLocale = controller.getCurrentLocale();
               var newLocale = new Locale({ language : 'en' });
               var message = new LanguageChangedMessage({newLocale : newLocale, previousLocale : previousLocale, originator : 'WebUIControllerTest' });
               messageBus.notifySubscribers( message );
			
               //VERIFY:
               assertEquals( "Given locale becomes the current.", 'en', controller.getCurrentLocale().getLanguage() );
               assertEquals( "... current document remains", 'Content/SampleContentOne', controller.currentDocumentProperties['documentURI'] );
               testCaseChain.callChain();
            },
            afterEachTest
         );
         runTestCase();
      }
		
      function test_webUIMessageHandler_whenLoadDocumentAction_loadsDocument() {
         testCaseChain.chain(
            beforeEachTest,
            function(){
               controller.configure();
            },
            function(){
               //EXCERCISE:
               var message = new MenuSelectedMessage({actionType : 'loadDocument', documentURI : SAMPLE_DOCUMENT_ONE });
               messageBus.notifySubscribers( message );
			
               //VERIFY:
               var documentsPanel = $('documents-panel');
               assertTrue( "After WebUIController.loadDocument()...", true );
               assertEquals( "... stores current document URI", SAMPLE_DOCUMENT_ONE, controller.currentDocumentProperties['documentURI'] );
               //assertEquals( "... adds page content.", "Minta tartalom - 1", Sarissa.getText( documentsPanel.getElements( "H1" )[0] ));
               testCaseChain.callChain();
            },
            afterEachTest
         );
         runTestCase();
      }
		
      function testWebUIMessageHandler_WhenSkinChangedMessage_Broadcasted() {
         testCaseChain.chain(
            beforeEachTest,
            function(){
               controller.configure();
            },
            function(){
               controller.loadDocument({ documentURI : 'Content/SampleContentOne' });
			
               //EXCERCISE:
               var previousSkin = controller.getCurrentSkin();
               var message = new SkinChangedMessage({newSkin : 'MochaUI', previousSkin : previousSkin, originator : 'WebUIControllerTest' });
               messageBus.notifySubscribers( message );
			
               //VERIFY:
               assertEquals( "Given skin becomes the current.", 'MochaUI', controller.getCurrentSkin() );
               assertEquals( "... current document remains", 'Content/SampleContentOne', controller.currentDocumentProperties['documentURI'] );
               testCaseChain.callChain();
            },
            afterEachTest
         );
         runTestCase();
      }
		
      function eventHandlerOne( eventMessage ){
         if( instanceOf( eventMessage, TestMessageTwo ) )
            eventHandlerTwoWasCalled = true;
      }
      
	</script>
</head>

<body>
	<div id='desktopContainer'></div>
</body>
</html>