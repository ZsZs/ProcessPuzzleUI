<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
   <title>Test page for LanguageSelectorWiget.js</title>
   <meta http-equiv="content-type" content="text/html; charset=UTF-8">

   <link rel="stylesheet" type="text/css" href="../../JsUnit/css/jsUnitStyle.css">
   
   <script type="text/javascript">
      var contextRootPrefix = "../../../";
   </script>
   
   <script type="text/javascript">
      var contextRootPrefix = "../../../";
   </script>
   
   <!--[if IE]>
      <script type="text/javascript" src="../../Libraries/MochaUI/excanvas.js"></script>
   <![endif]-->  
   
   <script type="text/javascript" src="../../Libraries/JsHamcrest/jshamcrest.js"></script>
   <script type="text/javascript" src="../../Libraries/JsMockito/JsMockito.js"></script>
   <script type="text/javascript" src="../../Libraries/Log4JavaScript/log4javascript.js"></script>
   <script type="text/javascript" src="../../Libraries/MooTools/mootools-core-1.4.0-full-compat.js"></script>
   <script type="text/javascript" src="../../Libraries/MooTools/mootools-more-1.4.0.1.js"></script>
   <script type="text/javascript" src="../../JsUnit/app/jsUnitCore.js"></script>
   <script type="text/javascript" src="../../JsUnit/app/JsTestCase.js"></script>
   <script type="text/javascript" src="../../JsUnit/app/JsTestFunction.js"></script>

   <script type="text/javascript" src="../../Libraries/Sarissa/sarissa.js"></script>  
   <script type="text/javascript" src="../../Libraries/Sarissa/sarissa_ieemu_xpath.js"></script>
   <script type="text/javascript" src="../../Libraries/Log4JavaScript/log4javascript.js"></script>
   <script type="text/javascript" src="../../Libraries/XMLforScript/xmlIO.js"></script>
   <script type="text/javascript" src="../../Libraries/XMLforScript/xmlEscape.js"></script>
   <script type="text/javascript" src="../../Libraries/XMLforScript/xmlsax.js"></script>
   <script type="text/javascript" src="../../Libraries/XMLforScript/preMadeSaxEventHandler.js"></script>

   <script type="text/javascript" src="../../Source/Singleton/Singleton.js"></script>
   <script type="text/javascript" src="../../Source/WebUIMessageBus/WebUIMessage.js"></script>
   
   <script type="text/javascript" src="../../Source/BrowserWidget/BrowserWidget.js"></script>
   <script type="text/javascript" src="../../Source/BrowserWidget/WidgetConstructedMessage.js"></script> 
   <script type="text/javascript" src="../../Source/BrowserWidget/WidgetElementFactory.js"></script>
   <script type="text/javascript" src="../../Source/FundamentalTypes/ArrayList.js"></script>
   <script type="text/javascript" src="../../Source/ComponentStateManager/DefaultStateUriTransformer.js"></script>
   <script type="text/javascript" src="../../Source/ComponentStateManager/ComponentStateManager.js"></script>
   <script type="text/javascript" src="../../Source/FundamentalTypes/StringTokenizer.js"></script>
   <script type="text/javascript" src="../../Source/FundamentalTypes/HashMap.js"></script>
   <script type="text/javascript" src="../../Source/FundamentalTypes/JavaCompatibility.js"></script>
   <script type="text/javascript" src="../../Source/FundamentalTypes/XmlResource.js"></script>
   <script type="text/javascript" src="../../Source/Internationalization/Locale.js"></script>
   <script type="text/javascript" src="../../Source/Internationalization/LocaleUtil.js"></script>
   <script type="text/javascript" src="../../Source/Internationalization/ResourceKey.js"></script>
   <script type="text/javascript" src="../../Source/Internationalization/ResourceCache.js"></script>
   <script type="text/javascript" src="../../Source/Internationalization/XMLBundleParser.js"></script>
   <script type="text/javascript" src="../../Source/Internationalization/XMLResourceBundle.js"></script>
   <script type="text/javascript" src="../../Source/WebUIConfiguration/WebUIConfiguration.js"></script>
   <script type="text/javascript" src="../../Source/WebUIController/WebUIController.js"></script>
   <script type="text/javascript" src="../../Source/WebUILogger/WebUILogger.js"></script>
   <script type="text/javascript" src="../../Source/WebUIMessageBus/WebUIMessage.js"></script>
   <script type="text/javascript" src="../../Source/WebUIMessageBus/WebUIMessageBus.js"></script>
   
   <script type="text/javascript" src="../../Source/LanguageSelectorWidget/LanguageChangedMessage.js"></script>
   <script type="text/javascript" src="../../Source/LanguageSelectorWidget/LanguageSelectorWidget.js"></script>

   <script type="text/javascript">
   window.addEvent('domready', function() {
      runTestFunction();
   });

   JsHamcrest.Integration.JsUnit();
   
   var CONFIGURATION_URI = "../WebUIController/SampleConfiguration.xml";
   var ELEMENT_SELECTOR = "LanguageSelector";
   var LANGUAGE = "hu";
   var WIDGET_CONTAINER_ID = "LanguageSelectorWidget";
   var callBackMessage;
   var callBackWasCalled = false;
   var componentStateManager;
   var languageSelector;
   var locale = new Locale({ language : LANGUAGE });
   var messageBus;
   var webUIConfiguration;
   var webUIController;
   var webUILogger;
   var widgetContainerElement;
   
   function setUp() {
      messageBus = new WebUIMessageBus();
      webUIConfiguration = new WebUIConfiguration( CONFIGURATION_URI );
      webUILogger = new WebUILogger( webUIConfiguration );
      componentStateManager = new ComponentStateManager();
      resourceBundle = new XMLResourceBundle( webUIConfiguration );
      resourceBundle.load( locale );
      languageSelector = new LanguageSelectorWidget({ widgetContainerId : WIDGET_CONTAINER_ID }, resourceBundle, webUIConfiguration );
      widgetContainerElement = languageSelector.getContainerElement();

      callBackWasCalled = false;
   }

   function tearDown() {
      messageBus.tearDown();
      callBackWasCalled = false;
      callBackMessage = null;
   }

   function test_initialization_WhenConstructorArgumentsAreGiven() {
      assertEquals( $( WIDGET_CONTAINER_ID ), languageSelector.getContainerElement() );
      assertEquals( "Initialization determines available locales.", 2, languageSelector.getAvailableLocales().size() ); 
      assertEquals( "hu", languageSelector.getAvailableLocales().get( 0 ).getLanguage() );
      assertEquals( "en", languageSelector.getAvailableLocales().get( 1 ).getLanguage() );
      assertEquals( "GB", languageSelector.getAvailableLocales().get( 1 ).getCountry() );
   }
   
   function test_initialization_WhenConstructorArgumentsAreMissing() {
      //SETUP:
      var webUIController = new WebUIController({ configurationUri : "../WebUIController/SampleConfiguration.xml" });
      
      //EXCERCISE:
      var languageSelector = new LanguageSelectorWidget();
      
      //VERIFY:
      assertTrue( "When 'LanguageSelector' is instantiated without arguments, 'WebUIController' is used as data source.", true );
      assertEquals( webUIController.getResourceBundle(), languageSelector.getResourceBundle() );
      assertEquals( webUIController.getWebUIConfiguration(), languageSelector.getWebUIConfiguration() );
      assertEquals( 2, languageSelector.getAvailableLocales().size() );
      
      //TEARDOWN:
      languageSelector.destroy();
      webUIController.destroy();
   }
   
   function test_configure_CreatesSelectElementWithOptions() {
      //SETUP:
      //EXCERCISE:
      languageSelector.construct();
      
      //VERIFY:
      var selectElement = widgetContainerElement.getElementById( ELEMENT_SELECTOR );
      assertNotNull( selectElement );
      assertEquals( "The number of options elements:", 3, selectElement.getChildren().length );
      //assertEquals( languageSelector.onSelection, selectElement.hasEvent( 'change' ));
   }
   
   function test_destory_destroysCreatedHtmlElements(){
      languageSelector.construct();
      languageSelector.destroy();
      
      assertThat( widgetContainerElement.getChildren( '*' ).length, equalTo( 0 ));
   }
   
   function test_onSelection_NotifiesMessageBusSubscribers() {
      //SETUP:
      languageSelector.construct();
      messageBus.subscribeToMessage( LanguageChangedMessage, onLanguageChangeCallback );
      
      //EXCERCISE:
      var selectElement = widgetContainerElement.getElementById( ELEMENT_SELECTOR );
   	  selectElement.fireEvent( 'change' );
   	  
      //VERIFY:
   	  assertTrue( callBackWasCalled );
   	  assertEquals( "en", callBackMessage.getNewLocale().getLanguage() );
   }
   
   function onLanguageChangeCallback( message ) {
	  callBackWasCalled = true;
	  callBackMessage = message;
   }
      
   //runs a test function during debugging
   function runTestFunction(){
      setUp();
      test_initialization_WhenConstructorArgumentsAreGiven();
      tearDown();
   }
   </script>
</head>

<body>
   <h1>LanguageSelectorWidget.js test page</h1>
   <div id="LanguageSelectorWidget"></div>
</body>
</html>
