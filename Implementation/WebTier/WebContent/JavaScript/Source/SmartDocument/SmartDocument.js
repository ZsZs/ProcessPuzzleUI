/*Name: SmartDocumentDescription: Represents a document of a Panel. Reads it's own structure and content from xml files and constructs HTML based on them.Requires:Provides:    - SmartDocumentPart of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. http://www.processpuzzle.comAuthors:     - Zsolt ZsuffaCopyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation, either version 3 of the License, or (at your option) any later version.This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty ofMERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.*/var SmartDocument = new Class({   Implements : [Events, Options],   Binds : ['constructBody',             'constructFooter',             'constructHeader',             'determineContainerElement',             'loadResources',             'onBodyConstructed',             'onConstructionError',            'onFooterConstructed',             'onHeaderConstructed',            'onResourceError',            'onResourcesLoaded'],      options : {      componentName : "SmartDocument",      descriptionSelector : "smartDocumentDefinition/description",      documentContentUri : "DocumentContent.xml",      documentDefinitionUri : "DocumentDefinition.xml",      bodySelector : "smartDocumentDefinition/documentBody",      footerSelector : "smartDocumentDefinition/documentFooter",      headerSelector : "smartDocumentDefinition/documentHeader",      nameSelector : "smartDocumentDefinition/name",      resourcesSelector : "smartDocumentDefinition/resources",      versionSelector : "smartDocumentDefinition/version",      widgetContainerId : "SmartDocument"   },      //Constructor   initialize : function( i18Resource, options ) {      this.setOptions( options );      this.constructionChain = new Chain();      this.documentBody = null;      this.documentFooter = null;      this.documentHeader = null;      this.containerElement;      this.description = null;      this.documentData;      this.documentDefinition;      this.error = null;      this.i18Resource = i18Resource;      this.name = null;      this.resources = null;      this.state = SmartDocument.States.UNINITIALIZED;      this.version = null;            this.loadDocumentDefinition();      this.loadDocumentData();      this.state = SmartDocument.States.INITIALIZED;   },   //Public accesors and mutators   construct: function(){      this.constructionChain.chain(         this.determineContainerElement,         this.loadResources,         this.constructHeader,         this.constructBody,         this.constructFooter      ).callChain();   },      destroy: function() {      if( this.resources ) this.resources.release();      if( this.documentHeader ) this.documentHeader.destroy();      if( this.documentBody ) this.documentBody.destroy();      if( this.documentFooter ) this.documentFooter.destroy();      this.constructionChain.clearChain();      this.state = SmartDocument.States.INITIALIZED;   },      onBodyConstructed: function(){      this.constructionChain.callChain();   },      onConstructionError: function( error ){      if( error ) this.error = error;      this.revertConstruction();      this.fireEvent( 'documentError', this.error );   },      onFooterConstructed: function(){      this.state = SmartDocument.States.CONSTRUCTED;      this.fireEvent('documentReady', this );      this.constructionChain.callChain();   },      onHeaderConstructed: function(){      this.constructionChain.callChain();   },      onResourceError: function( error ){      this.error = error;   },      onResourcesLoaded: function(){      if( this.resources.isSuccess() ) this.constructionChain.callChain();      else this.onConstructionError();   },      unmarshall: function(){      this.unmarshallDocumentDefinition();      this.unmarshallResources();      this.documentHeader = this.unmarshallDocumentComponent( this.options.headerSelector, { onConstructed : this.onHeaderConstructed, onConstructionError : this.onConstructionError } );      this.documentBody = this.unmarshallDocumentComponent( this.options.bodySelector, { onConstructed : this.onBodyConstructed, onConstructionError : this.onConstructionError } );      this.documentFooter = this.unmarshallDocumentComponent( this.options.footerSelector, { onConstructed : this.onFooterConstructed, onConstructionError : this.onConstructionError } );      this.state = SmartDocument.States.UNMARSHALLED;   },      //Properties   getBody: function() { return this.documentBody; },   getContainerElement: function() { return this.containerElement; },   getDescription: function() { return this.description; },   getDocumentData: function() { return this.documentData; },   getDocumentDefinition: function() { return this.documentDefinition; },   getError: function() { return this.error; },   getFooter: function() { return this.documentFooter; },   getHeader: function() { return this.documentHeader; },   getName: function() { return this.name; },   getResources: function() { return this.resources; },   getState: function() { return this.state; },   getVersion: function() { return this.version; },   isSuccess: function() { return this.error == null; },      //Protected, private helper methods   constructBody : function(){      if( this.documentBody ) this.documentBody.construct( this.containerElement, 'bottom' );      else this.constructionChain.callChain();   }.protect(),      constructFooter: function(){      if( this.documentFooter ) this.documentFooter.construct( this.containerElement, 'bottom' );      else this.onFooterConstructed();   }.protect(),      constructHeader: function(){      if( this.documentHeader ) this.documentHeader.construct( this.containerElement, 'bottom' );      else this.constructionChain.callChain();   }.protect(),      determineContainerElement: function(){      this.containerElement = $( this.options.widgetContainerId );      this.constructionChain.callChain();   }.protect(),      loadDocumentData: function() {      if( this.options.documentContentUri ) this.documentData = new XmlResource( this.options.documentContentUri );   }.protect(),      loadDocumentDefinition: function() {      if( this.options.documentDefinitionUri ) this.documentDefinition = new XmlResource( this.options.documentDefinitionUri );      else throw new IllegalArgumentException( 'SmartDocument.options.documentDefinitionUri', this.options.documentDefinitionUri );   }.protect(),      loadResources: function(){      if( this.resources ) this.resources.load();      else this.constructionChain.callChain();   }.protect(),      revertConstruction: function(){      if( this.resources ) this.resources.release();      if( this.documentHeader ) this.documentHeader.destroy();      if( this.documentBody ) this.documentBody.destroy();      if( this.documentFooter ) this.documentFooter.destroy();      this.state = SmartDocument.States.INITIALIZED;   }.protect(),      unmarshallDocumentComponent: function( selector, options ){      var documentComponent = null;      var componentDefinition = this.documentDefinition.selectNode( selector );      if( componentDefinition ) documentComponent = DocumentElementFactory.create( componentDefinition, this.i18Resource, this.documentData, options );      if( documentComponent ) documentComponent.unmarshall();      return documentComponent;   }.protect(),      unmarshallDocumentDefinition: function(){      this.description = this.documentDefinition.selectNodeText( this.options.descriptionSelector );      this.name = this.documentDefinition.selectNodeText( this.options.nameSelector );      this.version = this.documentDefinition.selectNodeText( this.options.versionSelector );   }.protect(),      unmarshallResources: function(){      var resourcesElement = this.documentDefinition.selectNode( this.options.resourcesSelector );      if( resourcesElement ){         this.resources = new ResourceManager( resourcesElement, { onResourcesLoaded : this.onResourcesLoaded, onResourceError : this.onResourceError } );         this.resources.unmarshall();      }   }.protect()});SmartDocument.States = { UNINITIALIZED : 0, INITIALIZED : 1, UNMARSHALLED : 2, CONSTRUCTED : 3 };SmartDocument.Types = { HTML : 0, SMART : 1 };