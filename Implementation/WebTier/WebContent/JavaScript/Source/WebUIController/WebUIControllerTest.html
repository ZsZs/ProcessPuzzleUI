<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
   <title>WebUIcontroller.js test page</title>
   <META http-equiv="Content-Type" content="text/html; charset=UTF-8">
   <META HTTP-EQUIV="CACHE-CONTROL" CONTENT="NO-CACHE">
	
   <link type="text/css" rel="stylesheet" href="../JsUnit/css/jsUnitStyle.css">
   
   <script type="text/javascript" src="../JsUnit/app/jsUnitCore.js"></script>
   
   <script type="text/javascript">
      var contextRootPrefix = "../../../";
   </script>

   <!--[if IE]>
      <script type="text/javascript" src="../../Libraries/MochaUI/excanvas.js"></script>
   <![endif]-->  
   
   <script type="text/javascript" src="../../Libraries/JsHamcrest/jshamcrest.js"></script>
   <script type="text/javascript" src="../../Libraries/Log4JavaScript/log4javascript.js"></script>
   <script type="text/javascript" src="../../Libraries/MooTools/mootools-core-1.4.0-full-compat.js"></script>
   <script type="text/javascript" src="../../Libraries/MooTools/mootools-more-1.4.0.1.js"></script>
   <script type="text/javascript" src="../../Libraries/MochaUI/Core.js"></script>
   <script type="text/javascript" src="../../Libraries/MochaUI/Dock.js"></script>
   <script type="text/javascript" src="../../Libraries/MochaUI/Layout.js"></script>
   <script type="text/javascript" src="../../Libraries/MochaUI/Tabs.js"></script>
   <script type="text/javascript" src="../../Libraries/MochaUI/Window.js"></script>
   <script type="text/javascript" src="../../Libraries/MochaUI/Modal.js"></script>
   <script type="text/javascript" src="../../Libraries/RemoteStyleSheet/RemoteStyleSheet.js"></script>
   <script type="text/javascript" src="../../Libraries/Sarissa/sarissa.js"></script>  
   <script type="text/javascript" src="../../Libraries/Sarissa/sarissa_ieemu_xpath.js"></script>
   <script type="text/javascript" src="../../Libraries/XMLforScript/xmlIO.js"></script>
   <script type="text/javascript" src="../../Libraries/XMLforScript/xmlEscape.js"></script>
   <script type="text/javascript" src="../../Libraries/XMLforScript/xmlsax.js"></script>
   <script type="text/javascript" src="../../Libraries/XMLforScript/preMadeSaxEventHandler.js"></script>

   <script type="text/javascript" src="../FundamentalTypes/TimeOutBehaviour.js"></script>
   <script type="text/javascript" src="../FundamentalTypes/WebUIException.js"></script>
   <script type="text/javascript" src="../Singleton/Singleton.js"></script>
   <script type="text/javascript" src="../WebUIMessageBus/WebUIMessage.js"></script>
    
   <script type="text/javascript" src="../AbstractDocument/AbstractDocument.js"></script>
   <script type="text/javascript" src="../BrowserWidget/BrowserWidget.js"></script>
   <script type="text/javascript" src="../BrowserWidget/WidgetElementFactory.js"></script> 
   <script type="text/javascript" src="../BrowserWidget/UnconfiguredWidgetException.js"></script>
   <script type="text/javascript" src="../ComponentStateManager/DefaultStateUriTransformer.js"></script>
   <script type="text/javascript" src="../ComponentStateManager/ComponentStateManager.js"></script>
   <script type="text/javascript" src="../Desktop/ComplexContentBehaviour.js"></script>
   <script type="text/javascript" src="../Desktop/ConfigurationTimeoutException.js"></script>
   <script type="text/javascript" src="../Desktop/Desktop.js"></script>
   <script type="text/javascript" src="../Desktop/DesktopElement.js"></script>
   <script type="text/javascript" src="../Desktop/DesktopElementFactory.js"></script>
   <script type="text/javascript" src="../Desktop/DesktopDocument.js"></script>
   <script type="text/javascript" src="../Desktop/DesktopContentArea.js"></script>
   <script type="text/javascript" src="../Desktop/DesktopColumn.js"></script>
   <script type="text/javascript" src="../Desktop/DesktopFooter.js"></script>
   <script type="text/javascript" src="../Desktop/DesktopHeader.js"></script>
   <script type="text/javascript" src="../Desktop/DesktopPanel.js"></script>
   <script type="text/javascript" src="../Desktop/DesktopPanelHeader.js"></script>
   <script type="text/javascript" src="../Desktop/DesktopWindow.js"></script>
   <script type="text/javascript" src="../Desktop/NoneExistingDesktopContainerElementException.js"></script>
   <script type="text/javascript" src="../Desktop/plugins/tree/scripts/tree.js"></script>
   <script type="text/javascript" src="../Desktop/ResourceNotFoundException.js"></script>
   <script type="text/javascript" src="../Desktop/WindowDocker.js"></script>
   <script type="text/javascript" src="../DocumentManager/DocumentManager.js"></script>
   <script type="text/javascript" src="../FundamentalTypes/ArrayList.js"></script>
   <script type="text/javascript" src="../FundamentalTypes/HashMap.js"></script>
   <script type="text/javascript" src="../FundamentalTypes/IllegalArgumentException.js"></script>
   <script type="text/javascript" src="../FundamentalTypes/JavaCompatibility.js"></script>
   <script type="text/javascript" src="../FundamentalTypes/LinkedHashMap.js"></script>
   <script type="text/javascript" src="../FundamentalTypes/OptionsResource.js"></script>
   <script type="text/javascript" src="../FundamentalTypes/RemoteResource.js"></script>
   <script type="text/javascript" src="../FundamentalTypes/StringTokenizer.js"></script>
   <script type="text/javascript" src="../FundamentalTypes/TimeOutException.js"></script>
   <script type="text/javascript" src="../FundamentalTypes/UniqueId.js"></script>
   <script type="text/javascript" src="../FundamentalTypes/XmlResource.js"></script>
   <script type="text/javascript" src="../HierarchicalMenuWidget/HierarchicalMenuWidget.js"></script>
   <script type="text/javascript" src="../HierarchicalMenuWidget/MenuSelectedMessage.js"></script>
   <script type="text/javascript" src="../Internationalization/Locale.js"></script>
   <script type="text/javascript" src="../Internationalization/LocaleUtil.js"></script>
   <script type="text/javascript" src="../Internationalization/ResourceKey.js"></script>
   <script type="text/javascript" src="../Internationalization/ResourceCache.js"></script>
   <script type="text/javascript" src="../Internationalization/XMLBundleParser.js"></script>
   <script type="text/javascript" src="../Internationalization/XMLResourceBundle.js"></script>
   <script type="text/javascript" src="../LanguageSelectorWidget/LanguageChangedMessage.js"></script>
   <script type="text/javascript" src="../LanguageSelectorWidget/LanguageSelectorWidget.js"></script>
   <script type="text/javascript" src="../ResourceManager/DocumentResource.js"></script>
   <script type="text/javascript" src="../ResourceManager/DocumentImage.js"></script>
   <script type="text/javascript" src="../ResourceManager/DocumentScript.js"></script>
   <script type="text/javascript" src="../ResourceManager/DocumentStyleSheet.js"></script>
   <script type="text/javascript" src="../ResourceManager/ResourceManager.js"></script>
   <script type="text/javascript" src="../SkinSelectorWidget/SkinChangedMessage.js"></script>
   <script type="text/javascript" src="../SkinSelectorWidget/SkinSelectorWidget.js"></script>
   <script type="text/javascript" src="../SmartDocument/DocumentElement.js"></script>
   <script type="text/javascript" src="../SmartDocument/DocumentElementFactory.js"></script>
   <script type="text/javascript" src="../SmartDocument/DocumentElementEditor.js"></script>
   <script type="text/javascript" src="../SmartDocument/DocumentElementEditorFactory.js"></script>
   <script type="text/javascript" src="../SmartDocument/DataElementBehaviour.js"></script>
   <script type="text/javascript" src="../SmartDocument/DataElement.js"></script>
   <script type="text/javascript" src="../SmartDocument/DataElementEditor.js"></script>
   <script type="text/javascript" src="../SmartDocument/CompositeDocumentElement.js"></script>
   <script type="text/javascript" src="../SmartDocument/CompositeDataElement.js"></script>
   <script type="text/javascript" src="../SmartDocument/DocumentBody.js"></script>
   <script type="text/javascript" src="../SmartDocument/DocumentElementFactory.js"></script>
   <script type="text/javascript" src="../SmartDocument/DocumentHeader.js"></script>
   <script type="text/javascript" src="../SmartDocument/DocumentFooter.js"></script>
   <script type="text/javascript" src="../SmartDocument/DocumentPlugin.js"></script>
   <script type="text/javascript" src="../SmartDocument/SmartDocument.js"></script>
   <script type="text/javascript" src="../TabWidget/DuplicatedTabException.js"></script>
   <script type="text/javascript" src="../TabWidget/Tab.js"></script>
   <script type="text/javascript" src="../TabWidget/TabSelectedMessage.js"></script>
   <script type="text/javascript" src="../TabWidget/TabWidget.js"></script>
   <script type="text/javascript" src="../ToolBarWidget/ToolBarButton.js"></script>
   <script type="text/javascript" src="../ToolBarWidget/ToolBarDivider.js"></script>
   <script type="text/javascript" src="../ToolBarWidget/ToolBarButtonFactory.js"></script>
   <script type="text/javascript" src="../ToolBarWidget/ToolBarWidget.js"></script>
   <script type="text/javascript" src="../WebUIConfiguration/WebUIConfiguration.js"></script>
   <script type="text/javascript" src="../WebUIController/WebUIController.js"></script>
   <script type="text/javascript" src="../WebUILogger/WebUILogger.js"></script>
   <script type="text/javascript" src="../WebUIController/WebUIStateRestoredMessage.js"></script>
   <script type="text/javascript" src="../WebUIMessageBus/TestMessageOne.js"></script>
   <script type="text/javascript" src="../WebUIMessageBus/TestMessageTwo.js"></script>
   <script type="text/javascript" src="../WebUIMessageBus/WebUIMessageBus.js"></script>
	
   <script type="text/javascript" >
      window.addEvent('domready', function() {
         //test_initialize_instantiatesComponents();
         //test_configure();
         test_changeLanguage();
      });
  	  
      JsHamcrest.Integration.JsUnit();
		
      var CONFIGURATION_URI = "../WebUIController/SampleConfiguration.xml";
      var DESKTOP_CONTAINER_ELEMENT_ID = "desktopContainer";
      var SAMPLE_DOCUMENT_ONE = "../WebUIController/Content/SampleContentOne";
      var componentStateManager = null;
      var controller;
      var docSelectorDiv = document.getElementById("DocumentSelector");
      var docViewSelectorDiv = document.getElementById("DocumentViewSelector");
      var infoPanelSelectorDiv = document.getElementById("InfoPanelSelector");
      var messageBus = null;
      var menuDiv = document.getElementById("RightMenu");
      var testCaseChain = new Chain();
      var testCaseIsRunning = false;
      var testWindow;
		
      function runTestCase(){
         if( !testCaseIsRunning ) testCaseChain.callChain();
         else runTestCase.delay( 500, this );
      }
      
      function beforeEachTest() {
         inform( "beforeEachTest" );
			
         messageBus = new WebUIMessageBus();
         controller = new WebUIController({ contextRootPrefix : "../../", configurationUri : CONFIGURATION_URI, onConfigured : onConfigured } );
         componentStateManager = Class.getInstanceOf( ComponentStateManager );
         
         testCaseIsRunning = true;
         testCaseChain.callChain();
      }

      function onConfigured(){
         testCaseChain.callChain();
      }
	      
      function afterEachTest(){
         controller.destroy();
         componentStateManager.reset();
         messageBus.tearDown();
			
         window.location.hash = "";

         inform( "afterEachTest" );
         testCaseIsRunning = false;
         testCaseChain.callChain();
      };
		
      function test_initialize_instantiatesComponents() {
         testCaseChain.chain(
            beforeEachTest,
            function(){
               assertTrue( "WebUIController...", true );
               assertNotNull( "... instantiates WebUIMessageBus.", controller.getMessageBus() );
               assertNotNull( "... instantiates ComponentStateManager.", controller.getStateManager() );
               assertFalse( "... initialization doesn't configure the browser front-end.", controller.getIsConfigured() );
               testCaseChain.callChain();
            },
            afterEachTest
         );
         runTestCase();
      }
		
      function test_configure() {
         testCaseChain.chain(
            beforeEachTest,
            function(){
               controller.configure();
            },
            function(){
               assertTrue( "When WebUIController is configured...", true );
               assertNotNull( "... loads configuration.", controller.getWebUIConfiguration() );
               assertNotNull( "... initializes a logger.", controller.getLogger() );
               assertEquals( "... initializes with default locale.", "hu", controller.getCurrentLocale().getLanguage() );
               assertNotNull( "... loads resource bundles.", controller.getResourceBundle() );
            
               //assertTrue( "... Language Selector is configured.", controller.getLanguageSelector().isConfigured );
               assertThat( controller.getDesktop().getState(), equalTo( DesktopElement.States.CONSTRUCTED ) ); 
               assertTrue( "... the whole browser front-end is configured.", controller.isConfigured );

               assertEquals( "... registers itself to 'SkinChangedMessage'.", controller.webUIMessageHandler, messageBus.getSubscribersToMessage( SkinChangedMessage ).get(0) );
               assertEquals( "... registers itself to 'LanguageChangedMessage'.", controller.webUIMessageHandler, messageBus.getSubscribersToMessage( LanguageChangedMessage ).get(0) );
            
               assertEquals( "... instantiates a configures DocumentManager.", Class.getInstanceOf( DocumentManager ), controller.getDocumentManager() );
               testCaseChain.callChain();
            },
            afterEachTest
         );
         runTestCase();
      }
		
      function test_changeLanguage() {
         testCaseChain.chain(
            beforeEachTest,
            function(){
               controller.configure();
            },
            function(){
               controller.loadDocument({ documentURI : 'Content/SampleContentOne' });
			
               var noneDefaultLanguage = new Locale({ language : 'en' });
               controller.changeLanguage( noneDefaultLanguage );
			
               assertEquals( "Given locale becomes the current.", noneDefaultLanguage, controller.getCurrentLocale() );
               assertEquals( "... current document remains", 'Content/SampleContentOne', controller.currentDocumentProperties['documentURI'] );
               //assertEquals( "... but is presented in the changed language.", "Sample Content One", $('documents-panel').getElements( "H1" )[0].childNodes[0].nodeValue );
               testCaseChain.callChain();
            },
            afterEachTest
         );
         runTestCase();
      }
		
      function test_Destroy(){
         testCaseChain.chain(
            beforeEachTest,
            function(){
               controller.getMessageBus().subscribeToMessage( TestMessageOne, eventHandlerOne );
               controller.configure();
            },
            function(){
               debug( "before destroy()" );
               controller.destroy();
			
               debug( "destroy() verification started." );
               assertTrue( "After WebUIController.destoy()...", true );
               assertFalse( "... not regarded to be configured.", controller.isConfigured );
               debug( "Desktop state: " + controller.getDesktop().getState() );
               assertThat( controller.getDesktop().getState(), equalTo( Desktop.States.INITIALIZED ));
               assertFalse( "... WebUIConfiguration is not loaded.", controller.getWebUIConfiguration().isLoaded );
               assertFalse( "... XMLResourcebundle is not loaded.", controller.getResourceBundle().isLoaded );
               assertEquals( "tears down message bus.", 0, controller.getMessageBus().getMessageListSize() );
               assertThat( $( DESKTOP_CONTAINER_ELEMENT_ID ).getChildren( '*' ).length, equalTo( 0 ));
               debug( "destroy() verification finished." );
               testCaseChain.callChain.delay( 1000, this );
            },
            afterEachTest
         );
         runTestCase();
      }
		
      function test_LoadDocument() {
         testCaseChain.chain(
            beforeEachTest,
            function(){
               controller.configure();
            },
            function(){
               controller.loadDocument({ documentURI : SAMPLE_DOCUMENT_ONE });

               var documentsPanel = $('documents-panel');
               assertTrue( "After WebUIController.loadDocument()...", true );
               assertEquals( "... stores current document URI", SAMPLE_DOCUMENT_ONE, controller.currentDocumentProperties['documentURI'] );
               //assertEquals( "... adds page content.", "Minta tartalom - 1", Sarissa.getText( documentsPanel.getElements( "H1" )[0] ));
               testCaseChain.callChain();
            },
            afterEachTest
         );
         runTestCase();
      }
		
      function test_RestoreStateFromUrl() {
         if( Browser.chrome || Browser.safary ) return; //Unfotunatelly Chrome and Safari dosn't handles location.hash of frames well.
         testCaseChain.chain(
            beforeEachTest,
            function(){
               controller.configure();
            },
            function(){
               //EXCERCISE:
               testWindow.location.hash = "!" + "WebUIController: {locale: 'hu'}; HierarchicalMenuWidget: {currentItemId: 'mainItemThree', contextItemId: 'MenuWidget'}";
               controller.restoreStateFromUrl();
			
               //VERIFY:
               assertEquals( "mainItemThree", componentStateManager.retrieveCurrentState( "HierarchicalMenuWidget" )['currentItemId'] );
               assertTrue( instanceOf( messageBus.getLastMessage(), WebUIStateRestoredMessage ));
               testCaseChain.callChain();
            },
            afterEachTest
         );
         runTestCase();
      }
		
      function testStoreStateInUrl() {
         if( Browser.chrome || Browser.safary ) return; //Unfotunatelly Chrome and Safari dosn't handles location.hash of frames well.
         testCaseChain.chain(
            beforeEachTest,
            function(){
               controller.configure();
            },
            function(){
               //EXCERCISE:
               controller.storeStateInUrl();
			
               //VERIFY:
               assertTrue( "storeStateInUrl()...", true );
               assertEquals( "...stores current document (relative) uri in location hash.", testWindow.location.hash.substring(2), controller.getStateManager().toString() );
               testCaseChain.callChain();
            },
            afterEachTest
         );
         runTestCase();
      }
      
      function testWebUIMessageHandler_WhenLanguageChangedMessage_Broadcasted() {
         testCaseChain.chain(
            beforeEachTest,
            function(){
               controller.configure();
            },
            function(){
               controller.loadDocument({ documentURI : 'Content/SampleContentOne' });
			
               //EXCERCISE:
               var previousLocale = controller.getCurrentLocale();
               var newLocale = new Locale({ language : 'en' });
               var message = new LanguageChangedMessage({newLocale : newLocale, previousLocale : previousLocale, originator : 'WebUIControllerTest' });
               messageBus.notifySubscribers( message );
			
               //VERIFY:
               assertEquals( "Given locale becomes the current.", 'en', controller.getCurrentLocale().getLanguage() );
               assertEquals( "... current document remains", 'Content/SampleContentOne', controller.currentDocumentProperties['documentURI'] );
               testCaseChain.callChain();
            },
            afterEachTest
         );
         runTestCase();
      }
		
      function test_webUIMessageHandler_whenLoadDocumentAction_loadsDocument() {
         testCaseChain.chain(
            beforeEachTest,
            function(){
               controller.configure();
            },
            function(){
               //EXCERCISE:
               var message = new MenuSelectedMessage({actionType : 'loadDocument', documentURI : SAMPLE_DOCUMENT_ONE });
               messageBus.notifySubscribers( message );
			
               //VERIFY:
               var documentsPanel = $('documents-panel');
               assertTrue( "After WebUIController.loadDocument()...", true );
               assertEquals( "... stores current document URI", SAMPLE_DOCUMENT_ONE, controller.currentDocumentProperties['documentURI'] );
               //assertEquals( "... adds page content.", "Minta tartalom - 1", Sarissa.getText( documentsPanel.getElements( "H1" )[0] ));
               testCaseChain.callChain();
            },
            afterEachTest
         );
         runTestCase();
      }
		
      function testWebUIMessageHandler_WhenSkinChangedMessage_Broadcasted() {
         testCaseChain.chain(
            beforeEachTest,
            function(){
               controller.configure();
            },
            function(){
               controller.loadDocument({ documentURI : 'Content/SampleContentOne' });
			
               //EXCERCISE:
               var previousSkin = controller.getCurrentSkin();
               var message = new SkinChangedMessage({newSkin : 'MochaUI', previousSkin : previousSkin, originator : 'WebUIControllerTest' });
               messageBus.notifySubscribers( message );
			
               //VERIFY:
               assertEquals( "Given skin becomes the current.", 'MochaUI', controller.getCurrentSkin() );
               assertEquals( "... current document remains", 'Content/SampleContentOne', controller.currentDocumentProperties['documentURI'] );
               testCaseChain.callChain();
            },
            afterEachTest
         );
         runTestCase();
      }
		
      function eventHandlerOne( eventMessage ){
         if( instanceOf( eventMessage, TestMessageTwo ) )
            eventHandlerTwoWasCalled = true;
      }
      
	</script>
</head>

<body>
	<div id='desktopContainer'></div>
</body>
</html>