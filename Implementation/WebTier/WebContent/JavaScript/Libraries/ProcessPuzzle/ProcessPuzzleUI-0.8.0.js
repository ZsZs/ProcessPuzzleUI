/*
---

name: Core

script: Core.js

description: MUI - A Web Applications User Interface Framework.

copyright: (c) 2007-2009 Greg Houston, <http://greghoustondesign.com/>.

license: MIT-style license.

authors:
  - Scott F. Frederick
  - Joel Lindau

note:
	This documentation is taken directly from the javascript source files. It is built using Natural Docs.

requires:
  - Core:1.2.4/Array
  - Core:1.2.4/Element
  - Core:1.2.4/Browser
  - Core:1.2.4/Request
  - Core:1.2.4/Request.HTML
  - Hash
  - More:1.2.4/Assets

provides: [MUI, MochaUI, MUI.Require]

...
*/


var MUI = MochaUI = new Hash({
	
	version: '0.9.7',

	options: new Hash({
		theme: 'default',				
		advancedEffects: false, // Effects that require fast browsers and are cpu intensive.
		standardEffects: true   // Basic effects that tend to run smoothly.
	}),

	path: {			
		source:  'scripts/source/', // Path to MochaUI source JavaScript
		themes:  'themes/',         // Path to MochaUI Themes
		plugins: 'plugins/'         // Path to Plugins
	},
	
	// Returns the path to the current theme directory
	themePath: function(){
		return MUI.path.themes + MUI.options.theme + '/'; 
	},
	
	files: new Hash()
	
});

MUI.files[MUI.path.source + 'Core/Core.js'] = 'loaded';

MUI.extend({
	
	Windows: {
		instances: new Hash()
	},

	ieSupport: 'excanvas',  // Makes it easier to switch between Excanvas and Moocanvas for testing	
	
	/*
	
	Function: updateContent
		Replace the content of a window or panel.
		
	Arguments:
		updateOptions - (object)
	
	updateOptions:
		element - The parent window or panel.
		childElement - The child element of the window or panel recieving the content.
		method - ('get', or 'post') The way data is transmitted.
		data - (hash) Data to be transmitted
		title - (string) Change this if you want to change the title of the window or panel.
		content - (string or element) An html loadMethod option.
		loadMethod - ('html', 'xhr', or 'iframe')
		url - Used if loadMethod is set to 'xhr' or 'iframe'.
		scrollbars - (boolean)		
		padding - (object)
		onContentLoaded - (function)

	*/	
	updateContent: function(options){

		var options = $extend({
			element:      null,
			childElement: null,
			method:       null,
			data:         null,
			title:        null,
			content:      null,
			loadMethod:   null,
			url:          null,
			scrollbars:   null,			
			padding:      null,
			require:      {},
			onContentLoaded: $empty
		}, options);		
	
		options.require = $extend({
			css: [], images: [], js: [], onload: null
		}, options.require);		
		
		var args = {};
				
		if (!options.element) return;
		var element = options.element;		

		if (MUI.Windows.instances.get(element.id)){
			args.recipient = 'window';		
		}
		else {
			args.recipient = 'panel';		
		}

		var instance = element.retrieve('instance');
		
		if( options.title ) instance.titleEl.set( 'html', options.title );			

		var contentEl = instance.contentEl;
		args.contentContainer = options.childElement != null ? options.childElement : instance.contentEl;		
		var contentWrapperEl = instance.contentWrapperEl;

		if (!options.loadMethod){
			if (!instance.options.loadMethod){
				if (!options.url){
					options.loadMethod = 'html';
				}
				else {
					options.loadMethod = 'xhr';
				}
			}
			else {	
				options.loadMethod = instance.options.loadMethod;
			}
		}	
				
		// Set scrollbars if loading content in main content container.
		// Always use 'hidden' for iframe windows
		var scrollbars = options.scrollbars || instance.options.scrollbars;
		if (args.contentContainer == instance.contentEl) {
			contentWrapperEl.setStyles({
				'overflow': scrollbars != false && options.loadMethod != 'iframe' ? 'auto' : 'hidden'
			});
		}		

		if (options.padding != null) {
			contentEl.setStyles({
				'padding-top': options.padding.top,
				'padding-bottom': options.padding.bottom,
				'padding-left': options.padding.left,
				'padding-right': options.padding.right
			});
		}

		// Remove old content.
		if (args.contentContainer == contentEl) {
			contentEl.empty().show();			
			// Panels are not loaded into the padding div, so we remove them separately.
			contentEl.getAllNext('.column').destroy();
			contentEl.getAllNext('.columnHandle').destroy();
		}
		
		args.onContentLoaded = function(){
			
			if (options.require.js.length || typeof options.require.onload == 'function'){
				new MUI.Require({
					js: options.require.js,
					onload: function(){
						if (Browser.Engine.presto){
							options.require.onload.delay(100);
						}
						else {
							options.require.onload();
						}
						(options.onContentLoaded && options.onContentLoaded!=$empty) ? options.onContentLoaded() : instance.fireEvent('contentLoaded', element);
					}.bind(this)		
				});
			}		
			else {
                (options.onContentLoaded && options.onContentLoaded!=$empty) ? options.onContentLoaded() : instance.fireEvent('contentLoaded', element);
			}			
		
		};
		
		if (options.require.css.length || options.require.images.length){
			new MUI.Require({
				css: options.require.css,
				images: options.require.images,
				onload: function(){
					this.loadSelect(instance, options, args);
				}.bind(this)		
			});
		}		
		else {
			this.loadSelect(instance, options, args);
		}
	},
	
	loadSelect: function(instance, options, args){					
				
		// Load new content.
		switch(options.loadMethod){
			case 'xhr':			
				this.updateContentXHR(instance, options, args);
				break;
			case 'iframe':
				this.updateContentIframe(instance, options, args);				
				break;
            case 'json':
                this.updateContentJSON(instance, options, args);
                break;
			case 'html':
			default:
				this.updateContentHTML(instance, options, args);
				break;
		}

	},

    updateContentJSON: function(instance, options, args) {
        var contentEl = instance.contentEl;
        var contentContainer = args.contentContainer;

        new Request({
            url: options.url,
            update: contentContainer,
            method: options.method != null ? options.method : 'get',
            data: options.data != null ? new Hash(options.data).toQueryString() : '',
            evalScripts: false,
            evalResponse: false,
            headers: {'Content-Type':'application/json'},
            onRequest: function() {
                if (args.recipient == 'window' && contentContainer == contentEl) {
                    instance.showSpinner();
                }
                else if (args.recipient == 'panel' && contentContainer == contentEl && $('spinner')) {
                    $('spinner').show();
                }
            } .bind(this),
            onFailure: function() {
                if (contentContainer == contentEl) {
                    contentContainer.set('html', '<p><strong>Error Loading XMLHttpRequest</strong></p>');
                    if (recipient == 'window') {
                        instance.hideSpinner();
                    }
                    else if (recipient == 'panel' && $('spinner')) {
                        $('spinner').hide();
                    }
                }

                if (contentContainer == contentEl) {
                    contentContainer.set('html', '<p><strong>Error Loading XMLHttpRequest</strong></p>');
                    if (args.recipient == 'window') {
                        instance.hideSpinner();
                    }
                    else if (args.recipient == 'panel' && $('spinner')) {
                        $('spinner').hide();
                    }
                }
            } .bind(this),
            onException: function() { } .bind(this),
            onSuccess: function(json) {
                if (contentContainer == contentEl) {
                    if (contentContainer == contentEl) {
                        if (args.recipient == 'window') instance.hideSpinner();
                        else if (args.recipient == 'panel' && $('spinner')) $('spinner').hide();
                    }
                    var json = JSON.decode(json);
                    // calls onLoaded event instead of onContentLoaded
                    // onLoaded - event should call updateContent again with loadMethod='html'
                    instance.fireEvent('loaded', $A([options.element, json, instance]));
                }
            } .bind(this),
            onComplete: function() { } .bind(this)
        }).get();
    },
    
	updateContentXHR: function(instance, options, args){
		var contentEl = instance.contentEl;
		var contentContainer = args.contentContainer;
		var onContentLoaded = args.onContentLoaded;
		new Request.HTML({
			url: options.url,
			update: contentContainer,
			method: options.method != null ? options.method : 'get',
			data: options.data != null ? new Hash(options.data).toQueryString() : '', 
			evalScripts: instance.options.evalScripts,
			evalResponse: instance.options.evalResponse,				
			onRequest: function(){
				if (args.recipient == 'window' && contentContainer == contentEl){
					instance.showSpinner();
				}
				else if (args.recipient == 'panel' && contentContainer == contentEl && $('spinner')){
					$('spinner').show();	
				}
			}.bind(this),
			onFailure: function(response){
				if (contentContainer == contentEl){
					var getTitle = new RegExp("<title>[\n\r\s]*(.*)[\n\r\s]*</title>", "gmi");
					var error = getTitle.exec(response.responseText);
					if (!error) error = 'Unknown';							 
					contentContainer.set('html', '<h3>Error: ' + error[1] + '</h3>');
					if (args.recipient == 'window'){
						instance.hideSpinner();
					}							
					else if (args.recipient == 'panel' && $('spinner')){
						$('spinner').hide();
					}						
				}
			}.bind(this),
			onSuccess: function(){
                contentEl.addClass("pad");
				if (contentContainer == contentEl){
					if (args.recipient == 'window') instance.hideSpinner();							
					else if (args.recipient == 'panel' && $('spinner')) $('spinner').hide();							
				}
				Browser.Engine.trident4 ? onContentLoaded.delay(750) : onContentLoaded();
			}.bind(this),
			onComplete: function(){}.bind(this)
		}).send();
	},
	
	updateContentIframe: function(instance, options, args){
		var contentEl = instance.contentEl;
		var contentContainer = args.contentContainer;
		var contentWrapperEl = instance.contentWrapperEl;
		var onContentLoaded = args.onContentLoaded;			
		if ( instance.options.contentURL == '' || contentContainer != contentEl) {
			return;
		}
        contentEl.removeClass("pad");
        contentEl.setStyle("padding","0px");
		instance.iframeEl = new Element('iframe', {
			'id': instance.options.id + '_iframe',
			'name': instance.options.id + '_iframe',
			'class': 'mochaIframe',
			'src': options.url,
			'marginwidth': 0,
			'marginheight': 0,
			'frameBorder': 0,
			'scrolling': 'auto',
			'styles': {
				'height': contentWrapperEl.offsetHeight - contentWrapperEl.getStyle('border-top').toInt() - contentWrapperEl.getStyle('border-bottom').toInt(),
				'width': instance.panelEl ? contentWrapperEl.offsetWidth - contentWrapperEl.getStyle('border-left').toInt() - contentWrapperEl.getStyle('border-right').toInt() : '100%'	
			}
		}).injectInside(contentEl);

		// Add onload event to iframe so we can hide the spinner and run onContentLoaded()
		instance.iframeEl.addEvent('load', function(e) {
			if (args.recipient == 'window') instance.hideSpinner();					
			else if (args.recipient == 'panel' && contentContainer == contentEl && $('spinner')) $('spinner').hide();
			Browser.Engine.trident4 ? onContentLoaded.delay(50) : onContentLoaded();
		}.bind(this));
		if (args.recipient == 'window') instance.showSpinner();				
		else if (args.recipient == 'panel' && contentContainer == contentEl && $('spinner')) $('spinner').show();
	},
	
	updateContentHTML: function(instance, options, args){
		var contentEl = instance.contentEl;
		var contentContainer = args.contentContainer;
		var onContentLoaded = args.onContentLoaded;			
		var elementTypes = new Array('element', 'textnode', 'whitespace', 'collection');

        contentEl.addClass("pad");
		if (elementTypes.contains($type(options.content))){
			options.content.inject(contentContainer);
		} else {
			contentContainer.set('html', options.content);
		}				
		if (contentContainer == contentEl){
			if (args.recipient == 'window') instance.hideSpinner();					
			else if (args.recipient == 'panel' && $('spinner')) $('spinner').hide();									
		}
		Browser.Engine.trident4 ? onContentLoaded.delay(50) : onContentLoaded();
	},
	
	/*
	
	Function: reloadIframe
		Reload an iframe. Fixes an issue in Firefox when trying to use location.reload on an iframe that has been destroyed and recreated.

	Arguments:
		iframe - This should be both the name and the id of the iframe.

	Syntax:
		(start code)
		MUI.reloadIframe(element);
		(end)

	Example:
		To reload an iframe from within another iframe:
		(start code)
		parent.MUI.reloadIframe('myIframeName');
		(end)

	*/
	reloadIframe: function(iframe){
		Browser.Engine.gecko ? $(iframe).src = $(iframe).src : top.frames[iframe].location.reload(true);		
	},
	
	roundedRect: function(ctx, x, y, width, height, radius, rgb, a){
		ctx.fillStyle = 'rgba(' + rgb.join(',') + ',' + a + ')';
		ctx.beginPath();
		ctx.moveTo(x, y + radius);
		ctx.lineTo(x, y + height - radius);
		ctx.quadraticCurveTo(x, y + height, x + radius, y + height);
		ctx.lineTo(x + width - radius, y + height);
		ctx.quadraticCurveTo(x + width, y + height, x + width, y + height - radius);
		ctx.lineTo(x + width, y + radius);
		ctx.quadraticCurveTo(x + width, y, x + width - radius, y);
		ctx.lineTo(x + radius, y);
		ctx.quadraticCurveTo(x, y, x, y + radius);
		ctx.fill(); 
	},
	
	triangle: function(ctx, x, y, width, height, rgb, a){
		ctx.beginPath();
		ctx.moveTo(x + width, y);
		ctx.lineTo(x, y + height);
		ctx.lineTo(x + width, y + height);
		ctx.closePath();
		ctx.fillStyle = 'rgba(' + rgb.join(',') + ',' + a + ')';
		ctx.fill();
	},
	
	circle: function(ctx, x, y, diameter, rgb, a){
		ctx.beginPath();
		ctx.arc(x, y, diameter, 0, Math.PI*2, true);
		ctx.fillStyle = 'rgba(' + rgb.join(',') + ',' + a + ')';
		ctx.fill();
	},
	
	notification: function(message){
			new MUI.Window({
				loadMethod: 'html',
				closeAfter: 1500,
				type: 'notification',
				addClass: 'notification',
				content: message,
				width: 220,
				height: 40,
				y: 53,
				padding:  { top: 10, right: 12, bottom: 10, left: 12 },
				shadowBlur: 5	
			});
	},
	
	/*
	  	
	Function: toggleEffects
		Turn effects on and off

	*/
	toggleAdvancedEffects: function(link){
		if (MUI.options.advancedEffects == false) {
			MUI.options.advancedEffects = true;
			if (link){
				this.toggleAdvancedEffectsLink = new Element('div', {
					'class': 'check',
					'id': 'toggleAdvancedEffects_check'
				}).inject(link);
			}			
		}
		else {
			MUI.options.advancedEffects = false;
			if (this.toggleAdvancedEffectsLink) {
				this.toggleAdvancedEffectsLink.destroy();
			}		
		}
	},
	/*
	  	
	Function: toggleStandardEffects
		Turn standard effects on and off

	*/
	toggleStandardEffects: function(link){
		if (MUI.options.standardEffects == false) {
			MUI.options.standardEffects = true;
			if (link){
				this.toggleStandardEffectsLink = new Element('div', {
					'class': 'check',
					'id': 'toggleStandardEffects_check'
				}).inject(link);
			}			
		}
		else {
			MUI.options.standardEffects = false;
			if (this.toggleStandardEffectsLink) {
				this.toggleStandardEffectsLink.destroy();
			}		
		}
	},			
	
	/*
	
	The underlay is inserted directly under windows when they are being dragged or resized
	so that the cursor is not captured by iframes or other plugins (such as Flash)
	underneath the window.
	
	*/
	underlayInitialize: function(){
	   if( !$( 'windowUnderlay' )){
         var windowUnderlay = new Element('div', {
            'id': 'windowUnderlay',
            'styles': {
               'height': window.getCoordinates().height,
               'opacity': .01,
               'display': 'none'
            }
         }).inject(document.body);
	   }
	},
	setUnderlaySize: function(){
		$('windowUnderlay').setStyle('height', window.getCoordinates().height);
	}
});

/* 

function: fixPNG
	Bob Osola's PngFix for IE6.

example:
	(begin code)
	<img src="xyz.png" alt="foo" width="10" height="20" onload="fixPNG(this)">
	(end)

note:
	You must have the image height and width attributes specified in the markup.

*/

function fixPNG(myImage){
	if (Browser.Engine.trident4 && document.body.filters){
		var imgID = (myImage.id) ? "id='" + myImage.id + "' " : "";
		var imgClass = (myImage.className) ? "class='" + myImage.className + "' " : "";
		var imgTitle = (myImage.title) ? "title='" + myImage.title  + "' " : "title='" + myImage.alt + "' ";
		var imgStyle = "display:inline-block;" + myImage.style.cssText;
		var strNewHTML = "<span " + imgID + imgClass + imgTitle
			+ " style=\"" + "width:" + myImage.width
			+ "px; height:" + myImage.height
			+ "px;" + imgStyle + ";"
			+ "filter:progid:DXImageTransform.Microsoft.AlphaImageLoader"
			+ "(src=\'" + myImage.src + "\', sizingMethod='scale');\"></span>";
		myImage.outerHTML = strNewHTML;		
	}
}

// Blur all windows if user clicks anywhere else on the page
document.addEvent('mousedown', function(event){
	MUI.blurAll.delay(50);
});

window.addEvent('domready', function(){
	MUI.underlayInitialize();
});

window.addEvent('resize', function(){
	if ($('windowUnderlay')) {
		MUI.setUnderlaySize();
	}
	else {
		MUI.underlayInitialize();
	}
});

Element.implement({
	hide: function(){
		this.setStyle('display', 'none');
		return this;
	},
	show: function(){
		this.setStyle('display', 'block');
		return this;
	}	
});	

/*

Shake effect by Uvumi Tools
http://tools.uvumi.com/element-shake.html

Function: shake

Example:
	Shake a window.
	(start code)
	$('parametrics').shake()
	(end)
  
*/

Element.implement({
	shake: function(radius,duration){
		radius = radius || 3;
		duration = duration || 500;
		duration = (duration/50).toInt() - 1;
		var parent = this.getParent();
		if(parent != $(document.body) && parent.getStyle('position') == 'static'){
			parent.setStyle('position','relative');
		}
		var position = this.getStyle('position');
		if(position == 'static'){
			this.setStyle('position','relative');
			position = 'relative';
		}
		if(Browser.Engine.trident){
			parent.setStyle('height',parent.getStyle('height'));
		}
		var coords = this.getPosition(parent);
		if(position == 'relative' && !Browser.Engine.presto){
			coords.x -= parent.getStyle('paddingLeft').toInt();
			coords.y -= parent.getStyle('paddingTop').toInt();
		}
		var morph = this.retrieve('morph');
		if (morph){
			morph.cancel();
			var oldOptions = morph.options;
		}
		var morph = this.get('morph',{
			duration:50,
			link:'chain'
		});
		for(var i=0 ; i < duration ; i++){
			morph.start({
				top:coords.y+$random(-radius,radius),
				left:coords.x+$random(-radius,radius)
			});
		}
		morph.start({
			top:coords.y,
			left:coords.x
		}).chain(function(){
			if(oldOptions){
				this.set('morph',oldOptions);
			}
		}.bind(this));
		return this;
	}
});

String.implement({
 
	parseQueryString: function() {
		var vars = this.split(/[&;]/);
		var rs = {};
		if (vars.length) vars.each(function(val) {
			var keys = val.split('=');
			if (keys.length && keys.length == 2) rs[decodeURIComponent(keys[0])] = decodeURIComponent(keys[1]);
		});
		return rs;
	}
 
});

// Mootools Patch: Fixes issues in Safari, Chrome, and Internet Explorer caused by processing text as XML. 
Request.HTML.implement({
 
	processHTML: function(text){
		var match = text.match(/<body[^>]*>([\s\S]*?)<\/body>/i);
		text = (match) ? match[1] : text;           
		var container = new Element('div');           
		return container.set('html', text);
	}
   
});

/*

	Examples:
		(start code)	
		getCSSRule('.myRule');
		getCSSRule('#myRule');
		(end)
  
*/
MUI.getCSSRule = function(selector) {
	for (var ii = 0; ii < document.styleSheets.length; ii++) {
		var mysheet = document.styleSheets[ii];
		var myrules = mysheet.cssRules ? mysheet.cssRules : mysheet.rules;
		for (i = 0; i < myrules.length; i++){
			if (myrules[i].selectorText == selector){
				return myrules[i];
			}
		}
	}		  
	return false;
}

// This makes it so Request will work to some degree locally
if (location.protocol == "file:"){

	Request.implement({
		isSuccess : function(status){
			return (status == 0 || (status >= 200) && (status < 300));
		}
	});

	Browser.Request = function(){
		return $try(function(){
			return new ActiveXObject('MSXML2.XMLHTTP');
		}, function(){
			return new XMLHttpRequest();
		});
	};
	
}

MUI.Require = new Class({

	Implements: [Options],

	options: {
		css: [],
		images: [],
		js: [],		
		onload: $empty
	},
	
	initialize: function(options){
		this.setOptions(options);
		var options = this.options;		
		
		this.assetsToLoad = options.css.length + options.images.length + options.js.length;		
		this.assetsLoaded = 0;
		
		var cssLoaded = 0;
		
		// Load CSS before images and JavaScript	
				
		if (options.css.length){
			options.css.each( function(sheet){
				
				this.getAsset(sheet, function(){
					if (cssLoaded == options.css.length - 1){
						
						if (this.assetsLoaded == this.assetsToLoad - 1){
							this.requireOnload();
						}
						else {
							// Add a little delay since we are relying on cached CSS from XHR request.
							this.assetsLoaded++;	 					
							this.requireContinue.delay(50, this);
						}				
					}
					else {
						cssLoaded++;
						this.assetsLoaded++;						
					}
				}.bind(this));
			}.bind(this));
		}
		else if (!options.js.length && !options.images.length){
			this.options.onload();
			return true;
		}
		else {
			this.requireContinue.delay(50, this); // Delay is for Safari
		}		
		
	},
	
	requireOnload: function(){
		this.assetsLoaded++;
		if (this.assetsLoaded == this.assetsToLoad){
			this.options.onload();
			return true;				
		}

	},	
	
	requireContinue: function(){

		var options = this.options;
		if (options.images.length){
			options.images.each( function(image){
				this.getAsset(image, this.requireOnload.bind(this));
			}.bind(this));
		}
	
		if (options.js.length){
			options.js.each( function(script){
				this.getAsset(script, this.requireOnload.bind(this));			
			}.bind(this));
		}
	
	},
	
	getAsset: function(source, onload){

		// If the asset is loaded, fire the onload function.
		if ( MUI.files[source] == 'loaded' ){
			if (typeof onload == 'function'){
				onload();
			}
			return true;	
		}
	
		// If the asset is loading, wait until it is loaded and then fire the onload function.
		// If asset doesn't load by a number of tries, fire onload anyway.
		else if ( MUI.files[source] == 'loading' ){
			var tries = 0;
			var checker = (function(){
				tries++;
				if (MUI.files[source] == 'loading' && tries < '100') return;
				$clear(checker);
				if (typeof onload == 'function'){
					onload();
				}
			}).periodical(50);
		}
	
		// If the asset is not yet loaded or loading, start loading the asset.
		else {
			MUI.files[source] = 'loading';	
	
			properties = {
				'onload': onload != 'undefined' ? onload : $empty	
			};	
	
			// Add to the onload function
			var oldonload = properties.onload;
			properties.onload = function() {
				MUI.files[source] = 'loaded';
				if (oldonload) {
						oldonload();
				}	
			}.bind(this);			
	
			switch ( source.match(/\.\w+$/)[0] ) {
				case '.js': return Asset.javascript(source, properties);
				case '.css': return Asset.css(source, properties);
				case '.jpg':
				case '.png':
				case '.gif': return Asset.image(source, properties);
			}
	
			alert('The required file "' + source + '" could not be loaded');
		}
	}			
		
});

$extend(Asset, {

	/* Fix an Opera bug in Mootools 1.2 */
	javascript: function(source, properties){
		properties = $extend({
			onload: $empty,
			document: document,
			check: $lambda(true)
		}, properties);
		
		if ($(properties.id)) {
			properties.onload();
			return $(properties.id);
		}				
		
		var script = new Element('script', {'src': source, 'type': 'text/javascript'});
		
		var load = properties.onload.bind(script), check = properties.check, doc = properties.document;
		delete properties.onload; delete properties.check; delete properties.document;
		
		if (!Browser.Engine.webkit419 && !Browser.Engine.presto){
			script.addEvents({
				load: load,
				readystatechange: function(){
					if (Browser.Engine.trident && ['loaded', 'complete'].contains(this.readyState)) 
						load();
				}
			}).setProperties(properties);
		}
		else {
			var checker = (function(){
				if (!$try(check)) return;
				$clear(checker);
				// Opera has difficulty with multiple scripts being injected into the head simultaneously. We need to give it time to catch up.
				Browser.Engine.presto ? load.delay(500) : load();
			}).periodical(50);
		}	
		return script.inject(doc.head);
	},
	
	// Get the CSS with XHR before appending it to document.head so that we can have an onload callback.
	css: function(source, properties){
		
		properties = $extend({
			id: null,
			media: 'screen',
			onload: $empty
		}, properties);		
		
		new Request({
			method: 'get',
			url: source,
			onComplete: function(response) { 
				var newSheet = new Element('link', {
					'id': properties.id,
					'rel': 'stylesheet',
					'media': properties.media,
					'type': 'text/css',
					'href': source
				}).inject(document.head);						
				properties.onload();										
			}.bind(this),
			onFailure: function(response){						
			},					
			onSuccess: function(){						 
			}.bind(this)
		}).send();		
	}	
	
});

/*

REGISTER PLUGINS

	Register Components and Plugins for Lazy Loading

	How this works may take a moment to grasp. Take a look at MUI.Window below.
	If we try to create a new Window and Window.js has not been loaded then the function
	below will run. It will load the CSS required by the MUI.Window Class and then
	then it will load Window.js. Here is the interesting part. When Window.js loads,
	it will overwrite the function below, and new MUI.Window(arg) will be ran
	again. This time it will create a new MUI.Window instance, and any future calls
	to new MUI.Window(arg) will immediately create new windows since the assets
	have already been loaded and our temporary function below has been overwritten.	
	
	Example:
	
	MyPlugins.extend({

		MyGadget: function(arg){
			new MUI.Require({
				css: [MUI.path.plugins + 'myGadget/css/style.css'],
				images: [MUI.path.plugins + 'myGadget/images/background.gif']
				js: [MUI.path.plugins + 'myGadget/scripts/myGadget.js'],
				onload: function(){
					new MyPlguins.MyGadget(arg);
				}		
			});
		}
	
	});	
	
-------------------------------------------------------------------- */

MUI.extend({

    newWindowsFromHTML: function(arg){
        new MUI.Require({
            js: [MUI.path.plugins + 'mochaui/Window/Windows-from-html.js'],
            onload: function(){
                new MUI.newWindowsFromHTML(arg);
            }
        });
    },
    
	newWindowsFromJSON: function(arg){
		new MUI.Require({
			js: [MUI.path.plugins + 'mochaui/Window/Windows-from-json.js'],
			onload: function(){
				new MUI.newWindowsFromJSON(arg);
			}
		});
	},

	arrangeCascade: function(){
		new MUI.Require({
			js: [MUI.path.plugins + 'mochaui/Window/Arrange-cascade.js'],
			onload: function(){
				new MUI.arrangeCascade();
			}		
		});		
	},
	
	arrangeTile: function(){
		new MUI.Require({
			js: [MUI.path.plugins + 'mochaui/Window/Arrange-tile.js'],
			onload: function(){
				new MUI.arrangeTile();
			}		
		});
	},
	
	saveWorkspace: function(){
		new MUI.Require({
			js: [MUI.path.plugins + 'mochaui/Layout/Workspaces.js'],
			onload: function(){
				new MUI.saveWorkspace();
			}		
		});		
	},
	
	loadWorkspace: function(){
		new MUI.Require({
			js: [MUI.path.plugins + 'mochaui/Layout/Workspaces.js'],
			onload: function(){
				new MUI.loadWorkspace();
			}		
		});			
	},

	Themes: {
		init: function(arg){			
			new MUI.Require({
				js: [MUI.path.plugins + 'mochaui/Utilities/Themes.js'],
				onload: function(){
					MUI.Themes.init(arg);
				}		
			});			
		}
	}
	
});
/*
---

name: Dock

script: Dock.js

description: Implements the dock/taskbar. Enables window minimize.

copyright: (c) 2007-2009 Greg Houston, <http://greghoustondesign.com/>.

license: MIT-style license.

todo:
  - Make it so the dock requires no initial html markup.

requires:
  - MochaUI/MUI
  - MochaUI/MUI.Windows
  - MochaUI/MUI.Column
  - MochaUI/MUI.Panel

provides: [MUI.Dock]
*/



MUI.files[MUI.path.source + 'Layout/Dock.js'] = 'loaded';

MUI.options.extend({
	// Naming options:
	// If you change the IDs of the Mocha Desktop containers in your HTML, you need to change them here as well.
	dockWrapper: 'dockWrapper',
    dockVisible: 'true',
	dock:        'dock'
});

MUI.extend({
	/*

	Function: minimizeAll
		Minimize all windows that are minimizable.

	*/
	minimizeAll: function() {
		$$('.mocha').each(function(windowEl){
			var instance = windowEl.retrieve('instance');
			if (!instance.isMinimized && instance.options.minimizable == true){
				MUI.Dock.minimizeWindow(windowEl);
			}
		}.bind(this));
	}
});

MUI.Dock = {

	options: {
		useControls:          true,      // Toggles autohide and dock placement controls.
		dockPosition:         'bottom',  // Position the dock starts in, top or bottom.
        dockVisible:          true,      // is the dock visible
		// Style options
		trueButtonColor:      [70, 245, 70],     // Color for autohide on
		enabledButtonColor:   [115, 153, 191],
		disabledButtonColor:  [170, 170, 170]
	},

	initialize: function(options){
		// Stops if MUI.Desktop is not implemented
		if (!MUI.Desktop) return;

		MUI.dockVisible = this.options.dockVisible;
		this.dockWrapper   = $(MUI.options.dockWrapper);
		this.dock          = $(MUI.options.dock);
		this.autoHideEvent = null;
		this.dockAutoHide  = false;  // True when dock autohide is set to on, false if set to off

		if (!this.dockWrapper) return;

		if (!this.options.useControls){
			if($('dockPlacement')){
				$('dockPlacement').setStyle('cursor', 'default');
			}
			if($('dockAutoHide')){
				$('dockAutoHide').setStyle('cursor', 'default');
			}
		}

		this.dockWrapper.setStyles({
			'display':  'block',
			'position': 'absolute',
			'top':      null,
			'bottom':   MUI.Desktop.desktopFooter ? MUI.Desktop.desktopFooter.offsetHeight : 0,
			'left':     0
		});

		if (this.options.useControls){
			this.initializeDockControls();
		}

		// Add check mark to menu if link exists in menu
		if ($('dockLinkCheck')){
			this.sidebarCheck = new Element('div', {
				'class': 'check',
				'id': 'dock_check'
			}).inject($('dockLinkCheck'));
		}

		this.dockSortables = new Sortables('#dockSort', {
			opacity: 1,
			constrain: true,
			clone: false,
			revert: false
		});

        if (!(MUI.dockVisible)) { this.dockWrapper.hide(); }
		MUI.Desktop.setDesktopSize();

		if (MUI.myChain){
			MUI.myChain.callChain();
		}

	},

	initializeDockControls: function(){

		// Convert CSS colors to Canvas colors.
		this.setDockColors();

		if (this.options.useControls){
			// Insert canvas
			var canvas = new Element('canvas', {
				'id':     'dockCanvas',
				'width':  '15',
				'height': '18'
			}).inject(this.dock);

			// Dynamically initialize canvas using excanvas. This is only required by IE
			if (Browser.Engine.trident && MUI.ieSupport == 'excanvas'){
				G_vmlCanvasManager.initElement(canvas);
			}
		}

		var dockPlacement = $('dockPlacement');
		var dockAutoHide = $('dockAutoHide');

		// Position top or bottom selector
		dockPlacement.setProperty('title','Position Dock Top');

		// Attach event
		dockPlacement.addEvent('click', function(){
			this.moveDock();
		}.bind(this));

		// Auto Hide toggle switch
		dockAutoHide.setProperty('title','Turn Auto Hide On');

		// Attach event Auto Hide
		dockAutoHide.addEvent('click', function(event){
			if ( this.dockWrapper.getProperty('dockPosition') == 'top' )
				return false;

			var ctx = $('dockCanvas').getContext('2d');
			this.dockAutoHide = !this.dockAutoHide;	// Toggle
			if (this.dockAutoHide){
				$('dockAutoHide').setProperty('title', 'Turn Auto Hide Off');
				//ctx.clearRect(0, 11, 100, 100);
				MUI.circle(ctx, 5 , 14, 3, this.options.trueButtonColor, 1.0);

				// Define event
				this.autoHideEvent = function(event) {
					if (!this.dockAutoHide)
						return;
					if (!MUI.Desktop.desktopFooter) {
						var dockHotspotHeight = this.dockWrapper.offsetHeight;
						if (dockHotspotHeight < 25) dockHotspotHeight = 25;
					}
					else if (MUI.Desktop.desktopFooter) {
						var dockHotspotHeight = this.dockWrapper.offsetHeight + MUI.Desktop.desktopFooter.offsetHeight;
						if (dockHotspotHeight < 25) dockHotspotHeight = 25;
					}
					if (!MUI.Desktop.desktopFooter && event.client.y > (document.getCoordinates().height - dockHotspotHeight)){
						if (!MUI.dockVisible){
							this.dockWrapper.show();
							MUI.dockVisible = true;
							MUI.Desktop.setDesktopSize();
						}
					}
					else if (MUI.Desktop.desktopFooter && event.client.y > (document.getCoordinates().height - dockHotspotHeight)){
						if (!MUI.dockVisible){
							this.dockWrapper.show();
							MUI.dockVisible = true;
							MUI.Desktop.setDesktopSize();
						}
					}
					else if (MUI.dockVisible){
						this.dockWrapper.hide();
						MUI.dockVisible = false;
						MUI.Desktop.setDesktopSize();

					}
				}.bind(this);

				// Add event
				document.addEvent('mousemove', this.autoHideEvent);

			} else {
				$('dockAutoHide').setProperty('title', 'Turn Auto Hide On');
				//ctx.clearRect(0, 11, 100, 100);
				MUI.circle(ctx, 5 , 14, 3, this.options.enabledButtonColor, 1.0);
				// Remove event
				document.removeEvent('mousemove', this.autoHideEvent);
			}

		}.bind(this));

		this.renderDockControls();

		if (this.options.dockPosition == 'top'){
			this.moveDock();
		}

	},

	setDockColors: function(){
		var dockButtonEnabled = MUI.getCSSRule('.dockButtonEnabled');
		if (dockButtonEnabled && dockButtonEnabled.style.backgroundColor){
			this.options.enabledButtonColor = new Color(dockButtonEnabled.style.backgroundColor);
		}

		var dockButtonDisabled = MUI.getCSSRule('.dockButtonDisabled');
		if (dockButtonDisabled && dockButtonDisabled.style.backgroundColor){
			this.options.disabledButtonColor = new Color(dockButtonDisabled.style.backgroundColor);
		}

		var trueButtonColor = MUI.getCSSRule('.dockButtonTrue');
		if (trueButtonColor && trueButtonColor.style.backgroundColor){
			this.options.trueButtonColor = new Color(trueButtonColor.style.backgroundColor);
		}
	},

	renderDockControls: function(){
		// Draw dock controls
		var ctx = $('dockCanvas').getContext('2d');
		ctx.clearRect(0, 0, 100, 100);
		MUI.circle(ctx, 5 , 4, 3, this.options.enabledButtonColor, 1.0);

		if( this.dockWrapper.getProperty('dockPosition') == 'top'){
			MUI.circle(ctx, 5 , 14, 3, this.options.disabledButtonColor, 1.0)
		}
		else if (this.dockAutoHide){
			MUI.circle(ctx, 5 , 14, 3, this.options.trueButtonColor, 1.0);
		}
		else {
			MUI.circle(ctx, 5 , 14, 3, this.options.enabledButtonColor, 1.0);
		}
	},

	moveDock: function(){
			var ctx = $('dockCanvas').getContext('2d');
			// Move dock to top position
			if (this.dockWrapper.getStyle('position') != 'relative'){
				this.dockWrapper.setStyles({
					'position': 'relative',
					'bottom':   null
				});
				this.dockWrapper.addClass('top');
				MUI.Desktop.setDesktopSize();
				this.dockWrapper.setProperty('dockPosition','top');
				ctx.clearRect(0, 0, 100, 100);
				MUI.circle(ctx, 5, 4, 3, this.options.enabledButtonColor, 1.0);
				MUI.circle(ctx, 5, 14, 3, this.options.disabledButtonColor, 1.0);
				$('dockPlacement').setProperty('title', 'Position Dock Bottom');
				$('dockAutoHide').setProperty('title', 'Auto Hide Disabled in Top Dock Position');
				this.dockAutoHide = false;
			}
			// Move dock to bottom position
			else {
				this.dockWrapper.setStyles({
					'position':      'absolute',
					'bottom':        MUI.Desktop.desktopFooter ? MUI.Desktop.desktopFooter.offsetHeight : 0
				});
				this.dockWrapper.removeClass('top');
				MUI.Desktop.setDesktopSize();
				this.dockWrapper.setProperty('dockPosition', 'bottom');
				ctx.clearRect(0, 0, 100, 100);
				MUI.circle(ctx, 5, 4, 3, this.options.enabledButtonColor, 1.0);
				MUI.circle(ctx, 5 , 14, 3, this.options.enabledButtonColor, 1.0);
				$('dockPlacement').setProperty('title', 'Position Dock Top');
				$('dockAutoHide').setProperty('title', 'Turn Auto Hide On');
			}
	},

	createDockTab: function(windowEl){

		var instance = windowEl.retrieve('instance');

		var dockTab = new Element('div', {
			'id': instance.options.id + '_dockTab',
			'class': 'dockTab',
			'title': titleText
		}).inject($('dockClear'), 'before');

		dockTab.addEvent('mousedown', function(e){
			new Event(e).stop();
			this.timeDown = $time();
		});

		dockTab.addEvent('mouseup', function(e){
			this.timeUp = $time();
			if ((this.timeUp - this.timeDown) < 275){
				// If the visibility of the windows on the page are toggled off, toggle visibility on.
				if (MUI.Windows.windowsVisible == false) {
					MUI.toggleWindowVisibility();
					if (instance.isMinimized == true) {
						MUI.Dock.restoreMinimized.delay(25, MUI.Dock, windowEl);
					}
					else {
						MUI.focusWindow(windowEl);
					}
					return;
				}
				// If window is minimized, restore window.
				if (instance.isMinimized == true) {
					MUI.Dock.restoreMinimized.delay(25, MUI.Dock, windowEl);
				}
				else{
					// If window is not minimized and is focused, minimize window.
					if (instance.windowEl.hasClass('isFocused') && instance.options.minimizable == true){
						MUI.Dock.minimizeWindow(windowEl)
					}
					// If window is not minimized and is not focused, focus window.
					else{
						MUI.focusWindow(windowEl);
					}
					// if the window is not minimized and is outside the viewport, center it in the viewport.
					var coordinates = document.getCoordinates();
					if (windowEl.getStyle('left').toInt() > coordinates.width || windowEl.getStyle('top').toInt() > coordinates.height){
						MUI.centerWindow(windowEl);
					}
				}
			}
		});

		this.dockSortables.addItems(dockTab);

		var titleText = instance.titleEl.innerHTML;

		var dockTabText = new Element('div', {
			'id': instance.options.id + '_dockTabText',
			'class': 'dockText'
		}).set('html', titleText.substring(0,19) + (titleText.length > 19 ? '...' : '')).inject($(dockTab));

		// If I implement this again, will need to also adjust the titleText truncate and the tab's
		// left padding.
		if (instance.options.icon != false){
			// dockTabText.setStyle('background', 'url(' + instance.options.icon + ') 4px 4px no-repeat');
		}

		// Need to resize everything in case the dock wraps when a new tab is added
		MUI.Desktop.setDesktopSize();

	},

	makeActiveTab: function(){

		// getWindowWith HighestZindex is used in case the currently focused window
		// is closed.
		var windowEl = MUI.getWindowWithHighestZindex();
		var instance = windowEl.retrieve('instance');

		$$('.dockTab').removeClass('activeDockTab');
		if (instance.isMinimized != true) {

			instance.windowEl.addClass('isFocused');

			var currentButton = $(instance.options.id + '_dockTab');
			if (currentButton != null) {
				currentButton.addClass('activeDockTab');
			}
		}
		else {
			instance.windowEl.removeClass('isFocused');
		}
	},

	minimizeWindow: function(windowEl){
		if (windowEl != $(windowEl)) return;

		var instance = windowEl.retrieve('instance');
		instance.isMinimized = true;

		// Hide iframe
		// Iframe should be hidden when minimizing, maximizing, and moving for performance and Flash issues
		if ( instance.iframeEl ) {
			// Some elements are still visible in IE8 in the iframe when the iframe's visibility is set to hidden.
			if (!Browser.Engine.trident) {
				instance.iframeEl.setStyle('visibility', 'hidden');
			}
			else {
				instance.iframeEl.hide();
			}
		}

		// Hide window and add to dock
		instance.contentBorderEl.setStyle('visibility', 'hidden');
		if(instance.toolbarWrapperEl){
			instance.toolbarWrapperEl.hide();
		}
		windowEl.setStyle('visibility', 'hidden');

		 // Fixes a scrollbar issue in Mac FF2
		if (Browser.Platform.mac && Browser.Engine.gecko){
			if (/Firefox[\/\s](\d+\.\d+)/.test(navigator.userAgent)){
				var ffversion = new Number(RegExp.$1);
				if (ffversion < 3) {
					instance.contentWrapperEl.setStyle('overflow', 'hidden');
				}
			}
		}

		MUI.Desktop.setDesktopSize();

		// Have to use timeout because window gets focused when you click on the minimize button
		setTimeout(function(){
			windowEl.setStyle('zIndex', 1);
			windowEl.removeClass('isFocused');
			this.makeActiveTab();
		}.bind(this),100);

		instance.fireEvent('onMinimize', windowEl);
	},

	restoreMinimized: function(windowEl) {

		var instance = windowEl.retrieve('instance');

		if (instance.isMinimized == false) return;

		if (MUI.Windows.windowsVisible == false){
			MUI.toggleWindowVisibility();
		}

		MUI.Desktop.setDesktopSize();

		 // Part of Mac FF2 scrollbar fix
		if (instance.options.scrollbars == true && !instance.iframeEl){
			instance.contentWrapperEl.setStyle('overflow', 'auto');
		}

		if (instance.isCollapsed) {
			MUI.collapseToggle(windowEl);
		}

		windowEl.setStyle('visibility', 'visible');
		instance.contentBorderEl.setStyle('visibility', 'visible');
		if(instance.toolbarWrapperEl){
			instance.toolbarWrapperEl.show();
		}

		// Show iframe
		if (instance.iframeEl){
			if (!Browser.Engine.trident){
				instance.iframeEl.setStyle('visibility', 'visible');
			}
			else {
				instance.iframeEl.show();
			}
		}

		instance.isMinimized = false;
		MUI.focusWindow(windowEl);
		instance.fireEvent('onRestore', windowEl);

	},

    toggle: function(){
		if (!MochaUI.dockVisible){
			this.dockWrapper.show();
			MUI.dockVisible = true;
			MUI.Desktop.setDesktopSize();
		}
		else {
			this.dockWrapper.hide();
			MUI.dockVisible = false;
			MUI.Desktop.setDesktopSize();
		}
	}
};
 
// Copyright 2006 Google Inc.
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//   http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.


// Known Issues:
//
// * Patterns are not implemented.
// * Radial gradient are not implemented. The VML version of these look very
//   different from the canvas one.
// * Clipping paths are not implemented.
// * Coordsize. The width and height attribute have higher priority than the
//   width and height style values which isn't correct.
// * Painting mode isn't implemented.
// * Canvas width/height should is using content-box by default. IE in
//   Quirks mode will draw the canvas using border-box. Either change your
//   doctype to HTML5
//   (http://www.whatwg.org/specs/web-apps/current-work/#the-doctype)
//   or use Box Sizing Behavior from WebFX
//   (http://webfx.eae.net/dhtml/boxsizing/boxsizing.html)
// * Non uniform scaling does not correctly scale strokes.
// * Optimize. There is always room for speed improvements.

// Only add this code if we do not already have a canvas implementation
if( !document.createElement('canvas').getContext ) {

(function() {

  // alias some functions to make (compiled) code shorter
  var m = Math;
  var mr = m.round;
  var ms = m.sin;
  var mc = m.cos;
  var abs = m.abs;
  var sqrt = m.sqrt;

  // this is used for sub pixel precision
  var Z = 10;
  var Z2 = Z / 2;

  /**
   * This funtion is assigned to the <canvas> elements as element.getContext().
   * @this {HTMLElement}
   * @return {CanvasRenderingContext2D_}
   */
  function getContext() {
    return this.context_ ||
        (this.context_ = new CanvasRenderingContext2D_(this));
  }

  var slice = Array.prototype.slice;

  /**
   * Binds a function to an object. The returned function will always use the
   * passed in {@code obj} as {@code this}.
   *
   * Example:
   *
   *   g = bind(f, obj, a, b)
   *   g(c, d) // will do f.call(obj, a, b, c, d)
   *
   * @param {Function} f The function to bind the object to
   * @param {Object} obj The object that should act as this when the function
   *     is called
   * @param {*} var_args Rest arguments that will be used as the initial
   *     arguments when the function is called
   * @return {Function} A new function that has bound this
   */
  function bind(f, obj, var_args) {
    var a = slice.call(arguments, 2);
    return function() {
      return f.apply(obj, a.concat(slice.call(arguments)));
    };
  }

  var G_vmlCanvasManager_ = {
    init: function(opt_doc) {
      if (/MSIE/.test(navigator.userAgent) && !window.opera) {
        var doc = opt_doc || document;
        // Create a dummy element so that IE will allow canvas elements to be
        // recognized.
        doc.createElement('canvas');
        doc.attachEvent('onreadystatechange', bind(this.init_, this, doc));
      }
    },

    init_: function(doc) {
      // create xmlns
      if (!doc.namespaces['g_vml_']) {
        doc.namespaces.add('g_vml_', 'urn:schemas-microsoft-com:vml',
                           '#default#VML');

      }
      if (!doc.namespaces['g_o_']) {
        doc.namespaces.add('g_o_', 'urn:schemas-microsoft-com:office:office',
                           '#default#VML');
      }

      // Setup default CSS.  Only add one style sheet per document
      if (!doc.styleSheets['ex_canvas_']) {
        var ss = doc.createStyleSheet();
        ss.owningElement.id = 'ex_canvas_';
        ss.cssText = 'canvas{display:inline-block;overflow:hidden;' +
            // default size is 300x150 in Gecko and Opera
            'text-align:left;width:300px;height:150px}' +
            'g_vml_\\:*{behavior:url(#default#VML)}' +
            'g_o_\\:*{behavior:url(#default#VML)}';

      }

      // find all canvas elements
      var els = doc.getElementsByTagName('canvas');
      for (var i = 0; i < els.length; i++) {
        this.initElement(els[i]);
      }
    },

    /**
     * Public initializes a canvas element so that it can be used as canvas
     * element from now on. This is called automatically before the page is
     * loaded but if you are creating elements using createElement you need to
     * make sure this is called on the element.
     * @param {HTMLElement} el The canvas element to initialize.
     * @return {HTMLElement} the element that was created.
     */
    initElement: function(el) {
      if (!el.getContext) {

        el.getContext = getContext;

        // Remove fallback content. There is no way to hide text nodes so we
        // just remove all childNodes. We could hide all elements and remove
        // text nodes but who really cares about the fallback content.
        el.innerHTML = '';

        // do not use inline function because that will leak memory
        el.attachEvent('onpropertychange', onPropertyChange);
        el.attachEvent('onresize', onResize);

        var attrs = el.attributes;
        if (attrs.width && attrs.width.specified) {
          // TODO: use runtimeStyle and coordsize
          // el.getContext().setWidth_(attrs.width.nodeValue);
          el.style.width = attrs.width.nodeValue + 'px';
        } else {
          el.width = el.clientWidth;
        }
        if (attrs.height && attrs.height.specified) {
          // TODO: use runtimeStyle and coordsize
          // el.getContext().setHeight_(attrs.height.nodeValue);
          el.style.height = attrs.height.nodeValue + 'px';
        } else {
          el.height = el.clientHeight;
        }
        //el.getContext().setCoordsize_()
      }
      return el;
    }
  };

  function onPropertyChange(e) {
    var el = e.srcElement;

    switch (e.propertyName) {
      case 'width':
        el.style.width = el.attributes.width.nodeValue + 'px';
        el.getContext().clearRect();
        break;
      case 'height':
        el.style.height = el.attributes.height.nodeValue + 'px';
        el.getContext().clearRect();
        break;
    }
  }

  function onResize(e) {
    var el = e.srcElement;
    if (el.firstChild) {
      el.firstChild.style.width =  el.clientWidth + 'px';
      el.firstChild.style.height = el.clientHeight + 'px';
    }
  }

  G_vmlCanvasManager_.init();

  // precompute "00" to "FF"
  var dec2hex = [];
  for (var i = 0; i < 16; i++) {
    for (var j = 0; j < 16; j++) {
      dec2hex[i * 16 + j] = i.toString(16) + j.toString(16);
    }
  }

  function createMatrixIdentity() {
    return [
      [1, 0, 0],
      [0, 1, 0],
      [0, 0, 1]
    ];
  }

  function matrixMultiply(m1, m2) {
    var result = createMatrixIdentity();

    for (var x = 0; x < 3; x++) {
      for (var y = 0; y < 3; y++) {
        var sum = 0;

        for (var z = 0; z < 3; z++) {
          sum += m1[x][z] * m2[z][y];
        }

        result[x][y] = sum;
      }
    }
    return result;
  }

  function copyState(o1, o2) {
    o2.fillStyle     = o1.fillStyle;
    o2.lineCap       = o1.lineCap;
    o2.lineJoin      = o1.lineJoin;
    o2.lineWidth     = o1.lineWidth;
    o2.miterLimit    = o1.miterLimit;
    o2.shadowBlur    = o1.shadowBlur;
    o2.shadowColor   = o1.shadowColor;
    o2.shadowOffsetX = o1.shadowOffsetX;
    o2.shadowOffsetY = o1.shadowOffsetY;
    o2.strokeStyle   = o1.strokeStyle;
    o2.globalAlpha   = o1.globalAlpha;
    o2.arcScaleX_    = o1.arcScaleX_;
    o2.arcScaleY_    = o1.arcScaleY_;
    o2.lineScale_    = o1.lineScale_;
  }

  function processStyle(styleString) {
    var str, alpha = 1;

    styleString = String(styleString);
    if (styleString.substring(0, 3) == 'rgb') {
      var start = styleString.indexOf('(', 3);
      var end = styleString.indexOf(')', start + 1);
      var guts = styleString.substring(start + 1, end).split(',');

      str = '#';
      for (var i = 0; i < 3; i++) {
        str += dec2hex[Number(guts[i])];
      }

      if (guts.length == 4 && styleString.substr(3, 1) == 'a') {
        alpha = guts[3];
      }
    } else {
      str = styleString;
    }

    return {color: str, alpha: alpha};
  }

  function processLineCap(lineCap) {
    switch (lineCap) {
      case 'butt':
        return 'flat';
      case 'round':
        return 'round';
      case 'square':
      default:
        return 'square';
    }
  }

  /**
   * This class implements CanvasRenderingContext2D interface as described by
   * the WHATWG.
   * @param {HTMLElement} surfaceElement The element that the 2D context should
   * be associated with
   */
  function CanvasRenderingContext2D_(surfaceElement) {
    this.m_ = createMatrixIdentity();

    this.mStack_ = [];
    this.aStack_ = [];
    this.currentPath_ = [];

    // Canvas context properties
    this.strokeStyle = '#000';
    this.fillStyle = '#000';

    this.lineWidth = 1;
    this.lineJoin = 'miter';
    this.lineCap = 'butt';
    this.miterLimit = Z * 1;
    this.globalAlpha = 1;
    this.canvas = surfaceElement;

    var el = surfaceElement.ownerDocument.createElement('div');
    el.style.width =  surfaceElement.clientWidth + 'px';
    el.style.height = surfaceElement.clientHeight + 'px';
    el.style.overflow = 'hidden';
    el.style.position = 'absolute';
    surfaceElement.appendChild(el);

    this.element_ = el;
    this.arcScaleX_ = 1;
    this.arcScaleY_ = 1;
    this.lineScale_ = 1;
  }

  var contextPrototype = CanvasRenderingContext2D_.prototype;
  contextPrototype.clearRect = function() {
    this.element_.innerHTML = '';
  };

  contextPrototype.beginPath = function() {
    // TODO: Branch current matrix so that save/restore has no effect
    //       as per safari docs.
    this.currentPath_ = [];
  };

  contextPrototype.moveTo = function(aX, aY) {
    var p = this.getCoords_(aX, aY);
    this.currentPath_.push({type: 'moveTo', x: p.x, y: p.y});
    this.currentX_ = p.x;
    this.currentY_ = p.y;
  };

  contextPrototype.lineTo = function(aX, aY) {
    var p = this.getCoords_(aX, aY);
    this.currentPath_.push({type: 'lineTo', x: p.x, y: p.y});

    this.currentX_ = p.x;
    this.currentY_ = p.y;
  };

  contextPrototype.bezierCurveTo = function(aCP1x, aCP1y,
                                            aCP2x, aCP2y,
                                            aX, aY) {
    var p = this.getCoords_(aX, aY);
    var cp1 = this.getCoords_(aCP1x, aCP1y);
    var cp2 = this.getCoords_(aCP2x, aCP2y);
    bezierCurveTo(this, cp1, cp2, p);
  };

  // Helper function that takes the already fixed cordinates.
  function bezierCurveTo(self, cp1, cp2, p) {
    self.currentPath_.push({
      type: 'bezierCurveTo',
      cp1x: cp1.x,
      cp1y: cp1.y,
      cp2x: cp2.x,
      cp2y: cp2.y,
      x: p.x,
      y: p.y
    });
    self.currentX_ = p.x;
    self.currentY_ = p.y;
  }

  contextPrototype.quadraticCurveTo = function(aCPx, aCPy, aX, aY) {
    // the following is lifted almost directly from
    // http://developer.mozilla.org/en/docs/Canvas_tutorial:Drawing_shapes

    var cp = this.getCoords_(aCPx, aCPy);
    var p = this.getCoords_(aX, aY);

    var cp1 = {
      x: this.currentX_ + 2.0 / 3.0 * (cp.x - this.currentX_),
      y: this.currentY_ + 2.0 / 3.0 * (cp.y - this.currentY_)
    };
    var cp2 = {
      x: cp1.x + (p.x - this.currentX_) / 3.0,
      y: cp1.y + (p.y - this.currentY_) / 3.0
    };

    bezierCurveTo(this, cp1, cp2, p);
  };

  contextPrototype.arc = function(aX, aY, aRadius,
                                  aStartAngle, aEndAngle, aClockwise) {
    aRadius *= Z;
    var arcType = aClockwise ? 'at' : 'wa';

    var xStart = aX + mc(aStartAngle) * aRadius - Z2;
    var yStart = aY + ms(aStartAngle) * aRadius - Z2;

    var xEnd = aX + mc(aEndAngle) * aRadius - Z2;
    var yEnd = aY + ms(aEndAngle) * aRadius - Z2;

    // IE won't render arches drawn counter clockwise if xStart == xEnd.
    if (xStart == xEnd && !aClockwise) {
      xStart += 0.125; // Offset xStart by 1/80 of a pixel. Use something
                       // that can be represented in binary
    }

    var p = this.getCoords_(aX, aY);
    var pStart = this.getCoords_(xStart, yStart);
    var pEnd = this.getCoords_(xEnd, yEnd);

    this.currentPath_.push({type: arcType,
                           x: p.x,
                           y: p.y,
                           radius: aRadius,
                           xStart: pStart.x,
                           yStart: pStart.y,
                           xEnd: pEnd.x,
                           yEnd: pEnd.y});

  };

  contextPrototype.rect = function(aX, aY, aWidth, aHeight) {
    this.moveTo(aX, aY);
    this.lineTo(aX + aWidth, aY);
    this.lineTo(aX + aWidth, aY + aHeight);
    this.lineTo(aX, aY + aHeight);
    this.closePath();
  };

  contextPrototype.strokeRect = function(aX, aY, aWidth, aHeight) {
    var oldPath = this.currentPath_;
    this.beginPath();

    this.moveTo(aX, aY);
    this.lineTo(aX + aWidth, aY);
    this.lineTo(aX + aWidth, aY + aHeight);
    this.lineTo(aX, aY + aHeight);
    this.closePath();
    this.stroke();

    this.currentPath_ = oldPath;
  };

  contextPrototype.fillRect = function(aX, aY, aWidth, aHeight) {
    var oldPath = this.currentPath_;
    this.beginPath();

    this.moveTo(aX, aY);
    this.lineTo(aX + aWidth, aY);
    this.lineTo(aX + aWidth, aY + aHeight);
    this.lineTo(aX, aY + aHeight);
    this.closePath();
    this.fill();

    this.currentPath_ = oldPath;
  };

  contextPrototype.createLinearGradient = function(aX0, aY0, aX1, aY1) {
    var gradient = new CanvasGradient_('gradient');
    gradient.x0_ = aX0;
    gradient.y0_ = aY0;
    gradient.x1_ = aX1;
    gradient.y1_ = aY1;
    return gradient;
  };

  contextPrototype.createRadialGradient = function(aX0, aY0, aR0,
                                                   aX1, aY1, aR1) {
    var gradient = new CanvasGradient_('gradientradial');
    gradient.x0_ = aX0;
    gradient.y0_ = aY0;
    gradient.r0_ = aR0;
    gradient.x1_ = aX1;
    gradient.y1_ = aY1;
    gradient.r1_ = aR1;
    return gradient;
  };

  contextPrototype.drawImage = function(image, var_args) {
    var dx, dy, dw, dh, sx, sy, sw, sh;

    // to find the original width we overide the width and height
    var oldRuntimeWidth = image.runtimeStyle.width;
    var oldRuntimeHeight = image.runtimeStyle.height;
    image.runtimeStyle.width = 'auto';
    image.runtimeStyle.height = 'auto';

    // get the original size
    var w = image.width;
    var h = image.height;

    // and remove overides
    image.runtimeStyle.width = oldRuntimeWidth;
    image.runtimeStyle.height = oldRuntimeHeight;

    if (arguments.length == 3) {
      dx = arguments[1];
      dy = arguments[2];
      sx = sy = 0;
      sw = dw = w;
      sh = dh = h;
    } else if (arguments.length == 5) {
      dx = arguments[1];
      dy = arguments[2];
      dw = arguments[3];
      dh = arguments[4];
      sx = sy = 0;
      sw = w;
      sh = h;
    } else if (arguments.length == 9) {
      sx = arguments[1];
      sy = arguments[2];
      sw = arguments[3];
      sh = arguments[4];
      dx = arguments[5];
      dy = arguments[6];
      dw = arguments[7];
      dh = arguments[8];
    } else {
      throw Error('Invalid number of arguments');
    }

    var d = this.getCoords_(dx, dy);

    var w2 = sw / 2;
    var h2 = sh / 2;

    var vmlStr = [];

    var W = 10;
    var H = 10;

    // For some reason that I've now forgotten, using divs didn't work
    vmlStr.push(' <g_vml_:group',
                ' coordsize="', Z * W, ',', Z * H, '"',
                ' coordorigin="0,0"' ,
                ' style="width:', W, 'px;height:', H, 'px;position:absolute;');

    // If filters are necessary (rotation exists), create them
    // filters are bog-slow, so only create them if abbsolutely necessary
    // The following check doesn't account for skews (which don't exist
    // in the canvas spec (yet) anyway.

    if (this.m_[0][0] != 1 || this.m_[0][1]) {
      var filter = [];

      // Note the 12/21 reversal
      filter.push('M11=', this.m_[0][0], ',',
                  'M12=', this.m_[1][0], ',',
                  'M21=', this.m_[0][1], ',',
                  'M22=', this.m_[1][1], ',',
                  'Dx=', mr(d.x / Z), ',',
                  'Dy=', mr(d.y / Z), '');

      // Bounding box calculation (need to minimize displayed area so that
      // filters don't waste time on unused pixels.
      var max = d;
      var c2 = this.getCoords_(dx + dw, dy);
      var c3 = this.getCoords_(dx, dy + dh);
      var c4 = this.getCoords_(dx + dw, dy + dh);

      max.x = m.max(max.x, c2.x, c3.x, c4.x);
      max.y = m.max(max.y, c2.y, c3.y, c4.y);

      vmlStr.push('padding:0 ', mr(max.x / Z), 'px ', mr(max.y / Z),
                  'px 0;filter:progid:DXImageTransform.Microsoft.Matrix(',
                  filter.join(''), ", sizingmethod='clip');")
    } else {
      vmlStr.push('top:', mr(d.y / Z), 'px;left:', mr(d.x / Z), 'px;');
    }

    vmlStr.push(' ">' ,
                '<g_vml_:image src="', image.src, '"',
                ' style="width:', Z * dw, 'px;',
                ' height:', Z * dh, 'px;"',
                ' cropleft="', sx / w, '"',
                ' croptop="', sy / h, '"',
                ' cropright="', (w - sx - sw) / w, '"',
                ' cropbottom="', (h - sy - sh) / h, '"',
                ' />',
                '</g_vml_:group>');

    this.element_.insertAdjacentHTML('BeforeEnd',
                                    vmlStr.join(''));
  };

  contextPrototype.stroke = function(aFill) {
    var lineStr = [];
    var lineOpen = false;
    var a = processStyle(aFill ? this.fillStyle : this.strokeStyle);
    var color = a.color;
    var opacity = a.alpha * this.globalAlpha;

    var W = 10;
    var H = 10;

    lineStr.push('<g_vml_:shape',
                 ' filled="', !!aFill, '"',
                 ' style="position:absolute;width:', W, 'px;height:', H, 'px;"',
                 ' coordorigin="0 0" coordsize="', Z * W, ' ', Z * H, '"',
                 ' stroked="', !aFill, '"',
                 ' path="');

    var newSeq = false;
    var min = {x: null, y: null};
    var max = {x: null, y: null};

    for (var i = 0; i < this.currentPath_.length; i++) {
      var p = this.currentPath_[i];
      var c;

      switch (p.type) {
        case 'moveTo':
          c = p;
          lineStr.push(' m ', mr(p.x), ',', mr(p.y));
          break;
        case 'lineTo':
          lineStr.push(' l ', mr(p.x), ',', mr(p.y));
          break;
        case 'close':
          lineStr.push(' x ');
          p = null;
          break;
        case 'bezierCurveTo':
          lineStr.push(' c ',
                       mr(p.cp1x), ',', mr(p.cp1y), ',',
                       mr(p.cp2x), ',', mr(p.cp2y), ',',
                       mr(p.x), ',', mr(p.y));
          break;
        case 'at':
        case 'wa':
          lineStr.push(' ', p.type, ' ',
                       mr(p.x - this.arcScaleX_ * p.radius), ',',
                       mr(p.y - this.arcScaleY_ * p.radius), ' ',
                       mr(p.x + this.arcScaleX_ * p.radius), ',',
                       mr(p.y + this.arcScaleY_ * p.radius), ' ',
                       mr(p.xStart), ',', mr(p.yStart), ' ',
                       mr(p.xEnd), ',', mr(p.yEnd));
          break;
      }


      // TODO: Following is broken for curves due to
      //       move to proper paths.

      // Figure out dimensions so we can do gradient fills
      // properly
      if (p) {
        if (min.x == null || p.x < min.x) {
          min.x = p.x;
        }
        if (max.x == null || p.x > max.x) {
          max.x = p.x;
        }
        if (min.y == null || p.y < min.y) {
          min.y = p.y;
        }
        if (max.y == null || p.y > max.y) {
          max.y = p.y;
        }
      }
    }
    lineStr.push(' ">');

    if (!aFill) {
      var lineWidth = this.lineScale_ * this.lineWidth;

      // VML cannot correctly render a line if the width is less than 1px.
      // In that case, we dilute the color to make the line look thinner.
      if (lineWidth < 1) {
        opacity *= lineWidth;
      }

      lineStr.push(
        '<g_vml_:stroke',
        ' opacity="', opacity, '"',
        ' joinstyle="', this.lineJoin, '"',
        ' miterlimit="', this.miterLimit, '"',
        ' endcap="', processLineCap(this.lineCap), '"',
        ' weight="', lineWidth, 'px"',
        ' color="', color, '" />'
      );
    } else if (typeof this.fillStyle == 'object') {
      var fillStyle = this.fillStyle;
      var angle = 0;
      var focus = {x: 0, y: 0};

      // additional offset
      var shift = 0;
      // scale factor for offset
      var expansion = 1;

      if (fillStyle.type_ == 'gradient') {
        var x0 = fillStyle.x0_ / this.arcScaleX_;
        var y0 = fillStyle.y0_ / this.arcScaleY_;
        var x1 = fillStyle.x1_ / this.arcScaleX_;
        var y1 = fillStyle.y1_ / this.arcScaleY_;
        var p0 = this.getCoords_(x0, y0);
        var p1 = this.getCoords_(x1, y1);
        var dx = p1.x - p0.x;
        var dy = p1.y - p0.y;
        angle = Math.atan2(dx, dy) * 180 / Math.PI;

        // The angle should be a non-negative number.
        if (angle < 0) {
          angle += 360;
        }

        // Very small angles produce an unexpected result because they are
        // converted to a scientific notation string.
        if (angle < 1e-6) {
          angle = 0;
        }
      } else {
        var p0 = this.getCoords_(fillStyle.x0_, fillStyle.y0_);
        var width  = max.x - min.x;
        var height = max.y - min.y;
        focus = {
          x: (p0.x - min.x) / width,
          y: (p0.y - min.y) / height
        };

        width  /= this.arcScaleX_ * Z;
        height /= this.arcScaleY_ * Z;
        var dimension = m.max(width, height);
        shift = 2 * fillStyle.r0_ / dimension;
        expansion = 2 * fillStyle.r1_ / dimension - shift;
      }

      // We need to sort the color stops in ascending order by offset,
      // otherwise IE won't interpret it correctly.
      var stops = fillStyle.colors_;
      stops.sort(function(cs1, cs2) {
        return cs1.offset - cs2.offset;
      });

      var length = stops.length;
      var color1 = stops[0].color;
      var color2 = stops[length - 1].color;
      var opacity1 = stops[0].alpha * this.globalAlpha;
      var opacity2 = stops[length - 1].alpha * this.globalAlpha;

      var colors = [];
      for (var i = 0; i < length; i++) {
        var stop = stops[i];
        colors.push(stop.offset * expansion + shift + ' ' + stop.color);
      }

      // When colors attribute is used, the meanings of opacity and o:opacity2
      // are reversed.
      lineStr.push('<g_vml_:fill type="', fillStyle.type_, '"',
                   ' method="none" focus="100%"',
                   ' color="', color1, '"',
                   ' color2="', color2, '"',
                   ' colors="', colors.join(','), '"',
                   ' opacity="', opacity2, '"',
                   ' g_o_:opacity2="', opacity1, '"',
                   ' angle="', angle, '"',
                   ' focusposition="', focus.x, ',', focus.y, '" />');
    } else {
      lineStr.push('<g_vml_:fill color="', color, '" opacity="', opacity,
                   '" />');
    }

    lineStr.push('</g_vml_:shape>');

    this.element_.insertAdjacentHTML('beforeEnd', lineStr.join(''));
  };

  contextPrototype.fill = function() {
    this.stroke(true);
  }

  contextPrototype.closePath = function() {
    this.currentPath_.push({type: 'close'});
  };

  /**
   * @private
   */
  contextPrototype.getCoords_ = function(aX, aY) {
    var m = this.m_;
    return {
      x: Z * (aX * m[0][0] + aY * m[1][0] + m[2][0]) - Z2,
      y: Z * (aX * m[0][1] + aY * m[1][1] + m[2][1]) - Z2
    }
  };

  contextPrototype.save = function() {
    var o = {};
    copyState(this, o);
    this.aStack_.push(o);
    this.mStack_.push(this.m_);
    this.m_ = matrixMultiply(createMatrixIdentity(), this.m_);
  };

  contextPrototype.restore = function() {
    copyState(this.aStack_.pop(), this);
    this.m_ = this.mStack_.pop();
  };

  function matrixIsFinite(m) {
    for (var j = 0; j < 3; j++) {
      for (var k = 0; k < 2; k++) {
        if (!isFinite(m[j][k]) || isNaN(m[j][k])) {
          return false;
        }
      }
    }
    return true;
  }

  function setM(ctx, m, updateLineScale) {
    if (!matrixIsFinite(m)) {
      return;
    }
    ctx.m_ = m;

    if (updateLineScale) {
      // Get the line scale.
      // Determinant of this.m_ means how much the area is enlarged by the
      // transformation. So its square root can be used as a scale factor
      // for width.
      var det = m[0][0] * m[1][1] - m[0][1] * m[1][0];
      ctx.lineScale_ = sqrt(abs(det));
    }
  }

  contextPrototype.translate = function(aX, aY) {
    var m1 = [
      [1,  0,  0],
      [0,  1,  0],
      [aX, aY, 1]
    ];

    setM(this, matrixMultiply(m1, this.m_), false);
  };

  contextPrototype.rotate = function(aRot) {
    var c = mc(aRot);
    var s = ms(aRot);

    var m1 = [
      [c,  s, 0],
      [-s, c, 0],
      [0,  0, 1]
    ];

    setM(this, matrixMultiply(m1, this.m_), false);
  };

  contextPrototype.scale = function(aX, aY) {
    this.arcScaleX_ *= aX;
    this.arcScaleY_ *= aY;
    var m1 = [
      [aX, 0,  0],
      [0,  aY, 0],
      [0,  0,  1]
    ];

    setM(this, matrixMultiply(m1, this.m_), true);
  };

  contextPrototype.transform = function(m11, m12, m21, m22, dx, dy) {
    var m1 = [
      [m11, m12, 0],
      [m21, m22, 0],
      [dx,  dy,  1]
    ];

    setM(this, matrixMultiply(m1, this.m_), true);
  };

  contextPrototype.setTransform = function(m11, m12, m21, m22, dx, dy) {
    var m = [
      [m11, m12, 0],
      [m21, m22, 0],
      [dx,  dy,  1]
    ];

    setM(this, m, true);
  };

  /******** STUBS ********/
  contextPrototype.clip = function() {
    // TODO: Implement
  };

  contextPrototype.arcTo = function() {
    // TODO: Implement
  };

  contextPrototype.createPattern = function() {
    return new CanvasPattern_;
  };

  // Gradient / Pattern Stubs
  function CanvasGradient_(aType) {
    this.type_ = aType;
    this.x0_ = 0;
    this.y0_ = 0;
    this.r0_ = 0;
    this.x1_ = 0;
    this.y1_ = 0;
    this.r1_ = 0;
    this.colors_ = [];
  }

  CanvasGradient_.prototype.addColorStop = function(aOffset, aColor) {
    aColor = processStyle(aColor);
    this.colors_.push({offset: aOffset,
                       color: aColor.color,
                       alpha: aColor.alpha});
  };

  function CanvasPattern_() {}

  // set up externs
  G_vmlCanvasManager = G_vmlCanvasManager_;
  CanvasRenderingContext2D = CanvasRenderingContext2D_;
  CanvasGradient = CanvasGradient_;
  CanvasPattern = CanvasPattern_;

})();

} // if
;
/*
---

name: Layout

script: Layout.js

description: Create web application layouts. Enables window maximize.

copyright: (c) 2007-2009 Greg Houston, <http://greghoustondesign.com/>.

license: MIT-style license.

requires:
  - MochaUI/MUI

provides: [MUI.Desktop, MUI.Column, MUI.Panel]

...
*/




MUI.files[MUI.path.source + 'Layout/Layout.js'] = 'loaded';

MUI.extend({
	Columns: {
		instances: new Hash(),
		columnIDCount: 0 // Used for columns without an ID defined by the user
	},
	Panels: {
		instances: new Hash(),
		panelIDCount: 0 // Used for panels without an ID defined by the user
	}
});

MUI.Desktop = {

	options: {
		// Naming options:
		// If you change the IDs of the MochaUI Desktop containers in your HTML, you need to change them here as well.
		desktop:             'desktop',
		desktopHeader:       'desktopHeader',
		desktopFooter:       'desktopFooter',
		desktopNavBar:       'desktopNavbar',
		pageWrapper:         'pageWrapper',
		page:                'page',
		desktopFooter:       'desktopFooterWrapper'
	},
	initialize: function( options ){
	   this.options.desktop = options['desktop'] ? options['desktop'] : this.options.desktop;            
      this.options.desktopHeader = options['desktopHeader'] ? options['desktopHeader'] : this.options.desktopHeader;            
      this.options.desktopFooter = options['desktopFooter'] ? options['desktopFooter'] : this.options.desktopFooter;            
      this.options.desktopNavBar = options['desktopNavBar'] ? options['desktopNavBar'] : this.options.desktopNavBar;            
      this.options.pageWrapper = options['pageWrapper'] ? options['pageWrapper'] : this.options.pageWrapper;            
      this.options.page = options['page'] ? options['page'] : this.options.page;            
      this.options.desktopFooter = options['desktopFooter'] ? options['desktopFooter'] : this.options.desktopFooter;            

		this.desktop         = $(this.options.desktop);
		this.desktopHeader   = $(this.options.desktopHeader);
		this.desktopNavBar   = $(this.options.desktopNavBar);
		this.pageWrapper     = $(this.options.pageWrapper);
		this.page            = $(this.options.page);
		this.desktopFooter   = $(this.options.desktopFooter);

      MUI.underlayInitialize();
      
		if (this.desktop) {
			($$('body')).setStyles({
				overflow: 'hidden',
				height: '100%',
				margin: 0
			});
			($$('html')).setStyles({
				overflow: 'hidden',
				height: '100%'
			});
		}

		// This is run on dock initialize so no need to do it twice.
		if (!MUI.Dock){
			this.setDesktopSize();
		}
		this.menuInitialize();

		// Resize desktop, page wrapper, modal overlay, and maximized windows when browser window is resized
		window.addEvent('resize', function(e){
			this.onBrowserResize();
		}.bind(this));

		if (MUI.myChain){
			MUI.myChain.callChain();
		}

	},
	menuInitialize: function(){
		// Fix for dropdown menus in IE6
		if (Browser.Engine.trident4 && this.desktopNavBar){
			this.desktopNavBar.getElements('li').each(function(element) {
				element.addEvent('mouseenter', function(){
					this.addClass('ieHover');
				});
				element.addEvent('mouseleave', function(){
					this.removeClass('ieHover');
				});
			});
		};
	},
	onBrowserResize: function(){
		this.setDesktopSize();
		// Resize maximized windows to fit new browser window size
		setTimeout( function(){
			MUI.Windows.instances.each(function(instance){
				if (instance.isMaximized){

					// Hide iframe while resize for better performance
					if ( instance.iframeEl ){
						instance.iframeEl.setStyle('visibility', 'hidden');
					}

					var coordinates = document.getCoordinates();
					var borderHeight = instance.contentBorderEl.getStyle('border-top').toInt() + instance.contentBorderEl.getStyle('border-bottom').toInt();
					var toolbarHeight = instance.toolbarWrapperEl ? instance.toolbarWrapperEl.getStyle('height').toInt() + instance.toolbarWrapperEl.getStyle('border-top').toInt() : 0;
					instance.contentWrapperEl.setStyles({
						'height': coordinates.height - instance.options.headerHeight - instance.options.footerHeight - borderHeight - toolbarHeight,
						'width': coordinates.width
					});

					instance.drawWindow();
					if ( instance.iframeEl ){
						instance.iframeEl.setStyles({
							'height': instance.contentWrapperEl.getStyle('height')
						});
						instance.iframeEl.setStyle('visibility', 'visible');
					}

				}
			}.bind(this));
		}.bind(this), 100);
	},
	setDesktopSize: function(){
		var windowDimensions = window.getCoordinates();

		// var dock = $(MUI.options.dock);
		var dockWrapper = $(MUI.options.dockWrapper);

		// Setting the desktop height may only be needed by IE7
		if (this.desktop){
			this.desktop.setStyle('height', windowDimensions.height);
		}

		// Set pageWrapper height so the dock doesn't cover the pageWrapper scrollbars.
		if (this.pageWrapper) {
			var dockOffset = MUI.dockVisible ? dockWrapper.offsetHeight : 0;
			var pageWrapperHeight = windowDimensions.height;
			pageWrapperHeight -= this.pageWrapper.getStyle('border-top').toInt();
			pageWrapperHeight -= this.pageWrapper.getStyle('border-bottom').toInt();
			if (this.desktopHeader){ pageWrapperHeight -= this.desktopHeader.offsetHeight; }
			if (this.desktopFooter){ pageWrapperHeight -= this.desktopFooter.offsetHeight; }
			pageWrapperHeight -= dockOffset;

			if (pageWrapperHeight < 0){
				pageWrapperHeight = 0;
			}
			this.pageWrapper.setStyle('height', pageWrapperHeight);
		}

		if (MUI.Columns.instances.getKeys().length > 0){ // Conditional is a fix for a bug in IE6 in the no toolbars demo.
			MUI.Desktop.resizePanels();
		}
	},
	resizePanels: function(){
		MUI.panelHeight();
		MUI.rWidth();
	},
	/*

	Function: maximizeWindow
		Maximize a window.

	Syntax:
		(start code)
		MUI.Desktop.maximizeWindow(windowEl);
		(end)

	*/
	maximizeWindow: function(windowEl){

		var instance = MUI.Windows.instances.get(windowEl.id);
		var options = instance.options;
		var windowDrag = instance.windowDrag;

		// If window no longer exists or is maximized, stop
		if (windowEl != $(windowEl) || instance.isMaximized ) return;

		if (instance.isCollapsed){
			MUI.collapseToggle(windowEl);
		}

		instance.isMaximized = true;

		// If window is restricted to a container, it should not be draggable when maximized.
		if (instance.options.restrict){
			windowDrag.detach();
			if (options.resizable) {
				instance.detachResizable();
			}
			instance.titleBarEl.setStyle('cursor', 'default');
		}

		// If the window has a container that is not the desktop
		// temporarily move the window to the desktop while it is minimized.
		if (options.container != this.desktop){
			this.desktop.grab(windowEl);
			if (this.options.restrict){
			windowDrag.container = this.desktop;
			}
		}

		// Save original position
		instance.oldTop = windowEl.getStyle('top');
		instance.oldLeft = windowEl.getStyle('left');

		var contentWrapperEl = instance.contentWrapperEl;

		// Save original dimensions
		contentWrapperEl.oldWidth = contentWrapperEl.getStyle('width');
		contentWrapperEl.oldHeight = contentWrapperEl.getStyle('height');

		// Hide iframe
		// Iframe should be hidden when minimizing, maximizing, and moving for performance and Flash issues
		if ( instance.iframeEl ) {
			if (!Browser.Engine.trident) {
				instance.iframeEl.setStyle('visibility', 'hidden');
			}
			else {
				instance.iframeEl.hide();
			}
		}

		var windowDimensions = document.getCoordinates();
		var options = instance.options;
		var shadowBlur = options.shadowBlur;
		var shadowOffset = options.shadowOffset;
		var newHeight = windowDimensions.height - options.headerHeight - options.footerHeight;
		newHeight -= instance.contentBorderEl.getStyle('border-top').toInt();
		newHeight -= instance.contentBorderEl.getStyle('border-bottom').toInt();
		newHeight -= (instance.toolbarWrapperEl ? instance.toolbarWrapperEl.getStyle('height').toInt() + instance.toolbarWrapperEl.getStyle('border-top').toInt() : 0);

		MUI.resizeWindow(windowEl, {
			width: windowDimensions.width,
			height: newHeight,
			top: shadowOffset.y - shadowBlur,
			left: shadowOffset.x - shadowBlur
		});
		instance.fireEvent('onMaximize', windowEl);

		if (instance.maximizeButtonEl) {
			instance.maximizeButtonEl.setProperty('title', 'Restore');
		}
		MUI.focusWindow(windowEl);

	},
	/*

	Function: restoreWindow
		Restore a maximized window.

	Syntax:
		(start code)
		MUI.Desktop.restoreWindow(windowEl);
		(end)

	*/
	restoreWindow: function(windowEl){

		var instance = windowEl.retrieve('instance');

		// Window exists and is maximized ?
		if (windowEl != $(windowEl) || !instance.isMaximized) return;

		var options = instance.options;
		instance.isMaximized = false;

		if (options.restrict){
			instance.windowDrag.attach();
			if (options.resizable){
				instance.reattachResizable();
			}
			instance.titleBarEl.setStyle('cursor', 'move');
		}

		// Hide iframe
		// Iframe should be hidden when minimizing, maximizing, and moving for performance and Flash issues
		if ( instance.iframeEl ) {
			if (!Browser.Engine.trident) {
				instance.iframeEl.setStyle('visibility', 'hidden');
			}
			else {
				instance.iframeEl.hide();
			}
		}

		var contentWrapperEl = instance.contentWrapperEl;

		MUI.resizeWindow(windowEl,{
			width: contentWrapperEl.oldWidth,
			height: contentWrapperEl.oldHeight,
			top: instance.oldTop,
			left: instance.oldLeft
		});
		instance.fireEvent('onRestore', windowEl);

		if (instance.maximizeButtonEl){
			instance.maximizeButtonEl.setProperty('title', 'Maximize');
		}
	}
};

/*

Class: Column
	Create a column. Columns should be created from left to right.

Syntax:
(start code)
	MUI.Column();
(end)

Arguments:
	options

Options:
	id - The ID of the column. This must be set when creating the column.
	container - Defaults to MUI.Desktop.pageWrapper.
	placement - Can be 'right', 'main', or 'left'. There must be at least one column with the 'main' option.
	width - 'main' column is fluid and should not be given a width.
	resizeLimit - resizelimit of a 'right' or 'left' column.
	sortable - (boolean) Whether the panels can be reordered via drag and drop.
	onResize - (function) Fired when the column is resized.
	onCollapse - (function) Fired when the column is collapsed.
	onExpand - (function) Fired when the column is expanded.

*/
MUI.Column = new Class({

	Implements: [Events, Options],

	options: {
		id:            null,
		container:     null,
		placement:     null,
		width:         null,
		resizeLimit:   [],
		sortable:      true,
        isCollapsed:   false,

		// Events
		onResize:     $empty,
		onCollapse:   $empty,
		onExpand:     $empty

	},

	initialize: function(options){
		this.setOptions(options);

		$extend(this, {
			timestamp: $time(),
			isCollapsed: false,
			oldWidth: 0
		});

		// If column has no ID, give it one.
		if (this.options.id == null){
			this.options.id = 'column' + (++MUI.Columns.columnIDCount);
		}

		// Shorten object chain
		var options = this.options;
		var instances = MUI.Columns.instances;
		var instanceID = instances.get(options.id);

		if (options.container == null) {
			options.container = MUI.Desktop.pageWrapper;
		}
		else {
			$(options.container).setStyle('overflow', 'hidden');
		}

		if (typeof this.options.container == 'string'){
			this.options.container = $(this.options.container);
		}

		// Check to see if there is already a class instance for this Column
		if (instanceID){
			var instance = instanceID;
		}

		// Check if column already exists
		if ( this.columnEl ){
			return;
		}
		else {
			instances.set(options.id, this);
		}

		// If loading columns into a panel, hide the regular content container.
		if ($(options.container).getElement('.pad') != null) {
			$(options.container).getElement('.pad').hide();
		}

		// If loading columns into a window, hide the regular content container.
		if ($(options.container).getElement('.mochaContent') != null) {
			$(options.container).getElement('.mochaContent').hide();
		}

		this.columnEl = new Element('div', {
			'id': this.options.id,
			'class': 'column expanded',
			'styles': {
				'width': options.placement == 'main' ? null : options.width
			}
		}).inject($(options.container));

		this.columnEl.store('instance', this);

		var parent = this.columnEl.getParent();
		var columnHeight = parent.getStyle('height').toInt();
		this.columnEl.setStyle('height', columnHeight);

		if (this.options.sortable){
			if (!this.options.container.retrieve('sortables')){
				var sortables = new Sortables(this.columnEl, {
					opacity: 1,
					handle: '.panel-header',
					constrain: false,
					revert: false,
					onSort: function(){
						$$('.column').each(function(column){
							column.getChildren('.panelWrapper').each(function(panelWrapper){
								panelWrapper.getElement('.panel').removeClass('bottomPanel');
							});
							if (column.getChildren('.panelWrapper').getLast()){
								column.getChildren('.panelWrapper').getLast().getElement('.panel').addClass('bottomPanel');
							}
                            column.getChildren('.panelWrapper').each(function(panelWrapper){
                                var panel = panelWrapper.getElement('.panel');
                                var column = panelWrapper.getParent().id;
                                instance = MUI.Panels.instances.get(panel.id);
                                instance.options.column = column;
                                if(instance) {
                                    var nextpanel = panel.getParent().getNext('.expanded');
                                    if(nextpanel) {
                                        nextpanel=nextpanel.getElement('.panel'); }
                                    instance.partner = nextpanel;
                                }
                            });
							MUI.panelHeight();
						}.bind(this));
					}.bind(this)
				});
				this.options.container.store('sortables', sortables);
			}
			else {
				this.options.container.retrieve('sortables').addLists(this.columnEl);
			}
		}

		if (options.placement == 'main'){
			this.columnEl.addClass('rWidth');
		}

		switch (this.options.placement) {
			case 'left':
				this.handleEl = new Element('div', {
					'id': this.options.id + '_handle',
					'class': 'columnHandle'
				}).inject(this.columnEl, 'after');

				this.handleIconEl = new Element('div', {
					'id': options.id + '_handle_icon',
					'class': 'handleIcon'
				}).inject(this.handleEl);

				addResizeRight(this.columnEl, options.resizeLimit[0], options.resizeLimit[1]);
				break;
			case 'right':
				this.handleEl = new Element('div', {
					'id': this.options.id + '_handle',
					'class': 'columnHandle'
				}).inject(this.columnEl, 'before');

				this.handleIconEl = new Element('div', {
					'id': options.id + '_handle_icon',
					'class': 'handleIcon'
				}).inject(this.handleEl);
				addResizeLeft(this.columnEl, options.resizeLimit[0], options.resizeLimit[1]);
				break;
		}

        if (this.options.isCollapsed && this.options.placement!='main'){
            this.columnToggle();
        }

		if (this.handleEl != null){
			this.handleEl.addEvent('dblclick', function(){
				this.columnToggle();
			}.bind(this));
		}

		MUI.rWidth();

	},
	
	close: function(){
	   MUI.closeColumn( this.options.id );
	},

    columnCollapse: function(){
        var column = this.columnEl;

        this.oldWidth = column.getStyle('width').toInt();

        this.resize.detach();
        this.handleEl.removeEvents('dblclick');
        this.handleEl.addEvent('click', function(){
            this.columnExpand();
        }.bind(this));
        this.handleEl.setStyle('cursor', 'pointer').addClass('detached');

        column.setStyle('width', 0);
        this.isCollapsed = true;
        column.addClass('collapsed');
        column.removeClass('expanded');
        MUI.rWidth();
        this.fireEvent('onCollapse');

        return true;
    },

    columnExpand : function(){
        var column = this.columnEl;

        column.setStyle('width', this.oldWidth);
        this.isCollapsed = false;
        column.addClass('expanded');
        column.removeClass('collapsed');

        this.handleEl.removeEvents('click');
        this.handleEl.addEvent('dblclick', function(){
            this.columnCollapse();
        }.bind(this));
        this.resize.attach();
        this.handleEl.setStyle('cursor', Browser.Engine.webkit ? 'col-resize' : 'e-resize').addClass('attached');

        MUI.rWidth();
        this.fireEvent('onExpand');

        return true;
    },

	columnToggle: function(){
		if (this.isCollapsed == false)
            this.columnCollapse();
		else
            this.columnExpand();
	}
});
MUI.Column.implement(new Options, new Events);

/*

Class: Panel
	Create a panel. Panels go one on top of another in columns. Create your columns first and then add your panels. Panels should be created from top to bottom, left to right.

Syntax:
(start code)
	MUI.Panel();
(end)

Arguments:
	options

Options:
	id - The ID of the panel. This must be set when creating the panel.
	column - Where to inject the panel. This must be set when creating the panel.
	loadMethod - ('html', 'xhr', or 'iframe') Defaults to 'html' if there is no contentURL. Defaults to 'xhr' if there is a contentURL. You only really need to set this if using the 'iframe' method. May create a 'panel' loadMethod in the future.
	contentURL - Used if loadMethod is set to 'xhr' or 'iframe'.
	method - ('get', or 'post') The method used to get the data. Defaults to 'get'.
	data - (hash) Data to send with the URL. Defaults to null.
	evalScripts - (boolean) An xhr loadMethod option. Defaults to true.
	evalResponse - (boolean) An xhr loadMethod option. Defaults to false.
	content - (string or element) An html loadMethod option.
	tabsURL - (url)
	tabsData - (hash) Data to send with the URL. Defaults to null.
	tabsOnload - (function)
	header - (boolean) Display the panel header or not
	headerToolbox: (boolean)
	headerToolboxURL: (url)
	headerToolboxOnload: (function)
	height - (number) Height of content area.
	addClass - (string) Add a class to the panel.
	scrollbars - (boolean)
	padding - (object)
	collapsible - (boolean)
	onBeforeBuild - (function) Fired before the panel is created.
	onContentLoaded - (function) Fired after the panel's conten is loaded.
	onResize - (function) Fired when the panel is resized.
	onCollapse - (function) Fired when the panel is collapsed.
	onExpand - (function) Fired when the panel is expanded.

*/

MUI.Panel = new Class({

	Implements: [Events, Options],

	options: {
		id:                 null,
		title:              'New Panel',
		column:             null,
		require:            {
			css:            [],
			images:         [],
			js:             [],
			onload:         null
		},
		loadMethod:         null,
		contentURL:         null,

		// xhr options
		method:             'get',
		data:               null,
		evalScripts:        true,
		evalResponse:       false,

		// html options
		content:            'Panel content',

		// Tabs
		tabsURL:            null,
		tabsData:           null,
		tabsOnload:         $empty,

		header:             true,
		headerToolbox:      false,
		headerToolboxURL:   'pages/lipsum.html',
		headerToolboxOnload: $empty,

		// Style options:
		height:             125,
		addClass:           '',
		scrollbars:         true,
		padding:   		    { top: 0, right: 0, bottom: 0, left: 0 },

		// Other:
		collapsible:	    true,

		// Events
		onBeforeBuild:       $empty,
		onContentLoaded:     $empty,
		onResize:            $empty,
		onCollapse:          $empty,
		onExpand:            $empty

	},
	initialize: function(options){
		this.setOptions(options);
		this.isClosing = false;

		$extend(this, {
			timestamp: $time(),
			isCollapsed: false, // This is probably redundant since we can check for the class
			oldHeight: 0,
			partner: null
		});

		// If panel has no ID, give it one.
		if (this.options.id == null){
			this.options.id = 'panel' + (++MUI.Panels.panelIDCount);
		}

		// Shorten object chain
		var instances = MUI.Panels.instances;
		var instanceID = instances.get(this.options.id);
		var options = this.options;

		// Check to see if there is already a class instance for this panel
		if (instanceID){
			var instance = instanceID;
		}

		// Check if panel already exists
		if ( this.panelEl ){
			return;
		}
		else {
			instances.set(this.options.id, this);
		}

		this.fireEvent('onBeforeBuild');

		if (options.loadMethod == 'iframe') {
			// Iframes have their own padding.
			options.padding = { top: 0, right: 0, bottom: 0, left: 0 };
		}

		this.showHandle = true;
		if( $(options.column).getChildren().length == 0 ) {
			this.showHandle = false;
		}

		this.panelWrapperEl = new Element('div', {
			'id': this.options.id + '_wrapper',
			'class': 'panelWrapper expanded'
		}).inject($(options.column));

		this.panelEl = new Element('div', {
			'id': this.options.id,
			'class': 'panel expanded',
			'styles': {
				'height': options.height
			}
		}).inject(this.panelWrapperEl);

		this.panelEl.store('instance', this);
		
		this.panelEl.addClass(options.addClass);

		this.contentEl = new Element('div', {
			'id': options.id + '_pad',
			'class': 'pad'
		}).inject(this.panelEl);

		// This is in order to use the same variable as the windows do in updateContent.
		// May rethink this.
		this.contentWrapperEl = this.panelEl;

		this.contentEl.setStyles({
			'padding-top': options.padding.top,
			'padding-bottom': options.padding.bottom,
			'padding-left': options.padding.left,
			'padding-right': options.padding.right
		});

		this.panelHeaderEl = new Element('div', {
			'id': this.options.id + '_header',
			'class': 'panel-header',
			'styles': {
				'display': options.header ? 'block' : 'none'
			}
		}).inject(this.panelEl, 'before');

		var columnInstances = MUI.Columns.instances;
		var columnInstance = columnInstances.get(this.options.column);

		if (this.options.collapsible) {
			this.collapseToggleInit();
		}

		if (this.options.headerToolbox) {
			this.panelHeaderToolboxEl = new Element('div', {
				'id': options.id + '_headerToolbox',
				'class': 'panel-header-toolbox'
			}).inject(this.panelHeaderEl);
		}

		this.panelHeaderContentEl = new Element('div', {
			'id': options.id + '_headerContent',
			'class': 'panel-headerContent'
		}).inject(this.panelHeaderEl);

        if (columnInstance.options.sortable) {
            this.panelHeaderEl.setStyle('cursor', 'move');
            columnInstance.options.container.retrieve('sortables').addItems(this.panelWrapperEl);
            if(this.panelHeaderToolboxEl) {
                this.panelHeaderToolboxEl.addEvent('mousedown',function(e) {
                    e=new Event(e).stop();
                    e.target.focus();
                });
                this.panelHeaderToolboxEl.setStyle("cursor","default");
            }
        }

		this.titleEl = new Element('h2', {
			'id': options.id + '_title'
		}).inject(this.panelHeaderContentEl);

		this.handleEl = new Element('div', {
			'id': options.id + '_handle',
			'class': 'horizontalHandle',
			'styles': {
				'display': this.showHandle == true ? 'block' : 'none'
			}
		}).inject(this.panelEl, 'after');

		this.handleIconEl = new Element('div', {
			'id': options.id + '_handle_icon',
			'class': 'handleIcon'
		}).inject(this.handleEl);

		addResizeBottom(options.id);

		if (options.require.css.length || options.require.images.length){
			new MUI.Require({
				css: options.require.css,
				images: options.require.images,
				onload: function(){
					this.newPanel();
				}.bind(this)
			});
		}
		else {
			this.newPanel();
		}
	},
	
	destroy: function(){
	   MUI.closePanel( this.panelEl );
	},
	
	newPanel: function(){

		options = this.options;

		if (this.options.headerToolbox) {
			MUI.updateContent({
				'element': this.panelEl,
				'childElement': this.panelHeaderToolboxEl,
				'loadMethod': 'xhr',
				'url': options.headerToolboxURL,
				'onContentLoaded': options.headerToolboxOnload
			});
		}

		if (options.tabsURL == null) {
			this.titleEl.set('html', options.title);
		} else {
			this.panelHeaderContentEl.addClass('tabs');
			MUI.updateContent({
				'element': this.panelEl,
				'childElement': this.panelHeaderContentEl,
				'loadMethod': 'xhr',
				'url': options.tabsURL,
				'data': options.tabsData,
				'onContentLoaded': options.tabsOnload
			});
		}

		// Add content to panel.
		MUI.updateContent({
			'element': this.panelEl,
			'content': options.content,
			'method': options.method,
			'data': options.data,
			'url': options.contentURL,
			'onContentLoaded': null,
			'require': {
				js: options.require.js,
				onload: options.require.onload
			}
		});

		// Do this when creating and removing panels
		$(options.column).getChildren('.panelWrapper').each(function(panelWrapper){
			panelWrapper.getElement('.panel').removeClass('bottomPanel');
		});
		$(options.column).getChildren('.panelWrapper').getLast().getElement('.panel').addClass('bottomPanel');

		MUI.panelHeight(options.column, this.panelEl, 'new');

	},
	collapseToggleInit: function(options){

		var options = this.options;

		this.panelHeaderCollapseBoxEl = new Element('div', {
			'id': options.id + '_headerCollapseBox',
			'class': 'toolbox'
		}).inject(this.panelHeaderEl);

		if (options.headerToolbox) {
			this.panelHeaderCollapseBoxEl.addClass('divider');
		}

		this.collapseToggleEl = new Element('div', {
			'id': options.id + '_collapseToggle',
			'class': 'panel-collapse icon16',
			'styles': {
				'width': 16,
				'height': 16
			},
			'title': 'Collapse Panel'
		}).inject(this.panelHeaderCollapseBoxEl);

		this.collapseToggleEl.addEvent('click', function(event){
			var panel = this.panelEl;
			var panelWrapper = this.panelWrapperEl

			// Get siblings and make sure they are not all collapsed.
			// If they are all collapsed and the current panel is collapsing
			// Then collapse the column.
			var instances = MUI.Panels.instances;
			var expandedSiblings = [];

			panelWrapper.getAllPrevious('.panelWrapper').each(function(sibling){
				var instance = instances.get(sibling.getElement('.panel').id);
				if (instance.isCollapsed == false){
					expandedSiblings.push(sibling.getElement('.panel').id);
				}
			});

			panelWrapper.getAllNext('.panelWrapper').each(function(sibling){
				var instance = instances.get(sibling.getElement('.panel').id);
				if (instance.isCollapsed == false){
					expandedSiblings.push(sibling.getElement('.panel').id);
				}
			});

			// Collapse Panel
			if (this.isCollapsed == false) {
				var currentColumn = MUI.Columns.instances.get($(options.column).id);

				if (expandedSiblings.length == 0 && currentColumn.options.placement != 'main'){
					var currentColumn = MUI.Columns.instances.get($(options.column).id);
					currentColumn.columnToggle();
					return;
				}
				else if (expandedSiblings.length == 0 && currentColumn.options.placement == 'main'){
					return;
				}
				this.oldHeight = panel.getStyle('height').toInt();
				if (this.oldHeight < 10) this.oldHeight = 20;
				this.contentEl.setStyle('position', 'absolute'); // This is so IE6 and IE7 will collapse the panel all the way
				panel.setStyle('height', 0);
				this.isCollapsed = true;
				panelWrapper.addClass('collapsed');
				panelWrapper.removeClass('expanded');
				MUI.panelHeight(options.column, panel, 'collapsing');
				MUI.panelHeight(); // Run this a second time for panels within panels
				this.collapseToggleEl.removeClass('panel-collapsed');
				this.collapseToggleEl.addClass('panel-expand');
				this.collapseToggleEl.setProperty('title','Expand Panel');
				this.fireEvent('onCollapse');
			}

			// Expand Panel
			else {
				this.contentEl.setStyle('position', null); // This is so IE6 and IE7 will collapse the panel all the way
				panel.setStyle('height', this.oldHeight);
				this.isCollapsed = false;
				panelWrapper.addClass('expanded');
				panelWrapper.removeClass('collapsed');
				MUI.panelHeight(this.options.column, panel, 'expanding');
				MUI.panelHeight(); // Run this a second time for panels within panels
				this.collapseToggleEl.removeClass('panel-expand');
				this.collapseToggleEl.addClass('panel-collapsed');
				this.collapseToggleEl.setProperty('title','Collapse Panel');
				this.fireEvent('onExpand');
			}
		}.bind(this));
	}
});
MUI.Panel.implement(new Options, new Events);

/*
  	arguments:
		column - The column to resize the panels in
		changing -  The panel that is collapsing, expanding, or new
  		action - collapsing, expanding, or new

*/

MUI.extend({
	// Panel Height
	panelHeight: function(column, changing, action){
		if (column != null) {
			MUI.panelHeight2($(column), changing, action);
		}
		else {
			$$('.column').each(function(column){
				MUI.panelHeight2(column);
			}.bind(this));
		}
	},
	/*

	actions can be new, collapsing or expanding.

	*/
	panelHeight2: function(column, changing, action){

		var instances = MUI.Panels.instances;

		var parent = column.getParent();
		var columnHeight = parent.getStyle('height').toInt();
		if (Browser.Engine.trident4 && parent == MUI.Desktop.pageWrapper) {
			columnHeight -= 1;
		}
		column.setStyle('height', columnHeight);

		// Get column panels
		var panels = [];
		column.getChildren('.panelWrapper').each( function(panelWrapper){
			panels.push(panelWrapper.getElement('.panel'));
		}.bind(this));

		// Get expanded column panels
		var panelsExpanded = [];
		column.getChildren('.expanded').each( function(panelWrapper){
			panelsExpanded.push(panelWrapper.getElement('.panel'));
		}.bind(this));

		 // All the panels in the column whose height will be effected.
		var panelsToResize = [];

		// The panel with the greatest height. Remainders will be added to this panel
		var tallestPanel;
		var tallestPanelHeight = 0;

		this.panelsTotalHeight = 0; // Height of all the panels in the column
		this.height = 0; // Height of all the elements in the column

		// Set panel resize partners
		panels.each(function(panel){
			instance = instances.get(panel.id);
			if (panel.getParent().hasClass('expanded') && panel.getParent().getNext('.expanded')) {
				instance.partner = panel.getParent().getNext('.expanded').getElement('.panel');
				instance.resize.attach();
				instance.handleEl.setStyles({
					'display': 'block',
					'cursor': Browser.Engine.webkit ? 'row-resize' : 'n-resize'
				}).removeClass('detached');
			} else {
				instance.resize.detach();
				instance.handleEl.setStyles({
					'display': 'none',
					'cursor': null
				}).addClass('detached');
			}
			if (panel.getParent().getNext('.panelWrapper') == null) {
				instance.handleEl.hide();
			}
		}.bind(this));

		// Add panels to panelsToResize
		// Get the total height of all the resizable panels
		// Get the total height of all the column's children
		column.getChildren().each(function(panelWrapper){

		panelWrapper.getChildren().each(function(el){

			if (el.hasClass('panel')){
				var instance = instances.get(el.id);

				// Are any next siblings Expanded?
				anyNextSiblingsExpanded = function(el){
					var test;
					el.getParent().getAllNext('.panelWrapper').each(function(sibling){
						var siblingInstance = instances.get(sibling.getElement('.panel').id);
						if (siblingInstance.isCollapsed == false){
							test = true;
						}
					}.bind(this));
					return test;
				}.bind(this);

				// If a next sibling is expanding, are any of the nexts siblings of the expanding sibling Expanded?
				anyExpandingNextSiblingsExpanded = function(el){
					var test;
					changing.getParent().getAllNext('.panelWrapper').each(function(sibling){
						var siblingInstance = instances.get(sibling.getElement('.panel').id);
						if (siblingInstance.isCollapsed == false){
							test = true;
						}
					}.bind(this));
					return test;
				}.bind(this);

				// Is the panel that is collapsing, expanding, or new located after this panel?
				anyNextContainsChanging = function(el){
					var allNext = [];
					el.getParent().getAllNext('.panelWrapper').each(function(panelWrapper){
						allNext.push(panelWrapper.getElement('.panel'));
					}.bind(this));
					var test = allNext.contains(changing);
					return test;
				}.bind(this);

				nextExpandedChanging = function(el){
					var test;
					if (el.getParent().getNext('.expanded')){
						if (el.getParent().getNext('.expanded').getElement('.panel') == changing) test = true;
					}
					return test;
				}

				// NEW PANEL
				// Resize panels that are "new" or not collapsed
				if (action == 'new') {
					if (!instance.isCollapsed && el != changing) {
						panelsToResize.push(el);
						this.panelsTotalHeight += el.offsetHeight.toInt();
					}
				}

				// COLLAPSING PANELS and CURRENTLY EXPANDED PANELS
				// Resize panels that are not collapsed.
				// If a panel is collapsing resize any expanded panels below.
				// If there are no expanded panels below it, resize the expanded panels above it.
				else if (action == null || action == 'collapsing' ){
					if (!instance.isCollapsed && (!anyNextContainsChanging(el) || !anyNextSiblingsExpanded(el))){
						panelsToResize.push(el);
						this.panelsTotalHeight += el.offsetHeight.toInt();
					}
				}

				// EXPANDING PANEL
				// Resize panels that are not collapsed and are not expanding.
				// Resize any expanded panels below the expanding panel.
				// If there are no expanded panels below the expanding panel, resize the first expanded panel above it.
				else if (action == 'expanding' && !instance.isCollapsed  && el != changing){
					if (!anyNextContainsChanging(el) || (!anyExpandingNextSiblingsExpanded(el) && nextExpandedChanging(el))){
						panelsToResize.push(el);
						this.panelsTotalHeight += el.offsetHeight.toInt();
					}
				}

				if (el.style.height){
					this.height += el.getStyle('height').toInt();
				}
			}
			else {
				this.height += el.offsetHeight.toInt();
			}
		}.bind(this));

		}.bind(this));

		// Get the remaining height
		var remainingHeight = column.offsetHeight.toInt() - this.height;

		this.height = 0;

		// Get height of all the column's children
		column.getChildren().each(function(el){
			this.height += el.offsetHeight.toInt();
		}.bind(this));

		var remainingHeight = column.offsetHeight.toInt() - this.height;

		panelsToResize.each(function(panel){
			var ratio = panel.offsetHeight.toInt() >= 1 ? this.panelsTotalHeight / panel.offsetHeight.toInt() : 1; 
			var newPanelHeight = panel.getStyle('height').toInt() + (remainingHeight / ratio);
			if (newPanelHeight < 1){
				newPanelHeight = 0;
			}
			panel.setStyle('height', newPanelHeight);
			if(!$defined(action)) instances[panel.id].fireEvent('onResize'); 
		}.bind(this));

		// Make sure the remaining height is 0. If not add/subtract the
		// remaining height to the tallest panel. This makes up for browser resizing,
		// off ratios, and users trying to give panels too much height.

		// Get height of all the column's children
		this.height = 0;
		column.getChildren().each(function(panelWrapper){
			panelWrapper.getChildren().each(function(el){
				this.height += el.offsetHeight.toInt();
				if (el.hasClass('panel') && el.getStyle('height').toInt() > tallestPanelHeight){
					tallestPanel = el;
					tallestPanelHeight = el.getStyle('height').toInt();
				}
			}.bind(this));
		}.bind(this));

		var remainingHeight = column.offsetHeight.toInt() - this.height;

		if (remainingHeight != 0 && tallestPanelHeight > 0){
			var calculatedPanelHeigh = tallestPanel.getStyle('height').toInt() + remainingHeight;
			if( calculatedPanelHeigh < 1){
				tallestPanel.setStyle('height', 0 );
			}else {
				tallestPanel.setStyle('height', calculatedPanelHeigh );
			}
		}

		parent.getChildren('.columnHandle').each(function(handle){
			var parent = handle.getParent();
			if (parent.getStyle('height').toInt() < 1) return; // Keeps IE7 and 8 from throwing an error when collapsing a panel within a panel
			var handleHeight = parent.getStyle('height').toInt() - handle.getStyle('border-top').toInt() - handle.getStyle('border-bottom').toInt();
			if (Browser.Engine.trident4 && parent == MUI.Desktop.pageWrapper){
				handleHeight -= 1;
			}
			handle.setStyle('height', handleHeight);
		});

		panelsExpanded.each(function(panel){
			MUI.resizeChildren(panel);
		}.bind(this));

	},
	// May rename this resizeIframeEl()
	resizeChildren: function(panel){
		var instances = MUI.Panels.instances;
		var instance = instances.get(panel.id);
		var contentWrapperEl = instance.contentWrapperEl;

		if (instance.iframeEl) {
			if (!Browser.Engine.trident) {
				instance.iframeEl.setStyles({
					'height': contentWrapperEl.getStyle('height'),
					'width': contentWrapperEl.offsetWidth - contentWrapperEl.getStyle('border-left').toInt() - contentWrapperEl.getStyle('border-right').toInt()
				});
			}
			else {
				// The following hack is to get IE8 RC1 IE8 Standards Mode to properly resize an iframe
				// when only the vertical dimension is changed.
				instance.iframeEl.setStyles({
					'height': contentWrapperEl.getStyle('height'),
					'width': contentWrapperEl.offsetWidth - contentWrapperEl.getStyle('border-left').toInt() - contentWrapperEl.getStyle('border-right').toInt() - 1
				});
				instance.iframeEl.setStyles({
					'width': contentWrapperEl.offsetWidth - contentWrapperEl.getStyle('border-left').toInt() - contentWrapperEl.getStyle('border-right').toInt()
				});
			}
		}

	},
	// Remaining Width
	rWidth: function(container){
		if (container == null) {
			var container = MUI.Desktop.desktop;
		}
		container.getElements('.rWidth').each(function(column){
			var currentWidth = column.offsetWidth.toInt();
			currentWidth -= column.getStyle('border-left').toInt();
			currentWidth -= column.getStyle('border-right').toInt();

			var parent = column.getParent();
			this.width = 0;

			// Get the total width of all the parent element's children
			parent.getChildren().each(function(el){
				if (el.hasClass('mocha') != true) {
					this.width += el.offsetWidth.toInt();
				}
			}.bind(this));

			// Add the remaining width to the current element
			var remainingWidth = parent.offsetWidth.toInt() - this.width;
			var newWidth = currentWidth + remainingWidth;
			if (newWidth < 1) newWidth = 0;
			column.setStyle('width', newWidth);
			column.getChildren('.panel').each(function(panel){
				panel.setStyle('width', newWidth - panel.getStyle('border-left').toInt() - panel.getStyle('border-right').toInt());
				MUI.resizeChildren(panel);
			}.bind(this));

		});
	}

});

function addResizeRight(element, min, max){
	if (!$(element)) return;
	element = $(element);

	var instances = MUI.Columns.instances;
	var instance = instances.get(element.id);

	var handle = element.getNext('.columnHandle');
	handle.setStyle('cursor', Browser.Engine.webkit ? 'col-resize' : 'e-resize');
	if (!min) min = 50;
	if (!max) max = 250;
	if (Browser.Engine.trident) {
		handle.addEvents({
			'mousedown': function(){
				handle.setCapture();
			},
			'mouseup': function(){
				handle.releaseCapture();
			}
		});
	}
	instance.resize = element.makeResizable({
		handle: handle,
		modifiers: {
			x: 'width',
			y: false
		},
		limit: {
			x: [min, max]
		},
		onStart: function(){
			element.getElements('iframe').setStyle('visibility', 'hidden');
			element.getNext('.column').getElements('iframe').setStyle('visibility', 'hidden');
		}.bind(this),
		onDrag: function(){
			if (Browser.Engine.gecko) {
				$$('.panel').each(function(panel){
					if (panel.getElements('.mochaIframe').length == 0) {
						panel.hide(); // Fix for a rendering bug in FF
					}
				});
			}
			MUI.rWidth(element.getParent());
			if (Browser.Engine.gecko) {
				$$('.panel').show(); // Fix for a rendering bug in FF
			}
			if (Browser.Engine.trident4) {
				element.getChildren().each(function(el){
					var width = $(element).getStyle('width').toInt();
					width -= el.getStyle('border-right').toInt();
					width -= el.getStyle('border-left').toInt();
					width -= el.getStyle('padding-right').toInt();
					width -= el.getStyle('padding-left').toInt();
					el.setStyle('width', width);
				}.bind(this));
			}
		}.bind(this),
		onComplete: function(){
			MUI.rWidth(element.getParent());
			element.getElements('iframe').setStyle('visibility', 'visible');
			element.getNext('.column').getElements('iframe').setStyle('visibility', 'visible');
			instance.fireEvent('onResize');
		}.bind(this)
	});
}

function addResizeLeft(element, min, max){
	if (!$(element)) return;
	element = $(element);

	var instances = MUI.Columns.instances;
	var instance = instances.get(element.id);

	var handle = element.getPrevious('.columnHandle');
	handle.setStyle('cursor', Browser.Engine.webkit ? 'col-resize' : 'e-resize');
	var partner = element.getPrevious('.column');
	if (!min) min = 50;
	if (!max) max = 250;
	if (Browser.Engine.trident){
		handle.addEvents({
			'mousedown': function(){
				handle.setCapture();
			},
			'mouseup': function(){
				handle.releaseCapture();
			}
		});
	}
	instance.resize = element.makeResizable({
		handle: handle,
		modifiers: {x: 'width' , y: false},
		invert: true,
		limit: { x: [min, max] },
		onStart: function(){
			$(element).getElements('iframe').setStyle('visibility','hidden');
			partner.getElements('iframe').setStyle('visibility','hidden');
		}.bind(this),
		onDrag: function(){
			MUI.rWidth(element.getParent());
		}.bind(this),
		onComplete: function(){
			MUI.rWidth(element.getParent());
			$(element).getElements('iframe').setStyle('visibility','visible');
			partner.getElements('iframe').setStyle('visibility','visible');
			instance.fireEvent('onResize');
			instances[partner.id].fireEvent('onResize');
		}.bind(this)
	});
}

function addResizeBottom(element){
	if (!$(element)) return;
	var element = $(element);

	var instances = MUI.Panels.instances;
	var instance = instances.get(element.id);
	var handle = instance.handleEl;
	handle.setStyle('cursor', Browser.Engine.webkit ? 'row-resize' : 'n-resize');
	partner = instance.partner;
	min = 0;
	max = function(){
		return element.getStyle('height').toInt() + partner.getStyle('height').toInt();
	}.bind(this);

	if (Browser.Engine.trident) {
		handle.addEvents({
			'mousedown': function(){
				handle.setCapture();
			},
			'mouseup': function(){
				handle.releaseCapture();
			}
		});
	}
	instance.resize = element.makeResizable({
		handle: handle,
		modifiers: {x: false, y: 'height'},
		limit: { y: [min, max] },
		invert: false,
		onBeforeStart: function(){
			partner = instance.partner;
			this.originalHeight = element.getStyle('height').toInt();
			this.partnerOriginalHeight = partner.getStyle('height').toInt();
		}.bind(this),
		onStart: function(){
			if (instance.iframeEl) {
				if (!Browser.Engine.trident) {
					instance.iframeEl.setStyle('visibility', 'hidden');
					partner.getElements('iframe').setStyle('visibility','hidden');
				}
				else {
					instance.iframeEl.hide();
					partner.getElements('iframe').hide();
				}
			}

		}.bind(this),
		onDrag: function(){
			partnerHeight = partnerOriginalHeight;
			partnerHeight += (this.originalHeight - element.getStyle('height').toInt());
			partner.setStyle('height', partnerHeight);
			MUI.resizeChildren(element, element.getStyle('height').toInt());
			MUI.resizeChildren(partner, partnerHeight);
			element.getChildren('.column').each( function(column){
				MUI.panelHeight(column);
			});
			partner.getChildren('.column').each( function(column){
				MUI.panelHeight(column);
			});
		}.bind(this),
		onComplete: function(){
			partnerHeight = partnerOriginalHeight;
			partnerHeight += (this.originalHeight - element.getStyle('height').toInt());
			partner.setStyle('height', partnerHeight);
			MUI.resizeChildren(element, element.getStyle('height').toInt());
			MUI.resizeChildren(partner, partnerHeight);
			element.getChildren('.column').each( function(column){
				MUI.panelHeight(column);
			});
			partner.getChildren('.column').each( function(column){
				MUI.panelHeight(column);
			});
			if (instance.iframeEl) {
				if (!Browser.Engine.trident) {
					instance.iframeEl.setStyle('visibility', 'visible');
					partner.getElements('iframe').setStyle('visibility','visible');
				}
				else {
					instance.iframeEl.show();
					partner.getElements('iframe').show();
					// The following hack is to get IE8 Standards Mode to properly resize an iframe
					// when only the vertical dimension is changed.
					var width = instance.iframeEl.getStyle('width').toInt();
					instance.iframeEl.setStyle('width', width - 1);
					MUI.rWidth();
					instance.iframeEl.setStyle('width', width);
				}
			}
			instance.fireEvent('onResize');
		}.bind(this)
	});
}

MUI.extend({
	/*

	Function: closeColumn
		Destroys/removes a column.

	Syntax:
	(start code)
		MUI.closeColumn();
	(end)

	Arguments:
		columnEl - the ID of the column to be closed

	Returns:
		true - the column was closed
		false - the column was not closed

	*/
	closeColumn: function(columnEl){
        columnEl=$(columnEl);
        if(columnEl==null) return;
		var instances = MUI.Columns.instances;
		var instance = instances.get(columnEl.id);
		if (instance==null || instance.isClosing) return;

		instance.isClosing = true;

		// Destroy all the panels in the column.
		var panels = $(columnEl).getElements('.panel');
		panels.each(function(panel){
			MUI.closePanel(panel.id);
		}.bind(this));

		if (Browser.Engine.trident) {
			columnEl.dispose();
			if (instance.handleEl != null) {
				instance.handleEl.dispose();
			}
		}
		else {
			columnEl.destroy();
			if (instance.handleEl != null) {
				instance.handleEl.destroy();
			}
		}        

		if (MUI.Desktop) {
			MUI.Desktop.resizePanels();
		}

        var sortables=instance.options.container.retrieve('sortables');
        if(sortables) sortables.removeLists(columnEl);

		instances.erase(instance.options.id);
		return true;
	},
	/*

	Function: closePanel
		Destroys/removes a panel.

	Syntax:
	(start code)
		MUI.closePanel();
	(end)

	Arguments:
		panelEl - the ID of the panel to be closed

	Returns:
		true - the panel was closed
		false - the panel was not closed

	*/
	closePanel: function(panelEl){
      panelEl=$(panelEl);
      if( panelEl==null) return;
		var instances = MUI.Panels.instances;
		var instance = instances.get(panelEl.id);
		if( panelEl != $(panelEl ) || instance.isClosing ) return;

		var column = instance.options.column;
		instance.isClosing = true;

		var columnInstances = MUI.Columns.instances;
		var columnInstance = columnInstances.get(column);

		if( columnInstance.options.sortable ){
			columnInstance.options.container.retrieve( 'sortables' ).removeItems( instance.panelWrapperEl );
		}

      instance.removeEvents();
		instance.panelWrapperEl.destroy();

		if( MUI.Desktop ) { MUI.Desktop.resizePanels(); }

		// Do this when creating and removing panels
      var panels=$(column).getElements('.panelWrapper');
		panels.each(function(panelWrapper){
			panelWrapper.getElement('.panel').removeClass('bottomPanel');
		});
		
      if(panels.length>0) panels.getLast().getElement('.panel').addClass('bottomPanel');

		instances.erase( instance.options.id );
		return true;
	}
});
/*
---

name: Tabs

script: Tabs.js

description: Functionality for window tabs.

copyright: (c) 2007-2008 Greg Houston, <http://greghoustondesign.com/>.	

license: MIT-style license.

requires:
  - MochaUI/MUI
  - MochaUI/MUI.Windows
  - MochaUI/MUI.Column
  - MochaUI/MUI.Panel

provides: [MUI.initializeTabs]

...
*/





MUI.extend({
	/*

	Function: initializeTabs
		Add click event to each list item that fires the selected function.

	*/
	initializeTabs: function(el, target){
		$(el).setStyle('list-style', 'none'); // This is to fix a glitch that occurs in IE8 RC1 when dynamically switching themes
		$(el).getElements('li').each(function(listitem){
			var link = listitem.getFirst('a').addEvent('click', function(e){
				e.preventDefault();
			});
			listitem.addEvent('click', function(e){
				MUI.updateContent({
					'element':  $(target),
					'url':      link.get('href')
				});
				MUI.selected(this, el);
			});
		});
	},
	/*

	Function: selected
		Add "selected" class to current list item and remove it from sibling list items.

	Syntax:
		(start code)
			selected(el, parent);
		(end)

Arguments:
	el - the list item
	parent - the ul

	*/
	selected: function(el, parent){
		$(parent).getChildren().each(function(listitem){
			listitem.removeClass('selected');
		});
		el.addClass('selected');
	}
});

/*
---

name: Window

script: Window.js

description: Build windows.

copyright: (c) 2007-2009 Greg Houston, <http://greghoustondesign.com/>.

license: MIT-style license.

requires: [MochaUI/MUI]

provides: [MUI.Windows]

...
*/






MUI.files[MUI.path.source + 'Window/Window.js'] = 'loading';
//$require(MUI.themePath() + '/css/Dock.css');

/*
Class: Window
	Creates a single MochaUI window.

Syntax:
	(start code)
	new MUI.Window(options);
	(end)

Arguments:
	options

Options:
	id - The ID of the window. If not defined, it will be set to 'win' + windowIDCount.
	title - The title of the window.
	icon - Place an icon in the window's titlebar. This is either set to false or to the url of the icon. It is set up for icons that are 16 x 16px.
	type - ('window', 'modal', 'modal2', or 'notification') Defaults to 'window'. Modals should be created with new MUI.Modal(options).
	loadMethod - ('html', 'xhr', or 'iframe') Defaults to 'html' if there is no contentURL. Defaults to 'xhr' if there is a contentURL. You only really need to set this if using the 'iframe' method.
	contentURL - Used if loadMethod is set to 'xhr' or 'iframe'.
	closeAfter - Either false or time in milliseconds. Closes the window after a certain period of time in milliseconds. This is particularly useful for notifications.
	evalScripts - (boolean) An xhr loadMethod option. Defaults to true.
	evalResponse - (boolean) An xhr loadMethod option. Defaults to false.
	content - (string or element) An html loadMethod option.
	toolbar - (boolean) Create window toolbar. Defaults to false. This can be used for tabs, media controls, and so forth.
	toolbarPosition - ('top' or 'bottom') Defaults to top.
	toolbarHeight - (number)
	toolbarURL - (url) Defaults to 'pages/lipsum.html'.
	toolbarContent - (string)
	toolbarOnload - (function)
	toolbar2 - (boolean) Create window toolbar. Defaults to false. This can be used for tabs, media controls, and so forth.
	toolbar2Position - ('top' or 'bottom') Defaults to top.
	toolbar2Height - (number)
	toolbar2URL - (url) Defaults to 'pages/lipsum.html'.
	toolbar2Content - (string)
	toolbar2Onload - (function)
	container - (element ID) Element the window is injected in. The container defaults to 'desktop'. If no desktop then to document.body. Use 'pageWrapper' if you don't want the windows to overlap the toolbars.
	restrict - (boolean) Restrict window to container when dragging.
	shape - ('box' or 'gauge') Shape of window. Defaults to 'box'.
	collapsible - (boolean) Defaults to true.
	minimizable - (boolean) Requires MUI.Desktop and MUI.Dock. Defaults to true if dependenices are met.
	maximizable - (boolean) Requires MUI.Desktop. Defaults to true if dependenices are met.
	closable - (boolean) Defaults to true.
	storeOnClose - (boolean) Hides a window and it's dock tab rather than destroying them on close. If you try to create the window again it will unhide the window and dock tab.
	modalOverlayClose - (boolean) Whether or not you can close a modal by clicking on the modal overlay. Defaults to true.
	draggable - (boolean) Defaults to false for modals; otherwise true.
	draggableGrid - (false or number) Distance in pixels for snap-to-grid dragging. Defaults to false.
	draggableLimit - (false or number) An object with x and y properties used to limit the movement of the Window. Defaults to false.
	draggableSnap - (boolean) The distance to drag before the Window starts to respond to the drag. Defaults to false.
	resizable - (boolean) Defaults to false for modals, notifications and gauges; otherwise true.
	resizeLimit - (object) Minimum and maximum width and height of window when resized.
	addClass - (string) Add a class to the window for more control over styling.
	width - (number) Width of content area.
	height - (number) Height of content area.
	headerHeight - (number) Height of window titlebar.
	footerHeight - (number) Height of window footer.
	cornerRadius - (number)
	x - (number) If x and y are left undefined the window is centered on the page.
	y - (number)
	scrollbars - (boolean)
	padding - (object)
	shadowBlur - (number) Width of shadows.
	shadowOffset - Should be positive and not be greater than the ShadowBlur.
	controlsOffset - Change this if you want to reposition the window controls.
	useCanvas - (boolean) Set this to false if you don't want a canvas body.
	useCanvasControls - (boolean) Set this to false if you wish to use images for the buttons.
	useSpinner - (boolean) Toggles whether or not the ajax spinners are displayed in window footers. Defaults to true.
	headerStartColor - ([r,g,b,]) Titlebar gradient's top color
	headerStopColor - ([r,g,b,]) Titlebar gradient's bottom color
	bodyBgColor - ([r,g,b,]) Background color of the main canvas shape
	minimizeBgColor - ([r,g,b,]) Minimize button background color
	minimizeColor - ([r,g,b,]) Minimize button color
	maximizeBgColor - ([r,g,b,]) Maximize button background color
	maximizeColor - ([r,g,b,]) Maximize button color
	closeBgColor - ([r,g,b,]) Close button background color
	closeColor - ([r,g,b,]) Close button color
	resizableColor - ([r,g,b,]) Resizable icon color
	onBeforeBuild - (function) Fired just before the window is built.
	onContentLoaded - (function) Fired when content is successfully loaded via XHR or Iframe.
	onFocus - (function)  Fired when the window is focused.
	onBlur - (function) Fired when window loses focus.
	onResize - (function) Fired when the window is resized.
	onMinimize - (function) Fired when the window is minimized.
	onMaximize - (function) Fired when the window is maximized.
	onRestore - (function) Fired when a window is restored from minimized or maximized.
	onClose - (function) Fired just before the window is closed.
	onCloseComplete - (function) Fired after the window is closed.

Returns:
	Window object.

Example:
	Define a window. It is suggested you name the function the same as your window ID + "Window".
	(start code)
	var mywindowWindow = function(){
		new MUI.Window({
			id: 'mywindow',
			title: 'My Window',
			loadMethod: 'xhr',
			contentURL: 'pages/lipsum.html',
			width: 340,
			height: 150
		});
	}
	(end)

Example:
	Create window onDomReady.
	(start code)
	window.addEvent('domready', function(){
		mywindow();
	});
	(end)

Example:
	Add link events to build future windows. It is suggested you give your anchor the same ID as your window + "WindowLink" or + "WindowLinkCheck". Use the latter if it is a link in the menu toolbar.

	If you wish to add links in windows that open other windows remember to add events to those links when the windows are created.

	(start code)
	// Javascript:
	if ($('mywindowLink')){
		$('mywindowLink').addEvent('click', function(e) {
			new Event(e).stop();
			mywindow();
		});
	}

	// HTML:
	<a id="mywindowLink" href="pages/lipsum.html">My Window</a>
	(end)


	Loading Content with an XMLHttpRequest(xhr):
		For content to load via xhr all the files must be online and in the same domain. If you need to load content from another domain or wish to have it work offline, load the content in an iframe instead of using the xhr option.

	Iframes:
		If you use the iframe loadMethod your iframe will automatically be resized when the window it is in is resized. If you want this same functionality when using one of the other load options simply add class="mochaIframe" to those iframes and they will be resized for you as well.

*/

// Having these options outside of the Class allows us to add, change, and remove
// individual options without rewriting all of them.

//= require ../MochaUI/Core.js
//= require ../MochaUI/Dock.js
//= require ../MochaUI/Layout.js

MUI.extend({
	Windows: {
		instances:      new Hash(),
		indexLevel:     100,          // Used for window z-Index
		windowIDCount:  0,            // Used for windows without an ID defined by the user
		windowsVisible: true,         // Ctrl-Alt-Q to toggle window visibility
		focusingWindow: false
	}
});

MUI.Windows.windowOptions = {
	id:                null,
	title:             'New Window',
	icon:              false,
	type:              'window',
	require:           {
		css:           [],
		images:        [],
		js:            [],
		onload:        null
	},
	loadMethod:        null,
	method:	           'get',
	contentURL:        null,
	data:              null,

	closeAfter:        false,

	// xhr options
	evalScripts:       true,
	evalResponse:      false,

	// html options
	content:           'Window content',

	// Toolbar
	toolbar:           false,
	toolbarPosition:   'top',
	toolbarHeight:     29,
	toolbarURL:        'pages/lipsum.html',
	toolbarData:	   null,
	toolbarContent:    '',
	toolbarOnload:     $empty,

	// Toolbar
	toolbar2:           false,
	toolbar2Position:   'bottom',
	toolbar2Height:     29,
	toolbar2URL:        'pages/lipsum.html',
	toolbar2Data:	    null,
	toolbar2Content:    '',
	toolbar2Onload:     $empty,

	// Container options
	container:         null,
	restrict:          true,
	shape:             'box',

	// Window Controls
	collapsible:       true,
	minimizable:       true,
	maximizable:       true,
	closable:          true,

	// Close options
	storeOnClose:       false,

	// Modal options
	modalOverlayClose: true,

	// Draggable
	draggable:         null,
	draggableGrid:     false,
	draggableLimit:    false,
	draggableSnap:     false,

	// Resizable
	resizable:         null,
	resizeLimit:       {'x': [250, 2500], 'y': [125, 2000]},

	// Style options:
	addClass:          '',
	width:             300,
	height:            125,
	headerHeight:      25,
	footerHeight:      25,
	cornerRadius:      8,
	x:                 null,
	y:                 null,
	scrollbars:        true,
	padding:   		   { top: 10, right: 12, bottom: 10, left: 12 },
	shadowBlur:        5,
	shadowOffset:      {'x': 0, 'y': 1},
	controlsOffset:    {'right': 6, 'top': 6},
	useCanvas:         true,
	useCanvasControls: true,
	useSpinner:        true,

	// Color options:
	headerStartColor:  [250, 250, 250],
	headerStopColor:   [229, 229, 229],
	bodyBgColor:       [229, 229, 229],
	minimizeBgColor:   [255, 255, 255],
	minimizeColor:     [0, 0, 0],
	maximizeBgColor:   [255, 255, 255],
	maximizeColor:     [0, 0, 0],
	closeBgColor:      [255, 255, 255],
	closeColor:        [0, 0, 0],
	resizableColor:    [254, 254, 254],

	// Events
	onBeforeBuild:     $empty,
	onContentLoaded:   $empty,
	onFocus:           $empty,
	onBlur:            $empty,
	onResize:          $empty,
	onMinimize:        $empty,
	onMaximize:        $empty,
	onRestore:         $empty,
	onClose:           $empty,
	onCloseComplete:   $empty
};

MUI.Windows.windowOptionsOriginal = $merge(MUI.Windows.windowOptions);

MUI.Window = new Class({

	Implements: [Events, Options],

	options: MUI.Windows.windowOptions,

	initialize: function(options){
		this.setOptions(options);

		// Shorten object chain
		var options = this.options;

		$extend(this, {
			mochaControlsWidth: 0,
			minimizebuttonX:  0,  // Minimize button horizontal position
			maximizebuttonX: 0,  // Maximize button horizontal position
			closebuttonX: 0,  // Close button horizontal position
			headerFooterShadow: options.headerHeight + options.footerHeight + (options.shadowBlur * 2),
			oldTop: 0,
			oldLeft: 0,
			isMaximized: false,
			isMinimized: false,
			isCollapsed: false,
			timestamp: $time()
		});

		if (options.type != 'window'){
			options.container = document.body;
			options.minimizable = false;
		}
		if (!options.container){
			options.container = MUI.Desktop && MUI.Desktop.desktop ? MUI.Desktop.desktop : document.body;
		}

		// Set this.options.resizable to default if it was not defined
		if (options.resizable == null){
			if (options.type != 'window' || options.shape == 'gauge'){
				options.resizable = false;
			}
			else {
				options.resizable = true;
			}
		}

		// Set this.options.draggable if it was not defined
		if (options.draggable == null){
			options.draggable = options.type != 'window' ? false : true;
		}

		// Gauges are not maximizable or resizable
		if (options.shape == 'gauge' || options.type == 'notification'){
			options.collapsible = false;
			options.maximizable = false;
			options.contentBgColor = 'transparent';
			options.scrollbars = false;
			options.footerHeight = 0;
		}
		if (options.type == 'notification'){
			options.closable = false;
			options.headerHeight = 0;
		}

		// Minimizable, dock is required and window cannot be modal
		if (MUI.Dock && $(MUI.options.dock)){
			if (MUI.Dock.dock && options.type != 'modal' && options.type != 'modal2'){
				options.minimizable = options.minimizable;
			}
		}
		else {
			options.minimizable = false;
		}

		// Maximizable, desktop is required
		options.maximizable = MUI.Desktop && MUI.Desktop.desktop && options.maximizable && options.type != 'modal' && options.type != 'modal2';

		if (this.options.type == 'modal2') {
			this.options.shadowBlur = 0;
			this.options.shadowOffset = {'x': 0, 'y': 0};
			this.options.useSpinner = false;
			this.options.useCanvas = false;
			this.options.footerHeight = 0;
			this.options.headerHeight = 0;
		}

		// If window has no ID, give it one.
		options.id = options.id || 'win' + (++MUI.Windows.windowIDCount);

		this.windowEl = $(options.id);

		if (options.require.css.length || options.require.images.length){
			new MUI.Require({
				css: options.require.css,
				images: options.require.images,
				onload: function(){
					this.newWindow();
				}.bind(this)
			});
		}
		else {
			this.newWindow();
		}

		// Return window object
		return this;
	},
	saveValues: function(){
		var coordinates = this.windowEl.getCoordinates();
		this.options.x = coordinates.left.toInt();
		this.options.y = coordinates.top.toInt();
	},

	/*

	Internal Function: newWindow

	Arguments:
		properties

	*/
	newWindow: function(properties){ // options is not doing anything

		// Shorten object chain
		var instances = MUI.Windows.instances;
		var instanceID = MUI.Windows.instances.get(this.options.id);
		var options = this.options;

		// Here we check to see if there is already a class instance for this window
		if (instanceID) var instance = instanceID;

		// Check if window already exists and is not in progress of closing
		if ( this.windowEl && !this.isClosing ){
			 // Restore if minimized
			if (instance.isMinimized){
				MUI.Dock.restoreMinimized(this.windowEl);
			}
			// Expand and focus if collapsed
			else if (instance.isCollapsed){
				MUI.collapseToggle(this.windowEl);
				setTimeout(MUI.focusWindow.pass(this.windowEl, this),10);
			}
			else if (this.windowEl.hasClass('windowClosed')){

				if (instance.check) instance.check.show();

				this.windowEl.removeClass('windowClosed');
				this.windowEl.setStyle('opacity', 0);
				this.windowEl.addClass('mocha');

				if (MUI.Dock && $(MUI.options.dock) && instance.options.type == 'window') {
					var currentButton = $(instance.options.id + '_dockTab');
					if (currentButton != null) {
						currentButton.show();
					}
					MUI.Desktop.setDesktopSize();
				}

				instance.displayNewWindow();

			}
			// Else focus
			else {
				var coordinates = document.getCoordinates();
				if (this.windowEl.getStyle('left').toInt() > coordinates.width || this.windowEl.getStyle('top').toInt() > coordinates.height){
					MUI.centerWindow(this.windowEl);
				}
				setTimeout(MUI.focusWindow.pass(this.windowEl, this),10);
				if (MUI.options.standardEffects == true) {
					this.windowEl.shake();
				}
			}
			return;
		}
		else {
			instances.set(options.id, this);
		}

		this.isClosing = false;
		this.fireEvent('onBeforeBuild');

		// Create window div
		MUI.Windows.indexLevel++;
		this.windowEl = new Element('div', {
			'class': 'mocha',
			'id': options.id,
			'styles': {
				'position': 'absolute',
				'width': options.width,
				'height': options.height,
				'display': 'block',
				'opacity': 0,
				'zIndex': MUI.Windows.indexLevel += 2
			}
		});

		this.windowEl.store('instance', this);

		this.windowEl.addClass(options.addClass);

		if (options.type == 'modal2') {
			this.windowEl.addClass('modal2');
		}

		// Fix a mouseover issue with gauges in IE7
		if ( Browser.Engine.trident && options.shape == 'gauge') {
			this.windowEl.setStyle('backgroundImage', 'url(../images/spacer.gif)');
		}

		if ((this.options.type == 'modal' || options.type == 'modal2' ) && Browser.Platform.mac && Browser.Engine.gecko){
			if (/Firefox[\/\s](\d+\.\d+)/.test(navigator.userAgent)) {
				var ffversion = new Number(RegExp.$1);
				if (ffversion < 3) {
					this.windowEl.setStyle('position', 'fixed');
				}
			}
		}

		if (options.loadMethod == 'iframe') {
			options.padding = { top: 0, right: 0, bottom: 0, left: 0 };
		}

		// Insert sub elements inside windowEl
		this.insertWindowElements();

		// Set title
		this.titleEl.set('html', options.title);

		this.contentWrapperEl.setStyle('overflow', 'hidden');

		this.contentEl.setStyles({
			'padding-top': options.padding.top,
			'padding-bottom': options.padding.bottom,
			'padding-left': options.padding.left,
			'padding-right': options.padding.right
		});

		if (options.shape == 'gauge'){
			if (options.useCanvasControls){
				this.canvasControlsEl.setStyle('visibility', 'hidden');
			}
			else {
				this.controlsEl.setStyle('visibility', 'hidden');
			}
			this.windowEl.addEvent('mouseover', function(){
				this.mouseover = true;
				var showControls = function(){
					if (this.mouseover != false){
						if (options.useCanvasControls){
							this.canvasControlsEl.setStyle('visibility', 'visible');
						}
						else {
							this.controlsEl.setStyle('visibility', 'visible');
						}
						this.canvasHeaderEl.setStyle('visibility', 'visible');
						this.titleEl.show();
					}
				};
				showControls.delay(0, this);

			}.bind(this));
			this.windowEl.addEvent('mouseleave', function(){
				this.mouseover = false;
				if (this.options.useCanvasControls){
					this.canvasControlsEl.setStyle('visibility', 'hidden');
				}
				else {
					this.controlsEl.setStyle('visibility', 'hidden');
				}
				this.canvasHeaderEl.setStyle('visibility', 'hidden');
				this.titleEl.hide();
			}.bind(this));
		}

		// Inject window into DOM
		this.windowEl.inject(options.container);

		// Convert CSS colors to Canvas colors.
		this.setColors();

		if (options.type != 'notification'){
			this.setMochaControlsWidth();
		}

		// Add content to window.
		MUI.updateContent({
			'element': this.windowEl,
			'content': options.content,
			'method': options.method,
			'url': options.contentURL,
			'data': options.data,
			'onContentLoaded': null,
			'require': {
				js: options.require.js,
				onload: options.require.onload
			}
		});

		// Add content to window toolbar.
		if (this.options.toolbar == true){
			MUI.updateContent({
				'element': this.windowEl,
				'childElement': this.toolbarEl,
				'content': options.toolbarContent,
				'loadMethod': 'xhr',
				'method': options.method,
				'url': options.toolbarURL,
				'data':	options.toolbarData,
				'onContentLoaded': options.toolbarOnload
			});
		}

		// Add content to window toolbar.
		if (this.options.toolbar2 == true){
			MUI.updateContent({
				'element': this.windowEl,
				'childElement': this.toolbar2El,
				'content': options.toolbar2Content,
				'loadMethod': 'xhr',
				'method': options.method,
				'url': options.toolbar2URL,
				'data':	options.toolbar2Data,
				'onContentLoaded': options.toolbar2Onload
			});
		}

		this.drawWindow();

		// Attach events to the window
		this.attachDraggable();
		this.attachResizable();
		this.setupEvents();

		if (options.resizable){
			this.adjustHandles();
		}

		// Position window. If position not specified by user then center the window on the page.
		if (options.container == document.body || options.container == MUI.Desktop.desktop){
			var dimensions = window.getSize();
		}
		else {
			var dimensions = $(this.options.container).getSize();
		}

        var x,y;
		if (!options.y) {
			if (MUI.Desktop && MUI.Desktop.desktop) {
				y = (dimensions.y * .5) - (this.windowEl.offsetHeight * .5);
				if (y < -options.shadowBlur) y = -options.shadowBlur;
			}
			else {
				y = window.getScroll().y + (window.getSize().y * .5) - (this.windowEl.offsetHeight * .5);
				if (y < -options.shadowBlur) y = -options.shadowBlur;
			}
		}
		else {
			y = options.y - options.shadowBlur;
		}

		if (this.options.x==null) {
			x =	(dimensions.x * .5) - (this.windowEl.offsetWidth * .5);
			if (x < -options.shadowBlur) x = -options.shadowBlur;
		}
		else {
			x = options.x - options.shadowBlur;
		}

		this.windowEl.setStyles({
			'top': y,
			'left': x
		});

		// Create opacityMorph

		this.opacityMorph = new Fx.Morph(this.windowEl, {
			'duration': 350,
			transition: Fx.Transitions.Sine.easeInOut,
			onComplete: function(){
				if (Browser.Engine.trident){
					this.drawWindow();
				}
			}.bind(this)
		});

		this.displayNewWindow();

		// This is a generic morph that can be reused later by functions like centerWindow()
		// It returns the windowEl element rather than this Class.
		this.morph = new Fx.Morph(this.windowEl, {
			'duration': 200
		});
		this.windowEl.store('morph', this.morph);

		this.resizeMorph = new Fx.Elements([this.contentWrapperEl, this.windowEl], {
			duration: 400,
			transition: Fx.Transitions.Sine.easeInOut,
			onStart: function(){
				this.resizeAnimation = this.drawWindow.periodical(20, this);
			}.bind(this),
			onComplete: function(){
				$clear(this.resizeAnimation);
				this.drawWindow();
				// Show iframe
				if ( this.iframeEl ) {
					this.iframeEl.setStyle('visibility', 'visible');
				}
			}.bind(this)
		});
		this.windowEl.store('resizeMorph', this.resizeMorph);

		// Add check mark to menu if link exists in menu
		// Need to make sure the check mark is not added to links not in menu
		if ($(this.windowEl.id + 'LinkCheck')){
			this.check = new Element('div', {
				'class': 'check',
				'id': this.options.id + '_check'
			}).inject(this.windowEl.id + 'LinkCheck');
		}

		if (this.options.closeAfter != false){
			MUI.closeWindow.delay(this.options.closeAfter, this, this.windowEl);
		}

		if (MUI.Dock && $(MUI.options.dock) && this.options.type == 'window' ){
			MUI.Dock.createDockTab(this.windowEl);
		}

	},
	displayNewWindow: function(){

		options = this.options;
		if (options.type == 'modal' || options.type == 'modal2') {
			MUI.currentModal = this.windowEl;
			if (Browser.Engine.trident4){
				$('modalFix').show();
			}
			$('modalOverlay').show();
			if (MUI.options.advancedEffects == false){
				$('modalOverlay').setStyle('opacity', .6);
				this.windowEl.setStyles({
					'zIndex': 11000,
					'opacity': 1
				});
			}
			else {
				MUI.Modal.modalOverlayCloseMorph.cancel();
				MUI.Modal.modalOverlayOpenMorph.start({
					'opacity': .6
				});
				this.windowEl.setStyles({
					'zIndex': 11000
				});
				this.opacityMorph.start({
					'opacity': 1
				});
			}

			$$('.dockTab').removeClass('activeDockTab');
			$$('.mocha').removeClass('isFocused');
			this.windowEl.addClass('isFocused');

		}
		else if (MUI.options.advancedEffects == false){
			this.windowEl.setStyle('opacity', 1);
			setTimeout(MUI.focusWindow.pass(this.windowEl, this), 10);
		}
		else {
			// IE cannot handle both element opacity and VML alpha at the same time.
			if (Browser.Engine.trident){
				this.drawWindow(false);
			}
			this.opacityMorph.start({
				'opacity': 1
			});
			setTimeout(MUI.focusWindow.pass(this.windowEl, this), 10);
		}

	},
	setupEvents: function() {
		var windowEl = this.windowEl;
		// Set events
		// Note: if a button does not exist, its due to properties passed to newWindow() stating otherwice
		if (this.closeButtonEl){
			this.closeButtonEl.addEvent('click', function(e) {
				new Event(e).stop();
				MUI.closeWindow(windowEl);
			}.bind(this));
		}

		if (this.options.type == 'window'){
			windowEl.addEvent('mousedown', function(e) {
				if (Browser.Engine.trident) {
					new Event(e).stop();
				}
				MUI.focusWindow(windowEl);
				if (windowEl.getStyle('top').toInt() < -this.options.shadowBlur) {
					windowEl.setStyle('top', -this.options.shadowBlur);
				}
			}.bind(this));
		}

		if (this.minimizeButtonEl) {
			this.minimizeButtonEl.addEvent('click', function(e) {
				new Event(e).stop();
				MUI.Dock.minimizeWindow(windowEl);
		}.bind(this));
		}

		if (this.maximizeButtonEl) {
			this.maximizeButtonEl.addEvent('click', function(e) {
				new Event(e).stop();
				if (this.isMaximized) {
					MUI.Desktop.restoreWindow(windowEl);
				} else {
					MUI.Desktop.maximizeWindow(windowEl);
				}
			}.bind(this));
		}

		if (this.options.collapsible == true){
			// Keep titlebar text from being selected on double click in Safari.
			this.titleEl.addEvent('selectstart', function(e) {
				e = new Event(e).stop();
			}.bind(this));

			if (Browser.Engine.trident) {
				this.titleBarEl.addEvent('mousedown', function(e) {
					this.titleEl.setCapture();
				}.bind(this));
				this.titleBarEl.addEvent('mouseup', function(e) {
						this.titleEl.releaseCapture();
				}.bind(this));
			}

			this.titleBarEl.addEvent('dblclick', function(e) {
				e = new Event(e).stop();
				MUI.collapseToggle(this.windowEl);
			}.bind(this));
		}

	},
	/*

	Internal Function: attachDraggable()
		Make window draggable.

	*/
	attachDraggable: function(){
		var windowEl = this.windowEl;
		if (!this.options.draggable) return;
		this.windowDrag = new Drag.Move(windowEl, {
			handle: this.titleBarEl,
			container: this.options.restrict == true ? $(this.options.container) : false,
			grid: this.options.draggableGrid,
			limit: this.options.draggableLimit,
			snap: this.options.draggableSnap,
			onStart: function() {
				if (this.options.type != 'modal' && this.options.type != 'modal2'){
					MUI.focusWindow(windowEl);
					$('windowUnderlay').show();
				}
				if (this.iframeEl) {
					if (!Browser.Engine.trident) {
						this.iframeEl.setStyle('visibility', 'hidden');
					}
					else {
						this.iframeEl.hide();
					}
				}
			}.bind(this),
			onComplete: function() {
				if (this.options.type != 'modal' && this.options.type != 'modal2') {
					$('windowUnderlay').hide();
				}
				if ( this.iframeEl ){
					if (!Browser.Engine.trident) {
						this.iframeEl.setStyle('visibility', 'visible');
					}
					else {
						this.iframeEl.show();
					}
				}
				// Store new position in options.
				this.saveValues();
			}.bind(this)
		});
	},
	/*

	Internal Function: attachResizable
		Make window resizable.

	*/
	attachResizable: function(){
		var windowEl = this.windowEl;
		if (!this.options.resizable) return;
		this.resizable1 = this.windowEl.makeResizable({
			handle: [this.n, this.ne, this.nw],
			limit: {
				y: [
					function(){
						return this.windowEl.getStyle('top').toInt() + this.windowEl.getStyle('height').toInt() - this.options.resizeLimit.y[1];
					}.bind(this),
					function(){
						return this.windowEl.getStyle('top').toInt() + this.windowEl.getStyle('height').toInt() - this.options.resizeLimit.y[0];
					}.bind(this)
				]
			},
			modifiers: {x: false, y: 'top'},
			onStart: function(){
				this.resizeOnStart();
				this.coords = this.contentWrapperEl.getCoordinates();
				this.y2 = this.coords.top.toInt() + this.contentWrapperEl.offsetHeight;
			}.bind(this),
			onDrag: function(){
				this.coords = this.contentWrapperEl.getCoordinates();
				this.contentWrapperEl.setStyle('height', this.y2 - this.coords.top.toInt());
				this.resizeOnDrag();
			}.bind(this),
			onComplete: function(){
				this.resizeOnComplete();
			}.bind(this)
		});

		this.resizable2 = this.contentWrapperEl.makeResizable({
			handle: [this.e, this.ne],
			limit: {
				x: [this.options.resizeLimit.x[0] - (this.options.shadowBlur * 2), this.options.resizeLimit.x[1] - (this.options.shadowBlur * 2) ]
			},
			modifiers: {x: 'width', y: false},
			onStart: function(){
				this.resizeOnStart();
			}.bind(this),
			onDrag: function(){
				this.resizeOnDrag();
			}.bind(this),
			onComplete: function(){
				this.resizeOnComplete();
			}.bind(this)
		});

		this.resizable3 = this.contentWrapperEl.makeResizable({
			container: this.options.restrict == true ? $(this.options.container) : false,
			handle: this.se,
			limit: {
				x: [this.options.resizeLimit.x[0] - (this.options.shadowBlur * 2), this.options.resizeLimit.x[1] - (this.options.shadowBlur * 2) ],
				y: [this.options.resizeLimit.y[0] - this.headerFooterShadow, this.options.resizeLimit.y[1] - this.headerFooterShadow]
			},
			modifiers: {x: 'width', y: 'height'},
			onStart: function(){
				this.resizeOnStart();
			}.bind(this),
			onDrag: function(){
				this.resizeOnDrag();
			}.bind(this),
			onComplete: function(){
				this.resizeOnComplete();
			}.bind(this)
		});

		this.resizable4 = this.contentWrapperEl.makeResizable({
			handle: [this.s, this.sw],
			limit: {
				y: [this.options.resizeLimit.y[0] - this.headerFooterShadow, this.options.resizeLimit.y[1] - this.headerFooterShadow]
			},
			modifiers: {x: false, y: 'height'},
			onStart: function(){
				this.resizeOnStart();
			}.bind(this),
			onDrag: function(){
				this.resizeOnDrag();
			}.bind(this),
			onComplete: function(){
				this.resizeOnComplete();
			}.bind(this)
		});

		this.resizable5 = this.windowEl.makeResizable({
			handle: [this.w, this.sw, this.nw],
			limit: {
				x: [
					function(){
						return this.windowEl.getStyle('left').toInt() + this.windowEl.getStyle('width').toInt() - this.options.resizeLimit.x[1];
					}.bind(this),
				   function(){
					   return this.windowEl.getStyle('left').toInt() + this.windowEl.getStyle('width').toInt() - this.options.resizeLimit.x[0];
					}.bind(this)
				]
			},
			modifiers: {x: 'left', y: false},
			onStart: function(){
				this.resizeOnStart();
				this.coords = this.contentWrapperEl.getCoordinates();
				this.x2 = this.coords.left.toInt() + this.contentWrapperEl.offsetWidth;
			}.bind(this),
			onDrag: function(){
				this.coords = this.contentWrapperEl.getCoordinates();
				this.contentWrapperEl.setStyle('width', this.x2 - this.coords.left.toInt());
				this.resizeOnDrag();
			}.bind(this),
			onComplete: function(){
				this.resizeOnComplete();
			}.bind(this)
		});

	},
	resizeOnStart: function(){
		$('windowUnderlay').show();
		if (this.iframeEl){
			if (!Browser.Engine.trident) {
				this.iframeEl.setStyle('visibility', 'hidden');
			}
			else {
				this.iframeEl.hide();
			}
		}
	},
	resizeOnDrag: function(){
		// Fix for a rendering glitch in FF when resizing a window with panels in it
		if (Browser.Engine.gecko) {
			this.windowEl.getElements('.panel').each(function(panel){
				panel.store('oldOverflow', panel.getStyle('overflow'));
				panel.setStyle('overflow', 'visible');
			});
		}
		this.drawWindow();
		this.adjustHandles();
		if (Browser.Engine.gecko) {
			this.windowEl.getElements('.panel').each(function(panel){
				panel.setStyle('overflow', panel.retrieve('oldOverflow')); // Fix for a rendering bug in FF
			});
		}
	},
	resizeOnComplete: function(){
		$('windowUnderlay').hide();
		if (this.iframeEl){
			if (!Browser.Engine.trident) {
				this.iframeEl.setStyle('visibility', 'visible');
			}
			else {
				this.iframeEl.show();
				// The following hack is to get IE8 RC1 IE8 Standards Mode to properly resize an iframe
				// when only the vertical dimension is changed.
				this.iframeEl.setStyle('width', '99%');
				this.iframeEl.setStyle('height', this.contentWrapperEl.offsetHeight);
				this.iframeEl.setStyle('width', '100%');
				this.iframeEl.setStyle('height', this.contentWrapperEl.offsetHeight);
			}
		}

		// Resize panels if there are any
		if (this.contentWrapperEl.getChildren('.column') != null) {
			MUI.rWidth(this.contentWrapperEl);
			this.contentWrapperEl.getChildren('.column').each(function(column){
				MUI.panelHeight(column);
			});
		}

		this.fireEvent('onResize', this.windowEl);
	},
	adjustHandles: function(){

		var shadowBlur = this.options.shadowBlur;
		var shadowBlur2x = shadowBlur * 2;
		var shadowOffset = this.options.shadowOffset;
		var top = shadowBlur - shadowOffset.y - 1;
		var right = shadowBlur + shadowOffset.x - 1;
		var bottom = shadowBlur + shadowOffset.y - 1;
		var left = shadowBlur - shadowOffset.x - 1;

		var coordinates = this.windowEl.getCoordinates();
		var width = coordinates.width - shadowBlur2x + 2;
		var height = coordinates.height - shadowBlur2x + 2;

		this.n.setStyles({
			'top': top,
			'left': left + 10,
			'width': width - 20
		});
		this.e.setStyles({
			'top': top + 10,
			'right': right,
			'height': height - 30
		});
		this.s.setStyles({
			'bottom': bottom,
			'left': left + 10,
			'width': width - 30
		});
		this.w.setStyles({
			'top': top + 10,
			'left': left,
			'height': height - 20
		});
		this.ne.setStyles({
			'top': top,
			'right': right
		});
		this.se.setStyles({
			'bottom': bottom,
			'right': right
		});
		this.sw.setStyles({
			'bottom': bottom,
			'left': left
		});
		this.nw.setStyles({
			'top': top,
			'left': left
		});
	},
	detachResizable: function(){
			this.resizable1.detach();
			this.resizable2.detach();
			this.resizable3.detach();
			this.resizable4.detach();
			this.resizable5.detach();
			this.windowEl.getElements('.handle').hide();
	},
	reattachResizable: function(){
			this.resizable1.attach();
			this.resizable2.attach();
			this.resizable3.attach();
			this.resizable4.attach();
			this.resizable5.attach();
			this.windowEl.getElements('.handle').show();
	},
	/*

	Internal Function: insertWindowElements

	Arguments:
		windowEl

	*/
	insertWindowElements: function(){

		var options = this.options;
		var height = options.height;
		var width = options.width;
		var id = options.id;

		var cache = {};

		if (Browser.Engine.trident4){
			cache.zIndexFixEl = new Element('iframe', {
				'id': id + '_zIndexFix',
				'class': 'zIndexFix',
				'scrolling': 'no',
				'marginWidth': 0,
				'marginHeight': 0,
				'src': '',
				'styles': {
					'position': 'absolute' // This is set here to make theme transitions smoother
				}
			}).inject(this.windowEl);
		}

		cache.overlayEl = new Element('div', {
			'id': id + '_overlay',
			'class': 'mochaOverlay',
			'styles': {
				'position': 'absolute', // This is set here to make theme transitions smoother
				'top': 0,
				'left': 0
			}
		}).inject(this.windowEl);

		cache.titleBarEl = new Element('div', {
			'id': id + '_titleBar',
			'class': 'mochaTitlebar',
			'styles': {
				'cursor': options.draggable ? 'move' : 'default'
			}
		}).inject(cache.overlayEl, 'top');

		cache.titleEl = new Element('h3', {
			'id': id + '_title',
			'class': 'mochaTitle'
		}).inject(cache.titleBarEl);

		if (options.icon != false){
			cache.titleEl.setStyles({
				'padding-left': 28,
				'background': 'url(' + options.icon + ') 5px 4px no-repeat'
			});
		}

		cache.contentBorderEl = new Element('div', {
			'id': id + '_contentBorder',
			'class': 'mochaContentBorder'
		}).inject(cache.overlayEl);

		if (options.toolbar){
			cache.toolbarWrapperEl = new Element('div', {
				'id': id + '_toolbarWrapper',
				'class': 'mochaToolbarWrapper',
				'styles': { 'height': options.toolbarHeight }
			}).inject(cache.contentBorderEl, options.toolbarPosition == 'bottom' ? 'after' : 'before');

			if (options.toolbarPosition == 'bottom') {
				cache.toolbarWrapperEl.addClass('bottom');
			}
			cache.toolbarEl = new Element('div', {
				'id': id + '_toolbar',
				'class': 'mochaToolbar',
				'styles': { 'height': options.toolbarHeight }
			}).inject(cache.toolbarWrapperEl);
		}

		if (options.toolbar2){
			cache.toolbar2WrapperEl = new Element('div', {
				'id': id + '_toolbar2Wrapper',
				'class': 'mochaToolbarWrapper',
				'styles': { 'height': options.toolbar2Height }
			}).inject(cache.contentBorderEl, options.toolbar2Position == 'bottom' ? 'after' : 'before');

			if (options.toolbar2Position == 'bottom') {
				cache.toolbar2WrapperEl.addClass('bottom');
			}
			cache.toolbar2El = new Element('div', {
				'id': id + '_toolbar2',
				'class': 'mochaToolbar',
				'styles': { 'height': options.toolbar2Height }
			}).inject(cache.toolbar2WrapperEl);
		}

		var elmentOptions = { 'id': id + '_contentWrapper', 'class': 'mochaContentWrapper', 'styles': { 'width': width + 'px', 'height': height + 'px' }};
		cache.contentWrapperEl = new Element( 'div', elmentOptions );
		cache.contentWrapperEl.inject( cache.contentBorderEl );

		if (this.options.shape == 'gauge'){
			cache.contentBorderEl.setStyle('borderWidth', 0);
		}

		cache.contentEl = new Element('div', {
			'id': id + '_content',
			'class': 'mochaContent'
		}).inject(cache.contentWrapperEl);

		if (this.options.useCanvas == true && Browser.Engine.trident != true) {
			cache.canvasEl = new Element('canvas', {
				'id': id + '_canvas',
				'class': 'mochaCanvas',
				'width': 10,
				'height': 10
			}).inject(this.windowEl);
		}

		if (this.options.useCanvas == true && Browser.Engine.trident) {
			cache.canvasEl = new Element('canvas', {
				'id': id + '_canvas',
				'class': 'mochaCanvas',
				'width': 50000, // IE8 excanvas requires these large numbers
				'height': 20000,
				'styles': {
					'position': 'absolute',
					'top': 0,
					'left': 0
				}
			}).inject(this.windowEl);

			if (MUI.ieSupport == 'excanvas'){
				G_vmlCanvasManager.initElement(cache.canvasEl);
				cache.canvasEl = this.windowEl.getElement('.mochaCanvas');
			}
		}

		cache.controlsEl = new Element('div', {
			'id': id + '_controls',
			'class': 'mochaControls'
		}).inject(cache.overlayEl, 'after');

		if (options.useCanvasControls == true){
			cache.canvasControlsEl = new Element('canvas', {
				'id': id + '_canvasControls',
				'class': 'mochaCanvasControls',
				'width': 14,
				'height': 14
			}).inject(this.windowEl);

			if (Browser.Engine.trident && MUI.ieSupport == 'excanvas'){
				G_vmlCanvasManager.initElement(cache.canvasControlsEl);
				cache.canvasControlsEl = this.windowEl.getElement('.mochaCanvasControls');
			}
		}

		if (options.closable){
			cache.closeButtonEl = new Element('div', {
				'id': id + '_closeButton',
				'class': 'mochaCloseButton mochaWindowButton',
				'title': 'Close'
			}).inject(cache.controlsEl);
		}

		if (options.maximizable){
			cache.maximizeButtonEl = new Element('div', {
				'id': id + '_maximizeButton',
				'class': 'mochaMaximizeButton mochaWindowButton',
				'title': 'Maximize'
			}).inject(cache.controlsEl);
		}

		if (options.minimizable){
			cache.minimizeButtonEl = new Element('div', {
				'id': id + '_minimizeButton',
				'class': 'mochaMinimizeButton mochaWindowButton',
				'title': 'Minimize'
			}).inject(cache.controlsEl);
		}

		if (options.useSpinner == true && options.shape != 'gauge' && options.type != 'notification'){
			cache.spinnerEl = new Element('div', {
				'id': id + '_spinner',
				'class': 'mochaSpinner',
				'width': 16,
				'height': 16
			}).inject(this.windowEl, 'bottom');
		}

		if (this.options.shape == 'gauge'){
			cache.canvasHeaderEl = new Element('canvas', {
				'id': id + '_canvasHeader',
				'class': 'mochaCanvasHeader',
				'width': this.options.width,
				'height': 26
			}).inject(this.windowEl, 'bottom');

			if (Browser.Engine.trident && MUI.ieSupport == 'excanvas'){
				G_vmlCanvasManager.initElement(cache.canvasHeaderEl);
				cache.canvasHeaderEl = this.windowEl.getElement('.mochaCanvasHeader');
			}
		}

		if ( Browser.Engine.trident ){
			cache.overlayEl.setStyle('zIndex', 2);
		}

		// For Mac Firefox 2 to help reduce scrollbar bugs in that browser
		if (Browser.Platform.mac && Browser.Engine.gecko){
			if (/Firefox[\/\s](\d+\.\d+)/.test(navigator.userAgent)){
				var ffversion = new Number(RegExp.$1);
				if (ffversion < 3){
					cache.overlayEl.setStyle('overflow', 'auto');
				}
			}
		}

		if (options.resizable){
			cache.n = new Element('div', {
				'id': id + '_resizeHandle_n',
				'class': 'handle',
				'styles': {
					'top': 0,
					'left': 10,
					'cursor': 'n-resize'
				}
			}).inject(cache.overlayEl, 'after');

			cache.ne = new Element('div', {
				'id': id + '_resizeHandle_ne',
				'class': 'handle corner',
				'styles': {
					'top': 0,
					'right': 0,
					'cursor': 'ne-resize'
				}
			}).inject(cache.overlayEl, 'after');

			cache.e = new Element('div', {
				'id': id + '_resizeHandle_e',
				'class': 'handle',
				'styles': {
					'top': 10,
					'right': 0,
					'cursor': 'e-resize'
				}
			}).inject(cache.overlayEl, 'after');

			cache.se = new Element('div', {
				'id': id + '_resizeHandle_se',
				'class': 'handle cornerSE',
				'styles': {
					'bottom': 0,
					'right': 0,
					'cursor': 'se-resize'
				}
			}).inject(cache.overlayEl, 'after');

			cache.s = new Element('div', {
				'id': id + '_resizeHandle_s',
				'class': 'handle',
				'styles': {
					'bottom': 0,
					'left': 10,
					'cursor': 's-resize'
				}
			}).inject(cache.overlayEl, 'after');

			cache.sw = new Element('div', {
				'id': id + '_resizeHandle_sw',
				'class': 'handle corner',
				'styles': {
					'bottom': 0,
					'left': 0,
					'cursor': 'sw-resize'
				}
			}).inject(cache.overlayEl, 'after');

			cache.w = new Element('div', {
				'id': id + '_resizeHandle_w',
				'class': 'handle',
				'styles': {
					'top': 10,
					'left': 0,
					'cursor': 'w-resize'
				}
			}).inject(cache.overlayEl, 'after');

			cache.nw = new Element('div', {
				'id': id + '_resizeHandle_nw',
				'class': 'handle corner',
				'styles': {
					'top': 0,
					'left': 0,
					'cursor': 'nw-resize'
				}
			}).inject(cache.overlayEl, 'after');
		}
		$extend(this, cache);

	},
	/*

	Convert CSS colors to Canvas colors.

	*/
	setColors: function(){

		if (this.options.useCanvas == true) {

			// Set TitlebarColor
			var pattern = /\?(.*?)\)/;
			if(( this.titleBarEl.getStyle('backgroundImage') != 'none' ) && this.titleBarEl.getStyle('backgroundImage').match(pattern) ){
				var gradient = this.titleBarEl.getStyle('backgroundImage');
				gradient = gradient.match(pattern)[1];
				gradient = gradient.parseQueryString();
				var gradientFrom = gradient.from;
				var gradientTo = gradient.to.replace(/\"/, ''); // IE7 was adding a quotation mark in. No idea why.

				this.options.headerStartColor = new Color(gradientFrom);
				this.options.headerStopColor = new Color(gradientTo);
				this.titleBarEl.addClass('replaced');
			}
			else if (this.titleBarEl.getStyle('background-color') !== '' && this.titleBarEl.getStyle('background-color') !== 'transparent') {
				this.options.headerStartColor = new Color(this.titleBarEl.getStyle('background-color')).mix('#fff', 20);
				this.options.headerStopColor = new Color(this.titleBarEl.getStyle('background-color')).mix('#000', 20);
				this.titleBarEl.addClass('replaced');
			}

			// Set BodyBGColor
			if (this.windowEl.getStyle('background-color') !== '' && this.windowEl.getStyle('background-color') !== 'transparent') {
				this.options.bodyBgColor = new Color(this.windowEl.getStyle('background-color'));
				this.windowEl.addClass('replaced');
			}

			// Set resizableColor, the color of the SE corner resize handle
			if (this.options.resizable && this.se.getStyle('background-color') !== '' && this.se.getStyle('background-color') !== 'transparent') {
				this.options.resizableColor = new Color(this.se.getStyle('background-color'));
				this.se.addClass('replaced');
			}

		}

		if (this.options.useCanvasControls == true){

			if (this.minimizeButtonEl){

				// Set Minimize Button Foreground Color
				if (this.minimizeButtonEl.getStyle('color') !== '' && this.minimizeButtonEl.getStyle('color') !== 'transparent') {
					this.options.minimizeColor = new Color(this.minimizeButtonEl.getStyle('color'));
				}

				// Set Minimize Button Background Color
				if (this.minimizeButtonEl.getStyle('background-color') !== '' && this.minimizeButtonEl.getStyle('background-color') !== 'transparent') {
					this.options.minimizeBgColor = new Color(this.minimizeButtonEl.getStyle('background-color'));
					this.minimizeButtonEl.addClass('replaced');
				}

			}

			if (this.maximizeButtonEl){

				// Set Maximize Button Foreground Color
				if (this.maximizeButtonEl.getStyle('color') !== '' && this.maximizeButtonEl.getStyle('color') !== 'transparent') {
					this.options.maximizeColor = new Color(this.maximizeButtonEl.getStyle('color'));
				}

				// Set Maximize Button Background Color
				if (this.maximizeButtonEl.getStyle('background-color') !== '' && this.maximizeButtonEl.getStyle('background-color') !== 'transparent') {
					this.options.maximizeBgColor = new Color(this.maximizeButtonEl.getStyle('background-color'));
					this.maximizeButtonEl.addClass('replaced');
				}

			}

			if (this.closeButtonEl){

				// Set Close Button Foreground Color
				if (this.closeButtonEl.getStyle('color') !== '' && this.closeButtonEl.getStyle('color') !== 'transparent') {
					this.options.closeColor = new Color(this.closeButtonEl.getStyle('color'));
				}

				// Set Close Button Background Color
				if (this.closeButtonEl.getStyle('background-color') !== '' && this.closeButtonEl.getStyle('background-color') !== 'transparent') {
					this.options.closeBgColor = new Color(this.closeButtonEl.getStyle('background-color'));
					this.closeButtonEl.addClass('replaced');
				}

			}
		}
	},
	/*

	Internal function: drawWindow
		This is where we create the canvas GUI

	Arguments:
		windowEl: the $(window)
		shadows: (boolean) false will draw a window without shadows

	*/
	drawWindow: function(shadows) {

		if (this.drawingWindow == true) return;
		this.drawingWindow = true;

		if (this.isCollapsed){
			this.drawWindowCollapsed(shadows);
			return;
		}

		var windowEl = this.windowEl;

		var options = this.options;
		var shadowBlur = options.shadowBlur;
		var shadowBlur2x = shadowBlur * 2;
		var shadowOffset = this.options.shadowOffset;

		this.overlayEl.setStyles({
			'width': this.contentWrapperEl.offsetWidth
		});

		// Resize iframe when window is resized
		if (this.iframeEl) {
			this.iframeEl.setStyle('height', this.contentWrapperEl.offsetHeight);
		}

		var borderHeight = this.contentBorderEl.getStyle('border-top').toInt() + this.contentBorderEl.getStyle('border-bottom').toInt();
		var toolbarHeight = this.toolbarWrapperEl ? this.toolbarWrapperEl.getStyle('height').toInt() + this.toolbarWrapperEl.getStyle('border-top').toInt() : 0;
		var toolbar2Height = this.toolbar2WrapperEl ? this.toolbar2WrapperEl.getStyle('height').toInt() + this.toolbar2WrapperEl.getStyle('border-top').toInt() : 0;

		this.headerFooterShadow = options.headerHeight + options.footerHeight + shadowBlur2x;
		var height = this.contentWrapperEl.getStyle('height').toInt() + this.headerFooterShadow + toolbarHeight + toolbar2Height + borderHeight;
		var width = this.contentWrapperEl.getStyle('width').toInt() + shadowBlur2x;
		this.windowEl.setStyles({
			'height': height,
			'width': width
		});

		this.overlayEl.setStyles({
			'height': height,
			'top': shadowBlur - shadowOffset.y,
			'left': shadowBlur - shadowOffset.x
		});

		if (this.options.useCanvas == true) {
			if (Browser.Engine.trident) {
				this.canvasEl.height = 20000;
				this.canvasEl.width = 50000;
			}
			this.canvasEl.height = height;
			this.canvasEl.width = width;
		}

		// Part of the fix for IE6 select z-index bug
		if (Browser.Engine.trident4){
			this.zIndexFixEl.setStyles({
				'width': width,
				'height': height
			})
		}

		this.titleBarEl.setStyles({
			'width': width - shadowBlur2x,
			'height': options.headerHeight
		});

		// Make sure loading icon is placed correctly.
		if (options.useSpinner == true && options.shape != 'gauge' && options.type != 'notification'){
			this.spinnerEl.setStyles({
				'left': shadowBlur - shadowOffset.x + 3,
				'bottom': shadowBlur + shadowOffset.y +  4
			});
		}

		if (this.options.useCanvas != false) {

			// Draw Window
			var ctx = this.canvasEl.getContext('2d');
			ctx.clearRect(0, 0, width, height);

			switch (options.shape) {
				case 'box':
					this.drawBox(ctx, width, height, shadowBlur, shadowOffset, shadows);
					break;
				case 'gauge':
					this.drawGauge(ctx, width, height, shadowBlur, shadowOffset, shadows);
					break;
			}

			if (options.resizable){
				MUI.triangle(
					ctx,
					width - (shadowBlur + shadowOffset.x + 17),
					height - (shadowBlur + shadowOffset.y + 18),
					11,
					11,
					options.resizableColor,
					1.0
				);
			}

			// Invisible dummy object. The last element drawn is not rendered consistently while resizing in IE6 and IE7
			if (Browser.Engine.trident){
				MUI.triangle(ctx, 0, 0, 10, 10, options.resizableColor, 0);
			}
		}

		if (options.type != 'notification' && options.useCanvasControls == true){
			this.drawControls(width, height, shadows);
		}

		// Resize panels if there are any
		if (MUI.Desktop && this.contentWrapperEl.getChildren('.column').length != 0) {
			MUI.rWidth(this.contentWrapperEl);
			this.contentWrapperEl.getChildren('.column').each(function(column){
				MUI.panelHeight(column);
			});
		}

		this.drawingWindow = false;
		return this;

	},
	drawWindowCollapsed: function(shadows) {

		var windowEl = this.windowEl;

		var options = this.options;
		var shadowBlur = options.shadowBlur;
		var shadowBlur2x = shadowBlur * 2;
		var shadowOffset = options.shadowOffset;

		var headerShadow = options.headerHeight + shadowBlur2x + 2;
		var height = headerShadow;
		var width = this.contentWrapperEl.getStyle('width').toInt() + shadowBlur2x;
		this.windowEl.setStyle('height', height);

		this.overlayEl.setStyles({
			'height': height,
			'top': shadowBlur - shadowOffset.y,
			'left': shadowBlur - shadowOffset.x
		});

		// Part of the fix for IE6 select z-index bug
		if (Browser.Engine.trident4){
			this.zIndexFixEl.setStyles({
				'width': width,
				'height': height
			});
		}

		// Set width
		this.windowEl.setStyle('width', width);
		this.overlayEl.setStyle('width', width);
		this.titleBarEl.setStyles({
			'width': width - shadowBlur2x,
			'height': options.headerHeight
		});

		// Draw Window
		if (this.options.useCanvas != false) {
			this.canvasEl.height = height;
			this.canvasEl.width = width;

			var ctx = this.canvasEl.getContext('2d');
			ctx.clearRect(0, 0, width, height);

			this.drawBoxCollapsed(ctx, width, height, shadowBlur, shadowOffset, shadows);
			if (options.useCanvasControls == true) {
				this.drawControls(width, height, shadows);
			}

			// Invisible dummy object. The last element drawn is not rendered consistently while resizing in IE6 and IE7
			if (Browser.Engine.trident){
				MUI.triangle(ctx, 0, 0, 10, 10, options.resizableColor, 0);
			}
		}

		this.drawingWindow = false;
		return this;

	},
	drawControls : function(width, height, shadows){
		var options = this.options;
		var shadowBlur = options.shadowBlur;
		var shadowOffset = options.shadowOffset;
		var controlsOffset = options.controlsOffset;

		// Make sure controls are placed correctly.
		this.controlsEl.setStyles({
			'right': shadowBlur + shadowOffset.x + controlsOffset.right,
			'top': shadowBlur - shadowOffset.y + controlsOffset.top
		});

		this.canvasControlsEl.setStyles({
			'right': shadowBlur + shadowOffset.x + controlsOffset.right,
			'top': shadowBlur - shadowOffset.y + controlsOffset.top
		});

		// Calculate X position for controlbuttons
		//var mochaControlsWidth = 52;
		this.closebuttonX = options.closable ? this.mochaControlsWidth - 7 : this.mochaControlsWidth + 12;
		this.maximizebuttonX = this.closebuttonX - (options.maximizable ? 19 : 0);
		this.minimizebuttonX = this.maximizebuttonX - (options.minimizable ? 19 : 0);

		var ctx2 = this.canvasControlsEl.getContext('2d');
		ctx2.clearRect(0, 0, 100, 100);

		if (this.options.closable){
			this.closebutton(
				ctx2,
				this.closebuttonX,
				7,
				options.closeBgColor,
				1.0,
				options.closeColor,
				1.0
			);
		}
		if (this.options.maximizable){
			this.maximizebutton(
				ctx2,
				this.maximizebuttonX,
				7,
				options.maximizeBgColor,
				1.0,
				options.maximizeColor,
				1.0
			);
		}
		if (this.options.minimizable){
			this.minimizebutton(
				ctx2,
				this.minimizebuttonX,
				7,
				options.minimizeBgColor,
				1.0,
				options.minimizeColor,
				1.0
			);
		}
					// Invisible dummy object. The last element drawn is not rendered consistently while resizing in IE6 and IE7
			if (Browser.Engine.trident){
				MUI.circle(ctx2, 0, 0, 3, this.options.resizableColor, 0);
			}

	},
	drawBox: function(ctx, width, height, shadowBlur, shadowOffset, shadows){

		var options = this.options;
		var shadowBlur2x = shadowBlur * 2;
		var cornerRadius = this.options.cornerRadius;

		// This is the drop shadow. It is created onion style.
		if ( shadows != false ) {
			for (var x = 0; x <= shadowBlur; x++){
				MUI.roundedRect(
					ctx,
					shadowOffset.x + x,
					shadowOffset.y + x,
					width - (x * 2) - shadowOffset.x,
					height - (x * 2) - shadowOffset.y,
					cornerRadius + (shadowBlur - x),
					[0, 0, 0],
					x == shadowBlur ? .29 : .065 + (x * .01)
				);
			}
		}
		// Window body.
		this.bodyRoundedRect(
			ctx,                          // context
			shadowBlur - shadowOffset.x,  // x
			shadowBlur - shadowOffset.y,  // y
			width - shadowBlur2x,         // width
			height - shadowBlur2x,        // height
			cornerRadius,                 // corner radius
			options.bodyBgColor      // Footer color
		);

		if (this.options.type != 'notification'){
		// Window header.
			this.topRoundedRect(
				ctx,                          // context
				shadowBlur - shadowOffset.x,  // x
				shadowBlur - shadowOffset.y,  // y
				width - shadowBlur2x,         // width
				options.headerHeight,         // height
				cornerRadius,                 // corner radius
				options.headerStartColor,     // Header gradient's top color
				options.headerStopColor       // Header gradient's bottom color
			);
		}
	},
	drawBoxCollapsed: function(ctx, width, height, shadowBlur, shadowOffset, shadows){

		var options = this.options;
		var shadowBlur2x = shadowBlur * 2;
		var cornerRadius = options.cornerRadius;

		// This is the drop shadow. It is created onion style.
		if ( shadows != false ){
			for (var x = 0; x <= shadowBlur; x++){
				MUI.roundedRect(
					ctx,
					shadowOffset.x + x,
					shadowOffset.y + x,
					width - (x * 2) - shadowOffset.x,
					height - (x * 2) - shadowOffset.y,
					cornerRadius + (shadowBlur - x),
					[0, 0, 0],
					x == shadowBlur ? .3 : .06 + (x * .01)
				);
			}
		}

		// Window header
		this.topRoundedRect2(
			ctx,                          // context
			shadowBlur - shadowOffset.x,  // x
			shadowBlur - shadowOffset.y,  // y
			width - shadowBlur2x,         // width
			options.headerHeight + 2,     // height
			cornerRadius,                 // corner radius
			options.headerStartColor,     // Header gradient's top color
			options.headerStopColor       // Header gradient's bottom color
		);

	},
	drawGauge: function(ctx, width, height, shadowBlur, shadowOffset, shadows){
		var options = this.options;
		var radius = (width * .5) - (shadowBlur) + 16;
		if (shadows != false) {
			for (var x = 0; x <= shadowBlur; x++){
				MUI.circle(
					ctx,
					width * .5 + shadowOffset.x,
					(height  + options.headerHeight) * .5 + shadowOffset.x,
					(width *.5) - (x * 2) - shadowOffset.x,
					[0, 0, 0],
					x == shadowBlur ? .75 : .075 + (x * .04)
				);
			}
		}
		MUI.circle(
			ctx,
			width * .5  - shadowOffset.x,
			(height + options.headerHeight) * .5  - shadowOffset.y,
			(width *.5) - shadowBlur,
			options.bodyBgColor,
			1
		);

		// Draw gauge header
		this.canvasHeaderEl.setStyles({
			'top': shadowBlur - shadowOffset.y,
			'left': shadowBlur - shadowOffset.x
		});
		var ctx = this.canvasHeaderEl.getContext('2d');
		ctx.clearRect(0, 0, width, 100);
		ctx.beginPath();
		ctx.lineWidth = 24;
		ctx.lineCap = 'round';
		ctx.moveTo(13, 13);
		ctx.lineTo(width - (shadowBlur*2) - 13, 13);
		ctx.strokeStyle = 'rgba(0, 0, 0, .65)';
		ctx.stroke();
	},
	bodyRoundedRect: function(ctx, x, y, width, height, radius, rgb){
		ctx.fillStyle = 'rgba(' + rgb.join(',') + ', 1)';
		ctx.beginPath();
		ctx.moveTo(x, y + radius);
		ctx.lineTo(x, y + height - radius);
		ctx.quadraticCurveTo(x, y + height, x + radius, y + height);
		ctx.lineTo(x + width - radius, y + height);
		ctx.quadraticCurveTo(x + width, y + height, x + width, y + height - radius);
		ctx.lineTo(x + width, y + radius);
		ctx.quadraticCurveTo(x + width, y, x + width - radius, y);
		ctx.lineTo(x + radius, y);
		ctx.quadraticCurveTo(x, y, x, y + radius);
		ctx.fill();

	},
	topRoundedRect: function(ctx, x, y, width, height, radius, headerStartColor, headerStopColor){
		var lingrad = ctx.createLinearGradient(0, 0, 0, height);
		lingrad.addColorStop(0, 'rgb(' + headerStartColor.join(',') + ')');
		lingrad.addColorStop(1, 'rgb(' + headerStopColor.join(',') + ')');
		ctx.fillStyle = lingrad;
		ctx.beginPath();
		ctx.moveTo(x, y);
		ctx.lineTo(x, y + height);
		ctx.lineTo(x + width, y + height);
		ctx.lineTo(x + width, y + radius);
		ctx.quadraticCurveTo(x + width, y, x + width - radius, y);
		ctx.lineTo(x + radius, y);
		ctx.quadraticCurveTo(x, y, x, y + radius);
		ctx.fill();

	},
	topRoundedRect2: function(ctx, x, y, width, height, radius, headerStartColor, headerStopColor){
		// Chrome is having trouble rendering the LinearGradient in this particular case
		if (navigator.userAgent.toLowerCase().indexOf('chrome') > -1) {
			ctx.fillStyle = 'rgba(' + headerStopColor.join(',') + ', 1)';
		}
		else {
			var lingrad = ctx.createLinearGradient(0, this.options.shadowBlur - 1, 0, height + this.options.shadowBlur + 3);
			lingrad.addColorStop(0, 'rgb(' + headerStartColor.join(',') + ')');
			lingrad.addColorStop(1, 'rgb(' + headerStopColor.join(',') + ')');
			ctx.fillStyle = lingrad;
		}
		ctx.beginPath();
		ctx.moveTo(x, y + radius);
		ctx.lineTo(x, y + height - radius);
		ctx.quadraticCurveTo(x, y + height, x + radius, y + height);
		ctx.lineTo(x + width - radius, y + height);
		ctx.quadraticCurveTo(x + width, y + height, x + width, y + height - radius);
		ctx.lineTo(x + width, y + radius);
		ctx.quadraticCurveTo(x + width, y, x + width - radius, y);
		ctx.lineTo(x + radius, y);
		ctx.quadraticCurveTo(x, y, x, y + radius);
		ctx.fill();
	},
	maximizebutton: function(ctx, x, y, rgbBg, aBg, rgb, a){
		// Circle
		ctx.beginPath();
		ctx.arc(x, y, 7, 0, Math.PI*2, true);
		ctx.fillStyle = 'rgba(' + rgbBg.join(',') + ',' + aBg + ')';
		ctx.fill();
		// X sign
		ctx.strokeStyle = 'rgba(' + rgb.join(',') + ',' + a + ')';
		ctx.lineWidth = 2;
		ctx.beginPath();
		ctx.moveTo(x, y - 3.5);
		ctx.lineTo(x, y + 3.5);
		ctx.moveTo(x - 3.5, y);
		ctx.lineTo(x + 3.5, y);
		ctx.stroke();
	},
	closebutton: function(ctx, x, y, rgbBg, aBg, rgb, a){
		// Circle
		ctx.beginPath();
		ctx.arc(x, y, 7, 0, Math.PI*2, true);
		ctx.fillStyle = 'rgba(' + rgbBg.join(',') + ',' + aBg + ')';
		ctx.fill();
		// Plus sign
		ctx.strokeStyle = 'rgba(' + rgb.join(',') + ',' + a + ')';
		ctx.lineWidth = 2;
		ctx.beginPath();
		ctx.moveTo(x - 3, y - 3);
		ctx.lineTo(x + 3, y + 3);
		ctx.moveTo(x + 3, y - 3);
		ctx.lineTo(x - 3, y + 3);
		ctx.stroke();
	},
	minimizebutton: function(ctx, x, y, rgbBg, aBg, rgb, a){
		// Circle
		ctx.beginPath();
		ctx.arc(x,y,7,0,Math.PI*2,true);
		ctx.fillStyle = 'rgba(' + rgbBg.join(',') + ',' + aBg + ')';
		ctx.fill();
		// Minus sign
		ctx.strokeStyle = 'rgba(' + rgb.join(',') + ',' + a + ')';
		ctx.lineWidth = 2;
		ctx.beginPath();
		ctx.moveTo(x - 3.5, y);
		ctx.lineTo(x + 3.5, y);
		ctx.stroke();
	},
	setMochaControlsWidth: function(){
		this.mochaControlsWidth = 0;
		var options = this.options;
		if (options.minimizable){
			this.mochaControlsWidth += (this.minimizeButtonEl.getStyle('margin-left').toInt() + this.minimizeButtonEl.getStyle('width').toInt());
		}
		if (options.maximizable){
			this.mochaControlsWidth += (this.maximizeButtonEl.getStyle('margin-left').toInt() + this.maximizeButtonEl.getStyle('width').toInt());
		}
		if (options.closable){
			this.mochaControlsWidth += (this.closeButtonEl.getStyle('margin-left').toInt() + this.closeButtonEl.getStyle('width').toInt());
		}
		this.controlsEl.setStyle('width', this.mochaControlsWidth);
		if (options.useCanvasControls == true){
			this.canvasControlsEl.setProperty('width', this.mochaControlsWidth);
		}
	},
	/*

	Function: hideSpinner
		Hides the spinner.

	Example:
		(start code)
		$('myWindow').retrieve('instance').hideSpinner();
		(end)

	*/
	hideSpinner: function() {
		if (this.spinnerEl)	this.spinnerEl.hide();
		return this;
	},
	/*

	Function: showSpinner
		Shows the spinner.

	Example:
		(start code)
		$('myWindow').retrieve('instance').showSpinner();
		(end)

	*/
	showSpinner: function(){
		if (this.spinnerEl) this.spinnerEl.show();
		return this;
	},
	/*

	Function: close
		Closes the window. This is an alternative to using MUI.Core.closeWindow().

	Example:
		(start code)
		$('myWindow').retrieve('instance').close();
		(end)

	 */
	close: function( ) {
		if (!this.isClosing) MUI.closeWindow(this.windowEl);
		return this;
	},
	/*

	Function: minimize
		Minimizes the window.

	Example:
		(start code)
		$('myWindow').retrieve('instance').minimize();
		(end)

	 */
	minimize: function( ){
		MUI.Dock.minimizeWindow(this.windowEl);
		return this;
	},
	/*

	Function: maximize
		Maximizes the window.

	Example:
		(start code)
		$('myWindow').retrieve('instance').maximize();
		(end)

	 */
	maximize: function( ) {
		if (this.isMinimized){
			MUI.Dock.restoreMinimized(this.windowEl);
		}
		MUI.Desktop.maximizeWindow(this.windowEl);
		return this;
	},
	/*

	Function: restore
		Restores a minimized/maximized window to its original size.

	Example:
		(start code)
		$('myWindow').retrieve('instance').restore();
		(end)

	 */
	restore: function() {
		if ( this.isMinimized )
			MUI.Dock.restoreMinimized(this.windowEl);
		else if ( this.isMaximized )
			MUI.Desktop.restoreWindow(this.windowEl);
		return this;
	},
	/*

	Function: resize
		Resize a window.

	Notes:
		If Advanced Effects are on the resize is animated. If centered is set to true the window remains centered as it resizes.

	Example:
		(start code)
		$('myWindow').retrieve('instance').resize({width:500,height:300,centered:true});
		(end)

	 */
	resize: function(options){
		MUI.resizeWindow(this.windowEl, options);
		return this;
	},
	/*

	Function: center
		Center a window.

	Example:
		(start code)
		$('myWindow').retrieve('instance').center();
		(end)

	 */
	center: function() {
		MUI.centerWindow(this.windowEl);
		return this;
	},

	hide: function(){
		this.windowEl.setStyle('display', 'none');
		return this;
	},

	show: function(){
		this.windowEl.setStyle('display', 'block');
		return this;
	},
	
	destroy: function(){
	   MUI.closeWindow( this.windowEl );
	}

});

MUI.extend({
	/*

	Function: closeWindow
		Closes a window.

	Syntax:
	(start code)
		MUI.closeWindow();
	(end)

	Arguments:
		windowEl - the ID of the window to be closed

	Returns:
		true - the window was closed
		false - the window was not closed

	*/
	closeWindow: function(windowEl){

		var instance = windowEl.retrieve('instance');

		// Does window exist and is not already in process of closing ?
		if (windowEl != $(windowEl) || instance.isClosing) return;

		instance.isClosing = true;
		instance.fireEvent('onClose', windowEl);

		if (instance.options.storeOnClose){
			this.storeOnClose(instance, windowEl);
			return;
		}
		if (instance.check) instance.check.destroy();

		if ((instance.options.type == 'modal' || instance.options.type == 'modal2') && Browser.Engine.trident4){
			$('modalFix').hide();
		}

		if (MUI.options.advancedEffects == false){
			if (instance.options.type == 'modal' || instance.options.type == 'modal2'){
				$('modalOverlay').setStyle('opacity', 0);
			}
			MUI.closingJobs(windowEl);
			return true;
		}
		else {
			// Redraws IE windows without shadows since IE messes up canvas alpha when you change element opacity
			if (Browser.Engine.trident) instance.drawWindow(false);
			if (instance.options.type == 'modal' || instance.options.type == 'modal2'){
				MUI.Modal.modalOverlayCloseMorph.start({
					'opacity': 0
				});
			}
			var closeMorph = new Fx.Morph(windowEl, {
				duration: 120,
				onComplete: function(){
					MUI.closingJobs(windowEl);
					return true;
				}.bind(this)
			});
			closeMorph.start({
				'opacity': .4
			});
		}

	},
	closingJobs: function(windowEl){

		var instances = MUI.Windows.instances;
		var instance = instances.get(windowEl.id);
		windowEl.setStyle('visibility', 'hidden');
		// Destroy throws an error in IE8
		if (Browser.Engine.trident) {
			windowEl.dispose();
		}
		else {
			windowEl.destroy();
		}
		instance.fireEvent('onCloseComplete');

		if (instance.options.type != 'notification'){
			var newFocus = this.getWindowWithHighestZindex();
			this.focusWindow(newFocus);
		}

		instances.erase(instance.options.id);
		if (this.loadingWorkspace == true) {
			this.windowUnload();
		}

		if (MUI.Dock && $(MUI.options.dock) && instance.options.type == 'window') {
			var currentButton = $(instance.options.id + '_dockTab');
			if (currentButton != null) {
				MUI.Dock.dockSortables.removeItems(currentButton).destroy();
			}
			// Need to resize everything in case the dock becomes smaller when a tab is removed
			MUI.Desktop.setDesktopSize();
		}
	},
	storeOnClose: function(instance, windowEl){

		if (instance.check) instance.check.hide();

		windowEl.setStyles({
			zIndex: -1
		});
		windowEl.addClass('windowClosed');
		windowEl.removeClass('mocha');

		if (MUI.Dock && $(MUI.options.dock) && instance.options.type == 'window') {
			var currentButton = $(instance.options.id + '_dockTab');
			if (currentButton != null) {
				currentButton.hide();
			}
			MUI.Desktop.setDesktopSize();
		}

		instance.fireEvent('onCloseComplete');

		if (instance.options.type != 'notification'){
			var newFocus = this.getWindowWithHighestZindex();
			this.focusWindow(newFocus);
		}

		instance.isClosing = false;

	},
	/*

	Function: closeAll
		Close all open windows.

	*/
	closeAll: function() {
		$$('.mocha').each(function(windowEl){
			this.closeWindow(windowEl);
		}.bind(this));
	},
	/*

	Function: collapseToggle
		Collapses an expanded window. Expands a collapsed window.

	*/
	collapseToggle: function(windowEl){
		var instance = windowEl.retrieve('instance');
		var handles = windowEl.getElements('.handle');
		if (instance.isMaximized == true) return;
		if (instance.isCollapsed == false) {
			instance.isCollapsed = true;
			handles.hide();
			if ( instance.iframeEl ) {
				instance.iframeEl.setStyle('visibility', 'hidden');
			}
			instance.contentBorderEl.setStyles({
				visibility: 'hidden',
				position: 'absolute',
				top: -10000,
				left: -10000
			});
			if(instance.toolbarWrapperEl){
				instance.toolbarWrapperEl.setStyles({
					visibility: 'hidden',
					position: 'absolute',
					top: -10000,
					left: -10000
				});
			}
			instance.drawWindowCollapsed();
		}
		else {
			instance.isCollapsed = false;
			instance.drawWindow();
			instance.contentBorderEl.setStyles({
				visibility: 'visible',
				position: null,
				top: null,
				left: null
			});
			if(instance.toolbarWrapperEl){
				instance.toolbarWrapperEl.setStyles({
					visibility: 'visible',
					position: null,
					top: null,
					left: null
				});
			}
			if ( instance.iframeEl ) {
				instance.iframeEl.setStyle('visibility', 'visible');
			}
			handles.show();
		}
	},
	/*

	Function: toggleWindowVisibility
		Toggle window visibility with Ctrl-Alt-Q.

	*/
	toggleWindowVisibility: function(){
		MUI.Windows.instances.each(function(instance){
			if (instance.options.type == 'modal' || instance.options.type == 'modal2' || instance.isMinimized == true) return;
			var id = $(instance.options.id);
			if (id.getStyle('visibility') == 'visible'){
				if (instance.iframe){
					instance.iframeEl.setStyle('visibility', 'hidden');
				}
				if (instance.toolbarEl){
					instance.toolbarWrapperEl.setStyle('visibility', 'hidden');
				}
				instance.contentBorderEl.setStyle('visibility', 'hidden');
				id.setStyle('visibility', 'hidden');
				MUI.Windows.windowsVisible = false;
			}
			else {
				id.setStyle('visibility', 'visible');
				instance.contentBorderEl.setStyle('visibility', 'visible');
				if (instance.iframe){
					instance.iframeEl.setStyle('visibility', 'visible');
				}
				if (instance.toolbarEl){
					instance.toolbarWrapperEl.setStyle('visibility', 'visible');
				}
				MUI.Windows.windowsVisible = true;
			}
		}.bind(this));

	},
	focusWindow: function(windowEl, fireEvent){

		// This is used with blurAll
		MUI.Windows.focusingWindow = true;
		var windowClicked = function(){
			MUI.Windows.focusingWindow = false;
		};
		windowClicked.delay(170, this);

		// Only focus when needed
		if ($$('.mocha').length == 0) return;
		if (windowEl != $(windowEl) || windowEl.hasClass('isFocused')) return;

		var instances =  MUI.Windows.instances;
		var instance = instances.get(windowEl.id);

		if (instance.options.type == 'notification'){
			windowEl.setStyle('zIndex', 11001);
			return;
		};

		MUI.Windows.indexLevel += 2;
		windowEl.setStyle('zIndex', MUI.Windows.indexLevel);

		// Used when dragging and resizing windows
		$('windowUnderlay').setStyle('zIndex', MUI.Windows.indexLevel - 1).inject($(windowEl),'after');

		// Fire onBlur for the window that lost focus.
		instances.each(function(instance){
			if (instance.windowEl.hasClass('isFocused')){
				instance.fireEvent('onBlur', instance.windowEl);
			}
			instance.windowEl.removeClass('isFocused');
		});

		if (MUI.Dock && $(MUI.options.dock) && instance.options.type == 'window') {
			MUI.Dock.makeActiveTab();
		}
		windowEl.addClass('isFocused');

		if (fireEvent != false){
			instance.fireEvent('onFocus', windowEl);
		}

	},
	getWindowWithHighestZindex: function(){
		this.highestZindex = 0;
		$$('.mocha').each(function(element){
			this.zIndex = element.getStyle('zIndex');
			if (this.zIndex >= this.highestZindex) {
				this.highestZindex = this.zIndex;
			}
		}.bind(this));
		$$('.mocha').each(function(element){
			if (element.getStyle('zIndex') == this.highestZindex) {
				this.windowWithHighestZindex = element;
			}
		}.bind(this));
		return this.windowWithHighestZindex;
	},
	blurAll: function(){
		if (MUI.Windows.focusingWindow == false) {
			$$('.mocha').each(function(windowEl){
				var instance = windowEl.retrieve('instance');
				if (instance.options.type != 'modal' && instance.options.type != 'modal2'){
					windowEl.removeClass('isFocused');
				}
			});
			$$('.dockTab').removeClass('activeDockTab');
		}
	},
	centerWindow: function(windowEl){

		if(!windowEl){
			MUI.Windows.instances.each(function(instance){
				if (instance.windowEl.hasClass('isFocused')){
					windowEl = instance.windowEl;
				}
			});
		}

		var instance = windowEl.retrieve('instance');
		var options = instance.options;
		var dimensions = options.container.getCoordinates();

		var windowPosTop = window.getScroll().y + (window.getSize().y * .5) - (windowEl.offsetHeight * .5);
		if (windowPosTop < -instance.options.shadowBlur){
			windowPosTop = -instance.options.shadowBlur;
		}
		var windowPosLeft =	(dimensions.width * .5) - (windowEl.offsetWidth * .5);
		if (windowPosLeft < -instance.options.shadowBlur){
			windowPosLeft = -instance.options.shadowBlur;
		}
		if (MUI.options.advancedEffects == true){
			instance.morph.start({
				'top': windowPosTop,
				'left': windowPosLeft
			});
		}
		else {
			windowEl.setStyles({
				'top': windowPosTop,
				'left': windowPosLeft
			});
		}
	},
	resizeWindow: function(windowEl, options){
		var instance = windowEl.retrieve('instance');

		$extend({
			width: null,
			height: null,
			top: null,
			left: null,
			centered: true
		}, options);

		var oldWidth = windowEl.getStyle('width').toInt();
		var oldHeight = windowEl.getStyle('height').toInt();
		var oldTop = windowEl.getStyle('top').toInt();
		var oldLeft = windowEl.getStyle('left').toInt();

		if (options.centered){
			var top = typeof(options.top) != 'undefined' ? options.top : oldTop - ((options.height - oldHeight) * .5);
			var left = typeof(options.left) != 'undefined' ? options.left : oldLeft - ((options.width - oldWidth) * .5);
		}
		else {
            var top = typeof(options.top) != 'undefined' ? options.top : oldTop;
            var left = typeof(options.left) != 'undefined' ? options.left : oldLeft;
		}

		if (MUI.options.advancedEffects == false){
			windowEl.setStyles({
				'top': top,
				'left': left
			});
			instance.contentWrapperEl.setStyles({
				'height': options.height,
				'width':  options.width
			});
			instance.drawWindow();
			// Show iframe
			if (instance.iframeEl){
				if (!Browser.Engine.trident) {
					instance.iframeEl.setStyle('visibility', 'visible');
				}
				else {
					instance.iframeEl.show();
				}
			}
		}
		else {
			windowEl.retrieve('resizeMorph').start({
				'0': {	'height': options.height,
						'width':  options.width
				},
				'1': {	'top': top,
						'left': left
				}
			});
		}
		return instance;
	},
	/*

	Internal Function: dynamicResize
		Use with a timer to resize a window as the window's content size changes, such as with an accordian.

	*/
	dynamicResize: function(windowEl){
		var instance = windowEl.retrieve('instance');
		var contentWrapperEl = instance.contentWrapperEl;
		var contentEl = instance.contentEl;

		contentWrapperEl.setStyles({
			'height': contentEl.offsetHeight,
			'width': contentEl.offsetWidth
		});
		instance.drawWindow();
	}
});

// Toggle window visibility with Ctrl-Alt-Q
document.addEvent('keydown', function(event){
	if (event.key == 'q' && event.control && event.alt) {
		MUI.toggleWindowVisibility();
	}
});

/*
---

name: Modal

script: Modal.js

description: Create modal dialog windows.

copyright: (c) 2007-2009 Greg Houston, <http://greghoustondesign.com/>.	

license: MIT-style license.	

See Also: <Window>

requires:
  - MochaUI/MUI
  - MochaUI/MUI.Windows

provides: [MUI.Modal]

...
*/






MUI.files[MUI.path.source + 'Window/Modal.js'] = 'loaded';

MUI.Modal = new Class({

	Extends: MUI.Window,
	
	options: {
		type: 'modal'
	},	
	
	initialize: function(options){
		
		if (!$('modalOverlay')){
			this.modalInitialize();
		
			window.addEvent('resize', function(){
				this.setModalSize();
			}.bind(this));
		}		
		this.parent(options);

	},
	modalInitialize: function(){
		var modalOverlay = new Element('div', {
			'id': 'modalOverlay',
			'styles': {
				'height': document.getCoordinates().height,				
				'opacity': .6
			}
		}).inject(document.body);
		
		modalOverlay.setStyles({
				'position': Browser.Engine.trident4 ? 'absolute' : 'fixed'
		});
		
		modalOverlay.addEvent('click', function(e){
			var instance = MUI.Windows.instances.get(MUI.currentModal.id);
			if (instance.options.modalOverlayClose == true) {
				MUI.closeWindow(MUI.currentModal);
			}
		});
		
		if (Browser.Engine.trident4){
			var modalFix = new Element('iframe', {
				'id': 'modalFix',
				'scrolling': 'no',
				'marginWidth': 0,
				'marginHeight': 0,
				'src': '',
				'styles': {
					'height': document.getCoordinates().height
				}
			}).inject(document.body);
		}

		MUI.Modal.modalOverlayOpenMorph = new Fx.Morph($('modalOverlay'), {
			'duration': 150
		});
		MUI.Modal.modalOverlayCloseMorph = new Fx.Morph($('modalOverlay'), {
			'duration': 150,
			onComplete: function(){
				$('modalOverlay').hide();
				if (Browser.Engine.trident4){
					$('modalFix').hide();
				}
			}.bind(this)
		});
	},
	setModalSize: function(){
		$('modalOverlay').setStyle('height', document.getCoordinates().height);
		if (Browser.Engine.trident4){
			$('modalFix').setStyle('height', document.getCoordinates().height);
		}
	}

});
if( Browser.Engine.webkit ) {
	MUI.Window.implement({
		shadowStart: function(ctx, shadowBlur, shadowOffset) {
			ctx.shadowColor = "rgba(0, 0, 0, 0.85)";
			ctx.shadowOffsetX = shadowOffset.x;
			ctx.shadowOffsetY = shadowOffset.y;
			ctx.shadowBlur = shadowBlur;
		},
		shadowStop: function(ctx) {
			ctx.shadowColor = "rgba(0,0,0,0)";
			ctx.shadowOffsetX = 0;
			ctx.shadowOffsetY = 0;
			ctx.shadowBlur = 0;
		},
		
		drawBox: function(ctx, width, height, shadowBlur, shadowOffset, shadows){

			var shadowBlur2x = shadowBlur * 2;
			var cornerRadius = this.options.cornerRadius;
	
			if ( shadows != false ) { // start the shadowing
				this.shadowStart(ctx, shadowBlur, shadowOffset);
			}
			// Window body.
			this.bodyRoundedRect(
				ctx,                          // context
				shadowBlur - shadowOffset.x,  // x
				shadowBlur - shadowOffset.y,  // y
				width - shadowBlur2x,         // width
				height - shadowBlur2x,        // height
				cornerRadius,                 // corner radius
				this.options.bodyBgColor      // Footer color
			);
			
			this.shadowStop(ctx); // stop the shadowing
			
			if (this.options.type != 'notification'){
			// Window header.
				this.topRoundedRect(
					ctx,                            // context
					shadowBlur - shadowOffset.x,    // x
					shadowBlur - shadowOffset.y,    // y
					width - shadowBlur2x,           // width
					this.options.headerHeight,      // height
					cornerRadius,                   // corner radius
					this.options.headerStartColor,  // Header gradient's top color
					this.options.headerStopColor    // Header gradient's bottom color
				);
			}	
		},
		
		drawBoxCollapsed: function(ctx, width, height, shadowBlur, shadowOffset, shadows){

			var options = this.options;
			var shadowBlur2x = shadowBlur * 2;
			var cornerRadius = options.cornerRadius;
		
			if ( shadows != false ){
				this.shadowStart(ctx, shadowBlur, shadowOffset);
			}
	
			// Window header
			this.topRoundedRect2(
				ctx,                          // context
				shadowBlur - shadowOffset.x,  // x
				shadowBlur - shadowOffset.y,  // y
				width - shadowBlur2x,         // width
				options.headerHeight + 2,     // height
				cornerRadius,                 // corner radius
				options.headerStartColor,     // Header gradient's top color
				options.headerStopColor       // Header gradient's bottom color
			);
			this.shadowStop(ctx);
	
		},	
		
		drawBoxCollapsed: function(ctx, width, height, shadowBlur, shadowOffset, shadows){

			var options = this.options;
			var shadowBlur2x = shadowBlur * 2;
			var cornerRadius = options.cornerRadius;
		
			if ( shadows != false ){
				this.shadowStart(ctx, shadowBlur, shadowOffset);
			}
	
			// Window header
			this.topRoundedRect2(
				ctx,                          // context
				shadowBlur - shadowOffset.x,  // x
				shadowBlur - shadowOffset.y,  // y
				width - shadowBlur2x,         // width
				options.headerHeight + 2,     // height
				cornerRadius,                 // corner radius
				options.headerStartColor,     // Header gradient's top color
				options.headerStopColor       // Header gradient's bottom color
			);
			this.shadowStop(ctx);
		},
		
		drawGauge: function(ctx, width, height, shadowBlur, shadowOffset, shadows){
			var options = this.options;
			var radius = (width * .5) - (shadowBlur) + 16;
			if ( shadows != false ){
				this.shadowStart(ctx, shadowBlur, shadowOffset);
			}
			MUI.circle(
				ctx,
				width * .5  - shadowOffset.x,
				(height + options.headerHeight) * .5  - shadowOffset.y,
				(width *.5) - shadowBlur,
				options.bodyBgColor,
				1
			);
			this.shadowStop(ctx);
	
			// Draw gauge header
			this.canvasHeaderEl.setStyles({
				'top': shadowBlur - shadowOffset.y,
				'left': shadowBlur - shadowOffset.x
			});		
			var ctx = this.canvasHeaderEl.getContext('2d');
			ctx.clearRect(0, 0, width, 100);
			ctx.beginPath();
			ctx.lineWidth = 24;
			ctx.lineCap = 'round';
			ctx.moveTo(13, 13);
			ctx.lineTo(width - (shadowBlur*2) - 13, 13);
			ctx.strokeStyle = 'rgba(0, 0, 0, .65)';
			ctx.stroke();
		}
	});
}
;
/*Name: ArrayListDescription: JavaScript implementation of Java ArrayList class.Requires:Provides:	- ArrayListPart of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. http://www.processpuzzle.comAuthors: 	- Zsolt ZsuffaCopyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation, either version 3 of the License, or (at your option) any later version.This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty ofMERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.*///= require_directory ../MochaUIvar ArrayList = new Class({   initialize : function() {      this.array = new Array();   },   add : function( obj ) {      this.array[this.array.length] = obj;   },      addAll : function( array ) {      if (array instanceof Array) {         for ( var i = 0; i < array.length; i++) {            this.add( array[i] );         }      } else if (array instanceof ArrayList) {         for ( var i = 0; i < array.size(); i++) {            this.add( array.get( i ) );         }      }   },      clear : function() {      this.array = new Array();   },      clone : function() {      var clonedList = new ArrayList();      this.each( function( listElement, index ){         clonedList.add( listElement );      }, this );      return clonedList;   },   contains : function( elem ) {      for ( var i = 0; i < this.array.length; i++) {         if (this.array[i] == elem )            return true;      }      return false;   },      each : function( fn, bind ){      for( var i = 0, l = this.size(); i < l; i++ ){         fn.call( bind, this.get( i ), i, this );      }   },      equals : function( anotherList ){      if( !instanceOf( anotherList, ArrayList )) return false;      if( anotherList.size() != this.size() ) return false;      for( var i = 0; i < this.size(); i++ ) {         if( this.get( i ) != anotherList.get( i )) return false;      }      return true;   },      get : function(index) {      return this.array[index];   },      getLast : function(){      return this.get( this.size() -1 );   },      indexOf : function( obj ){      var elementIndex = null;      this.array.some( function( element, index ){         if( element.equals( obj ) ){            elementIndex = index;            return true;         }       }, this );      return elementIndex;   },      isEmpty : function() {      if( this.size() > 0 ) return false;      else return true;   },      iterator : function() {      return new ArrayListIterator( this );   },      remove : function( index ){      var elementAtIndex = this.get( index );      if( elementAtIndex ) {         this.array[index] = null;         this.array = this.array.clean();      }   },      size : function() {      return this.array.length;   }   });var ArrayListIterator = new Class({      initialize : function( arrayList ) {      this.arrayList = arrayList;      this.index = 0;   },      hasNext : function() {      return this.index < this.arrayList.size();   },      next : function() {      return this.arrayList.get( this.index++ );   }});
/*
Name: 

Description: 

Requires:

Provides:

Part of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. 
http://www.processpuzzle.com

Authors: 
	- Zsolt Zsuffa

Copyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the 
GNU General Public License as published by the Free Software Foundation, either version 3 of the License, 
or (at your option) any later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/



function AssertUtil(){
}
new AssertUtil();
AssertUtil.assertInclude = function (object, jsFile) {
	if (object==null) {
		throw new AssertException( "file " + jsFile + " was not included ");
	}
};
AssertUtil.assertParamNotNull = function (value, paramName){
	if (value == null) {
		throw new IllegalArgumentException(  "Parameter must not be null: " + paramName );
	}
};
AssertUtil.assertParamIsNotEmpty = function (value, paramName){
	AssertUtil.assertParamNotNull(value, paramName);
	if (StringUtil.isEmpty(value)){
		throw new IllegalArgumentException(  "Parameter must not be empty: " + paramName );
	}
};
AssertUtil.assertIntegerParam = function (value, paramName){	AssertUtil.assertParamNotNull (value, paramName);
	var i = parseInt(value, 10);
	if ((i == null) || (isNaN(i))) {
		throw new IllegalArgumentException( "Invalid Integer Parameter: " + paramName);
	}
};
AssertUtil.assertTrue = function (expr, exprName){
	if (!expr) {
		throw new IllegalArgumentException(  "Expression: " + exprName + " evaluated to false." );
	}
};

AssertUtil.assertGreaterThanZeroParam = function (value, paramName){
	AssertUtil.assertIntegerParam (value, paramName);
	var i = parseInt(value, 10);
	if (i <= 0) {
		throw new IllegalArgumentException( " assertGreaterThanZeroParam : " + paramName);
	}
};
AssertUtil.assertInstance = function (param, clazz, clazzName){
	AssertUtil.assertParamNotNull(param, "param");
	AssertUtil.assertParamFalse(typeof(clazz) == "string", "Invalid clazz parameter");
	if (!(param instanceof clazz)) {
	    throw new IllegalArgumentException( " Invalid parameter must be instance of " + clazzName);
	}
}; 
AssertUtil.assertParamInstance = function (param, clazz, clazzName){
	if (!(param instanceof clazz)) {
		throw new IllegalArgumentException( " Invalid parameter must be instance of " + clazzName);
	}
};
AssertUtil.assertResultNotNull = function (valueOfResult, message) {
	if ( valueOfResult == null ){
		throw new AssertException( "Invalid result value: " + message);
	}
};
AssertUtil.assertParamFalse = function(booleanValue , message) {
	if (booleanValue) {
	    throw new IllegalArgumentException( "AssertParamFalse Exception message: " + message);
	}
};
AssertUtil.assertMethodExists = function(object, functionName) {
	AssertUtil.assertParamNotNull( object, "object");
	if (object[functionName]==null) {
		throw new AssertException(  " Object " + object + " does not have function :" + functionName );
	}
};
AssertUtil.assertMemberState = function(member, memberName, clazz, clazzName, mandatory, valueRange) {
    if (mandatory){
		if (member == null){
			throw new AssertException( " Member " + memberName + " must not be null ");
		}
		if (!(member instanceof clazz)) {
			throw new AssertException( " Invalid state " + memberName + " must be instance of " + clazzName);
		}
	}
    else if (member != null){
		if (!(member instanceof clazz)) {
			throw new AssertException( "Invalid state " + memberName + " must be instance of " + clazzName);
		}
	}
};
AssertUtil.assertMemberStateString = function(member, memberName, mandatory, valueRange){    if (mandatory){
		if (typeof(member) != typeof(" ")) {
			throw new AssertException( new AssertException( "Invalid state " + memberName + 
                        " must be instance of string and not " + typeof(member)) );		}
		if (StringUtil.isEmpty(member)){			throw new AssertException( "AssertException "  + memberName + " must not be empty");
		}
	}else if (member != null){
		if (typeof(member) != typeof(" ")) {
			throw new AssertException( "Invalid state " + memberName + " must be instance string " );
		}
	}
};
/*
Name: HashMap

Description: JavaScript implementation of Java HashMap.

Requires:

Provides:
	- HashMap

Part of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. 
http://www.processpuzzle.com

Authors: 
	- Zsolt Zsuffa

Copyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the 
GNU General Public License as published by the Free Software Foundation, either version 3 of the License, 
or (at your option) any later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/



var HashMap = new Class( {
   // Constructor
   initialize : function() {
      // instance variables
      this.table = new Array();
      this.len = 8;
      this.length = 0;
   },

   // Public accessors and mutators
   clear : function() {
      for ( var i = 0; i < this.table.length; i++)
         this.table[i] = null;
      this.length = 0;
   },

   containsKey : function( key ) {
      var hash = this.hash( key );
      var i = this.indexFor( hash );
      var e = this.table[i];

      while( e != null ) {
         if( e.hash == hash && key.equals( e.key ))
            return true;
         e = e.next;
      }
      return false;
   },

   containsValue : function( value ) {
      if( value == null ) return false;
      
      var tab = this.table;
      for( var i = 0; i < tab.length; i++ )
         for ( var e = tab[i]; e != null; e = e.next )
            if( value.equals( e.value ))
               return true;
      return false;
   },

   
   each : function( fn, bind ){
      var iterator = this.iterator();
      var index = 0;
      while( iterator.hasNext() ){
         var mapEntry = iterator.next();
         fn.call( bind, mapEntry, index, this );
         index++;
      }
   },
   
   equals : function( map ) {
      if( map.size() != this.size() )
         return false;

      for ( var it = this.iterator(); it.hasNext();) {
         var e = it.next();
         var key = e.getKey();
         var value = e.getValue();
         if (!value.equals( map.get( key ) ))
            return false;
      }
      return true;
   },

   get : function( key ) {
   	if( !key ) return null;
   	
      var entry = this.getEntry( key );
      if( entry ) return entry.value;
      else return null;
   },
   
   hashCode : function() {
      var h = 0;
      for ( var it = this.iterator(); it.hasNext();) {
         h += it.next().hashCode();
      }
      return h;
   },

   isEmpty : function() {
      return this.length == 0;
   },

   iterator : function() {
      var i = this.table.length;
      var next = null;
      while (i > 0 && next == null) {
         next = this.table[--i];
      }
      return new HashIterator( this.table, i, next );
   },

   put : function( key, value ) {
      var hash = this.hash( key );
      var bucketIndex = this.indexFor( hash );
      for( var entry = this.table[bucketIndex]; entry != null; entry = entry.next ) {
         if( entry.hash == hash && key.equals( entry.key )) {
            var oldValue = entry.value;
            entry.value = value;
            return oldValue;
         }
      }

      this.addEntry( hash, key, value, bucketIndex );
      var r = Math.ceil( this.length * 1.5 );

      if (r > this.len) {
         this.len = this.len << 1;
         this.rehash();
      }
      return null;
   },

   putAll : function(map) {
      var mod = false;
      for ( var it = map.iterator(); it.hasNext();) {
         var e = it.next();
         if (this.put( e.getKey(), e.getValue() ))
            mod = true;
      }
   },

   remove : function(key) {
      var e = this.removeEntryForKey( key );
      return (e == null ? null : e.value);
   },

   removeEntryForKey : function( key ) {
      var hash = this.hash( key );
      var bucketIndex = this.indexFor( hash );
      var prev = this.table[bucketIndex];
      var e = prev;

      while( e != null ) {
         var next = e.next;
         if( e.hash == hash && key.equals( e.key )) {
            this.length--;
            if( prev.equals( e ))
               this.table[bucketIndex] = next;
            else
               prev.next = next;
            return e;
         }
         prev = e;
         e = next;
      }
      return e;
   },

   size : function() {
      return this.length;
   },

   toString : function() {
      return this.getKey() + "=" + this.getValue();
   },

   // Private helper methods
   addEntry : function( hash, key, value, bucketIndex ) {
      this.table[bucketIndex] = new Entry( hash, key, value, this.table[bucketIndex] );
      this.length++;
   }.protect(),

   getEntry : function( key ) {
      var hash = this.hash( key );
      var i = this.indexFor( hash );
      var e = this.table[i];

      while( true ) {
         if( e == null ) return null;
         
         if( e.hash == hash && key.equals( e.key )) return e;
         
         e = e.next;
      }
   },
   
   hash : function( x ) {
      var h = x.hashCode();
      return h;
   }.protect(),

   indexFor : function( hash ) {
      var index = hash & ( this.len - 1 );
      return index;
   }.protect(),

   rehash : function() {
      var oldTable = this.table;
      this.table = new Array();
      // transfer
      for ( var i = 0; i < oldTable.length; i++) {
         var e = oldTable[i];
         if (e != null) {
            oldTable[i] = null;
            do {
               var next = e.next;
               var j = this.indexFor( e.hash );
               e.next = this.table[j];
               this.table[j] = e;
               e = next;
            } while (e != null);
         }
      }
   }.protect()
});

var Entry = new Class( {
   initialize : function( hash, key, value, next ) {
      this.value = value;
      this.next = next;
      this.key = key;
      this.hash = hash;
   },

   getKey : function() { return this.key; },
   getValue : function() { return this.value; },

   setValue : function( newValue ) {
      var oldValue = this.value;
      this.value = newValue;
      return oldValue;
   },

   equals : function( o ) {
      var e = o;
      var k1 = this.getKey();
      var k2 = e.getKey();
      var v1 = this.getValue();
      var v2 = e.getValue();
      return (k1.equals( k2 ) && v1.equals( v2 ));
   }
});

var HashIterator = new Class({
   initialize : function( table, index, nextEntry ) {
      this.table = table;
      this.nextEntry = nextEntry;
      this.index = index;
      this.current = null;
   },

   hasNext : function() {
      return this.nextEntry != null;
   },

   next : function() {
      var e = this.nextEntry;
      if (e == null)
         throw "No such Element";
      var n = e.next;
      var t = this.table;
      var i = this.index;
      while (n == null && i > 0)
         n = t[--i];
      this.index = i;
      this.nextEntry = n;
      this.current = e;

      return this.current;
   }
});
/*
 * Name: HasSet
 * 
 * Description: JavaScript implementation of Java HashSet
 * 
 * Requires:
 * 
 * Provides:
 * 
 * Part of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly
 * configurable, browser font-end, based on MochaUI and MooTools.
 * http://www.processpuzzle.com
 * 
 * Authors: - Zsolt Zsuffa
 * 
 * Copyright: (C) 2011 This program is free software: you can redistribute it
 * and/or modify it under the terms of the GNU General Public License as
 * published by the Free Software Foundation, either version 3 of the License,
 * or (at your option) any later version.
 * 
 * This program is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
 * FOR A PARTICULAR PURPOSE. See the GNU General Public License for more
 * details.
 * 
 * You should have received a copy of the GNU General Public License along with
 * this program. If not, see <http://www.gnu.org/licenses/>.
 */



var HashSet = new Class( {
	// Constructor
	initialize : function() {
		this.map = new HashMap();
		this.ZERO = 0;
	},

	// Public accessors and mutators
	add : function( object ) {
		this.map.put( object, this.ZERO ) == null;
	},

	addAll : function(set) {
		var mod = false;
		for ( var it = set.iterator(); it.hasNext();) {
			if (this.add( it.next() ))
				mod = true;
		}
		return mod;
	},

	clear : function() {
		this.map.clear();
	},

	contains : function(o) {
		return this.map.containsKey( o );
	},

   each : function( fn, bind ){
      var iterator = this.iterator();
      var index = 0;
      while( iterator.hasNext() ){
         var setElement = iterator.next();
         fn.call( bind, setElement, index, this );
         index++;
      }
   },
   
	equals : function(o) {
		if (o.size() != this.size())
			return false;
		for ( var it = this.iterator(); it.hasNext();) {
			if (!o.contains( it.next() ))
				return false;
		}
		return true;
	},

	hashCode : function() {
		var h = 0;
		for ( var it = this.iterator(); it.hasNext();) {
			h += it.next().hashCode();
		}
		return h;
	},

	isEmpty : function() {
		return this.map.isEmpty();
	},

	iterator : function() {
      return new SetIterator( this.map );
	},

	remove : function(o) {
		return this.map.remove( o ).equals( this.ZERO );
	},

	size : function() {
		return this.map.size();
	},

	toArray : function() {
		var arr = new Array();
		var i = 0;
		for ( var it = this.iterator(); it.hasNext();) {
			arr[i++] = it.next();
		}
		return arr;
	},

	// Protected, private helper methods
	hashIterator : function(it) {
		this.it = it;
	}.protect()

});

var SetIterator = new Class({
   initialize : function( map ) {
      this.mapIterator = map.iterator();
   },

   hasNext : function() {
      return this.mapIterator.hasNext();
   },

   next : function() {
      return this.mapIterator.next().getKey();
   }
});

/*
Name: WebUIException

Description: 

Requires:

Provides:

Part of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. 
http://www.processpuzzle.com

Authors: 
	- Zsolt Zsuffa

Copyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the 
GNU General Public License as published by the Free Software Foundation, either version 3 of the License, 
or (at your option) any later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/



var WebUIException = new Class({
   Implements: Options,
   options: {
      cause: null,
      description: "Please overwrite this option.",
      message : "",
      name: "WebUIException",
      source: null
   },
   
   //Constructors
   initialize: function( options ){
     this.setOptions( options );
     this.parameters;
   },
   
   //Public accessor and mutator methods
   stackTrace: function() {
      var stackTrace = "";
      if( this.options.cause && this.options.cause.stackTrace() )
         stackTrace += "\n" + this.options.cause.stackTrace();
      
      return stackTrace;
   },
   
   //Properties
   getCause: function() { return this.options.cause; },
   getDescription : function() { return this.options.description; },
   getMessage: function() { return this.options.description.substitute( this.parameters ); }, 
   getName: function() { return this.options.name; },
   getSource : function() { return this.options.source; }
});
/*
Name: UndefinedXmlResourceException

Description: 

Requires:

Provides:

Part of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. 
http://www.processpuzzle.com

Authors: 
	- Zsolt Zsuffa

Copyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the 
GNU General Public License as published by the Free Software Foundation, either version 3 of the License, 
or (at your option) any later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/




var IllegalArgumentException = new Class({
   Extends: WebUIException,
   options: {
      description: "Argument: '{argumentName}' has inappropriate value: '{argumentValue}'.",
      name: "IllegalArgumentException"
   },
   
   //Constructor
   initialize : function( argumentName, argumentValue, options ){
      this.parent( options );
      this.parameters = { argumentName : argumentName, argumentValue : argumentValue };
   }	
});
/*
Name: 

Description: 

Requires:

Provides:

Part of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. 
http://www.processpuzzle.com

Authors: 
	- Zsolt Zsuffa

Copyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the 
GNU General Public License as published by the Free Software Foundation, either version 3 of the License, 
or (at your option) any later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/



Object.extend({
   hashCode : function( thisObject ) {
      var h = 0;
      var s = thisObject.toString();
      for ( var i = 0; i < s.length; i++) {
         h = 31 * h + s.charCodeAt( i );
      }
      return h;
   },
   
   isA : function( instance, clss ) {
      var type = typeOf(clss);
     
      if (type == 'string') {
          var clss_names = clss.split('.'),
              clss_name = clss_names.shift();

          clss = window[clss_name];

          if (!clss) return false;

          while( clss_name = clss_names.shift()) {
              if (!clss_name in clss) return false;
              clss = clss[clss_name];
          }
          type = typeOf(clss);
      }

      if (['function', 'class'].contains(type)) {
          return (instance instanceof clss);
      }

      return false;
   },
   
   typeMatches : function( thisObject, obj ) {
      return thisObject.getClass() === obj.getClass();
   },
   
   equals : function( thisObject, obj) {
      if( !thisObject.typeMatches( obj )) return false;
      if( typeOf( thisObject ) == 'object' ){
         for( var objectProperty in thisObject ){
            if( thisObject[objectProperty] != obj[objectProperty] ) return false;
         }
         return true;
      }
      else return thisObject.toString() === obj.toString();
   }
});

Class.implement({
   equals : function( otherClass ){
      return this.hashCode() == otherClass.hashCode();
   },
   
   hashCode : function() {
      var hashCode = Object.hashCode( this.prototype.initialize.$origin );
      return hashCode;
   }
});

var JavaObject = new Class({
   /*
   getClass : function() {
      //Unfortunatelly there is no chanche to implement this in JavaScript.
   },*/
   
   hashCode : function() {
      return Object.hashCode( this );
   },
   
   typeMatches : function( obj ) {
      return Object.typeMaches( this, obj );
   },
   
   equals : function( obj ) {
      return Object.equals( this, obj );
   }
});

Array.implement({
   equals : function( otherArray ){
      var isEqual = true;
      this.each( function( currentItem, index ){
         var currentItemEquality = currentItem.equals( otherArray[index] );
         if( !currentItemEquality ) 
            isEqual = false;
      });
      return isEqual;
   }
});

//Boolean
Boolean.implement({
   parseBoolean : function( booleanString ) {
      return eval( booleanString );
   }
});

function parseBoolean( booleanString ){
   return new Boolean().parseBoolean( booleanString );
} 

// String
String.implement({
   compareTo : function(str) {
      if (!this.typeMatches( str ))
         throw "Type Mismacth!";
      var s1 = this.toString();
      var s2 = str.toString();
      if (s1 === s2)
         return 0;
      else if (s1 > s2)
         return 1;
      else
         return -1;
   },
   
   compareToIgnoreCase : function(str) {
      if( !this.typeMatches( str ))
         throw "Type Mismacth!";
      var s1 = this.toUpperCase();
      var s2 = str.toUpperCase();
      if (s1 === s2)
         return 0;
      else if (s1 > s2)
         return 1;
      else
         return -1;
   },
   
   concat : function(str) {
      return new String( this.toString() + str );
   },
   
   endsWith : function(suffix) {
      return this.substring( this.length - suffix.length ) == suffix;
   },
   
   equals : function( obj ) {
      return Object.equals( this, obj );
   },
   
   equalsIgnoreCase : function( str ) {
      if( typeOf( str ) != "string" ) return false;
      return this.toUpperCase() === str.toUpperCase();
   },

   hashCode : function() {
      return Object.hashCode( this );
   },
   
   startsWith : function(prefix) {
      return this.substring( 0, prefix.length ) == prefix;
   },
   
   toCharArray : function() {
      var charArr = new Array();
      for ( var i = 0; i < this.length; i++)
         charArr[i] = this.charAt( i );
      return charArr;
   },
   
   trim : function() {
      return this.replace( /(^\s*)|(\s*$)/g, "" );
   },
   
   typeMatches : function( obj ) {
      return typeOf( this ) === typeOf( obj );
   }
   
});

// Number
Number.implement({
   compareTo : function(obj) {
      if (!this.typeMatches( obj ))
         return false;
      return this - obj;
   },
   
   equals : function(obj) {
      if (!this.typeMatches( obj ))
         return false;
      return this.toString() == obj.toString();
   },
   
   hashCode : function() {
      // just for int,not for double
      return (this);
   },
   
   toBinaryString : function(i) {
      return i.toString( 2 );
   },
   
   toHexString : function(i) {
      return i.toString( 16 );
   }
});

// Date
Date.implement({
   compareTo : function(obj) {
      if (!this.typeMatches( obj ))
         return false;
      var thisInMillis = this.getTime();
      var objInMillis = obj.getTime();
      var difference = thisInMillis - objInMillis;
      var returnValue = difference & 0xffffffff;
      return returnValue;
   },

   equals : function(obj) {
      if (!this.typeMatches( obj ))
         return false;
      return this.getTime() == obj.getTime();
   },

   hashCode : function() {
      var l = this.getTime();
      var s = Number.toHexString( l );
   
      var high = 0;
      if (s.length > 8)
         high = parseInt( s.substring( 0, s.length - 8 ), 16 );
   
      var low = l & 0xffffffff;
      return low ^ high;
   },
   
   typeMatches : function( obj ) {
      return typeOf( this ) === typeOf( obj );
   }
});

//Function
Function.implement({
   equals : function( otherFunction ){
      if (!this.typeMatches( otherFunction )) return false; 
      return this === otherFunction;
   },

   typeMatches : function( otherFunction ) {
      return typeOf( this ) === typeOf( otherFunction );
   }
});
/*
Name: LinkedHashMap

Description: Hash table and linked list implementation of the Map interface, with predictable iteration order. 

Requires:

Provides:
	- LinkedHashMap

Part of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. 
http://www.processpuzzle.com

Authors: 
	- Zsolt Zsuffa

Copyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the 
GNU General Public License as published by the Free Software Foundation, either version 3 of the License, 
or (at your option) any later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/



var LinkedHashMap = new Class({
	Extends: HashMap,
	
   // Constructor
   initialize : function() {
      this.parent();
      this.firstEntry = null;
      this.lastEntry = null;
   },
   
   //Public accessors and mutators
   clear: function(){
      this.firstEntry = null;
      this.lastEntry = null;
      this.parent();
   },
   
   each : function( fn, bind ){
      var iterator = this.iterator();
      var index = 0;
      while( iterator.hasNext() ){
         var mapEntry = iterator.next();
         fn.call( bind, mapEntry, index, this );
         index++;
      }
   },
   
   first : function() {
      return this.firstEntry.getValue();
   },
   
   firstKey : function() {
      if( this.length > 0 ) return this.firstEntry.getKey();
      else return null;
   },
   
   iterator : function() {
      return new LinkedHashIterator( this.firstEntry );
   },

   last : function() {
      return this.lastEntry.getValue();
   },
   
   lastKey : function() {
   	if( this.length > 0 ) return this.lastEntry.getKey();
   	else return null;
   },
   
   next : function( referenceKey ){
      if( !referenceKey ) return null;
      
      var referenceEntry = this.getEntry( referenceKey );
      var nextEntry = referenceEntry.getNextEntry(); 
      if( nextEntry ) return nextEntry.getValue();
      else return null;
   },
   
   nextKey : function( referenceKey ) {
      if( !referenceKey ) return null;
   	
      var referenceEntry = this.getEntry( referenceKey );
      var nextEntry = referenceEntry.getNextEntry(); 
      if( nextEntry ) return nextEntry.getKey();
      else return null;
   },
   
   previous : function( referenceKey ){
   	return this.get( this.previousKey( referenceKey ));
   },
   
   previousKey : function( referenceKey ) {
   	if( !referenceKey ) return null;
   		
   	var referencedEntry = this.getEntry( referenceKey );
   	return this.findKeyBySerialIndex( referencedEntry.getSerialIndex() -1 );
   },
   
   // Private helper methods
   addEntry : function( hash, key, value, bucketIndex ) {
      var newEntry = new LinkedEntry( hash, key, value, this.table[bucketIndex], this.length, this.lastEntry );
      this.table[bucketIndex] = newEntry;
      if( this.firstEntry == null ) this.firstEntry = newEntry;
      if( this.lastEntry ) this.lastEntry.setNextEntry( newEntry );
      this.lastEntry = newEntry;
      this.length++;
   }.protect(),
   
   findKeyBySerialIndex : function( serialIndex ){
   	var searchedKey = null;
   	this.each( function( entry, index ){
   		if( entry.getSerialIndex() == serialIndex ) 
   			searchedKey = entry.getKey();
   	}, this );

   	return searchedKey;
   }.protect()

});

var LinkedEntry = new Class( {
   Extends : Entry,
	
   initialize : function( hash, key, value, next, serialIndex, previousEntry ) {
      this.parent( hash, key, value, next );
      this.nextEntry = null;
      this.previousEntry = previousEntry;
      this.serialIndex = serialIndex;
   },

   getNextEntry: function() { return this.nextEntry; },
   getSerialIndex : function() { return this.serialIndex; },
   setNextEntry: function( nextEntry ) { this.nextEntry = nextEntry; }
});

var LinkedHashIterator = new Class({
   initialize : function( firstEntry ) {
      this.currentEntry = firstEntry;
   },

   hasNext : function() {
      return this.currentEntry != null;
   },

   next : function() {
      var nextEntry = this.currentEntry;
      this.currentEntry = nextEntry.getNextEntry();
      return nextEntry;
   }
});

/*Name: OptionsResourceDescription: Unmarshalls a set of options from an XML file and transforms to a JavaScript object.Requires:    - XmlResourceProvides:	- OptionsResourcePart of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. http://www.processpuzzle.comAuthors: 	- Zsolt ZsuffaCopyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation, either version 3 of the License, or (at your option) any later version.This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty ofMERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.*///= require_directory ../MochaUIvar OptionsResource = new Class({   Implements: [Options],      options : {      nameSelector : "@name",      optionSelector : "option",      valueSelector : "@value"   },   //Constructor   initialize : function( definitionElement, options ) {      assertThat( definitionElement, not( nil() ));      this.setOptions( options );            this.definitionElement = definitionElement;      this.optionsAsText = "";      this.optionsObject;   },      //Public accessors and mutators   unmarshall: function(){      this.unmarshallOptions();      this.evaluateOptions();   },      //Properties   getOptions: function() { return this.optionsObject; },      //Protected, private helper methods   evaluateOptions: function(){      this.optionsObject = eval( "({" + this.optionsAsText + "})" );   }.protect(),      unmarshallOptions: function(){      var optionElements = XmlResource.selectNodes( this.options.optionSelector, this.definitionElement );      optionElements.each( function( optionElement, index ){         if( index > 0 ) this.optionsAsText += ", ";         var name = XmlResource.selectNodeText( this.options.nameSelector, optionElement );         var value = XmlResource.selectNodeText( this.options.valueSelector, optionElement );//         var arrayExpression = new RegExp( "^[\[]" ); //^[\[]+.*+[]$//         if( value.match( arrayExpression )) //            this.optionsAsText += name + " : " + eval( value );         this.optionsAsText += name + " : " + value ;      }, this );   }.protect()});
/*
Name: RemoteResource

Description: Retrieves any resource. Overrides isSuccess() of Request to handle local files.

Requires:
   - Request

Provides:
   - RemoteResource

Part of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. 
http://www.processpuzzle.com

Authors: 
    - Zsolt Zsuffa

Copyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the 
GNU General Public License as published by the Free Software Foundation, either version 3 of the License, 
or (at your option) any later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/



var RemoteResource = new Class({
   Extends: Request,
   
   options: {
      async : true,
      method : 'get',
      nameSpaces: "xmlns:pp='http://www.processpuzzle.com'"
   },
   
   // Constructor
   initialize: function ( uri, options ) {
      // parameter assertions
      assertThat( uri, not( nil() ));
      
      this.parent( options );
      this.options.url = uri;
   },
   
   //Public accessors and mutators
   isSuccess: function() { // Determines if an XMLHttpRequest was successful or not
      try {
          // IE error sometimes returns 1223 when it should be 204 so treat it as success, see #1450
          return ( location.protocol === "file:" && !this.status && this.status === 0 && ( this.response.text || this.response.xml )) ||
              // Opera returns 0 when status is 304
              ( this.status >= 200 && this.status < 300 ) ||
              ( this.status === 304 ) || 
              ( this.status === 1223 );
      } catch(e) {}

      return false;
  },
  
  retrieve: function(){
     try{
        this.send( this.options.url );
     }catch( e ){
        if( e.name == "NS_ERROR_FILE_NOT_FOUND" ) this.failure();
        else if( e.name == "Error" ) this.failure();
        else throw new e ;
     }
  },
  
  // Properties
  getUri: function() { return this.options.url; },
  isAsync: function() { return this.options.async; }
  
  //Private helper methods
});
   
//Author: Year of Moo

var RemoteStyleSheet = new Class( {
   Implements : [Options, Events],
   Binds: ['_checker'],

   options : {
      delay : 100,
      maxAttempts : 1000,
      idPrefix : 'css-preload-'},

   initialize : function( path, options ) {
      this.setOptions( options );
      this.path = path;
      this.id = this.options.idPrefix + (new Date().getTime());
   },

   getPath : function() {
      return this.path;
   },

   getID : function() {
      return this.id;
   },

   getElement : function() {
      return this.link;
   },

   _onready : function() {
      var args = [this.getPath(), this.getElement()];
      this.fireEvent( 'ready', args );
   },

   _onerror : function() {
      this.link.destroy();
      this.link = null;
      var args = [this.getPath()];
      this.fireEvent( 'error', args );
   },

   _onstart : function() {
      var args = [this.getPath(), this.getElement()];
      this.fireEvent( 'start', args );
   },

   createLinkElement : function() {
      this.link = new Element( 'link' );
      this.link.type = 'text/css';
      this.link.rel = 'stylesheet';
      this.link.id = this.getID();
      this.link.href = this.getPath();
      return this.link;
   },

   _checker : function() {
      if( !this.counter ){
         this.counter = 0;
      }

      var target = $( this.getID() );
      if( target.sheet ){
         var stylesheets = document.styleSheets;
         for( var i = 0; i < stylesheets.length; i++ ){
            var file = stylesheets[i];
            var owner = file.ownerNode ? file.ownerNode : file.owningElement;
            if( owner && owner.id == this.getID() ){
               this._onready();
               return;
            }

            if( this.counter++ > this.options.maxAttempts ){
               this._onerror();
               return;
            }
         }
      }

      this._checker.delay( this.options.delay, this );
   },

   start : function() {
      var callChecker = false;
      this.link = this.createLinkElement();
      if( Browser.ie || Browser.opera ){
         this.link.onload = this._onready.bind( this );
         this.link.onerror = this._onerror.bind( this );
      }else{
         callChecker = true;
      }

      try{
         document.getElement( 'head' ).appendChild( this.link );
         this._onstart();
      }catch( e ){
         this._onerror( e );
      }

      if( callChecker ){ 
         try{
            this._checker();
         }catch( e ){
            alert( e );
         }
      }
   }

} );
/*
Name: ResourceUri

Description: Helps to analyze a localize an uri.

Requires:
   - 

Provides:
   - ResourceUri

Part of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. 
http://www.processpuzzle.com

Authors: 
    - Zsolt Zsuffa

Copyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the 
GNU General Public License as published by the Free Software Foundation, either version 3 of the License, 
or (at your option) any later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/



var ResourceUri = new Class({
   Implements: Options,
   
   options: {
      applyCacheBuster : false,
      componentName : "ResourceUri",
      contentType : "xml",
      documentType : null,
      documentTypeKey : 'documentType'
   },
   
   // Constructor
   initialize: function ( fullUri, locale, options ) {
      // parameter assertions
      assertThat( fullUri, not( nil() ));
      
      this.setOptions( options );
      
      this.documentContentUri;
      this.documentVariables;
      this.locale = locale;
      this.fullUri = fullUri;
      this.uri;
      
      this.determineStrippedUri();
      this.determineDocumentContentUri();
      this.determineDocumentType();
      this.determineDocumentVariables();
      if( this.options.applyCacheBuster ) this.fullUri = this.appendCacheBusterParameterToUri( this.fullUri );
   },
   
   //Public accessors and mutators
   appendCacheBusterParameterToUri : function( fullUri ) {
      if( fullUri.indexOf( "?" ) == -1 ) fullUri += "?";
      else fullUri += "&";
      fullUri += "cacheBuster=";
      fullUri += new Date().getTime();
      return fullUri;
   },
   
   determineLocalizedUri : function(){
      var localizedUri = this.fullUri.indexOf( "." + this.options.contentType ) >= 0 ? this.fullUri.substring( 0, this.fullUri.lastIndexOf( "." + this.options.contentType )) : this.fullUri; 
      localizedUri += "_" + this.locale.getLanguage() + "." + this.options.contentType;
      return localizedUri;
   },
   
   isLocal : function(){
      var givenUri = new URI( this.fullUri );
      var documentUri = new URI( document.location.href );
      return givenUri.get( 'host' ) == "" || givenUri.get( 'host' ) == documentUri.get( 'host' ); 
   },
  
   // Properties
   getDocumentContentUri : function() { return this.documentContentUri; },
   getDocumentType : function() { return this.options.documentType; },
   getDocumentVariables : function() { return this.documentVariables; },
   getUri : function() { return this.uri; },
   
   //Private helper methods
   determineDocumentContentUri : function(){
      var givenUri = new URI( this.fullUri );
      if( givenUri.get( 'data' ) && givenUri.getData( 'contentUri' )){
         this.documentContentUri = eval( givenUri.getData( 'contentUri' ));
      }else this.documentContentUri = null;
   }.protect(),
   
   determineDocumentType : function(){
      if( !this.options.documentType ){
         var givenUri = new URI( this.fullUri );
         if( givenUri.get( 'data' ) && givenUri.getData( this.options.documentTypeKey ))
            this.options.documentType = AbstractDocument.Types[givenUri.getData( this.options.documentTypeKey )];
      }
   }.protect(),
   
   determineDocumentVariables : function(){
      var givenUri = new URI( this.fullUri );
      if( givenUri.get( 'data' ) && givenUri.getData( 'documentVariables' )){
         this.documentVariables = givenUri.getData( 'documentVariables' );
      }else this.documentVariables = null;
   }.protect(),
   
   determineStrippedUri : function(){
      if( this.fullUri.indexOf( '?' ) > 0 )
         this.uri = this.fullUri.substring( 0, this.fullUri.indexOf( '?' ))
      else this.uri = this.fullUri;
   }
});
   
/*
Name: StringTokenizer

Description: Breaks a string into tokens.  

Requires:

Provides:

Part of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. 
http://www.processpuzzle.com

Authors: 
	- Zsolt Zsuffa

Copyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the 
GNU General Public License as published by the Free Software Foundation, either version 3 of the License, 
or (at your option) any later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/



var StringTokenizer = new Class( {
   Implements : [Options], 
   options : {
      delimiters: " \t\n\r\f",
      returnTokens: false
   },
   
   //Constructors
   initialize: function( string, options ) {
      assertThat( string, not( nil() ));
      this.setOptions( options );
      this.s = string;
      this.current = 0;

      // Handle leading delimiters if returnTokens is false
      if( !this.returnTokens ) {
         while(( this.current < this.s.length ) && ( this.options.delimiters.indexOf( this.s.charAt( this.current ) ) >= 0)) {
            this.current++;
         }
      }

      // Check to see if there are any tokens
      if( this.current >= this.s.length )
         this.moreTokens = false;
      else
         this.moreTokens = true;
   },
   
   //Public accessors and mutators
   countTokens: function() {
      var tokenCount = 0;
      while( this.hasMoreTokens() ){
         tokenCount++;
         this.nextToken();
      }; 
      return tokenCount;
   },
   
   hasMoreTokens: function(){
      return this.moreTokens;
   },
   
   nextToken: function( delimeters ){
      var start, token, tokenlength;

      if (arguments.length >= 1) {
         this.delimiters = delimiters;
      }

      // Remember the starting position
      start = this.current;

      // Find the next delimiter
      while(( this.current < this.s.length ) && ( this.options.delimiters.indexOf( this.s.charAt( this.current ) ) < 0)) {
         this.current++;
      }

      if( this.current == start )
         this.current++;
      tokenlength = this.current - start;

      // Extract the token
      //
      token = this.s.substr( start, tokenlength );

      // Handle trailing delimiters if returnTokens is false
      if( !this.returnTokens ) {
         while(( this.current < this.s.length ) && ( this.options.delimiters.indexOf( this.s.charAt( this.current ) ) >= 0)) {
            this.current++;
         }
      }

      // Check to see if there are more tokens
      if (this.current >= this.s.length)
         this.moreTokens = false;

      return token;
   }
   
});
/*
Name: 
   - TimeOutBehaviour

Description: 
   - Throws a TimeOutException when the timer isn't stopped within the the specified time interval.

Requires:

Provides:
   - TimeOutBehaviour

Part of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. 
http://www.processpuzzle.com

Authors: 
   - Zsolt Zsuffa

Copyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the 
GNU General Public License as published by the Free Software Foundation, either version 3 of the License, 
or (at your option) any later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */



var TimeOutBehaviour = new Class({
   Implements : [Options],
   options : {
      delay : 200,
      maxTries : 20
   },

   // Constructor
   initialize : function( options ) {
      this.setOptions( options );
      this.checkedProcessName;
      this.numberOfTries;
      this.timer;
   },

   // Public accessors and mutators
   checkTimeOut : function() {
      this.numberOfTries++;
      if (this.numberOfTries >= this.options.maxTries) {
         clearInterval( this.timer );
         this.timeOut( new TimeOutException( this.options.componentName, this.checkedProcessName ));
      }
   },

   startTimeOutTimer : function( processName ) {
      this.checkedProcessName = processName;
      this.numberOfTries = 0;
      this.timer = this.checkTimeOut.periodical( this.options.delay );
   },

   stopTimeOutTimer : function() {
      clearInterval( this.timer );
   },
   
   //Properties
   
   //Protected, private helper methods
});
/*
Name: TimeOutException

Description: Thrown when the specified component's configuration or other process timed out.

Requires: WebUIException

Provides: TimeOutException

Part of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. 
http://www.processpuzzle.com

Authors: 
	- Zsolt Zsuffa

Copyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the 
GNU General Public License as published by the Free Software Foundation, either version 3 of the License, 
or (at your option) any later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/



var TimeOutException = new Class({
   Extends: WebUIException,
   options: {
      description: "Executing the '{componentName}' element's '{processName}' timed out. See the stack trace for the root cause.",
      name: "TimeoutException"
   },
   
   //Constructor
   initialize : function( componentName, processName, options ){
      this.parent( options );
      this.parameters = { componentName : componentName, processName : processName };
      this.componentName = componentName;
      this.processName = processName;
   },
   
   //Properties
   getComponentName: function() { return this.componentName; },
   getProcessName: function() { return this.processName; },
});
/*
Name: UndefinedXmlResourceException

Description: 

Requires:

Provides:

Part of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. 
http://www.processpuzzle.com

Authors: 
	- Zsolt Zsuffa

Copyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the 
GNU General Public License as published by the Free Software Foundation, either version 3 of the License, 
or (at your option) any later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/




var UndefinedXmlResourceException = new Class({
   Extends: WebUIException,
   options: {
      description: "Given xml resource: '{resourceName}' doesn't exist or can't be accessed.",
      name: "UndefinedXmlResourceException"
   },
   
   //Constructor
   initialize : function( resourceName, options ){
      this.parent( options );
      this.parameters = { resourceName : resourceName };
   }	
});
/*
Name: 
    - UniqueId

Description: 
    - Generates a unique identifier. 

Requires:
    - 
    
Provides:
    - UniqueId

Part of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. 
http://www.processpuzzle.com

Authors: 
    - Zsolt Zsuffa

Copyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the 
GNU General Public License as published by the Free Software Foundation, either version 3 of the License, 
or (at your option) any later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/



var lastUniqueIdentifier = 0;

var UniqueId = new Class({
   initialize: function( prefix ){
      this.prefix = typeOf( prefix ) == 'string' ? prefix : "";
   },
   
   generate: function(){
      lastUniqueIdentifier++;
      return this.prefix + lastUniqueIdentifier.toString( 16 - this.prefix.length );
   }
});

UniqueId.generate = function( prefix ){
   var generator = new UniqueId( prefix );
   return generator.generate();
};
/*
Name: XPathSelectionException

Description: Thrown when an XPath selector did not resulted in any element.

Requires: WebUIException

Provides: XPathSelectionException

Part of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. 
http://www.processpuzzle.com

Authors: 
	- Zsolt Zsuffa

Copyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the 
GNU General Public License as published by the Free Software Foundation, either version 3 of the License, 
or (at your option) any later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/




var XPathSelectionException = new Class({
   Extends: WebUIException,
   options: {
      description: "XPath selector: '{selector}' didn't resulted any element of XML: '{xmlResourceUri}'.",
      name: "XPathSelectionException"
   },
   
   //Constructor
   initialize : function( selector, xmlResourceUri, options ){
      this.parent( options );
      this.parameters = { selector : selector, xmlResourceUri : xmlResourceUri };
   }	
});
/*
Name: XmlResource

Description: 

Requires:

Provides:

Part of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. 
http://www.processpuzzle.com

Authors: 
	- Zsolt Zsuffa

Copyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the 
GNU General Public License as published by the Free Software Foundation, either version 3 of the License, 
or (at your option) any later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/



var XmlResource = new Class({
   Extends: Request,

   options: {
      applyCacheBuster : true,
      nameSpaces: "xmlns:pp='http://www.processpuzzle.com'",
      onComplete: function( responseAsText ) { 
         if( responseAsText ) {
            this.xmlAsText = responseAsText;
            
            if( this.options.parseOnComplete ) {
               this.xmlDoc = Sarissa.getDomDocument();
               var domParser = new DOMParser(); 
               this.xmlDoc = domParser.parseFromString( responseAsText, "text/xml" );
            }
         }
      },
      
      onException : function( headerName, value ) {
         //console.log( "Request header failed: '" + value + "'" );
      },
      
      onFailure : function( xhr ) {
         //console.log( "Request failed. status: '" + xhr.status + "'" );
      },
      
      parseOnComplete : true
   },
   
   // Constructor
   initialize: function ( uri, options ) {
      // parameter assertions
      assertThat( uri, not( nil() ));
      assertThat( Sarissa.XPATH_INITIALIZED, is( true ));
      
      if( this.options.applyCacheBuster ) {
         this.resourceUri = new ResourceUri( uri, null, { applyCacheBuster : true });
         uri = this.resourceUri.getUri();
      }
      
      this.parent( options );
      this.options.url = uri;
      this.options.method = 'get';
      this.options.async = false;
      this.xmlAsText = null;
      this.xmlDoc = null;
      
      //this.checkBrowserCompatibility();
      this.refreshResource();
      
      //console.log('XmlResource is initialized.');
   },
   
   // Public accessor and mutator methods
   createElement : function( tagName, properties ){
      var newXmlElement = this.xmlDoc.createElement( tagName );
      if( properties && properties['text'] ) newXmlElement.appendChild( this.xmlDoc.createTextNode( properties['text'] ) );
      return newXmlElement;
   },
   
   determineAttributeValue : function( xmlElement, attributeName ) {
      return XmlResource.determineAttributeValue( xmlElement, attributeName );
   },
   
   determineNodeText : function( xmlElement ) {
      return XmlResource.determineNodeText( xmlElement );
   },
   
   injectElement : function( elementToInject, contextSelector, position ){
      assertThat( elementToInject, not( nil() ));
      assertThat( contextSelector, not( nil() ));
      
      var contextElement = this.selectNode( contextSelector );
      if( !contextElement ) throw new XPathSelectionException( contextSelector, this.options.url );
      
      contextElement.appendChild( elementToInject );
   },
   
   isSuccess: function() { // Determines if an XMLHttpRequest was successful or not
       try {
           // IE error sometimes returns 1223 when it should be 204 so treat it as success, see #1450
           return !this.status && location.protocol === "file:" ||
               // Opera returns 0 when status is 304
               ( this.status >= 200 && this.status < 300 ) ||
               this.status === 304 || this.status === 1223 || this.status === 0;
       } catch(e) {}

       return false;
   },
   
   release : function(){
      this.xmlDoc = null;
   },
   
   selectNode : function( selector, subNode ) {
      var selectedNodes = this.selectNodes( selector, subNode );
      if( selectedNodes )  return selectedNodes[0];
      else return null;
   }, 
   
   selectNodes : function( selector, subNode ) {
      var subjectNode = subNode != null ? subNode : this.xmlDoc;
      
      var foundXmlNodes = null;
      try {
         foundXmlNodes = subjectNode.selectNodes( selector );
         if( typeOf( foundXmlNodes ) == 'collection' ){
            foundXmlNodes =  Array.from( foundXmlNodes );
         }
      }catch(e) {
         //console.log( e );
         //console.log( "Namespaces: " + subjectNode.getProperty( "SelectionNamespaces" ));
         return null;
      }
      return foundXmlNodes;
   },
   
   selectNodeText : function( selector, subNode, defaultValue ) {
      var selectedElements = this.selectNodes( selector, subNode );
      if( selectedElements && selectedElements.length > 0 && selectedElements[0] ) {
         return XmlResource.determineNodeText( selectedElements[0] );
      }else if( defaultValue ) return defaultValue;
      else return null;
   }, 
   
   refreshResource: function(){
      try {
         this.send( this.options.url );
      }catch( e ){
         throw new UndefinedXmlResourceException( this.options.url );
      }
      
      if( this.options.parseOnComplete && this.xmlDoc == null )
         throw new UndefinedXmlResourceException( this.options.url );
      
      if( this.xmlDoc ) {
         this.xmlDoc.setProperty("SelectionNamespaces", "xmlns:xsl='http://www.w3.org/1999/XSL/Transform'  " + this.options.nameSpaces ); 
         this.xmlDoc.setProperty("SelectionLanguage", "XPath");
      }
   },
   
   transform: function( xslt ){},
   
   // Properties
   getDocument: function() { return this.xmlDoc; },
   getUri: function() { return this.options.url; },
   getXmlAsText: function() { return this.xmlAsText; },
   isAsync: function() { return this.options.async; }
   
   //Private helper methods
});

//Static methods
XmlResource.determineAttributeValue = function( xmlElement, attributeName, defaultValue ) {
   var attributeElement = xmlElement.selectNodes( "@" + attributeName );
   if( attributeElement && attributeElement.length == 1 ) return attributeElement[0].nodeValue;
   else if( defaultValue ) return defaultValue;
   else return null;
};

XmlResource.determineNodeText = function( xmlElement, defaultValue ) {
   var nodeText = null;
   if( xmlElement ) {
      nodeText = Sarissa.getText( xmlElement );
      if( !nodeText ) nodeText = defaultValue;
   }
   
   return nodeText;
};

XmlResource.selectNode = function( selector, xmlElement ){
   var selectedNodes = XmlResource.selectNodes( selector, xmlElement );
   if( selectedNodes )  return selectedNodes[0];
   else return null;
};

XmlResource.selectNodes = function( selector, xmlElement ){
	var selectedElements = null;
	try{
		selectedElements = xmlElement.selectNodes( selector );
		if( typeOf( selectedElements ) == 'collection' ){
		   selectedElements = Array.from( selectedElements );
		}
	}catch( e ){
		log4javascript.getDefaultLogger().debug( "Selector: '" + selector + "' caused excection: " + e.message );
		return null;
	}
	return selectedElements;
};

XmlResource.selectNodeText = function( selector, xmlElement, nameSpaces, defaultValue ) {
   var selectedElement = XmlResource.selectNode( selector, xmlElement, nameSpaces );
   if( !selectedElement && defaultValue ) return defaultValue;
   else return XmlResource.determineNodeText( selectedElement, defaultValue );
};

function TransformXML( xmlFileName, xslFileName ) {
   var xml = new XmlResource( xmlFileName );
   var xsl = new XmlResource( xslFileName );
   var resultXml = XMLDocument();
   xml.transformNodeToObject(xsl,resultXml);
   return resultXml;
}

function XMLTransformator( xmlFileName, xslFileName ) {
   var sourceXML = new XML();
   sourceXML.load(  xmlFileName );
   
   var xslt = new XSLT( xslFileName );
   
   var resultXML = new XML();
   
   this.getSourceXML = function() { return sourceXML; };
   this.getResultXML = function() { return resultXML; };
   this.transform = _Transform;
   
   function _Transform() {
      resultXML = new XML( xslt.transform( sourceXML ));
      return resultXML.getDOM();
   }
}

function RemoveWhitespaceNodesFromXML( xml ) {
   var notWhitespace = /\S/;
   for( var i=0; i < xml.childNodes.length; i++ ) {
      if(xml.childNodes[i].nodeType == 3 && !notWhitespace.test(xml.childNodes[i].nodeValue)) {
         xml.removeChild(xml.childNodes[i]);
         i--;
      } else RemoveWhitespaceNodesFromXML(xml.childNodes[i]);
   }
}

XmlResource.Positions = {
      Before : 0,
      After : 1,
      FirstChild : 2,
      LastChild : 3,
      Undefined : 4 };
/*
---

name: Class.Singleton

description: Beautiful Singleton Implementation that is per-context or per-object/element

authors: Christoph Pojer (@cpojer)

license: MIT-style license.

requires: [Core/Class]

provides: Class.Singleton

...
*/




(function(){

var storage = {

   storage: {},

   destroy: function( key, value ){
      this.storage[key] = null;
   },
   
   store: function(key, value){
      this.storage[key] = value;
   },

   retrieve: function(key){
      return this.storage[key] || null;
   }

};

Class.Singleton = function(){
   this.$className = String.uniqueID();
};

Class.Singleton.prototype.check = function(item){
   if (!item) item = storage;

   var instance = item.retrieve('single:' + this.$className);
   if (!instance) item.store('single:' + this.$className, this);

   return instance;
};

Class.Singleton.prototype.destroyInstance = function(item){
	if (!item) item = storage;

	var instance = item.retrieve( 'single:' + this.$className );
	if( instance ) item.destroy( 'single:' + this.$className, this );
};

var gIO = function(klass){

   var name = klass.prototype.$className;

   return name ? this.retrieve('single:' + name) : null;

};

if (('Element' in this) && Element.implement) Element.implement({getInstanceOf: gIO});

Class.getInstanceOf = gIO.bind(storage);

}).call(this);
/*
ProcessPuzzle User Interface
Backend agnostic, desktop like configurable, browser font-end based on MochaUI.
Copyright (C) 2011  Joe Kueser, Zsolt Zsuffa

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/





var WebUILogger = new Class({
   Implements: [Class.Singleton, Options],
   options: {
      defaultLoggerName : "WebUI"
   },

   initialize: function( webUIConfiguration, options ) { return this.check() || this.setUp( webUIConfiguration, options ); },

   setUp : function( webUIConfiguration, options ) {
      this.appenders = new HashMap();
      this.defaultLogger = null;
      this.layouts = new HashMap();
      this.loggers = new HashMap();
      this.loggerIsConfigured = false;
      
      if( webUIConfiguration ) this.configure( webUIConfiguration );
      else this.configureDefaultLogger();
   },
   
   //Public accessors and mutators
   configure : function( webUIConfiguration ) {
      for( i = 0; i < webUIConfiguration.getLoggingLayoutElements().length; i++ ) {
         var layoutName = webUIConfiguration.getLoggingLayoutName( i );
         var layout = this.configureLayout( layoutName, webUIConfiguration );
         this.layouts.put( layoutName, layout );
      }
      
      for( i = 0; i < webUIConfiguration.getLoggingAppenderElements().length; i++ ) {
         var appenderName = webUIConfiguration.getLoggingAppenderName( i );
         var appender = this.configureAppender( appenderName, webUIConfiguration );
         this.appenders.put( appenderName, appender );
      }
      
      for( i = 0; i < webUIConfiguration.getLoggerElements().length; i++ ) {
         var loggerName = webUIConfiguration.getLoggerName( i );
         var logger = this.configureLogger( loggerName, webUIConfiguration );
         this.loggers.put( loggerName, logger );
      }
      
      this.determineDefaultLogger();
      this.loggerIsConfigured = true;
   },
   
   configureDefaultLogger: function(){
   	this.defaultLogger = log4javascript.getDefaultLogger();
   },
   
   debug : function( logMessage ) { this.log( WebUILogger.DEBUG, logMessage ); },
   error : function( logMessage ) { this.log( WebUILogger.ERROR, logMessage ); },
   fatal : function( logMessage ) { this.log( WebUILogger.FATAL, logMessage ); },
   group : function( groupName, initiallyExpanded ) { 
      this.defaultLogger.group( groupName, initiallyExpanded );
   },
   
   groupEnd : function() { 
      this.defaultLogger.groupEnd();
   },
   
   info : function( logMessage ) { this.log( WebUILogger.INFO, logMessage ); },
   
   log : function( logLevel, logMessage ){
      if( !this.logLevelIsValid( logLevel ) ) 
         throw new IllegalArgumentException( "logLevel", logLevel );
      this.defaultLogger.log( logLevel, logMessage );
   },
   
   tearDown : function() {
      var loggerIterator = this.loggers.iterator();
      while( loggerIterator.hasNext() ){
         var aLogger = loggerIterator.next().getValue();
         aLogger.removeAllAppenders();
      }
      
      this.layouts.clear();
      this.appenders.clear();
      this.loggers.clear();
      
      this.loggerIsConfigured = false;
   },
   
   trace : function( logMessage ) { this.log( WebUILogger.TRACE, logMessage ); },
   warn : function( logMessage ) { this.log( WebUILogger.WARN, logMessage ); },
   
   //Properties
   getAppender : function( appenderName ) { return this.appenders.get( appenderName ); },
   getAppenders : function() { return this.appenders; },
   getDefaultLogger : function() { return this.defaultLogger; },
   getLayout : function( layoutName ) { return this.layouts.get( layoutName ); },
   getLayouts : function() { return this.layouts; },
   getLevel : function() { return this.defaultLogger.getLevel(); },
   getLogger : function( loggerName ) { return this.loggers.get( loggerName ); },
   getLoggers : function() { return this.loggers; },
   getName : function() { return this.options.defaultLoggerName;},
   isConfigured : function() { return this.loggerIsConfigured; },
   
   //Private helper methods
   configureAppender : function( appenderName, webUIConfiguration ){
      var appender = null;
      var lazyInit = webUIConfiguration.getLoggingAppenderLazyInit( appenderName );
      var height = webUIConfiguration.getLoggingAppenderHeight( appenderName );
      var initiallyMinimized = webUIConfiguration.getLoggingAppenderInitiallyMinimized( appenderName );
      var useDocumentWrite = webUIConfiguration.getLoggingAppenderUseDocumentWrite( appenderName );
      var width = webUIConfiguration.getLoggingAppenderWidth( appenderName );
      
      switch( webUIConfiguration.getLoggingAppenderType( appenderName ).toUpperCase() ){
      case "WUI:ALERTAPPENDER": 
         appender = new log4javascript.AlertAppender(); 
         break;
      case "WUI:AJAXAPPENDER": 
         var url = webUIConfiguration.getLoggingAppenderURL( appenderName );
         appender = new log4javascript.AjaxAppender( url );
         break;
      case "WUI:BROWSERCONSOLEAPPENDER": 
         appender = new log4javascript.BrowserConsoleAppender(); 
         break;
      case "WUI:INPAGEAPPENDER": 
         var containerElementId = webUIConfiguration.getLoggingAppenderContainerElementId( appenderName );
         appender = new log4javascript.InPageAppender( containerElementId, lazyInit, initiallyMinimized, useDocumentWrite, width, height ); 
         break;
      case "WUI:POPUPAPPENDER": 
         var lazyInit = webUIConfiguration.getLoggingAppenderLazyInit( appenderName );
         var initiallyMinimized = webUIConfiguration.getLoggingAppenderInitiallyMinimized( appenderName );
         var useDocumentWrite = webUIConfiguration.getLoggingAppenderUseDocumentWrite( appenderName );
         var width = webUIConfiguration.getLoggingAppenderWidth( appenderName );
         var height = webUIConfiguration.getLoggingAppenderHeight( appenderName );
         appender = new log4javascript.PopUpAppender( lazyInit, initiallyMinimized, useDocumentWrite, width, height ); 
         break;
      default: appender = new log4javascript.PopUpAppender();
      };
      
      if( this.logLevelValueIsValid( webUIConfiguration.getLoggingAppenderThreshold( appenderName )))
         appender.setThreshold( this.parseLevel( webUIConfiguration.getLoggingAppenderThreshold( appenderName )));
      
      var layout = this.layouts.get( webUIConfiguration.getLoggingAppenderLayoutReference( appenderName ));
      appender.setLayout( layout );

      return appender;
   }.protect(),
   
   configureLayout : function( layoutName, webUIConfiguration ) {
      var layoutPattern = webUIConfiguration.getLoggingLayoutPattern( layoutName );
      var layout = new log4javascript.PatternLayout( layoutPattern );
      
      return layout;
   }.protect(),
   
   configureLogger : function( loggerName, webUIConfiguration ){
      var logger = log4javascript.getLogger( loggerName );
      logger.setLevel( this.parseLevel( webUIConfiguration.getLoggerLevel( loggerName )));
      var referencedAppender = this.appenders.get( webUIConfiguration.getLoggingLoggerAppenderReference( loggerName ));
      logger.addAppender( referencedAppender );

      if( webUIConfiguration.getLoggingLoggerIsDefault( loggerName )){
         this.options.defaultLoggerName = loggerName;
      }
      
      return logger;
   }.protect(),
   
   determineDefaultLogger : function() {
      if( this.defaultLogger == null ) this.defaultLogger = this.getLogger( this.options.defaultLoggerName );
   }.protect(),
   
   logLevelIsValid : function( logLevel ){
      switch( logLevel ){
      case log4javascript.Level.ALL: return true;
      case log4javascript.Level.TRACE: return true;
      case log4javascript.Level.DEBUG: return true;
      case log4javascript.Level.INFO: return true;
      case log4javascript.Level.WARN: return true;
      case log4javascript.Level.ERROR: return true;
      case log4javascript.Level.FATAL: return true;
      case log4javascript.Level.NONE: return true;
      default: return false;
   };
   }.protect(),
   
   logLevelValueIsValid : function( logLevelValue ){
      if( this.parseLevel( logLevelValue ) != null ) return true;
      else return false;
   }.protect(),
   
   parseLevel : function( levelString ){
      if( typeOf( levelString ) != 'string' ) return null;
      
      switch( levelString.toUpperCase() ){
         case "ALL": return log4javascript.Level.ALL;
         case "TRACE": return log4javascript.Level.TRACE;
         case "DEBUG": return log4javascript.Level.DEBUG;
         case "INFO": return log4javascript.Level.INFO;
         case "WARN": return log4javascript.Level.WARN;
         case "ERROR": return log4javascript.Level.ERROR;
         case "FATAL": return log4javascript.Level.FATAL;
         case "NONE": return log4javascript.Level.NONE;
         default: return null;
      };
   }.protect()
});

WebUILogger.ALL = log4javascript.Level.ALL;
WebUILogger.TRACE = log4javascript.Level.TRACE;
WebUILogger.DEBUG = log4javascript.Level.DEBUG;
WebUILogger.INFO = log4javascript.Level.INFO;
WebUILogger.WARN = log4javascript.Level.WARN;
WebUILogger.ERROR = log4javascript.Level.ERROR;
WebUILogger.FATAL = log4javascript.Level.FATAL;
WebUILogger.NONE = log4javascript.Level.NONE;
/*
ProcessPuzzle User Interface
Backend agnostic, desktop like configurable, browser font-end based on MochaUI.
Copyright (C) 2011  Joe Kueser, Zsolt Zsuffa

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/





var WebUIMessageBus = new Class({
   Implements: [Class.Singleton, Options],
   options: {
      message: "hello"
   },

   //Constructors
   initialize: function( options ) { return this.check() || this.setUp( options ); },
   setUp : function( options ){
      this.setOptions( options );
      this.lastMessage = null;
      this.subscribersToMessages = new HashMap();
   }.protect(),
   
   //Public accessor and mutator methods
   notifySubscribers: function( message ){
      this.lastMessage = message;
      
      var messageClass = message.getClass();
      var subscribersToMessage = this.getSubscribersToMessage( messageClass );
      if( subscribersToMessage && subscribersToMessage.size() > 0 ){
         var largestIndex;
         subscribersToMessage.each( function( callBack, index ){
            callBack( message );
            largestIndex = index;
         }, this );
         return largestIndex;
      }else return null;
   },
   
   subscribeToMessage: function( messageClass, callBack ){
      var subscribersToMessage = this.getSubscribersToMessage( messageClass );
      if( subscribersToMessage == null ) subscribersToMessage = new ArrayList();
      subscribersToMessage.add( callBack );
      this.subscribersToMessages.put( messageClass.prototype.options.name, subscribersToMessage );
   },
   
   writeOffFromMessage: function( messageClass, callBack ){
      var subscribersToMessage = this.getSubscribersToMessage( messageClass );
      if( subscribersToMessage == null ) return;
      
      subscribersToMessage.remove( subscribersToMessage.indexOf( callBack ));
   },
   
   tearDown: function() {
      this.subscribersToMessages.clear();
   },
   
   //Properties
   getLastMessage: function() { return this.lastMessage; },
   getMessageListSize: function() { return this.subscribersToMessages.size(); },
   getSubscribersToMessage: function( messageClass ) { return this.subscribersToMessages.get( messageClass.prototype.options.name ); }
   
   //Private helper methods
});
/*
Name: 
    - AbstractDocument

Description: 
    - Represents any kind of content can be displayed in a panel content area. Defines, implements the common properties of PlainHtmlDocument, SmartDocument.

Requires:
    - 
Provides:
    - AbstractDocument

Part of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. 
http://www.processpuzzle.com

Authors: 
    - Zsolt Zsuffa

Copyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the 
GNU General Public License as published by the Free Software Foundation, either version 3 of the License, 
or (at your option) any later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/






var AbstractDocument = new Class({
   Implements: [Events, Options],
   Binds: ['attachEditor',
           'detachEditor',
           'determineContainerElement',
           'finalizeConstruction', 
           'finalizeDestruction',
           'instantiateEditor',
           'loadDocumentContent',
           'loadResources', 
           'onConstructionError', 
           'onContainerResize',
           'onDocumentError', 
           'onDocumentReady', 
           'onEditorAttached',
           'onResourceError', 
           'onResourcesLoaded', 
           'releaseResources',
           'resetProperties',
           'subscribeToWebUIMessages', 
           'webUIMessageHandler'],
   
   options: {
      componentName : "AbstractDocument",
      contentUriSelector : "contentUri",
      descriptionSelector : "description",
      documentContainerId : "DocumentContainer",
      documentContentExtension : ".xml",
      documentContentUri : null,
      documentContentNameSpace : "xmlns:pp='http://www.processpuzzle.com'",
      documentDefinitionNameSpace: "xmlns:sd='http://www.processpuzzle.com/SmartDocument'",
      documentDefinitionUri : null,
      documentDefinitionUriSelector: "@documentDefinition",
      documentEditorClass : "DocumentEditor",
      documentVariables : null,
      eventFireDelay : 5,
      handleMenuSelectedEventsDefault : false,
      handleMenuSelectedEventsSelector : "handleMenuSelectedEvents",
      nameSelector : "name",
      resourcesSelector : "resources",
      rootElementName : "/smartDocumentDefinition",
      versionSelector : "version"
   },
   
   //Constructor
   initialize: function( i18Resource, options ){
      this.setOptions( options );
      this.constructionChain = new Chain();
      this.containerElement;
      this.contentUri;
      this.description;
      this.destructionChain = new Chain();
      this.documentContent;
      this.documentDefinition;
      this.documentDefinitionUri;
      this.editor;
      this.error;
      this.handleMenuSelectedEvents;
      this.htmlElementFactory;
      this.i18Resource = i18Resource;
      this.logger = Class.getInstanceOf( WebUILogger );
      this.messageBus = Class.getInstanceOf( WebUIMessageBus );
      this.name;
      this.resources;
      this.state = AbstractDocument.States.UNINITIALIZED;
      this.version;
      
      this.loadDocumentDefinition();
      this.loadDocumentContent();
      this.state = AbstractDocument.States.INITIALIZED;
   },
   
   //Public mutators and accessor methods
   construct: function(){
      this.compileConstructionChain();
      this.constructionChain.callChain();
   },
   
   destroy: function(){
      this.compileDestructionChain();
      this.destructionChain.callChain();
   },
   
   onConstructionError: function( error ){
      if( error ) this.error = error;
      this.revertConstruction();
      this.fireEvent( 'documentError', this.error );
   },
   
   onContainerResize: function( newSize ){
      //Abstract method, should be overwritten by subclasses
   },
   
   onDocumentError: function( error ){
      this.error = error;
      this.revertConstruction();
      this.fireEvent( 'documentError', error );
   },
   
   onDocumentReady: function(){
      this.constructionChain.callChain();
   },
   
   onEditorAttached: function(){
      this.constructionChain.callChain();
   },
   
   onResourceError: function( error ){
      this.error = error;
   },
   
   onResourcesLoaded: function(){
      if( this.resources.isSuccess() ) this.constructionChain.callChain();
      else this.onConstructionError();
   },
   
   showNotification: function( notificationText ){
      if( this.state == AbstractDocument.States.CONSTRUCTED ){
         var message = new MenuSelectedMessage({ originator : this.name, activityType : DesktopWindow.Activity.SHOW_NOTIFICATION, notification : notificationText });
         this.messageBus.notifySubscribers( message );
      }
   }, 
   
   showWindow: function( windowName ){
      if( this.state == AbstractDocument.States.CONSTRUCTED ){
         var message = new MenuSelectedMessage({ originator : this.name, activityType : DesktopWindow.Activity.SHOW_WINDOW, windowName : windowName });
         this.messageBus.notifySubscribers( message );
      }
   },
   
   unmarshall: function(){
      this.unmarshallProperties();
      this.unmarshallResources();
      this.state = AbstractDocument.States.UNMARSHALLED;
   },

   webUIMessageHandler: function( webUIMessage ){
      if( this.state != AbstractDocument.States.CONSTRUCTED ) return;
      
      if( instanceOf( webUIMessage, MenuSelectedMessage ) && webUIMessage.getActivityType() == AbstractDocument.Activity.MODIFY_DOCUMENT ) {
         switch( webUIMessage.getActionType() ){
            case AbstractDocument.Action.ADD_IMAGE: this.editor.textAddImage(); break;
            case AbstractDocument.Action.ADD_LINK: this.editor.textAddLink(); break;
            case AbstractDocument.Action.ALIGN_CENTER: this.editor.textAlignCenter(); break;
            case AbstractDocument.Action.ALIGN_LEFT: this.editor.textAlignLeft(); break;
            case AbstractDocument.Action.ALIGN_JUSTIFY: this.editor.textAlignJustify(); break;
            case AbstractDocument.Action.ALIGN_RIGHT: this.editor.textAlignRight(); break;
            case AbstractDocument.Action.BOLD: this.editor.textBold(); break;
            case AbstractDocument.Action.INDENT: this.editor.textIndent(); break;
            case AbstractDocument.Action.ITALIC: this.editor.textItalic(); break;
            case AbstractDocument.Action.ORDERED_LIST: this.editor.textOrderedList(); break;
            case AbstractDocument.Action.OUTDENT: this.editor.textOutdent(); break;
            case AbstractDocument.Action.REDO: this.editor.textRedo(); break;
            case AbstractDocument.Action.REMOVE_LINK: this.editor.textRemoveLink(); break;
            case AbstractDocument.Action.STRIKETHROUGH: this.editor.textStrikethrough(); break;
            case AbstractDocument.Action.TOGGLE_VIEW: this.editor.textToggleView(); break;
            case AbstractDocument.Action.UNDERLINE: this.editor.textUnderline(); break;
            case AbstractDocument.Action.UNDO: this.editor.textUndo(); break;
            case AbstractDocument.Action.UNORDERED_LIST: this.editor.textUnorderedList(); break;
         }
      }
      this.lastHandledMessage = webUIMessage;
   },

   //Properties
   getContainerElement: function() { return this.containerElement; },
   getDescription: function() { return this.description; },
   getDocumentContent: function() { return this.documentContent; },
   getDocumentContentUri: function() { return this.options.documentContentUr; },
   getDocumentDefinition: function() { return this.documentDefinition; },
   getDocumentDefinitionUri: function() { return this.options.documentDefinitionUri; },
   getEditor: function() { return this.editor; },
   getError: function() { return this.error; },
   getHandleMenuSelectedEvents: function() { return this.handleMenuSelectedEvents; },
   getHtmlElementFactory: function() { return this.htmlElementFactory; },
   getLogger: function() { return this.logger; },
   getMessageBus: function() { return this.messageBus; },
   getName: function() { return this.name; },
   getResources: function() { return this.resources; },
   getState: function() { return this.state; },
   getVersion: function() { return this.version; },
   isSuccess: function() { return this.error == null; },
   
   //Protected, private helper methods
   attachEditor: function(){
      this.editor.attach( this.containerElement );
   }.protect(),
   
   compileConstructionChain: function(){
      this.constructionChain.chain( this.determineContainerElement, this.instantiateEditor, this.attachEditor, this.subscribeToWebUIMessages, this.finalizeConstruction );
   }.protect(),
   
   compileDestructionChain: function(){
      this.destructionChain.chain(  this.releseResource, this.detachEditor, this.resetProperties, this.finalizeDestruction );
   }.protect(),
   
   detachEditor: function(){
      if( this.editor ) this.editor.detach();
      this.destructionChain.callChain();
   }.protect(),
   
   determineContainerElement: function(){
      this.containerElement = $( this.options.documentContainerId );
      this.htmlElementFactory = new WidgetElementFactory( this.containerElement, this.i18Resource );
      this.constructionChain.callChain();
   }.protect(),
   
   finalizeConstruction: function(){
      this.state = AbstractDocument.States.CONSTRUCTED;
      this.fireEvent('documentReady', this, this.options.eventFireDelay );
   }.protect(),
   
   finalizeDestruction: function(){
      this.constructionChain.clearChain();
      this.destructionChain.clearChain();
      this.state = AbstractDocument.States.INITIALIZED;
      this.fireEvent('documentDestroyed', this );
   }.protect(),
   
   instantiateEditor: function(){
      var editorClass = eval( this.options.documentEditorClass );
      this.editor = new editorClass( this.i18Resource, { onEditorAttached : this.onEditorAttached } );
      this.constructionChain.callChain();
   }.protect(),
   
   loadDocumentContent: function() {
      if( this.options.documentContentUri ){
         try{
            var resourceUri = new ResourceUri( this.options.documentContentUri, this.i18Resource.getLocale(), { contentType: this.options.documentContentExtension.substring( 1 ) });
            this.documentContent = new XmlResource( resourceUri.determineLocalizedUri() );
         }catch( e ){
            try{
               this.documentContent = new XmlResource( this.options.documentContentUri );
            }catch( e ){
               throw new IllegalArgumentException( 'SmartDocument.options.documentContentUri', this.options.documentContentUri );
            }
         }
      }else {
         this.options.documentContentUri = this.options.documentDefinitionUri.substring( 0, this.options.documentDefinitionUri.lastIndexOf( ".xml" ));
         try{
            this.documentContent = new XmlResource( this.options.documentContentUri + "_" + this.i18Resource.getLocale().getLanguage() + this.options.documentContentExtension );
         }catch( e ){
            this.logger.trace( "Content of " + this.name + " document couldn't be loaded." );
         }
      }
   }.protect(),
   
   loadDocumentDefinition: function() {
      if( this.options.documentDefinitionUri ) this.documentDefinition = new XmlResource( this.options.documentDefinitionUri );
      else throw new IllegalArgumentException( 'SmartDocument.options.documentDefinitionUri', this.options.documentDefinitionUri );
   }.protect(),
   
   loadResources: function(){
      if( this.resources ) this.resources.load();
      else this.constructionChain.callChain();
   }.protect(),
   
   releaseResources : function(){
      if( this.resources ) this.resources.release();
      this.destructionChain.callChain();
   }.protect(),
   
   resetProperties: function(){
      this.description = null;
      this.options.documentContentUri = null;
      this.options.documentDefinitionUri = null;
      this.editor = null;
      this.name = null;
      this.version = null;
      this.destructionChain.callChain();
   }.protect(),
   
   revertConstruction: function(){
      if( this.editor ) this.editor.destroy();
      this.resetProperties();
      this.state = AbstractDocument.States.INITIALIZED;
   }.protect(),
   
   subscribeToWebUIMessages: function() {
      if( this.handleMenuSelectedEvents ){
         this.logger.debug( this.options.componentName + ".subscribeToWebUIMessages() started." );
         this.messageBus.subscribeToMessage( MenuSelectedMessage, this.webUIMessageHandler );
      }
      
      this.constructionChain.callChain();
   }.protect(),
      
   unmarshallProperties: function(){
      this.description = this.documentDefinition.selectNodeText( this.options.rootElementName + "/" + this.options.descriptionSelector );
      this.handleMenuSelectedEvents = parseBoolean( this.documentDefinition.selectNodeText( this.options.rootElementName + "/" + this.options.handleMenuSelectedEventsSelector, null, this.options.handleMenuSelectedEventsDefault ));
      this.name = this.documentDefinition.selectNodeText( this.options.rootElementName + "/" + this.options.nameSelector );
      this.version = this.documentDefinition.selectNodeText( this.options.rootElementName + "/" + this.options.versionSelector );
      this.contentUri = this.documentDefinition.selectNodeText( this.options.rootElementName + "/" + this.options.contentUriSelector );
      //if( !this.options.documentContentUri && this.contentUri ) this.options.documentContentUri = this.contentUri;
   }.protect(),
      
   unmarshallResources: function(){
      var resourcesElement = this.documentDefinition.selectNode( this.options.rootElementName + "/" + this.options.resourcesSelector );
      if( resourcesElement ){
         this.resources = new ResourceManager( resourcesElement, { onResourcesLoaded : this.onResourcesLoaded, onResourceError : this.onResourceError } );
         this.resources.unmarshall();
      }
   }.protect()
});

AbstractDocument.States = { UNINITIALIZED : 0, INITIALIZED : 1, UNMARSHALLED : 2, CONSTRUCTED : 3 };
AbstractDocument.Types = { HTML : 'StaticHtml', SMART : 'SmartDocument', REMOTE_RESOURCE : 'RemoteResource' };
AbstractDocument.Activity = { LOAD_DOCUMENT : 'loadDocument', MODIFY_DOCUMENT : 'modifyDocument' };
AbstractDocument.Action = { 
      BOLD : 'bold', 
      ITALIC : 'italic', 
      UNDERLINE : 'underline', 
      STRIKETHROUGH : 'strikethrough', 
      UNORDERED_LIST : 'unorderedList', 
      ORDERED_LIST : 'orderedList', 
      INDENT : 'indent', 
      OUTDENT : 'outdent', 
      ALIGN_LEFT : 'alignLeft', 
      ALIGN_CENTER : 'alighCenter',
      ALIGN_RIGHT : 'alignRight',
      ALIGN_JUSTIFY : 'alignJustify',
      UNDO : 'undo',
      REDO : 'redo',
      ADD_LINK : 'addLink',
      REMOVE_LINK : 'removeLink',
      ADD_IMAGE : 'addImage',
      TOGGLE_VIEW : 'toggleView' };
//WebUIMessage.js




var WebUIMessage = new Class({
   Implements: Options,
   options: {
      activityType: null,
      actionType: null,
      description: "Generic Browser Interface message. Normally this message should be overwritten by subclasses.",
      isDefault: false,
      messageClass: null,
      messageResource: null,
      name: "WebUIMessage",       //Please note, that subclasses should overwrite this.
      originator: null
   },
   
   //Constructors
   initialize: function( options ){
      this.setOptions( options );
   },
   
   //Public accessor and mutator methods
   destroy: function(){
      this.options.activityType = null;
      this.options.actionType = null;
   },
   
   unmarshall: function(){
      if( this.options.messageResource ){
         this.unmarshallProperties();
      } 
   },
   
   //Properties
   getActionType: function() { return this.options.actionType; },
   getActivityType: function() { return this.options.activityType; },
   getClass: function() { return this.options.messageClass; },
   getDescription: function() { return this.options.description; },
   getMessageProperties: function() { return this.messageProperties },
   getName: function() { return this.options.name; },
   getOptions: function() { return this.options; },
   getOriginator: function() { return this.options.originator; },
   isDefault: function() { return this.options.isDefault; },
   
   //Private helper methods
   unmarshallProperties: function(){
      var messageText = XmlResource.determineNodeText( this.options.messageResource );
      var messageProperties = messageText ? eval( "(" + messageText + ")" ) : {};
      this.setOptions( messageProperties );
   }.protect()
});
/*
Name: 
   - DocumentSelectedMessage

Description: 
   - This message sent out when a document - either SmartDocument, local file or even RemoteDocument is selected.

Requires:
   - WebUIMessage

Provides:
   - DocumentSelectedMessage

Part of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. 
http://www.processpuzzle.com

Authors: 
   - Zsolt Zsuffa

Copyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the 
GNU General Public License as published by the Free Software Foundation, either version 3 of the License, 
or (at your option) any later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/






var DocumentSelectedMessage = new Class({
   Extends: WebUIMessage,
   options: {
      actionType: null,
      activityType: null,
      description: "A message about the event that a SmartDocument of RemoteResource was selected.",
      documentContentURI: null,
      documentType: AbstractDocument.Types.SMART,
      documentURI: null,
      name: "DocumentSelectedMessage",
      notification: null,
      windowName: null
   },
   
   //Constructors
   initialize: function( options ){
      this.setOptions( options );
      this.options.messageClass = DocumentSelectedMessage;
   },
   
   //Public accessors
   
   //Properties
   getActionType: function() { return this.options.actionType; },
   getActivityType: function() { return this.options.activityType; },
   getContextItemId: function() { return this.options.contextItemId; },
   getDocumentContentURI: function() { return this.options.documentContentURI; },
   getDocumentType: function() { return this.options.documentType; },
   getDocumentURI: function() { return this.options.documentURI; },
   getNotification: function() { return this.options.notification; },
   getWindowName: function() { return this.options.windowName; }
});

// BrowserWidget.js

/**
 * ProcessPuzzle User Interface Backend agnostic, desktop like configurable,
 * browser font-end based on MochaUI. Copyright (C) 2011 Zsolt Zsuffa
 * 
 * This program is free software: you can redistribute it and/or modify it under
 * the terms of the GNU General Public License as published by the Free Software
 * Foundation, either version 3 of the License, or (at your option) any later
 * version.
 * 
 * This program is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
 * FOR A PARTICULAR PURPOSE. See the GNU General Public License for more
 * details.
 * 
 * You should have received a copy of the GNU General Public License along with
 * this program. If not, see <http://www.gnu.org/licenses/>.
 */





var BrowserWidget = new Class( {
   Implements : [Events, Options],
   Binds : ['broadcastConstructedMessage', 'destroyChildHtmlElements', 'finalizeConstruction', 'finalizeDestruction', 'webUIMessageHandler'],

   options : {
      componentName : "BrowserWidget",
      dataXmlNameSpace : "xmlns:pp='http://www.processpuzzle.com'",
      definitionXmlNameSpace : "xmlns:pp='http://www.processpuzzle.com'",
      descriptionSelector : "//pp:widgetDefinition/description",
      domDocument : this.document,
      eventDeliveryDelay : 5,
      nameSelector : "//pp:widgetDefinition/name",
      optionsSelector : "//pp:widgetDefinition/options",
      subscribeToWebUIMessages : false,
      useLocalizedData : false,
      widgetContainerId : "widgetContainer",
      widgetDataURI : null,
      widgetDefinitionURI : null,
      widgetVersionSelector : "//pp:widgetDefinition/version"
   },

   // constructor
   initialize : function( options, resourceBundle, elementFactoryOptions ) {
      this.setOptions( options );

      // private instance variables
      this.componentStateManager;
      this.constructionChain = new Chain();
      this.containerElement;
      this.dataXml;
      this.definitionXml;
      this.description;
      this.destructionChain = new Chain();
      this.elementFactory = null;
      this.error;
      this.givenOptions = options;
      this.i18Resource = null;
      this.lastHandledMessage = null;
      this.locale;
      this.logger;
      this.messageBus;
      this.name;
      this.state;
      this.stateSpecification;
      this.widgetVersion;
      this.webUIController = null;

      // initialize object
      this.deduceInitializationArguments( options, resourceBundle );
      this.containerElement = document.id( $( this.options.widgetContainerId ));
      this.configureComponentStateManager();
      this.configureLogger();
      this.configureMessageBus();
      this.loadWidgetDefinition();
      this.loadWidgetData();

      assertThat( this.i18Resource, not( nil() ) );
      if( this.containerElement == null )
         throw new IllegalArgumentException( "Parameter 'widgetContainerId' in invalid." );
      if( !this.i18Resource.isLoaded )
         throw new IllegalArgumentException( "ResourceBundle should be already loaded." );
      
      this.elementFactory = new WidgetElementFactory( this.containerElement, this.i18Resource, elementFactoryOptions );
      this.restoreComponentState();
      this.state = BrowserWidget.States.INITIALIZED;
   },

   // public accessor and mutator methods
   construct : function() {
      if( this.state < BrowserWidget.States.CONSTRUCTED ) {
         this.compileConstructionChain();
         this.constructionChain.callChain();
      }
      return this;
   },

   destroy : function() {
      if( this.state == BrowserWidget.States.CONSTRUCTED ){
         this.compileDestructionChain();
         this.destructionChain.callChain();
      }
   },

   getText : function( key ) {
      var text = null;
      try{
         text = this.i18Resource.getText( key );
      }catch (e){
         text = key;
      }
      return text;
   },
   
   removeChild : function( childElement, parentElement ) {
      var contextElement = parentElement == undefined ? this.containerElement : parentElement;

      if( contextElement != null && childElement != null ){
         contextElement.removeChild( childElement );
      }
   },
   
   restoreComponentState : function() {
      this.stateSpecification = this.componentStateManager.retrieveComponentState( this.options.componentName ); 
      this.parseStateSpecification();
   },
   
   storeComponentState : function() {
      this.compileStateSpecification();
      this.componentStateManager.storeComponentState( this.options.componentName, this.stateSpecification );
   }.protect(),
   
   unmarshall : function(){
      this.unmarshallProperties();
      this.unmarshallOptions();
      this.state = BrowserWidget.States.UNMARSHALLED;
      return this;
   },

   updateText : function( theContainerElement, parentElementId, newTextValue ) {
      var parentElement = theContainerElement.findElementById( theContainerElement, parentElementId );
      parentElement.set( 'text', this.getText( newTextValue ) );
   },

   webUIMessageHandler : function( webUIMessage ) {
      if( webUIMessage.getOriginator() == this.options.componentName ) return;
      if( this.state != BrowserWidget.States.CONSTRUCTED ) throw new UnconfiguredWidgetException( { source : 'BrowserWidget.webUIMessageHandler()'} );
      
      this.lastHandledMessage = webUIMessage;
   },

   // Properties
   getContainerElement : function() { return this.containerElement; },
   getDataXml : function() { return this.dataXml; },
   getDefinitionXml : function() { return this.definitionXml; },
   getDescription: function() { return this.description; },
   getElementFactory : function() { return this.elementFactory; },
   getHtmlDOMDocument : function() { return this.options.domDocument; },
   getLastMessage : function() { return this.lastHandledMessage; },
   getLocale : function() { return this.locale; },
   getLogger : function() { return this.logger; },
   getMessageBus : function() { return this.messageBus; },
   getName: function() { return this.name; },
   getResourceBundle : function() { return this.i18Resource; },
   getState : function() { return this.state; },

   // Private helper methods
   broadcastConstructedMessage: function(){
      var constructedMessage = new WidgetConstuctedMessage({ originator : this.options.componentName });
      this.messageBus.notifySubscribers( constructedMessage );
   }.protect(),
   
   compileConstructionChain: function(){
      this.constructionChain.chain( this.finalizeConstruction );
   }.protect(),
   
   compileDestructionChain: function(){
      this.destructionChain.chain( this.destroyChildHtmlElements, this.finalizeDestruction );
   }.protect(),
   
   compileStateSpecification: function(){
      //Abstract method, should be overwrite!
   }.protect(),
   
   configureComponentStateManager : function() {
      if( this.webUIController == null ) this.componentStateManager = Class.getInstanceOf( ComponentStateManager );
      else this.componentStateManager = this.webUIController.getStateManager();
   }.protect(),

   configureLogger : function() {
      if( this.webUIController == null ){
         this.logger = Class.getInstanceOf( WebUILogger );
         if( this.logger == null )
            this.logger = new WebUILogger();
      }else
         this.logger = this.webUIController.getLogger();
   }.protect(),

   configureMessageBus : function() {
      if( this.webUIController == null ) this.messageBus = Class.getInstanceOf( WebUIMessageBus );
      else this.messageBus = this.webUIController.getMessageBus();

      this.subscribeToWebUIMessages();
   }.protect(),

   deduceInitializationArguments : function( options, resourceBundle ) {
      if( resourceBundle ){
         this.i18Resource = resourceBundle;
         this.locale = resourceBundle.getLocale();
      }else{
         this.webUIController = Class.getInstanceOf( WebUIController );
         this.i18Resource = this.webUIController.getResourceBundle();
         this.locale = this.webUIController.getCurrentLocale();
      }
   }.protect(),
   
   destroyChildHtmlElements : function(){
      this.containerElement = document.id( this.containerElement );
      this.containerElement.getElements( '*' ).each( function( childElement, index ) {
         if( childElement.removeEvents )
            childElement.removeEvents();
         if( childElement.destroy )
            childElement.destroy();
      });
      
      this.destructionChain.callChain();
   }.protect(),

   finalizeConstruction : function(){
      this.logger.trace( this.options.componentName + ".onConstructed() of '" + this.name + "'." );
      this.storeComponentState();
      this.state = BrowserWidget.States.CONSTRUCTED;
      this.constructionChain.clearChain();
      this.broadcastConstructedMessage();
      this.fireEvent( 'constructed', this, this.options.eventDeliveryDelay );
   }.protect(),
   
   finalizeDestruction : function(){
      this.logger.trace( this.options.componentName + ".onDestroyed() of '" + this.name + "'." );
      this.state = BrowserWidget.States.INITIALIZED;
      this.destructionChain.clearChain();
      this.fireEvent( 'destroyed', this, this.options.eventDeliveryDelay );
   }.protect(),

   loadWebUIConfiguration : function() {
      try{
         this.webUIConfiguration = new WebUIConfiguration( this.options.configurationUri );
      }catch (e){
         alert( "Couldn't load Browser Front-End configuration: " + this.options.configurationUri );
      }
   }.protect(),

   loadWidgetData : function() {
      if( this.options.widgetDataURI ){
         try{
            var dataUri = this.options.useLocalizedData ? new ResourceUri( this.options.widgetDataURI, this.locale ).determineLocalizedUri() : this.options.widgetDataURI;
            this.dataXml = new XmlResource( dataUri, {
               nameSpaces : this.options.dataXmlNameSpace} );
         }catch (e){
            this.logger.debug( "Widget data: '" + this.options.widgetDataURI + "' not found." );
         }
      }
   }.protect(),

   loadWidgetDefinition : function() {
      if( this.options.widgetDefinitionURI ){
         try{
            this.definitionXml = new XmlResource( this.options.widgetDefinitionURI, {
               nameSpaces : this.options.definitionXmlNameSpace} );
         }catch (e){
            this.logger.debug( "Widget definition: '" + this.options.widgetDefinitionURI + "' not found." );
         }
      }
   }.protect(),
   
   parseStateSpecification: function(){
      //Abstract method, should be overwrite!
   }.protect(),
   
   revertConstruction : function(){
      this.fireEvent( 'constructionError', this.error );
   }.protect(),

   subscribeToWebUIMessages : function() {
      if( this.options.subscribeToWebUIMessages ){
         this.options.subscribeToWebUIMessages.each( function( messageClass, index ) {
            this.messageBus.subscribeToMessage( messageClass, this.webUIMessageHandler );
         }, this );
      }
   }.protect(),
   
   unmarshallOptions: function(){
      if( this.definitionXml ){
         var widgetOptionsElement = this.definitionXml.selectNode( this.options.optionsSelector );
         if( widgetOptionsElement ){
            var widgetOptionsResource = new OptionsResource( widgetOptionsElement );
            widgetOptionsResource.unmarshall();
            this.setOptions( widgetOptionsResource.getOptions() );
         }
         
         this.setOptions( this.givenOptions );
      }
   }.protect(),

   unmarshallProperties: function(){
      if( this.definitionXml ){
         this.description = this.definitionXml.selectNodeText( this.options.descriptionSelector );
         this.name = this.definitionXml.selectNodeText( this.options.nameSelector );
      }
   }.protect(),
   
   writeOffFromWebUIMessages : function(){
      if( this.options.subscribeToWebUIMessages ){
         this.options.subscribeToWebUIMessages.each( function( messageClass, index ) {
            this.messageBus.writeOffFromMessage( messageClass, this.webUIMessageHandler );
         }, this );
      }
   }
});

BrowserWidget.States = { UNINITIALIZED : 0, INITIALIZED : 1, UNMARSHALLED : 2, CONSTRUCTED : 3 };
//UnconfiguredWidget.js




var UnconfiguredWidgetException = new Class({
   Extends: WebUIException,
   options: {
      description: "Browser Widget is unconfigured therefore the requested operation can't be carried out.",
      name: "UnconfiguredWidgetException"
   },
   
   //Constructor
   initialize : function( options ){
      this.setOptions( options );
      this.parent( options );
   }
});
/*
Name: 
   - WidgetConstructedMessage

Description: 
   - This message sent out when a widget is constructed.

Requires:
   - WebUIMessage

Provides:
   - WidgettedMessage

Part of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. 
http://www.processpuzzle.com

Authors: 
   - Zsolt Zsuffa

Copyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the 
GNU General Public License as published by the Free Software Foundation, either version 3 of the License, 
or (at your option) any later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/






var WidgetConstuctedMessage = new Class({
   Extends: WebUIMessage,
   options: {
      actionType: null,
      activityType: null,
      description: "New widget was constructed.",
      name: "WidgetConstructedMessage",
      notification: null,
      windowName: null
   },
   
   //Constructors
   initialize: function( options ){
      this.setOptions( options );
      this.options.messageClass = WidgetConstuctedMessage;
   },
   
   //Public accessors
   
   //Properties
   getActionType: function() { return this.options.actionType; },
   getActivityType: function() { return this.options.activityType; },
   getContextItemId: function() { return this.options.contextItemId; },
   getNotification: function() { return this.options.notification; },
   getWindowName: function() { return this.options.windowName; }
});

/*
Name: WidgetConstructionException

Description: Thrown when constructing a BrowserWidget caused error.

Requires: WebUIException

Provides: WidgetConstructionException

Part of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. 
http://www.processpuzzle.com

Authors: 
	- Zsolt Zsuffa

Copyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the 
GNU General Public License as published by the Free Software Foundation, either version 3 of the License, 
or (at your option) any later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/




var WidgetConstructionException = new Class({
   Extends: WebUIException,
   options: {
      description: "Constructing widget: '{widgetName}' caused the following error: '{configurationErrorDescription}'.",
      name: "WidgetConstructionException"
   },
   
   //Constructor
   initialize : function( widgetName, configurationErrorDescription, options ){
      this.parent( options );
      this.parameters = { widgetName : widgetName, configurationErrorDescription : configurationErrorDescription };
   },
   
   //Properties
   getConfigurationErrorDescription : function() { return this.parameters['ConfigurationErrorDescription']; },
   getWidgetName : function() { return this.parameters['widgetName']; },
});
/*
Name: 
    - HtmlElementFactory

Description: 
    - Instantiates a new HTML element with given properties and appends to the element hierarchy. 

Requires:
    - 
    
Provides:
    - HtmlElementFactory

Part of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. 
http://www.processpuzzle.com

Authors: 
    - Zsolt Zsuffa

Copyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the 
GNU General Public License as published by the Free Software Foundation, either version 3 of the License, 
or (at your option) any later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/



var WidgetElementFactory = new Class({
   Implements : Options,
   
   options : {
      appendByDefault : true,
      buttonClassName : "buttonSmall", 
      defaultPosition : 3,
      formFieldsContainerClassName : "editableContainer",
      fieldSetImageAlt : "Show/Hide",
      fieldSetImageSource : "Images/expver.png",
      fieldSetImageStyle : { 'cursor' : 'pointer' },
      fieldSetImageTitle : "Show/Hide",
      fieldSetStyle : { 'border-color' : '#336699', 'width' : '100%' },
      labelClassName : "label",
      readOnlyContainerClassName : "readOnlyContainer",
      rowClassName : "row",
      valueClassName : "formw"
   },

   // Constructor
   initialize : function( containerElement, i18Resource, options ) {
      assertThat( containerElement, not( nil() ) );
      assertThat( i18Resource, not( nil() ) );
      this.setOptions( options );

      this.containerElement = containerElement;
      this.i18Resource = i18Resource;
   },

   // Public accessors and mutator methods
   create : function( tagName, nodeText, contextElement, position, properties ) {
      var newElement = new Element( tagName, properties );
      if( nodeText )
         newElement.appendText( this.i18Resource.getText( nodeText ) );
      if( contextElement || this.options.appendByDefault )
         this.appendElement( newElement, contextElement, position );
      return newElement;
   },

   createAnchor : function( nodeText, anchorLink, clickEventHandler, contextElement, position, elementProperties ) {
      var defaultProperties;
      var anchorUri = anchorLink ? new ResourceUri( anchorLink ) : null;
      
      if( clickEventHandler ){
         defaultProperties = { href : "#", events : { click : clickEventHandler } };
      }else if( anchorUri && anchorUri.isLocal() ){
         if( anchorUri.getDocumentType() == AbstractDocument.Types.SMART ){
            var onClickCommand = "top.webUIController.loadSmartDocument('" + anchorUri.getUri()  + "'";
            onClickCommand += anchorUri.getDocumentContentUri() ? ", '" + anchorUri.getDocumentContentUri() + "'" : "";
            onClickCommand += anchorUri.getDocumentVariables() ? ", " + anchorUri.getDocumentVariables() : "";
            onClickCommand +=  ");";
            defaultProperties = { href : "#", onclick : onClickCommand };
         }else {
            defaultProperties = { href : "#", onclick : "top.webUIController.loadHtmlDocument('" + anchorLink  + "');" };
         }
      }else {
         defaultProperties = { href : anchorLink };
      }
      
      var properties = this.mergeProperties( defaultProperties, elementProperties );
      var newAnchor = this.create( 'A', nodeText, contextElement, position, properties );
      return newAnchor;
   },

   createButton : function( buttonCaption, clickEventHandler, contextElement, position, elementProperties ) {
      var defaultProperties = { 'class' : this.options.buttonClassName, type : "button", value : buttonCaption, events : { click : clickEventHandler } };
      var properties = this.mergeProperties( defaultProperties, elementProperties );
      var button = this.create( "INPUT", null, contextElement, position, properties );
      if( buttonCaption ) {
         var i18Caption = this.i18Resource.getText( buttonCaption );
         button.set( 'value', i18Caption );
      }
      return button;
   },

   createCollapsibleArea : function( contextElement, position, elementProperties ) {
      return this.create( "div", null, contextElement, position, this.mergeProperties( { 'class' : this.options.readOnlyContainerClassName }, elementProperties ));
   },

   createDivision : function( contextElement, position, elementProperties ) {
      return this.create( "div", null, contextElement, position, this.mergeProperties( { 'class' : this.options.readOnlyContainerClassName }, elementProperties ));
   },

   createFieldSet : function( imageId, contextElement, position, elementProperties ) {
      var defaultProperties = { styles : this.options.fieldSetStyle };
      var properties = this.mergeProperties( defaultProperties, elementProperties );
      var fieldSet = this.create( "FIELDSET", null, contextElement, position, properties );

      var legend = this.create( "LEGEND", null, fieldSet, WidgetElementFactory.Positions.LastChild );
      var imageProperties = { 
         id : imageId, 
         src : this.options.fieldSetImageSource, 
         "alt" : this.options.fieldSetImageAlt, 
         "title" : this.options.fieldSetImageTitle, 
         styles : this.options.fieldSetImageStyle 
      };
      this.create( "IMG", null, legend, WidgetElementFactory.Positions.LastChild, imageProperties );

      return fieldSet;
   },

   createForm : function( formName, methodType, contextElement, position, elementProperties ) {
      assertThat( formName, not( nil() ));
      assertThat( methodType.toUpperCase() == "POST" || methodType.toUpperCase() == "GET", is( true ) );
      
      var newForm = this.create( 'FORM', null, contextElement, position, this.mergeProperties( { id : formName, name : 'form', method : methodType }, elementProperties ) );
      this.create( 'DIV', null, newForm, WidgetElementFactory.Positions.LastChild, { 'class' : this.options.formFieldsContainerClassName } );
      this.create( 'DIV', null, newForm, WidgetElementFactory.Positions.LastChild, { 'class' : this.options.readOnlyContainerClassName } );
      return newForm;
   },

   createHiddenDivision : function( divId, contextElement, position, elementProperties ) {
      var defaultProperties = { id : divId, styles : { display : 'none' }, 'class' : this.options.readOnlyContainerClassName };
      var newDivision = this.create( 'DIV', null, contextElement, position, this.mergeProperties( defaultProperties, elementProperties ));
      return newDivision;
   },

   createOption : function( value, text, contextElement, position, elementProperties ) {
      var defaultProperties = { 'value' : value };
      return this.create( "OPTION", text, contextElement, position, this.mergeProperties( defaultProperties, elementProperties ) );
   },

   createRowLabel : function( labelText, contextElement, position, elementProperties ) {
      return this.create( 'span', labelText, contextElement, position, { 'class' : this.options.labelClassName } );
   },

   createRowValue : function( valueText, valueElementId, contextElement, position, elementProperties ) {
      return this.create( 'span', valueText, contextElement, position, { id : valueElementId, 'class' : this.options.valueClassName } );
   },

   createStaticRow : function( labelText, valueText, valueElementId, contextElement, position, valueLink ) {
      var staticRow = this.create( 'div', null, contextElement, position, { 'class' : this.options.rowClassName } );
      this.create( 'label', labelText, staticRow, WidgetElementFactory.Positions.LastChild, { 'class' : this.options.labelClassName } );
      if( valueLink ){
         var valueSpanElement = this.create( 'span', null, staticRow, WidgetElementFactory.Positions.LastChild, { id : valueElementId, 'class' : this.options.valueClassName } );
         this.createAnchor( valueText, valueLink, null, valueSpanElement );
      }else this.create( 'span', valueText, staticRow, WidgetElementFactory.Positions.LastChild, { id : valueElementId, 'class' : this.options.valueClassName } );
      return staticRow;
   },

   createTable : function( tableDefinition, contextElement, position ) {
      var tableElement = this.create( "TABLE", null, contextElement, position );
      var tableHeadElement = this.create( "THEAD", null, tableElement, WidgetElementFactory.Positions.LastChild );
      var tableBodyElement = this.create( "TBODY", null, tableElement, WidgetElementFactory.Positions.LastChild );
      var tableHeadRowElement = this.create( "TR", null, tableHeadElement, WidgetElementFactory.Positions.LastChild );

      for( var i = 1; i <= tableDefinition.getColumns().size(); i++) {
         var tableColumnDefinition = tableDefinition.getColumns().getColumnByIndex( i - 1 );
         this.create( "TH", tableColumnDefinition.getCaption(), tableHeadRowElement, WidgetElementFactory.Positions.LastChild );
      }

      for( var i = 0; i < tableDefinition.getRows().size(); i++) {
         var tableRow = tableDefinition.getRow( i );
         var tableBodyRowElement = this.create( "TR", null, tableBodyElement, WidgetElementFactory.Positions.LastChild );

         for( var c = 0; c < tableRow.length; c++ ) {
            this.create( "TD", tableRow[c], tableBodyRowElement, WidgetElementFactory.Positions.LastChild );
         }
      }

      return tableElement;
   },

   // Protected, private helper methods
   appendElement : function( element, contextElement, position ) {
      contextElement = $( contextElement );
      var context = contextElement == undefined ? this.containerElement : contextElement;
      switch( position ){
      case WidgetElementFactory.Positions.Before:
         context.grab( element, 'before' );
         break;
      case WidgetElementFactory.Positions.After:
         context.grab( element, 'after' );
         break;
      case WidgetElementFactory.Positions.FirstChild:
         context.grab( element, 'top' );
         break;
      case WidgetElementFactory.Positions.LastChild:
         context.grab( element, 'bottom' );
         break;
      default:
         context.appendChild( element, 'Last' );
         break;
      }
   }.protect(),
   
   mergeProperties : function( baseProperties, additionalProperties ){
      var mergedProperties = Object.merge( baseProperties, additionalProperties );
      return mergedProperties;
   }.protect()

});

var TableColumnDefinition = new Class( {
   // Constructor
   initialize : function(theCaptionKey, i18Resource) {
       // Private instance variables
       this.caption = null;
       this.i18Resource = i18Resource;
       try {
           this.caption = this.i18Resource.getText( theCaptionKey );
       } catch (e) {
           this.caption = theCaptionKey;
       }
   },

   // Properties
   getCaption : function() {
       return this.caption;
   }
});

var TableColumnList = new Class({
   //Constructor
   initialize: function(){
       this.tableColumns = new ArrayList();        
   },

   //Public accessor and mutator methods
   add : function( tableColumnDefinition ){
       this.tableColumns.add( tableColumnDefinition );
   },
   
   getColumnByIndex : function( columnIndex ){
       var searchedColumn = null;
       this.tableColumns.each( function( columnDefinition, index ){
           if( index == columnIndex ) { searchedColumn = columnDefinition; }
       }, this );
       
       return searchedColumn;
   },
   
   size : function() {
       return this.tableColumns.size();
   }
});

var TableHeaderDefinition = new Class( {
   // Constructor
   initialize : function(i18Resource) {
       this.tableColumns = new TableColumnList();
       this.i18Resource = i18Resource;
   },

   // Public accessor and mutator methods
   addColumn : function(theCaptionKey) {
       var columnDefinition = new TableColumnDefinition( theCaptionKey, this.i18Resource );
       this.tableColumns.add( columnDefinition );
       //this.tableColumns.add( columnDefinition.getCaption, columnDefinition );
   },

   getColumns : function() {
       return this.tableColumns;
   }
});

var TableDefinition = new Class( {
   // Constructor
   initialize : function(i18Resource) {
       this.tableHeaderDefinition = new TableHeaderDefinition( i18Resource );
       this.tableRows = new TableRowList();
   },

   // Public accessor and mutator methods
   addColumn : function(theCaptionKey) {
       this.tableHeaderDefinition.addColumn( theCaptionKey );
   },

   addRow : function( rowArray ) {
       this.tableRows.add( rowArray );
   },

   // Properties
   getColumns : function() {
       return this.tableHeaderDefinition.getColumns();
   },
   
   getRow : function( rowIndex ) {
       return this.tableRows.getRowByIndex( rowIndex );
   },
   
   getRows : function() {
       return this.tableRows;
   }
});

var TableRowList = new Class({
   //Constructor
   initialize: function(){
       this.tableRows = new ArrayList();       
   },

   //Public accessor and mutator methods
   add : function( tableRowDefinition ){
       this.tableRows.add( tableRowDefinition );
   },
   
   getRowByIndex : function( rowIndex ){
       var searchedRow = null;
       this.tableRows.each( function( rowDefinition, index ){
           if( index == rowIndex ) { searchedRow = rowDefinition; }
       }, this );
       
       return searchedRow;
   },
   
   size : function() {
       return this.tableRows.size();
   }
});

WidgetElementFactory.Positions = {
   Before : 0,
   After : 1,
   FirstChild : 2,
   LastChild : 3,
   Undefined : 4 };
/*
Name: 
    - StateTransformer

Description: 
    - Abstract class of all state transformers.

Requires:
    - 
Provides:
    - StateTransformer

Part of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. 
http://www.processpuzzle.com

Authors: 
    - Zsolt Zsuffa

Copyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the 
GNU General Public License as published by the Free Software Foundation, either version 3 of the License, 
or (at your option) any later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/




var StateTransformer = new Class({
   Implements: [Events, Options],
   options: {
      unknownValue : 'unknown'
   },

   //Constructor
   initialize: function( stateMachine, options ){
      assertThat( stateMachine, not( nil() ));
      this.setOptions( options );
      this.stateMachine = stateMachine;
   },
   
   //Public accessors and mutators
   parse : function(){
      //Needs to be overwritten
   },
   
   toString : function(){
      //Needs to be overwritten
   },
   
   //Protected, private helper methods
   setUnknowsValuesToNull : function( componentState ){
      if( componentState == this.options.unknownValue ) return null;
         
      for( var property in componentState ){
         if( componentState[property] == this.options.unknownValue ) componentState[property] = null;
      }
      
      return componentState;
   }.protect(),
   
   transformComponentStateToString : function( componentStateEntry ){
      var valueString = "";
      
      var value = componentStateEntry.getValue();
      if( value == null ) value = this.options.unknownValue;
      if( typeOf( value ) == "string" ) valueString = "'" + value + "'";
      else if( typeOf( value ) == "object" ){
         valueString = "{";
         for ( var property in value ) {
            if( valueString != "{" ) valueString += ",";
            if( value[property] == null ) valueString += property + ":'" + this.options.unknownValue + "'";
            else valueString += property + ":" + this.transformStateValueToString( value[property] );
         }
         valueString += "}";
      }else valueString = "'" + value.toString() + "'";
      
      return valueString;
   }.protect(),
   
   transformStateValueToString : function( stateValue ){
      valueString = "";
      
      if( typeOf( stateValue ) == "string" ) valueString = "'" + stateValue + "'";
      else if( typeOf( stateValue ) == "object" ){
         valueString = "{";
         for ( var property in stateValue ) {
            if( valueString != "{" ) valueString += ",";
            if( stateValue[property] == null ) valueString += property + ":'" + this.options.unknownValue + "'";
            else valueString += property + ":'" + stateValue[property] + "'";
         }
         valueString += "}";
      }else valueString = stateValue.toString();
      return valueString;
   }.protect()
   
});
/*
Name: 
    - DefaultStateTransformer

Description: 
    - Transforms component's state by using component / state names and specific delimiters.

Requires:
    - 
Provides:
    - DefaultStateTransformer

Part of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. 
http://www.processpuzzle.com

Authors: 
    - Zsolt Zsuffa

Copyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the 
GNU General Public License as published by the Free Software Foundation, either version 3 of the License, 
or (at your option) any later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/





var DefaultStateTransformer = new Class({
   Extends: StateTransformer,
   options: {
      
   },

   //Constructor
   initialize: function( stateMachine, options ){
      this.parent( stateMachine, options );
   },
   
   //Public accessors and mutators
   parse: function( stateString ) {
      var tokenizer = new StringTokenizer( stateString, { delimiters : ';' } );
      while( tokenizer.hasMoreTokens() ){
         var token = tokenizer.nextToken();
         var componentName = token.substring( 0, token.indexOf( ":" ));
         var componentStateString = token.substring( token.indexOf( ":" ) +1 );
         var componentState = eval( "(" + componentStateString.trim() + ")" );
         componentState = this.setUnknowsValuesToNull( componentState );
         this.fireEvent( 'componentStateParse',  [[componentName, componentState]] );
      };
   },
   
   toString: function(){
      var stateString = "";
      this.stateMachine.each( function( componentStateEntry, index ){
         if( stateString != "" ) stateString += ";";
         stateString += componentStateEntry.getKey() + ":";
         stateString += this.transformComponentStateToString( componentStateEntry );
      }, this );
      
      return stateString;
   }
   
   //Protected, private helper methods
   
});
/*
ProcessPuzzle User Interface
Backend agnostic, desktop like configurable, browser font-end based on MochaUI.
Copyright (C) 2011  Joe Kueser, Zsolt Zsuffa

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/



//ComponentStateManager.js




var ComponentStateManager = new Class({
   Implements: [Events, Options, Class.Singleton],
   Binds: ['onComponentStateParse'],
   
   options: {
      componentName : "ComponentStateManager",
      componentsInUri : [],
      stateUriTransformer: DefaultStateTransformer,
      stateValidityPeriod: 900000
   },
   
   //Constructors
   initialize: function( options ) { return this.check() || this.setUp( options ); },
   
   setUp : function( options ) {
      this.setOptions( options );
      this.stateMachine = new LinkedHashMap();
      this.stateTransformer = new DefaultStateTransformer( this.stateMachine, { onComponentStateParse : this.onComponentStateParse } );
      this.uriTransformer = new FixedComponentOrderedTransformer( this.stateMachine, this.options.componentsInUri, { onComponentStateParse : this.onComponentStateParse } );
   }.protect(),

   //Public accessor and mutator methods
   includeComponentNameToUri : function( componentName ){
      this.uriTransformer.addComponentName( componentName );
   },
   
   onComponentStateParse : function( componentState ){
      this.storeComponentState( componentState[0].trim(), componentState[1] );
   },
   
   parse : function( stateString ){
      if( stateString ) this.stateTransformer.parse( stateString );
   },
   
   parseUri : function( stateString ){
      this.uriTransformer.parse( stateString );
   },
   
   persist : function(){
      $.jStorage.set( this.options.componentName, this.toString() );
      $.jStorage.setTTL( this.options.componentName, this.options.stateValidityPeriod );
   },
   
   reset : function() {
      this.stateMachine.clear();
      $.jStorage.flush();
   },
   
   restore : function(){
      var stateString = $.jStorage.get( this.options.componentName );
      this.parse( stateString );
   },
   
   restoreStateFromUri : function(){
      if( window.location.hash.substring(2)) {
         var currentState = this.toString();
         try {
            this.parseUri( window.location.hash.substring(2) );
         }catch( e ){
            this.parse( currentState );
         }
      }
   },
   
   retrieveComponentState : function( componentName ){
      return this.stateMachine.get( componentName );
   },
   
   storeComponentState : function( componentName, currentState ){
      if( componentName && currentState ) this.stateMachine.put( componentName, currentState );
   },
   
   toString: function(){
      return this.stateTransformer.toString();
   },
   
   toUri: function(){
      return this.uriTransformer.toString();
   },
   
   //Properties
   getDefaultTransformer: function() { return this.stateTransformer; },
   getUriTransformer: function() { return this.uriTransformer; },
   
   //Protected, private helper methods
});
/*
Name: 
    - FixedComponentOrderedTransformer

Description: 
    - Relies on the predefined order of components when parsing state string.

Requires:
    - 
Provides:
    - FixedComponentOrderedTransformer

Part of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. 
http://www.processpuzzle.com

Authors: 
    - Zsolt Zsuffa

Copyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the 
GNU General Public License as published by the Free Software Foundation, either version 3 of the License, 
or (at your option) any later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/






var FixedComponentOrderedTransformer = new Class({
   Extends: StateTransformer,
   options: {
      
   },

   //Constructor
   initialize: function( stateMachine, componentList, options ){
      assertThat( componentList, not( nil() ));
      this.parent( stateMachine, options );
      
      this.componentList = componentList;
   },
   
   //Public accessors and mutators
   addComponentName: function( componentName ){
      this.componentList.include( componentName );
   },
   
   parse: function( stateString ) {
      stateString = stateString.replace( "%7B", "{" );
      stateString = stateString.replace( "%7D", "}" );
      stateString = stateString.replace( "%27", "'" );
      var tokenizer = new StringTokenizer( stateString, { delimiters : ';' } );
      var componentIndex = 0;
      
      while( tokenizer.hasMoreTokens() ){
         var componentName = this.componentList[componentIndex++];
         var componentStateString = tokenizer.nextToken();
         var componentState = eval( "(" + componentStateString.trim() + ")" );
         componentState = this.setUnknowsValuesToNull( componentState );
         
         this.fireEvent( 'componentStateParse',  [[componentName, componentState]] );
      };
   },
   
   toString: function(){
      var stateString = "";
      this.stateMachine.each( function( componentStateEntry, index ){
         if( this.componentList.contains( componentStateEntry.getKey() )){
            if( stateString != "" ) stateString += ";";
            stateString += this.transformComponentStateToString( componentStateEntry );
         }
      }, this );
      
      return stateString;
   },
   
   //Properties
   getComponentNames: function(){ return this.componentList; },
   
   //Protected, private helper methods
   
});
/*
Name: 
    - ComplexContentBehaviour

Description: 
    - Implements features of a DesktopElement which can contain header, toolbar, widget and smart document. 
Mainly used by DesktopPanel, and DesktopWidow. 

Requires:

Provides:
    - ComplexContentBehaviour

Part of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. 
http://www.processpuzzle.com

Authors: 
    - Zsolt Zsuffa

Copyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the 
GNU General Public License as published by the Free Software Foundation, either version 3 of the License, 
or (at your option) any later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/




var ComplexContentBehaviour = new Class({
   Implements: [Events, Options],
   
   options : {
      contentAreaElementStyle : "complexContentArea",
      contentUrlSelector : "contentURL",
      disableScrollBars : false,
      disableScrollBarsSelector: "disableScrollBars",
      documentContentUriSelector : "document/documentContentUri",
      documentDefinitionUriSelector : "document/documentDefinitionUri",
      documentNameSeparator : "_",
      documentTypeDefault : AbstractDocument.Types.SMART,
      documentTypeSelector : "document/@type",
      documentWrapperId : "_documentWrapper_" + (new Date().getTime()),
      documentWrapperIdSelector : "document/@id",
      documentWrapperStyle : "documentWrapper",
      documentWrapperStyleSelector : "document/@elementStyle",
      documentWrapperTag : "div",
      documentWrapperTagSelector : "document/@tag",
      eventSourcesSelector : "eventOriginators",
      handleMenuSelectedEvents : false,
      handleMenuSelectedEventsSelector : "handleMenuSelectedEvents",
      handleTabSelectedEvents : false,
      handleTabSelectedEventsSelector : "handleTabSelectedEvents",
      headerSelector : "panelHeader",
      heightDefault : 125,
      heightSelector : "height",
      nameSelector : "name",
      nameSpaces : "xmlns:pp='http://www.processpuzzle.com'",
      pluginSelector : "plugin",
      scrollBarStyle : "scroll",
      showHeaderSelector : "showHeader",
      storeStateInUriSelector : "storeStateInUri",
      storeStateSelector : "storeState",
      titleSelector : "title",
      widthDefault : 300,
      widthSelector : "width"
   },

   //Constructor
   initialize: function( definitionElement, bundle, options ){
      this.setOptions( options );
      this.componentRootElement;
      this.contentAreaElement;
      this.contentContainerElement;
      this.contentUrl;
      this.document;
      this.documentContentUri;
      this.documentContentType = AbstractDocument.Types.HTML;
      this.documentDefinitionUri;
      this.documentWrapper;
      this.documentWrapperId;
      this.documentWrapperStyle;
      this.documentWrapperTag;
      this.documentVariables;
      this.error;
      this.eventSources = null;
      this.handleMenuSelectedEvents;
      this.handleTabSelectedEvents;
      this.header;
      this.height;
      this.lastHandledMessage;
      this.name;
      this.plugin;
      this.showHeader;
      this.stateSpecification;
      this.storedDocumentNeedsToBeRestored = false;
      this.storeState = false;
      this.storeStateInUri = false;
      this.title;
      this.verticalScrollBar;
      this.width;
   },
   
   //Public accessor and mutator methods
   onContainerResize: function(){
      var containerEffectiveSize = this.contentContainerElement.getSize();
      
      if( this.verticalScrollBar ){
        this.verticalScrollBar.refresh( this.contentContainerElement.getSize() );
        containerEffectiveSize = this.verticalScrollBar.getContentViewSize();
      } 
      
      if( this.document && this.document.getState() == AbstractDocument.States.CONSTRUCTED ) {
         this.adjustDocumentWrapperSize( containerEffectiveSize );
         this.document.onContainerResize({ x : parseInt( this.documentWrapper.getStyle( 'width' )), y : parseInt( this.documentWrapper.getStyle( 'height' ))});
      }      
   },
   
   onDocumentError: function( error ){
      this.error = error;
      this.revertConstruction();
      this.fireEvent( 'panelError', error );
      this.fireEvent('panelConstructed', this ); 
   },
   
   onDocumentReady: function(){
      this.logger.trace( this.options.componentName + ".construct() of '" + this.name + "' finished." );
      this.onContainerResize();
      this.storeComponentState();
      this.fireEvent( 'documentLoaded', this.documentDefinitionUri );
      this.constructionChain.callChain();
   },
   
   onHeaderConstructed: function(){
      this.logger.trace( this.options.componentName + ".construct() of '" + this.name + "'s header finished." );
      this.constructionChain.callChain();
   },
   
   onHeaderConstructionError: function( error ){
      this.error = error;
      this.revertConstruction();
      this.fireEvent( 'panelError', this.error );
      this.fireEvent('panelConstructed', this ); 
   },
   
   onPluginConstructed: function(){
      this.logger.trace( this.options.componentName + ".construct() of '" + this.name + "'s plugin finished." );
      if( this.verticalScrollBar ) this.verticalScrollBar.refresh();
      this.constructionChain.callChain();
   },
   
   onPluginError: function( error ){
      this.error = error;
      this.revertConstruction();
      this.fireEvent( 'panelError', this.error );
      this.fireEvent('panelConstructed', this ); 
   },
   
   webUIMessageHandler: function( webUIMessage ){
      if( this.state != DesktopElement.States.CONSTRUCTED ) return;
      
      if(( instanceOf( webUIMessage, MenuSelectedMessage ) || instanceOf( webUIMessage, TabSelectedMessage )) 
           && ( webUIMessage.getActivityType() == AbstractDocument.Activity.LOAD_DOCUMENT )
           && ( this.eventSources == null || this.eventSources.contains( webUIMessage.getOriginator() ))) {
         
         if( this.storedContentHasPrecedence( webUIMessage )){
            this.storedDocumentNeedsToBeRestored = false;
            return;
         }
         
         this.destroyDocument();
         this.destroyDocumentWrapper();
         this.processMessageProperties( webUIMessage );
         this.loadDocument( webUIMessage.getDocumentType() );
      }
      this.lastHandledMessage = webUIMessage;
   },

   //Properties
   getColumnReference: function() { return this.columnReference; },
   getComponentStateManager: function() { return this.componentStateManager; },
   getContentAreaElement: function(){ return this.contentAreaElement; },
   getContentContainerId: function() { return this.name + this.options.componentContentIdPostfix; },
   getContentUrl: function() { return this.contentUrl; },
   getDocument: function() { return this.document; },
   getDocumentContentUri: function() { return this.documentContentUri; },
   getDocumentDefinitionUri: function() { return this.documentDefinitionUri; },
   getDocumentWrapperId: function() { return this.documentWrapperId; },
   getDocumentWrapperStyle: function() { return this.documentWrapperStyle; },
   getDocumentWrapperTag: function() { return this.documentWrapperTag; },
   getEventSources: function() { return this.eventSources; },
   getHeader: function() { return this.header; },
   getHeight: function() { return this.height; },
   getLogger: function() { return this.logger; },
   getMessageBus: function() { return this.messageBus; },
   getName: function() { return this.name; },
   getPlugin: function() { return this.plugin; },
   getShowHeader: function() { return this.showHeader; },
   getState: function() { return this.state; },
   getStoreState: function() { return this.storeState; },
   getStoreStateInUri: function() { return this.storeStateInUri; },
   getTitle: function() { return this.title; },
   getToolBox: function() { return this.header; },
   getVerticalScrollBar: function() { return this.verticalScrollBar; },
   getWidth: function() { return this.width; },
   isSuccess: function() { return this.error == null; },
   
   //Protected, private helper methods
   addScrollBars: function(){
      if( !this.options.disableScrollBars ){
         this.verticalScrollBar = new ScrollingBehaviour( this.contentAreaElement, {
            contentHeight: this.contentContainerElement.getSize().y,
            contentWidth: this.contentContainerElement.getSize().x
         });
         this.verticalScrollBar.construct();
      }
      this.constructionChain.callChain();
   }.protect(),
   
   adjustDocumentWrapperSize: function( containerEffectiveSize ){
      var framingWidth = parseInt( this.documentWrapper.getStyle( 'margin-left' )) + parseInt( this.documentWrapper.getStyle( 'margin-right' ));  
      framingWidth += 2 * parseInt( this.documentWrapper.getStyle( 'border' ));  
      framingWidth += parseInt( this.documentWrapper.getStyle( 'padding-left' )) + parseInt( this.documentWrapper.getStyle( 'padding-right' ));  
      this.documentWrapper.setStyles({ width : ( containerEffectiveSize.x - framingWidth ) + 'px' });
   }.protect(),
   
   cleanUpContentElement: function(){
      if( this.contentContainerElement ){
         var childElements = this.contentContainerElement.getElements ? this.contentContainerElement.getElements( '*' ) : Array.from( this.contentContainerElement.getElementsByTagName( '*' ));  
         childElements.each( function( childElement, index ){
            if( childElement.destroy ) childElement.destroy();
         }, this );
      }
   }.protect(),
      
   constructDocument: function(){
      if( this.document ) {
         this.createDocumentWrapper();
         this.document.construct();
      }else this.constructionChain.callChain();
   }.protect(),
   
   constructPlugin: function(){
      if( this.plugin ){
         try{
            this.plugin.construct();
         }catch( e ){
            this.logger.error( "Constructing plugin of panel: '" + this.name + "' caused error." );
            throw new DesktopElementConfigurationException( this.name );
         }
      } else this.constructionChain.callChain();
   }.protect(),
   
   constructHeader: function(){
      if( this.header ) this.header.construct( $( this.name + "_header" ));
      else this.constructionChain.callChain();
   }.protect(),
   
   createContentAreaElement: function(){
      var paddingElementForStaticContent = this.contentContainerElement.getChildren( '#' + this.name + '_pad' )[0]; 
      if( paddingElementForStaticContent ){
         this.contentAreaElement = paddingElementForStaticContent;
      }else{
         this.contentAreaElement = new Element( 'div' );
         this.contentContainerElement.grab( this.contentAreaElement );
      }
      this.contentAreaElement.addClass( this.options.contentAreaElementStyle );
      
      if( !this.options.disableScrollBars ) this.contentContainerElement.setStyle( 'overflow', 'hidden' );
      this.constructionChain.callChain();      
   }.protect(),
   
   createDocumentWrapper: function(){
      this.documentWrapper = new Element( this.documentWrapperTag, { id : this.documentWrapperId, 'class' : this.documentWrapperStyle } );
      this.contentAreaElement.grab( this.documentWrapper );
      this.documentWrapper.setStyle( 'width', this.contentContainerElement.getSize().x + 'px' );
   }.protect(),
   
   destroyComponentRootElement: function(){
      if( this.componentRootElement ) {
         if( this.componentRootElement.destroy ) this.componentRootElement.destroy();
         else this.componentRootElement.removeNode();
      }
   }.protect(),
      
   destroyComponents: function(){
      this.destroyDocument();
      this.destroyDocumentWrapper();
      this.destroyScrollBars();
      this.cleanUpContentElement();
      this.destroyHeader();
      this.destroyPlugin();
      
      this.destructionChain.callChain();
   }.protect(),
   
   destroyDocument: function(){
      if( this.document ){
         this.document.removeEvents();
         this.document.destroy();
      }  
      this.document = null;
   }.protect(),
   
   destroyDocumentWrapper: function(){
      if( this.documentWrapper && this.documentWrapper.destroy ) this.documentWrapper.destroy();
      this.documentWrapper = null;
   }.protect(),
   
   destroyHeader: function(){
      if( this.header ){
         this.header.removeEvents();
         this.header.destroy();
      }
   }.protect(),
   
   destroyPlugin: function(){
      if( this.plugin ) {
         this.plugin.removeEvents();
         this.plugin.destroy();
      }
   }.protect(),
   
   destroyScrollBars: function(){
      if( this.verticalScrollBar ){ this.verticalScrollBar.destroy(); this.verticalScrollBar = null; }
   }.protect(),
   
   determineComponentElements: function(){
      this.componentRootElement = $( this.name + this.options.componentRootElementIdPostfix );
      this.componentRootElement = $( this.componentRootElement );     //required by Internet Explorer
      this.contentContainerElement = $( this.getContentContainerId() );
      this.contentContainerElement = document.id( this.contentContainerElement ); //Applies Element's methods, required by Internet Explorer
      this.constructionChain.callChain();
   }.protect(),
   
   instantiateDocument: function( documentType, documentOptions ){
      var newDocument = null;
      switch( documentType ){
      case AbstractDocument.Types.HTML: newDocument = new HtmlDocument( this.internationalization, documentOptions ); break;
      case AbstractDocument.Types.SMART: newDocument = new SmartDocument( this.internationalization, documentOptions ); break;
      }
      return newDocument;
   }.protect(),
   
   internationalizeContentUri: function(){
      this.contentUrl = this.contentUrl.substring( 0, this.contentUrl.lastIndexOf( ".html" )) + "_" + this.internationalization.getLocale().getLanguage() + ".html";
   }.protect(),
   
   loadDocument: function( documentType ){
      this.document = this.instantiateDocument( documentType, { 
         documentContainerId : this.documentWrapperId, 
         documentDefinitionUri : this.documentDefinitionUri, 
         documentContentUri : this.documentContentUri,
         documentVariables : this.documentVariables,
         onDocumentReady : this.onDocumentReady,
         onDocumentError : this.onDocumentError
      });
      this.document.unmarshall();
      this.constructDocument();
   }.protect(),
   
   parseStateSpecification: function(){
      this.documentDefinitionUri = this.stateSpecification['documentDefinitionURI'] != 'null' ? this.stateSpecification['documentDefinitionURI'] : null;
      this.documentContentUri = this.stateSpecification['documentContentURI'] != 'null' ? this.stateSpecification['documentContentURI'] : null;
      this.documentContentType = this.stateSpecification['documentType'] != 'null' ? this.stateSpecification['documentType'] : this.options.documentTypeDefault;
   }.protect(),

   processMessageProperties: function( webUIMessage ){
      this.documentDefinitionUri = webUIMessage.getDocumentURI();
      this.documentContentUri = webUIMessage.getDocumentContentURI();
      this.documentContentType = webUIMessage.getDocumentType();
      this.documentVariables = webUIMessage.getDocumentVariables();
   }.protect(),
      
   resetProperties: function(){
      this.contentUrl = null;
      this.documentContentUri = null;
      this.documentDefinitionUri = null;
      this.documentWrapperId = null;
      this.documentWrapperStyle = null;
      this.documentWrapperTag = null;
      this.height = null;
      this.name = null;
      this.showHeader = null;
      this.title = null;
      
      this.destructionChain.callChain();
   }.protect(),
   
   restoreComponentState : function() {
      if( this.storeState ){
         this.stateSpecification = this.componentStateManager.retrieveComponentState( this.options.componentName ); 
         if( this.stateSpecification ) {
            this.parseStateSpecification();
            
            if( this.documentDefinitionUri ){
               this.storedDocumentNeedsToBeRestored = true;
               
               this.document = this.instantiateDocument( this.documentContentType, { 
                  documentContainerId : this.documentWrapperId, 
                  documentDefinitionUri : this.documentDefinitionUri, 
                  documentContentUri : this.documentContentUri,
                  onDocumentReady : this.onDocumentReady,
                  onDocumentError : this.onDocumentError
               });
               this.document.unmarshall();
            }
         }
      }
      this.constructionChain.callChain();
   }.protect(),
   
   revertConstruction: function(){
      this.destroyComponents();
      this.resetProperties();
   }.protect(),
      
   storeComponentState : function() {
      if( this.storeState ){
         this.stateSpecification = { 
            documentDefinitionURI : this.documentDefinitionUri, 
            documentContentURI : this.documentContentUri, 
            documentType : this.documentContentType,
            documentVariables : this.documentVariables
         };
         this.componentStateManager.storeComponentState( this.options.componentName, this.stateSpecification );
      }
   }.protect(),
   
   storedContentHasPrecedence : function(  webUIMessage ){
      return this.storedDocumentNeedsToBeRestored == true && webUIMessage.isDefault();
   }.protect(),
   
   subscribeToWebUIMessages: function() {
      if( this.handleMenuSelectedEvents ){
         this.logger.debug( this.options.componentName + ".subscribeToWebUIMessages() started." );
         this.messageBus.subscribeToMessage( MenuSelectedMessage, this.webUIMessageHandler );
      }
      
      if( this.handleTabSelectedEvents ){
         this.logger.debug( this.options.componentName + ".subscribedToWebUIMessages() started." );
         this.messageBus.subscribeToMessage( TabSelectedMessage, this.webUIMessageHandler );
      }
      this.constructionChain.callChain();
   }.protect(),
   
   unmarshallDocument: function(){
      this.documentContentUri = XmlResource.selectNodeText( this.options.documentContentUriSelector, this.definitionElement );
      this.documentDefinitionUri = XmlResource.selectNodeText( this.options.documentDefinitionUriSelector, this.definitionElement );
      this.documentContentType = XmlResource.selectNodeText( this.options.documentTypeSelector, this.definitionElement, this.options.nameSpaces, this.options.documentTypeDefault );
      this.documentWrapperId = XmlResource.selectNodeText( this.options.documentWrapperIdSelector, this.definitionElement, this.options.nameSpaces, this.name + this.options.documentWrapperId );
      this.documentWrapperStyle = XmlResource.selectNodeText( this.options.documentWrapperStyleSelector, this.definitionElement, this.options.nameSpaces, this.options.documentWrapperStyle );
      this.documentWrapperTag = XmlResource.selectNodeText( this.options.documentWrapperTagSelector, this.definitionElement, this.options.nameSpaces, this.options.documentWrapperTag );
      if( this.documentDefinitionUri ){
         this.document = this.instantiateDocument( this.documentContentType, { 
            documentContainerId : this.documentWrapperId, 
            documentDefinitionUri : this.documentDefinitionUri, 
            documentContentUri : this.documentContentUri,
            onDocumentReady : this.onDocumentReady,
            onDocumentError : this.onDocumentError
         });
         this.document.unmarshall();
      }
   }.protect(),
   
   unmarshallHeader: function(){
      var headerConfigurationElement = XmlResource.selectNode( this.options.headerSelector, this.definitionElement );
      if( headerConfigurationElement ){
          this.header = new DesktopPanelHeader( headerConfigurationElement, this.internationalization, { onHeaderConstructed : this.onHeaderConstructed, onHeaderConstructionError : this.onHeaderConstructionError });
          this.header.unmarshall();
      }
   }.protect(),
   
   
   unmarshallPlugin: function(){
      var pluginDefinition = XmlResource.selectNode( this.options.pluginSelector, this.definitionElement );
      if( pluginDefinition ){
         this.plugin = new DocumentPlugin( pluginDefinition, this.internationalization, { onConstructed : this.onPluginConstructed, onConstructionError : this.onPluginError } );
         this.plugin.unmarshall();
      }
   }.protect(),
   
   unmarshallProperties: function(){
      this.contentUrl = XmlResource.selectNodeText( this.options.contentUrlSelector, this.definitionElement );
      this.options.disableScrollBars = parseBoolean( XmlResource.determineAttributeValue( this.definitionElement, this.options.disableScrollBarsSelector, this.options.disableScrollBars ));
      this.height = parseInt( XmlResource.determineAttributeValue( this.definitionElement, this.options.heightSelector, this.options.heightDefault ));
      this.eventSources = eval( XmlResource.determineAttributeValue( this.definitionElement, this.options.eventSourcesSelector, null, this.eventSources ));
      this.name = XmlResource.determineAttributeValue( this.definitionElement, this.options.nameSelector );
      this.showHeader = parseBoolean( XmlResource.determineAttributeValue( this.definitionElement, this.options.showHeaderSelector ));
      this.handleMenuSelectedEvents = parseBoolean( XmlResource.determineAttributeValue( this.definitionElement, this.options.handleMenuSelectedEventsSelector, this.options.handleMenuSelectedEvents ));
      this.handleTabSelectedEvents = parseBoolean( XmlResource.determineAttributeValue( this.definitionElement, this.options.handleTabSelectedEventsSelector, this.options.handleTabSelectedEvents ));
      this.storeState = parseBoolean( XmlResource.determineAttributeValue( this.definitionElement, this.options.storeStateSelector, false ));
      this.storeStateInUri = parseBoolean( XmlResource.determineAttributeValue( this.definitionElement, this.options.storeStateInUriSelector, false ));
      this.title = XmlResource.selectNodeText( this.options.titleSelector, this.definitionElement );
      if( this.internationalization ) this.title = this.internationalization.getText( this.title );
      this.width = parseInt( XmlResource.determineAttributeValue( this.definitionElement, this.options.widthSelector, this.options.widthDefault ));
      this.options.componentName = this.name;
      
      if( this.storeStateInUri ) this.componentStateManager.includeComponentNameToUri( this.name );
   }.protect()
});
/*
Name: 
    - ConfigurationTimeoutException

Description: 
    - Thrown when a desktop or document element's configuration takes longer than specified. 

Requires:
    - WebUIException

Provides:
    - ConfigurationTimeoutException

Part of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. 
http://www.processpuzzle.com

Authors: 
    - Zsolt Zsuffa

Copyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the 
GNU General Public License as published by the Free Software Foundation, either version 3 of the License, 
or (at your option) any later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/




var ConfigurationTimeoutException = new Class({
   Extends: WebUIException,
   options: {
      description: "Configuring '{configurationPath}' exceeded the '{resourceLoadTimeout}'ms timeout period.",
      name: "ConfigurationTimeoutException"
   },
   
   //Constructor
   initialize : function( configurationPath, resourceLoadTimeout, options ){
      this.setOptions( options );
      this.parent( options );
      this.parameters = { configurationPath : configurationPath, resourceLoadTimeout : resourceLoadTimeout };
   }
});
/*
Name: 
   - Desktop

Description: 
   - Constructs complete desktop from predefined UI elements, like windows, columns and panels. It's wrapper of MockaUI desktop.
    
Requires:

Provides:
    - Desktop

Part of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. 
http://www.processpuzzle.com

Authors: 
    - Zsolt Zsuffa

Copyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the 
GNU General Public License as published by the Free Software Foundation, either version 3 of the License, 
or (at your option) any later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/




var Desktop = new Class({
   Implements : [Events, Options, TimeOutBehaviour], 
   Binds : ['checkTimeOut',
            'constructColumns', 
            'constructContentArea', 
            'constructFooter', 
            'constructHeader', 
            'constructPanels', 
            'constructWindowDocker', 
            'constructWindows',
            'destroyColumns',
            'destroyContentArea',
            'destroyFooter',
            'destroyHeader',
            'destroyHiddenElements',
            'destroyPanels',
            'destroyWindowDocker',
            'destroyWindows',
            'finalizeConstruction',
            'finalizeDestruction',
            'hideDesktop',
            'initializeMUI', 
            'loadResources',
            'onColumnConstructed',
            'onColumnDestructed',
            'onContentAreaConstructed',
            'onError',
            'onFooterConstructed',
            'onHeaderConstructed',
            'onPanelConstructed',
            'onPanelDestructed',
            'onResourceError',
            'onResourcesLoaded',
            'onWindowConstructed',
            'onWindowDestructed',
            'onWindowDockerConstructed',
            'releaseResources',
            'removeDesktopEvents',
            'showDesktop',
            'showNotification',
            'subscribeToWebUIMessages',
            'webUIMessageHandler'],
   options : {
      callChainDelay : 2000,
      componentName : "Desktop",
      columnSelector : "/desktopConfiguration/columns/column",
      configurationXmlNameSpace : "xmlns:dc='http://www.processpuzzle.com/DesktopConfiguration'",
      configurationURI : "DesktopConfiguration.xml",
      containerIdSelector : "/desktopConfiguration/containerId",
      contentAreaSelector : "/desktopConfiguration/contentArea",
      defaultContainerId : "desktop",
      descriptionSelector : "/desktopConfiguration/description",
      eventFireDelay : 5,
      footerSelector : "/desktopConfiguration/footer",
      headerSelector : "/desktopConfiguration/header",
      nameSelector : "/desktopConfiguration/name",
      panelSelector : "/desktopConfiguration/panels/panel",
      pluginOnloadDelay : 1000,
      resourceLoadTimeout : 5000,
      resourcesSelector : "/desktopConfiguration/resources", 
      skin : "ProcessPuzzle",
      versionSelector : "/desktopConfiguration/version",
      windowDockerSelector : "/desktopConfiguration/windowDocker",
      windowSelector : "/desktopConfiguration/windows/window",
   },
	
	//Constructor
   initialize : function( webUIConfiguration, resourceBundle, options ) {
      this.presetOptionsBasedOnWebUIConfiguration( webUIConfiguration );
      this.setOptions( options );

	//Private instance variables
      this.componentStateManager = Class.getInstanceOf( ComponentStateManager );
      this.columns = new LinkedHashMap();
      this.configurationXml = new XmlResource( this.options.configurationURI, { nameSpaces : this.options.configurationXmlNameSpace } );
      this.constructionChain = new Chain();
      this.containerElement;
      this.containerId;
      this.contentArea;
      this.currentLocale = null;
      this.description;
      this.destructionChain = new Chain();
      this.dock = null;
      this.error;
      this.footer;
      this.header;
      this.lastHandledMessage;
      this.logger = Class.getInstanceOf( WebUILogger );
      this.messageBus = Class.getInstanceOf( WebUIMessageBus );
      this.MUIDesktop = null;
      this.name;
      this.numberOfConstructedColumns = 0;
      this.numberOfConstructedPanels = 0;
      this.numberOfConstructedWindows = 0;
      this.panels = new LinkedHashMap();
      this.resourceBundle = resourceBundle;
      this.resources = null;
      this.state = DesktopElement.States.UNINITIALIZED;
      this.version;
      this.webUIConfiguration = webUIConfiguration;
      this.windowDocker;
      this.windows = new HashMap();
		
      this.determineCurrentLocale();
      this.loadI18Resources();
      this.configureLogger();
      this.state = DesktopElement.States.UNINITIALIZED;
   },
		
   //Public accessor and mutator methods
   construct : function() {
      this.startTimeOutTimer( 'construct' );
      this.constructionChain.chain(
         this.hideDesktop,
         this.loadResources,
         this.constructHeader,
         this.constructWindowDocker,
         this.constructContentArea,
         this.constructFooter,
         this.initializeMUI,
         this.constructColumns,
         this.constructPanels,
         this.constructWindows,
         this.subscribeToWebUIMessages,
         this.showDesktop,
         this.finalizeConstruction
      ).callChain();
   },
	
   destroy : function() {
      if( this.state > DesktopElement.States.UNMARSHALLED ){
         this.destructionChain.chain(
            this.hideDesktop,
            this.releaseResources,
            this.removeDesktopEvents,
            this.destroyWindows,
            this.destroyPanels,
            this.destroyColumns,
            this.destroyHeader,
            this.destroyContentArea,
            this.destroyFooter,
            this.destroyWindowDocker,
            this.destroyHiddenElements,
            this.finalizeDestruction
         ).callChain();
      }
   },
   
   onColumnConstructed: function( column ){
      this.numberOfConstructedColumns++;
      if( this.numberOfConstructedColumns == this.columns.size() ){
         this.logger.debug( this.options.componentName + ", loading desktop column is finished." );
         this.callNextConfigurationStep();
      } 
   },
   
   onColumnDestructed: function( panel ){
      this.numberOfConstructedColumns--;
      if( this.numberOfConstructedColumns == 0 ){
         this.logger.debug( this.options.componentName + ", destroy of desktop columns is finished." );
         this.columns.clear();
         this.destructionChain.callChain();
      } 
   },
   
   onContentAreaConstructed: function(){
      this.logger.debug( this.options.componentName + ", constructing desktop content area is finished." );
      this.callNextConfigurationStep();
   },
   
   onError: function( error ){
      this.error = error;
   },
   
   onFooterConstructed: function(){
      this.logger.debug( this.options.componentName + ", loading desktop footer is finished." );
      this.callNextConfigurationStep();
   },
   
   onHeaderConstructed: function(){
      this.logger.debug( this.options.componentName + ", loading desktop header is finished." );
      this.callNextConfigurationStep();
   },
   
   onPanelConstructed: function( panel ){
      this.numberOfConstructedPanels++;
      if( this.numberOfConstructedPanels == this.panels.size() ){
         this.logger.debug( this.options.componentName + ", loading desktop panels is finished." );
         this.callNextConfigurationStep();
      } 
   },
   
   onPanelDestructed: function( panel ){
      this.numberOfConstructedPanels--;
      if( this.numberOfConstructedPanels == 0 ){
         this.logger.debug( this.options.componentName + ", destroy of desktop panels is finished." );
         this.panels.clear();
         this.destructionChain.callChain();
      } 
   },
   
   onResourceError: function( error ){
      this.error = error;
   },
   
   onResourcesLoaded: function(){
      this.logger.debug( this.options.componentName + ", loading desktop resources is finished." );
      this.callNextConfigurationStep();      
   },
   
   onWindowConstructed: function( window ){
      this.logger.debug( this.options.componentName + ", constructing desktop window " + window.getName() + " is finished." );
      if( window.getOnReadyCallback() && typeOf( window.getOnReadyCallback() ) == 'function' ) window.getOnReadyCallback()();
   },
   
   onWindowDestructed: function( panel ){
      this.numberOfConstructedWindows--;
      if( this.numberOfConstructedWindows == 0 ){
         this.windows.clear();
         this.destructionChain.callChain();
      } 
   },
   
   onWindowDockerConstructed: function(){
      this.logger.debug( this.options.componentName + ", constructing desktop window docker is finished." );
      this.callNextConfigurationStep();
   },
   
   showNotification: function( notificationText ){
      if( this.state == DesktopElement.States.CONSTRUCTED ){
         MUI.notification( this.resourceBundle.getText( "DesktopNotification." + notificationText ));
      }
   },
   
   showWindow: function( windowName, onReadyCallBack ){
      var desktopWindow = this.windows.get( windowName );
      if( desktopWindow ) {
         if( desktopWindow.getState() == DesktopElement.States.INITIALIZED ) desktopWindow.unmarshall();
         desktopWindow.construct( onReadyCallBack );
      }
      return desktopWindow;
   },
   
   unmarshall: function(){
      this.unmarshallDesktopProperties();
      this.unmarshallResources();
      this.unmarshallHeader();
      this.unmarshallDesktopContentArea();
      this.unmarshallFooter();
      this.unmarshallWindowDocker();
      this.unmarshallColumns();
      this.unmarshallPanels();
      this.unmarshallWindows();
      this.componentStateManager.restoreStateFromUri();
      this.state = DesktopElement.States.UNMARSHALLED;
   },
	   
   webUIMessageHandler: function( webUIMessage ){
      if( this.state != DesktopElement.States.CONSTRUCTED ) return;
      
      if( instanceOf( webUIMessage, MenuSelectedMessage )) {
         switch( webUIMessage.getActivityType() ){
         case DesktopWindow.Activity.SHOW_NOTIFICATION:
            this.showNotification( webUIMessage.getNotification() ); break;
         case DesktopWindow.Activity.SHOW_WINDOW:
            this.showWindow( webUIMessage.getWindowName() ); break;
         }
      }
      this.lastHandledMessage = webUIMessage;
   },

   //Properties
   getColumns : function() { return this.columns; },
   getConfigurationXml : function() { return this.configurationXml; },
   getContainerId : function() { return this.containerId; },
   getCurrentLocale : function() { return this.currentLocale; },
   getDescription : function() { return this.description; },
   getMUIDesktop : function() { return this.MUIDesktop; },
   getFooter: function() { return this.footer; },
   getHeader: function() { return this.header; },
   getName: function() { return this.name; },
   getPanels : function() { return this.panels; },
   getResources : function() { return this.resources; },
   getState : function() { return this.state; },
   getVersion : function() { return this.version; },
   getWindowDocker : function() { return this.windowDocker; },
   getWindows : function() { return this.windows; },
   isSuccess: function() { return this.error == null; },
	
   //Private methods
   callNextConfigurationStep: function(){
      if( this.isSuccess() ) this.constructionChain.callChain();
      else{ this.revertConstruction(); }
   }.protect(),
   
   configureLogger : function() {
      if( !this.logger.isConfigured() ) this.logger.configure( this.webUIConfiguration );
   }.protect(),
	
   constructColumns : function() {
      this.logger.debug( this.options.componentName + ".constructColumns() started." );
      if( this.columns.size() > 0 ){
         this.columns.each( function( columnEntry, index ){
            var column = columnEntry.getValue();
            try{ column.construct();
            }catch( e ){ this.onError( e ); }
         }, this );
      }else this.callNextConfigurationStep();
   }.protect(),
   
   constructContentArea : function(){
      this.logger.debug( this.options.componentName + ".constructContentArea() started." );
      if( this.contentArea ) this.contentArea.construct();
      else this.callNextConfigurationStep();      
   }.protect(),
    
   constructHeader : function(){
      this.logger.debug( this.options.componentName + ".constructHeader() started." );
      if( this.header ) this.header.construct();
      else this.callNextConfigurationStep();      
   }.protect(),
	
   constructFooter : function(){
      this.logger.debug( this.options.componentName + ".constructFooter() started." );
      if( this.footer ) this.footer.construct();
      else this.callNextConfigurationStep();      
   }.protect(),
    
   constructPanels : function() {
      this.logger.debug( this.options.componentName + ".constructPanels() started." );
      if( this.panels.size() > 0 ){
         this.panels.each( function( panelEntry, index ){
            var panel = panelEntry.getValue();
            try{ panel.construct();
            }catch( e ){ this.onError( e ); }
         }, this );
      } else this.callNextConfigurationStep();
   }.protect(),
	
   constructWindowDocker : function(){
      this.logger.debug( this.options.componentName + ".constructWindowDocker() started." );
      if( this.windowDocker ) this.windowDocker.construct();
      else this.callNextConfigurationStep();      
   }.protect(),
    
   constructWindows : function() {
      this.logger.debug( this.options.componentName + ".constructWindows() started." );      
      this.callNextConfigurationStep();
   }.protect(),
	
   destroyColumns: function() {
      this.logger.debug( this.options.componentName + ".destroyColumns() started." );
      this.columns.each( function( columnEntry, index ) {
         var column = columnEntry.getValue();
         column.destroy();
      }, this );
   }.protect(),
   
   destroyContentArea: function(){
      if( this.contentArea ) this.contentArea.destroy();
      this.destructionChain.callChain();
   }.protect(),
   
   destroyElementById: function( elementId ){
      if( $( elementId )) $( elementId ).destroy(); 
   }.protect(),
   
   destroyFooter: function(){
      if( this.footer ) this.footer.destroy();
      this.destructionChain.callChain();
   }.protect(),
   
   destroyHeader: function(){
      if( this.header ) this.header.destroy();
      this.destructionChain.callChain();
   }.protect(),
   
   destroyHiddenElements: function(){
      this.destroyElementById( 'windowUnderlay' );
      this.destroyElementById( 'lbOverlay' );
      this.destroyElementById( 'lbCenter' );
      this.destroyElementById( 'lbBottomContainer' );
      this.destructionChain.callChain();
   }.protect(),
	
   destroyPanels: function() {
      this.logger.debug( this.options.componentName + ".destroyPanels() started." );
      this.panels.each( function( panelEntry, index ) {
         var panel = panelEntry.getValue();
         panel.destroy();
      }, this );
   }.protect(),
   
   destroyWindowDocker: function(){
      if( this.windowDocker ) this.windowDocker.destroy();
      this.destructionChain.callChain();
   }.protect(),
	
   destroyWindows: function() {
      this.logger.debug( this.options.componentName + ".destroyWindows() started." );
      this.numberOfConstructedWindows = this.windows.size();
      if( this.numberOfConstructedWindows > 0 ){
         this.windows.each( function( windowEntry, index ) {
            var window = windowEntry.getValue();
            window.destroy();
         }, this );
      }else this.destructionChain.callChain(); 
   }.protect(),
	
   determineCurrentLocale : function() {
      if( this.resourceBundle.isLoaded ) this.currentLocale = this.resourceBundle.getLocale();
      else {
         this.currentLocale = new ProcessPuzzleLocale();
         this.currentLocale.parse( this.webUIConfiguration.getI18DefaultLocale() );
      }
   }.protect(),
   
   finalizeConstruction: function(){
      this.state = DesktopElement.States.CONSTRUCTED;
      this.stopTimeOutTimer( 'construct' );
      this.constructionChain.clearChain();
      this.fireEvent( 'constructed', this, this.options.eventFireDelay ); 
   }.protect(),
   
   finalizeDestruction: function(){
      this.state = DesktopElement.States.INITIALIZED;
      this.destructionChain.clearChain();
      this.fireEvent( 'destructed', this, this.options.eventFireDelay ); 
   }.protect(),
   
   hideDesktop: function(){
      this.containerElement.setStyle( "visibility", "hidden" );
      if( this.destructionChain.$chain.length > 0 ) this.destructionChain.callChain();
      this.callNextConfigurationStep();
   }.protect(),
	
   initializeMUI : function() {
      this.logger.debug( this.options.componentName + ".initializeMUI() started." );
      MUI.myChain = new Chain();
      MUI.myChain.chain(
         function(){
            MUI.Desktop.initialize({
               desktop : this.containerId,
               desktopHeader : this.header.getId(),
               desktopFooter : this.footer.getFooterId(),
               desktopFooterWrapper : this.footer.getId(),
               desktopNavBar : this.header.getNavigationBarId(),
               pageWrapper : this.contentArea.getId()
            }); 
         }.bind( this ),
         function(){ MUI.Dock.initialize(); }
      );
      
      MUI.myChain.callChain();
      this.MUIDesktop = MUI.Desktop;
      this.dock = MUI.Dock;
      this.callNextConfigurationStep();
   }.protect(),
   
   loadResources: function(){
      this.logger.debug( this.options.componentName + ".loadResources() started." );
      if( this.resources ) {
         this.resources.load();
      }else this.onResourcesLoaded();
   }.protect(),
   
   loadI18Resources : function() {
      if( !this.resourceBundle.isLoaded )
         this.resourceBundle.load( this.currentLocale );
   }.protect(),
	
   presetOptionsBasedOnWebUIConfiguration : function( webUIConfiguration ){
      if( webUIConfiguration != 'undefined' && webUIConfiguration != null ){
         this.options.skin = webUIConfiguration.getDefaultSkin();
         this.options.configurationURI = webUIConfiguration.getSkinConfiguration( this.options.skin );
      }
   }.protect(),
   
   proceedWithConfigurationChainWhenResourcesLoaded: function() {
      if( this.pendingResourcesCounter > 0 ) return false;
      else this.callNextConfigurationStep();
   }.protect(),
   
   releaseResources : function(){
      if( this.resources ) this.resources.release();
      this.destructionChain.callChain();
   }.protect(),

   removeDesktopEvents : function(){
      this.containerElement.removeEvents();
      window.removeEvents();
      document.removeEvents();
      
      this.destructionChain.callChain();
   }.protect(),
   
   revertConstruction: function(){
      if( this.resources ) this.resources.release();
      if( this.header ) this.header.destroy();
      if( this.contentArea ) this.contentArea.destroy();
      if( this.footer ) this.footer.destroy();
      if( this.windowDocker ) this.windowDocker.destroy();
      this.destroyWindows();
      this.destroyPanels();
      this.destroyColumns();
      this.removeDesktopEvents();
      this.state = DesktopElement.States.INITIALIZED;      
      this.fireEvent( 'error', this.error );
   }.protect(),
   
   showDesktop: function(){
      this.containerElement.setStyle( "visibility", "visible" );
      this.callNextConfigurationStep();
   }.protect(),
   
   subscribeToWebUIMessages: function() {
      this.logger.debug( this.options.componentName + ".subscribeToWebUIMessages() started." );
      this.messageBus.subscribeToMessage( MenuSelectedMessage, this.webUIMessageHandler );
      this.callNextConfigurationStep();
   }.protect(),
   
   timeOut : function( exception ){
      this.error = exception;
      this.revertConstruction();
   }.protect(),
   
   unmarshallColumns: function(){
      var columnDefinitionElements = this.configurationXml.selectNodes( this.options.columnSelector );
      columnDefinitionElements.each( function( columnDefinition, index ){
         var desktopColumn = new DesktopColumn( columnDefinition, { componentContainerId : this.containerId, onConstructed: this.onColumnConstructed, onDestructed: this.onColumnDestructed, onError : this.onError  } );
         desktopColumn.unmarshall();
         this.columns.put( desktopColumn.getName(), desktopColumn );
      }, this );
   }.protect(),
   
   unmarshallDesktopContentArea: function(){
      var areaDefinitionElement = this.configurationXml.selectNode( this.options.contentAreaSelector );
      if( areaDefinitionElement ){
         this.contentArea = new DesktopContentArea( areaDefinitionElement, this.resourceBundle, { componentContainerId : this.containerId, onConstructed : this.onContentAreaConstructed, onConstructionError : this.onError } );
         this.contentArea.unmarshall();
      }
   }.protect(),

   unmarshallDesktopProperties: function(){
      this.name = this.configurationXml.selectNodeText( this.options.nameSelector );
      this.description = this.configurationXml.selectNodeText( this.options.descriptionSelector );
      this.version = this.configurationXml.selectNodeText( this.options.versionSelector );
      this.containerId = this.configurationXml.selectNodeText( this.options.containerIdSelector );
      if( !this.containerId ) this.containerId = this.options.defaultContainerId;
      this.containerElement = $( this.containerId );
      if( !this.containerElement ) throw new NoneExistingDesktopContainerElementException( this.containerId );
   }.protect(),
   
   unmarshallFooter: function(){
      var footerDefinitionElement = this.configurationXml.selectNode( this.options.footerSelector );
      if( footerDefinitionElement ){
         this.footer = new DesktopFooter( footerDefinitionElement, this.resourceBundle, { componentContainerId : this.containerId, onConstructed : this.onFooterConstructed, onError : this.onError } );
         this.footer.unmarshall();
      }
   }.protect(),

   unmarshallHeader: function(){
      var headerDefinitionElement = this.configurationXml.selectNode( this.options.headerSelector );
      if( headerDefinitionElement ){
         this.header = new DesktopHeader( headerDefinitionElement, this.resourceBundle, { componentContainerId : this.containerId, onConstructed : this.onHeaderConstructed, onError : this.onError } );
         this.header.unmarshall();
      }
   }.protect(),

   unmarshallPanels: function(){
      var panelDefinitionElements = this.configurationXml.selectNodes( this.options.panelSelector );
      panelDefinitionElements.each( function( panelDefinition, index ){
         var desktopPanel = new DesktopPanel( panelDefinition, this.resourceBundle, { componentContainerId: this.containerId, onConstructed: this.onPanelConstructed, onDestructed: this.onPanelDestructed, onError : this.onError });
         desktopPanel.unmarshall();
         this.panels.put( desktopPanel.getName(), desktopPanel );
      }, this );
   }.protect(),
   
   unmarshallResources: function(){
      var resourcesElement = this.configurationXml.selectNode( this.options.resourcesSelector );
      if( resourcesElement ) {
         this.resources = new ResourceManager( resourcesElement, { onResourcesLoaded : this.onResourcesLoaded, onResourceError : this.onResourceError } );
         this.resources.unmarshall();
      }
   }.protect(),
   
   unmarshallWindowDocker: function(){
      var windowDockerDefinitionElement = this.configurationXml.selectNode( this.options.windowDockerSelector );
      if( windowDockerDefinitionElement ){
         this.windowDocker = new WindowDocker( windowDockerDefinitionElement, this.resourceBundle, { componentContainerId : this.containerId, onConstructed : this.onWindowDockerConstructed, onError : this.onError } );
         this.windowDocker.unmarshall();         
      }
   }.protect(),
   
   unmarshallWindows: function(){
      var windowDefinitionElements = this.configurationXml.selectNodes( this.options.windowSelector );
      windowDefinitionElements.each( function( windowDefinition, index ){
         var desktopWindow = new DesktopWindow( windowDefinition, this.resourceBundle, { componentContainerId: this.containerId, onConstructed: this.onWindowConstructed, onDestructed: this.onWindowDestructed, onError : this.onError });
         desktopWindow.unmarshall();
         this.windows.put( desktopWindow.getName(), desktopWindow );
      }, this );
   }.protect(),
});
/*
Name: DesktopElement

Description: Represents a single desktop component.

Requires:
    - 
Provides:
    - DesktopElement

Part of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. 
http://www.processpuzzle.com

Authors: 
    - Zsolt Zsuffa

Copyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the 
GNU General Public License as published by the Free Software Foundation, either version 3 of the License, 
or (at your option) any later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/




var DesktopElement = new Class({
   Implements: [Events, Options, TimeOutBehaviour],
   Binds: ['checkTimeOut', 'constructed', 'createHtmlElement', 'destroyComponents', 'destroyHtmlElement', 'finalizeConstruction', 'finalizeDestruction', 'resetProperties', 'onConstructionError'],
   
   options: {
      componentContainerId: "desktop",
      componentName: "DesktopElement",
      defaultTag : "div",
      definitionXmlNameSpace : "xmlns:pp='http://www.processpuzzle.com'",
      eventFireDelay : 2,
      idSelector : "@id",
      tagSelector : "@tag",
   },
   
   //Constructor
   initialize: function( definitionElement, internationalization, options ){
      this.setOptions( options );
      this.componentStateManager;
      this.constructionChain = new Chain();
      this.containerElement;
      this.definitionElement = definitionElement;
      this.destructionChain = new Chain();
      this.error;
      this.htmlElement;
      this.id;
      this.internationalization = internationalization;
      this.logger;
      this.messageBus;
      this.state = DesktopElement.States.UNINITIALIZED;
      this.tag;
      
      this.setUp();
   },
   
   //Public accessors and mutators
   construct: function(){
      if( this.state != DesktopElement.States.UNMARSHALLED ) throw new UnconfiguredDocumentElementException( 'destroy', 'initialized' );
      this.logger.trace( this.options.componentName + ".construct() of '" + this.id + "'started." );
      this.startTimeOutTimer( 'construct' );
      this.compileConstructionChain();
      this.constructionChain.callChain();
   },
   
   destroy: function(){
      this.logger.trace( this.options.componentName + ".destroy() of '" + this.name + "' started." );
      if( this.state == DesktopElement.States.CONSTRUCTED ){
         this.startTimeOutTimer( 'destruct' );
         this.compileDestructionChain();
         this.destructionChain.callChain();
      }else this.finalizeDestruction();      
   },
   
   onConstructionError: function( error ){
      this.error = error;
      this.revertConstruction();
   },
   
   unmarshall: function(){
      this.state = DesktopElement.States.UNMARSHALLED;
   },
   
   //Properties
   getComponentStateManager: function() { return this.componentStateManager; },
   getContainerElement: function() { return this.containerElement; },
   getContainerElementId: function() { return this.options.componentContainerId; }, 
   getDefinitionElement: function() { return this.definitionElement; },
   getId: function() { return this.id; },
   getState: function() { return this.state; },
   isSuccess: function() { return this.error == null; },
   
   //Protected, private helper methods
   compileConstructionChain: function(){
      this.constructionChain.chain( this.finalizeConstruction );
   }.protect(),
   
   compileDestructionChain: function(){
      this.destructionChain.chain( this.destroyComponents, this.resetProperties, this.destroyHtmlElement, this.finalizeDestruction );
   }.protect(),
   
   configureLogger : function() {
      if( this.webUIController == null ){
         this.logger = Class.getInstanceOf( WebUILogger );
         if( this.logger == null )
            this.logger = new WebUILogger();
      }else
         this.logger = this.webUIController.getLogger();
   }.protect(),
   
   createHtmlElement: function(){
      if( this.tag ){
         this.htmlElement = new Element( this.tag );
         if( this.id ) this.htmlElement.set( 'id', this.id );
         this.htmlElement.inject( this.containerElement );
      }
      
      this.constructionChain.callChain();
   }.protect(),
   
   definitionElementAttribute: function( selector ){
      var attributeNode = XmlResource.selectNode( selector, this.definitionElement );
      if( attributeNode ) return attributeNode.value;
      else return null;
   }.protect(),
   
   destroyComponents: function(){
      //Abstract method, should be overwritten
      this.destructionChain.callChain();
   }.protect(),
   
   destroyHtmlElement: function(){
      if( this.htmlElement ) this.htmlElement.destroy();      
      this.destructionChain.callChain();
   }.protect(),
   
   finalizeConstruction: function(){
      this.stopTimeOutTimer();
      this.state = DesktopElement.States.CONSTRUCTED;
      this.constructionChain.clearChain();
      this.fireEvent( 'constructed', this, this.options.eventFireDelay ); 
   }.protect(),
   
   finalizeDestruction: function(){
      this.stopTimeOutTimer();
      this.state = DesktopElement.States.INITIALIZED;
      this.destructionChain.clearChain();
      this.fireEvent( 'destructed', this, this.options.eventFireDelay ); 
   }.protect(),
   
   resetProperties: function(){
      //Abstract method, should be overwritten.
      this.destructionChain.callChain();
   }.protect(),
   
   revertConstruction: function(){
      this.state = DesktopElement.States.INITIALIZED;
      this.fireEvent( 'error', this.error );
   }.protect(),
   
   setUp: function(){
      this.componentStateManager = Class.getInstanceOf( ComponentStateManager );
      this.configureLogger();
      this.containerElement = $( this.options.componentContainerId );
      if( this.containerElement == null ) 
         throw new IllegalArgumentException( "Parameter 'componetContainerId' in invalid." );
      this.messageBus = Class.getInstanceOf( WebUIMessageBus );
      this.state = DesktopElement.States.INITIALIZED;
   }.protect(),
   
   timeOut : function( exception ){
      this.error = exception;
      this.revertConstruction();
   }.protect(),
   
   unmarshallElementProperties: function(){
      this.id = this.definitionElementAttribute( this.options.idSelector );
      if( !this.id ) this.id = this.options.idPrefix + (new Date().getTime());
      if( this.dataElementsIndex > 0 ) this.id += "#" + this.dataElementsIndex; 
      
      this.tag = this.definitionElementAttribute( this.options.tagSelector );
      if( !this.tag ) this.tag = this.options.defaultTag;
   }.protect()
});

DesktopElement.States = { UNINITIALIZED : 0, INITIALIZED : 1, UNMARSHALLED : 2, CONSTRUCTED : 3 };
/*
Name: 
    - DesktopColumn

Description: 
    - Represents vertical column of the desktop. It's wrapper of MochaUI column, which gets it's properties from an XML descriptor. 

Requires:

Provides:
    - DesktopColumn

Part of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. 
http://www.processpuzzle.com

Authors: 
    - Zsolt Zsuffa

Copyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the 
GNU General Public License as published by the Free Software Foundation, either version 3 of the License, 
or (at your option) any later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/





var DesktopColumn = new Class({
   Extends: DesktopElement,
   Binds: ['constructMUIColumn', 'destroyMUIColumn'],
   options : {
      componentName : "DesktopColumn",
      maximumWidthSelector : "maximumWidth",
      minimumWidthSelector : "minimumWidth",
      nameSelector : "name",
      placementSelector : "placement",
      widthSelector : "width"
   },

   //Constructor
   initialize: function( definitionElement, options ){
      this.parent( definitionElement, null, options );
      this.maximumWidth;
      this.minimumWidth;
      this.MUIColumn;
      this.name;
      this.placement;
      this.width;
   },
   
   //Public accessor and mutator methods
   construct: function(){
      this.parent();
   },
   
   destroy: function(){
      this.parent();
   },
   
   unmarshall: function(){
      this.maximumWidth = parseInt( XmlResource.determineAttributeValue( this.definitionElement, this.options.maximumWidthSelector ));
      this.minimumWidth = parseInt( XmlResource.determineAttributeValue( this.definitionElement, this.options.minimumWidthSelector ));
      this.name = XmlResource.determineAttributeValue( this.definitionElement, this.options.nameSelector );
      this.placement = XmlResource.determineAttributeValue( this.definitionElement, this.options.placementSelector );
      this.width = parseInt( XmlResource.determineAttributeValue( this.definitionElement, this.options.widthSelector ));
      this.parent();
   },
   
   //Properties
   getMaximumWidth: function() { return this.maximumWidth; },
   getMinimumWidth: function() { return this.minimumWidth; },
   getMUIColumn: function() { return this.MUIColumn; },
   getName: function() { return this.name; },
   getPlacement: function() { return this.placement; },
   getWidth: function() { return this.width; },
   
   //Protected, private helper methods
   compileConstructionChain: function(){
      this.constructionChain.chain( this.constructMUIColumn, this.finalizeConstruction );
   }.protect(),
   
   compileDestructionChain: function(){
      this.destructionChain.chain( this.destroyMUIColumn, this.finalizeDestruction );
   }.protect(),
   
   constructMUIColumn: function(){
      this.MUIColumn = new MUI.Column({ id: this.name, placement: this.placement, width: this.width, resizeLimit: [this.minimumWidth, this.maximumWidth] });      
      this.constructionChain.callChain();
   }.protect(),
   
   destroyMUIColumn: function(){
      if( this.MUIColumn ) this.MUIColumn.close();
      
      this.destructionChain.callChain();
   }.protect()
});
/*
Name: DesktopContentArea

Description: Represents the content area of the desktop.

Requires:

Provides:
    - DesktopContentArea

Part of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. 
http://www.processpuzzle.com

Authors: 
    - Zsolt Zsuffa

Copyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the 
GNU General Public License as published by the Free Software Foundation, either version 3 of the License, 
or (at your option) any later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/





var DesktopContentArea = new Class({
   Extends: DesktopElement,
   
   options: {
      componentName : "DesktopContentArea",
   },
   
   //Constructor
   initialize: function( definitionElement, bundle, options ){
      this.options.type = "DesktopContentArea";
      this.parent( definitionElement, bundle, options );
   },
   
   //Public mutators and accessor methods
   construct: function(){
      this.parent();
   },
   
   unmarshall: function(){
      this.unmarshallElementProperties();
      this.parent();
   },

   //Properties
   
   //Protected, private helper methods
   compileConstructionChain: function(){
      this.constructionChain.chain( this.createHtmlElement, this.finalizeConstruction );
   }.protect(),
   
   compileDestructionChain: function(){
      this.destructionChain.chain( this.destroyHtmlElement, this.finalizeDestruction );
   }.protect()
   
});
/*
Name: DesktopDocument

Description: Represents the header component of the desktop.

Requires:
    - CompositeDesktopElement
Provides:
    - DesktopDocument

Part of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. 
http://www.processpuzzle.com

Authors: 
    - Zsolt Zsuffa

Copyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the 
GNU General Public License as published by the Free Software Foundation, either version 3 of the License, 
or (at your option) any later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/





var DesktopDocument = new Class({
   Extends: DesktopElement,
   Binds: ['constructDocument', 'instantiateDocument', 'onDocumentError', 'onDocumentReady'],
   
   options: {
      componentName : "DesktopDocument",
      documentDataNameSpace: "",
      documentDataUriSelector: "@documentData",
      documentDefinitionNameSpace: "xmlns:sd='http://www.processpuzzle.com/SmartDocument'",
      documentDefinitionUriSelector: "@documentDefinition"
   },
   
   //Constructor
   initialize: function( headerDefinitionElement, bundle, options ){
      this.parent( headerDefinitionElement, bundle, options );
      this.document;
      this.documentDataUri;
      this.documentDefinitionUri;
   },
   
   //Public mutators and accessor methods
   construct: function(){
      this.parent();
   },
   
   destroy: function(){
      this.parent();
   },
   
   onDocumentError: function( error ){
      this.onConstructionError( error );
   },
   
   onDocumentReady: function(){
      this.constructionChain.callChain();      
   },
   
   unmarshall: function(){
      this.unmarshallProperties();
      this.instantiateDocument();
      this.parent();
   },

   //Properties
   getDocument: function() { return this.document; },
   getDocumentDefinitionUri: function() { return this.documentDefinitionUri; },
   
   //Protected, private helper methods
   compileConstructionChain: function(){
      this.constructionChain.chain( this.constructDocument, this.finalizeConstruction );
   }.protect(),
   
   constructDocument: function(){
      this.document.construct();
   }.protect(),
   
   destroyComponents: function(){
      if( this.document ) this.document.destroy();
      this.destructionChain.callChain();
   }.protect(),
   
   instantiateDocument: function(){
      this.document = new SmartDocument( this.internationalization, {  
         documentContainerId : this.options.componentContainerId, 
         documentDefinitionUri : this.documentDefinitionUri, 
         documentContentUri : this.documentDataUri, 
         onDocumentReady : this.onDocumentReady,
         onDocumentError : this.onDocumentError
      });
      this.document.unmarshall();
   }.protect(),
   
   resetProperties: function(){
      this.document = null;
      this.documentDataUri = null;
      this.documentDefinitionUri = null;
      this.destructionChain.callChain();
   }.protect(),
   
   revertConstruction: function(){
      if( this.document && this.document.getState() > AbstractDocument.States.INITIALIZED ) this.document.destroy();
      this.document = null;
      this.parent();
   },
   
   unmarshallProperties: function(){
      this.documentDefinitionUri = XmlResource.selectNodeText( this.options.documentDefinitionUriSelector, this.definitionElement, [this.options.definitionXmlNameSpace, this.options.documentDefinitionNameSpace] );
   }.protect()
});
/*
Name: DesktopElementConfigurationException

Description: Thrown when configuring a desktop element failed.

Requires: WebUIException

Provides: DesktopElementConfigurationException

Part of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. 
http://www.processpuzzle.com

Authors: 
   - Zsolt Zsuffa

Copyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the 
GNU General Public License as published by the Free Software Foundation, either version 3 of the License, 
or (at your option) any later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/




var DesktopElementConfigurationException = new Class({
   Extends: WebUIException,
   options: {
      description: "Configuring '{desktopElementName}' caused error.",
      name: "ConfigurationTimeoutException"
   },
   
   //Constructor
   initialize : function( desktopElementName, options ){
      this.setOptions( options );
      this.parent( options );
      this.parameters = { desktopElementName : desktopElementName };
   }
});
/*
Name: DesktopElementFactory

Description: Instantiates a new subclass of DesktopElement according to the given XML element.

Requires:

Provides:
    - DesktopElementFactory

Part of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. 
http://www.processpuzzle.com

Authors: 
    - Zsolt Zsuffa

Copyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the 
GNU General Public License as published by the Free Software Foundation, either version 3 of the License, 
or (at your option) any later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/




var DesktopElementFactory = new Class({
   Implements: Options,
   
   options: {   
   },
   
   initialize: function(){
   },

   create: function( definitionXmlElement, bundle, options ){
      var newDesktopElement;
      switch( definitionXmlElement.tagName.toUpperCase() ){
      case "COMPOSITEELEMENT": 
         newDesktopElement = new CompositeDesktopElement( definitionXmlElement, bundle, options ); break;
      case "DOCUMENTBODY": 
         newDesktopElement = new DesktopBody( definitionXmlElement, bundle, options ); break;
      case "FOOTER": 
         newDesktopElement = new DesktopFooter( definitionXmlElement, bundle, options ); break;
      case "FOOTERBAR": 
         newDesktopElement = new DesktopFooterBar( definitionXmlElement, bundle, options ); break;
      case "HEADER": 
         newDesktopElement = new DesktopHeader( definitionXmlElement, bundle, options ); break;
      case "NAVIGATIONBAR": 
         newDesktopElement = new DesktopNavigationBar( definitionXmlElement, bundle, options ); break;
      case "TITLEBAR": 
         newDesktopElement = new DesktopTitleBar( definitionXmlElement, bundle, options ); break;
      case "ELEMENT":
      default:
         newDesktopElement = new DesktopElement( definitionXmlElement, bundle, options ); break;
      }
      
      return newDesktopElement;
   }
});

DesktopElementFactory.create = function(  definitionXmlElement, bundle, options ){
   var factory = new DesktopElementFactory();
   var element = factory.create( definitionXmlElement, bundle, options );
   return element;
};
/*
Name: DocumentFooter

Description: Represents the body component of a SmartDocument.

Requires:

Provides:
    - DocumentFooter

Part of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. 
http://www.processpuzzle.com

Authors: 
    - Zsolt Zsuffa

Copyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the 
GNU General Public License as published by the Free Software Foundation, either version 3 of the License, 
or (at your option) any later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/






var DesktopFooter = new Class({
   Extends: DesktopDocument,
   
   options: {
      componentName : "DesktopFooter",
      subElementsSelector : "footerBar | compositeElement | element",
   },
   
   //Constructor
   initialize: function( definitionElement, bundle, options ){
      this.parent( definitionElement, bundle, options );
      this.footerId;
   },
   
   //Public mutators and accessor methods
   construct: function(){
      this.parent();
   },
   
   unmarshall: function(){
      this.parent();
      this.footerId = this.document.getBody().elements.first().getId();
   },

   //Properties
   getId: function() { return this.document.getBody().getId(); },
   getFooterId: function() { return this.footerId; }
});
/*
Name: DesktopHeader

Description: Represents the header part of the desktop.

Requires:
   - DesktopDocument, DesktopElement

Provides:
   - DesktopHeader

Part of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. 
http://www.processpuzzle.com

Authors: 
   - Zsolt Zsuffa

Copyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the 
GNU General Public License as published by the Free Software Foundation, either version 3 of the License, 
or (at your option) any later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/






var DesktopHeader = new Class({
   Extends: DesktopDocument,
   
   options: {
      componentName : "DesktopHeader",
      navigationBarId : "desktopNavigationBar"
   },
   
   //Constructor
   initialize: function( definitionElement, bundle, options ){
      this.parent( definitionElement, bundle, options );
   },
   
   //Public mutators and accessor methods
   construct: function(){
      this.parent();
   },
   
   unmarshall: function(){
      this.parent();
   },

   //Properties
   getId: function() { return this.document.getBody().getId(); },
   getNavigationBarId: function() { return this.options.navigationBarId; }
});
/*
Name: 
    - DesktopPanel

Description: 
    - Represents a panel of the desktop. It's wrapper of MochaUI panel, which gets it's properties from an XML descriptor. 

Requires:

Provides:
    - DesktopPanel

Part of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. 
http://www.processpuzzle.com

Authors: 
    - Zsolt Zsuffa

Copyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the 
GNU General Public License as published by the Free Software Foundation, either version 3 of the License, 
or (at your option) any later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/





var DesktopPanel = new Class({
   Extends: DesktopElement,
   Implements: [ComplexContentBehaviour],
   Binds: ['addScrollBars',
           'constructDocument', 
           'constructPlugin', 
           'constructHeader', 
           'createContentAreaElement',
           'destroyComponents',
           'destroyMUIPanel',
           'determineComponentElements',
           'finalizeConstruction',
           'finalizeDestruction',
           'instantiateMUIPanel',
           'loadHtmlDocument',
           'loadSmartDocument',
           'onContainerResize', 
           'onDocumentError', 
           'onDocumentReady', 
           'onHeaderConstructed', 
           'onHeaderConstructionError',
           'onMUIPanelLoaded',
           'onPluginConstructed',
           'onPluginError',
           'restoreComponentState',
           'subscribeToWebUIMessages',
           'webUIMessageHandler'],   
   
   options : {
      columnReferenceSelector : "columnReference",
      componentContentIdPostfix : "",
      componentName : "DesktopPanel",
      componentRootElementIdPostfix : "_wrapper",
      panelContentElementSuffix : "_pad"
   },

   //Constructor
   initialize: function( definitionElement, bundle, options ){
      this.parent( definitionElement, bundle, options );
      this.columnReference;
      this.MUIPanel;
      this.MUIPanelLoaded = false;
   },
   
   //Public accessor and mutator methods
   construct: function(){
      this.parent();
   },
   
   destroy: function(){
      this.parent();
      this.columnReference = null;
   },
   
   onMUIPanelLoaded: function(){
      this.logger.trace( this.options.componentName + ".construct() of '" + this.name + "'s MUIPanel finished." );
      this.MUIPanelLoaded = true;
      this.constructionChain.callChain();
   },
   
   unmarshall: function(){
      this.unmarshallProperties();
      this.unmarshallPanelProperties();
      this.unmarshallHeader();
      this.unmarshallPlugin();
      this.unmarshallDocument();
      this.parent();
   },
   
   //Properties
   getColumnReference: function() { return this.columnReference; },
   getContentUrl: function() { return this.contentUrl; },
   getDocument: function() { return this.document; },
   getDocumentContentUri: function() { return this.documentContentUri; },
   getDocumentDefinitionUri: function() { return this.documentDefinitionUri; },
   getDocumentWrapperId: function() { return this.documentWrapperId; },
   getDocumentWrapperStyle: function() { return this.documentWrapperStyle; },
   getDocumentWrapperTag: function() { return this.documentWrapperTag; },
   getHeader: function() { return this.header; },
   getMUIPanel: function() { return this.MUIPanel; },
   getName: function() { return this.name; },
   getPlugin: function() { return this.plugin; },
   getShowHeader: function() { return this.showHeader; },
   getState: function() { return this.state; },
   getTitle: function() { return this.title; },
   getToolBox: function() { return this.header; },
   isSuccess: function() { return this.error == null; },
   
   //Protected, private helper methods
   compileConstructionChain: function(){
      this.constructionChain.chain(
         this.restoreComponentState,
         this.instantiateMUIPanel,
         this.determineComponentElements,
         this.constructHeader,
         this.createContentAreaElement,
         this.constructPlugin,
         this.constructDocument,
         this.addScrollBars,
         this.subscribeToWebUIMessages,
         this.finalizeConstruction
      );
   }.protect(),
   
   compileDestructionChain: function(){
      this.destructionChain.chain( this.destroyComponents, this.resetProperties, this.destroyHtmlElement, this.destroyMUIPanel, this.finalizeDestruction );
   }.protect(),
   
   destroyMUIPanel: function(){
      if( this.MUIPanel ){
         this.MUIPanel.removeEvents();
         this.MUIPanel.destroy();
         this.MUIPanel = null;
      }
      
      this.destructionChain.callChain();
   }.protect(),
   
   determinePanelElement: function(){
      this.componentRootElement = $( this.name + this.options.panelIdPostfix );
      this.componentRootElement = $( this.componentRootElement );     //required by Internet Explorer
      this.panelContentElement = $( this.name );
      this.constructionChain.callChain();
   }.protect(),
   
   instantiateMUIPanel: function(){
      var panelTitle = this.header && this.header.getPlugin() ? "" : this.title;
      try{
         this.MUIPanel = new MUI.Panel({
            column : this.columnReference,
            content : "",
            onContentLoaded : this.header ? null : this.onMUIPanelLoaded,
            contentURL : this.contentUrl,
            id : this.name,
            header : this.showHeader,
            headerToolbox : this.header ? true : false,
            headerToolboxOnload : this.header ? this.onMUIPanelLoaded : null,
            headerToolboxURL : this.header ? this.header.getToolBoxUrl() : null,
            height : this.height,
            onResize : this.onContainerResize,
            scrollbars : true,
            title : panelTitle 
         });
      }catch( exception ){
         var logMessage = exception.name + ": " + exception.message;
         logMessage += exception.stack ? "\n" + exception.stack : "";
         this.logger.error( logMessage );
         this.fireEvent('constructed', this, this.options.eventFireDelay ); //Needed by Desktop, to able to count panels created.
         this.onConstructionError( exception );
      }
   }.protect(),
   
   loadHtmlDocument: function( webUIMessage ){
      this.documentContentUri = webUIMessage.getDocumentURI();
      this.documentContentType = webUIMessage.getDocumentType(); 
      var documentFullURI = this.documentContentUri + this.options.documentNameSeparator + this.resourceBundle.getLocale().getLanguage() + ".html";
      
      MUI.updateContent({
         element: $( this.name ),
         onContentLoaded : this.onDocumentReady,
         padding: { top: 0, right: 5, bottom: 0, left: 5 },
         title: this.title,
         url: documentFullURI
      });
   }.protect(),
   
   unmarshallPanelProperties: function(){
      this.columnReference = XmlResource.determineAttributeValue( this.definitionElement, this.options.columnReferenceSelector );
   }.protect(),  
});
/*
Name: DekstopPanelHeader

Description: Represents the header element of a desktop panel component of a SmartDocument.

Requires:

Provides:
    - DesktopPanelHeader

Part of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. 
http://www.processpuzzle.com

Authors: 
    - Zsolt Zsuffa

Copyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the 
GNU General Public License as published by the Free Software Foundation, either version 3 of the License, 
or (at your option) any later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/




var DesktopPanelHeader = new Class({
   Implements: [Events, Options],
   Binds: ['construct', 'onPluginConstructed', 'onPluginConstructionError'],   
   
   options: {
      componentName : "DesktopPanelHeader",
      contentStyleSelector : "@contentStyle",
      contextRootPrefix : "",
      headerSelector : "panelHeader",
      pluginSelector : "plugin",
      toolboxContent : "JavaScript/Source/Desktop/EmptyToolboxContent.html",
      toolboxSelector : "toolBox",
      toolBoxUrlSelector : "@toolBoxUrl",
      type : "DesktopPanel"
   },
   
   //Constructor
   initialize: function( definitionElement, internationalization, options ){
      this.setOptions( options );
      
      this.contentStyle;
      this.contextElement;
      this.definitionElement = definitionElement;
      this.error = false;
      this.internationalization = internationalization;
      this.logger = Class.getInstanceOf( WebUILogger );
      this.plugin;
      this.state = DesktopPanelHeader.States.INITIALIZED;
      this.toolBox = null;
      this.toolBoxOnLoad = null;
      this.toolBoxUrl = this.options.toolboxContent;
   },
   
   //Public mutators and accessor methods
   construct: function( contextElement, where ){
      this.contextElement = contextElement;
      this.constructPlugin();
      this.addContentStyle();
   },
   
   destroy: function(){
      if( this.plugin ) this.plugin.destroy();
   },
   
   onPluginConstructed : function(){
      this.state = DesktopPanelHeader.States.CONSTRUCTED;      
      this.fireEvent( 'headerConstructed', this );
   },
   
   onPluginConstructionError: function(){
      this.error = true;
      this.revertConstruction();
      this.state = DesktopPanelHeader.States.INITIALIZED;
      this.fireEvent( 'headerConstructionError', this );
   },
   
   unmarshall: function(){
      this.contentStyle = XmlResource.selectNodeText( this.options.contentStyleSelector, this.definitionElement );
      this.toolBoxUrl = XmlResource.selectNodeText( this.options.toolBoxUrlSelector, this.definitionElement );
      if( !this.toolBoxUrl ) this.toolBoxUrl = this.options.contextRootPrefix + this.options.toolboxContent;
      var pluginDefinition = XmlResource.selectNode( this.options.pluginSelector, this.definitionElement );
      if( pluginDefinition ){
         this.plugin = new DocumentPlugin( pluginDefinition, this.internationalization, { onConstructed : this.onPluginConstructed, onConstructionError : this.onPluginConstructionError });
         this.plugin.unmarshall();
      }
      this.state = DesktopPanelHeader.States.UNMARSHALLED;      
   },

   //Properties
   getContentStyle: function() { return this.contentStyle; },
   getDefinitionElement: function() { return this.definitionElement; },
   getHeaderToolBox: function() { return this.plugin != null; },
   getPlugin: function() { return this.plugin; },
   getState: function() { return this.state; },
   getToolBoxUrl: function() { return this.toolBoxUrl; },
   
   //Protected, private helper methods
   addContentStyle: function(){
      if( this.contentStyle ){
         this.contextElement.getElementById( this.contextElement.get( 'id' ) + "Content" ).addClass( this.contentStyle );
      }
   }.protect(),
   
   constructPlugin: function(){
      if( this.plugin ) this.plugin.construct();
      else this.onPluginConstructed();
   }.protect(),
   
   revertConstruction: function(){
      if( this.plugin ) this.plugin.destroy();
   }
});

DesktopPanelHeader.States = { UNINITIALIZED : 0, INITIALIZED : 1, UNMARSHALLED : 2, CONSTRUCTED : 3 };
/*
ProcessPuzzle User Interface
Backend agnostic, desktop like configurable, browser font-end based on MochaUI.
Copyright (C) 2011  Joe Kueser, Zsolt Zsuffa

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/




var DesktopStructure = new Class({
	Implements : [Options], 
	options : {
		desktopColumnIdSelector : 'name',
		desktopColumnMaximumWidthSelector : 'maximumWidth',
		desktopColumnMinimumWidthSelector : 'minimumWidth',
		desktopColumnPlacementSelector : 'placement',
		desktopColumnWidthSelector : 'width',
		desktopColumnsSelector : '/pp:desktopConfiguration/columns/column',
		desktopElementId : 'desktop',
		desktopPanelColumnSelector : 'columnReference',
		desktopPanelContentUrlSelector : 'contentURL',
		desktopPanelHeightSelector : 'height',
		desktopPanelIdSelector : 'name',
		desktopPanelRequireSelector : 'require',
		desktopPanelsSelector : '/pp:desktopConfiguration/panels/panel',
		desktopPanelTitleSelector : 'title',
		dockerAutoHideId : 'dockAutoHide',
		dockerClearId : 'dockClear',
		dockerClearClass : 'clear',
		dockerControlsId : 'dock',
		dockerPlacementId : 'dockPlacement',
		dockerSelector : '/pp:desktopConfiguration/windowDocker',
		dockerSortId : 'dockSort',
		dockerWrapperId : 'dockWrapper',
		documentContainerId : 'pageWrapper',
		elementsSelector : 'elements/element',
		footerBarSelector : '/pp:desktopConfiguration/footer/footerBar',
		footerBarElementId : 'desktopFooter',
		footerElementId : 'desktopFooterWrapper',
		footerSelector : '/pp:desktopConfiguration/footer',
		headerElementId : 'desktopHeader',
		headerSelector : '/pp:desktopConfiguration/header',
		navigationBarSelector : '/pp:desktopConfiguration/header/navigationBar',
		navigationBarElementId : 'desktopNavbar',
		idAttributeSelector : '@name',
		styleSheetElementsSelector : 'pp:desktopConfiguration/resources/styleSheets/styleSheet',
		tagAttributeSelector : '@tag',
		titleBarSelector : '/pp:desktopConfiguration/header/titleBar',
		titleBarWrapperId : 'desktopTitlebarWrapper'
	},
	
	//Constructor
	initialize : function( options, configurationXml ) {
		this.setOptions( options );

	//Private instance variables
		this.configurationXml = configurationXml;
		this.desktopColumns = new ArrayList();
		this.desktopElement = $( this.options.desktopElementId );
		this.desktopPanels = new ArrayList();
		this.desktopWindows = new ArrayList();
		this.documentContainerElement = null;
		this.footerBarElement = null;
		this.footerElement = null;
		this.headerElement = null;
		this.navigationBarElement = null;
		this.titleBarElement = null;
		this.titleBarWrapperElement = null;
	},
	
	//Public accessor and mutator methods
	addDesktopColumn : function( desktopColumn ) {
		this.desktopColumns.add( desktopColumn );
	},
	
	determineDesktopElementId : function() {
		return this.desktopElement != null ? this.desktopElement.get( 'id' ) : this.options.desktopElementId;
	},
	
	determineHeaderElementId : function() {
		return this.headerElement != null ? this.headerElement.get( 'id' ) : this.options.headerElementId;
	},
	
	determineFooterElementId : function() {
		return this.footerElement != null ? this.footerElement.get( 'id' ) : this.options.footerElementId;
	},
	
	determineNavigationBarElementId : function() {
		return this.navigationBarElement != null ? this.navigationBarElement.get( 'id' ) : this.options.navigationBarElementId;
	},
	
	determineDocumentContainerElementId : function() {
		return this.documentContainerElement != null ? this.documentContainerElement.get( 'id' ) : this.options.documentContainerElementId;
	},
	
	determineFooterBarElementId : function() {
		return this.footerBarElement != null ? this.footerBarElement.get( 'id' ) : this.options.footerBarElementId;
	},
	
	//Properties
	getDesktopColumnIdSelector : function() { return this.options.desktopColumnIdSelector; },
	getDesktopColumnMaximumWidthSelector : function() { return this.options.desktopColumnMaximumWidthSelector; },
	getDesktopColumnMinimumWidthSelector : function() { return this.options.desktopColumnMinimumWidthSelector; },
	getDesktopColumnPlacementSelector : function() { return this.options.desktopColumnPlacementSelector; },
	getDesktopColumnWidthSelector : function() { return this.options.desktopColumnWidthSelector; },
	getDesktopColumns : function() { return this.desktopColumns; },
	getDesktopColumnsSelector : function() { return this.options.desktopColumnsSelector; },
	getDesktopElement : function() { return this.desktopElement; },
	getDesktopPanelContentUrlSelector : function() { return this.options.desktopPanelContentUrlSelector; },
	getDesktopPanelColumnSelector : function() { return this.options.desktopPanelColumnSelector; },
	getDesktopPanelHeightSelector : function() { return this.options.desktopPanelHeightSelector; },
	getDesktopPanelIdSelector : function() { return this.options.desktopPanelIdSelector; },
	getDesktopPanelRequireSelector : function() { return this.options.desktopPanelRequireSelector; },
	getDesktopPanels : function() { return this.desktopPanels; },
	getDesktopPanelsSelector : function() { return this.options.desktopPanelsSelector; },
	getDesktopPanelTitleSelector : function() { return this.options.desktopPanelTitleSelector; },
	getDesktopWindows : function() { return this.desktopWindows; },
	getDocumentContainerElement : function() { return this.documentContainerElement; },
	getDocumentContainerId : function() { return this.options.documentContainerId; },
	getElementsSelector : function() { return this.options.elementsSelector; },
	getFooterBarElement : function() { return this.footerBarElement; },
	getFooterBarSelector : function() { return this.options.footerBarSelector; },
	getFooterElement : function() { return this.footerElement; },
	getFooterSelector : function() { return this.options.footerSelector; },
	getHeaderElement : function() { return this.headerElement; },
	getHeaderSelector : function() { return this.options.headerSelector; },
	getIdAttributeSelector : function() { return this.options.idAttributeSelector; },
	getNavigationBarElement : function() { return this.navigationBarElement; },
	getNavigationBarSelector : function() { return this.options.navigationBarSelector; },
	getStyleSheetByIndex : function( styleSheetIndex ) {
	   var styleSheetElement = this.getStyleSheetElementByIndex( styleSheetIndex );
	   return this.configurationXml.selectNode( "text()", styleSheetElement ).nodeValue; 
	},
   getStyleSheetElementByIndex : function( styleSheetIndex ) { return this.getStyleSheetElements()[styleSheetIndex]; },
	getStyleSheetElements : function() { return this.configurationXml.selectNodes( this.options.styleSheetElementsSelector ); },
	getTagAttributeSelector : function() { return this.options.tagAttributeSelector; },
	getTitleBarElement : function() { return this.titleBarElement; },
	getTitleBarSelector : function() { return this.options.titleBarSelector; },
	getTitleBarWrapperElement : function() { return this.titleBarWrapperElement; },
	getTitleBarWrapperId : function() { return this.options.titleBarWrapperId; },
	getWindowDockerAutoHideId : function() { return this.options.dockerAutoHideId; },
	getWindowDockerClearId : function() { return this.options.dockerClearId; },
	getWindowDockerClearClass : function() { return this.options.dockerClearClass; },
	getWindowDockerControlsId : function() { return this.options.dockerControlsId; },
	getWindowDockerId : function() { return this.options.dockerWrapperId; },
	getWindowDockerPlacementId : function() { return this.options.dockerPlacementId; },
	getWindowDockerSelector : function() { return this.options.dockerSelector; },
	getWindowDockerSortId : function() { return this.options.dockerSortId; },
	
	setDesktopElement : function( desktopElement ) { this.desktopElement = desktopElement; },
	setDocumentContainerElement : function( documentContainerElement ) { this.documentContainerElement = documentContainerElement; },
	setFooterBarElement : function( footerBarElement ) { this.footerBarElement = footerBarElement; },
	setFooterElement : function( footerElement ) { this.footerElement = footerElement; },
	setHeaderElement : function( headerElement ) { this.headerElement = headerElement; },
	setNavigationBarElement : function( navigationBarElement ) { this.navigationBarElement = navigationBarElement; },
	setTitleBarElement : function( titleBarElement ) { this.titleBarElement = titleBarElement; },
	setTitleBarWrapperElement : function( titleBarWrapperElement ) { this.titleBarWrapperElement = titleBarWrapperElement; }
	
	//Private methods
});
/*
Name: 
   - DesktopWindow

Description: 
   - Represents a window within desktop. It's wrapper of MochaUI column, which gets it's properties from an XML descriptor. 

Requires:
   - DesktopElement, ComplexContentBehaviour

Provides:
   - DesktopWindow

Part of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. 
http://www.processpuzzle.com

Authors: 
   - Zsolt Zsuffa

Copyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the 
GNU General Public License as published by the Free Software Foundation, either version 3 of the License, 
or (at your option) any later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/





var DesktopWindow = new Class({
   Extends: DesktopElement,
   Implements: [ComplexContentBehaviour],
   Binds: [
      'addScrollBars',
      'constructDocument',
      'constructHeader',
      'constructPlugin',
      'createContentAreaElement',
      'destroy',
      'destroyMUIWindow',
      'determineComponentElements', 
      'finalizeConstruction',
      'instantiateMUIWindow', 
      'loadHtmlDocument',
      'loadSmartDocument',
      'onContainerResize', 
      'onDocumentError', 
      'onDocumentReady', 
      'onHeaderConstructed', 
      'onHeaderConstructionError',
      'onMUIWindowLoaded',
      'onPluginConstructed',
      'onPluginError',
      'restoreComponentState',
      'subscribeToWebUIMessages',
      'webUIMessageHandler'],
   options : {
      componentContainerId : "desktop",
      componentContentIdPostfix : "_content",
      componentName : "DesktopWindow",
      componentRootElementIdPostfix: "",
   },

   //Constructor
   initialize: function( definitionElement, internationalization, options ){
      this.parent( definitionElement, internationalization, options );
      this.MUIWindow;
      this.onReadyCallBack;
   },
   
   //Public accessor and mutator methods
   construct: function( onReadyCallback ){
      this.onReadyCallBack = onReadyCallback;
      this.parent();
   },
   
   destroy: function(){
      this.parent();
   },
   
   onMUIWindowLoaded : function(){
      this.constructionChain.callChain();
   },
   
   unmarshall: function(){
      this.unmarshallProperties();
      this.unmarshallWindowProperties();
      this.unmarshallHeader();
      this.unmarshallPlugin();
      this.unmarshallDocument();
      this.parent();
   },
   
   //Properties
   getMUIWindow: function() { return this.MUIWindow; },
   getOnReadyCallback: function() { return this.onReadyCallBack; },
   getWindowContentElement: function() { return this.contentContainerElement; },
   getWindowElement: function() { return this.componentRootElement; },
   
   //Protected, private helper methods
   compileConstructionChain: function(){
      this.constructionChain.chain( 
         this.instantiateMUIWindow, 
         this.determineComponentElements, 
         this.constructHeader,
         this.createContentAreaElement,
         this.constructPlugin,
         this.constructDocument,
         this.addScrollBars,
         this.subscribeToWebUIMessages,
         this.finalizeConstruction
      );
   }.protect(),
   
   compileDestructionChain: function(){
      this.destructionChain.chain( this.destroyComponents, this.resetProperties, this.destroyHtmlElement, this.destroyMUIWindow, this.finalizeDestruction );
   }.protect(),
   
   destroyMUIWindow: function(){
      if( this.MUIWindow ){
         this.MUIWindow.removeEvents();
         this.MUIWindow.destroy();
         this.MUIWindow = null;
      }
      
      this.destructionChain.callChain();
   }.protect(),
   
   instantiateMUIWindow: function(){
      if( this.contentUrl ) this.internationalizeContentUri();
      
      this.MUIWindow = new MUI.Window({
         container : this.containerElement,
         contentURL : this.contentUrl ? this.contentUrl : null,
         height : this.height,
         id : this.name,
         onClose : this.destroy,
         onContentLoaded : this.contentUrl ? this.onMUIWindowLoaded : null,
         onResize : this.onContainerResize,
         title : this.internationalization.getText( this.title ),
         width : this.width
      });
            
      if( !this.contentUrl ) this.constructionChain.callChain();
   }.protect(),
   
   unmarshallWindowProperties: function(){
   }.protect(),
});

DesktopWindow.Activity = { SHOW_WINDOW : 'showWindow', SHOW_NOTIFICATION : 'showNotification' };
/*
Name: NoneExistingDesktopContainerElementException

Description: Thrown when the specified desktop container element doesn't exist.

Requires: WebUIException

Provides: NoneExistingDesktopContainerElementException

Part of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. 
http://www.processpuzzle.com

Authors: 
	- Zsolt Zsuffa

Copyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the 
GNU General Public License as published by the Free Software Foundation, either version 3 of the License, 
or (at your option) any later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/




var NoneExistingDesktopContainerElementException = new Class({
   Extends: WebUIException,
   options: {
      description: "The specifified desktop container element: '{desktopContainerId}' doesn't exist.",
      name: "NoneExistingDesktopContainerElementException"
   },
   
   //Constructor
   initialize : function( desktopContainerId, options ){
      this.setOptions( options );
      this.parent( options );
      this.parameters = { desktopContainerId : desktopContainerId };
   }	
});
/*
ProcessPuzzle User Interface
Backend agnostic, desktop like configurable, browser font-end based on MochaUI.
Copyright (C) 2011  Joe Kueser, Zsolt Zsuffa

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/




var PanelInterpreter = new Class({
	Implements : [Options], 
	options : {
		headerSelector : "panelHeader",
		pluginSelector : "plugin",
		toolboxContent : "../Desktop/EmptyToolboxContent.html"
	},
	
	//Constructor
	initialize: function( panelConfiguration, options ){
		this.setOptions( options );
		this.headerToolBox = false;
		this.headerToolBoxOnLoad = null;
		this.headerToolBoxURL = this.options.toolboxContent;
		this.panelConfiguration = panelConfiguration;
		this.headerPlugin = null;
	},

	//Public accessor and mutator methods
	interpret: function(){
		this.interpretPanelHeader();
	},

	//Properties
	getHeaderPlugin : function() { return this.headerPlugin; },
	getHeaderToolBox : function() { return this.headerToolBox; },
	getHeaderToolBoxOnLoad : function() { return this.headerToolBoxOnLoad; },
	getHeaderToolBoxURL : function() { return this.headerToolBoxURL; },
	
	//Protected, private helper methods
	interpretPanelHeader: function(){
		var headerConfigurationElement = XmlResource.selectNode( this.options.headerSelector, this.panelConfiguration );
		if( headerConfigurationElement ){
			this.headerToolBox = true;
			
			this.interpretPlugin( headerConfigurationElement );
			this.headerToolBoxOnLoad = this.headerPlugin['onload'];
		}
	}.protect(),
	
	interpretPlugin: function( parentConfigurationElement ) {
		this.headerPlugin = { css: [], images: [], js: [], onload: null };
		var pluginText =	XmlResource.selectNodeText( this.options.pluginSelector, parentConfigurationElement );
		this.headerPlugin = pluginText != null ? eval( "(" + pluginText + ")" ) : this.headerPlugin;
	}
});
//UnconfiguredWidget.js




var ResourceLoadTimeoutException = new Class({
   Extends: WebUIException,
   options: {
      description: "Loading one or more resources exceeded the '{resourceLoadTimeout}' ms timeout period.",
      name: "ResourceLoadTimeoutException"
   },
   
   //Constructor
   initialize : function( resourceLoadTimeout, options ){
      this.setOptions( options );
      this.parent( options );
      this.parameters = { resourceLoadTimeout : resourceLoadTimeout };
   }
});
//UnconfiguredWidget.js




var ResourceNotFoundException = new Class({
   Extends: WebUIException,
   options: {
      description: "Resource '{resourceName}' not found.",
      name: "ResourceNotFoundException"
   },
   
   //Constructor
   initialize : function( resourceName, options ){
      this.setOptions( options );
      this.parent( options );
      this.parameters = { resourceName : resourceName };
   }
});
/*
Name: UnconfiguredDesktopElementException

Description: Thrown when a DesktopElement's method is invoked but the object isn't configure appropriately.

Requires: WebUIException

Provides: UnconfiguredDesktopElementException

Part of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. 
http://www.processpuzzle.com

Authors: 
	- Zsolt Zsuffa

Copyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the 
GNU General Public License as published by the Free Software Foundation, either version 3 of the License, 
or (at your option) any later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/




var UnconfiguredDesktopElementException = new Class({
   Extends: WebUIException,
   options: {
      description: "When calling method: '{methodName}' of a DocumentElement it should be in: '{statusName}' .",
      name: "UnconfiguredDesktopElementException"
   },
   
   //Constructor
   initialize : function( methodName, statusName, options ){
      this.setOptions( options );
      this.parent( options );
      this.parameters = { methodName : methodName, statusName : statusName };
   }	
});
/*
Name: WindowDocker

Description: Represents the window docker component of a the desktop.

Requires:

Provides:
    - WindowDocker

Part of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. 
http://www.processpuzzle.com

Authors: 
    - Zsolt Zsuffa

Copyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the 
GNU General Public License as published by the Free Software Foundation, either version 3 of the License, 
or (at your option) any later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/





var WindowDocker = new Class({
   Extends: DesktopElement,
   Binds: ['createDockerElements', 'injectDockerElement'],   
   options: {
      componentName : "WindowDocker",
      dockerAutoHideId : 'dockAutoHide',
      dockerClearId : 'dockClear',
      dockerClearClass : 'clear',
      dockerControlsId : 'dock',
      dockerPlacementId : 'dockPlacement',
      dockerSelector : '/desktopConfiguration/windowDocker',
      dockerSortId : 'dockSort',
      dockerWrapperId : 'dockWrapper'
   },
   
   //Constructor
   initialize: function( definitionElement, bundle, options ){
      this.parent( definitionElement, bundle, options );
      this.dockerAutoHideElement;
      this.dockerClearElement;
      this.dockerControlsElement;
      this.dockerPlacementElement;
      this.dockerSortElement;
   },
   
   //Public mutators and accessor methods
   construct: function(){
      this.parent();
   },
   
   destroy: function(){
      this.parent();
   },
   
   unmarshall: function(){
      this.unmarshallElementProperties();
      this.parent();
   },

   //Properties
   
   //Protected, private helper methods
   compileConstructionChain: function(){
      this.constructionChain.chain( this.createDockerElements, this.createHtmlElement, this.injectDockerElement, this.finalizeConstruction );
   }.protect(),
   
   compileDestructionChain: function(){
      this.destructionChain.chain( this.destroyComponents, this.resetProperties, this.destroyHtmlElement, this.finalizeDestruction );
   }.protect(),
   
   createDockerElements: function(){
      this.dockerControlsElement = new Element( 'div', { id : this.options.dockerControlsId });
      this.dockerPlacementElement = new Element( 'div', { id : this.options.dockerPlacementId });
      this.dockerAutoHideElement = new Element( 'div', { id : this.options.dockerAutoHideId });
      this.dockerSortElement = new Element( 'div', { id : this.options.dockerSortId } );
      this.dockerClearElement = new Element( 'div', { id : this.options.dockerClearId, 'class' : this.options.dockerClearClass });
      
      this.constructionChain.callChain();
   }.protect(),
   
   destroyComponents: function(){
      this.dockerClearElement.destroy();
      this.dockerSortElement.destroy();
      this.dockerAutoHideElement.destroy();
      this.dockerPlacementElement.destroy();
      
      this.destructionChain.callChain();
   }.protect(),
   
   injectDockerElement: function(){
      this.htmlElement.grab( this.dockerControlsElement, 'bottom' );
      this.dockerControlsElement.grab( this.dockerPlacementElement, 'bottom' );
      this.dockerControlsElement.grab( this.dockerAutoHideElement, 'bottom' );
      this.dockerControlsElement.grab( this.dockerSortElement, 'bottom' );
      this.dockerSortElement.grab( this.dockerClearElement, 'bottom' );
      
      this.constructionChain.callChain();
   }.protect(),
   
   resetProperties: function(){
      this.dockerAutoHideElement = null;
      this.dockerClearElement = null;
      this.dockerControlsElement = null;
      this.dockerPlacementElement = null;
      this.dockerSortElement = null;
      
      this.destructionChain.callChain();
   }.protect()
   
});
/*
Name: 
    - DiagramWidget

Description: 
    - Shows an editable Visio like diagram to the user.

Requires:
    - BrowserWidget, Draw2d

Provides:
    - DiagramWidget

Part of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. 
http://www.processpuzzle.com

Authors: 
    - Zsolt Zsuffa

Copyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the 
GNU General Public License as published by the Free Software Foundation, either version 3 of the License, 
or (at your option) any later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/





var DiagramWidget = new Class({
   Extends : BrowserWidget,
   Binds : ['destroyCanvas', 'destroyFigures', 'drawCanvas', 'drawFigures', 'onFigureConstructed', 'onFigureConstructionError'],
   
   options : {
      authorSelector : "//pp:widgetDefinition/author",
      canvasHeightDefault : 200,
      canvasHeightSelector : "//pp:widgetDefinition/canvas/@height",
      canvasWidthDefault : 300,
      canvasWidthSelector : "//pp:widgetDefinition/canvas/@width",
      componentName : "DiagramWidget",
      descriptionSelector : "//pp:widgetDefinition/description",
      figuresSelector : "//pp:widgetDefinition/figures/annotation | //pp:widgetDefinition/figures/class | //pp:widgetDefinition/figures/inheritanceConnection",
      nameSelector : "//pp:widgetDefinition/name",
      paintAreaId : "paintarea",
      titleSelector : "//pp:widgetDefinition/title",
      widgetContainerId : "DiagramWidget",
      widgetDefinitionURI : "MenuDefinition.xml"
   },
   
   //Constructor
   initialize : function( options, resourceBundle ){
      this.parent( options, resourceBundle );
      
      this.author;
      this.canvas;
      this.canvasHeight;
      this.canvasWidth;
      this.description;
      this.figures = new ArrayList();
      this.figuresConstructionChain = new Chain();
      this.name;
      this.title;
      this.paintArea;
   },
   
   //Public accessor and mutator methods
   construct : function( configurationOptions ) {
      this.parent();
   },
   
   destroy : function() {
      this.parent();
   },
      
   onFigureConstructed: function( figure ){
      this.figuresConstructionChain.callChain();
   },
   
   onFigureConstructionError: function( error ){
      this.error = error;
      this.revertConstruction();
   },
   
   unmarshall: function(){
      this.unmarshallProperties();
      this.unmarshallFigures();
      return this.parent();
   },
   
   //Properties
   getAuthor : function() { return this.author; },
   getCanvas : function() { return this.canvas; },
   getCanvasHeight : function() { return this.canvasHeight; },
   getCanvasWidth : function() { return this.canvasWidth; },
   getDescription : function() { return this.i18Resource.getText( this.description ); },
   getFigures : function() { return this.figures; },
   getName : function() { return this.name; },
   getTitle : function() { return this.i18Resource.getText( this.title ); },
   getPaintArea : function() { return this.paintArea; },
   
   //Private helper methods
   compileConstructionChain: function(){
      this.constructionChain.chain( this.drawCanvas, this.drawFigures, this.finalizeConstruction );
   }.protect(),
   
   compileDestructionChain: function(){
      this.destructionChain.chain( this.destroyFigures, this.destroyCanvas, this.destroyChildHtmlElements, this.finalizeDestruction );
   }.protect(),
   
   destroyCanvas : function(){
      if( this.paintArea && this.paintArea.destroy ) this.paintArea.destroy();
      
      this.destructionChain.callChain();
   }.protect(),
   
   destroyFigures : function(){
      this.figures.each( function( figure, index ){
         figure.destroy();
      }.bind( this ));
      
      this.figures.clear();
      
      this.destructionChain.callChain();
   }.protect(),
   
   drawCanvas : function(){
      this.paintArea = this.elementFactory.create( 'div', null, this.containerElement, WidgetElementFactory.Positions.LastChild, { 
            id : this.options.paintAreaId,
            styles : { height : this.canvasHeight, width : this.canvasWidth }
         });
      this.canvas = new draw2d.Workflow( this.options.paintAreaId );
      
      this.constructionChain.callChain();
   }.protect(),
   
   drawFigures : function(){
      if( this.figures.size() > 0 ){
         this.figures.each( function( figure, index ){
            this.figuresConstructionChain.chain( function(){ figure.draw( this ); }.bind( this ));
         }, this );
            
         this.figuresConstructionChain.chain(
            function(){
               this.figuresConstructionChain.clearChain();
               this.constructionChain.callChain(); 
            }.bind( this )
         );
         this.figuresConstructionChain.callChain();
      }else this.constructionChain.callChain();
   }.protect(),
   
   unmarshallFigures: function(){
      var figuresElement = this.definitionXml.selectNodes( this.options.figuresSelector );
      if( figuresElement ){
         figuresElement.each( function( figureElement, index ){
            var figure = DiagramFigureFactory.create( figureElement, this.i18Resource, { 
               onFigureConstructed : this.onFigureConstructed, 
               onFigureConstructionError : this.onFigureConstructionError 
            });
            figure.unmarshall();
            this.figures.add( figure );
         }, this );
      }
   }.protect(),
   
   unmarshallProperties: function(){
      this.name = this.unmarshallWidgetProperty( null, this.options.nameSelector );
      this.description = this.unmarshallWidgetProperty( "", this.options.descriptionSelector );
      this.title = this.unmarshallWidgetProperty( "", this.options.titleSelector );
      this.author = this.unmarshallWidgetProperty( "", this.options.authorSelector );
      this.canvasHeight = parseInt( this.unmarshallWidgetProperty( this.options.canvasHeightDefault, this.options.canvasHeightSelector ));
      this.canvasWidth = parseInt( this.unmarshallWidgetProperty( this.options.canvasWidthDefault, this.options.canvasWidthSelector ));
   }.protect(),
   
   unmarshallWidgetProperty: function( defaultValue, selector ){
      var propertyValue = this.definitionXml.selectNodeText( selector );
      if( propertyValue ) return propertyValue;
      else return defaultValue;
   }.protect()
});
/*
Name: 
    - DiagramFigure

Description: 
    - Represents an abstract element of DiagramWidget's figure. 

Requires:

Provides:
    - DiagramFigure

Part of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. 
http://www.processpuzzle.com

Authors: 
    - Zsolt Zsuffa

Copyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the 
GNU General Public License as published by the Free Software Foundation, either version 3 of the License, 
or (at your option) any later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/





var DiagramFigure = new Class({
   Implements : [Events, Options],
   Binds: ['addFigureToCanvas', 'finalizeDraw'],
   
   options : {
      componentName : "DiagramFigure",
      nameSelector : "@name",
      positionXSelector : "@positionX",
      positionYSelector : "@positionY"
   },

   //Constructor
   initialize: function( definitionXmlElement, internationalization, options ){
      this.setOptions( options );
      
      this.canvas;
      this.definitionXml = definitionXmlElement;
      this.diagram;
      this.draw2dObject;
      this.drawChain = new Chain();
      this.internationalization = internationalization;
      this.name;
      this.positionX;
      this.positionY;
      this.state = DiagramFigure.States.INITIALIZED;
   },
   
   //Public accessor and mutator methods
   destroy: function(){
      if( this.state == DiagramFigure.States.CONSTRUCTED ){
         this.removeFigureFromCanvas();
         this.state = DiagramFigure.States.INITIALIZED;
      }
   },
   
   draw: function( diagram ){
      assertThat( diagram, not( nil() ));
      this.diagram = diagram;
      this.canvas = diagram.getCanvas();
      this.compileDrawChain();
      this.drawChain.callChain();
   },
   
   unmarshall: function(){
      this.unmarshallProperties();
      this.state = DiagramFigure.States.UNMARSHALLED;
   },
   
   //Properties
   getDraw2dObject : function() { return this.draw2dObject; },
   getId: function() { return this.draw2dObject.id; },
   getInternationalizedName: function() { return this.internationalization.getText( this.getName()); },
   getName: function() { return this.name; },
   getPositionX: function() { return this.positionX; },
   getPositionY: function() { return this.positionY; },
   getState: function() { return this.state; },
   
   //Protected, private helper methods
   compileDrawChain : function(){
      this.drawChain.chain( this.instantiateDraw2dObject, this.addFigureToCanvas, this.finalizeDraw );
   }.protect(),
   
   addFigureToCanvas : function(){
      this.canvas.addFigure( this.draw2dObject, this.positionX, this.positionY );
      this.drawChain.callChain();
   }.protect(),
   
   finalizeDraw : function(){
      this.drawChain.clearChain();
      this.state = DiagramFigure.States.CONSTRUCTED;
      this.fireEvent( 'figureConstructed', this );
   }.protect(),
   
   lookUpDiagramFigure : function( figureName ){
      var searchedFigure = null;
      this.diagram.getFigures().each( function( figure, index ){
         if( figure.getName() == figureName ) 
            searchedFigure = figure;
      }.bind( this ));
      
      return searchedFigure;
   }.protect(),
   
   removeFigureFromCanvas : function(){
      this.canvas.removeFigure( this.draw2dObject );
   }.protect(),
   
   unmarshallProperties: function(){
      this.name = XmlResource.selectNodeText( this.options.nameSelector, this.definitionXml );
      this.positionX = XmlResource.selectNodeText( this.options.positionXSelector, this.definitionXml );
      this.positionY = XmlResource.selectNodeText( this.options.positionYSelector, this.definitionXml );
   }.protect()
});

DiagramFigure.States = { UNINITIALIZED : 0, INITIALIZED : 1, UNMARSHALLED : 2, CONSTRUCTED : 3 };
/*
Name: 
    - AnnotationFigure

Description: 
    - Represents an annotation figure. 

Requires:

Provides:
    - AnnotationFigure

Part of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. 
http://www.processpuzzle.com

Authors: 
    - Zsolt Zsuffa

Copyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the 
GNU General Public License as published by the Free Software Foundation, either version 3 of the License, 
or (at your option) any later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/






var AnnotationFigure = new Class({
   Extends : DiagramFigure,
   Implements : [Events, Options],
   Binds: ['instantiateDraw2dObject', 'drawAttributes', 'setDimension'],
   
   options : {
      componentName : "AnnotationFigure",
      textSelector : "text",
      heightSelector : "@height",
      widthSelector : "@width"
   },

   //Constructor
   initialize: function( definition, internationalization, options ){
      this.parent( definition, internationalization, options );
      
      this.height;
      this.text;
      this.width;
   },
   
   //Public accessor and mutator methods
   destroy: function(){
      this.parent();
   },
   
   draw: function( diagram ){
      this.parent( diagram );
   },
   
   unmarshall: function(){
      this.parent();
   },
   
   //Properties
   getHeight : function() { return this.height; },
   getText : function() { return this.text; },
   getWidth : function() { return this.width; },
   
   //Protected, private helper methods
   compileDrawChain : function(){
      this.drawChain.chain( this.instantiateDraw2dObject, this.setDimension, this.addFigureToCanvas, this.finalizeDraw );
   }.protect(),

   instantiateDraw2dObject : function(){
      this.draw2dObject = new draw2d.Annotation( this.text );
      this.drawChain.callChain();
   }.protect(),
   
   setDimension : function(){
      this.draw2dObject.setDimension( this.width, this.height );
      this.drawChain.callChain();
   }.protect(),
   
   unmarshallProperties: function(){
      this.text = XmlResource.selectNodeText( this.options.textSelector, this.definitionXml );
      if( this.text ) this.text = this.internationalization.getText( this.text );
      this.height = parseInt( XmlResource.selectNodeText( this.options.heightSelector, this.definitionXml ));
      this.width = parseInt( XmlResource.selectNodeText( this.options.widthSelector, this.definitionXml ));
      
      this.parent();
   }.protect()
   
});

/*
Name: 
    - AttributeFigure

Description: 
    - Represents an attribute of ClassFigure. 

Requires:

Provides:
    - AttributeFigure

Part of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. 
http://www.processpuzzle.com

Authors: 
    - Zsolt Zsuffa

Copyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the 
GNU General Public License as published by the Free Software Foundation, either version 3 of the License, 
or (at your option) any later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/






var AttributeFigure = new Class({
   Extends : DiagramFigure,
   Binds: [],
   
   options : {
      componentName : "AttributeFigure",
      defaultValueSelector : "@defaultValue",
      nameSelector : "@name",
      typeSelector : "@type"
   },

   //Constructor
   initialize: function( definition, internationalization, options ){
      this.setOptions( options );
      
      this.defaultValue;
      this.definitionXml = definition;
      this.internationalization = internationalization;
      this.name;
      this.type;
   },
   
   //Public accessor and mutator methods
   destroy: function(){
      this.parent();
   },
   
   draw: function( diagram ){
      this.parent( diagram );
   },
   
   unmarshall: function(){
      this.parent();
   },
   
   //Properties
   getDefaultValue : function() { return this.defaultValue; },
   getType : function() { return this.type; },
   
   //Protected, private helper methods
   unmarshallProperties : function(){
      this.type = XmlResource.selectNodeText( this.options.typeSelector, this.definitionXml );
      this.defaultValue = XmlResource.selectNodeText( this.options.defaultValueSelector, this.definitionXml );
      this.parent();
   }.protect()
});

/*
Name: 
    - ClassFigure

Description: 
    - Represents a figure of UML class. 

Requires:

Provides:
    - ClassFigure

Part of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. 
http://www.processpuzzle.com

Authors: 
    - Zsolt Zsuffa

Copyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the 
GNU General Public License as published by the Free Software Foundation, either version 3 of the License, 
or (at your option) any later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/






var ClassFigure = new Class({
   Extends : DiagramFigure,
   Implements : [Events, Options],
   Binds: ['instantiateDraw2dObject', 'drawAttributes'],
   
   options : {
      attributesSelector : "attributes/attribute",
      componentName : "ClassFigure"
   },

   //Constructor
   initialize: function( definition, internationalization, options ){
      this.parent( definition, internationalization, options );
      
      this.attributes = new ArrayList();
   },
   
   //Public accessor and mutator methods
   destroy: function(){
      this.parent();
   },
   
   draw: function( diagram ){
      this.parent( diagram );
   },
   
   unmarshall: function(){
      this.unmarshallAttributes();
      this.parent();
   },
   
   //Properties
   getAttributes : function() { return this.attributes; },
   
   //Protected, private helper methods
   compileDrawChain : function(){
      this.drawChain.chain( this.instantiateDraw2dObject, this.drawAttributes, this.addFigureToCanvas, this.finalizeDraw );
   }.protect(),

   drawAttributes : function(){
      this.attributes.each( function( attribute, index ){
         this.draw2dObject.addAttribute( attribute.getInternationalizedName(), attribute.getType(), attribute.getDefaultValue() );
      }.bind( this ));
      
      this.drawChain.callChain();
   }.protect(),
   
   instantiateDraw2dObject : function(){
      this.draw2dObject = new draw2d.shape.uml.Class( this.getInternationalizedName() );
      this.drawChain.callChain();
   }.protect(),
   
   unmarshallAttributes: function(){
      var attributesElement = this.definitionXml.selectNodes( this.options.attributesSelector );
      if( attributesElement ){
         if( !attributesElement.each ) attributesElement = Array.from( attributesElement );
         attributesElement.each( function( attributeElement, index ){
            var attribute = new AttributeFigure( attributeElement, this.internationalization );
            attribute.unmarshall();
            this.attributes.add( attribute );
         }, this );
      }
   }.protect()
   
});

/*
Name: 
    - ConnectionFigure

Description: 
    - Represents a connection between two figures. 

Requires:

Provides:
    - ConnectionFigure

Part of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. 
http://www.processpuzzle.com

Authors: 
    - Zsolt Zsuffa

Copyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the 
GNU General Public License as published by the Free Software Foundation, either version 3 of the License, 
or (at your option) any later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/






var ConnectionFigure = new Class({
   Extends : DiagramFigure,
   Implements : [Events, Options],
   Binds: ['instantiateDraw2dObject', 'linkSourceAndTarget'],
   
   options : {
      componentName : "ConnectionFigure",
      sourceSelector : "@source",
      targetSelector : "@target"
   },

   //Constructor
   initialize: function( definition, internationalization, options ){
      this.parent( definition, internationalization, options );
      
      this.sourceFigureName;
      this.targetFigureName;
   },
   
   //Public accessor and mutator methods
   destroy: function(){
      this.parent();
   },
   
   draw: function( diagram ){
      this.parent( diagram );
   },
   
   unmarshall: function(){
      this.parent();
   },
   
   //Properties
   getSourceFigureName : function() { return this.sourceFigureName; },
   getTargetFigureName : function() { return this.targetFigureName; },
   
   //Protected, private helper methods
   compileDrawChain : function(){
      this.drawChain.chain( this.instantiateDraw2dObject, this.linkSourceAndTarget, this.addFigureToCanvas, this.finalizeDraw );
   }.protect(),

   instantiateDraw2dObject : function(){
      this.draw2dObject = new draw2d.Connection( this.name );
      this.drawChain.callChain();
   }.protect(),
   
   linkSourceAndTarget : function(){
      var sourceFigure = this.lookUpDiagramFigure( this.sourceFigureName );
      var targetFigure = this.lookUpDiagramFigure( this.targetFigureName );
      this.draw2dObject.setSource( sourceFigure.getDraw2dObject().portTop );
      this.draw2dObject.setTarget( targetFigure.getDraw2dObject().portTop );
      this.drawChain.callChain();
   }.protect(),
   
   unmarshallProperties: function(){
      this.sourceFigureName = XmlResource.selectNodeText( this.options.sourceSelector, this.definitionXml );
      this.targetFigureName = XmlResource.selectNodeText( this.options.targetSelector, this.definitionXml );
      this.parent();
   }.protect()
});

/*
Name: DiagramFigureFactory

Description: Instantiates a new subclass of DiagramFigure according to the given XML element.

Requires:

Provides:
    - DiagramFigureFactory

Part of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. 
http://www.processpuzzle.com

Authors: 
    - Zsolt Zsuffa

Copyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the 
GNU General Public License as published by the Free Software Foundation, either version 3 of the License, 
or (at your option) any later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/





var DiagramFigureFactory = new Class({
   Implements: Options,
   
   options: {   
   },
   
   initialize: function(){
   },

   create: function( definitionXmlElement, internationalization, options ){
      var newFigure;
      switch( definitionXmlElement.tagName.toUpperCase() ){
      case "ANNOTATION": 
         newFigure = new AnnotationFigure( definitionXmlElement, internationalization, options ); break;
      case "CLASS": 
         newFigure = new ClassFigure( definitionXmlElement, internationalization, options ); break;
      case "INHERITANCECONNECTION":
      default:
         newFigure = new InheritanceConnectionFigure( definitionXmlElement, internationalization, options ); break;
      }
      
      return newFigure;
   }
});

DiagramFigureFactory.create = function(  definitionXmlElement, internationalization, options ){
   var factory = new DiagramFigureFactory();
   var figure = factory.create( definitionXmlElement, internationalization, options );
   return figure;
};
/*
Name: 
    - InheritanceConnectionFigure

Description: 
    - Represents a inheritance connection between two figures. 

Requires:

Provides:
    - InheritanceConnectionFigure

Part of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. 
http://www.processpuzzle.com

Authors: 
    - Zsolt Zsuffa

Copyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the 
GNU General Public License as published by the Free Software Foundation, either version 3 of the License, 
or (at your option) any later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/






var InheritanceConnectionFigure = new Class({
   Extends : ConnectionFigure,
   Implements : [Events, Options],
   Binds: ['instantiateDraw2dObject'],
   
   options : {
      componentName : "InheritanceConnectionFigure"
   },

   //Constructor
   initialize: function( definition, internationalization, options ){
      this.parent( definition, internationalization, options );
   },
   
   //Public accessor and mutator methods
   destroy: function(){
      this.parent();
   },
   
   draw: function( diagram ){
      this.parent( diagram );
   },
   
   unmarshall: function(){
      this.parent();
   },
   
   //Properties
   
   //Protected, private helper methods
   instantiateDraw2dObject : function(){
      this.draw2dObject = new draw2d.shape.uml.InheritanceConnection( this.name );
      this.drawChain.callChain();
   }.protect()
});

/*
Name: 
    - DocumentEditor

Description: 
    - Abstract class of all specialized SmartDocument editors. Standardize the interface for SmartDocuments and provides fundamental services. 

Requires:
    - 
    
Provides:
    - DocumentEditor

Part of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. 
http://www.processpuzzle.com

Authors: 
    - Zsolt Zsuffa

Copyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the 
GNU General Public License as published by the Free Software Foundation, either version 3 of the License, 
or (at your option) any later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/




var DocumentEditor = new Class({
   Implements: [Events, Options],
   Binds: ['determineStyleSheets', 'finalizeAttach', 'instantiateTools', 'subscribeToWebUIMessages', 'webUIMessageHandler'],
   options : {
      componentName : "DocumentEditor",
      subscribeToWebUIMessages : [],
   },

   //Constructor
   initialize: function( internationalization, options ){
      this.setOptions( options );
      this.internationalization = internationalization;
      
      //Private attributes
      this.attachChain = new Chain();
      this.lastWebUIMessage;
      this.logger = Class.getInstanceOf( WebUILogger );
      this.messageBus = Class.getInstanceOf( WebUIMessageBus );
      this.styleSheets = new ArrayList();
      this.subjectElement;
   },
   
   //Public accessor and mutator methods
   attach: function( subjectElement ){
      this.subjectElement = subjectElement;
      this.attachChain.chain( this.determineStyleSheets, this.instantiateTools, this.subscribeToWebUIMessages, this.finalizeAttach );
      this.attachChain.callChain();
   },
   
   detach: function(){
      this.destroyTools();
      this.writeOffFromWebUIMessages();
      this.finalizeDetach();
   },
   
   showNotification: function( notificationText ){
      var message = new MenuSelectedMessage({ originator : this.name, activityType : DesktopWindow.Activity.SHOW_NOTIFICATION, notification : this.options.componentName + "." + notificationText });
      this.messageBus.notifySubscribers( message );
   }, 
   
   showWindow: function( windowName ){
      var message = new MenuSelectedMessage({ originator : this.name, activityType : DesktopWindow.Activity.SHOW_WINDOW, windowName : windowName });
      this.messageBus.notifySubscribers( message );
   },
   
   webUIMessageHandler : function( webUIMessage ){
      var messageHandlerName = "this.on" + webUIMessage.getName();
      try{
         var messageHandler = eval( messageHandlerName );
         messageHandler( webUIMessage );
      }catch( e ){
         this.logger.debug( "'" + messageHandleName + "' should be implemented." );
      }
      this.lastWebUIMessage = webUIMessage;
   },
      
   //Properties
   getSubjectElement: function() { return this.subjectElement; },
   
   //Protected and private helper methods
   destroyTools: function(){
      //Abstract method, should be overwritten.
   }.protect(),
   
   determineStyleSheets: function(){
      var linkElements = this.subjectElement.getDocument().getElements( 'link' ); 
      linkElements.each( function( linkElement, index ){
         try{
            this.styleSheets.add( linkElement.get( 'href' ));
         }catch( e ){
            this.logger.error( this.options.componentName + ".determineStyleSheets() caused an error." );
         }
      }, this );
      this.attachChain.callChain();
   }.protect(),
   
   finalizeAttach: function(){
      this.attachChain.clearChain();
      this.fireEvent( 'editorAttached', this );
   }.protect(),
   
   finalizeDetach: function(){
      this.fireEvent( 'editorDetached', this );
   }.protect(),
   
   instantiateTools: function(){
      //Abstract method, should be overwritten in subclasses.
      this.attachChain.callChain();
   }.protect(),
   
   subscribeToWebUIMessages : function() {
      if( this.options.subscribeToWebUIMessages ){
         this.options.subscribeToWebUIMessages.each( function( messageClass, index ) {
            this.messageBus.subscribeToMessage( messageClass, this.webUIMessageHandler );
         }, this );
      }
      this.attachChain.callChain();
   }.protect(),

   writeOffFromWebUIMessages : function(){
      if( this.options.subscribeToWebUIMessages ){
         this.options.subscribeToWebUIMessages.each( function( messageClass, index ) {
            this.messageBus.writeOffFromMessage( messageClass, this.webUIMessageHandler );
         }, this );
      }
   }.protect(),
});
/*
Name: 
    - MenuItem

Description: 
    - Implements common behaviour of a menu item. It is abstract. 

Requires:

Provides:
    - MenuItem

Part of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. 
http://www.processpuzzle.com

Authors: 
    - Zsolt Zsuffa

Copyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the 
GNU General Public License as published by the Free Software Foundation, either version 3 of the License, 
or (at your option) any later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/




var MenuItem = new Class({
   Implements : [Events, Options],
   Binds: ['onClick'],
   
   options : {
      accordionBehaviour : false,
      accordionParent : "",
      captionSelector : "@caption",
      componentName : "MenuItem",
      contextItemId : "",
      href : "#",
      idPathSeparator : "/",
      isDefaultSelector : "@isDefault",
      menuItemIdSelector : "@menuItemId",
      messagePropertiesSelector : "messageProperties",
      parentItemId : "",
      selectedItemStyle : 'selectedMenuItem',
      showSubItems : false,
      target : "_self"
   },

   //Constructor
   initialize: function( definition, elementFactory, options ){
      this.setOptions( options );
      
      this.anchorElement;
      this.definitionXml = definition;
      this.caption;
      this.elementFactory = elementFactory;
      this.isDefault;
      this.listItemElement;
      this.menuItemId;
      this.messageProperties;
      this.parentHtmlElement;
      this.state = BrowserWidget.States.INITIALIZED;
   },
   
   //Public accessor and mutator methods
   addClassToListItem: function(){
      if( this.listItemElement ) this.listItemElement.addClass( this.options.selectedItemStyle );
   },
   
   construct: function( parentElement ){
      assertThat( parentElement, not( nil() ));
      this.parentHtmlElement = parentElement;
      if( this.state == BrowserWidget.States.UNMARSHALLED && this.needsToBeDisplayed() ) {
         this.instantiateHtmlElements();
         this.state = BrowserWidget.States.CONSTRUCTED;
         if( this.isDefault ) this.fireEvent( 'onDefaultItem', this );
      }
   },
   
   destroy: function(){
      if( this.anchorElement && this.anchorElement.destroy ) this.anchorElement.destroy();
      if( this.listItemElement && this.listItemElement.destroy ) this.listItemElement.destroy();
      this.state = BrowserWidget.States.INITIALIZED;
   },
   
   findItemById: function( itemFullId ){
      if( this.getFullId() == itemFullId ) return this;
      else return null;
   },
   
   needsToBeDisplayed: function(){
      return this.isContextItemUndefined() && this.isTheRootItem() ||
             this.isContextItemUndefined() && this.isDirectChildOfRootItem() ||
             this.isContextItemUndefined() && this.options.showSubItems ||
             this.isTheContextItem() ||
             this.isDirectChildOfContextItem() ||
             this.isChildOfContextItem() && this.options.showSubItems ||
             this.isDirectChildOfAccordionParent() && this.options.accordionBehaviour;
   },
   
   onClick : function() {
      this.addClassToListItem();
      this.fireEvent( 'onSelection', this );
   },
   
   removeClassFromListItem: function(){
      if( this.listItemElement && this.listItemElement.removeClass ) this.listItemElement.removeClass( this.options.selectedItemStyle );
   },
   
   unmarshall: function(){
      this.unmarshallProperties();
      this.unmarshallMessage();
      this.state = BrowserWidget.States.UNMARSHALLED;
   },
   
   //Properties
   getAnchorElement: function() { return this.anchorElement; },
   getCaption: function() { return this.caption; },
   getFullId: function() { return this.options.parentItemId + this.options.idPathSeparator + this.menuItemId; },
   getId: function() { return this.menuItemId; },
   getMessageProperties: function() { return this.messageProperties; },
   getListItemElement: function() { return this.listItemElement; },
   getParentElement: function() { return this.parentHtmlElement; },
   getSelectedItemClass: function() { return this.options.selectedItemStyle; },
   getState: function() { return this.state; },
   
   //Protected, private helper methods
   instantiateHtmlElements: function(){
      this.listItemElement = this.elementFactory.create( 'li', null, this.parentHtmlElement, WidgetElementFactory.Positions.lastChild, { id : this.menuItemId } );
      this.anchorElement = this.elementFactory.createAnchor( this.caption, null, this.onClick, this.listItemElement, WidgetElementFactory.Positions.lastChild );
   }.protect(),
   
   isChildOfContextItem: function(){
      return this.options.parentItemId != "" && this.getFullId().contains( this.options.contextItemId + this.options.idPathSeparator );
   }.protect(),
   
   isAccordionParentUndefined: function(){
      return this.options.accordionParent == "";
   }.protect(),
   
   isContextItemUndefined: function(){
      return this.options.contextItemId == "";
   }.protect(),
   
   isDirectChildOfContextItem: function(){
      return !this.isContextItemUndefined() && (( this.options.contextItemId + this.options.idPathSeparator + this.menuItemId ) == this.getFullId());
   }.protect(),
   
   isDirectChildOfAccordionParent: function(){
      return !this.isAccordionParentUndefined() && (( this.options.accordionParent + this.options.idPathSeparator + this.menuItemId ) == this.getFullId());
   }.protect(),
   
   isDirectChildOfRootItem: function(){
      return ( this.options.parentItemId.lastIndexOf( this.options.idPathSeparator ) == 0 );
   }.protect(),
   
   isTheContextItem: function(){
      return !this.isContextItemUndefined() && this.options.contextItemId == this.getFullId();
   }.protect(),
   
   isTheRootItem: function(){
      return this.options.parentItemId == "";
   }.protect(),
   
   unmarshallMessage: function(){
      var messageText = XmlResource.selectNodeText( this.options.messagePropertiesSelector, this.definitionXml );
      this.messageProperties = messageText ? eval( "(" + messageText + ")" ) : {};
      this.messageProperties['contextItemId'] = this.getFullId();
   }.protect(),
   
   unmarshallProperties: function(){
      this.caption = XmlResource.selectNodeText( this.options.captionSelector, this.definitionXml );
      this.isDefault = parseBoolean( XmlResource.selectNodeText( this.options.isDefaultSelector, this.definitionXml, null, false ));
      this.menuItemId = XmlResource.selectNodeText( this.options.menuItemIdSelector, this.definitionXml );
   }.protect()
});
/*
Name: 
    - CompositeMenu

Description: 
    - Represents a series of menu items. Can be part of another menu and can contain sub menus too.
      Tipically presented by UL tags. 

Requires:

Provides:
    - CompositeMenu

Part of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. 
http://www.processpuzzle.com

Authors: 
    - Zsolt Zsuffa

Copyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the 
GNU General Public License as published by the Free Software Foundation, either version 3 of the License, 
or (at your option) any later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/





var CompositeMenu = new Class({
   Extends : MenuItem,
   Binds: ['onDefaultItem', 'onSelection'],
   
   options : {
      componentName : 'CompositeMenu',
      menuStyle : 'menuWidget',
      subItemsSelector : 'menuItem'
   },

   //Constructor
   initialize: function( definition, elementFactory, options ){
      this.parent( definition, elementFactory, options );

      this.isExpanded;
      this.listElement;
      this.subItems = new ArrayList();
   },
   
   //Public accessor and mutator methods
   collapse: function(){
      this.destroySubItems();
      if( this.listElement && this.listElement.destroy ) this.listElement.destroy();
      this.isExpanded = false;
   },
   
   construct: function( parentElement ){
      this.parent( parentElement );
      this.constructSubItems();
   },
   
   destroy: function(){
      if( this.options.showSubItems ) this.destroySubItems();
      if( this.listElement && this.listElement.destroy ) this.listElement.destroy();
      this.parent();
   },
   
   expand: function(){
      if( this.isExpanded != undefined ) this.unmarshall();
      this.options.accordionParent = this.getFullId();
      this.createListContainerElement();
      this.constructSubItems();
      this.isExpanded = true;
   },
   
   findItemById: function( itemFullId ){
      var foundItem = this.parent( itemFullId );
      
      if( foundItem ){ 
         return foundItem;
      }else {
         this.subItems.each( function( subItem, index ){
            var returnedValue = subItem.findItemById(  itemFullId  );
            if( returnedValue ) foundItem = returnedValue;
         }.bind( this ));
      }
      
      return foundItem;
   },
   
   onClick : function() {
      if( this.options.accordionBehaviour ){
         if( !this.isExpanded ) this.expand();
         else this.collapse();
      };
      this.parent();
   },
   
   onDefaultItem: function( menuItem ){
      this.fireEvent( 'onDefaultItem', menuItem );
   },
   
   onSelection: function( menuItem ){
      this.fireEvent( 'onSelection', menuItem );
   },
      
   unmarshall: function(){
      this.parent();
      this.unmarshallSubItems();
   },
   
   //Properties
   getMenuStyle : function() { return this.options.menuStyle; },
   getSelectedElementClass : function() { return this.options.selectedElementClass; },
   getState: function() { return this.state; },
   getSubItems: function() { return this.subItems; },
   
   //Protected, private helper methods
   anyChildNeedsToBeDisplayed: function(){
      var anyChildNeedsToBeDisplayed = false;
      this.subItems.each( function( subItem, index ){
         if( subItem.needsToBeDisplayed() ) anyChildNeedsToBeDisplayed = true;
      }.bind( this ));
      
      return anyChildNeedsToBeDisplayed;
   }.protect(),
   
   constructSubItems: function(){
      this.subItems.each( function( subItem, index ){
         subItem.options.accordionParent = this.options.accordionParent;
         subItem.construct( this.parentHtmlElement );
      }.bind( this ));
   }.protect(),
   
   createListContainerElement: function(){
      this.listElement = this.elementFactory.create( 'ul', null, this.listItemElement, WidgetElementFactory.Positions.lastChild, { id : this.menuItemId } );
      this.parentHtmlElement = this.listElement;
   }.protect(),
   
   destroySubItems: function(){
      this.subItems.each( function( subItem, index ){
         subItem.destroy();
      }.bind( this ));
      
      this.subItems.clear();
   }.protect(),
   
   instantiateHtmlElements: function(){
      if( !this.isTheContextItem() ) this.parent();
      
      if( this.anyChildNeedsToBeDisplayed() ){
         this.createListContainerElement();         
         if( this.isTheRootItem() || this.isTheContextItem() ) this.listElement.addClass( this.options.menuStyle );
      }
   }.protect(),
   
   unmarshallProperties: function(){
      this.parent();
   }.protect(),
   
   unmarshallSubItems: function(){
      var subElements = XmlResource.selectNodes( this.options.subItemsSelector, this.definitionXml );
      if( subElements ){
         subElements.each( function( subItemElement, index ){
            var subItem = MenuItemFactory.create( subItemElement, this.elementFactory, { 
               accordionBehaviour : this.options.accordionBehaviour,
               contextItemId : this.options.contextItemId,
               idPathSeparator : this.options.idPathSeparator,
               menuStyle : this.options.menuStyle,
               onDefaultItem : this.onDefaultItem,
               onSelection : this.onSelection,
               parentItemId : this.getFullId(),
               selectedItemStyle : this.options.selectedItemStyle, 
               showSubItems : this.options.showSubItems 
            });
            subItem.unmarshall();
            this.subItems.add( subItem );
         }.bind( this ));
      }      
      
   }.protect()
});
/*
Name: 
    - HierarchicalMenuWidget

Description: 
    - Represents a tree of items in selectable menus. Depending on the associated CSS it can be a drop-down menu, two or more synchronized menus.

Requires:
    - BrowserWidget
    
Provides:
    - HierarchicalMenuWidget

Part of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. 
http://www.processpuzzle.com

Authors: 
    - Zsolt Zsuffa

Copyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the 
GNU General Public License as published by the Free Software Foundation, either version 3 of the License, 
or (at your option) any later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/





var HierarchicalMenuWidget = new Class({
   Extends : BrowserWidget,
   Binds : ['constructMenuItems', 'destroyMenuItems', 'determineCurrentItemId', 'fireCurrentSelection', 'onDefaultItem', 'onSelection'],
   
   options : {
      accordionBehaviour : false,
      componentName : "HierarchicalMenuWidget",
      contextItemId : "",
      idPathSeparator : "/",
      fireDefaultItem : true,
      menuItemOptions : {},
      menuStyle : "menuWidget",
      rootMenuSelector : "//pp:menuWidgetDefinition/menuItem[1]",
      selectedItemStyle : 'selectedMenuItem',
      showSubItems : false,
      widgetContainerId : "HierarchicalMenuWidget"
   },
   
   //Constructor
   initialize : function( options, resourceBundle ){
      this.parent( options, resourceBundle );

      this.currentItemId;
      this.defaultItem;
      this.rootMenu;
      this.selectedItem;
      this.ulElement;      
      
      this.instantiateMenuItemFactory();
   },
   
   //Public accessor and mutator methods
   construct : function() {
      this.parent();
   },
   
   destroy : function() {      
      this.parent();
   },
   
   findItemById: function( itemFullId ){
      if(( itemFullId == null ) || ( this.state != BrowserWidget.States.UNMARSHALLED && this.state != BrowserWidget.States.CONSTRUCTED )) return null;
      return this.rootMenu.findItemById( itemFullId );
   },
   
   onDefaultItem: function( menuItem ){
      if( this.isDirectChildOfContextItem( menuItem ) || this.isDirectChildOfPreviousDefault( this.defaultItem, menuItem )) 
         this.defaultItem = menuItem;
   },
   
   onSelection: function( menuItem ){
      if( this.selectedItem != menuItem ){
         this.deselectCurrentItem();
         this.selectedItem = menuItem;
      }
      
      this.storeComponentState();
      this.messageBus.notifySubscribers( this.createMessage( menuItem ));      
   },
   
   unmarshall: function(){
      this.parent();
      this.unmarshallMenu();
   },
   
   webUIMessageHandler: function( webUIMessage ){
      this.parent( webUIMessage );
      if( instanceOf( webUIMessage, MenuSelectedMessage )){
         if( webUIMessage.getActionType() == 'loadMenu' ){
            this.destroy();
            this.givenOptions.contextItemId = webUIMessage.getContextItemId();
            this.unmarshall();
            this.construct();
         }
      }
   },
   
   //Properties
   getAccordionBehaviour : function() { return this.options.accordionBehaviour; },
   getContextItemId : function() { return this.options.contextItemId; },
   getCurrentItemId : function() { return this.currentItemId; },
   getRootMenu : function() { return this.rootMenu; },
   getSelectedItemClass : function() { return this.options.selectedItemStyle; },
   
   //Private helper methods
   compileConstructionChain: function(){
      this.constructionChain.chain( this.constructMenuItems, this.determineCurrentItemId, this.fireCurrentSelection, this.finalizeConstruction );
   }.protect(),
   
   compileDestructionChain: function(){
      this.destructionChain.chain( this.destroyMenuItems, this.destroyChildHtmlElements, this.finalizeDestruction );
   }.protect(),
   
   compileStateSpecification : function(){
      this.stateSpecification = { currentItemId : this.selectedItem.getFullId(), contextItemId : this.options.contextItemId };
   }.protect(),
   
   constructMenuItems: function(){
      this.rootMenu.construct( this.containerElement );
      this.constructionChain.callChain();
   }.protect(),
   
   createMessage : function( menuItem ){
      var messageProperties = menuItem.getMessageProperties();
      messageProperties['originator'] = this.options.componentName;
      if( this.state == BrowserWidget.States.UNMARSHALLED )  messageProperties['isDefault'] = true;
      return new MenuSelectedMessage( messageProperties );
   }.protect(),
   
   deselectCurrentItem : function(){
      if( this.selectedItem ){
         this.selectedItem.removeClassFromListItem();
      }
   }.protect(),
   
   destroyMenuItems : function(){
      this.rootMenu.destroy();
      this.rootMenu = null;
      this.currentItemId = null;
      this.defaultItemId = null;
      this.destructionChain.callChain();
   }.protect(),
   
   determineCurrentItemId : function(){
      if( this.options.contextItemId ){
         if( this.findItemById( this.options.contextItemId ) == null )
            throw new WidgetConstructionException( this.options.componentName, "ContextItemId is invalid" );
      }
      if( !this.currentItemId ) this.currentItemId = this.defaultItemId;
      this.constructionChain.callChain();
   }.protect(),
   
   determineParentDefinitionElement: function(){
      var selectorExpression = this.options.parentItemSelector.substitute({ menuItemId : this.options.contextItemId });
      return this.definitionXml.selectNode( selectorExpression );
   }.protect(),
   
   fireCurrentSelection: function(){
      var currentItem = this.findItemById( this.currentItemId );
      if( currentItem == null || ( currentItem != null && currentItem.getState() != BrowserWidget.States.CONSTRUCTED )){
         this.currentItemId = this.defaultItem.getFullId();
      }
      
      var itemToSelect = this.findItemById( this.currentItemId );
      itemToSelect.addClassToListItem();
      if( this.options.fireDefaultItem ) this.onSelection( itemToSelect );
      else this.selectedItem = itemToSelect;

      this.constructionChain.callChain();
   }.protect(),
   
   instantiateMenuItemFactory : function(){
      MenuItemFactory.singleInstance = new  MenuItemFactory({});
   }.protect(),
   
   isDirectChildOfContextItem: function( subjectItem ){
      return this.options.contextItemId != "" && ( this.options.contextItemId + this.options.idPathSeparator + subjectItem.getId() ) == subjectItem.getFullId();
   }.protect(),
   
   isDirectChildOfPreviousDefault: function( givenItem, subjectItem ){
      return givenItem == null || ( givenItem.getFullId() + this.options.idPathSeparator + subjectItem.getId() ) == subjectItem.getFullId();
   }.protect(),
   
   parseStateSpecification: function(){
      if( this.stateSpecification ){
         this.currentItemId = this.stateSpecification['currentItemId'];
         this.options.contextItemId = this.stateSpecification['contextItemId'];
         this.givenOptions.contextItemId = this.stateSpecification['contextItemId'];
      }
   }.protect(),
   
   standardizeContextItemId: function(){
      if( this.options.contextItemId != "" && this.options.contextItemId.charAt( 0 ) != this.options.idPathSeparator ){
         this.options.contextItemId = this.options.idPathSeparator + this.options.contextItemId; 
      }
   }.protect(),
   
   unmarshallMenu: function(){
      var rootMenuElement = this.dataXml.selectNode( this.options.rootMenuSelector );
      this.standardizeContextItemId();
      if( rootMenuElement ){
         this.rootMenu = new RootMenu( rootMenuElement, this.elementFactory, {
            accordionBehaviour : this.options.accordionBehaviour,
            contextItemId : this.options.contextItemId,
            idPathSeparator : this.options.idPathSeparator,
            menuStyle : this.options.menuStyle,
            onDefaultItem : this.onDefaultItem,
            onSelection : this.onSelection,
            selectedItemStyle : this.options.selectedItemStyle, 
            showSubItems : this.options.showSubItems 
         });
         this.rootMenu.unmarshall();
      }      
   }.protect(),
   
   unmarshallProperties: function(){
      this.parent();
   }.protect()
});
/*
Name: 
    - LeafMenuItem

Description: 
    - Represents a leaf item in menu system. It's a component of a HierarchicalMenu. 

Requires:

Provides:
    - LeafMenuItem

Part of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. 
http://www.processpuzzle.com

Authors: 
    - Zsolt Zsuffa

Copyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the 
GNU General Public License as published by the Free Software Foundation, either version 3 of the License, 
or (at your option) any later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/





var LeafMenuItem = new Class({
	Extends : MenuItem,
	options : {
      componentName : "LeafMenuItem"
	},
	
	//Constructor
	initialize: function( parentNode, nodeType, nodeResource, elementFactory, options ) {
		this.parent( parentNode, nodeType, nodeResource, elementFactory, options );
	}

	//public accessor and mutator methods

	//Properties

	//private methods
});
/*
Name: MenuItemFactory

Description: Instantiates a new subclass of MenuItem according to the given XML element.

Requires:

Provides:
    - MenuItemFactory

Part of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. 
http://www.processpuzzle.com

Authors: 
    - Zsolt Zsuffa

Copyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the 
GNU General Public License as published by the Free Software Foundation, either version 3 of the License, 
or (at your option) any later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/




var MenuItemFactory = new Class({
   Implements: Options,
   
   options: {
   },
   
   //Constructor
   initialize: function( options ){
      this.setOptions( options );
      
   },

   //Public mutators and accessors
   create: function( menuItemDefinition, elementFactory, options ){
      var hasChildNodes = XmlResource.selectNodes( "menuItem", menuItemDefinition ).length > 0 ? true : false;
      var treeNode;
      
      if( hasChildNodes ) treeNode = new CompositeMenu( menuItemDefinition, elementFactory, options );
      else treeNode = new LeafMenuItem( menuItemDefinition, elementFactory, options );
      
      return treeNode;
   }
   
   //Properties
});

MenuItemFactory.create = function(  definitionXmlElement, htmlElementFactory, options ){
   if( !MenuItemFactory.singleInstance ) MenuItemFactory.singleInstance = new MenuItemFactory();
   return MenuItemFactory.singleInstance.create( definitionXmlElement, htmlElementFactory, options );
};

MenuItemFactory.singleInstance;
/*
Name: 
    - MenuSelectedMessage

Description: 
    - Represents the event when a MenuItem of a MenuWidget was selected.

Requires:
    - WebUIMessage
Provides:
    - MenuSelectedMessage

Part of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. 
http://www.processpuzzle.com

Authors: 
    - Zsolt Zsuffa

Copyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the 
GNU General Public License as published by the Free Software Foundation, either version 3 of the License, 
or (at your option) any later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/





var MenuSelectedMessage = new Class({
   Extends: WebUIMessage,
   options: {
      description: "A message about the event that a menu or tool bar item was selected.",
      documentContentURI: null,
      documentType: AbstractDocument.Types.SMART,
      documentURI: null,
      documentVariables: null,
      contextItemId : null,
      name: "MenuSelectedMessage",
      notification: null,
      windowName: null
   },
   
   //Constructors
   initialize: function( options ){
      this.setOptions( options );
      this.options.messageClass = MenuSelectedMessage;
   },
   
   //Public accessors
   
   //Properties
   getContextItemId: function() { return this.options.contextItemId; },
   getDocumentContentURI: function() { return this.options.documentContentURI; },
   getDocumentType: function() { return this.options.documentType; },
   getDocumentURI: function() { return this.options.documentURI; },
   getDocumentVariables: function() { return this.options.documentVariables; },
   getNotification: function() { return this.options.notification; },
   getProperty: function( propertyName ) { return this.options[propertyName]; },
   getWindowName: function() { return this.options.windowName; }
});

/*
Name: 
    - RootMenu

Description: 
    - Represents a series of menu items directly associated with the menu widget. 

Requires:

Provides:
    - RootMenu

Part of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. 
http://www.processpuzzle.com

Authors: 
    - Zsolt Zsuffa

Copyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the 
GNU General Public License as published by the Free Software Foundation, either version 3 of the License, 
or (at your option) any later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/






var RootMenu = new Class({
   Extends : CompositeMenu,
   Binds: [],
   
   options : {
      componentName : 'RootMenu'
   },

   //Constructor
   initialize: function( definition, elementFactory, options ){
      this.parent( definition, elementFactory, options );
   },
   
   //Public accessor and mutator methods
   construct: function( parentElement ){
      this.parent( parentElement );
   },
   
   destroy: function(){
      this.parent();
   },
   
   unmarshall: function(){
      this.parent();
   },
   
   //Properties
   
   //Protected, private helper methods
   destroySubItems: function(){
      this.subItems.each( function( subItem, index ){
         subItem.destroy();
      }.bind( this ));
   }.protect(),
   
   instantiateHtmlElements: function(){
      this.listElement = this.elementFactory.create( 'ul', null, this.parentHtmlElement, WidgetElementFactory.Positions.lastChild, { id : this.menuItemId } );
      this.listElement.addClass( this.options.menuStyle );
      this.parentHtmlElement = this.listElement;
   }.protect()
   
});
/*
Name: 
   - HtmlDocument

Description: A specialized subclass of AbstractDocument which presents and provides editing possibilities for plain HTML content.

Requires:
   - AbstractDocument

Provides:
   - HtmlDocument

Part of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. 
http://www.processpuzzle.com

Authors: 
   - Zsolt Zsuffa

Copyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the 
GNU General Public License as published by the Free Software Foundation, either version 3 of the License, 
or (at your option) any later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/





var HtmlDocument = new Class({
   Extends: AbstractDocument,
   Binds: ['attachEditor', 'createTextArea', 'destroyTextArea', 'onContainerResize', 'resizeTextArea'],
   
   options: {
      componentName : "HtmlDocument",
      documentContentExtension : ".html",
      documentDefinitionNameSpace: "xmlns:sd='http://www.processpuzzle.com/HtmlDocument'",
      documentEditorClass : "TextAreaEditor",
      rootElementName : "/htmlDocumentDefinition",
   },
   
   //Constructor
   initialize: function( i18Resource, options ){
      this.parent( i18Resource, options );
      
      //Private variables
      this.textArea;
   },
   
   //Public mutators and accessor methods
   attachEditor: function(){
      this.editor.attach( this.textArea, this.documentContent.xmlAsText );
   }.protect(),
   
   construct: function(){
      this.parent();
   },
   
   destroy: function(){
      this.parent();
   },
   
   onContainerResize: function( newSize ){
      this.editor.onContainerResize( newSize );
   },
   
   resizeTextArea: function(){
      var oldScrollTop = this.textArea.getScroll().y;
      this.textArea.scrollTo( null, 1 );
      
      while( this.textArea.getScroll().y > 0 ) {
         var oldHeight = this.textArea.clientHeight;
         this.textArea.rows++;
   
         if( this.textArea.clientHeight == oldHeight ) {
             if( this.textArea.getStyle( 'overflowY' )) this.textArea.setStyle( 'overflowY', '' );
             this.textArea.scrollTo( null, oldScrollTop );
             return;
         }
   
         this.textArea.scrollTop = 1; // perhaps +1 row is not enough, do it again
      }
   
      if( !this.textArea.getStyle( 'overflowY' )) this.textArea.setStyle( 'overflowY', 'hidden' );
   },
   
   unmarshall: function(){
      this.parent();
   },

   //Properties
   getTextArea: function() { return this.textArea; },
   
   //Protected, private helper methods
   compileConstructionChain: function(){
      this.constructionChain.chain(
         this.determineContainerElement, 
         this.instantiateEditor, 
         this.createTextArea, 
         this.attachEditor, 
         this.subscribeToWebUIMessages, 
         this.finalizeConstruction );
   }.protect(),
   
   compileDestructionChain: function(){
      this.destructionChain.chain(  this.releseResource, this.detachEditor, this.destroyTextArea, this.resetProperties, this.finalizeDestruction );
   }.protect(),
   
   createTextArea: function(){
      this.textArea = this.htmlElementFactory.create( 'textArea', null, this.containerElement, WidgetElementFactory.Positions.LastChild, { 
         id : this.name, styles : { border: 0, margin: 0, padding: 0, visibility : 'hidden', overflowY : 'hidden' }});
      this.textArea.set( 'html', this.documentContent.xmlAsText );
      this.textArea.setStyle( 'width', this.containerElement.getSize().x );
      this.textArea.setStyle( 'height', this.textArea.getScrollSize().y );
      this.resizeTextArea();
      this.constructionChain.callChain();
   },
   
   destroyTextArea: function(){
      if( this.textArea.removeEvents ) this.textArea.removeEvents();
      if( this.textArea.destroy ) this.textArea.destroy();
      this.destructionChain.callChain();
   }.protect()
      
});
/*
ProcessPuzzle User Interface
Backend agnostic, desktop like configurable, browser font-end based on MochaUI.
Copyright (C) 2011  Joe Kueser, Zsolt Zsuffa

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/




var ProcessPuzzleLocale = new Class({
   Implements: Options,
   options: {
      delimiter : ",-",
      language : "en",
      country : null,
      variant : null
   },
	
	//Constructor
	initialize: function ( options ) {
	   this.setOptions ( options );
	},
	
   //Public accessor and mutator methods
   equals : function( objectToCheck ){
      return this.options.language == objectToCheck.options.language &&
      this.options.country == objectToCheck.options.country &&
      this.options.variant == objectToCheck.options.variant;
   },
	
   parse : function( localeString ) {
      var tokenizer = new StringTokenizer( localeString, {delimiters : this.options.delimiter});
      i = 0;
      while( tokenizer.hasMoreTokens() ) {
         var nextLocaleConstituent = tokenizer.nextToken().trim();
         if( i == 0 ) this.options.language = nextLocaleConstituent;
         else if( i == 1 ) this.options.country = nextLocaleConstituent;
         else if( i == 2 ) this.options.variant = nextLocaleConstituent;
         i++;
      }
   },
	
   toString: function() {
	   var localeString = this.options.language;
	   if( this.options.country != null && this.options.country != "" ) localeString += this.options.delimiter + this.options.country;
      if( this.options.variant != null && this.options.variant != "" ) localeString += this.options.delimiter + this.options.variant;
      
      return localeString;
	},

	//Properties
	getLanguage : function () {return this.options.language;},
	getCountry : function () {return this.options.country;},
	getVariant : function () {return this.options.variant;}
	
});
/*
ProcessPuzzle User Interface
Backend agnostic, desktop like configurable, browser font-end based on MochaUI.
Copyright (C) 2011  Joe Kueser, Zsolt Zsuffa

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/




var ProcessPuzzleLocaleUtil = new Class({

	// Constructor
	initialize: function () {
	
		//private instance variables
		this.DELIMITER = '_';
	},
	
	//public accessors methods
	getFileName : function( locale, prefix, suffix, depth ){
	  var buffer = new String( prefix );
      if (depth > 0) {
         var language = locale.getLanguage();
         if ( language != null && language != "" ) {
            buffer += this.DELIMITER;
            buffer += language;
         }
      }
      if (depth > 1) {
         var country = locale.getCountry();
         if ( country != null && country != "" ) {
            buffer += this.DELIMITER;
            buffer += country;
         }
      }
      if (depth > 2) {
         var variant = locale.getVariant();
         if ( variant != null && variant != "" ) {
            buffer += this.DELIMITER;
            buffer += variant;
         }
      }
      return buffer.toString() + suffix;
	},

	getFileNameList : function( locale, prefix, suffix ) {
		assertThat( suffix, not( nil() ));
		assertThat( suffix, containsString( "." ));
		
		var list = new ArrayList();
		for (var i = 0; i < 3; i++) {
		   var filename = this.getFileName(locale, prefix, suffix, i);
		   if (!list.contains(filename)) {
		      list.add(filename);
		   }
		}
		var array = new Array(list.size());
		for (var i = 0; i < array.length; i++) {
		   array[i] = list.get(i);
		}
		return array;
	},

	splitName : function( name ) {
	   var tokenizer = new StringTokenizer( name, {delimiters : this.DELIMITER });
	   var array = new Array();
	   i = 0;
	   while( tokenizer.hasMoreTokens() ) {
	      array[i] = tokenizer.nextToken();
	      i++;
	   }
	   return array;
	}
	
	//public mutators methods

	//private methods
});
/*
name: ResourceCache
script: ResourceCache.js
description: Mantains a HashMap for internationalization resource items.
copyright: (c) 2010 IT Codex Llc., <http://itkodex.hu/>.
license: MIT-style license.

todo:
  - 

requires:
  - MooTools/mootools-core.1.3
  - ProcessPuzzle/JavaCompatibility
  - ProcessPuzzle/JavaCollection

provides: [ProcessPuzzle.ResourceCache]
*/




var ResourceCache = new Class({

	initialize : function(){
	//parameter assertions

	//private instance variables
  	this.resources = new HashMap();
	this.self = this;
	},
	
	clear : function(){
	  this.resources.clear(); 
	},

	//public accessors methods
	get : function( name, type ) {
	    var resourceKey = new ResourceKey( name, type );
	    if( !this.resources.containsKey( resourceKey ) ) {
	        throw new IllegalArgumentException( "no such key: " + resourceKey );
	    }
	    return this.resources.get( resourceKey );
	},
	
	//public mutators methods
	put : function( resourceKey, resourceValue ){
		this.resources.put( resourceKey, resourceValue );
	}

	//private methods
});
/*
ProcessPuzzle User Interface
Backend agnostic, desktop like configurable, browser font-end based on MochaUI.
Copyright (C) 2011  Joe Kueser, Zsolt Zsuffa

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/




var ResourceKey = new Class({
   
   initialize: function( theKey, theType ) {
      //parameter assertions
      assertThat( theKey, not( nil() ));
      assertThat( theType, not( nil() ));
      
      //private instance variables
      this.key = theKey;
      this.type = theType;
   },

   //public accessors methods
   toString : function() { 
      return this.key + '/' + this.type;
   },
   
   hashCode : function() { 
      var keyHashCode = this.key.hashCode();
      var hashCode = this.toString().hashCode();
      return keyHashCode;
   },
   
   equals : function( obj ) { 
      return this.compareTo(obj); 
   },

   compareTo : function( otherKey ) {
       if (otherKey instanceof ResourceKey) {
           response = (this.key == otherKey.key);
           if (response) {
            response = (this.type == otherKey.type);
           }
           return response;
       }
       return false;
   }

   //public mutators methods

   //private methods
});
/*
ProcessPuzzle User Interface
Backend agnostic, desktop like configurable, browser font-end based on MochaUI.
Copyright (C) 2011  Joe Kueser, Zsolt Zsuffa

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/




var XMLBundleParser = new Class({
	
	//Constructor
	initialize: function() {
		//private instance variables
		this.buffer = new String();
		this.cache = new ResourceCache();
		this.key;
		this.parserLanguage, this.parserCountry, this.parserVariant;
		this.targetLanguage, this.targetCountry, this.targetVariant;
		this.saxEventHandler = new SAXEventHandler(); 
		this.xmlResource = null;
		this.xmlAsText = "";
	},
	
	//Public accessors and mutator methods
	characters : function( chars, offset, length ) {
	    this.buffer += chars.substring( offset, offset + length );
	},

	endElement : function( qName ) {
	    var content = this.buffer.trim();
	    this.buffer = new String();
	    if( qName.equals("Language")) {
	        this.parserLanguage = null;
	    }
	    if( qName.equals("Country")) {
	        this.parserCountry = null;
	    }
	    if( qName.equals("Variant")) {
	        this.parserVariant = null;
	    }
	    if( qName.equals("Resource") && this.inContext()) {
	        this.cache.put( this.key, content );
	    }
	},

	parse : function( theCache, theFilename, theTargetLocale ) {
	    this.cache = theCache;
	    this.targetLanguage = theTargetLocale.getLanguage();
	    this.targetCountry = theTargetLocale.getCountry();
	    this.targetVariant = theTargetLocale.getVariant();
	    
	    var parser = new SAXDriver();
	    parser.setDocumentHandler( this );
	    parser.setLexicalHandler(this );
	    parser.setErrorHandler( this );
	    this.xmlResource = new XmlResource( theFilename, { parseOnComplete : false } );
	    parser.parse( this.xmlResource.getXmlAsText() );
	},

	startElement : function( qName, attrs ) {
	    if( qName.equals("Language")) {
	    	this.parserLanguage = attrs.getValueByName("name");
	    }
	    if( qName.equals("Country")) {
	    	this.parserCountry = attrs.getValueByName("name");
	    }
	    if( qName.equals("Variant")) {
	    	this.parserVariant = attrs.getValueByName("name");
	    }
	    if( qName.equals("Resource")) {
	    	this.key = new ResourceKey(attrs.getValueByName("key"), attrs.getValueByName("type"));
	    }
	},

	//Properties
	setXML : function( strXML ) { this.xmlAsText = strXML; },
	
	//Protected private helper methods
	inContext : function() {
	    if( this.parserLanguage == null || this.parserLanguage.equals( this.targetLanguage )) {
	        if( this.parserCountry == null || this.parserCountry.equals( this.targetCountry )) {
	        if( this.parserVariant == null || this.parserVariant.equals( this.targetVariant )) {
	            return true;
	        }
	        }
	    }
	    return false;
	}.protect()
});
/*
ProcessPuzzle User Interface
Backend agnostic, desktop like configurable, browser font-end based on MochaUI.
Copyright (C) 2011  Joe Kueser, Zsolt Zsuffa

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/




var XMLResourceBundle = new Class( {
   Implements : Options,

   options : {
      componentName : "XMLResourceBundle",
      defaultLocale : null,
      nameSpaces : "xmlns:pp='http://www.processpuzzle.com/'"
   },

   // Constructor
   initialize : function(webUIConfiguration, options) {

      // parameter assertions
   assertThat( webUIConfiguration, not( nil() ));
   this.setOptions( options );

   // private instance variables
   this.cache;
   this.currentLocale = null;
   this.isLoaded = false;
   this.logger = Class.getInstanceOf( WebUILogger );
   this.localeUtil = new ProcessPuzzleLocaleUtil();
   this.parser = new XMLBundleParser();
   this.resourceBundleNames = new Array();
   this.webUIConfiguration = webUIConfiguration;

   this.determineDefaultLocale();
   this.determineNameSpace();
   this.determineResourceBundleNames();
},

// public accessors methods
   getDefaultLocale : function() {
      return this.options.defaultLocale;
   },

   getFile : function(key) {
      var file = this.cache.get( key, "File" );
      return new File( file );
   },
   
   getLocale : function() { return this.currentLocale; },

   getNameSpace : function() {
      return this.options.nameSpaces;
   },
   getResourceBundleNames : function() {
      return this.resourceBundleNames;
   },

   getText : function( resourceKey ) {
      if( !resourceKey ) return null;
      
      var resourceValue;
      try {
         resourceValue = this.cache.get( resourceKey, "String" );
      }catch( e ) {
         resourceValue = resourceKey;
      }
      return resourceValue;
   },

   // public mutators methods
   load : function( locale ) {
      this.logger.debug( this.options.componentName + ".load() started." );
      this.currentLocale = locale;
      this.cache = new ResourceCache();
      var fileList = this.determineFileNames( locale );
      var numOfSuccess = 0;
      for ( var i = 0; i < fileList.size(); i++) {
         if (this.parseFile( fileList.get( i ), locale )) {
            numOfSuccess++;
         }
      }
      if (numOfSuccess == 0) {
         var exception = new UndefinedXmlResourceException( fileList.get( 0 ) );
         throw exception;
      }
      this.isLoaded = true;
   },
   
   release : function(){
      this.currentLocale = null;
      this.cache.clear();
      this.cache = null;
      this.resourceBundleNames.empty();
      this.isLoaded = false;
   },

   // private methods
   determineDefaultLocale : function() {
      var defaultLocaleInConfig = this.webUIConfiguration.getI18DefaultLocale();
      if (defaultLocaleInConfig != null)
         this.options.defaultLocale = defaultLocaleInConfig;
   }.protect(),

   determineFileNames : function(locale) {
      var fileNames = new ArrayList();
      this.resourceBundleNames.each( function(resourceBundleName, index) {
         var fileList = this.localeUtil.getFileNameList( locale, resourceBundleName, ".xml" );
         fileNames.addAll( fileList );
      }, this );

      return fileNames;
   }.protect(),

   determineNameSpace : function() {
      var nameSpaceInConfig = this.webUIConfiguration.getI18ResourceBundleNameSpace();
      if (nameSpaceInConfig != null)
         this.options.nameSpaces = nameSpaceInConfig;
   }.protect(),

   determineResourceBundleNames : function() {
      var resourceBundleElements = this.webUIConfiguration.getI18ResourceBundleElements();
      for (i = 0; i < this.webUIConfiguration.getI18ResourceBundleElements().length; i++) {
         var resourceBundleName = this.webUIConfiguration.getI18ResourceBundleName( i );
         this.resourceBundleNames[i] = resourceBundleName;
      }
      ;
   }.protect(),

   parseFile : function(theFilename, theLocale) {
      try {
         var xmlDocument = new XmlResource( theFilename, {
            nameSpaces : this.options.nameSpaces
         } );
      } catch (e) {
         return false;
      }
      this.parser.parse( this.cache, theFilename, theLocale );
      return true;
   }.protect()
} );
/*
 * ----------------------------- JSTORAGE -------------------------------------
 * Simple local storage wrapper to save data on the browser side, supporting
 * all major browsers - IE6+, Firefox2+, Safari4+, Chrome4+ and Opera 10.5+
 *
 * Copyright (c) 2010 Andris Reinman, andris.reinman@gmail.com
 * Project homepage: www.jstorage.info
 *
 * Licensed under MIT-style license:
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */

/**
 * $.jStorage
 *
 * USAGE:
 *
 * jStorage requires Prototype, MooTools or jQuery! If jQuery is used, then
 * jQuery-JSON (http://code.google.com/p/jquery-json/) is also needed.
 * (jQuery-JSON needs to be loaded BEFORE jStorage!)
 *
 * Methods:
 *
 * -set(key, value)
 * $.jStorage.set(key, value) -> saves a value
 *
 * -get(key[, default])
 * value = $.jStorage.get(key [, default]) ->
 *    retrieves value if key exists, or default if it doesn't
 *
 * -deleteKey(key)
 * $.jStorage.deleteKey(key) -> removes a key from the storage
 *
 * -flush()
 * $.jStorage.flush() -> clears the cache
 *
 * -storageObj()
 * $.jStorage.storageObj() -> returns a read-ony copy of the actual storage
 *
 * -storageSize()
 * $.jStorage.storageSize() -> returns the size of the storage in bytes
 *
 * -index()
 * $.jStorage.index() -> returns the used keys as an array
 *
 * -storageAvailable()
 * $.jStorage.storageAvailable() -> returns true if storage is available
 *
 * -reInit()
 * $.jStorage.reInit() -> reloads the data from browser storage
 *
 * <value> can be any JSON-able value, including objects and arrays.
 *
 **/


(function($){
    if(!$ || !($.toJSON || Object.toJSON || window.JSON)){
        throw new Error("jQuery, MooTools or Prototype needs to be loaded before jStorage!");
    }

    var
        /* This is the object, that holds the cached values */
        _storage = {},

        /* Actual browser storage (localStorage or globalStorage['domain']) */
        _storage_service = {jStorage:"{}"},

        /* DOM element for older IE versions, holds userData behavior */
        _storage_elm = null,

        /* How much space does the storage take */
        _storage_size = 0,

        /* function to encode objects to JSON strings */
        json_encode = $.toJSON || Object.toJSON || (window.JSON && (JSON.encode || JSON.stringify)),

        /* function to decode objects from JSON strings */
        json_decode = $.evalJSON || (window.JSON && (JSON.decode || JSON.parse)) || function(str){
            return String(str).evalJSON();
        },

        /* which backend is currently used */
        _backend = false,

        /* Next check for TTL */
        _ttl_timeout,

        /**
         * XML encoding and decoding as XML nodes can't be JSON'ized
         * XML nodes are encoded and decoded if the node is the value to be saved
         * but not if it's as a property of another object
         * Eg. -
         *   $.jStorage.set("key", xmlNode);        // IS OK
         *   $.jStorage.set("key", {xml: xmlNode}); // NOT OK
         */
        _XMLService = {

            /**
             * Validates a XML node to be XML
             * based on jQuery.isXML function
             */
            isXML: function(elm){
                var documentElement = (elm ? elm.ownerDocument || elm : 0).documentElement;
                return documentElement ? documentElement.nodeName !== "HTML" : false;
            },

            /**
             * Encodes a XML node to string
             * based on http://www.mercurytide.co.uk/news/article/issues-when-working-ajax/
             */
            encode: function(xmlNode) {
                if(!this.isXML(xmlNode)){
                    return false;
                }
                try{ // Mozilla, Webkit, Opera
                    return new XMLSerializer().serializeToString(xmlNode);
                }catch(E1) {
                    try {  // IE
                        return xmlNode.xml;
                    }catch(E2){}
                }
                return false;
            },

            /**
             * Decodes a XML node from string
             * loosely based on http://outwestmedia.com/jquery-plugins/xmldom/
             */
            decode: function(xmlString){
                var dom_parser = ("DOMParser" in window && (new DOMParser()).parseFromString) ||
                        (window.ActiveXObject && function(_xmlString) {
                    var xml_doc = new ActiveXObject('Microsoft.XMLDOM');
                    xml_doc.async = 'false';
                    xml_doc.loadXML(_xmlString);
                    return xml_doc;
                }),
                resultXML;
                if(!dom_parser){
                    return false;
                }
                resultXML = dom_parser.call("DOMParser" in window && (new DOMParser()) || window, xmlString, 'text/xml');
                return this.isXML(resultXML)?resultXML:false;
            }
        };

    ////////////////////////// PRIVATE METHODS ////////////////////////

    /**
     * Initialization function. Detects if the browser supports DOM Storage
     * or userData behavior and behaves accordingly.
     * @returns undefined
     */
    function _init(){
        /* Check if browser supports localStorage */
        var localStorageReallyWorks = false;
        if("localStorage" in window){
            try {
                window.localStorage.setItem('_tmptest', 'tmpval');
                localStorageReallyWorks = true;
                window.localStorage.removeItem('_tmptest');
            } catch(BogusQuotaExceededErrorOnIos5) {
                // Thanks be to iOS5 Private Browsing mode which throws
                // QUOTA_EXCEEDED_ERRROR DOM Exception 22.
            }
        }
        if(localStorageReallyWorks){
            try {
                if(window.localStorage) {
                    _storage_service = window.localStorage;
                    _backend = "localStorage";
                }
            } catch(E3) {/* Firefox fails when touching localStorage and cookies are disabled */}
        }
        /* Check if browser supports globalStorage */
        else if("globalStorage" in window){
            try {
                if(window.globalStorage) {
                    _storage_service = window.globalStorage[window.location.hostname];
                    _backend = "globalStorage";
                }
            } catch(E4) {/* Firefox fails when touching localStorage and cookies are disabled */}
        }
        /* Check if browser supports userData behavior */
        else {
            _storage_elm = new Element( 'link' );
            if(_storage_elm.addBehavior){

                /* Use a DOM element to act as userData storage */
                _storage_elm.style.behavior = 'url(#default#userData)';

                /* userData element needs to be inserted into the DOM! */
                document.getElementsByTagName('head')[0].appendChild(_storage_elm);

                _storage_elm.load("jStorage");
                var data = "{}";
                try{
                    data = _storage_elm.getAttribute("jStorage");
                }catch(E5){}
                _storage_service.jStorage = data;
                _backend = "userDataBehavior";
            }else{
                _storage_elm = null;
                return;
            }
        }

        _load_storage();

        // remove dead keys
        _handleTTL();
    }

    /**
     * Loads the data from the storage based on the supported mechanism
     * @returns undefined
     */
    function _load_storage(){
        /* if jStorage string is retrieved, then decode it */
        if(_storage_service.jStorage){
            try{
                _storage = json_decode(String(_storage_service.jStorage));
            }catch(E6){_storage_service.jStorage = "{}";}
        }else{
            _storage_service.jStorage = "{}";
        }
        _storage_size = _storage_service.jStorage?String(_storage_service.jStorage).length:0;
    }

    /**
     * This functions provides the "save" mechanism to store the jStorage object
     * @returns undefined
     */
    function _save(){
        try{
            _storage_service.jStorage = json_encode(_storage);
            // If userData is used as the storage engine, additional
            if(_storage_elm) {
                _storage_elm.setAttribute("jStorage",_storage_service.jStorage);
                _storage_elm.save("jStorage");
            }
            _storage_size = _storage_service.jStorage?String(_storage_service.jStorage).length:0;
        }catch(E7){/* probably cache is full, nothing is saved this way*/}
    }

    /**
     * Function checks if a key is set and is string or numberic
     */
    function _checkKey(key){
        if(!key || (typeof key != "string" && typeof key != "number")){
            throw new TypeError('Key name must be string or numeric');
        }
        if(key == "__jstorage_meta"){
            throw new TypeError('Reserved key name');
        }
        return true;
    }

    /**
     * Removes expired keys
     */
    function _handleTTL(){
        var curtime, i, TTL, nextExpire = Infinity, changed = false;

        clearTimeout(_ttl_timeout);

        if(!_storage.__jstorage_meta || typeof _storage.__jstorage_meta.TTL != "object"){
            // nothing to do here
            return;
        }

        curtime = +new Date();
        TTL = _storage.__jstorage_meta.TTL;
        for(i in TTL){
            if(TTL.hasOwnProperty(i)){
                if(TTL[i] <= curtime){
                    delete TTL[i];
                    delete _storage[i];
                    changed = true;
                }else if(TTL[i] < nextExpire){
                    nextExpire = TTL[i];
                }
            }
        }

        // set next check
        if(nextExpire != Infinity){
            _ttl_timeout = setTimeout(_handleTTL, nextExpire - curtime);
        }

        // save changes
        if(changed){
            _save();
        }
    }

    ////////////////////////// PUBLIC INTERFACE /////////////////////////

    $.jStorage = {
        /* Version number */
        version: "0.1.6.1",

        /**
         * Sets a key's value.
         *
         * @param {String} key - Key to set. If this value is not set or not
         *              a string an exception is raised.
         * @param value - Value to set. This can be any value that is JSON
         *              compatible (Numbers, Strings, Objects etc.).
         * @returns the used value
         */
        set: function(key, value){
            _checkKey(key);
            if(_XMLService.isXML(value)){
                value = {_is_xml:true,xml:_XMLService.encode(value)};
            }else if(typeof value == "function"){
                value = null; // functions can't be saved!
            }else if(value && typeof value == "object"){
                // clone the object before saving to _storage tree
                value = json_decode(json_encode(value));
            }
            _storage[key] = value;
            _save();
            return value;
        },

        /**
         * Looks up a key in cache
         *
         * @param {String} key - Key to look up.
         * @param {mixed} def - Default value to return, if key didn't exist.
         * @returns the key value, default value or <null>
         */
        get: function(key, def){
            _checkKey(key);
            if(key in _storage){
                if(_storage[key] && typeof _storage[key] == "object" &&
                        _storage[key]._is_xml &&
                            _storage[key]._is_xml){
                    return _XMLService.decode(_storage[key].xml);
                }else{
                    return _storage[key];
                }
            }
            return typeof(def) == 'undefined' ? null : def;
        },

        /**
         * Deletes a key from cache.
         *
         * @param {String} key - Key to delete.
         * @returns true if key existed or false if it didn't
         */
        deleteKey: function(key){
            _checkKey(key);
            if(key in _storage){
                delete _storage[key];
                // remove from TTL list
                if(_storage.__jstorage_meta &&
                  typeof _storage.__jstorage_meta.TTL == "object" &&
                  key in _storage.__jstorage_meta.TTL){
                    delete _storage.__jstorage_meta.TTL[key];
                }
                _save();
                return true;
            }
            return false;
        },

        /**
         * Sets a TTL for a key, or remove it if ttl value is 0 or below
         *
         * @param {String} key - key to set the TTL for
         * @param {Number} ttl - TTL timeout in milliseconds
         * @returns true if key existed or false if it didn't
         */
        setTTL: function(key, ttl){
            var curtime = +new Date();
            _checkKey(key);
            ttl = Number(ttl) || 0;
            if(key in _storage){

                if(!_storage.__jstorage_meta){
                    _storage.__jstorage_meta = {};
                }
                if(!_storage.__jstorage_meta.TTL){
                    _storage.__jstorage_meta.TTL = {};
                }

                // Set TTL value for the key
                if(ttl>0){
                    _storage.__jstorage_meta.TTL[key] = curtime + ttl;
                }else{
                    delete _storage.__jstorage_meta.TTL[key];
                }

                _save();

                _handleTTL();
                return true;
            }
            return false;
        },

        /**
         * Deletes everything in cache.
         *
         * @return true
         */
        flush: function(){
            _storage = {};
            _save();
            return true;
        },

        /**
         * Returns a read-only copy of _storage
         *
         * @returns Object
        */
        storageObj: function(){
            function F() {}
            F.prototype = _storage;
            return new F();
        },

        /**
         * Returns an index of all used keys as an array
         * ['key1', 'key2',..'keyN']
         *
         * @returns Array
        */
        index: function(){
            var index = [], i;
            for(i in _storage){
                if(_storage.hasOwnProperty(i) && i != "__jstorage_meta"){
                    index.push(i);
                }
            }
            return index;
        },

        /**
         * How much space in bytes does the storage take?
         *
         * @returns Number
         */
        storageSize: function(){
            return _storage_size;
        },

        /**
         * Which backend is currently in use?
         *
         * @returns String
         */
        currentBackend: function(){
            return _backend;
        },

        /**
         * Test if storage is available
         *
         * @returns Boolean
         */
        storageAvailable: function(){
            return !!_backend;
        },

        /**
         * Reloads the data from browser storage
         *
         * @returns undefined
         */
        reInit: function(){
            var new_storage_elm, data;
            if(_storage_elm && _storage_elm.addBehavior){
                new_storage_elm = new Element( 'link' );

                _storage_elm.parentNode.replaceChild(new_storage_elm, _storage_elm);
                _storage_elm = new_storage_elm;

                /* Use a DOM element to act as userData storage */
                _storage_elm.style.behavior = 'url(#default#userData)';

                /* userData element needs to be inserted into the DOM! */
                document.getElementsByTagName('head')[0].appendChild(_storage_elm);

                _storage_elm.load("jStorage");
                data = "{}";
                try{
                    data = _storage_elm.getAttribute("jStorage");
                }catch(E5){}
                _storage_service.jStorage = data;
                _backend = "userDataBehavior";
            }

            _load_storage();
        }
    };

    // Initialize jStorage
    _init();

})(window.jQuery || window.$);
//LanguageChangedMessage.js
/**
ProcessPuzzle User Interface
Backend agnostic, desktop like configurable, browser font-end based on MochaUI.
Copyright (C) 2011  Joe Kueser, Zsolt Zsuffa

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/





var LanguageChangedMessage = new Class({
   Extends: WebUIMessage,
   options: {
      actionType: null,
      description: "A message about the event that WebUI's language was changed.",
      name: "Language Changed Message",
      newLocale : null,
      previousLocale: null
   },
   
   //Constructors
   initialize: function( options ){
      this.setOptions( options );
      this.options.messageClass = LanguageChangedMessage;
   },
   
   //Public accessors
   
   //Properties
   getNewLocale: function() { return this.options.newLocale; },
   getPreviousLocale: function() { return this.options.previousLocale; }
});

//LanguageSelectorWidget.js
/**
ProcessPuzzle User Interface
Backend agnostic, desktop like configurable, browser font-end based on MochaUI.
Copyright (C) 2011  Joe Kueser, Zsolt Zsuffa

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/





var LanguageSelectorWidget = new Class({
   Extends : BrowserWidget,
   Binds : ['onSelection'],
   
   options : {
      componentName : "LanguageSelectorWidget",
      componentPrefix : "LanguageSelectorWidget",
      selectElementId : "LanguageSelector",
      selectTextKey : "LanguageSelectorWidget.select",
      widgetContainerId : "LanguageSelectorWidget",
      wrapperElementStyle : "LanguageSelectorWrapper"
   },
   
   //Constructor
   initialize : function( options, resourceBundle, webUIConfiguration ){
      this.setOptions( options );
      this.parent( options, resourceBundle );
      
      this.availableLocales = new ArrayList();
      this.isConfigured = false;
      this.selectElement = null;
      this.selectElementContainer = null;
      this.webUIConfiguration = webUIConfiguration;
      
      this.determineInitializationArguments();
      this.determineAvailableLocales();
   },

   //Public accessor and mutator methods
   construct : function() {
      this.createSpanElements();
      this.createSelectElement();
      this.createSelectElementOptions();
      return this.parent();
   },
   
   destroy : function() {
      this.availableLocales.clear();
      this.parent();
   },
   
   onSelection : function() {
      var currentLocale = this.locale;
      var newLocale = new ProcessPuzzleLocale();
      newLocale.parse( this.selectElement.options[this.selectElement.selectedIndex].value );
      var message = new LanguageChangedMessage({ previousLocale : currentLocale, newLocale : newLocale, originator : this.options.widgetContainerId });
      this.messageBus.notifySubscribers( message );
   },
   
   //Properties
   getAvailableLocales : function() { return this.availableLocales; },
   getWebUIConfiguration : function() { return this.webUIConfiguration; },
   
   //Private helper methods
   createSelectElement : function(){
      this.selectElement = this.elementFactory.create( 'select', null, this.selectElementContainer, WidgetElementFactory.Positions.LastChild, { id : this.options.selectElementId } );
      this.selectElement.addEvent( 'change', this.onSelection );
   }.protect(),
   
   createSelectElementOptions : function() {
      var selectedOption = this.elementFactory.createOption( "", this.options.selectTextKey, this.selectElement, WidgetElementFactory.Positions.LastChild );
      selectedOption.set( 'selected' );
      
      this.availableLocales.each( function( locale, index ){
         this.elementFactory.createOption( locale.getLanguage(), this.options.componentPrefix + "." + locale.getLanguage(), this.selectElement, WidgetElementFactory.Positions.LastChild );
      }, this );
   }.protect(),
   
   createSpanElements: function() {
      var languageSelectorWrapper = this.elementFactory.create( 'span', null, null, null, {'class': this.options.wrapperElementStyle });
      this.selectElementContainer = this.elementFactory.create( 'span', null, languageSelectorWrapper );
   }.protect(),
   
   determineAvailableLocales : function(){
      for( var i = 0; i < this.webUIConfiguration.getI18LocaleElements().length; i++ ) {
         var i18LocaleText = this.webUIConfiguration.getI18Locale( i );
         var locale = new ProcessPuzzleLocale();
         locale.parse( i18LocaleText );
         this.availableLocales.add( locale );
      }
   }.protect(),
   
   determineInitializationArguments : function(){
      if( !this.webUIConfiguration ){
         var webUIController = Class.getInstanceOf( WebUIController );
         if( webUIController ) this.webUIConfiguration = webUIController.getWebUIConfiguration();
         else this.webUIConfiguration = Class.getInstanceOf( WebUIConfiguration );
      }
   }.protect()
   
});
/*
---

name: MooEditable

description: Class for creating a WYSIWYG editor, for contentEditable-capable browsers.

license: MIT-style license

authors:
- Lim Chee Aun
- Radovan Lozej
- Ryan Mitchell
- Olivier Refalo
- T.J. Leahy

requires:
- Core/Class.Extras
- Core/Element.Event
- Core/Element.Dimensions

inspiration:
- Code inspired by Stefan's work [Safari Supports Content Editing!](http://www.xs4all.nl/~hhijdra/stefan/ContentEditable.html) from [safari gets contentEditable](http://walkah.net/blog/walkah/safari-gets-contenteditable)
- Main reference from Peter-Paul Koch's [execCommand compatibility](http://www.quirksmode.org/dom/execCommand.html)
- Some ideas and code inspired by [TinyMCE](http://tinymce.moxiecode.com/)
- Some functions inspired by Inviz's [Most tiny wysiwyg you ever seen](http://forum.mootools.net/viewtopic.php?id=746), [mooWyg (Most tiny WYSIWYG 2.0)](http://forum.mootools.net/viewtopic.php?id=5740)
- Some regex from Cameron Adams's [widgEditor](http://widgeditor.googlecode.com/)
- Some code from Juan M Martinez's [jwysiwyg](http://jwysiwyg.googlecode.com/)
- Some reference from MoxieForge's [PunyMCE](http://punymce.googlecode.com/)
- IE support referring Robert Bredlau's [Rich Text Editing](http://www.rbredlau.com/drupal/node/6)

provides: [MooEditable, MooEditable.Selection, MooEditable.UI, MooEditable.Actions]

...
 */


(function() {

var blockEls = /^(H[1-6]|HR|P|DIV|ADDRESS|PRE|FORM|TABLE|LI|OL|UL|TD|CAPTION|BLOCKQUOTE|CENTER|DL|DT|DD|SCRIPT|NOSCRIPT|STYLE)$/i;
var urlRegex = /^(https?|ftp|rmtp|mms):\/\/(([A-Z0-9][A-Z0-9_-]*)(\.[A-Z0-9][A-Z0-9_-]*)+)(:(\d+))?\/?/i;
var protectRegex = /<(script|noscript|style)[\u0000-\uFFFF]*?<\/(script|noscript|style)>/g;

this.MooEditable = new Class({
   Implements : [Events, Options],

   options : {
      actions : 'bold italic underline strikethrough | insertunorderedlist insertorderedlist indent outdent | undo redo | createlink unlink | urlimage | toggleview',
      baseCSS : 'html{ height: 100%; cursor: text; } body{ font-family: sans-serif; }',
      baseURL : '',
      cleanup : true,
      dimensions : null,
      disabled : false,
      elasticHeight : true,
      estimatedRowHeight : 10,
      extraCSS : '',
      externalCSS : '',
      handleDialogs : true,
      handleLabel : true,
      handleSubmit : true,
      html : '<!DOCTYPE html><html><head><meta charset="UTF-8">{BASEHREF}<style>{BASECSS} {EXTRACSS}</style>{EXTERNALCSS}</head><body></body></html>',
      paragraphise : true,
      rootElement : 'p',
      semantics : true,
      toolbar : true,
      xhtml : true,},

   initialize : function( el, options ) {

      // check for content editable and design mode support
      if( !("contentEditable" in document.body) && !("designMode" in document) ){
         return;
      }

      this.setOptions( options );
      this.textarea = document.id( el );
      this.textarea.store( 'MooEditable', this );
      this.actions = this.options.actions.clean().split( ' ' );
      this.keys = {};
      this.dialogs = {};
      this.protectedElements = [];
      this.actions.each( function( action ) {
         var act = MooEditable.Actions[action];
         if( !act )
            return;
         if( act.options ){
            var key = act.options.shortcut;
            if( key )
               this.keys[key] = action;
         }
         if( act.dialogs ){
            Object.each( act.dialogs, function( dialog, name ) {
               dialog = dialog.attempt( this );
               dialog.name = action + ':' + name;
               if( typeOf( this.dialogs[action] ) != 'object' )
                  this.dialogs[action] = {};
               this.dialogs[action][name] = dialog;
            }, this );
         }
         if( act.events ){
            Object.each( act.events, function( fn, event ) {
               this.addEvent( event, fn );
            }, this );
         }
      }.bind( this ) );
      this.render();
   },

   toElement : function() {
      return this.textarea;
   },

   render : function() {
      var self = this;

      // Dimensions
      var dimensions = this.options.dimensions || this.textarea.getSize();

      // Build the container
      this.container = new Element( 'div', {
         id : (this.textarea.id) ? this.textarea.id + '-mooeditable-container' : null,
         'class' : 'mooeditable-container',
         styles : { overflowY : 'hidden', width : dimensions.x  + "px" }
      });

      // Override all textarea styles
      this.textarea.addClass( 'mooeditable-textarea' ).setStyle( 'height', dimensions.y + "px" );

      // Build the iframe
      this.iframe = new Element( 'IFrame', {
         'class' : 'mooeditable-iframe',
         frameBorder : 0,
         scrolling : 'no',
         src : 'javascript:""', // Workaround for HTTPs warning in IE6/7
         styles : { height : dimensions.y + "px", width : dimensions.x  + "px" }
      });
      
      this.toolbar = new MooEditable.UI.Toolbar({
         onItemAction : function() {
            var args = Array.from( arguments );
            var item = args[0];
            self.action( item.name, args );
         }
      });
      
      this.attach.delay( 1, this );

      // Update the event for textarea's corresponding labels
      if( this.options.handleLabel && this.textarea.id )
         $$( 'label[for="' + this.textarea.id + '"]' ).addEvent( 'click', function( e ) {
            if( self.mode != 'iframe' )
               return;
            e.preventDefault();
            self.focus();
         } );

      // Update & cleanup content before submit
      if( this.options.handleSubmit ){
         this.form = this.textarea.getParent( 'form' );
         if( !this.form ) return;
         this.form.addEvent( 'submit', function() {
            if( self.mode == 'iframe' ) self.saveContent();
         });
      }

      this.fireEvent( 'render', this );
   },

   adjustIFrameHeight: function(){
      var innerDoc = (this.iframe.contentDocument) ? this.iframe.contentDocument : this.iframe.contentWindow.document;
      this.iframe.setStyle( 'height', innerDoc.body.offsetHeight +10 );
   
      if( !this.iframe.getStyle( 'overflowY' )) this.iframe.setStyle( 'overflowY', 'hidden' );
   }.protect(),
   
   tryToDecreaseHeight: function(){
      if( Browser.ie ) return;
      
      while( this.getFrameScrollTop() == 0 && this.iframe.getStyle( 'height' ).toInt() > 0 ) {
         var currentHeight = this.iframe.getStyle( 'height' ).toInt();
         var decreasedHeight = ( currentHeight - this.options.estimatedRowHeight ) >= 0 ? currentHeight - this.options.estimatedRowHeight : 0;
         this.iframe.setStyle( 'height', decreasedHeight );
      }
      
      if( this.iframe.contentWindow.getScroll().y > 0 )
         this.iframe.setStyle( 'height', this.iframe.getStyle( 'height' ).toInt() + this.options.estimatedRowHeight );
   }.protect(),
   
   tryToIncreaseHeight : function(){
      var heightIncreased = false;
      this.iframe.contentWindow.scrollTo( null, 1 );
      
      while( this.iframe.contentWindow.getScroll().y > 0 ) {
         heightIncreased = true;
         var currentHeight = this.iframe.getStyle( 'height' ).toInt();
         this.iframe.setStyle( 'height', currentHeight + this.options.estimatedRowHeight );
   
         this.iframe.contentWindow.scrollTo( null, 1 );
      }
      
      return heightIncreased;
   }.protect(),
   
   onContainerResize: function( newSize ){
      this.container.setStyle( 'width', newSize.x );
      this.iframe.setStyle( 'width', newSize.x );
      this.adjustIFrameHeight();
   },
   
   attach : function() {
      var self = this;

      // Assign view mode
      this.mode = 'iframe';

      // Editor iframe state
      this.editorDisabled = false;

      // Put textarea inside container
      this.container.wraps( this.textarea );

      this.textarea.setStyle( 'display', 'none' );

      this.iframe.setStyle( 'display', '' ).inject( this.textarea, 'before' );

      if( this.options.handleDialogs ){
         Object.each( this.dialogs, function( action, name ) {
            Object.each( action, function( dialog ) {
               document.id( dialog ).inject( self.iframe, 'before' );
               var range =  null;
               dialog.addEvents( {
                  open : function() {
                     range = self.selection.getRange();
                     self.editorDisabled = true;
                     self.toolbar.disable( name );
                     self.fireEvent( 'dialogOpen', this );
                  },
                  close : function() {
                     self.toolbar.enable();
                     self.editorDisabled = false;
                     self.focus();
                     if( range )
                        self.selection.setRange( range );
                     self.fireEvent( 'dialogClose', this );
                  }} );
            } );
         } );
      }

      // contentWindow and document references
      this.win = this.iframe.contentWindow;
      this.doc = this.win.document;

      // Deal with weird quirks on Gecko
      if( Browser.firefox )
         this.doc.designMode = 'On';

      // Build the content of iframe
      var docHTML = this.options.html.substitute( {
         BASECSS : this.options.baseCSS,
         EXTRACSS : this.options.extraCSS,
         EXTERNALCSS : (this.options.externalCSS) ? this.options.externalCSS : '',
         BASEHREF : (this.options.baseURL) ? '<base href="' + this.options.baseURL + '" />' : ''} );
      this.doc.open();
      this.doc.write( docHTML );
      this.doc.close();

      // Turn on Design Mode
      // IE fired load event twice if designMode is set
      (Browser.ie) ? this.doc.body.contentEditable = true : this.doc.designMode = 'On';

      // Mootoolize window, document and body
      Object.append( this.win, new Window );
      Object.append( this.doc, new Document );
      if( Browser.Element ){
         var winElement = this.win.Element.prototype;
         for( var method in Element ){ // methods from Element generics
            if( !method.test( /^[A-Z]|\$|prototype|mooEditable/ ) ){
               winElement[method] = Element.prototype[method];
            }
         }
      }else{
         document.id( this.doc.body );
      }

      if( Browser.ie ) this.setContent( this.textarea.get( 'html' ));
      else this.setContent( this.textarea.get( 'text' ));

      // Bind all events
      this.doc.addEvents( {
         mouseup : this.editorMouseUp.bind( this ),
         mousedown : this.editorMouseDown.bind( this ),
         mouseover : this.editorMouseOver.bind( this ),
         mouseout : this.editorMouseOut.bind( this ),
         mouseenter : this.editorMouseEnter.bind( this ),
         mouseleave : this.editorMouseLeave.bind( this ),
         contextmenu : this.editorContextMenu.bind( this ),
         click : this.editorClick.bind( this ),
         dblclick : this.editorDoubleClick.bind( this ),
         keypress : this.editorKeyPress.bind( this ),
         keyup : this.editorKeyUp.bind( this ),
         keydown : this.editorKeyDown.bind( this ),
         focus : this.editorFocus.bind( this ),
         blur : this.editorBlur.bind( this )} );
      this.win.addEvents({
         focus : this.editorFocus.bind( this ),
         blur : this.editorBlur.bind( this )
      });
      ['cut', 'copy', 'paste'].each( function( event ) {
         self.doc.body.addListener( event, self['editor' + event.capitalize()].bind( self ) );
      });
      this.textarea.addEvent( 'keypress', this.textarea.retrieve( 'mooeditable:textareaKeyListener', this.keyListener.bind( this ) ) );

      // Fix window focus event not firing on Firefox 2
      if( Browser.firefox2 )
         this.doc.addEvent( 'focus', function() {
            self.win.fireEvent( 'focus' ).focus();
         } );
      // IE9 is also not firing focus event
      if( this.doc.addEventListener )
         this.doc.addEventListener( 'focus', function() {
            self.win.fireEvent( 'focus' );
         }, true );

      // styleWithCSS, not supported in IE and Opera
      if( !Browser.ie && !Browser.opera ){
         var styleCSS = function() {
            self.execute( 'styleWithCSS', false, false );
            self.doc.removeEvent( 'focus', styleCSS );
         };
         this.win.addEvent( 'focus', styleCSS );
      }

      if( this.options.toolbar ){
         document.id( this.toolbar ).inject( this.container, 'top' );
         this.toolbar.render( this.actions );
      }

      if( this.options.disabled )
         this.disable();

      this.selection = new MooEditable.Selection( this.win );

      this.oldContent = this.getContent();

      this.fireEvent( 'attach', this );

      return this;
   },

   detach : function() {
      this.saveContent();
      this.textarea.setStyle( 'display', '' ).removeClass( 'mooeditable-textarea' ).inject( this.container, 'before' );
      this.textarea.removeEvent( 'keypress', this.textarea.retrieve( 'mooeditable:textareaKeyListener' ) );
      if( this.doc && this.doc.removeEvents ) this.doc.removeEvents();
      if( this.win && this.win.removeEvents ) this.win.removeEvents();
      this.container.dispose();
      this.fireEvent( 'detach', this );
      this.removeEvents();
      return this;
   },

   enable : function() {
      this.editorDisabled = false;
      this.toolbar.enable();
      return this;
   },

   disable : function() {
      this.editorDisabled = true;
      this.toolbar.disable();
      return this;
   },

   editorFocus : function( e ) {
      this.oldContent = '';
      this.fireEvent( 'editorFocus', [e, this] );
   },

   editorBlur : function( e ) {
      this.oldContent = this.saveContent().getContent();
      this.fireEvent( 'editorBlur', [e, this] );
   },

   editorMouseUp : function( e ) {
      if( this.editorDisabled ){
         e.stop();
         return;
      }

      if( this.options.toolbar )
         this.checkStates();

      this.fireEvent( 'editorMouseUp', [e, this] );
   },

   editorMouseDown : function( e ) {
      if( this.editorDisabled ){
         e.stop();
         return;
      }

      this.fireEvent( 'editorMouseDown', [e, this] );
   },

   editorMouseOver : function( e ) {
      if( this.editorDisabled ){
         e.stop();
         return;
      }

      this.fireEvent( 'editorMouseOver', [e, this] );
   },

   editorMouseOut : function( e ) {
      if( this.editorDisabled ){
         e.stop();
         return;
      }

      this.fireEvent( 'editorMouseOut', [e, this] );
   },

   editorMouseEnter : function( e ) {
      if( this.editorDisabled ){
         e.stop();
         return;
      }

      if( this.oldContent && this.getContent() != this.oldContent ){
         this.focus();
         this.fireEvent( 'editorPaste', [e, this] );
      }

      this.fireEvent( 'editorMouseEnter', [e, this] );
   },

   editorMouseLeave : function( e ) {
      if( this.editorDisabled ){
         e.stop();
         return;
      }

      this.fireEvent( 'editorMouseLeave', [e, this] );
   },

   editorContextMenu : function( e ) {
      if( this.editorDisabled ){
         e.stop();
         return;
      }

      this.fireEvent( 'editorContextMenu', [e, this] );
   },

   editorClick : function( e ) {
      // make images selectable and draggable in Safari
      if( Browser.safari || Browser.chrome ){
         var el = e.target;
         if( Element.get( el, 'tag' ) == 'img' ){

            // safari doesnt like dragging locally linked images
            if( this.options.baseURL ){
               if( el.getProperty( 'src' ).indexOf( 'http://' ) == -1 ){
                  el.setProperty( 'src', this.options.baseURL + el.getProperty( 'src' ) );
               }
            }

            this.selection.selectNode( el );
            this.checkStates();
         }
      }

      this.fireEvent( 'editorClick', [e, this] );
   },

   editorDoubleClick : function( e ) {
      this.fireEvent( 'editorDoubleClick', [e, this] );
   },

   editorKeyPress : function( e ) {
      if( this.editorDisabled ){
         e.stop();
         return;
      }

      this.keyListener( e );

      this.fireEvent( 'editorKeyPress', [e, this] );
   },

   editorKeyUp : function( e ) {
      if( this.editorDisabled ){
         e.stop();
         return;
      }

      var c = e.code;
      // 33-36 = pageup, pagedown, end, home; 45 = insert
      if( this.options.toolbar && (/^enter|left|up|right|down|delete|backspace$/i.test( e.key ) || (c >= 33 && c <= 36) || c == 45 || e.meta || e.control) ){
         if( Browser.ie6 ){ // Delay for less cpu usage when you are typing
            clearTimeout( this.checkStatesDelay );
            this.checkStatesDelay = this.checkStates.delay( 500, this );
         }else{
            this.checkStates();
         }
      }

      this.adjustIFrameHeight();
      this.fireEvent( 'editorKeyUp', [e, this] );
   },

   editorKeyDown : function( e ) {
      if( this.editorDisabled ){
         e.stop();
         return;
      }

      if( e.key == 'enter' ){
         if( this.options.paragraphise ){
            if( e.shift && (Browser.safari || Browser.chrome) ){
               var s = this.selection;
               var r = s.getRange();

               // Insert BR element
               var br = this.doc.createElement( 'br' );
               r.insertNode( br );

               // Place caret after BR
               r.setStartAfter( br );
               r.setEndAfter( br );
               s.setRange( r );

               // Could not place caret after BR then insert an nbsp entity and move the caret
               if( s.getSelection().focusNode == br.previousSibling ){
                  var nbsp = this.doc.createTextNode( '\u00a0' );
                  var p = br.parentNode;
                  var ns = br.nextSibling;
                  (ns) ? p.insertBefore( nbsp, ns ) : p.appendChild( nbsp );
                  s.selectNode( nbsp );
                  s.collapse( 1 );
               }

               // Scroll to new position, scrollIntoView can't be used
               // due to bug:
               // http://bugs.webkit.org/show_bug.cgi?id=16117
               this.win.scrollTo( 0, Element.getOffsets( s.getRange().startContainer ).y );

               e.preventDefault();
            }else if( Browser.firefox || Browser.safari || Browser.chrome ){
               var node = this.selection.getNode();
               var isBlock = Element.getParents( node ).include( node ).some( function( el ) {
                  return el.nodeName.test( blockEls );
               } );
               if( !isBlock )
                  this.execute( 'insertparagraph' );
            }
         }else{
            if( Browser.ie ){
               var r = this.selection.getRange();
               var node = this.selection.getNode();
               if( r && node.get( 'tag' ) != 'li' ){
                  this.selection.insertContent( '<br>' );
                  this.selection.collapse( false );
               }
               e.preventDefault();
            }
         }
      }

      if( Browser.opera ){
         var ctrlmeta = e.control || e.meta;
         if( ctrlmeta && e.key == 'x' ){
            this.fireEvent( 'editorCut', [e, this] );
         }else if( ctrlmeta && e.key == 'c' ){
            this.fireEvent( 'editorCopy', [e, this] );
         }else if( (ctrlmeta && e.key == 'v') || (e.shift && e.code == 45) ){
            this.fireEvent( 'editorPaste', [e, this] );
         }
      }

      this.fireEvent( 'editorKeyDown', [e, this] );
   },

   editorCut : function( e ) {
      if( this.editorDisabled ){
         e.stop();
         return;
      }

      this.fireEvent( 'editorCut', [e, this] );
   },

   editorCopy : function( e ) {
      if( this.editorDisabled ){
         e.stop();
         return;
      }

      this.fireEvent( 'editorCopy', [e, this] );
   },

   editorPaste : function( e ) {
      if( this.editorDisabled ){
         e.stop();
         return;
      }

      this.fireEvent( 'editorPaste', [e, this] );
   },

   keyListener : function( e ) {
      var key = (Browser.Platform.mac) ? e.meta : e.control;
      if( !key || !this.keys[e.key] )
         return;
      e.preventDefault();
      var item = this.toolbar.getItem( this.keys[e.key] );
      item.action( e );
   },

   focus : function() {
      (this.mode == 'iframe' ? this.win : this.textarea).focus();
      this.fireEvent( 'focus', this );
      return this;
   },

   action : function( command, args ) {
      var action = MooEditable.Actions[command];
      if( action.command && typeOf( action.command ) == 'function' ){
         action.command.apply( this, args );
      }else{
         this.focus();
         this.execute( command, false, args );
         if( this.mode == 'iframe' )
            this.checkStates();
      }
   },

   execute : function( command, param1, param2 ) {
      if( this.busy )
         return;
      this.busy = true;
      this.doc.execCommand( command, param1, param2 );
      this.saveContent();
      this.busy = false;
      return false;
   },

   toggleView : function() {
      this.fireEvent( 'beforeToggleView', this );
      if( this.mode == 'textarea' ){
         this.mode = 'iframe';
         this.iframe.setStyle( 'display', '' );
         this.setContent( this.textarea.value );
         this.textarea.setStyle( 'display', 'none' );
      }else{
         this.saveContent();
         this.mode = 'textarea';
         this.textarea.setStyle( 'display', '' );
         this.iframe.setStyle( 'display', 'none' );
      }
      this.fireEvent( 'toggleView', this );
      this.focus.delay( 10, this );
      return this;
   },

   getContent : function() {
      var protect = this.protectedElements;
      var html = this.doc.body.get( 'html' ).replace( /<!-- mooeditable:protect:([0-9]+) -->/g, function( a, b ) {
         return protect[b.toInt()];
      } );
      return this.cleanup( this.ensureRootElement( html ) );
   },
   
   getFrameScrollTop : function(){
      if( Browser.ie ) return this.doc.documentElement.scrollTop; 
      else return this.iframe.contentWindow.getScroll().y; 
   },

   setContent : function( content ) {
      var protect = this.protectedElements;
      content = content.replace( protectRegex, function( a ) {
         protect.push( a );
         return '<!-- mooeditable:protect:' + (protect.length - 1) + ' -->';
      } );
      this.doc.body.set( 'html', this.ensureRootElement( content ) );
      if( this.options.elasticHeight )  this.adjustIFrameHeight();
      return this;
   },

   saveContent : function() {
      if( this.mode == 'iframe' ){
         if( this.textarea.set ) this.textarea.set( 'value', this.getContent() );
         else this.textarea.value = this.getContent();
      }
      return this;
   },

   ensureRootElement : function( val ) {
      if( this.options.rootElement ){
         var el = new Element( 'div', {
            html : val.trim()} );
         var start = -1;
         var create = false;
         var html = '';
         var length = el.childNodes.length;
         for( var i = 0; i < length; i++ ){
            var childNode = el.childNodes[i];
            var nodeName = childNode.nodeName;
            if( !nodeName.test( blockEls ) && nodeName !== '#comment' ){
               if( nodeName === '#text' ){
                  if( childNode.nodeValue.trim() ){
                     if( start < 0 )
                        start = i;
                     html += childNode.nodeValue;
                  }
               }else{
                  if( start < 0 )
                     start = i;
                  html += new Element( 'div' ).adopt( $( childNode ).clone() ).get( 'html' );
               }
            }else{
               create = true;
            }
            if( i == (length - 1) )
               create = true;
            if( start >= 0 && create ){
               var newel = new Element( this.options.rootElement, {
                  html : html} );
               el.replaceChild( newel, el.childNodes[start] );
               for( var k = start + 1; k < i; k++ ){
                  el.removeChild( el.childNodes[k] );
                  length--;
                  i--;
                  k--;
               }
               start = -1;
               create = false;
               html = '';
            }
         }
         val = el.get( 'html' ).replace( /\n\n/g, '' );
      }
      return val;
   },

   checkStates : function() {
      var element = this.selection.getNode();
      if( !element )
         return;
      if( typeOf( element ) != 'element' )
         return;

      this.actions.each( function( action ) {
         var item = this.toolbar.getItem( action );
         if( !item )
            return;
         item.deactivate();

         var states = MooEditable.Actions[action]['states'];
         if( !states )
            return;

         // custom checkState
         if( typeOf( states ) == 'function' ){
            states.attempt( [document.id( element ), item], this );
            return;
         }

         try{
            if( this.doc.queryCommandState( action ) ){
               item.activate();
               return;
            }
         }catch (e){
         }

         if( states.tags ){
            var el = element;
            do{
               var tag = el.tagName.toLowerCase();
               if( states.tags.contains( tag ) ){
                  item.activate( tag );
                  break;
               }
            }while( (el = Element.getParent( el )) != null );
         }

         if( states.css ){
            var el = element;
            do{
               var found = false;
               for( var prop in states.css ){
                  var css = states.css[prop];
                  if( el.style[prop.camelCase()].contains( css ) ){
                     item.activate( css );
                     found = true;
                  }
               }
               if( found || el.tagName.test( blockEls ) )
                  break;
            }while( (el = Element.getParent( el )) != null );
         }
      }.bind( this ) );
   },

   cleanup : function( source ) {
      if( !this.options.cleanup )
         return source.trim();

      do{
         var oSource = source;

         // replace base URL references: ie localize links
         if( this.options.baseURL ){
            source = source.replace( '="' + this.options.baseURL, '="' );
         }

         // Webkit cleanup
         source = source.replace( /<br class\="webkit-block-placeholder">/gi, "<br />" );
         source = source.replace( /<span class="Apple-style-span">(.*)<\/span>/gi, '$1' );
         source = source.replace( / class="Apple-style-span"/gi, '' );
         source = source.replace( /<span style="">/gi, '' );

         // Remove padded paragraphs
         source = source.replace( /<p>\s*<br ?\/?>\s*<\/p>/gi, '<p>\u00a0</p>' );
         source = source.replace( /<p>(&nbsp;|\s)*<\/p>/gi, '<p>\u00a0</p>' );
         if( !this.options.semantics ){
            source = source.replace( /\s*<br ?\/?>\s*<\/p>/gi, '</p>' );
         }

         // Replace improper BRs (only if XHTML : true)
         if( this.options.xhtml ){
            source = source.replace( /<br>/gi, "<br />" );
         }

         if( this.options.semantics ){
            // remove divs from <li>
            if( Browser.ie ){
               source = source.replace( /<li>\s*<div>(.+?)<\/div><\/li>/g, '<li>$1</li>' );
            }
            // remove stupid apple divs
            if( Browser.safari || Browser.chrome ){
               source = source.replace( /^([\w\s]+.*?)<div>/i, '<p>$1</p><div>' );
               source = source.replace( /<div>(.+?)<\/div>/ig, '<p>$1</p>' );
            }

            // <p> tags around a list will get moved to after the list
            if( !Browser.ie ){
               // not working properly in safari?
               source = source.replace( /<p>[\s\n]*(<(?:ul|ol)>.*?<\/(?:ul|ol)>)(.*?)<\/p>/ig, '$1<p>$2</p>' );
               source = source.replace( /<\/(ol|ul)>\s*(?!<(?:p|ol|ul|img).*?>)((?:<[^>]*>)?\w.*)$/g, '</$1><p>$2</p>' );
            }

            source = source.replace( /<br[^>]*><\/p>/g, '</p>' ); // remove
                                                                  // <br>'s
                                                                  // that
                                                                  // end
                                                                  // a
                                                                  // paragraph
                                                                  // here.
            source = source.replace( /<p>\s*(<img[^>]+>)\s*<\/p>/ig, '$1\n' ); // if a
                                                                                 // <p>
                                                                                 // only
                                                                                 // contains
                                                                                 // <img>,
                                                                                 // remove
                                                                                 // the
                                                                                 // <p>
                                                                                 // tags

            // format the source
            source = source.replace( /<p([^>]*)>(.*?)<\/p>(?!\n)/g, '<p$1>$2</p>\n' ); // break
                                                                                       // after
                                                                                       // paragraphs
            source = source.replace( /<\/(ul|ol|p)>(?!\n)/g, '</$1>\n' ); // break
                                                                           // after
                                                                           // </p></ol></ul>
                                                                           // tags
            source = source.replace( /><li>/g, '>\n\t<li>' ); // break
                                                               // and
                                                               // indent
                                                               // <li>
            source = source.replace( /([^\n])<\/(ol|ul)>/g, '$1\n</$2>' ); // break
                                                                           // before
                                                                           // </ol></ul>
                                                                           // tags
            source = source.replace( /([^\n])<img/ig, '$1\n<img' ); // move
                                                                     // images
                                                                     // to
                                                                     // their
                                                                     // own
                                                                     // line
            source = source.replace( /^\s*$/g, '' ); // delete empty
                                                      // lines in the
                                                      // source code
                                                      // (not working
                                                      // in opera)
         }

         // Remove leading and trailing BRs
         source = source.replace( /<br ?\/?>$/gi, '' );
         source = source.replace( /^<br ?\/?>/gi, '' );

         // Remove useless BRs
         if( this.options.paragraphise )
            source = source.replace( /(h[1-6]|p|div|address|pre|li|ol|ul|blockquote|center|dl|dt|dd)><br ?\/?>/gi, '$1>' );

         // Remove BRs right before the end of blocks
         source = source.replace( /<br ?\/?>\s*<\/(h1|h2|h3|h4|h5|h6|li|p)/gi, '</$1' );

         // Semantic conversion
         source = source.replace( /<span style="font-weight: bold;">(.*)<\/span>/gi, '<strong>$1</strong>' );
         source = source.replace( /<span style="font-style: italic;">(.*)<\/span>/gi, '<em>$1</em>' );
         source = source.replace( /<b\b[^>]*>(.*?)<\/b[^>]*>/gi, '<strong>$1</strong>' );
         source = source.replace( /<i\b[^>]*>(.*?)<\/i[^>]*>/gi, '<em>$1</em>' );
         source = source.replace( /<u\b[^>]*>(.*?)<\/u[^>]*>/gi, '<span style="text-decoration: underline;">$1</span>' );
         source = source.replace( /<strong><span style="font-weight: normal;">(.*)<\/span><\/strong>/gi, '$1' );
         source = source.replace( /<em><span style="font-weight: normal;">(.*)<\/span><\/em>/gi, '$1' );
         source = source.replace( /<span style="text-decoration: underline;"><span style="font-weight: normal;">(.*)<\/span><\/span>/gi, '$1' );
         source = source.replace( /<strong style="font-weight: normal;">(.*)<\/strong>/gi, '$1' );
         source = source.replace( /<em style="font-weight: normal;">(.*)<\/em>/gi, '$1' );

         // Replace uppercase element names with lowercase
         source = source.replace( /<[^> ]*/g, function( match ) {
            return match.toLowerCase();
         } );

         // Replace uppercase attribute names with lowercase
         source = source.replace( /<[^>]*>/g, function( match ) {
            match = match.replace( / [^=]+=/g, function( match2 ) {
               return match2.toLowerCase();
            } );
            return match;
         } );

         // Put quotes around unquoted attributes
         source = source.replace( /<[^!][^>]*>/g, function( match ) {
            match = match.replace( /( [^=]+=)([^"][^ >]*)/g, "$1\"$2\"" );
            return match;
         } );

         // make img tags xhtml compatible <img>,<img></img> -> <img/>
         if( this.options.xhtml ){
            source = source.replace( /<img([^>]+)(\s*[^\/])>(<\/img>)*/gi, '<img$1$2 />' );
         }

         // remove double <p> tags and empty <p> tags
         source = source.replace( /<p>(?:\s*)<p>/g, '<p>' );
         source = source.replace( /<\/p>\s*<\/p>/g, '</p>' );

         // Replace <br>s inside <pre> automatically added by some
         // browsers
         source = source.replace( /<pre[^>]*>.*?<\/pre>/gi, function( match ) {
            return match.replace( /<br ?\/?>/gi, '\n' );
         } );

         // Final trim
         source = source.trim();
      }while( source != oSource );

      return source;
   }

} );

MooEditable.Selection = new Class( {

   initialize : function( win ) {
      this.win = win;
   },

   getSelection : function() {
      this.win.focus();
      return (this.win.getSelection) ? this.win.getSelection() : this.win.document.selection;
   },

   getRange : function() {
      var s = this.getSelection();

      if( !s )
         return null;

      try{
         return s.rangeCount > 0 ? s.getRangeAt( 0 ) : (s.createRange ? s.createRange() : null);
      }catch (e){
         // IE bug when used in frameset
         return this.doc.body.createTextRange();
      }
   },

   setRange : function( range ) {
      if( range.select ){
         Function.attempt( function() {
            range.select();
         } );
      }else{
         var s = this.getSelection();
         if( s.addRange ){
            s.removeAllRanges();
            s.addRange( range );
         }
      }
   },

   selectNode : function( node, collapse ) {
      var r = this.getRange();
      var s = this.getSelection();

      if( r.moveToElementText ){
         Function.attempt( function() {
            r.moveToElementText( node );
            r.select();
         } );
      }else if( s.addRange ){
         collapse ? r.selectNodeContents( node ) : r.selectNode( node );
         s.removeAllRanges();
         s.addRange( r );
      }else{
         s.setBaseAndExtent( node, 0, node, 1 );
      }

      return node;
   },

   isCollapsed : function() {
      var r = this.getRange();
      if( r && r.item ) return false;
      return ( r && r.boundingWidth == 0 ) || this.getSelection().isCollapsed;
   },

   collapse : function( toStart ) {
      var r = this.getRange();
      var s = this.getSelection();

      if( r.select ){
         r.collapse( toStart );
         r.select();
      }else{
         toStart ? s.collapseToStart() : s.collapseToEnd();
      }
   },

   getContent : function() {
      var r = this.getRange();
      var body = new Element( 'body' );

      if( this.isCollapsed() )
         return '';

      if( r.cloneContents ){
         body.appendChild( r.cloneContents() );
      }else if( r.item != undefined || r.htmlText != undefined ){
         body.set( 'html', r.item ? r.item( 0 ).outerHTML : r.htmlText );
      }else{
         body.set( 'html', r.toString() );
      }

      var content = body.get( 'html' );
      return content;
   },

   getText : function() {
      var r = this.getRange();
      var s = this.getSelection();
      return this.isCollapsed() ? '' : r.text || (s.toString ? s.toString() : '');
   },

   getNode : function() {
      var r = this.getRange();

      if( !Browser.ie || Browser.version >= 9 ){
         var el = null;

         if( r ){
            el = r.commonAncestorContainer;

            // Handle selection a image or other control like element such as
            // anchors
            if( !r.collapsed )
               if( r.startContainer == r.endContainer )
                  if( r.startOffset - r.endOffset < 2 )
                     if( r.startContainer.hasChildNodes() )
                        el = r.startContainer.childNodes[r.startOffset];

            while( typeOf( el ) != 'element' )
               el = el.parentNode;
         }

         return document.id( el );
      }

      return document.id( r.item ? r.item( 0 ) : r.parentElement() );
   },

   insertContent : function( content ) {
      if( Browser.ie ){
         var r = this.getRange();
         if( r.pasteHTML ){
            r.pasteHTML( content );
            r.collapse( false );
            r.select();
         }else if( r.insertNode ){
            r.deleteContents();
            if( r.createContextualFragment ){
               r.insertNode( r.createContextualFragment( content ) );
            }else{
               var doc = this.win.document;
               var fragment = doc.createDocumentFragment();
               var temp = doc.createElement( 'div' );
               fragment.appendChild( temp );
               temp.outerHTML = content;
               r.insertNode( fragment );
            }
         }
      }else{
         this.win.document.execCommand( 'insertHTML', false, content );
      }
   }

} );

// Avoiding Locale dependency
// Wrapper functions to be used internally and for plugins, defaults to en-US
var phrases = {};
MooEditable.Locale = {

   define : function( key, value ) {
      if( typeOf( window.Locale ) != 'null' )
         return window.Locale.define( 'en-US', 'MooEditable', key, value );
      if( typeOf( key ) == 'object' )
         Object.merge( phrases, key );
      else
         phrases[key] = value;
   },

   get : function( key ) {
      if( typeOf( window.Locale ) != 'null' )
         return window.Locale.get( 'MooEditable.' + key );
      return key ? phrases[key] : '';
   }

};

MooEditable.Locale.define( {
   ok : 'OK',
   cancel : 'Cancel',
   bold : 'Bold',
   italic : 'Italic',
   underline : 'Underline',
   strikethrough : 'Strikethrough',
   unorderedList : 'Unordered List',
   orderedList : 'Ordered List',
   indent : 'Indent',
   outdent : 'Outdent',
   undo : 'Undo',
   redo : 'Redo',
   removeHyperlink : 'Remove Hyperlink',
   addHyperlink : 'Add Hyperlink',
   selectTextHyperlink : 'Please select the text you wish to hyperlink.',
   enterURL : 'Enter URL',
   enterImageURL : 'Enter image URL',
   addImage : 'Add Image',
   toggleView : 'Toggle View'} );

MooEditable.UI = {};

MooEditable.UI.Toolbar = new Class( {

   Implements : [Events, Options],

   options : {
      /*
       * onItemAction: function(){},
       */
      'class' : ''},

   initialize : function( options ) {
      this.setOptions( options );
      this.el = new Element( 'div', {
         'class' : 'mooeditable-ui-toolbar ' + this.options['class']} );
      this.items = {};
      this.content = null;
   },

   toElement : function() {
      return this.el;
   },

   render : function( actions ) {
      if( this.content ){
         this.el.adopt( this.content );
      }else{
         this.content = actions.map( function( action ) {
            if( action == '|' ){
               return this.addSeparator();
            }else if( action == '/' ){
               return this.addLineSeparator();
            }
            return this.addItem( action );
         }.bind( this ) );
      }
      return this;
   },

   addItem : function( action ) {
      var self = this;
      var act = MooEditable.Actions[action];
      if( !act )
         return;
      var type = act.type || 'button';
      var options = act.options || {};
      var item = new MooEditable.UI[type.camelCase().capitalize()]( Object.append( options, {
         name : action,
         'class' : action + '-item toolbar-item',
         title : act.title,
         onAction : self.itemAction.bind( self )} ) );
      this.items[action] = item;
      document.id( item ).inject( this.el );
      return item;
   },

   getItem : function( action ) {
      return this.items[action];
   },

   addSeparator : function() {
      return new Element( 'span.toolbar-separator' ).inject( this.el );
   },

   addLineSeparator : function() {
      return new Element( 'div.toolbar-line-separator' ).inject( this.el );
   },

   itemAction : function() {
      this.fireEvent( 'itemAction', arguments );
   },

   disable : function( except ) {
      Object.each( this.items, function( item ) {
         (item.name == except) ? item.activate() : item.deactivate().disable();
      } );
      return this;
   },

   enable : function() {
      Object.each( this.items, function( item ) {
         item.enable();
      } );
      return this;
   },

   show : function() {
      this.el.setStyle( 'display', '' );
      return this;
   },

   hide : function() {
      this.el.setStyle( 'display', 'none' );
      return this;
   }

} );

MooEditable.UI.Button = new Class( {

   Implements : [Events, Options],

   options : {
      /*
       * onAction: function(){},
       */
      title : '',
      name : '',
      text : 'Button',
      'class' : '',
      shortcut : '',
      mode : 'icon'},

   initialize : function( options ) {
      this.setOptions( options );
      this.name = this.options.name;
      this.render();
   },

   toElement : function() {
      return this.el;
   },

   render : function() {
      var self = this;
      var key = (Browser.Platform.mac) ? 'Cmd' : 'Ctrl';
      var shortcut = (this.options.shortcut) ? ' ( ' + key + '+' + this.options.shortcut.toUpperCase() + ' )' : '';
      var text = this.options.title || name;
      var title = text + shortcut;
      this.el = new Element( 'button', {
         'class' : 'mooeditable-ui-button ' + self.options['class'],
         title : title,
         html : '<span class="button-icon"></span><span class="button-text">' + text + '</span>',
         events : {
            click : self.click.bind( self ),
            mousedown : function( e ) {
               e.preventDefault();
            }}} );
      if( this.options.mode != 'icon' )
         this.el.addClass( 'mooeditable-ui-button-' + this.options.mode );

      this.active = false;
      this.disabled = false;

      // add hover effect for IE
      if( Browser.ie )
         this.el.addEvents( {
            mouseenter : function( e ) {
               this.addClass( 'hover' );
            },
            mouseleave : function( e ) {
               this.removeClass( 'hover' );
            }} );

      return this;
   },

   click : function( e ) {
      e.preventDefault();
      if( this.disabled )
         return;
      this.action( e );
   },

   action : function() {
      this.fireEvent( 'action', [this].concat( Array.from( arguments ) ) );
   },

   enable : function() {
      if( this.active )
         this.el.removeClass( 'onActive' );
      if( !this.disabled )
         return;
      this.disabled = false;
      this.el.removeClass( 'disabled' ).set( {
         disabled : false,
         opacity : 1} );
      return this;
   },

   disable : function() {
      if( this.disabled )
         return;
      this.disabled = true;
      this.el.addClass( 'disabled' ).set( {
         disabled : true,
         opacity : 0.4} );
      return this;
   },

   activate : function() {
      if( this.disabled )
         return;
      this.active = true;
      this.el.addClass( 'onActive' );
      return this;
   },

   deactivate : function() {
      this.active = false;
      this.el.removeClass( 'onActive' );
      return this;
   }

} );

MooEditable.UI.Dialog = new Class( {

   Implements : [Events, Options],

   options : {
      /*
       * onOpen: function(){}, onClose: function(){},
       */
      'class' : '',
      contentClass : ''},

   initialize : function( html, options ) {
      this.setOptions( options );
      this.html = html;

      var self = this;
      this.el = new Element( 'div', {
         'class' : 'mooeditable-ui-dialog ' + self.options['class'],
         html : '<div class="dialog-content ' + self.options.contentClass + '">' + html + '</div>',
         styles : {
            'display' : 'none'},
         events : {
            click : self.click.bind( self )}} );
   },

   toElement : function() {
      return this.el;
   },

   click : function() {
      this.fireEvent( 'click', arguments );
      return this;
   },

   open : function() {
      this.el.setStyle( 'display', '' );
      this.fireEvent( 'open', this );
      return this;
   },

   close : function() {
      this.el.setStyle( 'display', 'none' );
      this.fireEvent( 'close', this );
      return this;
   }

} );

MooEditable.UI.AlertDialog = function( alertText ) {
   if( !alertText )
      return;
   var html = alertText + ' <button class="dialog-ok-button">' + MooEditable.Locale.get( 'ok' ) + '</button>';
   return new MooEditable.UI.Dialog( html, {
      'class' : 'mooeditable-alert-dialog',
      onOpen : function() {
         var button = this.el.getElement( '.dialog-ok-button' );
         (function() {
            button.focus();
         }).delay( 10 );
      },
      onClick : function( e ) {
         e.preventDefault();
         if( e.target.tagName.toLowerCase() != 'button' )
            return;
         if( document.id( e.target ).hasClass( 'dialog-ok-button' ) )
            this.close();
      }} );
};

MooEditable.UI.PromptDialog = function( questionText, answerText, fn ) {
   if( !questionText )
      return;
   var html = '<label class="dialog-label">' + questionText + ' <input type="text" class="text dialog-input" value="' + answerText + '">'
         + '</label> <button class="dialog-button dialog-ok-button">' + MooEditable.Locale.get( 'ok' ) + '</button>'
         + '<button class="dialog-button dialog-cancel-button">' + MooEditable.Locale.get( 'cancel' ) + '</button>';
   return new MooEditable.UI.Dialog( html, {
      'class' : 'mooeditable-prompt-dialog',
      onOpen : function() {
         var input = this.el.getElement( '.dialog-input' );
         (function() {
            input.focus();
            input.select();
         }).delay( 10 );
      },
      onClick : function( e ) {
         e.preventDefault();
         if( e.target.tagName.toLowerCase() != 'button' )
            return;
         var button = document.id( e.target );
         var input = this.el.getElement( '.dialog-input' );
         if( button.hasClass( 'dialog-cancel-button' ) ){
            input.set( 'value', answerText );
            this.close();
         }else if( button.hasClass( 'dialog-ok-button' ) ){
            var answer = input.get( 'value' );
            input.set( 'value', answerText );
            this.close();
            if( fn )
               fn.attempt( answer, this );
         }
      }} );
};

MooEditable.Actions = {

   bold : {
      title : MooEditable.Locale.get( 'bold' ),
      options : {
         shortcut : 'b'},
      states : {
         tags : ['b', 'strong'],
         css : {
            'font-weight' : 'bold'}},
      events : {
         beforeToggleView : function() {
            if( Browser.firefox ){
               var value = this.textarea.get( 'value' );
               var newValue = value.replace( /<strong([^>]*)>/gi, '<b$1>' ).replace( /<\/strong>/gi, '</b>' );
               if( value != newValue )
                  this.textarea.set( 'value', newValue );
            }
         },
         attach : function() {
            if( Browser.firefox ){
               var value = this.textarea.get( 'value' );
               var newValue = value.replace( /<strong([^>]*)>/gi, '<b$1>' ).replace( /<\/strong>/gi, '</b>' );
               if( value != newValue ){
                  this.textarea.set( 'value', newValue );
                  this.setContent( newValue );
               }
            }
         }}},

   italic : {
      title : MooEditable.Locale.get( 'italic' ),
      options : {
         shortcut : 'i'},
      states : {
         tags : ['i', 'em'],
         css : {
            'font-style' : 'italic'}},
      events : {
         beforeToggleView : function() {
            if( Browser.firefox ){
               var value = this.textarea.get( 'value' );
               var newValue = value.replace( /<embed([^>]*)>/gi, '<tmpembed$1>' ).replace( /<em([^>]*)>/gi, '<i$1>' ).replace( /<tmpembed([^>]*)>/gi,
                     '<embed$1>' ).replace( /<\/em>/gi, '</i>' );
               if( value != newValue )
                  this.textarea.set( 'value', newValue );
            }
         },
         attach : function() {
            if( Browser.firefox ){
               var value = this.textarea.get( 'value' );
               var newValue = value.replace( /<embed([^>]*)>/gi, '<tmpembed$1>' ).replace( /<em([^>]*)>/gi, '<i$1>' ).replace( /<tmpembed([^>]*)>/gi,
                     '<embed$1>' ).replace( /<\/em>/gi, '</i>' );
               if( value != newValue ){
                  this.textarea.set( 'value', newValue );
                  this.setContent( newValue );
               }
            }
         }}},

   underline : {
      title : MooEditable.Locale.get( 'underline' ),
      options : {
         shortcut : 'u'},
      states : {
         tags : ['u'],
         css : {
            'text-decoration' : 'underline'}},
      events : {
         beforeToggleView : function() {
            if( Browser.firefox || Browser.ie ){
               var value = this.textarea.get( 'value' );
               var newValue = value.replace( /<span style="text-decoration: underline;"([^>]*)>/gi, '<u$1>' ).replace( /<\/span>/gi, '</u>' );
               if( value != newValue )
                  this.textarea.set( 'value', newValue );
            }
         },
         attach : function() {
            if( Browser.firefox || Browser.ie ){
               var value = this.textarea.get( 'value' );
               var newValue = value.replace( /<span style="text-decoration: underline;"([^>]*)>/gi, '<u$1>' ).replace( /<\/span>/gi, '</u>' );
               if( value != newValue ){
                  this.textarea.set( 'value', newValue );
                  this.setContent( newValue );
               }
            }
         }}},

   strikethrough : {
      title : MooEditable.Locale.get( 'strikethrough' ),
      options : {
         shortcut : 's'},
      states : {
         tags : ['s', 'strike'],
         css : {
            'text-decoration' : 'line-through'}}},

   insertunorderedlist : {
      title : MooEditable.Locale.get( 'unorderedList' ),
      states : {
         tags : ['ul']}},

   insertorderedlist : {
      title : MooEditable.Locale.get( 'orderedList' ),
      states : {
         tags : ['ol']}},

   indent : {
      title : MooEditable.Locale.get( 'indent' ),
      states : {
         tags : ['blockquote']}},

   outdent : {
      title : MooEditable.Locale.get( 'outdent' )},

   undo : {
      title : MooEditable.Locale.get( 'undo' ),
      options : {
         shortcut : 'z'}},

   redo : {
      title : MooEditable.Locale.get( 'redo' ),
      options : {
         shortcut : 'y'}},

   unlink : {
      title : MooEditable.Locale.get( 'removeHyperlink' )},

   createlink : {
      title : MooEditable.Locale.get( 'addHyperlink' ),
      options : {
         shortcut : 'l'},
      states : {
         tags : ['a']},
      dialogs : {
         alert : MooEditable.UI.AlertDialog.pass( MooEditable.Locale.get( 'selectTextHyperlink' ) ),
         prompt : function( editor ) {
            return MooEditable.UI.PromptDialog( MooEditable.Locale.get( 'enterURL' ), 'http://', function( url ) {
               editor.execute( 'createlink', false, url.trim() );
            } );
         }},
      command : function() {
         var selection = this.selection;
         var dialogs = this.dialogs.createlink;
         if( selection.isCollapsed() ){
            var node = selection.getNode();
            if( node && node.get( 'tag' ) == 'a' && node.get( 'href' ) ){
               selection.selectNode( node );
               var prompt = dialogs.prompt;
               prompt.el.getElement( '.dialog-input' ).set( 'value', node.get( 'href' ) );
               prompt.open();
            }else{
               dialogs.alert.open();
            }
         }else{
            var text = selection.getText();
            var prompt = dialogs.prompt;
            if( urlRegex.test( text ) )
               prompt.el.getElement( '.dialog-input' ).set( 'value', text );
            prompt.open();
         }
      }},

   urlimage : {
      title : MooEditable.Locale.get( 'addImage' ),
      options : {
         shortcut : 'm'},
      dialogs : {
         prompt : function( editor ) {
            return MooEditable.UI.PromptDialog( MooEditable.Locale.get( 'enterImageURL' ), 'http://', function( url ) {
               editor.execute( 'insertimage', false, url.trim() );
            } );
         }},
      command : function() {
         this.dialogs.urlimage.prompt.open();
      }},

   toggleview : {
      title : MooEditable.Locale.get( 'toggleView' ),
      command : function() {
         (this.mode == 'textarea') ? this.toolbar.enable() : this.toolbar.disable( 'toggleview' );
         this.toggleView();
      }}

};

MooEditable.Actions.Settings = {};

Element.Properties.mooeditable = {

   get : function() {
      return this.retrieve( 'MooEditable' );
   }

};

Element.implement( {

   mooEditable : function( options ) {
      var mooeditable = this.get( 'mooeditable' );
      if( !mooeditable )
         mooeditable = new MooEditable( this, options );
      return mooeditable;
   }

});

})();
/*
---

name: MooEditable.Charmap

description: Extends MooEditable with a characters map

license: MIT-style license

authors:
- Ryan Mitchell

requires:
# - MooEditable
# - MooEditable.UI
# - MooEditable.Actions

provides: [MooEditable.UI.CharacterDialog, MooEditable.Actions.charmap]

usage: |
  Add the following tags in your html
  <link rel="stylesheet" href="MooEditable.css">
  <link rel="stylesheet" href="MooEditable.Charmap.css">
  <script src="mootools.js"></script>
  <script src="MooEditable.js"></script>
  <script src="MooEditable.Charmap.js"></script>

  <script>
  window.addEvent('domready', function(){
    var mooeditable = $('textarea-1').mooEditable({
      actions: 'bold italic underline strikethrough | charmap | toggleview',
      externalCSS: '../../Assets/MooEditable/Editable.css'
    });
  });
  </script>

...
*/



MooEditable.Actions.Settings.charmap = {
	chars: [
		['&nbsp;', '&#160;'],
		['&amp;', '&#38;'],
		['&quot;', '&#34;'],
		['&cent;', '&#162;'],
		['&euro;', '&#8364;'],
		['&pound;', '&#163;'],
		['&yen;', '&#165;'],
		['&copy;', '&#169;'],
		['&reg;', '&#174;'],
		['&trade;', '&#8482;'],
		['&permil;', '&#8240;'],
		['&micro;', '&#181;'],
		['&middot;', '&#183;'],
		['&bull;', '&#8226;'],
		['&hellip;', '&#8230;'],
		['&prime;', '&#8242;'],
		['&Prime;', '&#8243;'],
		['&sect;', '&#167;'],
		['&para;', '&#182;'],
		['&szlig;', '&#223;'],
		['&lsaquo;', '&#8249;'],
		['&rsaquo;', '&#8250;'],
		['&laquo;', '&#171;'],
		['&raquo;', '&#187;'],
		['&lsquo;', '&#8216;'],
		['&rsquo;', '&#8217;'],
		['&ldquo;', '&#8220;'],
		['&rdquo;', '&#8221;'],
		['&sbquo;', '&#8218;'],
		['&bdquo;', '&#8222;'],
		['&lt;', '&#60;'],
		['&gt;', '&#62;'],
		['&le;', '&#8804;'],
		['&ge;', '&#8805;'],
		['&ndash;', '&#8211;'],
		['&mdash;', '&#8212;'],
		['&macr;', '&#175;'],
		['&oline;', '&#8254;'],
		['&curren;', '&#164;'],
		['&brvbar;', '&#166;'],
		['&uml;', '&#168;'],
		['&iexcl;', '&#161;'],
		['&iquest;', '&#191;'],
		['&circ;', '&#710;'],
		['&tilde;', '&#732;'],
		['&deg;', '&#176;'],
		['&minus;', '&#8722;'],
		['&plusmn;', '&#177;'],
		['&divide;', '&#247;'],
		['&frasl;', '&#8260;'],
		['&times;', '&#215;'],
		['&sup1;', '&#185;'],
		['&sup2;', '&#178;'],
		['&sup3;', '&#179;'],
		['&frac14;', '&#188;'],
		['&frac12;', '&#189;'],
		['&frac34;', '&#190;'],
		['&fnof;', '&#402;'],
		['&int;', '&#8747;'],
		['&sum;', '&#8721;'],
		['&infin;', '&#8734;'],
		['&radic;', '&#8730;'],
		['&sim;', '&#8764;'],
		['&cong;', '&#8773;'],
		['&asymp;', '&#8776;'],
		['&ne;', '&#8800;'],
		['&equiv;', '&#8801;'],
		['&isin;', '&#8712;'],
		['&notin;', '&#8713;'],
		['&ni;', '&#8715;'],
		['&prod;', '&#8719;'],
		['&and;', '&#8743;'],
		['&or;', '&#8744;'],
		['&not;', '&#172;'],
		['&cap;', '&#8745;'],
		['&cup;', '&#8746;'],
		['&part;', '&#8706;'],
		['&forall;', '&#8704;'],
		['&exist;', '&#8707;'],
		['&empty;', '&#8709;'],
		['&nabla;', '&#8711;'],
		['&lowast;', '&#8727;'],
		['&prop;', '&#8733;'],
		['&ang;', '&#8736;'],
		['&acute;', '&#180;'],
		['&cedil;', '&#184;'],
		['&ordf;', '&#170;'],
		['&ordm;', '&#186;'],
		['&dagger;', '&#8224;'],
		['&Dagger;', '&#8225;'],
		['&Agrave;', '&#192;'],
		['&Aacute;', '&#193;'],
		['&Acirc;', '&#194;'],
		['&Atilde;', '&#195;'],
		['&Auml;', '&#196;'],
		['&Aring;', '&#197;'],
		['&AElig;', '&#198;'],
		['&Ccedil;', '&#199;'],
		['&Egrave;', '&#200;'],
		['&Eacute;', '&#201;'],
		['&Ecirc;', '&#202;'],
		['&Euml;', '&#203;'],
		['&Igrave;', '&#204;'],
		['&Iacute;', '&#205;'],
		['&Icirc;', '&#206;'],
		['&Iuml;', '&#207;'],
		['&ETH;', '&#208;'],
		['&Ntilde;', '&#209;'],
		['&Ograve;', '&#210;'],
		['&Oacute;', '&#211;'],
		['&Ocirc;', '&#212;'],
		['&Otilde;', '&#213;'],
		['&Ouml;', '&#214;'],
		['&Oslash;', '&#216;'],
		['&OElig;', '&#338;'],
		['&Scaron;', '&#352;'],
		['&Ugrave;', '&#217;'],
		['&Uacute;', '&#218;'],
		['&Ucirc;', '&#219;'],
		['&Uuml;', '&#220;'],
		['&Yacute;', '&#221;'],
		['&Yuml;', '&#376;'],
		['&THORN;', '&#222;'],
		['&agrave;', '&#224;'],
		['&aacute;', '&#225;'],
		['&acirc;', '&#226;'],
		['&atilde;', '&#227;'],
		['&auml;', '&#228;'],
		['&aring;', '&#229;'],
		['&aelig;', '&#230;'],
		['&ccedil;', '&#231;'],
		['&egrave;', '&#232;'],
		['&eacute;', '&#233;'],
		['&ecirc;', '&#234;'],
		['&euml;', '&#235;'],
		['&igrave;', '&#236;'],
		['&iacute;', '&#237;'],
		['&icirc;', '&#238;'],
		['&iuml;', '&#239;'],
		['&eth;', '&#240;'],
		['&ntilde;', '&#241;'],
		['&ograve;', '&#242;'],
		['&oacute;', '&#243;'],
		['&ocirc;', '&#244;'],
		['&otilde;', '&#245;'],
		['&ouml;', '&#246;'],
		['&oslash;', '&#248;'],
		['&oelig;', '&#339;'],
		['&scaron;', '&#353;'],
		['&ugrave;', '&#249;'],
		['&uacute;', '&#250;'],
		['&ucirc;', '&#251;'],
		['&uuml;', '&#252;'],
		['&yacute;', '&#253;'],
		['&thorn;', '&#254;'],
		['&yuml;', '&#255;'],
		['&Alpha;', '&#913;'],
		['&Beta;', '&#914;'],
		['&Gamma;', '&#915;'],
		['&Delta;', '&#916;'],
		['&Epsilon;', '&#917;'],
		['&Zeta;', '&#918;'],
		['&Eta;', '&#919;'],
		['&Theta;', '&#920;'],
		['&Iota;', '&#921;'],
		['&Kappa;', '&#922;'],
		['&Lambda;', '&#923;'],
		['&Mu;', '&#924;'],
		['&Nu;', '&#925;'],
		['&Xi;', '&#926;'],
		['&Omicron;', '&#927;'],
		['&Pi;', '&#928;'],
		['&Rho;', '&#929;'],
		['&Sigma;', '&#931;'],
		['&Tau;', '&#932;'],
		['&Upsilon;', '&#933;'],
		['&Phi;', '&#934;'],
		['&Chi;', '&#935;'],
		['&Psi;', '&#936;'],
		['&Omega;', '&#937;'],
		['&alpha;', '&#945;'],
		['&beta;', '&#946;'],
		['&gamma;', '&#947;'],
		['&delta;', '&#948;'],
		['&epsilon;', '&#949;'],
		['&zeta;', '&#950;'],
		['&eta;', '&#951;'],
		['&theta;', '&#952;'],
		['&iota;', '&#953;'],
		['&kappa;', '&#954;'],
		['&lambda;', '&#955;'],
		['&mu;', '&#956;'],
		['&nu;', '&#957;'],
		['&xi;', '&#958;'],
		['&omicron;', '&#959;'],
		['&pi;', '&#960;'],
		['&rho;', '&#961;'],
		['&sigmaf;', '&#962;'],
		['&sigma;', '&#963;'],
		['&tau;', '&#964;'],
		['&upsilon;', '&#965;'],
		['&phi;', '&#966;'],
		['&chi;', '&#967;'],
		['&psi;', '&#968;'],
		['&omega;', '&#969;'],
		['&alefsym;', '&#8501;'],
		['&piv;', '&#982;'],
		['&real;', '&#8476;'],
		['&thetasym;', '&#977;'],
		['&upsih;', '&#978;'],
		['&weierp;', '&#8472;'],
		['&image;', '&#8465;'],
		['&larr;', '&#8592;'],
		['&uarr;', '&#8593;'],
		['&rarr;', '&#8594;'],
		['&darr;', '&#8595;'],
		['&harr;', '&#8596;'],
		['&crarr;', '&#8629;'],
		['&lArr;', '&#8656;'],
		['&uArr;', '&#8657;'],
		['&rArr;', '&#8658;'],
		['&dArr;', '&#8659;'],
		['&hArr;', '&#8660;'],
		['&there4;', '&#8756;'],
		['&sub;', '&#8834;'],
		['&sup;', '&#8835;'],
		['&nsub;', '&#8836;'],
		['&sube;', '&#8838;'],
		['&supe;', '&#8839;'],
		['&oplus;', '&#8853;'],
		['&otimes;', '&#8855;'],
		['&perp;', '&#8869;'],
		['&sdot;', '&#8901;'],
		['&lceil;', '&#8968;'],
		['&rceil;', '&#8969;'],
		['&lfloor;', '&#8970;'],
		['&rfloor;', '&#8971;'],
		['&lang;', '&#9001;'],
		['&rang;', '&#9002;'],
		['&loz;', '&#9674;'],
		['&spades;', '&#9824;'],
		['&clubs;', '&#9827;'],
		['&hearts;', '&#9829;'],
		['&diams;', '&#9830;']
	]
};

MooEditable.Locale.define({
	insertCustomCharacter: 'Insert custom character',
	insertCharacter: 'Insert character'
});

MooEditable.UI.CharacterDialog = function(editor){
	var html = MooEditable.Locale.get('insertCharacter') + ' <select class="char">';
	var chars = MooEditable.Actions.Settings.charmap.chars;
	for (var i=0, len=chars.length; i<len; i++) {
		html += '<option data-code="' + chars[i][0] + '">' + chars[i][1] + '</option>';
	}
	html += '</select>'
		+ '<button class="dialog-button dialog-ok-button">' + MooEditable.Locale.get('ok') + '</button>'
		+ '<button class="dialog-button dialog-cancel-button">' + MooEditable.Locale.get('cancel') + '</button>';
	return new MooEditable.UI.Dialog(html, {
		'class': 'mooeditable-charmap-dialog',
		onClick: function(e){
			if (e.target.tagName.toLowerCase() == 'button') e.preventDefault();
			var button = document.id(e.target);
			if (button.hasClass('dialog-cancel-button')){
				this.close();
			} else if (button.hasClass('dialog-ok-button')){
				this.close();
				var sel = button.getPrevious('select.char');
				var div = new Element('div').set('html', $(sel.options[sel.selectedIndex]).getProperty('data-code').trim());
				editor.selection.insertContent(div.get('html'));
			}
		}
	});
};

MooEditable.Actions.charmap = {
	title: MooEditable.Locale.get('insertCustomCharacter'),
	dialogs: {
		prompt: function(editor){
			return MooEditable.UI.CharacterDialog(editor);
		}
	},
	command: function() {
		this.dialogs.charmap.prompt.open();
	},
	events: {
		toggleView: function(){
			if (this.mode == 'textarea'){
				var s = this.textarea.get('value');
				// when switching from iframe to textarea, we need to convert special symbols to html entities
				MooEditable.Actions.Settings.charmap.chars.each(function(e){
					if (!['&amp;', '&gt;', '&lt;', '&quot;', '&nbsp;'].contains(e[0])){
						var r = new RegExp(String.fromCharCode(parseInt(e[1].replace('&#', '').replace(';', ''))), 'g');
						s = s.replace(r, e[0]);
					}
				}, this);
				this.textarea.set('value', s);
			}
		}
	}
};
/*
---

name: MooEditable.CleanPaste

description: Extends MooEditable to insert text copied from other editors like word without all that messy style-information.

updates in previous version: Improved Internet Explorer handling to break text on to new lines. Improved handling of some styles from newer versions of MS Word to remove extra style tags that were remaining. (David)

updates in this version: Fixed CleanPaste in Safari (Jo)

license: MIT-style license

authors:
- Andr Fiedler <kontakt@visualdrugs.net>
- David Bennett <david@fuzzylime.co.uk>
- Jo Carter <jocarter@holler.co.uk>

requires:
- MooEditable
- MooEditable.Selection
- More/Class.Refactor

usage:
  Add the following tags in your html
  <link rel="stylesheet" href="MooEditable.css">
  <script src="mootools.js"></script>
  <script src="MooEditable.js"></script>
  <script src="MooEditable.CleanPaste.js"></script>

  <script>
  window.addEvent('domready', function (){
    var mooeditable = $('textarea-1').mooEditable();
  });
  </script>

provides: [MooEditable.CleanPaste]

...
*/



(function () {
    
    MooEditable = Class.refactor(MooEditable, {
      
        // @FIXED: Removed because inferred by above and breaks MooEditable completely with MooTools 1.3.
        // Extends: MooEditable,
        
        attach: function () {
            var ret = this.previous();
            this.doc.body.addListener('paste', this.cleanPaste.bind(this));
            return ret;
        },
        
        cleanPaste: function (e) {
            var txtPastet = e.clipboardData && e.clipboardData.getData ?
                e.clipboardData.getData('text/html') : // Standard
                window.clipboardData && window.clipboardData.getData ?
                window.clipboardData.getData('Text') : // MS
                false;
            
            // @FIXED: If !MS and data is not html - try this (ie. pasting plain text)
            if ((!txtPastet || '' === txtPastet.trim()) && e.clipboardData && e.clipboardData.getData) {
              txtPastet = e.clipboardData.getData('Text');
            }
            
            if (!!txtPastet) { // IE and Safari
              if (window.clipboardData) {
                this.selection.insertContent(this.cleanHtml(txtPastet, 1)); // IE
              }
              else {
                this.selection.insertContent(this.cleanHtml(txtPastet)); // Safari
              }
              
              new Event(e).stop();
            }
            else { // no clipboard data available
                this.selection.insertContent('<span id="INSERTION_MARKER">&nbsp;</span>');
                this.txtMarked = this.doc.body.get('html');
                this.doc.body.set('html', '');
                this.replaceMarkerWithPastedText.delay(5, this);
            }
            return this;
        },
        
        replaceMarkerWithPastedText: function () {
            var txtPastetClean = this.cleanHtml(this.doc.body.get('html'));
            this.doc.body.set('html', this.txtMarked);
            this.selection.selectNode(this.doc.body.getElementById('INSERTION_MARKER'));
            this.selection.insertContent(txtPastetClean);
            return this;
        },
        
        cleanHtml: function (html, isie) {
          if (isie) {
            if (!this.options.paragraphise) {
              html = html.replace(/\n/g, "<br />");
            }
            else {
              html = "<p>" + html + "<\/p>";
              html = html.replace(/\n/g, "<\/p><p>");
              html = html.replace(/<p>\s<\/p>/gi, '');
            }
          }
          else {
            // @FIXED: Safari pastes in styles with ' not " - fixed to not be broken in safari
            // @FIXED: Word pastes in Safari
          
            // remove body and html tag
            html = html.replace(/<html[^>]*?>(.*)/gim, "$1");
            html = html.replace(/<\/html>/gi, '');
            html = html.replace(/<body[^>]*?>(.*)/gi, "$1");
            html = html.replace(/<\/body>/gi, '');
          
            // remove style, meta and link tags
            html = html.replace(/<style[^>]*?>[\s\S]*?<\/style[^>]*>/gi, '');
            html = html.replace(/<(?:meta|link)[^>]*>\s*/gi, '');
            
            // remove XML elements and declarations
            html = html.replace(/<\\?\?xml[^>]*>/gi, '');
            
            // remove w: tags with contents.
            html = html.replace(/<w:[^>]*>[\s\S]*?<\/w:[^>]*>/gi, '');
            
            // remove tags with XML namespace declarations: <o:p><\/o:p>
            html = html.replace(/<o:p>\s*<\/o:p>/g, '');
            html = html.replace(/<o:p>[\s\S]*?<\/o:p>/g, '&nbsp;');
            html = html.replace(/<\/?\w+:[^>]*>/gi, '');
            
            // remove comments [SF BUG-1481861].
            html = html.replace(/<\!--[\s\S]*?-->/g, '');
            html = html.replace(/<\!\[[\s\S]*?\]>/g, '');
            
            // remove mso-xxx styles.
            html = html.replace(/\s*mso-[^:]+:[^;"']+;?/gi, '');
            
            // remove styles.
            html = html.replace(/<(\w[^>]*) style='([^\']*)'([^>]*)/gim, "<$1$3");
            html = html.replace(/<(\w[^>]*) style="([^\"]*)"([^>]*)/gim, "<$1$3");
            
            // remove margin styles.
            html = html.replace(/\s*margin: 0cm 0cm 0pt\s*;/gi, '');
            html = html.replace(/\s*margin: 0cm 0cm 0pt\s*"/gi, "\"");
            
            html = html.replace(/\s*text-indent: 0cm\s*;/gi, '');
            html = html.replace(/\s*text-indent: 0cm\s*"/gi, "\"");
            
            html = html.replace(/\s*text-align: [^\s;]+;?"/gi, "\"");
            
            html = html.replace(/\s*page-break-before: [^\s;]+;?"/gi, "\"");
            
            html = html.replace(/\s*font-variant: [^\s;]+;?"/gi, "\"");
            
            html = html.replace(/\s*tab-stops:[^;"']*;?/gi, '');
            html = html.replace(/\s*tab-stops:[^"']*/gi, '');
            
            // remove font face attributes.
            html = html.replace(/\s*face="[^"']*"/gi, '');
            html = html.replace(/\s*face=[^ >]*/gi, '');
            
            html = html.replace(/\s*font-family:[^;"']*;?/gi, '');
            html = html.replace(/\s*font-size:[^;"']*;?/gi, '');
            
            // remove class attributes
            html = html.replace(/<(\w[^>]*) class=([^ |>]*)([^>]*)/gi, "<$1$3");
            
            // remove "display:none" attributes.
            html = html.replace(/<(\w+)[^>]*\sstyle="[^"']*display\s?:\s?none[\s \S]*?<\/\1>/ig, '');
            
            // remove empty styles.
            html = html.replace(/\s*style='\s*'/gi, '');
            html = html.replace(/\s*style="\s*"/gi, '');
            
            html = html.replace(/<span\s*[^>]*>\s*&nbsp;\s*<\/span>/gi, '&nbsp;');
            
            html = html.replace(/<span\s*[^>]*><\/span>/gi, '');
            
            // remove align attributes
            html = html.replace(/<(\w[^>]*) align=([^ |>]*)([^>]*)/gi, "<$1$3");
            
            // remove lang attributes
            html = html.replace(/<(\w[^>]*) lang=([^ |>]*)([^>]*)/gi, "<$1$3");
            
            html = html.replace(/<span([^>]*)>([\s\S]*?)<\/span>/gi, '$2');
            
            html = html.replace(/<font\s*>([\s\S]*?)<\/font>/gi, '$1');
            
            html = html.replace(/<(u|i|strike)>&nbsp;<\/\1>/gi, '&nbsp;');
            
            html = html.replace(/<h\d>\s*<\/h\d>/gi, '');
            
            // remove language attributes
            html = html.replace(/<(\w[^>]*) language=([^ |>]*)([^>]*)/gi, "<$1$3");
            
            // remove onmouseover and onmouseout events (from MS word comments effect)
            html = html.replace(/<(\w[^>]*) onmouseover="([^\"']*)"([^>]*)/gi, "<$1$3");
            html = html.replace(/<(\w[^>]*) onmouseout="([^\"']*)"([^>]*)/gi, "<$1$3");
            
            // the original <Hn> tag sent from word is something like this: <Hn style="margin-top:0px;margin-bottom:0px">
            html = html.replace(/<h(\d)([^>]*)>/gi, '<h$1>');
            
            // word likes to insert extra <font> tags, when using IE. (Weird).
            html = html.replace(/<(h\d)><font[^>]*>([\s\S]*?)<\/font><\/\1>/gi, '<$1>$2<\/$1>');
            html = html.replace(/<(h\d)><em>([\s\S]*?)<\/em><\/\1>/gi, '<$1>$2<\/$1>');
            
            // i -> em, b -> strong - doesn't match nested tags e.g <b><i>some text</i></b> - not possible in regexp 
            // @see - http://stackoverflow.com/questions/1721223/php-regexp-for-nested-div-tags etc.
            html = html.replace(/<b\b[^>]*>(.*?)<\/b[^>]*>/gi, '<strong>$1</strong>');
            html = html.replace(/<i\b[^>]*>(.*?)<\/i[^>]*>/gi, '<em>$1</em>');
            
            // remove "bad" tags
            html = html.replace(/<\s+[^>]*>/gi, '');
            
            // remove empty <span>s (ie. no attributes, no reason for span in pasted text)
            // done twice for nested spans
            html = html.replace(/<span>([\s\S]*?)<\/span>/gi, '$1');
            html = html.replace(/<span>([\s\S]*?)<\/span>/gi, '$1');
            
            // remove empty <div>s (see span)
            html = html.replace(/<div>([\s\S]*?)<\/div>/gi, '$1');
            html = html.replace(/<div>([\s\S]*?)<\/div>/gi, '$1');
            
            // remove empty tags (three times, just to be sure - for nested empty tags).
            // This also removes any empty anchors
            html = html.replace(/<([^\s>]+)(\s[^>]*)?>\s*<\/\1>/g, '');
            html = html.replace(/<([^\s>]+)(\s[^>]*)?>\s*<\/\1>/g, '');
            html = html.replace(/<([^\s>]+)(\s[^>]*)?>\s*<\/\1>/g, '');
            
            html = html.trim();
            
            // Convert <p> to <br />
            if (!this.options.paragraphise) {
                html.replace(/<p>/gi, '<br />');
                html.replace(/<\/p>/gi, '');
            }
            // Check if in paragraph - this fixes FF3.6 and it's <br id=""> issue
            else {
              var check = html.substr(0,2);
              if ('<p' !== check) {
                html = '<p>' + html + '</p>';
                // Replace breaks with paragraphs
                html = html.replace(/\n/g, "<\/p><p>");
                html = html.replace(/<br[^>]*>/gi, '<\/p><p>');
              }
            }
            
            // Make it valid xhtml
            html = html.replace(/<br>/gi, '<br />');
            
            // remove <br>'s that end a paragraph here.
            html = html.replace(/<br[^>]*><\/p>/gim, '</p>');
            
            // remove empty paragraphs - with just a &nbsp; (or whitespace) in (and tags again for good measure)
            html = html.replace(/<p>&nbsp;<\/p>/gi,'');
            html = html.replace(/<p>\s<\/p>/gi, '');
            html = html.replace(/<([^\s>]+)(\s[^>]*)?>\s*<\/\1>/g, '');
            
            html = html.trim();
          }
          
          return html;
        }
    });
    
}());
/*
---

name: MooEditable.Extras

description: Extends MooEditable to include more (simple) toolbar buttons.

license: MIT-style license

authors:
- Lim Chee Aun
- Ryan Mitchell

requires:
# - MooEditable
# - MooEditable.UI
# - MooEditable.UI.MenuList

provides: 
- MooEditable.Actions.formatBlock
- MooEditable.Actions.justifyleft
- MooEditable.Actions.justifyright
- MooEditable.Actions.justifycenter
- MooEditable.Actions.justifyfull
- MooEditable.Actions.removeformat
- MooEditable.Actions.insertHorizontalRule

...
*/



MooEditable.Locale.define({
	blockFormatting: 'Block Formatting',
	paragraph: 'Paragraph',
	heading1: 'Heading 1',
	heading2: 'Heading 2',
	heading3: 'Heading 3',
	alignLeft: 'Align Left',
	alignRight: 'Align Right',
	alignCenter: 'Align Center',
	alignJustify: 'Align Justify',
	removeFormatting: 'Remove Formatting',
	insertHorizontalRule: 'Insert Horizontal Rule'
});

Object.append(MooEditable.Actions, {

	formatBlock: {
		title: MooEditable.Locale.get('blockFormatting'),
		type: 'menu-list',
		options: {
			list: [
				{text: MooEditable.Locale.get('paragraph'), value: 'p'},
				{text: MooEditable.Locale.get('heading1'), value: 'h1', style: 'font-size:24px; font-weight:bold;'},
				{text: MooEditable.Locale.get('heading2'), value: 'h2', style: 'font-size:18px; font-weight:bold;'},
				{text: MooEditable.Locale.get('heading3'), value: 'h3', style: 'font-size:14px; font-weight:bold;'}
			]
		},
		states: {
			tags: ['p', 'h1', 'h2', 'h3']
		},
		command: function(menulist, name){
			var argument = '<' + name + '>';
			this.focus();
			this.execute('formatBlock', false, argument);
		}
	},
	
	justifyleft:{
		title: MooEditable.Locale.get('alignLeft'),
		states: {
			css: {'text-align': 'left'}
		}
	},
	
	justifyright:{
		title: MooEditable.Locale.get('alignRight'),
		states: {
			css: {'text-align': 'right'}
		}
	},
	
	justifycenter:{
		title: MooEditable.Locale.get('alignCenter'),
		states: {
			tags: ['center'],
			css: {'text-align': 'center'}
		}
	},
	
	justifyfull:{
		title: MooEditable.Locale.get('alignJustify'),
		states: {
			css: {'text-align': 'justify'}
		}
	},
	
	removeformat: {
		title: MooEditable.Locale.get('removeFormatting')
	},
	
	insertHorizontalRule: {
		title: MooEditable.Locale.get('insertHorizontalRule'),
		states: {
			tags: ['hr']
		},
		command: function(){
			this.selection.insertContent('<hr>');
		}
	}

});
/*
---

name: MooEditable.Flash

description: Extends MooEditable to embed Flash.

license: MIT-style license

authors:
- Radovan Lozej

requires:
# - MooEditable
# - MooEditable.UI
# - MooEditable.Actions

provides: [MooEditable.UI.FlashDialog, MooEditable.Actions.flash]

usage: |
  Add the following tags in your html
  <link rel="stylesheet" href="MooEditable.css">
  <link rel="stylesheet" href="MooEditable.Flash.css">
  <script src="mootools.js"></script>
  <script src="MooEditable.js"></script>
  <script src="MooEditable.Flash.js"></script>

  <script>
  window.addEvent('domready', function(){
    var mooeditable = $('textarea-1').mooEditable({
      actions: 'bold italic underline strikethrough | flash | toggleview',
      externalCSS: '../../Assets/MooEditable/Editable.css'
    });
  });
  </script>

...
*/



MooEditable.Locale.define({
	embed: 'Enter embed code',
	flashEmbed: 'Flash Embed'
});

MooEditable.UI.FlashDialog = function(editor){
	var html = MooEditable.Locale.get('embed') + ' <textarea class="dialog-f" value="" rows="2" cols="40"></textarea> '
		+ '<button class="dialog-button dialog-ok-button">' + MooEditable.Locale.get('ok') + '</button> '
		+ '<button class="dialog-button dialog-cancel-button">' + MooEditable.Locale.get('cancel') + '</button>';
	return new MooEditable.UI.Dialog(html, {
		'class': 'mooeditable-flash-dialog',
		onOpen: function(){
			var input = this.el.getElement('.dialog-f');
			(function(){
				input.focus();
				input.select();
			}).delay(10);
		},
		onClick: function(e){
			if (e.target.tagName.toLowerCase() == 'button') e.preventDefault();
			var button = document.id(e.target);
			if (button.hasClass('dialog-cancel-button')){
				this.close();
			} else if (button.hasClass('dialog-ok-button')){
				this.close();
				var div = new Element('div').set('html', this.el.getElement('.dialog-f').get('value').trim());
				editor.selection.insertContent(div.get('html'));
			}
		}
	});
};

MooEditable.Actions.flash = {
	title: MooEditable.Locale.get('flashEmbed'),
	dialogs: {
		prompt: function(editor){
			return MooEditable.UI.FlashDialog(editor);
		}
	},
	command: function(){
		this.dialogs.flash.prompt.open();
	}
};
/*
---

name: MooEditable.Forecolor

description: Extends MooEditable to change the color of the text from a list a predefined colors.

license: MIT-style license

authors:
- Olivier Refalo

requires:
# - MooEditable
# - MooEditable.UI
# - MooEditable.UI.ButtonOverlay
# - MooEditable.Actions

provides: [MooEditable.Actions.forecolor]

usage: |
  Add the following tags in your html
  <link rel="stylesheet" href="MooEditable.css">
  <link rel="stylesheet" href="MooEditable.Forecolor.css">
  <script src="mootools.js"></script>
  <script src="MooEditable.js"></script>
  <script src="MooEditable.UI.ButtonOverlay.js"></script>
  <script src="MooEditable.Forecolor.js"></script>

  <script>
  window.addEvent('domready', function(){
    var mooeditable = $('textarea-1').mooEditable({
      actions: 'bold italic underline strikethrough | forecolor | toggleview'
    });
  });
  </script>

...
*/



MooEditable.Actions.Settings.forecolor = {
	colors: [
		['000000', '993300', '333300', '003300', '003366', '000077', '333399', '333333'],
		['770000', 'ff6600', '777700', '007700', '007777', '0000ff', '666699', '777777'],
		['ff0000', 'ff9900', '99cc00', '339966', '33cccc', '3366f0', '770077', '999999'],
		['ff00ff', 'ffcc00', 'ffff00', '00ff00', '00ffff', '00ccff', '993366', 'cccccc'],
		['ff99cc', 'ffcc99', 'ffff99', 'ccffcc', 'ccffff', '99ccff', 'cc9977', 'ffffff']
	]
};

MooEditable.Locale.define('changeColor', 'Change Color');

MooEditable.Actions.forecolor = {
	type: 'button-overlay',
	title: MooEditable.Locale.get('changeColor'),
	options: {
		overlaySize: {x: 'auto'},
		overlayHTML: (function(){
			var html = '';
			MooEditable.Actions.Settings.forecolor.colors.each(function(row){
				row.each(function(c){
					html += '<a href="#" class="forecolor-colorpicker-color" style="background-color: #' + c + '" title="#' + c.toUpperCase() + '"></a>'; 
				});
				html += '<span class="forecolor-colorpicker-br"></span>';
			});
			return html;
		})()
	},
	command: function(buttonOverlay, e){
		var el = e.target;
		if (el.tagName.toLowerCase() != 'a') return;
		var color = $(el).getStyle('background-color');
		this.execute('forecolor', false, color);
		this.focus();
	}
};
/*
---

name: MooEditable.Group

description: Extends MooEditable to have multiple instances on a page controlled by one toolbar.

license: MIT-style license

authors:
- Ryan Mitchell

requires:
# - MooEditable
# - MooEditable.UI
# - MooEditable.Actions

provides: [MooEditable.Group]

...
*/



MooEditable.Group = new Class({

	Implements: [Options],
	
	options: {
		actions: 'bold italic underline strikethrough | insertunorderedlist insertorderedlist indent outdent | undo redo | createlink unlink | urlimage | toggleview'
	},
    
	initialize: function(toolbarEl, options){
		this.setOptions(options);
		this.actions = this.options.actions.clean().split(' ');
		var self = this;
		this.toolbar = new MooEditable.UI.Toolbar({
			onItemAction: function(){
				var args = Array.from(arguments);
				var item = args[0];
				if (!self.activeEditor) return;
				self.activeEditor.focus();
				self.activeEditor.action(item.name, args);
				if (self.activeEditor.mode == 'iframe') self.activeEditor.checkStates();
			}
		}).render(this.actions);
		document.id(toolbarEl).adopt(this.toolbar);
	},

	add: function(textarea, options){
		return this.activeEditor = new MooEditable.Group.Item(textarea, this, Object.merge({toolbar: false}, this.options, options));
	}
	
});


MooEditable.Group.Item = new Class({

	Extends: MooEditable,

	initialize: function(textarea, group, options){
		var self = this;
		this.group = group;
		this.parent(textarea, options);
		this.addEvent('attach', function(){
			var focus = function(){
				if (this == self.win) self.group.activeEditor = self;
			};
			self.textarea.addEvent('focus', focus);
			self.win.addEvent('focus', focus);
		});
	}

});
/*
---

name: MooEditable.Image

description: Extends MooEditable to insert image with manipulation options.

license: MIT-style license

authors:
- Radovan Lozej

requires:
# - MooEditable
# - MooEditable.UI
# - MooEditable.Actions

provides: [MooEditable.UI.ImageDialog, MooEditable.Actions.image]

usage: |
  Add the following tags in your html
  <link rel="stylesheet" href="MooEditable.css">
  <link rel="stylesheet" href="MooEditable.Image.css">
  <script src="mootools.js"></script>
  <script src="MooEditable.js"></script>
  <script src="MooEditable.Image.js"></script>

  <script>
  window.addEvent('domready', function(){
    var mooeditable = $('textarea-1').mooEditable({
      actions: 'bold italic underline strikethrough | image | toggleview'
    });
  });
  </script>

...
*/



MooEditable.Locale.define({
	imageAlt: 'alt',
	imageClass: 'class',
	imageAlign: 'align',
	imageAlignNone: 'none',
	imageAlignLeft: 'left',
	imageAlignCenter: 'center',
	imageAlignRight: 'right',
	addEditImage: 'Add/Edit Image'
});

MooEditable.UI.ImageDialog = function(editor){
	var html = MooEditable.Locale.get('enterImageURL') + ' <input type="text" class="dialog-url" value="" size="15"> '
		+ MooEditable.Locale.get('imageAlt') + ' <input type="text" class="dialog-alt" value="" size="8"> '
		+ MooEditable.Locale.get('imageClass') + ' <input type="text" class="dialog-class" value="" size="8"> '
		+ MooEditable.Locale.get('imageAlign') + ' <select class="dialog-align">'
			+ '<option>' + MooEditable.Locale.get('imageAlignNone') + '</option>'
			+ '<option>' + MooEditable.Locale.get('imageAlignLeft') + '</option>'
			+ '<option>' + MooEditable.Locale.get('imageAlignCenter') + '</option>'
			+ '<option>' + MooEditable.Locale.get('imageAlignRight') + '</option>'
		+ '</select> '
		+ '<button class="dialog-button dialog-ok-button">' + MooEditable.Locale.get('ok') + '</button> '
		+ '<button class="dialog-button dialog-cancel-button">' + MooEditable.Locale.get('cancel') + '</button>';
		
	return new MooEditable.UI.Dialog(html, {
		'class': 'mooeditable-image-dialog',
		onOpen: function(){
			var input = this.el.getElement('.dialog-url');
			var node = editor.selection.getNode();
			if (node.get('tag') == 'img'){
				this.el.getElement('.dialog-url').set('value', node.get('src'));
				this.el.getElement('.dialog-alt').set('value', node.get('alt'));
				this.el.getElement('.dialog-class').set('value', node.className);
				this.el.getElement('.dialog-align').set('align', node.get('align'));
			}
			(function(){
				input.focus();
				input.select();
			}).delay(10);
		},
		onClick: function(e){
			if (e.target.tagName.toLowerCase() == 'button') e.preventDefault();
			var button = document.id(e.target);
			if (button.hasClass('dialog-cancel-button')){
				this.close();
			} else if (button.hasClass('dialog-ok-button')){
				this.close();
				var dialogAlignSelect = this.el.getElement('.dialog-align');
				var node = editor.selection.getNode();
				if (node.get('tag') == 'img'){
					node.set('src', this.el.getElement('.dialog-url').get('value').trim());
					node.set('alt', this.el.getElement('.dialog-alt').get('value').trim());
					node.className = this.el.getElement('.dialog-class').get('value').trim();
					node.set('align', $(dialogAlignSelect.options[dialogAlignSelect.selectedIndex]).get('value'));
				} else {
					var div = new Element('div');
					new Element('img', {
						src: this.el.getElement('.dialog-url').get('value').trim(),
						alt: this.el.getElement('.dialog-alt').get('value').trim(),
						'class': this.el.getElement('.dialog-class').get('value').trim(),
						align: $(dialogAlignSelect.options[dialogAlignSelect.selectedIndex]).get('value')
					}).inject(div);
					editor.selection.insertContent(div.get('html'));
				}
			}
		}
	});
};

MooEditable.Actions.image = {
	title: MooEditable.Locale.get('addEditImage'),
	options: {
		shortcut: 'm'
	},
	dialogs: {
		prompt: function(editor){
			return MooEditable.UI.ImageDialog(editor);
		}
	},
	command: function(){
		this.dialogs.image.prompt.open();
	}
};
/*
---

name: MooEditable.Pagebreak

description: Extends MooEditable with pagebreak plugin

license: MIT-style license

authors:
- Ryan Mitchell

requires:
# - MooEditable
# - MooEditable.UI
# - MooEditable.Actions

provides: [MooEditable.Actions.pagebreak]

usage: |
  Add the following tags in your html
  <link rel="stylesheet" href="MooEditable.css">
  <link rel="stylesheet" href="MooEditable.Pagebreak.css">
  <script src="mootools.js"></script>
  <script src="MooEditable.js"></script>
  <script src="MooEditable.Pagebreak.js"></script>

  <script>
  window.addEvent('domready', function(){
    var mooeditable = $('textarea-1').mooEditable({
      actions: 'bold italic underline strikethrough | pagebreak | toggleview',
      externalCSS: '../../Assets/MooEditable/Editable.css'
    });
  });
  </script>

...
*/



MooEditable.Actions.Settings.pagebreak = {
	imageFile: '../../Assets/MooEditable/Other/pagebreak.gif'
};

MooEditable.Locale.define('pageBreak', 'Page break');

MooEditable.Actions.pagebreak = {
	title: MooEditable.Locale.get('pageBreak'),
	command: function(){
		this.selection.insertContent('<img class="mooeditable-visual-aid mooeditable-pagebreak">');
	},
	events: {
		attach: function(editor){
			if (Browser.ie){
				// addListener instead of addEvent, because controlselect is a native event in IE
				editor.doc.addListener('controlselect', function(e){
					var el = e.target || e.srcElement;
					if (el.tagName.toLowerCase() != 'img') return;
					if (!document.id(el).hasClass('mooeditable-pagebreak')) return;
					if (e.preventDefault){
						e.preventDefault();
					} else {
						e.returnValue = false;
					}
				});
			}
		},
		editorMouseDown: function(e, editor){
			var el = e.target;
			var isSmiley = (el.tagName.toLowerCase() == 'img') && $(el).hasClass('mooeditable-pagebreak');
			Function.attempt(function(){
				editor.doc.execCommand('enableObjectResizing', false, !isSmiley);
			});
		},
		beforeToggleView: function(){ // code to run when switching from iframe to textarea
			if (this.mode == 'iframe'){
				var s = this.getContent().replace(/<img([^>]*)class="mooeditable-visual-aid mooeditable-pagebreak"([^>]*)>/gi, '<!-- page break -->');
				this.setContent(s);
			} else {
				var s = this.textarea.get('value').replace(/<!-- page break -->/gi, '<img class="mooeditable-visual-aid mooeditable-pagebreak">');
				this.textarea.set('value', s);
			}
		},
		render: function(){
			this.options.extraCSS = 'img.mooeditable-pagebreak { display:block; width:100%; height:16px; background: url('
				+ MooEditable.Actions.Settings.pagebreak.imageFile + ') repeat-x; }'
				+ this.options.extraCSS;
		}
	}
};
/*
---

name: MooEditable.Smiley

description: Extends MooEditable to insert smiley/emoticons.

license: MIT-style license

authors:
- Olivier Refalo

requires:
# - MooEditable
# - MooEditable.UI
# - MooEditable.UI.ButtonOverlay
# - MooEditable.Actions

provides: [MooEditable.Actions.smiley]

usage: |
  Add the following tags in your html
  <link rel="stylesheet" href="MooEditable.css">
  <link rel="stylesheet" href="MooEditable.Smiley.css">
  <script src="mootools.js"></script>
  <script src="MooEditable.js"></script>
  <script src="MooEditable.UI.ButtonOverlay.js"></script>
  <script src="MooEditable.Smiley.js"></script>

  <script>
  window.addEvent('domready', function(){
    var mooeditable = $('textarea-1').mooEditable({
      actions: 'bold italic underline strikethrough | smiley | toggleview'
    });
  });
  </script>

...
*/



MooEditable.Actions.Settings.smiley = {
	imagesPath: '../../Assets/MooEditable/Smiley/',
	smileys: ['angryface', 'blush', 'gasp', 'grin', 'halo', 'lipsaresealed', 'smile', 'undecided', 'wink'],
	fileExt: '.png'
};

MooEditable.Locale.define('insertSmiley', 'Insert Smiley');

MooEditable.Actions.smiley = {
	type: 'button-overlay',
	title: MooEditable.Locale.get('insertSmiley'),
	options: {
		overlaySize: {x: 'auto'},
		overlayHTML: (function(){
			var settings = MooEditable.Actions.Settings.smiley;
			var html = '';
			settings.smileys.each(function(s){
				html += '<img src="'+ settings.imagesPath + s + settings.fileExt + '" alt="" class="smiley-image">'; 
			});
			return html;
		})()
	},
	command: function(buttonOverlay, e){
		var el = e.target;
		if (el.tagName.toLowerCase() != 'img') return;
		var src = $(el).get('src');
		var content = '<img style="border:0;" class="smiley" src="' + src + '" alt="">';
		this.focus();
		this.selection.insertContent(content);
	},
	events: {
		attach: function(editor){
			if (Browser.ie){
				// addListener instead of addEvent, because controlselect is a native event in IE
				editor.doc.addListener('controlselect', function(e){
					var el = e.target || e.srcElement;
					if (el.tagName.toLowerCase() != 'img') return;
					if (!document.id(el).hasClass('smiley')) return;
					if (e.preventDefault){
						e.preventDefault();
					} else {
						e.returnValue = false;
					}
				});
			}
		},
		editorMouseDown: function(e, editor){
			var el = e.target;
			var isSmiley = (el.tagName.toLowerCase() == 'img') && $(el).hasClass('smiley');
			Function.attempt(function(){
				editor.doc.execCommand('enableObjectResizing', false, !isSmiley);
			});
		}
	}
};
/*
---

name: MooEditable.Table

description: Extends MooEditable to insert table with manipulation options.

license: MIT-style license

authors:
- Radovan Lozej
- Ryan Mitchell

requires:
# - MooEditable
# - MooEditable.UI
# - MooEditable.Actions

provides:
- MooEditable.UI.TableDialog
- MooEditable.Actions.tableadd
- MooEditable.Actions.tableedit
- MooEditable.Actions.tablerowadd
- MooEditable.Actions.tablerowedit
- MooEditable.Actions.tablerowspan
- MooEditable.Actions.tablerowsplit
- MooEditable.Actions.tablerowdelete
- MooEditable.Actions.tablecoladd
- MooEditable.Actions.tablecoledit
- MooEditable.Actions.tablecolspan
- MooEditable.Actions.tablecolsplit
- MooEditable.Actions.tablecoldelete

usage: |
  Add the following tags in your html
  <link rel="stylesheet" href="MooEditable.css">
  <link rel="stylesheet" href="MooEditable.Table.css">
  <script src="mootools.js"></script>
  <script src="MooEditable.js"></script>
  <script src="MooEditable.Table.js"></script>

  <script>
  window.addEvent('domready', function(){
    var mooeditable = $('textarea-1').mooEditable({
      actions: 'bold italic underline strikethrough | table | toggleview'
    });
  });
  </script>

...
*/



MooEditable.Locale.define({
	tableColumns: 'columns',
	tableRows: 'rows',
	tableWidth: 'width',
	tableClass: 'class',
	tableType: 'type',
	tableHeader: 'Header',
	tableCell: 'Cell',
	tableAlign: 'align',
	tableAlignNone: 'none',
	tableAlignCenter: 'center',
	tableAlignRight: 'right',
	tableValign: 'vertical align',
	tableValignNone: 'none',
	tableValignTop: 'top',
	tableValignMiddle: 'middle',
	tableValignBottom: 'bottom',
	addTable: 'Add Table',
	editTable: 'Edit Table',
	addTableRow: 'Add Table Row',
	editTableRow: 'Edit Table Row',
	mergeTableRow: 'Merge Table Row',
	splitTableRow: 'Split Table Row',
	deleteTableRow: 'Delete Table Row',
	addTableCol: 'Add Table Column',
	editTableCol: 'Edit Table Column',
	mergeTableCell: 'Merge Table Cell',
	splitTableCell: 'Split Table Cell',
	deleteTableCol: 'Delete Table Column'
});

MooEditable.UI.TableDialog = function(editor, dialog){
	var html = {
		tableadd: MooEditable.Locale.get('tableColumns') + ' <input type="text" class="table-c" value="" size="4"> '
			+ MooEditable.Locale.get('tableRows') + ' <input type="text" class="table-r" value="" size="4"> ',
		tableedit: MooEditable.Locale.get('tableWidth') + ' <input type="text" class="table-w" value="" size="4"> '
			+ MooEditable.Locale.get('tableClass') + ' <input type="text" class="table-c" value="" size="15"> ',
		tablerowedit: MooEditable.Locale.get('tableClass') + ' <input type="text" class="table-c" value="" size="15"> '
			+ MooEditable.Locale.get('tableType') + ' <select class="table-c-type">'
				+ '<option value="th">' + MooEditable.Locale.get('tableHeader') + '</option>'
				+ '<option value="td">' + MooEditable.Locale.get('tableCell') + '</option>'
			+ '</select> ',
		tablecoledit: MooEditable.Locale.get('tableWidth') + ' <input type="text" class="table-w" value="" size="4"> '
			+ MooEditable.Locale.get('tableClass') + ' <input type="text" class="table-c" value="" size="15"> '
			+ MooEditable.Locale.get('tableAlign') + ' <select class="table-a">'
				+ '<option>' + MooEditable.Locale.get('tableAlignNone') + '</option>'
				+ '<option>' + MooEditable.Locale.get('tableAlignLeft') + '</option>'
				+ '<option>' + MooEditable.Locale.get('tableAlignCenter') + '</option>'
				+ '<option>' + MooEditable.Locale.get('tableAlignRight') + '</option>'
			+ '</select> '
			+ MooEditable.Locale.get('tableValign') + ' <select class="table-va">'
				+ '<option>' + MooEditable.Locale.get('tableValignNone') + '</option>'
				+ '<option>' + MooEditable.Locale.get('tableValignTop') + '</option>'
				+ '<option>' + MooEditable.Locale.get('tableValignMiddle') + '</option>'
				+ '<option>' + MooEditable.Locale.get('tableValignBottom') + '</option>'
			+ '</select> '
	};
	html[dialog] += '<button class="dialog-button dialog-ok-button">' + MooEditable.Locale.get('ok') + '</button>'
		+ '<button class="dialog-button dialog-cancel-button">' + MooEditable.Locale.get('cancel') + '</button>';
		
	var action = {
		tableadd: {
			click: function(e){
				var col = this.el.getElement('.table-c').value.toInt();
				var row = this.el.getElement('.table-r').value.toInt();
				if (!(row>0 && col>0)) return;
				var div, table, tbody, ro = [];
				div = new Element('tdiv');
				table = new Element('table').set('border', 0).set('width', '100%').inject(div);
				tbody = new Element('tbody').inject(table);
				for (var r = 0; r<row; r++){
					ro[r] = new Element('tr').inject(tbody, 'bottom');
					for (var c=0; c<col; c++) new Element('td').set('html', '&nbsp;').inject(ro[r], 'bottom');
				}
				editor.selection.insertContent(div.get('html'));
			}
		},
		tableedit: {
			load: function(e){
				var node = editor.selection.getNode().getParent('table');
				this.el.getElement('.table-w').set('value', node.get('width'));
				this.el.getElement('.table-c').set('value', node.className);
			},
			click: function(e){
				var node = editor.selection.getNode().getParent('table');
				node.set('width', this.el.getElement('.table-w').value);
				node.className = this.el.getElement('.table-c').value;
			}
		},
		tablerowedit: {
			load: function(e){
				var node = editor.selection.getNode().getParent('tr');
				this.el.getElement('.table-c').set('value', node.className);
				this.el.getElement('.table-c-type').set('value', editor.selection.getNode().get('tag'));
			},
			click: function(e){
				var node = editor.selection.getNode().getParent('tr');
				node.className = this.el.getElement('.table-c').value;
				node.getElements('td, th').each(function(c){
					if (this.el.getElement('.table-c-type') != c.get('tag')){
						var n = editor.doc.createElement(this.el.getElement('.table-c-type').get('value'));
						$(n).set('html', c.get('html')).replaces(c);
					}
				}, this);
			}
		},
		tablecoledit: {
			load : function(e){
				var node = editor.selection.getNode();
				if (node.get('tag') != 'td') node = node.getParent('td');
				this.el.getElement('.table-w').set('value', node.get('width'));
				this.el.getElement('.table-c').set('value', node.className);
				this.el.getElement('.table-a').set('value', node.get('align'));
				this.el.getElement('.table-va').set('value', node.get('valign'));
			},
			click: function(e){
				var node = editor.selection.getNode();
				if (node.get('tag') != 'td') node = node.getParent('td');
				node.set('width', this.el.getElement('.table-w').value);
				node.className = this.el.getElement('.table-c').value;
				node.set('align', this.el.getElement('.table-a').value);
				node.set('valign', this.el.getElement('.table-va').value);
			}
		}
	};
	
	return new MooEditable.UI.Dialog(html[dialog], {
		'class': 'mooeditable-table-dialog',
		onOpen: function(){
			if (action[dialog].load) action[dialog].load.apply(this);
			var input = this.el.getElement('input');
			(function(){ input.focus(); }).delay(10);
		},
		onClick: function(e){
			if (e.target.tagName.toLowerCase() == 'button') e.preventDefault();
			var button = document.id(e.target);
			if (button.hasClass('dialog-cancel-button')){
				this.close();
			} else if (button.hasClass('dialog-ok-button')){
				this.close();
				action[dialog].click.apply(this);
			}
		}
	});
};

Object.append(MooEditable.Actions, {

	tableadd:{
		title: MooEditable.Locale.get('addTable'),
		dialogs: {
			prompt: function(editor){
				return MooEditable.UI.TableDialog(editor, 'tableadd');
			}
		},
		command: function(){
			this.dialogs.tableadd.prompt.open();
		}
	},
	
	tableedit:{
		title: MooEditable.Locale.get('editTable'),
		dialogs: {
			prompt: function(editor){
				return MooEditable.UI.TableDialog(editor, 'tableedit');
			}
		},
		command: function(){
			if (this.selection.getNode().getParent('table')) this.dialogs.tableedit.prompt.open();
		}
	},
	
	tablerowadd:{
		title: 'Add Row',
		command: function(){
			var node = this.selection.getNode().getParent('tr');
			if (node) node.clone().inject(node, 'after');
		}
	},
	
	tablerowedit:{
		title: MooEditable.Locale.get('editTableRow'),
		dialogs: {
			prompt: function(editor){
				return MooEditable.UI.TableDialog(editor, 'tablerowedit');
			}
		},
		command: function(){
			if (this.selection.getNode().getParent('table')) this.dialogs.tablerowedit.prompt.open();
		}
	},
	
	tablerowspan:{
		title: MooEditable.Locale.get('mergeTableRow'),
		command: function(){
			var node = this.selection.getNode();
			if (node.get('tag') != 'td') node = node.getParent('td');
			if (node){
				var index = node.cellIndex;
				var row = node.getParent().rowIndex;
				if (node.getParent().getParent().childNodes[row+node.rowSpan]){
					node.getParent().getParent().childNodes[row+node.rowSpan].deleteCell(index);
					node.rowSpan++;
				}
			}
		}
	},
	
	tablerowsplit:{
		title: MooEditable.Locale.get('splitTableRow'),
		command: function(){
			var node = this.selection.getNode();
			if (node.get('tag') != 'td') node = node.getParent('td');
			if (node){
				var index = node.cellIndex;
				var row = node.getParent().rowIndex;
				if (node.getProperty('rowspan')){
					var rows = parseInt(node.getProperty('rowspan'));
					for (i=1; i<rows; i++){
						node.getParent().getParent().childNodes[row+i].insertCell(index);
					}
					node.removeProperty('rowspan');
				}
			}
		},
		states: function(node){
			if (node.get('tag') != 'td') return;
			if (node){
				if (node.getProperty('rowspan') && parseInt(node.getProperty('rowspan')) > 1){
					this.el.addClass('onActive');
				}
			}
		}
	},
	
	tablerowdelete:{
		title: MooEditable.Locale.get('deleteTableRow'),
		command: function(){
			var node = this.selection.getNode().getParent('tr');
			if (node) node.getParent().deleteRow(node.rowIndex);
		}
	},
	
	tablecoladd:{
		title: MooEditable.Locale.get('addTableCol'),
		command: function(){
			var node = this.selection.getNode();
			if (node.get('tag') != 'td') node = node.getParent('td');
			if (node){
				var index = node.cellIndex;
				var len = node.getParent().getParent().childNodes.length;
				for (var i=0; i<len; i++){
					var ref = $(node.getParent().getParent().childNodes[i].childNodes[index]);
					ref.clone().inject(ref, 'after');
				}
			}
		}
	},
	
	tablecoledit:{
		title: MooEditable.Locale.get('editTableCol'),
		dialogs: {
			prompt: function(editor){
				return MooEditable.UI.TableDialog(editor, 'tablecoledit');
			}
		},
		command: function(){
			if (this.selection.getNode().getParent('table')) this.dialogs.tablecoledit.prompt.open();
		}
	},
	
	tablecolspan:{
		title: MooEditable.Locale.get('mergeTableCell'),
		command: function(){
			var node = this.selection.getNode();
			if (node.get('tag')!='td') node = node.getParent('td');
			if (node){
				var index = node.cellIndex + 1;
				if (node.getParent().childNodes[index]){
					node.getParent().deleteCell(index);
					node.colSpan++;
				}
			}
		}
	},
		
	tablecolsplit:{
		title: MooEditable.Locale.get('splitTableCell'),
		command: function(){
			var node = this.selection.getNode();
			if (node.get('tag')!='td') node = node.getParent('td');
			if (node){
				var index = node.cellIndex + 1;
				if(node.getProperty('colspan')){
					var cols = parseInt(node.getProperty('colspan'));
					for (i=1;i<cols;i++){
						node.getParent().insertCell(index+i);
					}
					node.removeProperty('colspan');
				}
			}
		},
		states: function(node){
			if (node.get('tag')!='td') return;
			if (node){
				if (node.getProperty('colspan') && parseInt(node.getProperty('colspan')) > 1){
					this.el.addClass('onActive');
				}
			}
		}
	},
	
	tablecoldelete:{
		title: MooEditable.Locale.get('deleteTableCol'),
		command: function(){
			var node = this.selection.getNode();
			if (node.get('tag') != 'td') node = node.getParent('td');
			if (node){
				var len = node.getParent().getParent().childNodes.length;
				var index = node.cellIndex;
				var tt = node.getParent().getParent();
				for (var i=0; i<len; i++) tt.childNodes[i].deleteCell(index);
			}
		}
	}
	
});
/*
---

name: MooEditable.UI.ButtonOverlay

description: UI Class to create a button element with a popup overlay.

license: MIT-style license

authors:
- Lim Chee Aun

requires:
# - MooEditable
# - MooEditable.UI

provides: [MooEditable.UI.ButtonOverlay]

...
*/



MooEditable.UI.ButtonOverlay = new Class({

	Extends: MooEditable.UI.Button,

	options: {
		/*
		onOpenOverlay: function(){},
		onCloseOverlay: function(){},
		*/
		overlayHTML: '',
		overlayClass: '',
		overlaySize: {x: 150, y: 'auto'},
		overlayContentClass: ''
	},

	initialize: function(options){
		this.parent(options);
		this.render();
		this.el.addClass('mooeditable-ui-buttonOverlay');
		this.renderOverlay(this.options.overlayHTML);
	},
	
	renderOverlay: function(html){
		var self = this;
		this.overlay = new Element('div', {
			'class': 'mooeditable-ui-button-overlay ' + self.name + '-overlay ' + self.options.overlayClass,
			html: '<div class="overlay-content ' + self.options.overlayContentClass + '">' + html + '</div>',
			tabindex: 0,
			styles: {
				left: '-999em',
				position: 'absolute',
				width: self.options.overlaySize.x,
				height: self.options.overlaySize.y
			},
			events: {
				mousedown: self.clickOverlay.bind(self),
				focus: self.openOverlay.bind(self),
				blur: self.closeOverlay.bind(self)
			}
		}).inject(document.body).store('MooEditable.UI.ButtonOverlay', this);
		this.overlayVisible = false;
		
		window.addEvent('resize', function(){
			if (self.overlayVisible) self.positionOverlay();
		});
	},
	
	openOverlay: function(){
		if (this.overlayVisible) return;
		this.overlayVisible = true;
		this.activate();
		this.fireEvent('openOverlay', this);
		return this;
	},
	
	closeOverlay: function(){
		if (!this.overlayVisible) return;
		this.overlay.setStyle('left', '-999em');
		this.overlayVisible = false;
		this.deactivate();
		this.fireEvent('closeOverlay', this);
		return this;
	},
	
	clickOverlay: function(e){
		if (e.target == this.overlay || e.target.parentNode == this.overlay) return;
		this.overlay.blur();
		e.preventDefault();
		this.action(e);
	},
	
	click: function(e){
		e.preventDefault();
		if (this.disabled) return;
		if (this.overlayVisible){
			this.overlay.blur();
			return;
		} else {
			this.positionOverlay();
			this.overlay.focus();
		}
	},
	
	positionOverlay: function(){
		var coords = this.el.getCoordinates();
		this.overlay.setStyles({
			top: coords.bottom,
			left: coords.left
		});
		return this;
	}
	
});
/*
---

name: MooEditable.UI.ExtendedLinksDialog

description: Extends MooEditable, adds better link support.

license: MIT-style license

authors:
- Andr Fiedler <kontakt@visualdrugs.net>

requires:
- MooEditable.UI.Dialog
- MooEditable.Actions
- MooEditable.UI.AlertDialog
- More/URI

provides: [MooEditable.UI.ExtendedLinksDialog]

...
*/



(function(){
    
MooEditable.Locale.define({
    protocol: 'protocol',
    link: 'link',
    email: 'e-Mail',
    urlWithoutHttp: 'URL (without http://)',
    window: 'window',
    sameWindow: 'same window',
    newWindow: 'new window'
});

String.implement({
    camelCaseFirst: function(){
    	return this.replace(/\s*(\D)/, function(match){
    		return match.toUpperCase();
    	});
    }
});

var urlRegex = /^(https?|ftp|rmtp|mms):\/\/(([A-Z0-9][A-Z0-9_-]*)(\.[A-Z0-9][A-Z0-9_-]*)+)(:(\d+))?\/?/i;

MooEditable.UI.ExtendedLinksDialog = function(editor){
    var html = '<div class="dialog-column"><label class="dialog-label">' 
        + MooEditable.Locale.get('protocol').camelCaseFirst()+ '<br/><select class="dialog-input-protocol">'
        + '<option value="http">' + MooEditable.Locale.get('link') + '</option>'
        + '<option value="mailto">' + MooEditable.Locale.get('email') + '</option>'
        + '</select></label></div>'
		+ '<div class="dialog-column"><label class="dialog-label">'
        + MooEditable.Locale.get('urlWithoutHttp').camelCaseFirst()
        + '<br/><input type="text" class="dialog-input-url" value=""></label></div> '
		+ '<div class="dialog-column"><label class="dialog-label">'
        + MooEditable.Locale.get('window').camelCaseFirst() + '<br/><select class="dialog-input-target">'
        + '<option value="_self">' + MooEditable.Locale.get('sameWindow') + '</option>'
        + '<option value="_blank">' + MooEditable.Locale.get('newWindow') + '</option>'
        + '</select></label></div><br/>'
		+ '<button class="dialog-button dialog-ok-button">' + MooEditable.Locale.get('ok').camelCaseFirst() + '</button>'
		+ '<button class="dialog-button dialog-cancel-button">' + MooEditable.Locale.get('cancel').camelCaseFirst() + '</button>';
	return new MooEditable.UI.Dialog(html, {
		'class': 'mooeditable-prompt-dialog',
		onOpen: function(){
			var protocol_input = this.el.getElement('.dialog-input-protocol');
			var url_input = this.el.getElement('.dialog-input-url');
			var target_input = this.el.getElement('.dialog-input-target');
			var text = editor.selection.getText();
			var node = editor.selection.getNode();
			if(node.get('tag') == 'a'){
				var uri = new URI(node.href);
				protocol_input.set('value', uri.get('scheme'));
				if(uri.get('scheme') == 'mailto'){
					url_input.set('value', node.href.replace('mailto:', ''));
				}
                else {
					url_input.set('value', uri.get('host'));
				}
				target_input.set('value', node.target || '_self');
			}
			else if(urlRegex.test(text)) {
				var uri = new URI(text);
				protocol_input.set('value', uri.get('scheme'));
				url_input.set('value', uri.get('host'));
			}
			(function(){
				url_input.focus();
				url_input.select();
			}).delay(10);
		},
		onClick: function(e){
			e.preventDefault();
			if (e.target.tagName.toLowerCase() != 'button') return;
			var button = document.id(e.target);
			var protocol_input = this.el.getElement('.dialog-input-protocol');
			var url_input = this.el.getElement('.dialog-input-url');
			var target_input = this.el.getElement('.dialog-input-target');
			if (button.hasClass('dialog-cancel-button')){
				this.close();
			}
            else if (button.hasClass('dialog-ok-button')){
				if(protocol_input.get('value') == 'mailto'){
					editor.selection.insertContent('<a href="mailto:' + url_input.get('value') + '" target="' + target_input.get('value') + '">' + editor.selection.getText() + '</a>');
				}
                else {
					editor.selection.insertContent('<a href="' + protocol_input.get('value') + '://' + url_input.get('value') + '" target="' + target_input.get('value') + '">' + editor.selection.getText() + '</a>');
				}
				this.close();
			}
		}
	});
};

MooEditable.Actions.createlink.dialogs.prompt = function(editor){
	return MooEditable.UI.ExtendedLinksDialog(editor);
}
MooEditable.Actions.createlink.command = function(){
    var selection = this.selection;
    var dialogs = this.dialogs.createlink;
    if (selection.isCollapsed()){
    	var node = selection.getNode();
    	if (node.get('tag') == 'a' && node.get('href')){
    		selection.selectNode(node);
    		dialogs.prompt.open();
    	} else {
    		dialogs.alert.open();
    	}
    } else {
    	dialogs.prompt.open();
    }
}

})();
/*
---

name: MooEditable.UI.MenuList

description: UI Class to create a menu list (select) element.

license: MIT-style license

authors:
- Lim Chee Aun

requires:
# - MooEditable
# - MooEditable.UI

provides: [MooEditable.UI.MenuList]

...
*/



MooEditable.UI.MenuList = new Class({

	Implements: [Events, Options],

	options: {
		/*
		onAction: function(){},
		*/
		title: '',
		name: '',
		'class': '',
		list: []
	},

	initialize: function(options){
		this.setOptions(options);
		this.name = this.options.name;
		this.render();
	},
	
	toElement: function(){
		return this.el;
	},
	
	render: function(){
		var self = this;
		var html = '';
		this.options.list.each(function(item){
			html += '<option value="{value}" style="{style}">{text}</option>'.substitute(item);
		});
		this.el = new Element('select', {
			'class': self.options['class'],
			title: self.options.title,
			html: html,
			styles: { 'height' : '21px' },
			events: {
				change: self.change.bind(self)
			}
		});
		
		this.disabled = false;

		// add hover effect for IE
		if (Browser.ie) this.el.addEvents({
			mouseenter: function(e){ this.addClass('hover'); },
			mouseleave: function(e){ this.removeClass('hover'); }
		});
		
		return this;
	},
	
	change: function(e){
		e.preventDefault();
		if (this.disabled) return;
		var name = e.target.value;
		this.action(name);
	},
	
	action: function(){
		this.fireEvent('action', [this].concat(Array.from(arguments)));
	},
	
	enable: function(){
		if (!this.disabled) return;
		this.disabled = false;
		this.el.set('disabled', false).removeClass('disabled').set({
			disabled: false,
			opacity: 1
		});
		return this;
	},
	
	disable: function(){
		if (this.disabled) return;
		this.disabled = true;
		this.el.set('disabled', true).addClass('disabled').set({
			disabled: true,
			opacity: 0.4
		});
		return this;
	},
	
	activate: function(value){
		if (this.disabled) return;
		var index = 0;
		if (value) this.options.list.each(function(item, i){
			if (item.value == value) index = i;
		});
		this.el.selectedIndex = index;
		return this;
	},
	
	deactivate: function(){
		this.el.selectedIndex = 0;
		this.el.removeClass('onActive');
		return this;
	}
	
});
/*Name:     - NewsReaderWidgetDescription:     - Shows RSS feed to the user. The levevel details can be customized.Requires:    - Provides:    - NewsReaderWidgetPart of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. http://www.processpuzzle.comAuthors:     - Zsolt ZsuffaCopyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation, either version 3 of the License, or (at your option) any later version.This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty ofMERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.*///= require_directory ../MochaUI//= require_directory ../FundamentalTypes//= require ../BrowserWidget/BrowserWidget.jsvar NewsReaderWidget = new Class({   Extends : BrowserWidget,   Binds : ['constructChannel', 'destroyChannel'],      options : {      channelOptions : {},      channelSelector : "//rss/channel",      componentName : "NewsReaderWidget",      useLocalizedData : true,      widgetContainerId : "NewsReaderWidget"   },      //Constructor   initialize : function( options, resourceBundle, elementFactoryOptions ) {      this.parent( options, resourceBundle, elementFactoryOptions );            this.channel;   },   //Public accesors and mutators   construct : function(){      this.parent();   },      destroy : function() {      this.parent();   },      unmarshall : function(){      this.unmarshallChannel();      this.parent();   },      //Properties   getChannel : function() { return this.channel; },      //Protected, private helper methods   compileConstructionChain: function(){      this.constructionChain.chain( this.constructChannel, this.finalizeConstruction );   }.protect(),      compileDestructionChain : function(){      this.destructionChain.chain( this.destroyChannel, this.destroyChildHtmlElements, this.finalizeDestruction );   }.protect(),      constructChannel : function(){      this.channel.construct( this.containerElement );      this.constructionChain.callChain();   }.protect(),      destroyChannel : function(){      this.channel.destroy();   }.protect(),      unmarshallChannel : function(){      var channelElement = this.dataXml.selectNode( this.options.channelSelector );      if( channelElement ){         this.channel = new RssChannel( this.dataXml, this.i18Resource, this.elementFactory, this.options.channelOptions );         this.channel.unmarshall();      }         }.protect()});
/*
Name: RssChannel

Description: Represents and RSS 2.0 channel as JavaScript object 

Requires:

Provides:

Part of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. 
http://www.processpuzzle.com

Authors: 
    - Zsolt Zsuffa

Copyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the 
GNU General Public License as published by the Free Software Foundation, either version 3 of the License, 
or (at your option) any later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/




var RssChannel = new Class({
   Implements: Options,

   options: {
      buildDateSelector : "//rss/channel/lastBuildDate",
      descriptionSelector : "//rss/channel/description",
      descriptionStyle : "rssChannelDescription",
      documentsSelector : "//rss/channel/docs",
      generatorSelector : "//rss/channel/generator",
      itemOptions : {},
      itemsSelector : "//rss/channel/item",
      itemsWrapperStyle : "rssItemsWrapper",
      languageSelector : "//rss/channel/language",
      linkSelector : "//rss/channel/link",
      managingEditorSelector : "//rss/channel/managingEditor",
      publicationDateSelector : "//rss/channel/pubDate",
      showDescription: true, 
      showTitle: true, 
      titleSelector : "//rss/channel/title",
      titleStyle : "rssChannelTitle",
      webMasterSelector : "//rss/channel/webMaster",
      wrapperElementId : "rssChannelWrapper",
      wrapperElementTag : "div"
   },
   
   //Constructor
   initialize: function ( rssResource, internationalization, elementFactory, options ) {
      // parameter assertions
      assertThat( rssResource, not( nil() ));
      this.setOptions( options );
      
      this.buildDate;
      this.containerElement;
      this.description;
      this.documents;
      this.elementFactory = elementFactory;
      this.generator;
      this.internationalization;
      this.items = new ArrayList();
      this.language;
      this.link;
      this.managingEditor;
      this.publicationDate;
      this.rssResource = rssResource;
      this.state = BrowserWidget.States.INITIALIZED;
      this.title;
      this.webMaster;
      this.wrapperElement;
   },
   
   //Public accessor and mutator methods
   construct : function( containerElement ){
      if( this.state == BrowserWidget.States.UNMARSHALLED ){
         this.containerElement = containerElement;
         this.createWrapperElement();
         this.createTitleElement();
         this.createItemsWrapper();
         this.constructItems();
         
         this.state = BrowserWidget.States.CONSTRUCTED;
      }
   },
   
   destroy: function(){
      if( this.state == BrowserWidget.States.CONSTRUCTED ){
         this.destroyItems();
         this.destroyPropertyElements();
      }
      
      this.state = BrowserWidget.States.INITIALIZED;
   },
   
   unmarshall: function(){
      this.unmarshallChannelProperties();
      this.unmarshallItems();
      this.state = BrowserWidget.States.UNMARSHALLED;
   },
   
   //Properties
   getBuildDate: function() { return this.buildDate; },
   getDescription: function() { return this.description; },
   getDocuments: function() { return this.documents; },
   getElementFactory : function() { return this.elementFactory; },
   getGenerator: function() { return this.generator; },
   getItems: function() { return this.items; },
   getLanguage: function() { return this.language; },
   getLink: function() { return this.link; },
   getManagingEditor: function() { return this.managingEditor; },
   getPublicationDate: function() { return this.publicationDate; },
   getState: function() { return this.state; },
   getTitle: function() { return this.title; },
   getWebMaster: function() { return this.webMaster; },
   getWrapperElement: function() { return this.wrapperElement; },
   
   //Private helper methods
   constructItems : function() {
      this.items.each( function( channelItem, index ){
         channelItem.construct( this.itemsWrapperElement );
      }.bind( this ));
   }.protect(),
   
   createItemsWrapper : function(){
      this.itemsWrapperElement = this.elementFactory.create( 
         this.options.wrapperElementTag, 
         null, 
         this.wrapperElement, 
         WidgetElementFactory.Positions.LastChild, 
         { 'class' : this.options.itemsWrapperStyle }
      );
   }.protect(),
   
   createTitleElement : function(){
      if( this.options.showTitle ){
         var elementOptions = { 'class' : this.options.titleStyle };
         var elementText = this.link ? null : this.title;
         this.titleElement = this.elementFactory.create( 'div', elementText, this.wrapperElement, WidgetElementFactory.Positions.LastChild, elementOptions );
         
         if( this.link ){
            this.elementFactory.createAnchor( this.title, this.link, null, this.titleElement );
         }
      }
   }.protect(),
   
   createWrapperElement : function(){
      this.wrapperElement = this.elementFactory.create( 
         this.options.wrapperElementTag, 
         null, 
         this.containerElement, 
         WidgetElementFactory.Positions.LastChild, 
         { id : this.options.wrapperElementId }
      );
   }.protect(),
   
   destroyItems: function(){
      this.items.each( function( channelItem, index ){
         channelItem.destroy();
      }.bind( this ));
   }.protect(),
   
   destroyPropertyElements: function(){
      if( this.wrapperElement.removeEvents ) this.wrapperElement.removeEvents();
      if( this.wrapperElement.destroy ) this.wrapperElement.destroy();
      
      if( this.titleElement && this.titleElement.removeEvents ) this.titleElement.removeEvents();
      if( this.titleElement && this.titleElement.destroy ) this.titleElement.destroy();
   }.protect(),
   
   unmarshallChannelProperties: function(){
      this.buildDate = this.rssResource.selectNodeText( this.options.buildDateSelector );
      this.description = this.rssResource.selectNodeText( this.options.descriptionSelector );
      this.documents = this.rssResource.selectNodeText( this.options.documentsSelector );
      this.generator = this.rssResource.selectNodeText( this.options.generatorSelector );
      this.language = this.rssResource.selectNodeText( this.options.languageSelector );
      this.link = this.rssResource.selectNodeText( this.options.linkSelector );
      this.managingEditor = this.rssResource.selectNodeText( this.options.managingEditorSelector );
      this.publicationDate = this.rssResource.selectNodeText( this.options.publicationDateSelector );
      this.title = this.rssResource.selectNodeText( this.options.titleSelector );
      this.webMaster = this.rssResource.selectNodeText( this.options.webMasterSelector );
   }.protect(),
   
   unmarshallItem: function( itemResource ){
      var rssItem = new RssItem( itemResource, this.elementFactory, this.options.itemOptions );
      rssItem.unmarshall();
      this.items.add( rssItem );
   }.protect(),
   
   unmarshallItems: function( ){
      var rssItemResources = this.rssResource.selectNodes( this.options.itemsSelector );
      rssItemResources.each( function( itemResource, index ){
         this.unmarshallItem( itemResource );
      }, this );
   }.protect()
});
/*
Name: RssItem

Description: Represents and RSS 2.0 channel item as JavaScript object 

Requires:

Provides:

Part of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. 
http://www.processpuzzle.com

Authors: 
    - Zsolt Zsuffa

Copyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the 
GNU General Public License as published by the Free Software Foundation, either version 3 of the License, 
or (at your option) any later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/




var RssItem = new Class({
   Implements: Options,

   options: {
      descriptionSelector: "description",
      descriptionStyle : "rssItemDescription",
      globalUniqueIdSelector: "guid",
      linkSelector: "link",
      publicationDateSelector: "pubDate",
      showDescription: true, 
      showTitle: true, 
      titleSelector: "title",
      titleStyle : "rssItemTitle",
      trancatedDescriptionEnding : "...",
      truncatedDescriptionLength : 120,
      truncateDescription : false
   },
   
   //Constructor
   initialize: function ( itemResource, elementFactory, options ) {
      // parameter assertions
      assertThat( itemResource, not( nil() ));      
      this.setOptions( options );
      
      this.containerElement;
      this.description;
      this.elementFactory = elementFactory;
      this.globalUniqueId;
      this.itemResource = itemResource;
      this.link;
      this.publicationDate;
      this.state = BrowserWidget.States.INITIALIZED;
      this.title;
   },
   
   //Public accessor and mutator methods
   construct: function( containerElement ){
      if( this.state == BrowserWidget.States.UNMARSHALLED ){
         this.containerElement = containerElement;
         this.createTitleElement();
         this.createDescriptionElement();
         this.state = BrowserWidget.States.CONSTRUCTED;
      }
   },
   
   destroy: function(){
      if( this.state == BrowserWidget.States.CONSTRUCTED ){
         this.destroyPropertyElements();
      }
      
      this.state = BrowserWidget.States.INITIALIZED;
   },
   
   unmarshall: function(){
      this.description = XmlResource.selectNodeText( this.options.descriptionSelector, this.itemResource );
      this.globalUniqueId = XmlResource.selectNodeText( this.options.globalUniqueIdSelector, this.itemResource );
      this.link = XmlResource.selectNodeText( this.options.linkSelector, this.itemResource );
      this.publicationDate = XmlResource.selectNodeText( this.options.publicationDateSelector, this.itemResource );
      this.title = XmlResource.selectNodeText( this.options.titleSelector, this.itemResource );
      
      this.state = BrowserWidget.States.UNMARSHALLED;
   },
   
   //Properties
   getDescription: function() { return this.description; },
   getGlobalUniqueId: function() { return this.globalUniqueId; },
   getLink: function() { return this.link; },
   getPublicationDate: function() { return this.publicationDate; },
   getState: function() { return this.state; },
   getTitle: function() { return this.title; },
   
   //Private helper methods
   createDescriptionElement : function(){
      if( this.options.showDescription ){
         var elementOptions = { 'class' : this.options.descriptionStyle };
         var descriptionText;
         if( this.options.truncateDescription ){
            descriptionText = this.description.substr( 0, this.options.truncatedDescriptionLength ) + this.options.trancatedDescriptionEnding;
         }else {
            descriptionText = this.description;
         }
         this.descriptionElement = this.elementFactory.create( 'div', descriptionText, this.containerElement, WidgetElementFactory.Positions.LastChild, elementOptions );
      }
   }.protect(),
   
   createTitleElement : function(){
      var elementOptions = { 'class' : this.options.titleStyle };
      var elementText = this.link ? null : this.title;
      this.titleElement = this.elementFactory.create( 'div', elementText, this.containerElement, WidgetElementFactory.Positions.LastChild, elementOptions );
      
      if( this.link ){
         this.elementFactory.createAnchor( this.title, this.link, null, this.titleElement );
      }
   }.protect(),
   
   destroyPropertyElement: function( propertyElement ){
      if( propertyElement.removeEvents ) propertyElement.removeEvents();
      if( propertyElement.destroy ) propertyElement.destroy();
   }.protect(),
   
   destroyPropertyElements: function(){
      this.destroyPropertyElement( this.titleElement );
      this.destroyPropertyElement( this.descriptionElement );
   }
});
/*
Name: RssResource

Description: Represents and RSS 2.0 xml resource file as JavaScript object 

Requires:

Provides:

Part of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. 
http://www.processpuzzle.com

Authors: 
	- Zsolt Zsuffa

Copyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the 
GNU General Public License as published by the Free Software Foundation, either version 3 of the License, 
or (at your option) any later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/




var RssResource = new Class({
   Extends: XmlResource,

   options: {
   },
   
   //Constructor
   initialize: function ( uri, options ) {
      // parameter assertions
      assertThat( uri, not( nil() ));
      
      this.parent( uri, options );

      this.channel = null;
   },
   
   //Public accessor and mutator methods
   release: function(){
      
   },
   
   unmarshall: function(){
      this.unmarshallChannel();
   },
   
   //Properties
   getChannel: function() { return this.channel; },
   getItems: function() { return this.channel.getItems(); },
   
   //Private helper methods
   unmarshallChannel: function(){
      this.channel = new RssChannel( this );
      this.channel.unmarshall();
   }.protect(),
   
});
/*Name:    - PartyEventWidgetDescription:     - Shows list of events to the user. The level details can be customized.Requires:    - BrowserWidgetProvides:    - PartyEventWidgetPart of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. http://www.processpuzzle.comAuthors:     - Zsolt ZsuffaCopyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation, either version 3 of the License, or (at your option) any later version.This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty ofMERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.*///= require_directory ../MochaUI//= require_directory ../FundamentalTypes//= require ../BrowserWidget/BrowserWidget.jsvar PartyEventWidget = new Class({   Extends : BrowserWidget,   Binds : ['constructEvents', 'destroyEvents'],      options : {      componentName : "EventWidget",      eventOptions : {},      eventsSelector : "//pp:eventList/events/event",      useLocalizedData : true,      widgetContainerId : "EventWidget"   },      //Constructor   initialize : function( options, resourceBundle, elementFactoryOptions ) {      this.parent( options, resourceBundle, elementFactoryOptions );            this.events = new ArrayList();   },   //Public accesors and mutators   construct : function(){      this.parent();   },      destroy : function() {      this.parent();   },      unmarshall : function(){      this.unmarshallEvents();      this.parent();   },      //Properties   getEvents : function() { return this.events; },      //Protected, private helper methods   compileConstructionChain: function(){      this.constructionChain.chain( this.constructEvents, this.finalizeConstruction );   }.protect(),      compileDestructionChain : function(){      this.destructionChain.chain( this.destroyEvents, this.destroyChildHtmlElements, this.finalizeDestruction );   }.protect(),      constructEvents : function(){      this.events.each( function( event, index ){         event.construct( this.containerElement );      }.bind( this ));            this.constructionChain.callChain();   }.protect(),      destroyEvents : function(){      this.events.each( function( event, index ){         event.destroy();      }.bind( this ));            this.destructionChain.callChain();   }.protect(),      unmarshallEvents : function(){      var eventElements = this.dataXml.selectNodes( this.options.eventsSelector );      if( eventElements ){         eventElements.each( function( eventElement, index ){            var event = new PartyEvent( eventElement, this.elementFactory, this.options.eventOptions );            event.unmarshall();            this.events.add( event );         }.bind( this ));      }         }.protect()});
/*
Name: 
   - PartyEvent

Description: 
   - Represents and displays an event associated with a party.

Requires:
   - PartyEventWidget

Provides:
   - PartyEvent

Part of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. 
http://www.processpuzzle.com

Authors: 
   - Zsolt Zsuffa

Copyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the 
GNU General Public License as published by the Free Software Foundation, either version 3 of the License, 
or (at your option) any later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/





var PartyEvent = new Class({
   Implements: Options,

   options: {
      descriptionSelector: "description",
      descriptionStyle : "eventDescription",
      endDateSelector : "schedule/endDate",
      isFullDaySelector : "@isFullDay",
      linkSelector: "link",
      locationAddressSelector: "location/address",
      locationLinkSelector: "location/link",
      locationStyle : "eventLocation",
      programDescriptionSelector : "program/description",
      programLinkSelector : "program/link",
      publicationDateSelector: "pubDate",
      scheduleStyle: "eventSchedule",
      showDescription: true,
      showLocation: true,
      showSchedule: true,
      showTitle: true, 
      startDateSelector : "schedule/startDate",
      titleSelector: "title",
      titleStyle : "eventTitle",
      trancatedDescriptionEnding : "...",
      truncatedDescriptionLength : 120,
      truncateDescription : false
   },
   
   //Constructor
   initialize: function ( eventResource, elementFactory, options ) {
      // parameter assertions
      assertThat( eventResource, not( nil() ));      
      this.setOptions( options );
      
      this.containerElement;
      this.description;
      this.elementFactory = elementFactory;
      this.endDate;
      this.globalUniqueId;
      this.eventResource = eventResource;
      this.isFullDay;
      this.link;
      this.locationAddress;
      this.locationElement;
      this.locationLink;
      this.programDescription;
      this.programLink;
      this.publicationDate;
      this.scheduleElement;
      this.startDate;
      this.state = BrowserWidget.States.INITIALIZED;
      this.title;
   },
   
   //Public accessor and mutator methods
   construct: function( containerElement ){
      if( this.state == BrowserWidget.States.UNMARSHALLED ){
         this.containerElement = containerElement;
         this.createTitleElement();
         this.createDescriptionElement();
         this.createScheduleElement();
         this.createLocationElement();
         this.state = BrowserWidget.States.CONSTRUCTED;
      }
   },
   
   destroy: function(){
      if( this.state == BrowserWidget.States.CONSTRUCTED ){
         this.destroyPropertyElements();
         this.destroyScheduleElements();
         this.destroyLocationElements();
      }
      
      this.state = BrowserWidget.States.INITIALIZED;
   },
   
   unmarshall: function(){
      this.unmarshallProperties();
      this.unmarshallSchedule();
      this.unmarshallLocation();
      this.state = BrowserWidget.States.UNMARSHALLED;
   },
   
   //Properties
   getDescription: function() { return this.description; },
   getElementFactory: function() { return this.elementFactory; },
   getEndDate: function() { return this.endDate; },
   getGlobalUniqueId: function() { return this.globalUniqueId; },
   getLink: function() { return this.link; },
   getLocationAddress: function() { return this.locationAddress; },
   getLocationLink: function() { return this.locationLink; },
   getProgramDescription: function() { return this.programDescription; },
   getProgramLink: function() { return this.programLink; },
   getPublicationDate: function() { return this.publicationDate; },
   getStartDate: function() { return this.startDate; },
   getState: function() { return this.state; },
   getTitle: function() { return this.title; },
   
   //Private helper methods
   createDescriptionElement : function(){
      if( this.options.showDescription ){
         var elementOptions = { 'class' : this.options.descriptionStyle };
         var descriptionText;
         if( this.options.truncateDescription ){
            descriptionText = this.description.substr( 0, this.options.truncatedDescriptionLength ) + this.options.trancatedDescriptionEnding;
         }else {
            descriptionText = this.description;
         }
         this.descriptionElement = this.elementFactory.create( 'div', descriptionText, this.containerElement, WidgetElementFactory.Positions.LastChild, elementOptions );
      }
   }.protect(),
   
   createLocationElement : function(){
      if( this.options.showLocation ){
         var elementOptions = { 'class' : this.options.locationStyle };
         this.locationElement = this.elementFactory.create( 'div', this.locationAddress, this.containerElement, WidgetElementFactory.Positions.LastChild, elementOptions );
      }
   }.protect(),
   
   createScheduleElement : function(){
      if( this.options.showSchedule ){
         var elementOptions = { 'class' : this.options.scheduleStyle };
         var scheduleText = this.startDate + " - " + this.endDate;
         this.scheduleElement = this.elementFactory.create( 'div', scheduleText, this.containerElement, WidgetElementFactory.Positions.LastChild, elementOptions );
      }
   }.protect(),
   
   createTitleElement : function(){
      var elementOptions = { 'class' : this.options.titleStyle };
      var elementText = this.link ? null : this.title;
      this.titleElement = this.elementFactory.create( 'div', elementText, this.containerElement, WidgetElementFactory.Positions.LastChild, elementOptions );
      
      if( this.link ){
         this.elementFactory.createAnchor( this.title, this.link, null, this.titleElement );
      }
   }.protect(),
   
   destroyLocationElements: function(){
      this.destroyPropertyElement( this.locationElement );
   }.protect(),
   
   destroyPropertyElement: function( propertyElement ){
      if( propertyElement.removeEvents ) propertyElement.removeEvents();
      if( propertyElement.destroy ) propertyElement.destroy();
   }.protect(),
   
   destroyPropertyElements: function(){
      this.destroyPropertyElement( this.titleElement );
      this.destroyPropertyElement( this.descriptionElement );
   }.protect(),
   
   destroyScheduleElements: function(){
      this.destroyPropertyElement( this.scheduleElement );
   }.protect(),
   
   unmarshallLocation: function(){
      this.locationAddress = XmlResource.selectNodeText( this.options.locationAddressSelector, this.eventResource );
      this.locationLink = XmlResource.selectNodeText( this.options.locationLinkSelector, this.eventResource );
   }.protect(),
   
   unmarshallProperties: function(){
      this.description = XmlResource.selectNodeText( this.options.descriptionSelector, this.eventResource );
      this.link = XmlResource.selectNodeText( this.options.linkSelector, this.eventResource );
      this.programDescription = XmlResource.selectNodeText( this.options.programDescriptionSelector, this.eventResource );
      this.programLink = XmlResource.selectNodeText( this.options.programLinkSelector, this.eventResource );
      this.publicationDate = XmlResource.selectNodeText( this.options.publicationDateSelector, this.eventResource );
      this.title = XmlResource.selectNodeText( this.options.titleSelector, this.eventResource );
   }.protect(),
   
   unmarshallSchedule: function(){
      this.isFullDay = XmlResource.selectNodeText( this.options.isFullDaySelector, this.eventResource );
      this.startDate = XmlResource.selectNodeText( this.options.startDateSelector, this.eventResource );
      this.endDate = XmlResource.selectNodeText( this.options.endDateSelector, this.eventResource );
   }.protect()
});
/*
Name: 
    - PhotoGaleryImage

Description: 
    - Represents an image of a photo galery. 

Requires:

Provides:
    - PhotoGaleryImage

Part of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. 
http://www.processpuzzle.com

Authors: 
    - Zsolt Zsuffa

Copyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the 
GNU General Public License as published by the Free Software Foundation, either version 3 of the License, 
or (at your option) any later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/




var PhotoGaleryImage = new Class({
   Implements : Options,
   
   options : {
      captionSelector : "caption",
      linkSelector : "link",
      thumbnailSelector : "thumbnailUri",
      uriSelector : "uri"
   },

   //Constructor
   initialize: function( definitionXml, internationalization, options ){
      this.setOptions( options );
      this.anchorElement;
      this.caption;
      this.data;
      this.dataAsText;
      this.definitionXml = definitionXml;
      this.internationalization = internationalization;
      this.link;
      this.thumbnailUri;
      this.uri;
      this.state = PhotoGaleryImage.States.INITIALIZED;
   },
   
   //Public accessor and mutator methods
   construct: function(){
      this.compileDataFromProperties();
      this.state = PhotoGaleryImage.States.CONSTRUCTED;
   },
   
   destroy: function(){
      this.data = null;
      this.dataAsText = null;
      this.link = null;
      this.thumbnailUri = null;
      this.uri = null;
      this.state = PhotoGaleryImage.States.INITIALIZED;
   },
   
   unmarshall: function(){
      this.unmarshallProperties();
      this.state = PhotoGaleryImage.States.UNMARSHALLED;
   },
   
   //Properties
   getCaption: function() { return this.caption; },
   getData: function() { return this.data; },
   getDataAsText: function() { return this.dataAsText; },
   getLink: function() { return this.link; },
   getState: function() { return this.state; },
   getThumbnailUri: function() { return this.thumbnailUri; },
   getUri: function() { return this.uri; },
   
   //Protected, private helper methods
   compileDataFromProperties: function(){
      var caption = this.caption ? "caption:'" + this.caption + "'" : null;
      var href = this.link ? "href:'" + this.link + "'" : null;
      var thumbnail = this.thumbnailUri ? "thumbnail:'" + this.thumbnailUri + "'" : null;
      
      var dataFragment = caption ? caption : "";

      if( dataFragment != "" && href ) dataFragment += ", ";
      dataFragment += href ? href : "";

      if( dataFragment != "" && thumbnail ) dataFragment += ", ";
      dataFragment += thumbnail ? thumbnail : "";
      
      this.dataAsText = "'" + this.uri + "': {" + dataFragment + "}";
      this.data = eval( "({" + this.dataAsText + "})" );
   }.protect(),
   
   unmarshallProperties: function(){
      this.caption = XmlResource.selectNodeText( this.options.captionSelector, this.definitionXml );
      this.caption = this.internationalization.getText( this.caption );
      this.link = XmlResource.selectNodeText( this.options.linkSelector, this.definitionXml );
      this.thumbnailUri = XmlResource.selectNodeText( this.options.thumbnailSelector, this.definitionXml );
      this.uri = XmlResource.selectNodeText( this.options.uriSelector, this.definitionXml );
   }.protect(),
});

PhotoGaleryImage.States = { UNINITIALIZED : 0, INITIALIZED : 1, UNMARSHALLED : 2, CONSTRUCTED : 3 };
/*
Name: 
    - PhotoGaleryWidget

Description: 
    - Represents a collection of images with thumbnails, displays the selected one in original size and runs slide show. 

Requires:
    - PhotoGaleryImage, BrowserWidget, WidgetElementFactory
    
Provides:
    - PhotoGaleryWidget

Part of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. 
http://www.processpuzzle.com

Authors: 
    - Zsolt Zsuffa

Copyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the 
GNU General Public License as published by the Free Software Foundation, either version 3 of the License, 
or (at your option) any later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/





var PhotoGaleryWidget = new Class({
   Extends : BrowserWidget,
   Binds : ['compileDataObject', 'instantiateSlideShow', 'onComplete', 'onEnd', 'onShow', 'onStart'],
   options : {
      accessKeysDefault : null,
      accessKeysSelector : "pp:widgetDefinition/properties/accessKeys",
      automaticallyLinkSlideDefault : false,
      automaticallyLinkSlideSelector : "pp:widgetDefinition/properties/automaticallyLinkSlideToFullSizedImage",
      centerImagesDefault : true,
      centerImagesSelector : "pp:widgetDefinition/properties/centerImages",
      componentName : "PhotoGaleryWidget",
      descriptionSelector : "/pp:widgetDefinition/description", 
      effectDurationDefault : 750,
      effectDurationSelector : "pp:widgetDefinition/properties/effectDuration",
      eventDeliveryDelay : 50,
      firstSlideDefault: 0,
      firstSlideSelector: "pp:widgetDefinition/properties/firstSlide",
      galeryLinkDefault: null,
      galeryLinkSelector: "pp:widgetDefinition/properties/galeryLink",
      heightDefault: 300,
      heightSelector: "pp:widgetDefinition/properties/height",
      imageFolderUriDefault: "",
      imageFolderUriSelector: "pp:widgetDefinition/properties/imageFolderUri",
      imagesSelector: "/pp:widgetData/images/image",
      loopShowDefault: true,
      loopShowSelector: "pp:widgetDefinition/properties/loopShow",
      nameSelector : "/pp:widgetDefinition/name",
      overlapImagesDefault : true,
      overlapImagesSelector : "pp:widgetDefinition/properties/overlapImages",
      resizeImagesDefault : true,
      resizeImagesSelector : "pp:widgetDefinition/properties/resizeImages",
      showControllerDefault : true,
      showControllerSelector : "pp:widgetDefinition/properties/showController",
      showImageCaptionsDefault : true,
      showImageCaptionsSelector : "pp:widgetDefinition/properties/showImageCaptions",
      showSlidesRandomDefault : false,
      showSlidesRandomSelector : "pp:widgetDefinition/properties/showSlidesRandom",
      showThumbnailsDefault : true,
      showThumbnailsSelector : "pp:widgetDefinition/properties/showThumbnails",
      skipTransitionDefault : null,
      skipTransitionSelector : "pp:widgetDefinition/properties/skipTransition",
      slideChangeDelayDefault : 2000,
      slideChangeDelaySelector : "pp:widgetDefinition/properties/slideChangeDelay",
      slideTransitionDefault : "Sine",
      slideTransitionSelector : "pp:widgetDefinition/properties/slideTransition",
      startPausedDefault : true,
      startPausedSelector : "pp:widgetDefinition/properties/startPaused",
      thumbnailFileNameRuleDefault : null,
      thumbnailFileNameRuleSelector : "pp:widgetDefinition/properties/thumbnailFileNameRule",
      widthDefault : 450,
      widthSelector : "pp:widgetDefinition/properties/width"
   },

   //Constructor
   initialize: function( options, internationalization ){
      this.setOptions( options );
      this.parent( options, internationalization );
      
      //Private attributes
      this.accessKeys;
      this.automaticallyLinkSlide;
      this.centerImages;
      this.constructionChain = new Chain();
      this.data;
      this.dataAsText = "";
      this.effectDuration;
      this.firstSlide;
      this.galeryLink;
      this.height;
      this.images = new LinkedHashMap();
      this.imageFolderUri;
      this.loopShow;
      this.overlapImages;
      this.resizeImages;
      this.showController;
      this.showImageCaptions;
      this.showSlidesRandom;
      this.showThumbnails;
      this.skipTransition;
      this.slideChangeDelay;
      this.slideShow;
      this.slideTransition;
      this.startPaused;
      this.thumbnailFileNameRule;
      this.width;
   },
   
   //Public accessor and mutator methods
   construct: function(){
      this.parent();
   },
   
   destroy: function(){
      this.destroyComponents();
      this.destroyChildElements( this.containerElement );
      this.resetFields();
      this.parent();
   },
   
   onComplete: function(){
      if( this.state < BrowserWidget.States.CONSTRUCTED ){
         this.logger.trace( this.options.componentName + ".onComplete() completed to load Slideshow 2." );
         this.constructionChain.callChain();
      }
   },
   
   onEnd: function(){
      this.logger.trace( this.options.componentName + ".onEnd() ended Slideshow 2." );
   },
   
   onShow: function(){
      if( this.state < BrowserWidget.States.CONSTRUCTED ){
         this.logger.trace( this.options.componentName + ".onShow() started to load Slideshow 2." );
         this.constructionChain.callChain();
      }
   },
   
   onStart: function(){
      if( this.state < BrowserWidget.States.CONSTRUCTED ){
         this.logger.trace( this.options.componentName + ".onStart() started to load Slideshow 2." );
         this.constructionChain.callChain();
      }
   },
   
   unmarshall: function(){
      this.unmarshallProperties();
      this.unmarshallImages();
      return this.parent();
   },
   
   //Properties
   getAccessKeys: function() { return this.accessKeys; },
   getAutomaticallyLinkSlide: function() { return this.automaticallyLinkSlide; },
   getCenterImages: function() { return this.centerImages; },
   getData: function() { return this.data; },
   getEffectDuration: function() { return this.effectDuration; },
   getFirstSlide: function() { return this.firstSlide; },
   getGaleryLink: function() { return this.galeryLink; },
   getHeight: function() { return this.height; },
   getImages: function() { return this.images; },
   getImageFolderUri: function() { return this.imageFolderUri; },
   getLoopShow: function() { return this.loopShow; },
   getOverlapImages: function() { return this.overlapImages; },
   getResizeImages: function() { return this.resizeImages; },
   getShowController: function() { return this.showController; },
   getShowImageCaptions: function() { return this.showImageCaptions; },
   getShowSlidesRandom: function() { return this.showSlidesRandom; },
   getShowThumbnails: function() { return this.showThumbnails; },
   getSkipTransition: function() { return this.skipTransition; },
   getSlideChangeDelay: function() { return this.slideChangeDelay; },
   getSlideShow: function() { return this.slideShow; },
   getSlideTransition: function() { return this.slideTransition; },
   getStartPaused: function() { return this.startPaused; },
   getThumbnailFileNameRule: function() { return this.thumbnailFileNameRule; },
   getWidth: function() { return this.width; },
   
   //Protected and private helper methods
   compileDataObject: function(){
      this.images.each( function( imageEntry, index ){
         var image = imageEntry.getValue();
         image.construct();
         if( this.dataAsText ) this.dataAsText += ", ";
         this.dataAsText += image.getDataAsText();
      }, this );
      
      this.data = eval( "({" + this.dataAsText + "})" );
      this.constructionChain.callChain();
   }.protect(),
   
   compileConstructionChain: function(){
      this.constructionChain.chain(
         this.compileDataObject,
         this.instantiateSlideShow,
         this.finalizeConstruction
      );
      
   }.protect(),
   
   destroyChildElements: function( parentElement ){
      var childElements = parentElement.getChildren ? parentElement.getChildren( '*' ) : new Array();
      childElements.each( function( childElement, index ){
         if( childElement.getChildren( '*' ).length > 0 ) this.destroyChildElements( childElement );
         
         if( childElement.removeEvents ) childElement.removeEvents();
         if( childElement.destroy ) childElement.destroy();
      }.bind( this ));
   }.protect(),
   
   destroyComponents: function(){
      if( this.slideShow ) this.slideShow.destroy();
   }.protect(),
   
   instantiateSlideShow: function(){
      var slideShowOptions = {
         captions : this.showImageCaptions,
         center : this.centerImages,
         controller : this.showController,
         delay : this.slideChangeDelay,
         duration : this.effectDuration,
         fast : this.skipTransition,
         height : this.height,
         href : this.galeryLink,
         hu : this.imageFolderUri,
         linked : this.automaticallyLinkSlide,
         loop : this.loopShow,
         onComplete : this.onComplete,
         onEnd : this.onEnd,
         onShow : this.onShow,
         onStart : this.onStart,
         overlap : this.overlapImages,
         paused : this.startPaused,
         random : this.showSlidesRandom,
         replace : this.thumbnailFileNameRule,
         resize : this.resizeImages,
         slide : this.firstSlide,
         thumbnails : this.showThumbnails,
         transition : this.slideTransition,
         width : this.width
      };
      this.slideShow = new Slideshow( this.containerElement, this.data, slideShowOptions );
   }.protect(),
   
   resetFields: function(){
      this.accessKeys = null;
      this.automaticallyLinkSlide = null;
      this.centerImages = null;
      this.data = null;
      this.dataAsText = "";
      this.effectDuration = null;
      this.firstSlide = null;
      this.galeryLink = null;
      this.height = null;
      this.imageFolderUri = null;
      this.loopShow = null;
      this.overlapImages = null;
      this.resizeImages = null;
      this.showController = null;
      this.showImageCaptions = null;
      this.showSlidesRandom = null;
      this.showThumbnails = null;
      this.skipTransition = null;
      this.slideChangeDelay = null;
      this.slideTransition = null;
      this.startPaused = null;
      this.thumbnailFileNameRule = null;
      this.width = null;
      this.images.clear();
   }.protect(),
   
   unmarshallImages: function(){
      var imagesElement = this.dataXml.selectNodes( this.options.imagesSelector );
      if( imagesElement ){
         imagesElement.each( function( imageElement, index ){
            var image = new PhotoGaleryImage( imageElement, this.i18Resource );
            image.unmarshall();
            this.images.put( image.getUri(), image );
         }, this );
      }
   }.protect(),
   
   unmarshallProperties: function(){
      this.accessKeys = this.unmarshallProperty( this.options.accessKeysDefault, this.options.accessKeysSelector );
      this.automaticallyLinkSlide = this.unmarshallProperty( this.options.automaticallyLinkSlideDefault, this.options.automaticallyLinkSlideSelector );
      this.centerImages = parseBoolean( this.unmarshallProperty( this.options.centerImagesDefault, this.options.centerImagesSelector ));
      this.effectDuration = parseInt( this.unmarshallProperty( this.options.effectDurationDefault, this.options.effectDurationSelector ));
      this.firstSlide = parseInt( this.unmarshallProperty( this.options.firstSlideDefault, this.options.firstSlideSelector ));
      this.galeryLink = this.unmarshallProperty( this.options.galeryLinkDefault, this.options.galeryLinkSelector );
      this.height = parseInt( this.unmarshallProperty( this.options.heightDefault, this.options.heightSelector ));
      this.imageFolderUri = this.unmarshallProperty( this.options.imageFolderUriDefault, this.options.imageFolderUriSelector );
      this.loopShow = parseBoolean( this.unmarshallProperty( this.options.loopShowDefault, this.options.loopShowSelector ));
      this.overlapImages = parseBoolean( this.unmarshallProperty( this.options.overlapImagesDefault, this.options.overlapImagesSelector ));
      this.resizeImages = parseBoolean( this.unmarshallProperty( this.options.resizeImagesDefault, this.options.resizeImagesSelector ));
      this.showController = parseBoolean( this.unmarshallProperty( this.options.showControllerDefault, this.options.showControllerSelector ));
      this.showImageCaptions = parseBoolean( this.unmarshallProperty( this.options.showImageCaptionsDefault, this.options.showImageCaptionsSelector ));
      this.showSlidesRandom = parseBoolean( this.unmarshallProperty( this.options.showSlidesRandomDefault, this.options.showSlidesRandomSelector ));
      this.showThumbnails = parseBoolean( this.unmarshallProperty( this.options.showThumbnailsDefault, this.options.showThumbnailsSelector ));
      this.skipTransition = eval( "(" + this.unmarshallProperty( this.options.skipTransitionDefault, this.options.skipTransitionSelector ) + ")" );
      this.slideChangeDelay = parseInt( this.unmarshallProperty( this.options.slideChangeDefault, this.options.slideChangeDelaySelector ));
      this.slideTransition = this.unmarshallProperty( this.options.slideTransitionDefault, this.options.slideTransitionSelector );
      this.startPaused = parseBoolean( this.unmarshallProperty( this.options.startPausedDefault, this.options.startPausedSelector ));
      this.thumbnailFileNameRule = this.unmarshallProperty( this.options.thumbnailFileNameRuleDefault, this.options.thumbnailFileNameRuleSelector );
      this.width = parseInt( this.unmarshallProperty( this.options.widthDefault, this.options.widthSelector ));
   }.protect(),
   
   unmarshallProperty: function( defaultValue, selector ){
      var propertyValue = this.definitionXml.selectNodeText( selector );
      if( propertyValue ) return propertyValue;
      else return defaultValue;
   }.protect()
});
/*
Name: DocumentResource

Description: Represents an element in the <resources> part of the SmartDocumentDefinition.

Requires:

Provides:
    - DocumentResource

Part of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. 
http://www.processpuzzle.com

Authors: 
    - Zsolt Zsuffa

Copyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the 
GNU General Public License as published by the Free Software Foundation, either version 3 of the License, 
or (at your option) any later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/




var DocumentResource = new Class({
   Implements: [Events, Options],
   Binds: ['checkResourceAvailability', 'onResourceLoaded'],   
   
   options: {
      idSelector : "@id",
      type : null
   },
   
   //Constructor
   initialize: function( resourceElement, options ){
      this.setOptions( options );
      this.availabilityCheckIsRunning;
      this.id = null;
      this.htmlElement = null;
      this.resourceElement = resourceElement;
      this.resourceAvailable = false;
      this.resourceUri = null;
      this.loadChain = new Chain();
      this.logger = Class.getInstanceOf( WebUILogger );
   },
   
   //Public mutators and accessor methods
   load: function(){
      if( !this.isResourceLoaded() ){
         this.loadChain.chain( this.checkResourceAvailability, this.loadResource ).callChain();
      }else this.onResourceLoaded();
   },
   
   onResourceError: function(){
      this.fireEvent( 'resourceError', this.resourceUri );
   },
   
   onResourceLoaded: function(){
      this.fireEvent( 'resourceLoaded', this );
   },
   
   release: function(){
      if( this.htmlElement ) this.htmlElement.destroy();
   },
   
   unmarshall: function(){
      this.id = XmlResource.selectNodeText( this.options.idSelector, this.resourceElement );
      this.resourceUri = XmlResource.determineNodeText( this.resourceElement );
      this.resourceUri = this.transformToResourceUriToAbsolute();
   },

   //Properties
   getId: function() { return this.htmlElement.get( 'id' ); },
   getResourceType: function() { return this.options.type; },
   getResourceUri: function() { return this.resourceUri; },
   
   //Protected, private helper methods
   checkResourceAvailability: function(){
      this.remoteResource = new RemoteResource( this.resourceUri, {
         async: false,            
         onSuccess: function( responseText, responseXML ){ 
            this.resourceAvailable = true;
            this.availabilityCheckIsRunning = false;
            this.loadChain.callChain();
         }.bind( this ),
         onException: function( headerName, value ){ 
            this.loadChain.clearChain();
            if( this.availabilityCheckIsRunning ) {
               this.availabilityCheckIsRunning = false;
               this.onResourceError(); 
            }
         }.bind( this ),
         onFailure: function( xhr ) { 
            this.loadChain.clearChain();
            if( this.availabilityCheckIsRunning ) {
               this.availabilityCheckIsRunning = false;
               this.onResourceError(); 
            }
         }.bind( this )
      });
      
      try{
         this.availabilityCheckIsRunning = true;
         this.remoteResource.retrieve();
      }catch( e ){
         throw new UndefinedDocumentResourceException( this.resourceUri, { cause: e, source : this.componentName } );
      }
   }.protect(),
   
   determineBaseUri: function(){
   }.protect(),
   
   transformToResourceUriToAbsolute: function(){
      var resourceUriFragment = this.resourceUri;
      var currentDirectory = document.location.href;
      currentDirectory = currentDirectory.lastIndexOf( "#" ) > 0 ? currentDirectory.substring( 0, currentDirectory.lastIndexOf( "#" )) : currentDirectory;
      currentDirectory = currentDirectory.lastIndexOf( "?" ) > 0  ? currentDirectory.substring( 0, currentDirectory.lastIndexOf( "?" )) : currentDirectory;
      currentDirectory = currentDirectory.substring( 0, currentDirectory.lastIndexOf( "/" ));
      
      while( resourceUriFragment.indexOf( "../" ) == 0 ){
         resourceUriFragment = resourceUriFragment.substring( resourceUriFragment.indexOf( "../" ) + 3 );
         currentDirectory = currentDirectory.substring( 0, currentDirectory.lastIndexOf( "/" ));
      }
      
      return currentDirectory + "/" + resourceUriFragment;
   }
});
/*
Name: DocumentImage

Description: Represents an element in the <resources> part of the SmartDocumentDefinition.

Requires:

Provides:
    - DocumentImage

Part of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. 
http://www.processpuzzle.com

Authors: 
    - Zsolt Zsuffa

Copyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the 
GNU General Public License as published by the Free Software Foundation, either version 3 of the License, 
or (at your option) any later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/





var DocumentImage = new Class({
   Extends: DocumentResource,
   Binds: ['loadResource'],   
   
   options: {
      titleSelector : "@title"
   },
   
   //Constructor
   initialize: function( resourceElement, options ){
      this.options.type = "Image";
      this.parent( resourceElement, options );
      this.title = null;
   },
   
   //Public mutators and accessor methods
   release: function(){
      this.parent();
   },

   unmarshall: function(){
      this.parent();
      this.title = XmlResource.selectNodeText( this.options.titleSelector, this.resourceElement );
   },

   //Properties
   getTitle: function() { return this.title; },
   
   //Protected, private helper methods
   checkResourceAvailability: function(){
      this.resourceAvailable = true;
      this.availabilityCheckIsRunning = false;
      this.loadChain.callChain();
   }.protect(),
   
   isResourceLoaded: function(){
      return false;
   }.protect(),
   
   loadResource: function(){
      Asset.image( this.resourceUri, {
         id: this.id,
         title: this.title,
         onAbort: function(){
            this.onResourceError();
         }.bind( this ),
         
         onError: function(){
            this.onResourceError();
         }.bind( this ),
         
         onLoad: function(){
            this.onResourceLoaded();
         }.bind( this )
     });      
   }.protect()
});
/*
Name: DocumentScript

Description: Represents an element in the <resources> part of the SmartDocumentDefinition.

Requires:

Provides:
    - DocumentScript

Part of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. 
http://www.processpuzzle.com

Authors: 
    - Zsolt Zsuffa

Copyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the 
GNU General Public License as published by the Free Software Foundation, either version 3 of the License, 
or (at your option) any later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/





var DocumentScript = new Class({
   Extends: DocumentResource,
   Binds: ['loadResource'],   
   
   //Constructor
   initialize: function( resourceElement, options ){
      this.options.type = "Script";
      this.parent( resourceElement, options );
   },
   
   //Public mutators and accessor methods
   release: function(){
      this.parent();
   },

   //Properties
   
   //Protected, private helper methods
   isResourceLoaded: function(){
      var scriptElement = $$("script[src='" + this.resourceUri + "']"); 
      return scriptElement.length > 0;
   }.protect(),
   
   loadResource: function(){
      Asset.javascript( this.resourceUri, {
         id: this.id,
         onLoad: function(){
            this.htmlElement = $$("script[src='" + this.resourceUri + "']");
            this.onResourceLoaded();
         }.bind( this )
     });      
   }.protect()
});
/*
Name: DocumentResource

Description: Represents an element in the <resources> part of the SmartDocumentDefinition.

Requires:

Provides:
    - DocumentResource

Part of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. 
http://www.processpuzzle.com

Authors: 
    - Zsolt Zsuffa

Copyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the 
GNU General Public License as published by the Free Software Foundation, either version 3 of the License, 
or (at your option) any later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/





var DocumentStyleSheet = new Class({
   Extends: DocumentResource,
   Binds: ['loadResource'],   
   
   options: {
      componentName : "DocumentStyleSheet",
      idPrefix : 'css-preload-'
   },
   
   //Constructor
   initialize: function( resourceElement, options ){
      this.options.type = "StyleSheet";
      this.parent( resourceElement, options );
      this.remoteResource;
   },
   
   //Public mutators and accessor methods
   release: function(){
      this.parent();
   },

   //Properties
   
   //Protected, private helper methods
   isResourceLoaded: function(){
      var linkElement = $$("link[href='" + this.resourceUri + "']"); 
      return linkElement.length > 0;
   }.protect(),
   
   loadResource: function(){
      new RemoteStyleSheet( this.resourceUri, {
         onReady: function( path, element ) {
            this.logger.debug( "Stylesheet: '" + path + "' was added to the document." );
            this.htmlElement = element;
            this.onResourceLoaded();
         }.bind( this ),
         
         onError: function() {
            this.logger.debug( "Error: Couldn't load style sheet '" + this.resourceUri + "'." );
            this.onResourceError();
         }.bind( this ),
         
         onStart: function() {
            this.logger.debug( "Started to add: '" + this.resourceUri + "' to the document." );
         }.bind( this )
      }).start();
   }.protect()
});
/*
Name: ResourceManager

Description: Represents a collection of DocumentResorce objects and provides common handling methods like load unLoad.

Requires:

Provides:
    - ResourceManager

Part of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. 
http://www.processpuzzle.com

Authors: 
    - Zsolt Zsuffa

Copyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the 
GNU General Public License as published by the Free Software Foundation, either version 3 of the License, 
or (at your option) any later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/




var ResourceManager = new Class({
   Implements: [Events, Options],
   Binds: ['onResourceError', 'onResourceLoaded'],   

   options: {
      documentImagesSelector: "images/image",
      documentScriptsSelector: "javaScripts/javaScript",
      documentStyleSheetsSelector: "styleSheets/styleSheet",
      eventFireDelay : 5,
      type : null
   },
   
   //Constructor
   initialize: function( resourceDefinition, options ){
      this.setOptions( options );
      
      this.error = null;
      this.numberOfResourcesLoaded = 0;
      this.resourceDefinition = resourceDefinition;
      this.resourceUri = null;
      this.resources = new ArrayList();
      this.state = ResourceManager.States.INITIALIZED;
      this.styleSheets = new ArrayList();
   },
   
   //Public mutators and accessor methods
   load: function(){
      if( this.resources.size() > 0 ){
         this.resources.each( function( documentResource, index ){
            documentResource.load();
         }, this );
      }else{
         this.state = ResourceManager.States.LOADED;
         this.fireEvent( 'resourcesLoaded', this );
      }
   },
   
   onResourceError: function( resourceUri ){
      this.error = new UndefinedDocumentResourceException( resourceUri );
      this.fireEvent( 'resourceError', this.error, this.options.eventFireDelay );
      this.onResourceLoaded( resourceUri );
   },
   
   onResourceLoaded: function( resource ){
      this.numberOfResourcesLoaded++;
      if( this.resources.size() > 0 && this.numberOfResourcesLoaded >= this.resources.size() ){
         this.state = ResourceManager.States.LOADED;
         this.fireEvent( 'resourcesLoaded', this, this.options.eventFireDelay );
      }
   },
   
   release: function(){
      this.resources.each( function( documentResource, index ){
         documentResource.release();
      }, this );
      
      this.styleSheets.clear();
      this.resources.clear();
      this.numberOfResourcesLoaded = 0;
   },
   
   unmarshall: function(){
      this.unmarshallResources();
      this.state = ResourceManager.States.UNMARSHALLED;
   },

   //Properties
   getError: function() { return this.error; },
   getResources: function() { return this.resources; },
   getResourceType: function() { return this.options.type; },
   getResourceUri: function() { return resourceUri; },
   getState: function() { return this.state; },
   getStyleSheets: function() { return this.styleSheets; },
   isSuccess: function() { return this.error == null; },
   
   //Protected, private helper methods
   unmarshallResource: function( selector, resourceClass ) {
      var resourceElements = XmlResource.selectNodes( selector, this.resourceDefinition );
      resourceElements.each( function( resourceElement, index ){
         var documentResource = new resourceClass( resourceElement, { onResourceLoaded : this.onResourceLoaded, onResourceError : this.onResourceError } );
         documentResource.unmarshall();
         this.resources.add( documentResource );
         if( instanceOf( documentResource, DocumentStyleSheet )) this.styleSheets.add( documentResource );
      }, this );
   }.protect(),
   
   unmarshallResources: function() {
      this.unmarshallResource( this.options.documentScriptsSelector, DocumentScript );
      this.unmarshallResource( this.options.documentStyleSheetsSelector, DocumentStyleSheet );
      this.unmarshallResource( this.options.documentImagesSelector, DocumentImage );
   }.protect()
});

ResourceManager.States = { INITIALIZED : 0, UNMARSHALLED : 1, LOADED : 2 };
/*
Name: UndefinedXmlResourceException

Description: 

Requires:

Provides:

Part of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. 
http://www.processpuzzle.com

Authors: 
	- Zsolt Zsuffa

Copyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the 
GNU General Public License as published by the Free Software Foundation, either version 3 of the License, 
or (at your option) any later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/




var UndefinedDocumentResourceException = new Class({
   Extends: WebUIException,
   options: {
      description: "Given document resource: '{resourceName}' doesn't exist or can't be accessed.",
      name: "UndefinedDocumentException"
   },
   
   //Constructor
   initialize : function( resourceName, options ){
      this.setOptions( options );
      this.parent( options );
      this.parameters = { resourceName : resourceName };
   }	
});
/*
Name: NoneExistingScrollableElementException

Description: Thrown when the specified scrollable element doesn't exist.

Requires: WebUIException

Provides: NoneExistingScrollableElementException

Part of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. 
http://www.processpuzzle.com

Authors: 
	- Zsolt Zsuffa

Copyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the 
GNU General Public License as published by the Free Software Foundation, either version 3 of the License, 
or (at your option) any later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/




var NoneExistingScrollableElementException = new Class({
   Extends: WebUIException,
   options: {
      description: "The specifified scrollable element: '{scrollableElementId}' doesn't exist.",
      name: "NoneExistingScrollableElementException"
   },
   
   //Constructor
   initialize : function( scrollableElementId, options ){
      this.setOptions( options );
      this.parent( options );
      this.parameters = { scrollableElementId : scrollableElementId };
   }	
});
/*
Name: 
    - ScrollArea

Description: 
    - Wraps scrollable element into a scroll window and adds scroll controls.

Requires:
    - 
Provides:
    - ScrollingArea

Part of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. 
http://www.processpuzzle.com

Authors: 
    - Zsolt Zsuffa

Copyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the 
GNU General Public License as published by the Free Software Foundation, either version 3 of the License, 
or (at your option) any later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/




var ScrollArea = new Class({
   Implements : Options,
   Binds : ['onScrollContent', 'onScrollableElementClick', 'onScrollableElementKeyDown', 'onScrollableElementMouseWheel'],
   options : {
      componentName : "ScrollArea",
      contentHeight : null,
      contentViewElementClass : 'contentEl',
      contentWidth : null,
      handleOpacity : 1,
      handleActiveOpacity : 0.85,
      paddingElementClass : 'paddingEl',
   },

   initialize : function( scrollableElement, windowFxScroll, options ) {
      assertThat( scrollableElement, not( nil() ));
      this.setOptions( options );

      this.borderHeight;
      this.contentViewElement;
      this.contentWrapperElement;
      this.hasFocusTimeout;
      this.scrollableElement = scrollableElement;
      this.scrollableElementPadding = this.scrollableElement.getStyles( 'padding-top', 'padding-right', 'padding-bottom', 'padding-left' );
      this.scrollableElementSize = this.scrollableElement.getStyles( 'height', 'width' );
      this.scrollControls;
      this.sliderTimeout;
      this.step;
      this.overHang;
      this.paddingHeight;
      this.paddingWidth;
      this.windowFxScroll = windowFxScroll;
   },

   // Public accessors and mutators
   construct : function() {
      this.createContentViewElement();
      this.determineBorderHeight();
      this.determinePadding();
      this.createPaddingElement();
      this.setContentElementStyle();
      
      this.adjustContentWrapperWidth();
      this.determineOverHang();
      this.constructScrollControls();
      
      this.addScrollableElementEvents();
   },

   destroy : function() {
      this.removeScrollableElementEvents();
      
      this.restoreContentElement();
      
      this.destroyScrollControls();
      this.destroyPaddingElement();
      this.destroyContentViewElement();
   },

   onScrollContent : function( step ){
      this.contentViewElement.scrollTo( 0, step );
   },
   
   onScrollableElementClick : function( e ){
      this.hasFocus = true;
      this.hasFocusTimeout = (function() {
         clearInterval( this.hasFocusTimeout );
         this.hasFocus = true;
      }.bind( this )).delay( 50 );
   },
   
   onScrollableElementKeyDown : function( e ){
      if( e.key === 'up' ) {
         e = new Event( e ).stop();
         this.scrollControls.scrollUp();
      }else if (e.key === 'down' || e.key === 'space') {
         e = new Event( e ).stop();
         this.scrollControls.scrollDown();
      }
   },
   
   onScrollableElementMouseWheel : function( mouseWheelEvent ){
      //event = new Event( mouseWheelEvent )
      mouseWheelEvent.stop();
      if( mouseWheelEvent.wheel > 0) { this.scrollControls.scrollUp(); }
      else if( mouseWheelEvent.wheel < 0 ) { this.scrollControls.scrollDown(); }
   },
   
   refresh : function( size ) {
      this.setContentViewSize( size );
      this.adjustContentWrapperWidth();
      this.determineOverHang();
      this.scrollControls.refresh( this.overHang );
   },
   
   //Properties
   getContentViewElement : function() { return this.contentViewElement; },
   getContentViewSize : function() { 
      var contentWidth = this.contentViewElement.getSize().x;
      contentWidth -= parseInt( this.contentWrapperElement.getStyle( 'margin-left' )) + parseInt( this.contentWrapperElement.getStyle( 'margin-right' ));
      contentWidth -= parseInt( this.contentWrapperElement.getStyle( 'padding-left' )) + parseInt( this.contentWrapperElement.getStyle( 'padding-right' ));
      contentWidth += this.scrollControls.getEffectiveWidth();
      if( this.scrollControls.isVisible() ) contentWidth -= this.scrollControls.getWidth();
      return { x : contentWidth, y : this.contentViewElement.getSize().y }; },
   getContentWrapperElement : function(){ return this.contentWrapperElement; },

   // Protected, private helper methods
   adjustContentWrapperWidth : function(){
      this.determineOverHang();
      var rightMargin = this.overHang <= 0 ? '0px' : '15px';
      this.contentWrapperElement.setStyle( 'margin-right', rightMargin );
   }.protect(),

   addScrollableElementEvents : function(){
      this.scrollableElement.addEvents({
         'mousewheel' : this.onScrollableElementMouseWheel,
         'keydown' : this.onScrollableElementKeyDown,
         'click' : this.onScrollableElementClick
      });
   }.protect(),
   
   constructScrollControls : function(){
      this.scrollControls = new ScrollControls( this.contentViewElement, this.overHang, { onScrollContent : this.onScrollContent } );
      this.scrollControls.construct();
   }.protect(),
   
   createContentViewElement : function(){
      this.contentViewElement = new Element( 'div', { 'class' : this.options.contentViewElementClass });
      this.contentViewElement.wraps( this.scrollableElement );
      this.contentViewElement.setStyles({  overflow : 'hidden', padding : 0, });
      this.determinePadding();
      this.setContentViewSize();
   }.protect(),
   
   createPaddingElement : function(){
      this.contentWrapperElement = new Element( 'div', { 'class' : this.options.paddingElementClass });
      this.contentWrapperElement.adopt( this.contentViewElement.getChildren() );
      this.contentWrapperElement.inject( this.contentViewElement, 'top' );
      this.contentWrapperElement.setStyles( this.scrollableElementPadding );
      this.contentWrapperElement.setStyles({ display: 'inline', 'float': 'left' });
   }.protect(),
   
   destroyContentViewElement : function(){
      if( this.contentViewElement && this.contentViewElement.destroy ){
         this.contentViewElement.destroy();
         this.contentViewElement = null;
      }
   }.protect(),
   
   destroyPaddingElement : function(){
      if( this.contentWrapperElement && this.contentWrapperElement.destroy ){ 
         this.contentWrapperElement.destroy();
         this.contentWrapperElement = null;
      }
   }.protect(),
   
   destroyScrollControls : function(){
      if( this.scrollControls ){
         this.scrollControls.removeEvent( 'scrollContent', this.onScrollContent );
         this.scrollControls.destroy();      
      }
   }.protect(),
   
   determineBorderHeight : function(){
      this.borderHeight = parseFloat( this.scrollableElement.getStyle( 'border-top-width' )) + parseFloat( this.scrollableElement.getStyle( 'border-bottom-width' ));
   }.protect(),
   
   determineOverHang : function(){
      this.overHang = this.scrollableElement.getSize().y + parseInt( this.contentWrapperElement.getStyle( 'padding-top' )) - this.contentViewElement.getSize().y;
   }.protect(),
   
   determinePadding : function(){
      this.paddingHeight = parseFloat( this.scrollableElement.getStyle( 'padding-top' )) + parseFloat( this.scrollableElement.getStyle( 'padding-bottom' ) );
      this.paddingWidth = parseFloat( this.scrollableElement.getStyle( 'padding-left' )) + parseFloat( this.scrollableElement.getStyle( 'padding-right' ) );
   }.protect(),
   
   removeScrollableElementEvents : function(){
      if( this.scrollableElement && this.scrollableElement.removeEvent ){
         this.scrollableElement.removeEvent( 'mousewheel', this.onScrollableElementMouseWheel );
         this.scrollableElement.removeEvent( 'keydown', this.onScrollableElementKeyDown );
         this.scrollableElement.removeEvent( 'click', this.onScrollableElementClick );
      }
   }.protect(),
   
   restoreContentElement : function(){
      if( this.contentViewElement ){
         this.scrollableElement.dispose();
         this.scrollableElement.inject( this.contentViewElement, 'before' );
      }
      
      this.scrollableElement.setStyles( this.scrollableElementSize );
   }.protect(),
   
   setContentElementStyle : function(){
      this.scrollableElement.setStyles({ height : '100%', margin : '0px', padding : '0px', width : '100%' });
   }.protect(),
   
   setContentViewSize : function( size ){      
      if( size && size.x && size.y ){
         this.options.contentHeight = size.y;
         this.options.contentWidth = size.x;
      }else if( !this.options.contentHeight && !this.options.contentWidth ){
         this.options.contentHeight = parseInt( this.scrollableElement.getStyle( 'height' ));
         this.options.contentWidth = parseInt( this.scrollableElement.getStyle( 'width' ));
      }

      this.contentViewElement.setStyles({ width : this.options.contentWidth + 'px', height : this.options.contentHeight + 'px' });
   }.protect()
 
});
/*
Name: 
    - ScrollControls

Description: 
    - User interface for the scrolling behaviour.

Requires:
    - 
Provides:
    - ScrollConstrols

Part of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. 
http://www.processpuzzle.com

Authors: 
    - Zsolt Zsuffa

Copyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the 
GNU General Public License as published by the Free Software Foundation, either version 3 of the License, 
or (at your option) any later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/




var ScrollControls = new Class({
   Implements : [Events, Options],
   Binds : ['onDocumentClick', 'onDocumentKeyDown', 'onDocumentMouseUp', 'scrollDown', 'scrollUp'],
   options : {
      componentName : "ScrollControls",
      disabledOpacity : 0,
      downBtnClass : 'downBtn',
      increment : 15,
      scrollBarClass : 'scrollBar',
      scrollControlsYClass : 'scrollControlsY',
      scrollHandleClass : 'scrollHandle',
      scrollHandleBGClass : 'scrollHandleBG',
      scrollHandleTopClass : 'scrollHandleTop',
      scrollHandleMiddleClass : 'scrollHandleMiddle',
      scrollHandleBottomClass : 'scrollHandleBottom',
      scrollSlotClass : 'scrollSlot',
      upBtnClass : 'upBtn'
   },

   initialize : function( contentViewElement, overHang, options ) {
      assertThat( contentViewElement, not( nil() ));
      assertThat( overHang, not( nil() ));
      this.setOptions( options );

      this.contentViewElement = contentViewElement;
      this.downButton;
      this.downInterval;
      this.overHang = overHang;
      this.scrollSlot;
      this.scrollHandle;
      this.scrollHandleBG;
      this.slider;
      this.state = BrowserWidget.States.INITIALIZED;
      this.upButton;
      this.upInterval;
   },

   // Public accessors and mutators
   construct : function() {
      this.createControlElements();
      this.setHeights();
      this.createSlider();
      this.illuminateScrollControls();      
      
      this.addScrollHandleEvents();
      this.addUpButtonEvents();
      this.addDownButtonEvents();
      this.addContentViewEvents();
      this.addDocumentEvents();
      
      this.state = BrowserWidget.States.CONSTRUCTED;
   },

   destroy : function() {
      clearInterval( this.sliderTimeout );
      this.removeScrollHandleEvents();
      this.removeDownButtonEvents();
      this.removeUpButtonEvents();
      this.removeContentViewEvents();
      this.removeDocumentEvents();
      
      this.destroySlider();
      this.destroyControlElements();
      
      this.state = BrowserWidget.States.INITIALIZED;
   },
   
   onDocumentClick : function( e ){
      this.hasFocus = false;
   },
   
   onDocumentKeyDown : function( e ){
      if(( this.hasFocus || this.options.fullWindowMode ) && ( e.key === 'down' || e.key === 'space' || e.key === 'up' )) {
         this.scrollableElement.fireEvent( 'keydown', e );
      }
   },
   
   onDocumentMouseUp : function( e ){
      this.scrollHandle.removeClass( this.options.scrollHandleClass + '-Active' ).setStyle( 'opacity', this.options.handleOpacity );
      this.stopScrollUp();
      this.stopScrollDown();
   },
   
   refresh : function( overHang ){
      this.overHang = overHang;
      this.updateSlider();
      this.illuminateScrollControls();      
      this.setHeights();
   },
   
   scrollDown : function() {
      var target = this.contentViewElement.getScroll().y + this.options.increment;
      this.slider.set( target );
   },

   scrollUp : function() {
      var target = this.contentViewElement.getScroll().y - this.options.increment;
      if( target < 0 ) target = 0;
      this.slider.set( target );
   },

   //Properties
   getEffectiveWidth : function() { return ( this.isVisible() ? this.getWidth() : 0 ); },
   getSlider : function() { return this.slider; },
   getWidth : function() { return this.scrollControlsYWrapper ? this.scrollControlsYWrapper.getSize().x : 0; },
   isVisible : function() { return this.overHang > 0 ? true : false; },


   // Protected, private helper methods
   addContentViewEvents : function(){
      this.contentViewElement.addEvents({
         'scroll' : function(e) {
            this.slider.set( this.contentViewElement.getScroll().y );
         }.bind( this )
      });
   }.protect(),
   
   addDocumentEvents : function(){
      document.addEvents({
         'mouseup' : this.onDocumentMouseUp,
         'keydown' : this.onDocumentKeyDown,
         'click' : this.onDocumentClick
      });
   }.protect(),
   
   addDownButtonEvents : function(){
      this.downButton.addEvents({
         'mousedown' : function( e ) {
            clearInterval( this.upInterval );
            clearInterval( this.downInterval );
            this.downInterval = this.scrollDown.periodical( 10, this );
            this.downButton.addClass( this.options.downBtnClass + '-Active' );
         }.bind( this ),

         'mouseup' : function( e ) { this.stopScrollDown(); }.bind( this ),
         'mouseout' : function( e ) { this.stopScrollDown(); }.bind( this )
      });
   }.protect(),
   
   addScrollHandleEvents : function(){
      this.scrollHandle.addEvents({
         'mousedown' : function(e) {
            this.scrollHandle.addClass( this.options.scrollHandleClass + '-Active' ).setStyle( 'opacity', this.options.handleActiveOpacity );
         }.bind( this )
      });
   }.protect(),
   
   addUpButtonEvents : function(){
      this.upButton.addEvents({
         'mousedown' : function( e ) {
            clearInterval( this.upInterval );
            clearInterval( this.downInterval );
            this.upInterval = this.scrollUp.periodical( 10, this );
            this.upButton.addClass( this.options.upBtnClass + '-Active' );
         }.bind( this ),

         'mouseup' : function( e ) { this.stopScrollUp(); }.bind( this ),
         'mouseout' : function( e ) { this.stopScrollUp(); }.bind( this )
      } );
   }.protect(),
      
   createControlElements : function() {
      this.scrollControlsYWrapper = new Element( 'div', { 'class' : this.options.scrollControlsYClass }).inject( this.contentViewElement, 'bottom' );
      this.upButton = new Element( 'div', { 'class' : this.options.upBtnClass }).inject( this.scrollControlsYWrapper, 'bottom' );
      this.downButton = new Element( 'div', { 'class' : this.options.downBtnClass }).inject( this.scrollControlsYWrapper, 'bottom' );
      this.scrollSlot = new Element( 'div', { 'class' : this.options.scrollSlotClass }).inject( this.scrollControlsYWrapper, 'bottom' );
      this.scrollHandle = new Element( 'div', { 'class' : this.options.scrollHandleClass }).inject( this.scrollSlot, 'inside' );
      this.scrollHandleTop = new Element( 'div', { 'class' : this.options.scrollHandleTopClass }).inject( this.scrollHandle, 'inside' );
      this.scrollHandleBG = new Element( 'div', { 'class' : this.options.scrollHandleBGClass }).inject( this.scrollHandle, 'inside' );
      this.scrollHandleMiddle = new Element( 'div', { 'class' : this.options.scrollHandleMiddleClass }).inject( this.scrollHandle, 'inside' );
      this.scrollHandleBottom = new Element( 'div', { 'class' : this.options.scrollHandleBottomClass }).inject( this.scrollHandle, 'inside' );
   }.protect(),
   
   createSlider : function() {
      var upperBound = this.overHang >= 0 ? Math.round( this.overHang ) : 0;
      this.slider = new Slider( this.scrollSlot, this.scrollHandle, {
         range : [ 0, upperBound ],
         mode : 'vertical',
         snap : true,
         onChange : function( step, e ) {
            if( this.state == BrowserWidget.States.CONSTRUCTED ) this.fireEvent( 'scrollContent', step );
         }.bind( this )
      });
      
      this.slider.set( 0 );
   }.protect(),
   
   destroyControlElements : function(){
      if( this.upButton ){ this.upButton.destroy(); this.upButton = null; }
      if( this.downButton ){ this.downButton.destroy(); this.downButton = null; }
      if( this.scrollHandleTop ){ this.scrollHandleTop.destroy(); this.scrollHandleTop = null; }
      if( this.scrollHandleBG ){ this.scrollHandleBG.destroy(); this.scrollHandleBG = null; }
      if( this.scrollHandleMiddle ){ this.scrollHandleMiddle.destroy(); this.scrollHandleMiddle = null; }
      if( this.scrollHandleBottom ){ this.scrollHandleBottom.destroy(); this.scrollHandleBottom = null; }
      if( this.scrollHandle ){ this.scrollHandle.destroy(); this.scrollHandle = null; }
      if( this.scrollSlot ){ this.scrollSlot.destroy(); this.scrollSlot = null; }
      if( this.scrollControlsYWrapper ){ this.scrollControlsYWrapper.destroy(); this.scrollControlsYWrapper = null; }
   }.protect(),
   
   destroySlider: function(){
      if( this.slider ){
         this.slider.removeEvents();
         this.slider = null;
      }
   }.protect(),
   
   greyOut : function() {
      this.scrollHandle.setStyles({ opacity : this.options.disabledOpacity });
      this.scrollHandleTop.setStyles({ opacity : this.options.disabledOpacity });
      this.scrollHandleBG.setStyles({ opacity : this.options.disabledOpacity });
      this.scrollHandleMiddle.setStyles({ opacity : this.options.disabledOpacity });
      this.scrollHandleBottom.setStyles({ opacity : this.options.disabledOpacity });
      this.upButton.setStyles({ opacity : this.options.disabledOpacity });
      this.scrollControlsYWrapper.setStyles({ opacity : this.options.disabledOpacity });
      this.downButton.setStyles({ opacity : this.options.disabledOpacity });
      this.scrollSlot.setStyles({ opacity : this.options.disabledOpacity });
   }.protect(),
   
   illuminateScrollControls : function(){
      if( this.overHang <= 0 ){ this.greyOut();
      }else{ this.unGrey(); }
   }.protect(),

   removeContentViewEvents : function(){
      if( this.contentViewElement && this.contentViewElement.removeEvents ) this.contentViewElement.removeEvents();
   }.protect(),
   
   removeDocumentEvents : function(){
      document.removeEvent( 'mouseup', this.onDocumentMouseUp );
      document.removeEvent( 'keydown', this.onDocumentKeyDown );
      document.removeEvent( 'click', this.onDocumentClick );
   }.protect(),
   
   removeDownButtonEvents : function(){
      if( this.downButton && this.downButton.removeEvents ) this.downButton.removeEvents();
      this.stopScrollDown();
   }.protect(),
   
   removeScrollHandleEvents : function(){
      if( this.scrollHandle && this.scrollHandle.removeEvents ) this.scrollHandle.removeEvents();
   }.protect(),
   
   removeUpButtonEvents : function(){
      if( this.upButton && this.upButton.removeEvents ) this.upButton.removeEvents();
      this.stopScrollUp();
      
   }.protect(),
   
   setHandleHeight : function() {
      var handleHeightRatio = this.overHang > 0 ? 1 / ( 1 + this.overHang / this.contentViewElement.getSize().y ) : 1;
      var slotHeight = this.scrollSlot.getSize().y;
      var handleHeight = Math.round( handleHeightRatio * slotHeight );
      
      var minimumHandleHeight = this.scrollHandleBottom.getSize().y + this.scrollHandleTop.getSize().y;
      if( handleHeight < minimumHandleHeight ) {
         handleHeight = minimumHandleHeight;
      }
      
      this.scrollHandle.setStyles({ height : handleHeight + 'px' });
      
      var handleMiddleHeight = handleHeight - ( this.scrollHandleTop.getSize().y + this.scrollHandleBottom.getSize().y );
      handleMiddleHeight = handleMiddleHeight > 0 ? handleMiddleHeight : 0;
      this.scrollHandleBG.setStyles({ height : handleMiddleHeight + 'px' });
   }.protect(),
   
   setHeights : function(){
      this.setScrollSlotHeight();
      this.setHandleHeight();
   }.protect(),
   
   setScrollSlotHeight : function(){
      var slotHeight = this.contentViewElement.getSize().y - ( this.downButton.getSize().y + this.upButton.getSize().y + parseInt( this.scrollSlot.getStyle( 'top' )) + parseInt( this.scrollSlot.getStyle( 'margin-bottom' )));
      slotHeight = slotHeight > 0 ? slotHeight : 0;
      this.scrollSlot.setStyles({ height : slotHeight + 'px' });
   }.protect(),

   stopScroll : function(){
      this.stopScrollDown();
      this.stopScrollUp();
   }.protect(),
   
   stopScrollDown : function(){
      clearInterval( this.downInterval );
      if( this.downButton && this.downButton.removeClass ) this.downButton.removeClass( this.options.downBtnClass + '-Active' );
   },
   
   stopScrollUp : function(){
      clearInterval( this.downInterval );
      if( this.upButton && this.upButton.removeClass ) this.upButton.removeClass( this.options.upBtnClass + '-Active' );
   },
   
   unGrey : function() {
      this.scrollHandle.setStyles({ display : 'block', opacity : 1 });
      this.scrollHandleTop.setStyles({ opacity : 1 });
      this.scrollHandleBG.setStyles({ opacity : 1 });
      this.scrollHandleMiddle.setStyles({ opacity : 1 });
      this.scrollHandleBottom.setStyles({ opacity : 1 });
      this.scrollControlsYWrapper.setStyles({ opacity : 1 });
      this.upButton.setStyles({ opacity : 1 });
      this.downButton.setStyles({ opacity : 1 });
      this.scrollSlot.setStyles({ opacity : 1 });
   }.protect(),
   
   updateSlider : function(){
      if( this.overHang > 0 ) this.slider.setRange([ 0, this.overHang ]);
      this.slider.set( 0 );
   }

});
/*
Name: 
    - ScrollingBehaviour

Description: 
    - Add scrolling behaviour to any div or span element.

Requires:
    - 
Provides:
    - ScrollingBehaviour

Part of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. 
http://www.processpuzzle.com

Authors: 
    - Zsolt Zsuffa

Copyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the 
GNU General Public License as published by the Free Software Foundation, either version 3 of the License, 
or (at your option) any later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/




var ScrollingBehaviour = new Class({
   Implements : Options,
   options : {
      contentHeight : null,
      contentWidth : null,
      disabledOpacity : 0,
      downBtnClass : 'downBtn',
      fullWindowMode : false,
      handleOpacity : 1,
      handleActiveOpacity : 0.85,
      increment : 15,
      restrictedBrowsers : [ Browser.Engine.presto925, Browser.Platform.ipod, Browser.Engine.webkit419 ],
      scrollBarClass : 'scrollBar',
      scrollHandleClass : 'scrollHandle',
      scrollHandleBGClass : 'scrollHandleBG',
      scrollHandleTopClass : 'scrollHandleTop',
      scrollHandleMiddleClass : 'scrollHandleMiddle',
      scrollHandleBottomClass : 'scrollHandleBottom',
      scrollControlsYClass : 'scrollControlsY',
      selector : '.scroll',
      smoothMooScroll : {
         toAnchor : true,
         toMooScrollArea : true
      },
      upBtnClass : 'upBtn'
   // Opera 9.25 or lower, Safari 2 or lower, iPhone/iPod Touch
   },

   //Constructor
   initialize : function( scrollableElement, options ) {
      if( this.options.restrictedBrowsers.contains( true )) { return; }
      this.setOptions( options );

      this.scrollArea;
      this.scrollableElement;
      this.windowFxScroll = new Fx.Scroll( document.window, { wait : false });
      
      this.identifyScrollableElement( scrollableElement );
   },
   
   //Public accessors and mutators
   construct : function(){
      this.scrollArea = new ScrollArea( this.scrollableElement, this.windowFxScroll, this.options );
      this.scrollArea.construct();
      
      if( this.options.smoothMooScroll.toAnchor || this.options.smoothMooScroll.toMooScrollArea ) {
         this.smoothMooScroll = new SmoothScroll({
            toAnchor : this.options.smoothMooScroll.toAnchor,
            toMooScrollArea : this.options.smoothMooScroll.toMooScrollArea
         }, this.scrollArea.contentEl, this.windowFxScroll );
      }
   },
   
   destroy : function(){
      if( this.scrollArea ) this.scrollArea.destroy();
   },

   loadContent : function( content ) {
      this.scrollArea.loadContent( content );
   },

   refresh : function( size ) {
      this.scrollArea.refresh( size );
   },

   setSlider : function(v) {
      this.scrollAreas.setSlider( v );
   },
   
   //Properties
   getContentViewSize : function() { return this.scrollArea.getContentViewSize(); },
   getScrollableElement : function() { return this.scrollableElement; },
   getScrollArea : function() { return this.scrollArea; },
   
   //Protected, private helper methods
   identifyScrollableElement : function( scrollableElement ){
      this.scrollableElement = $( scrollableElement );
      if( !this.scrollableElement ) throw new NoneExistingScrollableElementException( scrollableElement );
   }
});
/*
 * MooScroll beta [for mootools 1.2]
 * @author Jason J. Jaeger | greengeckodesign.com
 * @version 0.59
 * @license MIT-style License
 *       Permission is hereby granted, free of charge, to any person obtaining a copy
 *       of this software and associated documentation files (the "Software"), to deal
 *       in the Software without restriction, including without limitation the rights
 *       to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 *       copies of the Software, and to permit persons to whom the Software is
 *       furnished to do so, subject to the following conditions:
 * 
 *       The above copyright notice and this permission notice shall be included in
 *       all copies or substantial portions of the Software.
 * 
 *       THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 *       IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 *       FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 *       AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 *       LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 *       OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 *       THE SOFTWARE.
 */




var SmoothScroll = new Class({
   Extends: Fx.Scroll,
   initialize: function(options, context, windowFxScroll){
      this.setOptions(options);
      this.windowFxScroll = windowFxScroll;
      this.context = context;
      context = context || document;
      this.context = context;
      var doc = context.getDocument(), win = context.getWindow();    
      this.parent(context, options);
      
      this.links = (this.options.links) ? $$(this.options.links) : $$(doc.links);
      var location = win.location.href.match(/^[^#]*/)[0] + '#';
      this.links.each(function(link){
         if (link.href.indexOf(location) != 0) {   return;  }
         var anchor = link.href.substr(location.length);
         if (anchor && $(anchor) && $(anchor).getParents().contains($(this.context))) {
            this.useLink(link,anchor, true);
         }else if(anchor && $(anchor) && !this.inMooScrollArea($(anchor))){
            this.useLink(link,anchor, false);
         }
      }, this);
      if (!Browser.Engine.webkit419) this.addEvent('complete', function(){
         win.location.hash = this.anchor;
      }, true);
   },
   
   inMooScrollArea:function(el){
      return el.getParents().filter(function(item, index){return item.match('[rel=MooScrollArea]');}).length > 0;
   },
   
   putAnchorInAddressBar:function(anchor){
      window.location.href = "#" + anchor;      
   },

   useLink: function(link, anchor, inThisMooScrollArea){    
      link.removeEvents('click');
      link.addEvent('click', function(event){         
         if(!anchor || !$(anchor)){return;}        
         this.anchor = anchor;
         if (inThisMooScrollArea) {
            if(this.options.toMooScrollArea && this.options.toAnchor){
               this.windowFxScroll.toElement(this.context.getParent()).chain(function(item, index){            
                  this.toElement(anchor).chain(function(){  this.putAnchorInAddressBar(anchor); }.bind(this));          
               }.bind(this));
            }else if(this.options.toMooScrollArea){
               this.windowFxScroll.toElement(this.context.getParent()).chain(function(){  this.putAnchorInAddressBar(anchor); }.bind(this));
            }else if(this.options.toAnchor){
               this.toElement(anchor).chain(function(){  this.putAnchorInAddressBar(anchor); }.bind(this)); 
            }           
         }else{
            this.windowFxScroll.toElement(anchor).chain(function(){  this.putAnchorInAddressBar(anchor); }.bind(this));     
         }
         event.stop();     
      }.bind(this));
   }

});
/*
ProcessPuzzle User Interface
Backend agnostic, desktop like configurable, browser font-end based on MochaUI.
Copyright (C) 2011  Joe Kueser, Zsolt Zsuffa

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/





var SkinChangedMessage = new Class({
   Extends: WebUIMessage,
   options: {
      actionType: null,
      description: "A message about the event that WebUI's skin was changed.",
      name: "SkingChangedMessage",
      newSkin : null,
      previousSkin: null
   },
   
   //Constructors
   initialize: function( options ){
      this.setOptions( options );
      this.options.messageClass = SkinChangedMessage;
   },
   
   //Public accessors
   
   //Properties
   getNewSkin: function() { return this.options.newSkin; },
   getPreviousSkin: function() { return this.options.previousSkin; }
});

/*
ProcessPuzzle User Interface
Backend agnostic, desktop like configurable, browser font-end based on MochaUI.
Copyright (C) 2011  Joe Kueser, Zsolt Zsuffa

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/





var SkinSelectorWidget = new Class({
   Extends : BrowserWidget,
   Binds : ['onSelection'],
   
   options : {
      componentPrefix : "SkinSelectorWidget",
      selectElementId : "SkinSelector",
      selectTextKey : "SkinSelectorWidget.select",
      widgetContainerId : "SkinSelectorWidget",
      wrapperElementStyle : "SkinSelectorWrapper"
   },
   
   //Constructor
   initialize : function( options, resourceBundle, webUIConfiguration ){
      this.setOptions( options );
      this.parent( options, resourceBundle );
      
      this.availableSkins = new HashMap();
      this.isConfigured = false;
      this.selectElement = null;
      this.selectElementContainer = null;
      this.webUIConfiguration = webUIConfiguration;
      
      this.determineInitializationArguments();
      this.determineAvailableSkins();
   },

   //Public accessor and mutator methods
   construct : function() {
      this.createSpanElements();
      this.createSelectElement();
      this.createSelectElementOptions();
      return this.parent();
   },
   
   destroy : function() {
      this.availableSkins.clear();
      this.parent();
   },
   
   onSelection : function() {
      var currentSkin = this.skin;
      var newSkin = this.selectElement.options[this.selectElement.selectedIndex].value;
      var message = new SkinChangedMessage({ previousSkin : currentSkin, newSkin : newSkin, originator : this.options.widgetContainerId });
      this.messageBus.notifySubscribers( message );
   },
   
   //Properties
   getAvailableSkins : function() { return this.availableSkins; },
   getWebUIConfiguration : function() { return this.webUIConfiguration; },
   
   //Private helper methods
   createSelectElement : function(){
      this.selectElement = this.elementFactory.create( 'select', null, this.selectElementContainer, WidgetElementFactory.Positions.FirstChild, { id : this.options.selectElementId } );
      this.selectElement.addEvent( 'change', this.onSelection );
   }.protect(),
   
   createSelectElementOptions : function() {
      var selectedOption = this.elementFactory.createOption( "", this.options.selectTextKey, this.selectElement, WidgetElementFactory.Positions.LastChild );
      selectedOption.set( 'selected' );
      
      this.availableSkins.each( function( skinEntry, index ){
         this.elementFactory.createOption( skinEntry.getKey(), skinEntry.getKey(), this.selectElement, WidgetElementFactory.Positions.LastChild );
      }, this );
   }.protect(),
   
   createSpanElements: function() {
      var skinSelectorWrapper = this.elementFactory.create( 'span', null, null, null, {'class': this.options.wrapperElementStyle });
      this.selectElementContainer = this.elementFactory.create( 'span', null, skinSelectorWrapper, WidgetElementFactory.Positions.LastChild );
   }.protect(),
   
   determineAvailableSkins : function(){
      for( var i = 0; i < this.webUIConfiguration.getAvailableSkinElements().length; i++ ) {
         var skinName = this.webUIConfiguration.getSkinNameByIndex( i );
         var skinPath = this.webUIConfiguration.getSkinPathByIndex( i );
         this.availableSkins.put( skinName, skinPath );
      }
   }.protect(),
   
   determineInitializationArguments : function(){
      if( !this.webUIConfiguration ){
         var webUIController = Class.getInstanceOf( WebUIController );
         this.webUIConfiguration = webUIController.getWebUIConfiguration();
      }
   }.protect()
   
});
/**
 * Script: Slideshow.js Slideshow - A javascript class for Mootools to stream
 * and animate the presentation of images on your website.
 * 
 * License: MIT-style license.
 * 
 * Copyright: Copyright (c) 2011 [Aeron
 * Glemann](http://www.electricprism.com/aeron/).
 * 
 * Dependencies: Mootools 1.3.1 Core: Fx.Morph, Fx.Tween, Selectors,
 * Element.Dimensions. Mootools 1.3.1.1 More: Assets.
 */




(function() {
   WhenPaused = 1 << 0;
   WhenPlaying = 1 << 1;
   OnStart = 1 << 2;

   Slideshow = new Class({
            Implements : [Chain, Events, Options],

            options : {/*
                         * onComplete: $empty, onEnd: $empty, onStart: $empty,
                         */
               accesskeys : {
                  'first' : {
                     'key' : 'shift left',
                     'label' : 'Shift + Leftwards Arrow'},
                  'prev' : {
                     'key' : 'left',
                     'label' : 'Leftwards Arrow'},
                  'pause' : {
                     'key' : 'p',
                     'label' : 'P'},
                  'next' : {
                     'key' : 'right',
                     'label' : 'Rightwards Arrow'},
                  'last' : {
                     'key' : 'shift right',
                     'label' : 'Shift + Rightwards Arrow'}},
               captions : true,
               center : true,
               classes : [/*
                            * 'slideshow', 'first', 'prev', 'play', 'pause',
                            * 'next', 'last', 'images', 'captions',
                            * 'controller', 'thumbnails', 'hidden', 'visible',
                            * 'inactive', 'active', 'loader'
                            */],
               controller : true,
               data : null,
               delay : 2000,
               duration : 1000,
               fast : false,
               height : false,
               href : '',
               hu : '',
               linked : false,
               loader : true,
               loop : true,
               match : /\?slide=(\d+)$/,
               overlap : true,
               paused : false,
               random : false,
               replace : [/(\.[^\.]+)$/, 't$1'],
               resize : 'fill',
               slide : 0,
               thumbnails : true,
               titles : false,
               transition : 'sine:in:out',
               width : false},

            /**
             * Constructor: initialize Creates an instance of the Slideshow
             * class.
             * 
             * Arguments: element - (element) The wrapper element. data - (array
             * or object) The images and optional thumbnails, captions and links
             * for the show. options - (object) The options below.
             * 
             * Syntax: var myShow = new Slideshow(element, data, options);
             */

            initialize : function( el, data, options ) {
               this.setOptions( options );
               this.el = document.id( el );
               if( !this.el ) return;
               
               var match = window.location.href.match( this.options.match );
               this.slide = this._slide = this.options.match && match ? match[1].toInt() : this.options.slide;
               this.counter = this.timeToNextTransition = this.timeToTransitionComplete = 0;
               this.direction = 'left';
               this.cache = {};
               this.paused = false;
               if( !this.options.overlap ) this.options.duration *= 2;
               var anchor = this.el.getElement( 'a' ) || new Element( 'a' );
               if( !this.options.href ) this.options.href = anchor.get( 'href' ) || '';
               if( this.options.hu.length && !this.options.hu.test( /\/$/ ) ) this.options.hu += '/';
               if( this.options.fast === true ) this.options.fast = WhenPaused | WhenPlaying;

               // styles
               var keys = 'slideshow first prev play pause next last images captions controller thumbnails hidden visible inactive active loader'.split( ' ' );
               var values = keys.map( function( key, i ) {
                  return this.options.classes[i] || key;
               }, this );
               this.classes = values.associate( keys );
               this.classes.get = function() {
                  var str = '.' + this.slideshow;
                  for( var i = 0, l = arguments.length; i < l; i++ )
                     str += '-' + this[arguments[i]];
                  return str;
               }.bind( this.classes );

               // data
               if( !data ){
                  this.options.hu = '';
                  data = {};
                  var thumbnails = this.el.getElements( this.classes.get( 'thumbnails' ) + ' img' );
                  this.el.getElements( this.classes.get( 'images' ) + ' img' ).each( function( img, i ) {
                     var src = img.src, caption = img.alt || img.title, href = img.getParent().href, thumbnail = thumbnails[i] ? thumbnails[i].src : '';
                     data[src] = {
                        'caption' : caption,
                        'href' : href,
                        'thumbnail' : thumbnail};
                  } );
               }
               var loaded = this.load( data );
               if( !loaded )
                  return;

               // events
               this.events = {};
               this.events.push = function( type, fn ) {
                  if( !this[type] )
                     this[type] = [];
                  this[type].push( fn );
                  document.addEvent( type, fn );
                  return this;
               }.bind( this.events );

               this.accesskeys = {};
               for( action in this.options.accesskeys ){
                  var obj = this.options.accesskeys[action];
                  this.accesskeys[action] = accesskey = { 'label' : obj.label };
                  ['shift', 'control', 'alt'].each( function( modifier ) {
                     var re = new RegExp( modifier, 'i' );
                     accesskey[modifier] = obj.key.test( re );
                     obj.key = obj.key.replace( re, '' );
                  });
                  accesskey.key = obj.key.trim();
               }

               this.events.push( 'keyup', function( e ) {
                  Object.each( this.accesskeys, function( accesskey, action ) {
                     if( e.key == accesskey.key && e.shift == accesskey.shift && e.control == accesskey.control && e.alt == accesskey.alt )
                        this[action]();
                  }, this );
               }.bind( this ) );

               // required elements
               var el = this.el.getElement( this.classes.get( 'images' ) );
               var img = this.el.getElement( 'img' ) || new Element( 'img' );
               var images = el ? el.empty() : new Element( 'div', { 'class' : this.classes.get( 'images' ).substr( 1 ) }).inject( this.el );
               var div = images.getSize();
               this.height = this.options.height || div.y;
               this.width = this.options.width || div.x;
               images.set( { 'styles' : { 'height' : this.height, 'width' : this.width}} );
               this.el.store( 'images', images );
               this.a = this.image = img;
               if( Browser.ie && Browser.version >= 7 ) this.a.style.msInterpolationMode = 'bicubic';
               this.a.set( 'styles', { 'display' : 'none' });
               this.b = this.a.clone();
               [this.a, this.b].each( function( img ) {
                  anchor.clone().cloneEvents( anchor ).grab( img ).inject( images );
               });

               // optional elements
               this.options.captions && new Caption( this );
               this.options.controller && new Controller( this );
               this.options.loader && new Loader( this );
               this.options.thumbnails && new Thumbnails( this );

               // begin show
               this._preload( this.options.fast & OnStart );
            },

            /**
             * Public method: go Jump directly to a slide in the show.
             * 
             * Arguments: n - (integer) The index number of the image to jump
             * to, 0 being the first image in the show.
             * 
             * Syntax: myShow.go(n);
             */

            go : function( n, direction ) {
               var nextSlide = (this.slide + this.data.images.length) % this.data.images.length;
               if( n == nextSlide || Date.now() < this.timeToTransitionComplete )
                  return;
               clearTimeout( this.timer );
               this.timeToNextTransition = 0;
               this.direction = direction ? direction : n < this._slide ? 'right' : 'left';
               this.slide = this._slide = n;
               if( this.preloader )
                  this.preloader = this.preloader.destroy();
               this._preload( (this.options.fast & WhenPlaying) || (this.paused && this.options.fast & WhenPaused) );
            },

            /**
             * Public method: first Goes to the first image in the show.
             * 
             * Syntax: myShow.first();
             */

            first : function() {
               this.prev( true );
            },

            /**
             * Public method: prev Goes to the previous image in the show.
             * 
             * Syntax: myShow.prev();
             */

            prev : function( first ) {
               var n = 0;
               if( !first ){
                  if( this.options.random ){
                     if( this.showed.i < 2 )
                        return;
                     this.showed.i -= 2;
                     n = this.showed.array[this.showed.i];
                  }else
                     n = (this.slide - 1 + this.data.images.length) % this.data.images.length;
               }
               this.go( n, 'right' );
            },

            /**
             * Public method: pause Toggles play / pause state of the show.
             * 
             * Arguments: p - (undefined, 1 or 0) Call pause with no arguments
             * to toggle the pause state. Call pause(1) to force pause, or
             * pause(0) to force play.
             * 
             * Syntax: myShow.pause(p);
             */

            pause : function( p ) {
               if( p != undefined )
                  this.paused = p ? false : true;
               if( this.paused ){ // play
                  this.paused = false;
                  this.timeToTransitionComplete = Date.now() + this.timeToTransitionComplete;
                  this.timer = this._preload.delay( 50, this );
                  [this.a, this.b].each( function( img ) {
                     ['morph', 'tween'].each( function( p ) {
                        if( this.retrieve && this.retrieve( p ))
                           this.get( p ).resume();
                     }, img );
                  } );
                  
                  this.controller && this.el.retrieve( 'pause' ).getParent().removeClass( this.classes.play );
               }else{ // pause
                  this.paused = true;
                  this.timeToTransitionComplete = this.timeToTransitionComplete - Date.now();
                  clearTimeout( this.timer );
                  [this.a, this.b].each( function( img ) {
                     ['morph', 'tween'].each( function( p ) {
                        if( this.retrieve && this.retrieve( p ) )
                           this.get( p ).pause();
                     }, img );
                  });
                  
                  if( this.controller && this.el.retrieve && this.el.retrieve( 'pause' )){
                     var pauseValue = this.el.retrieve( 'pause' );
                     if( pauseValue.getParent() ) pauseValue.getParent().addClass( this.classes.play );
                  };
               }
            },

            /**
             * Public method: next Goes to the next image in the show.
             * 
             * Syntax: myShow.next();
             */

            next : function( last ) {
               var n = last ? this.data.images.length - 1 : this._slide;
               this.go( n, 'left' );
            },

            /**
             * Public method: last Goes to the last image in the show.
             * 
             * Syntax: myShow.last();
             */

            last : function() {
               this.next( true );
            },

            /**
             * Public method: load Loads a new data set into the show: will stop
             * the current show, rewind and rebuild thumbnails if applicable.
             * 
             * Arguments: data - (array or object) The images and optional
             * thumbnails, captions and links for the show.
             * 
             * Syntax: myShow.load(data);
             */

            load : function( data ) {
               this.firstrun = true;
               this.showed = { 'array' : [], 'i' : 0 };
               if( typeOf( data ) == 'array' ){
                  this.options.captions = false;
                  data = new Array( data.length ).associate( data.map( function( image, i ) {
                     return image + '?' + i
                  }));
               }
               this.data = {
                  'images' : [],
                  'captions' : [],
                  'hrefs' : [],
                  'thumbnails' : [],
                  'targets' : [],
                  'titles' : []};
               for( var image in data ){
                  var obj = data[image] || {}, image = this.options.hu + image, caption = obj.caption ? obj.caption.trim() : '', href = obj.href ? obj.href
                        .trim() : this.options.linked ? image : this.options.href, target = obj.target ? obj.target.trim() : '_self', thumbnail = obj.thumbnail ? this.options.hu
                        + obj.thumbnail.trim()
                        : image.replace( this.options.replace[0], this.options.replace[1] ), title = caption.replace( /<.+?>/gm, '' ).replace( /</g, '&lt;' )
                        .replace( />/g, '&gt;' ).replace( /"/g, "'" );
                  this.data.images.push( image );
                  this.data.captions.push( caption );
                  this.data.hrefs.push( href );
                  this.data.targets.push( target );
                  this.data.thumbnails.push( thumbnail );
                  this.data.titles.push( title );
               }
               if( this.options.random )
                  this.slide = this._slide = Number.random( 0, this.data.images.length - 1 );

               // only run when data is loaded dynamically into an existing
               // slideshow instance

               if( this.options.thumbnails && this.el.retrieve( 'thumbnails' ) )
                  this._thumbnails();
               if( this.el.retrieve( 'images' ) ){
                  [this.a, this.b].each( function( img ) {
                     ['morph', 'tween'].each( function( p ) {
                        if( this.retrieve( p ) )
                           this.get( p ).cancel();
                     }, img );
                  } );
                  this.slide = this._slide = this.timeToTransitionComplete = 0;
                  this.go( 0 );
               }
               return this.data.images.length;
            },

            /**
             * Public method: destroy Destroys a Slideshow instance.
             * 
             * Arguments: p - (string) The images and optional thumbnails,
             * captions and links for the show.
             * 
             * Syntax: myShow.destroy(p);
             */

            destroy : function( p ) {
               Object.each( this.events, function( array, e ) {
                  if( 'each' in array )
                     array.each( function( fn ) {
                        document.removeEvent( e, fn );
                     } );
               } );
               this.pause( 1 );
               'caption loader thumbnails'.split( ' ' ).each( function( i, timer ) {
                  this.options[i] && this[i].retrieve && (timer = this[i].retrieve( 'timer' )) && clearTimeout( timer );
               }, this );
               typeOf( this.el[p] ) == 'function' && this.el[p]();
               if( this.el.eliminate ) this.el.eliminate( 'uid' );
               if( this.preloader && this.preloader.removeEvents ) this.preloader.removeEvents();
               if( this.preloader && this.preloader.destroy ) this.preloader.destroy();
            },

            /**
             * Private method: preload Preloads the next slide in the show, once
             * loaded triggers the show, updates captions, thumbnails, etc.
             */
            _preload : function( fast ) {
               var src = this.data.images[this._slide].replace( /([^?]+).*/, '$1' );
               var cached = loaded = !!this.cache[src];
               if( !cached ){
                  if( !this.preloader )
                     this.preloader = new Asset.image( src, {
                        'onerror' : function() {
                           // do something
                        },
                        'onload' : function() {
                           this.store( 'loaded', true );
                        }} );
                  loaded = this.preloader.retrieve( 'loaded' ) && this.preloader.get( 'width' );
               }
               
               if( loaded && Date.now() > this.timeToNextTransition && Date.now() > this.timeToTransitionComplete ){
                  var src = this.data.images[this._slide].replace( /([^?]+).*/, '$1' );
                  if( this.preloader ){
                     this.cache[src] = {
                        'height' : this.preloader.get( 'height' ),
                        'src' : src,
                        'width' : this.preloader.get( 'width' )}
                  }
                  if( this.stopped ){
                     if( this.options.captions )
                        this.caption.get( 'morph' ).cancel().start( this.classes.get( 'captions', 'hidden' ) );
                     this.pause( 1 );
                     if( this.end )
                        this.fireEvent( 'end' );
                     this.stopped = this.end = false;
                     return;
                  }
                  this.image = this.counter % 2 ? this.b : this.a;
                  this.image.set( 'styles', {
                     'display' : 'block',
                     'height' : null,
                     'visibility' : 'hidden',
                     'width' : null,
                     'zIndex' : this.counter} );
                  this.image.set( this.cache[src] );
                  this.image.width = this.cache[src].width;
                  this.image.height = this.cache[src].height;
                  this.options.resize && this._resize( this.image );
                  this.options.center && this._center( this.image );
                  var anchor = this.image.getParent();
                  if( this.data.hrefs[this._slide] ){
                     anchor.set( 'href', this.data.hrefs[this._slide] );
                     anchor.set( 'target', this.data.targets[this._slide] );
                  }else{
                     anchor.erase( 'href' );
                     anchor.erase( 'target' );
                  }
                  var title = this.data.titles[this._slide];
                  this.image.set( 'alt', title );
                  this.options.titles && anchor.set( 'title', title );
                  this.options.loader && this.loader.fireEvent( 'hide' );
                  this.options.captions && this.caption.fireEvent( 'update', fast );
                  this.options.thumbnails && this.thumbnails.fireEvent( 'update', fast );
                  this._show( fast );
                  this._loaded( fast );
               }else{
                  if( Date.now() > this.timeToNextTransition && this.options.loader ){
                     this.loader.fireEvent( 'show' );
                  }
                  this.timer = this._preload.delay( 50, this, fast );
               }
            },

            /**
             * Private method: show Does the slideshow effect.
             */
            _show : function( fast ) {
               if( !this.image.retrieve( 'morph' ) ){
                  var options = this.options.overlap ? {
                     'link' : 'cancel'} : {
                     'link' : 'chain'};
                  $$( this.a, this.b ).set( 'morph', Object.merge( options, {
                     'duration' : this.options.duration,
                     'onStart' : this._start.bind( this ),
                     'onComplete' : this._complete.bind( this ),
                     'transition' : this.options.transition} ) );
               }
               var hidden = this.classes.get( 'images', (this.direction == 'left' ? 'next' : 'prev') ), visible = this.classes.get( 'images', 'visible' ), img = this.counter % 2 ? this.a
                     : this.b;
               if( fast ){
                  img.get( 'morph' ).cancel().set( hidden );
                  this.image.get( 'morph' ).cancel().set( visible );
               }else{
                  if( this.options.overlap ){
                     img.get( 'morph' ).set( visible );
                     this.image.get( 'morph' ).set( hidden ).start( visible );
                  }else{
                     var fn = function( visible ) {
                        this.image.get( 'morph' ).start( visible );
                     }.pass( visible, this );
                     if( this.firstrun )
                        return fn();
                     hidden = this.classes.get( 'images', (this.direction == 'left' ? 'prev' : 'next') );
                     this.image.get( 'morph' ).set( hidden );
                     img.get( 'morph' ).set( visible ).start( hidden ).chain( fn );
                  }
               }
               
               this.fireEvent( 'show' );
            },

            /**
             * Private method: loaded Run after the current image has been
             * loaded, sets up the next image to be shown.
             */

            _loaded : function( fast ) {
               this.counter++;
               this.timeToNextTransition = Date.now() + this.options.duration + this.options.delay;
               this.direction = 'left';
               this.timeToTransitionComplete = fast ? 0 : Date.now() + this.options.duration;
               if( this._slide == (this.data.images.length - 1) && !this.options.loop && !this.options.random )
                  this.stopped = this.end = true;
               if( this.options.random ){
                  this.showed.i++;
                  if( this.showed.i >= this.showed.array.length ){
                     var n = this._slide;
                     if( this.showed.array.getLast() != n )
                        this.showed.array.push( n );
                     while( this._slide == n )
                        this.slide = this._slide = Number.random( 0, this.data.images.length - 1 );
                  }else
                     this.slide = this._slide = this.showed.array[this.showed.i];
               }else{
                  this.slide = this._slide;
                  this._slide = (this.slide + 1) % this.data.images.length;
               }
               if( this.image.getStyle( 'visibility' ) != 'visible' )
                  (function() {
                     this.image.setStyle( 'visibility', 'visible' );
                  }).delay( 1, this );
               if( this.preloader )
                  this.preloader = this.preloader.destroy();
               this.paused || this._preload();
            },

            /**
             * Private method: center Center an image.
             */

            _center : function( img ) {
               var size = img.getSize(), h = size.y, w = size.x;
               img.set( 'styles', {
                  'left' : (w - this.width) / -2,
                  'top' : (h - this.height) / -2} );
            },

            /**
             * Private method: resize Resizes an image.
             */

            _resize : function( img ) {
               var h = img.get( 'height' ).toFloat(), w = img.get( 'width' ).toFloat(), dh = this.height / h, dw = this.width / w;
               if( this.options.resize == 'fit' )
                  dh = dw = dh > dw ? dw : dh;
               if( this.options.resize == 'fill' )
                  dh = dw = dh > dw ? dh : dw;
               img.set( 'styles', {
                  'height' : Math.ceil( h * dh ),
                  'width' : Math.ceil( w * dw )} );
            },

            /**
             * Private method: start Callback on start of slide change.
             */

            _start : function() {
               this.fireEvent( 'start' );
            },

            /**
             * Private method: complete Callback on start of slide change.
             */

            _complete : function() {
               if( this.firstrun && this.options.paused ) this.pause( 1 );
               this.firstrun = false;
               this.fireEvent( 'complete', [], 10 );
            }} );

   /**
    * Private method: captions Builds the optional caption element, adds
    * interactivity. This method can safely be removed if the captions option is
    * not enabled.
    */

   var Caption = new Class( {
      Implements : [Chain, Events, Options],

      options : {/*
                   * duration: 500, fps: 50, transition: 'sine:in:out', unit:
                   * false,
                   */
         delay : 0,
         link : 'cancel'},

      initialize : function( slideshow ) {
         if( !slideshow )
            return;
         var options = slideshow.options.captions;
         if( options === true )
            options = {};
         this.setOptions( options );
         var el = slideshow.el.getElement( slideshow.classes.get( 'captions' ) ), caption = el ? el.dispose().empty() : new Element( 'div', {
            'class' : slideshow.classes.get( 'captions' ).substr( 1 )} );
         slideshow.caption = caption;
         caption.set( {
            'aria-busy' : false,
            'aria-hidden' : false,
            'events' : {
               'update' : this.update.bind( slideshow )},
            'morph' : this.options,
            'role' : 'description'} ).store( 'delay', this.options.delay );
         if( !caption.get( 'id' ) )
            caption.set( 'id', 'Slideshow-' + Date.now() );
         slideshow.el.retrieve( 'images' ).set( 'aria-labelledby', caption.get( 'id' ) );
         caption.inject( slideshow.el );
      },

      update : function( fast ) {
         var empty = !this.data.captions[this._slide].length, timer;
         if( timer = this.caption.retrieve( 'timer' ) )
            clearTimeout( timer );
         if( fast ){
            var p = empty ? 'hidden' : 'visible';
            this.caption.set( {
               'aria-hidden' : empty,
               'html' : this.data.captions[this._slide]} ).get( 'morph' ).cancel().set( this.classes.get( 'captions', p ) );
         }else{
            var fn1 = empty ? function() {
            } : function( caption ) {
               this.caption.store( 'timer', setTimeout( function( caption ) {
                  this.caption.set( 'html', caption ).morph( this.classes.get( 'captions', 'visible' ) );
               }.pass( caption, this ), this.caption.retrieve( 'delay' ) ) );
            }.pass( this.data.captions[this._slide], this );
            var fn2 = function() {
               this.caption.set( 'aria-busy', false );
            }.bind( this );
            this.caption.set( 'aria-busy', true ).get( 'morph' ).cancel().start( this.classes.get( 'captions', 'hidden' ) ).chain( fn1, fn2 );
         }
      }} );

   /**
    * Private method: controller Builds the optional controller element, adds
    * interactivity. This method can safely be removed if the controller option
    * is not enabled.
    */

   var Controller = new Class(
         {
            Implements : [Chain, Events, Options],

            options : {/*
                         * duration: 500, fps: 50, transition: 'sine:in:out',
                         * unit: false,
                         */
               link : 'cancel'},

            initialize : function( slideshow ) {
               if( !slideshow )
                  return;
               var options = slideshow.options.captions;
               if( options === true )
                  options = {};
               this.setOptions( options );
               var el = slideshow.el.getElement( slideshow.classes.get( 'controller' ) ), controller = el ? el.dispose().empty() : new Element( 'div', {
                  'class' : slideshow.classes.get( 'controller' ).substr( 1 )} );
               slideshow.controller = controller;
               controller.set( {
                  'aria-hidden' : false,
                  'role' : 'menubar'} );
               var ul = new Element( 'ul', {
                  'role' : 'menu'} ).inject( controller ), i = 0;
               Object.each( slideshow.accesskeys, function( accesskey, action ) {
                  var li = new Element( 'li', {
                     'class' : (action == 'pause' && this.options.paused) ? this.classes.play + ' ' + this.classes[action] : this.classes[action]} )
                        .inject( ul );
                  var a = this.el.retrieve( action, new Element( 'a', {
                     'role' : 'menuitem',
                     'tabindex' : i++,
                     'title' : accesskey.label} ).inject( li ) );
                  a.set( 'events', {
                     'click' : function( action ) {
                        this[action]()
                     }.pass( action, this ),
                     'mouseenter' : function( active ) {
                        this.addClass( active )
                     }.pass( this.classes.active, a ),
                     'mouseleave' : function( active ) {
                        this.removeClass( active )
                     }.pass( this.classes.active, a )} );
               }, slideshow );
               controller.set( {
                  'events' : {
                     'hide' : this.hide.pass( slideshow.classes.get( 'controller', 'hidden' ), controller ),
                     'show' : this.show.pass( slideshow.classes.get( 'controller', 'visible' ), controller )},
                  'morph' : this.options} ).store( 'hidden', false );
               slideshow.events.push( 'keydown', this.keydown.bind( slideshow ) ).push( 'keyup', this.keyup.bind( slideshow ) ).push( 'mousemove',
                     this.mousemove.bind( slideshow ) );
               controller.inject( slideshow.el ).fireEvent( 'hide' );
            },

            hide : function( hidden ) {
               if( this.get( 'aria-hidden' ) == 'false' )
                  this.set( 'aria-hidden', true ).morph( hidden );
            },

            keydown : function( e ) {
               Object.each( this.accesskeys, function( accesskey, action ) {
                  if( e.key == accesskey.key && e.shift == accesskey.shift && e.control == accesskey.control && e.alt == accesskey.alt ){
                     if( this.controller.get( 'aria-hidden' ) == 'true' )
                        this.controller.get( 'morph' ).set( this.classes.get( 'controller', 'visible' ) );
                     this.el.retrieve( action ).fireEvent( 'mouseenter' );
                  }
               }, this );
            },

            keyup : function( e ) {
               Object.each( this.accesskeys, function( accesskey, action ) {
                  if( e.key == accesskey.key && e.shift == accesskey.shift && e.control == accesskey.control && e.alt == accesskey.alt ){
                     if( this.controller.get( 'aria-hidden' ) == 'true' )
                        this.controller.set( 'aria-hidden', false ).fireEvent( 'hide' );
                     this.el.retrieve( action ).fireEvent( 'mouseleave' );
                  }
               }, this );
            },

            mousemove : function( e ) {
               var images = this.el.retrieve( 'images' ).getCoordinates(), action = (e.page.x > images.left && e.page.x < images.right && e.page.y > images.top && e.page.y < images.bottom) ? 'show'
                     : 'hide';
               this.controller.fireEvent( action );
            },

            show : function( visible ) {
               if( this.get( 'aria-hidden' ) == 'true' )
                  this.set( 'aria-hidden', false ).morph( visible );
            }} );

   /**
    * Private method: loader Builds the optional loader element, adds
    * interactivity. This method can safely be removed if the loader option is
    * not enabled.
    */

   var Loader = new Class( {
      Implements : [Chain, Events, Options],

      options : {/*
                   * duration: 500, transition: 'sine:in:out', unit: false,
                   */
         fps : 20,
         link : 'cancel'},

      initialize : function( slideshow ) {
         if( !slideshow )
            return;
         var options = slideshow.options.loader;
         if( options === true )
            options = {};
         this.setOptions( options );
         var loader = new Element( 'div', {
            'aria-hidden' : false,
            'class' : slideshow.classes.get( 'loader' ).substr( 1 ),
            'morph' : this.options,
            'role' : 'progressbar'} ).store( 'animate', false ).store( 'i', 0 ).store( 'delay', 1000 / this.options.fps ).inject( slideshow.el );
         slideshow.loader = loader;
         var url = loader.getStyle( 'backgroundImage' ).replace( /url\(['"]?(.*?)['"]?\)/, '$1' ).trim();
         if( url ){
            if( url.test( /\.png$/ ) && Browser.ie && Browser.version < 7 )
               loader.setStyles( {
                  'backgroundImage' : 'none',
                  'filter' : 'progid:DXImageTransform.Microsoft.AlphaImageLoader(src="' + url + '", sizingMethod="crop")'} );
            new Asset.image( url, {
               'onload' : function() {
                  var size = loader.getSize(), width = this.get( 'width' ), height = this.get( 'height' );
                  if( width > size.x )
                     loader.store( 'x', size.x ).store( 'animate', 'x' ).store( 'frames', (width / size.x).toInt() );
                  if( height > size.y )
                     loader.store( 'y', size.y ).store( 'animate', 'y' ).store( 'frames', (height / size.y).toInt() );
               }} );
         }
         loader.set( 'events', {
            'animate' : this.animate.bind( loader ),
            'hide' : this.hide.pass( slideshow.classes.get( 'loader', 'hidden' ), loader ),
            'show' : this.show.pass( slideshow.classes.get( 'loader', 'visible' ), loader )} );
         loader.fireEvent( 'hide' );
      },

      animate : function() {
         var animate = this.retrieve( 'animate' );
         if( !animate )
            return;
         var i = (this.retrieve( 'i' ).toInt() + 1) % this.retrieve( 'frames' );
         this.store( 'i', i );
         var n = (i * this.retrieve( animate )) + 'px';
         if( animate == 'x' )
            this.setStyle( 'backgroundPosition', n + ' 0px' );
         if( animate == 'y' )
            this.setStyle( 'backgroundPosition', '0px ' + n );
      },

      hide : function( hidden ) {
         if( this.get( 'aria-hidden' ) == 'false' ){
            this.set( 'aria-hidden', true ).morph( hidden );
            if( this.retrieve( 'animate' ) )
               clearTimeout( this.retrieve( 'timer' ) );
         }
      },

      show : function( visible ) {
         if( this.get( 'aria-hidden' ) == 'true' ){
            this.set( 'aria-hidden', false ).morph( visible );
            if( this.retrieve( 'animate' ) ){
               this.store( 'timer', function() {
                  this.fireEvent( 'animate' )
               }.periodical( this.retrieve( 'delay' ), this ) );
            }
         }
      }} );

   /**
    * Private method: thumbnails Builds the optional thumbnails element, adds
    * interactivity. This method can safely be removed if the thumbnails option
    * is not enabled.
    */

   var Thumbnails = new Class({
      Implements : [Chain, Events, Options],
      options : { /* duration: 500, transition: 'sine:in:out', unit: false, */
         columns : null,
         fps : 50,
         link : 'cancel',
         position : null,
         rows : null,
         scroll : null
      },

      initialize : function( slideshow ) {
         var options = (slideshow.options.thumbnails === true) ? {} : slideshow.options.thumbnails;
         this.setOptions( options );
         var el = slideshow.el.getElement( slideshow.classes.get( 'thumbnails' ) );
         var thumbnails = el ? el.empty() : new Element( 'div', { 'class' : slideshow.classes.get( 'thumbnails' ).substr( 1 )} );
         slideshow.thumbnails = thumbnails;
         thumbnails.set({ 'role' : 'menubar', 'styles' : { 'overflow' : 'hidden' } });
         var uid = thumbnails.retrieve( 'uid', 'Slideshow-' + Date.now() );
         var ul = new Element( 'ul', {
            'role' : 'menu',
            'styles' : {
               'left' : 0,
               'position' : 'absolute',
               'top' : 0 
            },
            'tween' : { 'link' : 'cancel' }
         }).inject( thumbnails );
         
         slideshow.data.thumbnails.each( function( thumbnail, i ) {
            var li = new Element( 'li', { 'id' : uid + i } ).inject( ul );
            var a = new Element( 'a', {
               'class' : slideshow.classes.get( 'thumbnails', 'hidden' ).substr( 1 ),
               'events' : { 'click' : this.click.pass( i, slideshow ) },
               'href' : slideshow.data.images[i],
               'morph' : this.options,
               'role' : 'menuitem',
               'tabindex' : i
            }).store( 'uid', i ).inject( li );
                  
            if( slideshow.options.titles )
               a.set( 'title', slideshow.data.titles[i] );
            new Asset.image( thumbnail, { 'onload' : this.onload.pass( i, slideshow ) } ).inject( a );
         }, this );
         
         thumbnails.set( 'events', {
            'scroll' : this.scroll.bind( thumbnails ),
            'update' : this.update.bind( slideshow )
         });

         var coords = thumbnails.getCoordinates();
         if( !options.scroll ) options.scroll = (coords.height > coords.width) ? 'y' : 'x';
         var props = (options.scroll == 'y') ? 'top bottom height y width'.split( ' ' ) : 'left right width x height'.split( ' ' );
         thumbnails.store( 'props', props );
         thumbnails.store( 'delay', 1000 / this.options.fps );
         slideshow.events.push( 'mousemove', this.mousemove.bind( thumbnails ) );
         thumbnails.inject( slideshow.el );
      },

      click : function( i ) {
         this.go( i );
         return false;
      },

      mousemove : function( e ) {
         var coords = this.getCoordinates();
         if( e.page.x > coords.left && e.page.x < coords.right && e.page.y > coords.top && e.page.y < coords.bottom ){
            this.store( 'page', e.page );
            if( !this.retrieve( 'mouseover' ) ){
               this.store( 'mouseover', true );
               this.store( 'timer', function() {
                  this.fireEvent( 'scroll' );
               }.periodical( this.retrieve( 'delay' ), this ) );
            }
            }else{
               if( this.retrieve( 'mouseover' ) ){
                  this.store( 'mouseover', false );
                  clearTimeout( this.retrieve( 'timer' ) );
               }
            }
         },

      onload : function( i ) {
         var thumbnails = this.thumbnails;
         var a = thumbnails.getElements( 'a' )[i];
         if( a ){
            (function( a ) {
               var visible = i == this.slide ? 'active' : 'inactive';
               if( a.store ){
                  a.store( 'loaded', true );
                  var morphProperty = a.get( 'morph' );
                  morphProperty.set( this.classes.get( 'thumbnails', 'hidden' ));
                  morphProperty.start( this.classes.get( 'thumbnails', visible ));
                  
               }
            }).delay( Math.max( 1000 / this.data.thumbnails.length, 100 ), this, a );
         }

         if( thumbnails.retrieve( 'limit' ) ) return;
               
         var props = thumbnails.retrieve( 'props' );    //left right width x height
         var options = this.options.thumbnails;
         var pos = props ? props[1] : 'right';
         var length = props[2];
         var width = props[4];
         var li = thumbnails.getElement( 'li:nth-child(' + (i + 1) + ')' ).getCoordinates();

         if( options.columns || options.rows ){
            thumbnails.setStyles( {
               'height' : this.height,
               'width' : this.width
            });
            if( options.columns.toInt() ) thumbnails.setStyle( 'width', li.width * options.columns.toInt() );
            if( options.rows.toInt() ) thumbnails.setStyle( 'height', li.height * options.rows.toInt() );
         }
         var div = thumbnails.getCoordinates();
         if( options.position ){
            if( options.position.test( /bottom|top/ ) ){
               thumbnails.setStyles({
                  'bottom' : 'auto',
                  'top' : 'auto' 
               }).setStyle( options.position, -div.height );
            }
            if( options.position.test( /left|right/ ) ){
               thumbnails.setStyles({
                  'left' : 'auto',
                  'right' : 'auto'
               }).setStyle( options.position, -div.width );
            }
         }
         
         var units = div[width] >= li[width] ? Math.floor( div[width] / li[width] ) : 1;
         var x = Math.ceil( this.data.images.length / units );
         var r = this.data.images.length % units;
         var len = x * li[length], ul = thumbnails.getElement( 'ul' ).setStyle( length, len );
         ul.getElements( 'li' ).setStyles({
            'height' : li.height,
            'width' : li.width
         });
         thumbnails.store( 'limit', div[length] - len );
      },

      scroll : function( n, fast ) {
         var div = this.getCoordinates();
         var ul = this.getElement( 'ul' ).getPosition();
         var props = this.retrieve( 'props' );
         var axis = props[3];
         var delta;
         var pos = props[0];
         var size = props[2];
         var value;
         var tween = this.getElement( 'ul' ).set( 'tween', { 'property' : pos } ).get( 'tween' );
         if( n != undefined ){
            var uid = this.retrieve( 'uid' ), li = document.id( uid + n ).getCoordinates();
            delta = div[pos] + (div[size] / 2) - (li[size] / 2) - li[pos];
            value = (ul[axis] - div[pos] + delta).limit( this.retrieve( 'limit' ), 0 );
            tween[fast ? 'set' : 'start']( value );
         } else{
            var area = div[props[2]] / 3, page = this.retrieve( 'page' ), velocity = -(this.retrieve( 'delay' ) * 0.01);
            if( page[axis] < (div[pos] + area) ) delta = (page[axis] - div[pos] - area) * velocity;
            else if( page[axis] > (div[pos] + div[size] - area) ) delta = (page[axis] - div[pos] - div[size] + area) * velocity;
            if( delta ){
               value = (ul[axis] - div[pos] + delta).limit( this.retrieve( 'limit' ), 0 );
               tween.set( value );
            }
         }
      },

      update : function( fast ) {
         var thumbnails = this.thumbnails;
         var uid = thumbnails.retrieve( 'uid' );
         thumbnails.getElements( 'a' ).each( function( a, i ) {
            if( a.retrieve( 'loaded' ) ){
               if( a.retrieve( 'uid' ) == this._slide ){
                  if( !a.retrieve( 'active', false ) ){
                     a.store( 'active', true );
                     var active = this.classes.get( 'thumbnails', 'active' );
                     if( fast ) a.get( 'morph' ).set( active );
                     else a.morph( active );
                  }
               }else{
                  if( a.retrieve( 'active', true ) ){
                     a.store( 'active', false );
                     var inactive = this.classes.get( 'thumbnails', 'inactive' );
                     if( fast ) a.get( 'morph' ).set( inactive );
                     else a.morph( inactive );
                  }
               }
            }
         }, this );
         
         if( !thumbnails.retrieve( 'mouseover' ) ) thumbnails.fireEvent( 'scroll', [this._slide, fast] );
      }
   });
})();
/**
Script: Slideshow.Flash.js
	Slideshow.Flash - Flash extension for Slideshow.

License:
	MIT-style license.

Copyright:
	Copyright (c) 2008 [Aeron Glemann](http://www.electricprism.com/aeron/).

Dependencies:
	Slideshow.
*/





(function(){
	Slideshow.Flash = new Class({
		Extends: Slideshow,
	
		options: {
			color: ['#FFF']
		},
	
	/**
	Constructor: initialize
		Creates an instance of the Slideshow class.

	Arguments:
		element - (element) The wrapper element.
		data - (array or object) The images and optional thumbnails, captions and links for the show.
		options - (object) The options below.

	Syntax:
		var myShow = new Slideshow.Flash(element, data, options);
*/

		initialize: function(el, data, options){
			options = options || {};
			options.overlap = true;
			if (options.color)
				options.color = Array.from(options.color);
			this.parent(el, data, options);
		},

	/**
	Private method: show
		Does the slideshow effect.
*/

		_show: function(fast){
			if (!this.image.retrieve('tween'))
			  $$(this.a, this.b).set('tween', {'duration': this.options.duration, 'link': 'cancel', 'onStart': this._start.bind(this), 'onComplete': this._complete.bind(this), 'property': 'opacity'});
			if (fast)
				this.image.get('tween').cancel().set(1);
			else {
				this.el.retrieve('images').setStyle('background', this.options.color[this.slide % this.options.color.length]);
				var img = (this.counter % 2) ? this.a : this.b;
				img.get('tween').cancel().set(0);
				this.image.get('tween').set(0).start(1);
			}
		}
	});
})();
/**
Script: Slideshow.Fold.js
	Slideshow.Fold - Flash extension for Slideshow.

License:
	MIT-style license.

Copyright:
	Copyright (c) 2008 [Aeron Glemann](http://www.electricprism.com/aeron/).

Dependencies:
	Slideshow.
*/





Slideshow.Fold = new Class({
	Extends: Slideshow,
	
/**
Private method: show
	Does the slideshow effect.
*/

	_show: function(fast){
		if (!this.image.retrieve('tween')){
			var options = (this.options.overlap) ? {'duration': this.options.duration} : {'duration': this.options.duration / 2};
			$$(this.a, this.b).set('tween', Object.merge(options, {'link': 'chain', 'onStart': this._start.bind(this), 'onComplete': this._complete.bind(this), 'property': 'clip', 'transition': this.options.transition}));
		}
		var img = (this.counter % 2) ? this.a : this.b,
			rect = this._rect(this.image),
			half = Math.ceil(rect.top + (rect.bottom - rect.top) / 2);
			
		if (fast){			
			img.get('tween').cancel().set('rect(0, 0, 0, 0)');
			this.image.get('tween').cancel().set('rect(auto, auto, auto, auto)'); 			
		} 
		else {
			if (this.options.overlap){	
				img.get('tween').set('rect(auto, auto, auto, auto)');
				this.image.get('tween')
					.set(rect.top + ' ' + rect.left + ' ' + half + ' ' + rect.left)
					.start(rect.top + ' ' + rect.right + ' ' + half + ' ' + rect.left)
					.start(rect.top + ' ' + rect.right + ' ' + rect.bottom + ' ' + rect.left);
			} 
			else	{
				var fn = function(rect){
					this.image.get('tween')
						.set(rect.top + ' ' + rect.left + ' ' + half + ' ' + rect.left)
						.start(rect.top + ' ' + rect.right + ' ' + half + ' ' + rect.left)
						.start(rect.top + ' ' + rect.right + ' ' + rect.bottom + ' ' + rect.left);
				}.pass(rect, this);
				if (this.firstrun)
					return fn();
				rect = this._rect(img);
				img.get('tween')
					.set(rect.top + ' ' + rect.right + ' ' + rect.bottom + ' ' + rect.left)
					.start(rect.top + ' ' + rect.right + ' ' + half + ' ' + rect.left)
					.start(rect.top + ' ' + rect.left + ' ' + half + ' ' + rect.left).chain(fn);
			}
		}
	},
	
	/**
	Private method: rect
		Calculates the clipping rect
	*/

	_rect: function(img){
		var rect = img.getCoordinates(this.el.retrieve('images'));
		rect.left = (rect.left < 0) ? Math.abs(rect.left) : 0;
		rect.top = (rect.top < 0) ? Math.abs(rect.top) : 0;
		rect.right = (rect.right > this.width) ? rect.left + this.width : rect.width;
		rect.bottom = (rect.bottom > this.height) ? rect.top + this.height : rect.height;
		return rect;		
	}
});
/**
Script: Slideshow.KenBurns.js
	Slideshow.KenBurns - KenBurns extension for Slideshow, includes zooming and panning effects.

License:
	MIT-style license.

Copyright:
	Copyright (c) 2008 [Aeron Glemann](http://www.electricprism.com/aeron/).
	
Dependencies:
	Slideshow.
*/





(function(){
	Slideshow.KenBurns = new Class({
		Extends: Slideshow,

		options: {
			pan: [100, 100],
			zoom: [50, 50]
		},

	/**
	Constructor: initialize
		Creates an instance of the Slideshow class.

	Arguments:
		element - (element) The wrapper element.
		data - (array or object) The images and optional thumbnails, captions and links for the show.
		options - (object) The options below.

	Syntax:
		var myShow = new Slideshow.KenBurns(element, data, options);
	*/

		initialize: function(el, data, options){
			options = options || {};
			options.overlap = true;
			options.resize = 'fill';
			['pan', 'zoom'].each(function(p){
				if (this[p] != undefined){
					if (typeOf(this[p]) != 'array') this[p] = [this[p], this[p]];
					this[p].map(function(n){return (n.toInt() || 0).limit(0, 100);});					
				}
			}, options);
			this.parent(el, data, options);
		},

	/**
	Private method: show
		Does the slideshow effect.
	*/

		_show: function(fast){
			if (!this.image.retrieve('morph')){
				$$(this.a, this.b).set({
					'tween': {'duration': this.options.duration, 'link': 'cancel', 'onStart': this._start.bind(this), 'onComplete': this._complete.bind(this), 'property': 'opacity'},
					'morph': {'duration': (this.options.delay + this.options.duration * 2), 'link': 'cancel', 'transition': 'linear'}
				});
			}
			this.image.set('styles', {'bottom': 'auto', 'left': 'auto', 'right': 'auto', 'top': 'auto'});
			var props = ['top left', 'top right', 'bottom left', 'bottom right'][this.counter % 4].split(' ');
			this.image.setStyles([0, 0].associate(props));
			var src = this.data.images[this._slide].replace(/([^?]+).*/, '$1'),
				cache = this.cache[src];
			dh = this.height / cache.height;
			dw = this.width / cache.width;
			delta = (dw > dh) ? dw : dh;
			var values = {},
				zoom = (Number.random.apply(Number, this.options.zoom) / 100.0) + 1,
				pan = Math.abs((Number.random.apply(Number, this.options.pan) / 100.0) - 1);
			['height', 'width'].each(function(prop, i){
				var e = Math.ceil(cache[prop] * delta),
					s = (e * zoom).toInt();		
				values[prop] = [s, e];
				if (dw > dh || i){
					e = (this[prop] - this.image[prop]);
					s = (e * pan).toInt();			
					values[props[i]] = [s, e];
				}
			}, this);
			var paused = ((this.firstrun && this.options.paused) || this.paused);
			if (fast || paused){
				this._center(this.image);
				this.image.get('morph').cancel();
				if (paused)
					this.image.get('tween').cancel().set(0).start(1);
				else
					this.image.get('tween').cancel().set(1);
			} 
			else{
				this.image.get('morph').start(values);
				this.image.get('tween').set(0).start(1);
			}
		}
	});
})();
/*
Script: Slideshow.Push.js
	Slideshow.Push - Push extension for Slideshow.

License:
	MIT-style license.

Copyright:
	Copyright (c) 2008 [Aeron Glemann](http://www.electricprism.com/aeron/).
	
Dependencies:
	Slideshow.
	Mootools 1.3.1 More: Fx.Elements.
*/





Slideshow.Push = new Class({
	Extends: Slideshow,
	
	initialize: function(el, data, options){
		options = options || {};
		options.overlap = true;		
		this.parent(el, data, options);
	},

	_show: function(fast){
		var images = [this.image, ((this.counter % 2) ? this.a : this.b)];
		if (!this.image.retrieve('fx'))
			this.image.store('fx', new Fx.Elements(images, {'duration': this.options.duration, 'link': 'cancel', 'onStart': this._start.bind(this), 'onComplete': this._complete.bind(this), 'transition': this.options.transition }));
		this.image.set('styles', {'left': 'auto', 'right': 'auto' }).setStyle(this.direction, this.width);
		var values = {'0': {}, '1': {} };
		values['0'][this.direction] = [this.width, 0];
		values['1'][this.direction] = [0, -this.width];
		if (images[1].getStyle(this.direction) == 'auto'){
			var width = this.width - images[1].width;	
			images[1].set('styles', {'left': 'auto', 'right': 'auto' }).setStyle(this.direction, width);		 
			values['1'][this.direction] = [width, -this.width];
		}
		if (fast){
		 	for (var prop in values)
		 		values[prop][this.direction] = values[prop][this.direction][1];			
			this.image.retrieve('fx').cancel().set(values);
		} 
		else
			this.image.retrieve('fx').start(values);
	}
});
/*
Name: DocumentElement

Description: Represents a constituent element of a Smart Document. This is an abstract class, specialized elements can be instantiated.

Requires:

Provides:
    - DocumentElement

Part of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. 
http://www.processpuzzle.com

Authors: 
    - Zsolt Zsuffa

Copyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the 
GNU General Public License as published by the Free Software Foundation, either version 3 of the License, 
or (at your option) any later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/




var DocumentElement = new Class({
   Implements: [Events, Options, TimeOutBehaviour],
   Binds: ['associateEditor', 'authorization', 'checkTimeOut', 'createHtmlElement', 'constructPlugin', 'finalizeConstruction', 'injectHtmlElement', 'onPluginConstructed', 'onPluginError'],   
   
   options: {
      componentName : "DocumentElement",
      defaultTag : "div",
      eventFireDelay : 2,
      idPrefix : "Desktop-Element-",
      idSelector : "@id",
      isEditable : false,
      isEditableSelector : "@isEditable",
      pluginSelector : "plugin",
      referenceSelector : "@href",
      sourceSelector : "@source",
      styleSelector : "@elementStyle",
      tagSelector : "@tag"
   },
   
   //Constructor
   initialize: function( definitionElement, bundle, options ){
      assertThat( definitionElement, not( nil() ));
      assertThat( bundle, not( nil() ));
      this.setOptions( options );

      //Protected, private variables
      this.definitionElement = definitionElement;
      this.resourceUri = null;
      
      this.constructionChain = new Chain();
      this.contextElement;
      this.editable;
      this.editor;
      this.elementFactory;
      this.error = null;
      this.htmlElement;
      this.id;
      this.logger = WebUILogger ? Class.getInstanceOf( WebUILogger ) : null;
      this.plugin;
      this.reference;
      this.resourceBundle = bundle;
      this.source;
      this.status = DocumentElement.States.INITIALIZED;
      this.style;
      this.tag;
      this.text;
      this.where;      
   },
   
   //Public mutators and accessor methods
   construct: function( contextElement, where ){
      if( this.status != DocumentElement.States.UNMARSHALLED ) 
         throw new UnconfiguredDocumentElementException( 'destroy', 'initialized' );
      this.logger.trace( this.options.componentName + ".construct() of '" + this.id + "'started." );
      assertThat( contextElement, not( nil() ));
      this.contextElement = contextElement;
      this.where = where;
      this.elementFactory = new WidgetElementFactory( contextElement, this.resourceBundle );
      this.startTimeOutTimer( 'construct' );
      this.compileConstructionChain();
      this.constructionChain.callChain();
   },
   
   destroy: function(){
      if( this.status == DocumentElement.States.INITIALIZED ) throw new UnconfiguredDocumentElementException( 'destroy', 'initialized' );

      if( this.plugin ) this.plugin.destroy();
      if( this.status == DocumentElement.States.CONSTRUCTED ) this.deleteHtmlElement();
      if( this.status <= DocumentElement.States.CONSTRUCTED )this.resetProperties();
      if( this.editor ) this.editor.detach();
      this.error = null;
      this.status = DocumentElement.States.INITIALIZED;
   },
   
   onPluginConstructed: function(){
      this.constructionChain.callChain();
   },
   
   onPluginError: function( exception ){
      this.error = exception;
      this.revertConstruction();
   },
   
   unmarshall: function(){
      this.unmarshallProperties();
      this.unmarshallPlugin();
      this.status = DocumentElement.States.UNMARSHALLED;
   },

   //Properties
   getDefinitionElement: function() { return this.definitionElement; },
   getBind: function() { return this.bind; },
   getEditor: function() { return this.editor; },
   getHtmlElement: function() { return this.htmlElement; },
   getId: function() { return this.id; },
   getPlugin: function() { return this.plugin; },
   getReference: function() { return this.reference; },
   getResourceBundle: function() { return this.resourceBundle; },
   getSource: function(){ return this.source; },
   getState: function() { return this.status; },
   getStyle: function() { return this.style; },
   getTag: function() { return this.tag; },
   getText: function() { return this.text; },
   getResourceType: function() { return this.options.type; },
   getResourceUri: function() { return resourceUri; },
   isEditable: function() { return this.editable ? this.editable : this.options.isEditable; },
   isSuccess: function() { return this.error == null; },
   
   //Protected, private helper methods
   associateEditor: function(){
      if( this.isEditable() ){
         this.editor = DocumentElementEditorFactory.create( this, {} );
         this.editor.attach();
      }
      this.constructionChain.callChain();
   }.protect(),
   
   authorization: function(){
      this.editable = this.options.isEditable;
      this.constructionChain.callChain();
   }.protect(),
   
   compileConstructionChain: function(){
      this.constructionChain.chain( this.createHtmlElement, this.injectHtmlElement, this.constructPlugin, this.authorization, this.associateEditor, this.finalizeConstruction );
   }.protect(),
   
   constructPlugin: function(){
      if( this.plugin ){ this.plugin.construct();
      }else this.constructionChain.callChain();
   }.protect(),
   
   createAnchorIfNeeded: function(){
      if( this.reference ){
         this.elementFactory.createAnchor( this.text, this.reference, null, this.htmlElement );
      }else {
         if( this.text ) this.htmlElement.appendText( this.resourceBundle.getText( this.text ));
      }
   }.protect(),
   
   createHtmlElement: function(){
      if( this.tag ){
         this.htmlElement = new Element( this.tag );
         if( this.id ) this.htmlElement.set( 'id', this.id );
         if( this.source ) this.htmlElement.set( 'src', this.source );
         if( this.style ) this.htmlElement.addClass( this.style );
         this.createAnchorIfNeeded();
      }
      this.constructionChain.callChain();
   }.protect(),
   
   deleteHtmlElement: function(){
      if( this.htmlElement ) {
         if( this.htmlElement.destroy ) this.htmlElement.destroy();
         this.htmlElement = null;
      }
   }.protect(),
   
   definitionElementAttribute: function( selector, defaultValue ){
      var attributeNode = XmlResource.selectNode( selector, this.definitionElement );
      if( attributeNode ) return attributeNode.value;
      else return defaultValue;
   }.protect(),
      
   finalizeConstruction: function(){
      this.stopTimeOutTimer();
      this.status = DocumentElement.States.CONSTRUCTED;
      this.constructionChain.clearChain();
      this.fireEvent( 'constructed', this, this.options.eventFireDelay );
   }.protect(),
   
   injectHtmlElement: function(){
      this.htmlElement.inject( this.contextElement, this.where );
      this.constructionChain.callChain();
   }.protect(),
   
   resetProperties: function(){
      this.id = null;
      this.htmlElement = null;
      this.reference = null;
      this.style = null;
      this.tag = null;
      this.text = null;
   }.protect(),
   
   revertConstruction: function(){
      this.constructionChain.clearChain();
      if( this.plugin ) this.plugin.destroy();
      this.deleteHtmlElement();
      this.status = DocumentElement.States.INITIALIZED;
      this.fireEvent( 'constructionError', this.error );
   }.protect(),

   timeOut : function( exception ){
      this.error = exception;
      this.revertConstruction();
   }.protect(),
   
   unmarshallId: function(){
      this.id = this.definitionElementAttribute( this.options.idSelector );
      if( !this.id ) this.id = this.options.idPrefix + (new Date().getTime());
      if( this.dataElementsIndex > 0 ) this.id += "#" + this.dataElementsIndex; 
   }.protect(),
   
   unmarshallIsEditable: function(){
      this.options.isEditable = parseBoolean( XmlResource.selectNodeText( this.options.isEditableSelector, this.definitionElement, null, this.options.isEditable ));
   }.protect(),
   
   unmarshallPlugin: function(){
      var pluginDefinition = XmlResource.selectNode( this.options.pluginSelector, this.definitionElement );
      if( pluginDefinition ){
         this.plugin = new DocumentPlugin( pluginDefinition, this.resourceBundle, { onConstructed : this.onPluginConstructed, onConstructionError : this.onPluginError } );
         this.plugin.unmarshall();
      }
   }.protect(),
   
   unmarshallProperties: function(){
      this.unmarshallId();
      this.unmarshallIsEditable();
      this.unmarshallReference();
      this.unmarshallSource();
      this.unmarshallStyle();
      this.unmarshallTag();
      this.unmarshallText();
   }.protect(),
   
   unmarshallReference: function(){
      this.reference = this.definitionElementAttribute( this.options.referenceSelector );
   }.protect(),
   
   unmarshallSource: function(){
      this.source = this.definitionElementAttribute( this.options.sourceSelector );
   }.protect(),
   
   unmarshallStyle: function(){
      this.style = this.definitionElementAttribute( this.options.styleSelector );
   }.protect(),
   
   unmarshallTag: function(){
      this.tag = this.definitionElementAttribute( this.options.tagSelector );
      if( !this.tag ) this.tag = this.options.defaultTag;
   }.protect(),
   
   unmarshallText: function(){
      this.text = XmlResource.determineNodeText( this.definitionElement );
      if( this.resourceBundle && this.text ) this.text = this.resourceBundle.getText( this.text.trim() );
      
      if( !this.text ) this.text = "";
   }
});

DocumentElement.States = { INITIALIZED : 0, UNMARSHALLED : 1, CONSTRUCTED : 2 };
/*
Name: CompositeDocumentElement

Description: Represents a composite constituent element of a SmartDocument which can have nested elements.

Requires: 
    - DocumentElement

Provides:
    - CompositeDocumentElement

Part of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. 
http://www.processpuzzle.com

Authors: 
    - Zsolt Zsuffa

Copyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the 
GNU General Public License as published by the Free Software Foundation, either version 3 of the License, 
or (at your option) any later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/





var CompositeDocumentElement = new Class({
   Extends: DocumentElement,
   Binds: ['constructNestedElements', 'onNestedElementConstructed', 'onNestedElementConstructionError'],
   
   options: {
      componentName : "CompositeDocumentElement",
      subElementsSelector : "compositeElement | element | compositeDataElement | dataElement | formElement | formField | tableElement",
      tagName : "div"
   },
   
   //Constructor
   initialize: function( definitionElement, bundle, dataXml, options ){
      this.parent( definitionElement, bundle, options );
      this.dataXml = dataXml;
      this.elements = new LinkedHashMap();
      this.nestedElementsConstructionChain = new Chain();
      this.nestedElementsContext;
      this.numberOfConstructedNestedElements = 0;
   },
   
   //Public mutators and accessor methods
   construct: function( contextElement, where ){
      this.parent( contextElement, where );
   },
   
   destroy: function(){
      this.elements.each( function( elementsEntry, index ){
         var nestedElement = elementsEntry.getValue();
         if( nestedElement.getState() > DocumentElement.States.INITIALIZED ) nestedElement.destroy();
      }, this );
      this.numberOfConstructedNestedElements = 0;
      this.parent();
   },
   
   onNestedElementConstructed: function( nestedElement ){
      this.numberOfConstructedNestedElements++;
      this.nestedElementsConstructionChain.callChain();
   },
   
   onNestedElementConstructionError: function( error ){
      this.error = error;
      this.revertConstruction();
      this.fireEvent( 'constructionError', this.error );
   },
   
   unmarshall: function(){
      this.parent();
      if( !this.tag ) this.tag = this.options.tagName;
      this.unmarshallNestedElements();
   },

   //Properties
   getElement: function( name ) { return this.elements.get( name ); },
   getElements: function() { return this.elements; },
   
   //Protected, private helper methods
   addElement: function( documentElement ){
      this.elements.put( documentElement.getId(), documentElement );
   }.protect(),
   
   compileConstructionChain: function(){
      this.constructionChain.chain( 
         this.createHtmlElement, 
         this.injectHtmlElement, 
         this.associateEditor, 
         this.constructPlugin, 
         this.constructNestedElements, 
         this.authorization, 
         this.finalizeConstruction 
      );
   }.protect(),
   
   constructNestedElements: function( contextElement ){
      if( contextElement ) this.nestedElementsContext = contextElement;
      else this.nestedElementsContext = this.htmlElement;
      
      if( this.elements.size() > 0 ){
         this.elements.each( function( elementsEntry, index ){
            var nestedElement = elementsEntry.getValue();
            this.nestedElementsConstructionChain.chain(
               function(){
                  nestedElement.construct( this.nestedElementsContext );
               }.bind( this )
            );
         }, this );
         
         this.nestedElementsConstructionChain.chain(
            function(){
               this.nestedElementsConstructionChain.clearChain();
               this.constructionChain.callChain(); 
            }.bind( this )
         );
         this.nestedElementsConstructionChain.callChain();
      }else this.constructionChain.callChain();
   }.protect(),
   
   instantiateDocumentElement: function( elementDefinition ){
      var documentElementOptions = { onConstructed : this.onNestedElementConstructed, onConstructionError : this.onNestedElementConstructionError };
      if( this.options.variables ) documentElementOptions['variables'] = this.options.variables;
      return DocumentElementFactory.create( elementDefinition, this.resourceBundle, this.dataXml, documentElementOptions );
   }.protect(),
   
   revertConstruction: function(){
      this.elements.each( function( elementsEntry, index ){
         var nestedElement = elementsEntry.getValue();
         if( nestedElement.getState() > DocumentElement.States.INITIALIZED ) nestedElement.destroy();
      }, this );
      this.elements.clear();
      this.numberOfConstructedNestedElements = 0;
      this.parent();
   }.protect(),
   
   unmarshallNestedElement: function( subElementDefinition, options ){
      var nestedDesktopElement = this.instantiateDocumentElement( subElementDefinition );
      nestedDesktopElement.unmarshall();
      this.addElement( nestedDesktopElement );
      return nestedDesktopElement;
   }.protect(),
   
   unmarshallNestedElements: function(){
      var subElements = XmlResource.selectNodes( this.options.subElementsSelector, this.definitionElement );
      subElements.each( function( subElementDefinition, index ){
         this.unmarshallNestedElement( subElementDefinition );
      }, this );
   }.protect()
   
});
/*
Name: DataElementBehaviour

Description: A specialized subclass of DekstopElement which can display data from a given source.

Requires:

Provides:
    - DataElementBehaviour

Part of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. 
http://www.processpuzzle.com

Authors: 
    - Zsolt Zsuffa

Copyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the 
GNU General Public License as published by the Free Software Foundation, either version 3 of the License, 
or (at your option) any later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/




var DataElementBehaviour = new Class({
   options: {
      bindSelector : "@bind",
      hrefSelector : "/@href",
      eventFireDelay : 2,
      indexVariable : "index",
      indexVariableSelector : "@indexVariable",
      maxOccuresSelector : "@maxOccures",
      minOccuresSelector : "@minOccures",
      overwriteElementReference : true,
      sourceSelector : "@source",
      variables : { index : "'*'" }
   },
   
   //Constructor
   initialize: function( definitionElement, bundle, data, options ){
      
      //Private variables
      this.bind;
      this.bindedData;
      this.dataXml = data;
      this.dataElementsNumber;
      this.href;
      this.maxOccures;
      this.minOccures;
      this.numberOfConstructedSiblings = 0;
      this.siblings;
      this.source;
   },
   
   //Public mutators and accessor methods
   onSiblingConstructed: function(){
      this.numberOfConstructedSiblings++;
      if( this.numberOfConstructedSiblings == this.siblings.size() ) this.constructionChain.callChain();
   },
   
   onSiblingConstructionError: function( error ){
      this.error = error;
      this.revertConstruction();
      this.fireEvent( 'constructionError', this.error, this.options.eventFireDelay );
   },
   
   unmarshallDataBehaviour: function(){
      this.unmarshallDataProperties();
      this.loadDataSource();
      this.determineDataElementsNumber();
      this.instantiateSiblings();
   },

   //Properties
   getBind: function() { return this.bind; },
   getBindedData: function() { return this.bindedData; },
   getDataElementsIndex: function() { return this.dataElementsIndex; },
   getDataElementsNumber: function() { return this.dataElementsNumber; },
   getDataXml: function() { return this.dataXml; },
   getIndexVariable: function() { return this.options.indexVariable; },
   getMaxOccures: function() { return this.maxOccures; },
   getMinOccures: function() { return this.minOccures; },
   getSiblings: function() { return this.siblings; },
   getSource: function() { return this.source; },
   
   //Protected, private helper methods
   checkIfBindVariableNeeded: function(){
      if( this.maxOccures ){
         if(( this.maxOccures == 'unbounded' || this.maxOccures > 0 ) && ( this.bind.search( "{.*}" ) == -1 )) 
            throw new MissingBindVariableException( this.id );
      }

   }.protect(),
   
   constructSiblings: function(){
      if( this.siblings.size() > 0 ){
         this.numberOfConstructedSiblings = 0;
         this.siblings.each( function( siblingElement, index ){
            siblingElement.construct( this.contextElement, this.where );
         }, this );      
      }else this.constructionChain.callChain();
   }.protect(),
   
   determineDataElementsNumber: function(){
      var dataSelector = this.bind.substitute( this.options.variables );
      this.bindedData = this.dataXml.selectNodes( dataSelector );
      if( this.maxOccures == 'unbounded' && this.bindedData.length > 1 ) this.dataElementsNumber = this.bindedData.length;
      if( this.maxOccures > 1 && this.maxOccures < this.bindedData.length ) this.dataElementsNumber = this.maxOccures;
   }.protect(),
   
   destroySiblings: function(){
      this.siblings.each( function( siblingElement, index ){
         siblingElement.destroy();
      }, this );
      
      this.numberOfConstructedSiblings = 0;
   }.protect(),
   
   initializeBindVariables : function(){
      if( !this.options.variables[this.options.indexVariable] )
         this.options.variables[this.options.indexVariable] = "'*'";
   }.protect(),
   
   instantiateSiblings: function() {
      for( var i = 2; i <= this.dataElementsNumber; i++ ){
         var variables = this.options.variables;
         variables[this.options.indexVariable] = i;
         var siblingElement = DocumentElementFactory.create( this.definitionElement, this.resourceBundle, this.dataXml, { 
            onConstructed : this.onSiblingConstructed, 
            onConstructionError : this.onSiblingConstructionError, 
            variables : variables });
         siblingElement.unmarshall();
         this.siblings.add( siblingElement );
      }
      
      if( this.dataElementsNumber > 1 ) {
         this.options.variables[this.options.indexVariable] = 1;
      }
   }.protect(),
   
   loadDataSource: function(){
      if( this.source ){
         this.dataXml = new XmlResource( this.source );
      }
   }.protect(),
   
   resetProperties: function(){
      this.bind = null;
      this.maxOccures = null;
      this.minOccures = null;
      this.source = null;
   }.protect(),
   
   retrieveData: function(){
      if( this.bind && this.dataXml ){
         var dataSelector = this.bind.substitute( this.options.variables );
         var href = null;
         if( instanceOf( this.dataXml, XmlResource ) ){
            this.text = this.dataXml.selectNodeText( dataSelector );
            href = this.dataXml.selectNodeText( dataSelector + this.options.hrefSelector );
         }else if( typeOf( this.dataXml ) == "element" ){
            if( dataSelector.indexOf( "/" ) < 0 ){
               this.text = XmlResource.determineNodeText( this.dataXml );
               href = XmlResource.selectNodeText( "@href", this.dataXml );
            }else{
               this.text = XmlResource.selectNodeText( dataSelector, this.dataXml );
               href = XmlResource.selectNodeText( dataSelector + this.options.hrefSelector, this.dataXml );
            }
         }
      
         if( this.text ) this.text.trim();
         if( href && this.options.overwriteElementReference ) this.reference = href;
      }      
      this.constructionChain.callChain();
   }.protect(),
   
   unmarshallDataProperties: function(){
      this.bind = this.definitionElementAttribute( this.options.bindSelector );
      this.options.indexVariable = this.definitionElementAttribute( this.options.indexVariableSelector, this.options.indexVariable );
      this.maxOccures = this.definitionElementAttribute( this.options.maxOccuresSelector );
      this.minOccures = this.definitionElementAttribute( this.options.minOccuresSelector );
      this.source = this.definitionElementAttribute( this.options.sourceSelector );
      
      this.checkIfBindVariableNeeded();
      this.initializeBindVariables();
   }
});
/*
Name: CompositeDataElement

Description: Represents a composite constituent element of a SmartDocument which retrieves and presents data from a given data source.

Requires:
    - CompositeDocumentElement, DocumentElement

Provides:
    - CompositeDataElement

Part of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. 
http://www.processpuzzle.com

Authors: 
    - Zsolt Zsuffa

Copyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the 
GNU General Public License as published by the Free Software Foundation, either version 3 of the License, 
or (at your option) any later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/






var CompositeDataElement = new Class({
   Extends: CompositeDocumentElement,
   Binds: ['constructSiblings', 'finalizeConstruction', 'onSiblingConstructed', 'onSiblingConstructionError', 'retrieveData'],
   Implements: DataElementBehaviour,
   
   options: {
      componentName : "CompositeDataElement"
   },
   
   //Constructor
   initialize: function( definitionElement, bundle, dataXml, options ){
      this.parent( definitionElement, bundle, dataXml, options );
      this.contextElement;
      this.bind;
      this.dataElementsNumber = 1;
      this.maxOccures;
      this.minOccures;
      this.siblings = new ArrayList();
      this.source;
      this.where;
   },
   
   //Public mutators and accessor methods
   construct: function( contextElement, where ){
      this.contextElement = contextElement;
      this.where = where;
      this.parent( contextElement, where );
   },
   
   destroy: function(){
      this.destroySiblings();
      this.parent();
   },
   
   unmarshall: function(){
      this.unmarshallDataBehaviour();
      this.parent();
   },
   
   //Properties
   
   //Protected, private helper methods
   compileConstructionChain: function(){
      this.constructionChain.chain(
         this.retrieveData,
         this.createHtmlElement, 
         this.injectHtmlElement, 
         this.associateEditor, 
         this.constructPlugin, 
         this.constructNestedElements, 
         this.authorization, 
         this.constructSiblings,
         this.finalizeConstruction 
      );
   }.protect()
   
});
/*
Name: DataElement

Description: A specialized subclass of DekstopElement which can display data from a given source.

Requires:

Provides:
    - DataElement

Part of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. 
http://www.processpuzzle.com

Authors: 
    - Zsolt Zsuffa

Copyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the 
GNU General Public License as published by the Free Software Foundation, either version 3 of the License, 
or (at your option) any later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/






var DataElement = new Class({
   Extends: DocumentElement,
   Binds: ['constructSiblings', 'finalizeConstruction', 'onSiblingConstructed', 'onSiblingConstructionError', 'retrieveData'],
   Implements: DataElementBehaviour,
   
   options: {
      componentName : "DataElement",
      isEditable : true,
   },
   
   //Constructor
   initialize: function( definitionElement, bundle, data, options ){
      this.parent( definitionElement, bundle, options );
      
      //Private variables
      this.setUp( data );
   },
   
   //Public mutators and accessor methods
   construct: function( contextElement, where ){
      this.parent( contextElement, where );
   },
   
   destroy: function(){
      this.destroySiblings();
      this.parent();
      this.numberOfConstructedSiblings = 0;
   },
   
   unmarshall: function(){
      this.unmarshallDataBehaviour();
      this.parent();
   },
   
   //Properties
   
   //Protected, private helper methods
   compileConstructionChain: function(){
      this.constructionChain.chain( 
         this.retrieveData, 
         this.createHtmlElement, 
         this.injectHtmlElement, 
         this.constructPlugin, 
         this.authorization, 
         this.associateEditor, 
         this.constructSiblings, 
         this.finalizeConstruction 
      );
   }.protect(),
   
   injectHtmlElement: function(){
      this.htmlElement.addClass( DataElement.CLASS );
      this.parent();
   }.protect(),
   
   setUp: function( data ){
      this.dataXml = data;
      this.numberOfConstructedSiblings = 0;
      this.siblings = new ArrayList();
   }.protect(),
});

DataElement.CLASS = "dataElement";
/*
Name: DocumentElementEditor

Description: An inline editor, associciated with SmartDocument's elements (DocumentElement).

Requires:

Provides:
    - DocumentElementEditor

Part of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. 
http://www.processpuzzle.com

Authors: 
    - Zsolt Zsuffa

Copyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the 
GNU General Public License as published by the Free Software Foundation, either version 3 of the License, 
or (at your option) any later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/




var DocumentElementEditor = new Class({
   Implements: [Events, Options],
   Binds: ['onBlur', 'onClick'],
   options: {
      dataType : 'string', //DocumentElementEditor.DataType.STRING,
      inputStyle : { background: 'transparent', border : 'none', width: '20em' },
      mininmumWidth : '400',
      restriction : null,
      styleProperties : ['color', 'display', 'font-family', 'font-size', 'font-weight', 'line-height', 'margin', 'height', 'padding', 'position', 'text-align', 'width'],
   },
   
   initialize: function( subjectHtmlElement, options ){
      this.setOptions( options );
      assertThat( subjectHtmlElement, not( nil() ));
      
      //private fields
      this.inputElement;
      this.previousValue;
      this.state = DocumentElementEditor.States.DETACHED;
      this.subjectHtmlElement = subjectHtmlElement;
      this.text;
   },
   
   //Public accessors and mutators
   attach: function(){
      if( this.state == DocumentElementEditor.States.DETACHED ){
         this.subjectHtmlElement.addEvent( 'focus', this.onClick );
         this.subjectHtmlElement.addEvent( 'click', this.onClick );
         this.state = DocumentElementEditor.States.ATTACHED;
      }
   },
   
   detach: function(){
      if( this.state == DocumentElementEditor.States.EDITING || this.state == DocumentElementEditor.States.ATTACHED ){
         if( this.inputElement ) this.removeInputElement();
         this.state = DocumentElementEditor.States.DETACHED;
      }
   },
   
   onBlur: function(){
      if( this.state == DocumentElementEditor.States.EDITING ){
         this.removeInputElement();
         this.state = DocumentElementEditor.States.ATTACHED;
         this.fireEvent( 'editEnd', this );
      }
   },
   
   onClick: function(){
      if( this.state == DocumentElementEditor.States.ATTACHED ){
         this.saveCurrentValue();
         this.injectInputElement();
         this.state = DocumentElementEditor.States.EDITING;
         this.fireEvent( 'editStart', this );
      }
   },
   
   onKeypress: function(){
      
   },
   
   //Properties
   getInputElement: function() { return this.inputElement; },
   getPreviousValue: function() { return this.previousValue; },
   getState: function() { return this.state; },
   getSubjectElement: function(){ return this.subjectHtmlElement; },
   getText: function() { return this.text; },
   isChanged: function() { return !(this.text && this.text.equals( this.previousValue )); },
   
   //Protected, private helper methods
   injectInputElement: function(){
      var subjectHtmlElementStyle = this.subjectHtmlElement.getStyles( this.options.styleProperties );
      this.subjectHtmlElement.setStyle( 'display', 'none' );
      this.inputElement = new Element( 'input', {
         events : { blur : this.onBlur },
         name : this.subjectHtmlElement.get( 'id'), 
         type: 'text', 
         value : this.text, 
         styles : this.options.inputStyle 
      });
      this.inputElement.setStyles( subjectHtmlElementStyle );
      if( this.inputElement.getStyle( 'width' ).toInt() < this.options.minimumWidth ) this.inputElement.setStyle( 'width', this.options.minimumWidth );
      this.inputElement.inject( this.subjectHtmlElement, 'after' );
   }.protect(),
   
   removeInputElement: function(){
      this.text = this.inputElement.get( 'value' );
      this.inputElement.removeEvents();
      this.inputElement.destroy();
      this.subjectHtmlElement.removeEvent( 'focus', this.onClick );
      this.subjectHtmlElement.removeEvent( 'click', this.onClick );
      this.subjectHtmlElement.set( 'text', this.text );
      this.subjectHtmlElement.setStyle( 'display', 'inline' );
   }.protect(),
   
   saveCurrentValue: function(){
      this.text = this.subjectHtmlElement.get( 'text' );
      this.previousValue = this.text;
   }
});

DocumentElementEditor.DataType = { BOOLEAN : 'boolean', INTEGER : 'integer', LONG_INTEGER : 'longInteger', STRING : 'string', TEXT : 'text', TIME_POINT : 'timePoint' };
DocumentElementEditor.DataType.TIME_POINT.Precission = { YEAR : 'year', MONTH : 'month', DAY : 'day', HOUR : 'hour', MINUTE : 'minute', SECOND : 'second', MILLI_SECOND : 'milliSecond' };
DocumentElementEditor.States = { DETACHED : 'detached', ATTACHED : 'attached', EDITING : 'editing' };
/*
Name: DataElementEditor

Description: An inline editor, associciated with SmartDocument's DataElements.

Requires:
   - DocumentElementEditor
Provides:
    - DataElementEditor

Part of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. 
http://www.processpuzzle.com

Authors: 
    - Zsolt Zsuffa

Copyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the 
GNU General Public License as published by the Free Software Foundation, either version 3 of the License, 
or (at your option) any later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/





var DataElementEditor = new Class({
   Extends: DocumentElementEditor,
   options: {
   },
   
   //Consturctor
   initialize: function( subjectHtmlElement, options ){
      this.parent( subjectHtmlElement, options );
   }
   
   //Public accessors and mutators
   
   //Properties
   
   //Protected, private helper methods
});
/*
Name: DocumentBody

Description: Represents the body component of a SmartDocument.

Requires:

Provides:
    - DocumentBody

Part of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. 
http://www.processpuzzle.com

Authors: 
    - Zsolt Zsuffa

Copyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the 
GNU General Public License as published by the Free Software Foundation, either version 3 of the License, 
or (at your option) any later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/





var DocumentBody = new Class({
   Extends: CompositeDocumentElement,
   
   options: {
      componentName : "DocumentBody"
   },
   
   //Constructor
   initialize: function( headerDefinitionElement, bundle, data, options ){
      this.parent( headerDefinitionElement, bundle, data, options );
   },
   
   //Public mutators and accessor methods
   construct: function( contextElement, where ){
      this.parent( contextElement, where );
   },
   
   constructed: function(){
      this.parent();
   },
   
   unmarshall: function(){
      this.parent();
   }

   //Properties
});
/*
Name: DocumentElementEditorFactory

Description: Instantiates a new instance of DocumentElementEditor or one of it's subclass depending on the type of DocumentElement.

Requires:

Provides:
    - DocumentElementEditorFactory

Part of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. 
http://www.processpuzzle.com

Authors: 
    - Zsolt Zsuffa

Copyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the 
GNU General Public License as published by the Free Software Foundation, either version 3 of the License, 
or (at your option) any later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/




var DocumentElementEditorFactory = new Class({
   Implements: Options,
   
   options: {   
   },
   
   initialize: function(){
   },

   create: function( subjectDocumentElement, options ){
      var subjectHtmlElement = subjectDocumentElement.getHtmlElement(); 
      var documentElementEditor = null;
      switch( subjectDocumentElement.options.componentName ){
      case "CompositeDataElement": 
      case "FormField": 
         documentElementEditor = new DataElementEditor( subjectDocumentElement.getValueElement(), options ); break;
      case "DataElement": 
         documentElementEditor = new DataElementEditor( subjectHtmlElement, options ); break;
      case "CompositeDocumentElement": 
      case "DocumentElement": 
         documentElementEditor = new DocumentElementEditor( subjectHtmlElement, options ); break;
      case "TableBody": 
      case "TableCell": 
      case "TableElement": 
      case "TableHeader": 
      case "TableRow": 
         documentElementEditor = new TableElementEditor( subjectHtmlElement, options ); break;
      }
      
      return documentElementEditor;
   }
});

DocumentElementEditorFactory.create = function( subjectDocumentElement, options ){
   var factory = new DocumentElementEditorFactory();
   var elementEditor = factory.create( subjectDocumentElement, options );
   return elementEditor;
};
/*
Name: DocumentElementFactory

Description: Instantiates a new subclass of DocumentElement according to the given XML element.

Requires:

Provides:
    - DocumentElementFactory

Part of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. 
http://www.processpuzzle.com

Authors: 
    - Zsolt Zsuffa

Copyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the 
GNU General Public License as published by the Free Software Foundation, either version 3 of the License, 
or (at your option) any later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/




var DocumentElementFactory = new Class({
   Implements: Options,
   
   options: {   
   },
   
   initialize: function(){
   },

   create: function( definitionXmlElement, bundle, data, options ){
      var newDocumentElement;
      switch( definitionXmlElement.tagName.toUpperCase() ){
      case "COMPOSITEDATAELEMENT": 
         newDocumentElement = new CompositeDataElement( definitionXmlElement, bundle, data, options ); break;
      case "COMPOSITEELEMENT": 
         newDocumentElement = new CompositeDocumentElement( definitionXmlElement, bundle, data, options ); break;
      case "DATAELEMENT": 
         newDocumentElement = new DataElement( definitionXmlElement, bundle, data, options ); break;
      case "DOCUMENTBODY": 
         newDocumentElement = new DocumentBody( definitionXmlElement, bundle, data, options ); break;
      case "DOCUMENTFOOTER": 
         newDocumentElement = new DocumentFooter( definitionXmlElement, bundle, data, options ); break;
      case "DOCUMENTHEADER": 
         newDocumentElement = new DocumentHeader( definitionXmlElement, bundle, data, options ); break;
      case "FORMELEMENT": 
         newDocumentElement = new FormElement( definitionXmlElement, bundle, data, options ); break;
      case "FORMFIELD": 
         newDocumentElement = new FormField( definitionXmlElement, bundle, data, options ); break;
      case "TABLEELEMENT": 
         newDocumentElement = new TableElement( definitionXmlElement, bundle, data, options ); break;
      case "TABLECOLUMN": 
         newDocumentElement = new TableColumn( definitionXmlElement, bundle, data, options ); break;
      case "ELEMENT":
      default:
         newDocumentElement = new DocumentElement( definitionXmlElement, bundle, options ); break;
      }
      
      return newDocumentElement;
   }
});

DocumentElementFactory.create = function(  definitionXmlElement, bundle, data, options ){
   var factory = new DocumentElementFactory();
   var element = factory.create( definitionXmlElement, bundle, data, options );
   return element;
};
/*
Name: DocumentFooter

Description: Represents the body component of a SmartDocument.

Requires:

Provides:
    - DocumentFooter

Part of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. 
http://www.processpuzzle.com

Authors: 
    - Zsolt Zsuffa

Copyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the 
GNU General Public License as published by the Free Software Foundation, either version 3 of the License, 
or (at your option) any later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/





var DocumentFooter = new Class({
   Extends: CompositeDocumentElement,
   
   options: {
      componentName : "DocumentFooter"
   },
   
   //Constructor
   initialize: function( headerDefinitionElement, bundle, data, options ){
      this.parent( headerDefinitionElement, bundle, data, options );
   },
   
   //Public mutators and accessor methods
   construct: function( contextElement, where ){
      this.parent( contextElement, where );
   },
   
   unmarshall: function(){
      this.parent();
   }

   //Properties
});
/*
Name: DocumentHeader

Description: Represents the header element of a SmartDocument.

Requires:

Provides:
    - DocumentHeader

Part of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. 
http://www.processpuzzle.com

Authors: 
    - Zsolt Zsuffa

Copyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the 
GNU General Public License as published by the Free Software Foundation, either version 3 of the License, 
or (at your option) any later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/





var DocumentHeader = new Class({
   Extends: CompositeDocumentElement,
   
   options: {
      componentName : "DocumentHeader"
   },
   
   //Constructor
   initialize: function( headerDefinitionElement, bundle, data, options ){
      this.parent( headerDefinitionElement, bundle, data, options );
   },
   
   //Public mutators and accessor methods
   construct: function( contextElement, where ){
      this.parent( contextElement, where );
   },
   
   unmarshall: function(){
      this.parent();
   }

   //Properties
});
/*
Name: 
    - DocumentPlugin

Description: 
    - Represents an embedable active element of SmartDocument. The dynamic behaviour of ProcessPuzzleUI is provided by plugins. 

Requires:

Provides:
    - DocumentPlugin

Part of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. 
http://www.processpuzzle.com

Authors: 
    - Zsolt Zsuffa

Copyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the 
GNU General Public License as published by the Free Software Foundation, either version 3 of the License, 
or (at your option) any later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/




var DocumentPlugin = new Class({
   Implements: [Events, Options],
   Binds: ['finalizeConstruction', 'instantiateWidget', 'loadResources', 'onResourceError', 'onResourcesLoaded', 'onWidgetConstructed', 'onWidgetError'],   
   
   options: {
      componentName : "DocumentPlugin",
      nameSelector : "@name",
      optionsSelector : "widget/options",
      resourcesSelector : "resources",
      widgetNameSelector : "widget/@name"
   },
   
   //Constructor
   initialize: function( definitionElement, internationalization, options ){
      this.setOptions( options );

      //Protected, private variables
      this.constructChain = new Chain();
      this.definitionElement = definitionElement;
      this.error = null;
      this.internationalization = internationalization;
      this.logger = Class.getInstanceOf( WebUILogger );
      this.name;
      this.onLoad;
      this.resources;
      this.state = DocumentPlugin.States.INITIALIZED;
      this.widget;
      this.widgetName;
      this.widgetOptions;
      
      this.constructChain.chain( this.loadResources, this.instantiateWidget, this.finalizeConstruction );
   },
   
   //Public mutators and accessor methods
   construct: function(){
      this.logger.trace( this.options.componentName + ".construct() of '" + this.name + "' started." );
      this.constructChain.callChain();
   },
   
   destroy: function(){
      if( this.resources ) this.resources.release();
      if( this.widget && this.widget.destroy && typeOf( this.widget.destroy ) == 'function' ) this.widget.destroy();
      this.state = DocumentPlugin.States.INITIALIZED;
   },
   
   loadResources: function(){
      if( this.resources ) this.resources.load();
      else this.constructChain.callChain();
   },
   
   onResourceError: function( error ){
      this.error = error;
   },
   
   onResourcesLoaded: function(){
      if( this.resources.isSuccess() ){
         this.state = DocumentPlugin.States.LOADED;
         this.fireEvent( 'resourcesLoaded', this );
         this.constructChain.callChain();
      }else {
         this.constructChain.clearChain();
         this.resources.release();
         this.fireEvent( 'constructionError', this.error );
      }
   },
   
   onWidgetConstructed: function(){
      this.constructChain.callChain();
   },
   
   onWidgetError: function( error ){
      this.error = error;
      this.constructChain.clearChain();
      this.fireEvent( 'constructionError', this.error );
   },
   
   unmarshall: function(){
      this.unmarshallProperties();
      this.unmarshallResources();
      this.unmarshallWidget();
      this.state = DocumentPlugin.States.UNMARSHALLED;
   },

   //Properties
   getDefinitionElement: function() { return this.definitionElement; },
   getError: function() { return this.error; },
   getOnLoad: function() { return this.onLoad; },
   getResources: function() { return this.resources; },
   getState: function() { return this.state; },
   getWidget: function() { return this.widget; },
   getWidgetName: function() { return this.widgetName; },
   getWidgetOptions: function() { return this.widgetOptions; },
   isSuccess: function() { return this.error == null; },

   //Protected, pirvated helper methods
   finalizeConstruction: function(){
      this.constructChain.clearChain();
      this.state = DocumentPlugin.States.CONSTRUCTED;
      this.fireEvent( 'constructed', this );
   }.protect(),
   
   instantiateWidget: function(){
      if( this.widgetName ){
         try{
            var widgetClass = eval( this.widgetName );
            var mergedOptions = Object.merge( this.widgetOptions, { onConstructed : this.onWidgetConstructed, onError : this.onWidgetError } );
            this.widget = new widgetClass( mergedOptions, this.internationalization );
            this.widget.unmarshall();
            this.widget.construct();
         }catch( exception ){
            this.onWidgetError( exception );
         }
      }else this.onWidgetConstructed();
   }.protect(),
   
   unmarshallOptions: function(){
      var optionsElement = XmlResource.selectNode( this.options.optionsSelector, this.definitionElement );
      if( optionsElement ){
         var optionsResource = new OptionsResource( optionsElement );
         optionsResource.unmarshall();
         this.widgetOptions = optionsResource.getOptions();
      }
   }.protect(),
   
   unmarshallProperties: function(){
      this.name = XmlResource.selectNodeText( this.options.nameSelector, this.definitionElement );
   }.protect(),
   
   unmarshallResources: function() {
      var resourcesElement = XmlResource.selectNode( this.options.resourcesSelector, this.definitionElement );
      if( resourcesElement ){
         this.resources = new ResourceManager( resourcesElement, { onResourcesLoaded : this.onResourcesLoaded, onResourceError : this.onResourceError } );
         this.resources.unmarshall();
      }
   }.protect(),
   
   unmarshallWidget: function() {
      this.widgetName = XmlResource.selectNodeText( this.options.widgetNameSelector, this.definitionElement );
      this.unmarshallOptions();
   }
});

DocumentPlugin.States = { INITIALIZED : 0, UNMARSHALLED : 1, LOADED : 2, CONSTRUCTED : 3 };
/*
Name: FormElement

Description: Represents a composite constituent element of a SmartDocument which retrieves and presents data from a given data source.

Requires:
    - CompositeDocumentElement, DocumentElement

Provides:
    - FormElement

Part of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. 
http://www.processpuzzle.com

Authors: 
    - Zsolt Zsuffa

Copyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the 
GNU General Public License as published by the Free Software Foundation, either version 3 of the License, 
or (at your option) any later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/





var FormElement = new Class({
   Extends: CompositeDataElement,
   
   options: {
      componentName : "FormElement",
      methodSelector : "method"
   },
   
   //Constructor
   initialize: function( definitionElement, bundle, dataXml, options ){
      this.parent( definitionElement, bundle, dataXml, options );
      this.controlsContainerElement;
      this.fieldsContainerElement;
      this.method;
   },
   
   //Public mutators and accessor methods
   construct: function( contextElement, where ){
      this.parent( contextElement, where );
   },
   
   destroy: function(){
      this.parent();
   },
   
   unmarshall: function( dataElementIndex ){
      this.parent();
   },

   //Properties
   getMethod: function() { return this.method; },
   
   //Protected, private helper methods
   constructNestedElements : function(){
      this.parent( this.fieldsContainerElement );
   }.protect(),
   
   createHtmlElement : function(){
      this.htmlElement = this.elementFactory.createForm( this.id, this.method, this.contextElement, WidgetElementFactory.Positions.LastChild );
      this.controlsContainerElement = this.htmlElement.getChildren()[1];
      this.fieldsContainerElement = this.htmlElement.getChildren()[0];
      this.constructionChain.callChain();
   }.protect(),
   
   unmarshallProperties: function(){
      this.method = this.resourceBundle.getText( XmlResource.determineAttributeValue( this.definitionElement, this.options.methodSelector ));
      this.parent();
   }   
});
/*
Name: FormField

Description: A specialized subclass of DekstopElement which can display data from a given source.

Requires:

Provides:
    - FormField

Part of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. 
http://www.processpuzzle.com

Authors: 
    - Zsolt Zsuffa

Copyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the 
GNU General Public License as published by the Free Software Foundation, either version 3 of the License, 
or (at your option) any later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/





var FormField = new Class({
   Extends: DataElement,
   
   options: {
      componentName : "FormField",
      labelSelector: "label"
   },
   
   //Constructor
   initialize: function( definitionElement, bundle, data, options ){
      this.parent( definitionElement, bundle, data, options );
      
      //Private variables
      this.elementFactory;
      this.label;
      this.labelElement;
      this.valueElement;
   },
   
   //Public mutators and accessor methods
   construct: function( contextElement, where ){
      this.parent( contextElement, where );
   },
   
   destroy: function(){
      this.parent();
   },
   
   unmarshall: function(){
      this.parent();
   },

   //Properties
   getElementFactory: function() { return this.elementFactory; },
   getLabel: function() { return this.label; },
   getLabelElement: function() { return this.labelElement; },
   getValueElement: function() { return this.valueElement; },
   
   //Protected, private helper methods
   associateEditor: function(){
      if( this.isEditable() ){
         this.editor = DocumentElementEditorFactory.create( this, {} );
         this.editor.attach();
      }
      this.constructionChain.callChain();
   }.protect(),
   
   createHtmlElement : function(){
      this.htmlElement = this.elementFactory.createStaticRow( this.label, this.text, this.id, this.contextElement, WidgetElementFactory.Positions.LastChild, this.reference );
      this.labelElement = this.htmlElement.getChildren( 'label' )[0];
      this.valueElement = this.htmlElement.getChildren( 'span' )[0];
      this.constructionChain.callChain();
   },
   
   unmarshallProperties: function(){
      this.label = this.resourceBundle.getText( XmlResource.determineAttributeValue( this.definitionElement, this.options.labelSelector ));
      this.parent();
   }
});
/*
Name: ImageElement

Description: Represents an image element of a SmartDocument.

Requires:
    - DocumentElement

Provides:
    - ImageElement

Part of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. 
http://www.processpuzzle.com

Authors: 
    - Zsolt Zsuffa

Copyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the 
GNU General Public License as published by the Free Software Foundation, either version 3 of the License, 
or (at your option) any later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/






var ImageElement = new Class({
   Extends: DocumentElement,
   
   options: {
      componentName : "ImageElement",
   },
   
   //Constructor
   initialize: function( definitionElement, bundle, options ){
      this.parent( definitionElement, bundle, options );
      
   },
   
   //Public mutators and accessor methods
   construct: function( contextElement, where ){
      this.tag = "IMG";
      this.parent( contextElement, where );
   },
   
   destroy: function(){
      this.parent();
   },
   
   unmarshall: function(){
      this.parent();
   },

   //Properties
   
   //Protected, private helper methods
});
/*
Name: ImageLensBehavior

Description: Add lens functionality for ImageElement.

Requires:
    - 

Provides:
    - ImageLensBehavior

Part of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. 
http://www.processpuzzle.com

Authors: 
    - Zsolt Zsuffa

Copyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the 
GNU General Public License as published by the Free Software Foundation, either version 3 of the License, 
or (at your option) any later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/




var ImageLensBehaviour = new Class({
   Implements: [Options],
   
   options: {
      borderColor: "#888",
      borderSize: 4,
      componentName : "ImageLensBehaviour",
      lensSize: 100
   },
   
   //Constructor
   initialize: function( options ){
      this.setOptions( options );
      
      this.lensStyle;
   },
   
   //Public mutators and accessor methods
   construct: function( ){
      this.defineLensStyle();
      this.createLensElement();
      this.calculateActualImageSize();
   },
   
   destroy: function(){
   },

   setPosition: function( event ){
      var leftPos = parseInt(e.pageX - offset.left);
      var topPos = parseInt(e.pageY - offset.top);

      if (leftPos < 0 || topPos < 0 || leftPos > obj.width() || topPos > obj.height()) {
          target.hide();
      }else {
          target.show();

          leftPos = String(((e.pageX - offset.left) * widthRatio - target.width() / 2) * (-1));
          topPos = String(((e.pageY - offset.top) * heightRatio - target.height() / 2) * (-1));
          target.css({ backgroundPosition: leftPos + 'px ' + topPos + 'px' });

          leftPos = String(e.pageX - target.width() / 2);
          topPos = String(e.pageY - target.height() / 2);
          target.css({ left: leftPos + 'px', top: topPos + 'px' });
      }
   },
   
   unmarshall: function(){
   },

   //Properties
   
   //Protected, private helper methods
   calculateActualImageSize : function(){
      var imageSrc = options.imageSrc ? options.imageSrc : $(this).attr("src");
      var imageTag = "<img style='display:none;' src='" + imageSrc + "' />";

      var widthRatio = 0;
      var heightRatio = 0;

      $(imageTag).load(function () {
          widthRatio = $(this).width() / obj.width();
          heightRatio = $(this).height() / obj.height();
      }).appendTo($(this).parent());

      target.css({ backgroundImage: "url('" + imageSrc + "')" });

      target.mousemove(setPosition);
      $(this).mousemove(setPosition);
   }.protect(),
   
   createLensElement : function(){
      this.target = $("<div style='" + this.lensStyle + "' class='" + options.lensCss + "'>&nbsp;</div>").appendTo($(this).parent());
      this.targetSize = this.target.size();
   }.protect(),
   
   defineLensStyle : function(){
      this.lensStyle = "background-position: 0px 0px;width: " + String(options.lensSize) + "px;height: " + String(options.lensSize)
      + "px;float: left;display: none;border-radius: " + String(options.lensSize / 2 + options.borderSize)
      + "px;border: " + String(options.borderSize) + "px solid " + options.borderColor 
      + ";background-repeat: no-repeat;position: absolute;";
   }.protect()
});
/*
Name: MissingBindVariableException

Description: Thrown when a DataElement's 'bind' attribute doesn't contain one or more variables.

Requires:
   - WebUIExceptions

Provides:
   - MissgingVariableException

Part of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. 
http://www.processpuzzle.com

Authors: 
	- Zsolt Zsuffa

Copyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the 
GNU General Public License as published by the Free Software Foundation, either version 3 of the License, 
or (at your option) any later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/




var MissingBindVariableException = new Class({
   Extends: WebUIException,
   options: {
      description: "Data element's: '{dataElementId}' 'bind' property doesn't contains any variables.",
      name: "MissingBindVariableException"
   },
   
   //Constructor
   initialize : function( dataElementId, options ){
      this.setOptions( options );
      this.parent( options );
      this.parameters = { dataElementId : dataElementId };
   }	
});
/*Name: SmartDocumentDescription: Represents a document of a Panel. Reads it's own structure and content from xml files and constructs HTML based on them.Requires:Provides:    - SmartDocumentPart of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. http://www.processpuzzle.comAuthors:     - Zsolt ZsuffaCopyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation, either version 3 of the License, or (at your option) any later version.This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty ofMERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.*///= require_directory ../MochaUI//= require_directory ../FundamentalTypes//= require ../AbstractDocument/AbstractDocument.jsvar SmartDocument = new Class({   Extends: AbstractDocument,   Binds : ['constructBody',             'constructFooter',             'constructHeader',             'destroyHeaderBodyAndFooter',            'determineContainerElement',             'loadResources',             'onBodyConstructed',             'onConstructionError',            'onFooterConstructed',             'onHeaderConstructed',            'onResourceError',            'onResourcesLoaded'],      options : {      componentName : "SmartDocument",      bodySelector : "documentBody",      footerSelector : "documentFooter",      headerSelector : "documentHeader",      rootElementName : "/smartDocumentDefinition"   },      //Constructor   initialize : function( i18Resource, options ) {      this.parent( i18Resource, options );      this.documentBody = null;      this.documentFooter = null;      this.documentHeader = null;   },   //Public accesors and mutators   construct: function(){      this.parent();   },      destroy: function() {      this.parent();   },      onBodyConstructed: function(){      this.constructionChain.callChain();   },      onFooterConstructed: function(){      this.constructionChain.callChain();   },      onHeaderConstructed: function(){      this.constructionChain.callChain();   },      unmarshall: function(){      var documentComponentOptions = { onConstructed : this.onHeaderConstructed, onConstructionError : this.onConstructionError };      if( this.options.documentVariables ) documentComponentOptions['variables'] = this.options.documentVariables      this.documentHeader = this.unmarshallDocumentComponent( this.options.rootElementName + "/" + this.options.headerSelector, documentComponentOptions );      this.documentBody = this.unmarshallDocumentComponent( this.options.rootElementName + "/" + this.options.bodySelector, documentComponentOptions );      this.documentFooter = this.unmarshallDocumentComponent( this.options.rootElementName + "/" + this.options.footerSelector, documentComponentOptions );      this.parent();   },      //Properties   getBody: function() { return this.documentBody; },   getFooter: function() { return this.documentFooter; },   getHeader: function() { return this.documentHeader; },      //Protected, private helper methods   compileConstructionChain: function(){      this.constructionChain.chain(         this.determineContainerElement,         this.loadResources,         this.constructHeader,         this.constructBody,         this.constructFooter,         this.finalizeConstruction      );   }.protect(),      compileDestructionChain: function(){      this.destructionChain.chain(  this.destroyHeaderBodyAndFooter, this.releseResource, this.detachEditor, this.resetProperties, this.finalizeDestruction );   }.protect(),      constructBody : function(){      if( this.documentBody ) this.documentBody.construct( this.containerElement, 'bottom' );      else this.constructionChain.callChain();   }.protect(),      constructFooter: function(){      if( this.documentFooter ) this.documentFooter.construct( this.containerElement, 'bottom' );      else this.constructionChain.callChain();   }.protect(),      constructHeader: function(){      if( this.documentHeader ) this.documentHeader.construct( this.containerElement, 'bottom' );      else this.constructionChain.callChain();   }.protect(),      destroyHeaderBodyAndFooter: function(){      if( this.documentHeader ) this.documentHeader.destroy();      if( this.documentBody ) this.documentBody.destroy();      if( this.documentFooter ) this.documentFooter.destroy();      this.destructionChain.callChain();   }.protect(),      resetProperties: function(){      this.documentHeader = null;      this.documentBody = null;      this.documentFooter = null;      this.parent();   }.protect(),      revertConstruction: function(){      if( this.resources ) this.resources.release();      if( this.documentHeader ) this.documentHeader.destroy();      if( this.documentBody ) this.documentBody.destroy();      if( this.documentFooter ) this.documentFooter.destroy();      this.parent();   }.protect(),      unmarshallDocumentComponent: function( selector, options ){      var documentComponent = null;      var componentDefinition = this.documentDefinition.selectNode( selector );      if( componentDefinition ) documentComponent = DocumentElementFactory.create( componentDefinition, this.i18Resource, this.documentContent, options );      if( documentComponent ) documentComponent.unmarshall();      return documentComponent;   }.protect()   });
/*
Name: TableBody

Description: Represents the body element of a TableElement.

Requires:
    - DocumentElement

Provides:
    - TableBody

Part of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. 
http://www.processpuzzle.com

Authors: 
    - Zsolt Zsuffa

Copyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the 
GNU General Public License as published by the Free Software Foundation, either version 3 of the License, 
or (at your option) any later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/





var TableBody = new Class({
   Extends: DocumentElement,
   Binds: ['createRowElement', 'constructRows', 'onRowConstructed', 'onRowConstructionError'],
   
   options: {
      componentName : "TableBody",
   },
   
   //Constructor
   initialize: function( definitionElement, bundle, dataSet, columnHeaders, options ){
      this.parent( definitionElement, bundle, options );
      
      this.columnHeaders = columnHeaders;
      this.dataSet = dataSet;
      this.rowsConstructionChain = new Chain();
      this.rows = new ArrayList();
   },
   
   //Public mutators and accessor methods
   construct: function( contextElement, where ){
      this.tag = "TBODY";
      this.parent( contextElement, where );
   },
   
   destroy: function(){
      this.parent();
   },
   
   onRowConstructed : function( columnHeader ){
      this.rowsConstructionChain.callChain();
   },
   
   onRowConstructionError : function( error ){
      this.error = error;
      this.revertConstruction();
   },
   
   unmarshall: function(){
      this.unmarshallRows();
      this.parent();
   },

   //Properties
   getRows: function() { return this.rows; },
   
   //Protected, private helper methods
   compileConstructionChain: function(){
      this.constructionChain.chain( 
         this.createHtmlElement,
         this.injectHtmlElement, 
         this.constructPlugin, 
         this.authorization, 
         this.associateEditor, 
         this.constructRows, 
         this.finalizeConstruction 
      );
   }.protect(),
   
   constructRows : function(){
      this.rows.each( function( row, index ){
         this.rowsConstructionChain.chain(
            function(){ 
               row.construct( this.htmlElement ); 
            }.bind( this )
         );
      }.bind( this ));
      this.rowsConstructionChain.chain(
         function(){
            this.rowsConstructionChain.clearChain();
            this.constructionChain.callChain(); 
         }.bind( this )
      );
      this.rowsConstructionChain.callChain();
   }.protect(),
   
   deleteHtmlElement : function(){
      this.destroyRows();
      this.parent();
   }.protect(),
   
   destroyRows : function(){
      this.rows.each( function( row, index ){
         row.destroy(); 
      }.bind( this ));
   }.protect(),
   
   unmarshallRows: function(){
      this.dataSet.each( function( columnHeaderDefinition, index ){
         var row = new TableRow( this.definitionElement, this.resourceBundle, this.dataSet[index], this.columnHeaders, { 
            isEditable : this.isEditable(),
            onConstructed : this.onRowConstructed, 
            onConstructionError : this.onRowConstructionError 
         });
         row.unmarshall();
         this.rows.add( row );
      }, this );
   }.protect(),
   
});
/*
Name: TableCell

Description: Represents a cell element of a TableElement.

Requires:
    - DataElement

Provides:
    - TableCell

Part of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. 
http://www.processpuzzle.com

Authors: 
    - Zsolt Zsuffa

Copyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the 
GNU General Public License as published by the Free Software Foundation, either version 3 of the License, 
or (at your option) any later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/






var TableCell = new Class({
   Extends: DataElement,
   
   options: {
      componentName : "TableCell",
   },
   
   //Constructor
   initialize: function( definitionElement, bundle, data, options ){
      this.parent( definitionElement, bundle, data, options );
      
   },
   
   //Public mutators and accessor methods
   construct: function( contextElement, where ){
      this.tag = "TD";
      this.text = this.label;
      this.parent( contextElement, where );
   },
   
   destroy: function(){
      this.parent();
   },
   
   unmarshall: function(){
      this.parent();
   },

   //Properties
   
   //Protected, private helper methods
});
/*
Name: TableColumnHeader

Description: Represents the header cell element of a TableElment.

Requires:
    - DocumentElement

Provides:
    - TableColumnHeader

Part of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. 
http://www.processpuzzle.com

Authors: 
    - Zsolt Zsuffa

Copyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the 
GNU General Public License as published by the Free Software Foundation, either version 3 of the License, 
or (at your option) any later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/





var TableColumnHeader = new Class({
   Extends: DocumentElement,
   
   options: {
      bindSelector : "@bind",
      componentName : "TableColumnHeader",
      labelSelector : "@label"
   },
   
   //Constructor
   initialize: function( definitionElement, bundle, options ){
      this.parent( definitionElement, bundle, options );
      
      this.bind;
      this.label;
   },
   
   //Public mutators and accessor methods
   construct: function( contextElement, where ){
      this.tag = "TH";
      this.text = this.label;
      this.parent( contextElement, where );
   },
   
   destroy: function(){
      this.parent();
   },
   
   selectDataDefinition: function( rowData ){
      return XmlResource.selectNode( this.bind, rowData );
   },
   
   unmarshall: function(){
      this.unmarshallBind();
      this.unmarshallLabel();
      this.parent();
   },

   //Properties
   getBind: function() { return this.bind; },
   getLabel: function() { return this.label; },
   
   //Protected, private helper methods
   unmarshallBind : function(){
      this.bind = XmlResource.selectNodeText( this.options.bindSelector, this.definitionElement );
   }.protect(),
   
   unmarshallLabel : function(){
      this.label = XmlResource.selectNodeText( this.options.labelSelector, this.definitionElement );      
   }
});
/*
Name: TableElement

Description: Represents a composite constituent element of a SmartDocument which retrieves and presents data in table form from a given data source.

Requires:
    - CompositeDocumentElement, DocumentElement

Provides:
    - TableElement

Part of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. 
http://www.processpuzzle.com

Authors: 
    - Zsolt Zsuffa

Copyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the 
GNU General Public License as published by the Free Software Foundation, either version 3 of the License, 
or (at your option) any later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/





var TableElement = new Class({
   Extends: CompositeDataElement,
   Binds: ['constructBody', 'constructHeader', 'createTableElement', 'onBodyConstructed', 'onBodyConstructionError', 'onHeaderConstructed', 'onHeaderConstructionError'],
   
   options: {
      componentName : "TableElement",
      editableClass : "editableContainer",
      readOnlyClass : "readOnlyContainer"
   },
   
   //Constructor
   initialize: function( definitionElement, bundle, dataXml, options ){
      this.parent( definitionElement, bundle, dataXml, options );
      
      this.body;
      this.header;
      this.maxRowCount;
      this.tableElement;
   },
   
   //Public mutators and accessor methods
   construct: function( contextElement, where ){
      this.parent( contextElement, where );
   },
   
   destroy: function(){
      this.parent();
   },
   
   onBodyConstructed: function( body ){
      this.constructionChain.callChain();
   },
   
   onBodyConstructionError: function( error ){
      this.error = error;
      this.revertConstruction();
   },
   
   onHeaderConstructed: function( header ){
      this.constructionChain.callChain();
   },
   
   onHeaderConstructionError: function( error ){
      this.error = error;
      this.revertConstruction();
   },
   
   unmarshall: function(){
      this.parent();
   },

   //Properties
   getBody: function() { return this.body; },
   getContainerClass: function() { return this.isEditable() ? this.options.editableClass : this.options.readOnlyClass; },
   getHeader: function() { return this.header; },
   getMaxRowCount: function() { return this.maxRowCount; },
   
   //Protected, private helper methods
   compileConstructionChain: function(){
      this.constructionChain.chain(
         this.createHtmlElement, 
         this.createTableElement,
         this.injectHtmlElement, 
         this.associateEditor, 
         this.constructPlugin, 
         this.constructNestedElements, 
         this.authorization, 
         this.constructHeader,
         this.constructBody,
         this.finalizeConstruction 
      );
   }.protect(),
   
   constructBody : function(){
      this.body.construct( this.tableElement, "bottom" );
   }.protect(),
   
   constructHeader : function(){
      this.header.construct( this.tableElement, "bottom" );
   }.protect(),
   
//   constructNestedElements : function(){
//      this.parent( this.fieldsContainerElement );
//   }.protect(),
//   
   createHtmlElement : function(){
      this.tag = "div";
      this.style = this.getContainerClass();
      this.parent();
   }.protect(),
   
   createTableElement : function(){
      this.tableElement = this.elementFactory.create( "table", null, this.htmlElement, WidgetElementFactory.Positions.LastChild, { id : this.id });
      this.constructionChain.callChain();
   }.protect(),
   
   unmarshallBody: function(){
      this.body = new TableBody( this.definitionElement, this.resourceBundle, this.bindedData, this.header.getColumnHeaders(), {
         isEditable : this.isEditable(),
         onConstructed : this.onBodyConstructed, 
         onConstructionError : this.onBodyConstructionError });
      this.body.unmarshall();
   }.protect(),
   
   unmarshallDataBehaviour: function(){
      this.unmarshallDataProperties();
      this.loadDataSource();
      this.determineDataElementsNumber();
      this.unmarshallHeader();
      this.unmarshallBody();
   }.protect(),
   
   unmarshallHeader: function(){
      this.header = new TableHeader( this.definitionElement, this.resourceBundle, { onConstructed : this.onHeaderConstructed, onConstructionError : this.onHeaderConstructionError });
      this.header.unmarshall();
   }.protect()
   
});
/*
Name: TableElementEditor

Description: An inline editor, associciated with SmartDocument's TableElements.

Requires:
   - DocumentElementEditor
Provides:
    - TableElementEditor

Part of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. 
http://www.processpuzzle.com

Authors: 
    - Zsolt Zsuffa

Copyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the 
GNU General Public License as published by the Free Software Foundation, either version 3 of the License, 
or (at your option) any later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/





var TableElementEditor = new Class({
   Extends: DocumentElementEditor,
   options: {
   },
   
   //Consturctor
   initialize: function( subjectHtmlElement, options ){
      this.parent( subjectHtmlElement, options );
   }
   
   //Public accessors and mutators
   
   //Properties
   
   //Protected, private helper methods
});
/*
Name: TableHeader

Description: Represents the header row element of a TableElement.

Requires:
    - DocumentElement

Provides:
    - TableHeader

Part of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. 
http://www.processpuzzle.com

Authors: 
    - Zsolt Zsuffa

Copyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the 
GNU General Public License as published by the Free Software Foundation, either version 3 of the License, 
or (at your option) any later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/





var TableHeader = new Class({
   Extends: DocumentElement,
   Binds: ['createHeaderRowElement', 'constructColumnHeaders', 'onColumnHeaderConstructed', 'onColumnHeaderConstructionError'],
   
   options: {
      componentName : "TableHeader",
      tableColumnsSelector : "tableColumn"
   },
   
   //Constructor
   initialize: function( definitionElement, bundle, options ){
      this.parent( definitionElement, bundle, options );
      
      this.columnHeaderConstructionChain = new Chain();
      this.columnHeaders = new ArrayList();
      this.headerRowElement;
   },
   
   //Public mutators and accessor methods
   construct: function( contextElement, where ){
      this.tag = "THEAD";
      this.parent( contextElement, where );
   },
   
   destroy: function(){
      this.parent();
   },
   
   onColumnHeaderConstructed : function( columnHeader ){
      this.columnHeaderConstructionChain.callChain();
   },
   
   onColumnHeaderConstructionError : function( error ){
      this.error = error;
      this.revertConstruction();
   },
   
   unmarshall: function(){
      this.unmarshallColumnHeaders();
      this.parent();
   },

   //Properties
   getColumnHeaders: function() { return this.columnHeaders; },
   
   //Protected, private helper methods
   compileConstructionChain: function(){
      this.constructionChain.chain( 
         this.createHtmlElement,
         this.createHeaderRowElement,
         this.injectHtmlElement, 
         this.constructPlugin, 
         this.authorization, 
         this.associateEditor, 
         this.constructColumnHeaders, 
         this.finalizeConstruction 
      );
   }.protect(),
   
   constructColumnHeaders : function(){
      this.columnHeaders.each( function( columnHeader, index ){
         this.columnHeaderConstructionChain.chain(
            function(){ 
               columnHeader.construct( this.headerRowElement ); 
            }.bind( this )
         );
      }.bind( this ));
      this.columnHeaderConstructionChain.chain(
         function(){
            this.columnHeaderConstructionChain.clearChain();
            this.constructionChain.callChain(); 
         }.bind( this )
      );
      this.columnHeaderConstructionChain.callChain();
   }.protect(),
   
   createHeaderRowElement : function(){
      this.headerRowElement = this.elementFactory.create( "tr", null, this.htmlElement, WidgetElementFactory.Positions.LastChild );
      this.constructionChain.callChain(); 
   }.protect(),
   
   deleteHtmlElement : function(){
      this.headerRowElement.removeEvents();
      this.headerRowElement.destroy();
      this.parent();
   }.protect(),
   
   unmarshallColumnHeaders: function(){
      var columnHeaderDefinitions = XmlResource.selectNodes( this.options.tableColumnsSelector, this.definitionElement );
      for( var i = 0; i < columnHeaderDefinitions.length; i++ ){
         var columnHeader = new TableColumnHeader( columnHeaderDefinitions[i], this.resourceBundle, { onConstructed : this.onColumnHeaderConstructed, onConstructionError : this.onColumnHeaderConstructionError });
         columnHeader.unmarshall();
         this.columnHeaders.add( columnHeader );
      }
   }.protect(),
   
});
/*
Name: TableRow

Description: Represents the row element of a TableElement.

Requires:
    - DocumentElement

Provides:
    - TableRow

Part of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. 
http://www.processpuzzle.com

Authors: 
    - Zsolt Zsuffa

Copyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the 
GNU General Public License as published by the Free Software Foundation, either version 3 of the License, 
or (at your option) any later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/





var TableRow = new Class({
   Extends: DocumentElement,
   Binds: ['createTableRowElement', 'constructTableCells', 'onTableCellConstructed', 'onTableCellConstructionError'],
   
   options: {
      componentName : "TableRow",
      tableColumnsSelector : "tableColumn"
   },
   
   //Constructor
   initialize: function( definitionElement, bundle, rowData, columnHeaders, options ){
      this.parent( definitionElement, bundle, options );
      
      this.columnHeaders = columnHeaders;
      this.rowData = rowData;
      this.tableCellsConstructionChain = new Chain();
      this.tableCells = new ArrayList();
      this.tableRowElement;
   },
   
   //Public mutators and accessor methods
   construct: function( contextElement, where ){
      this.tag = "TR";
      this.parent( contextElement, where );
   },
   
   destroy: function(){
      this.parent();
   },
   
   onTableCellConstructed : function(){
      this.tableCellsConstructionChain.callChain();
   },
   
   onTableCellConstructionError : function( error ){
      this.error = error;
      this.revertConstruction();
   },
   
   unmarshall: function(){
      this.unmarshallTableCells();
      this.parent();
   },

   //Properties
   getTableCells : function() { return this.tableCells; },
   
   //Protected, private helper methods
   compileConstructionChain: function(){
      this.constructionChain.chain( 
         this.createHtmlElement,
         this.injectHtmlElement, 
         this.constructPlugin, 
         this.authorization, 
         this.associateEditor, 
         this.constructTableCells, 
         this.finalizeConstruction 
      );
   }.protect(),
   
   constructTableCells : function(){
      this.tableCells.each( function( tableCell, index ){
         this.tableCellsConstructionChain.chain(
            function(){ 
               tableCell.construct( this.htmlElement ); 
            }.bind( this )
         );
      }.bind( this ));
      this.tableCellsConstructionChain.chain(
         function(){
            this.tableCellsConstructionChain.clearChain();
            this.constructionChain.callChain(); 
         }.bind( this )
      );
      this.tableCellsConstructionChain.callChain();
   }.protect(),
   
   deleteHtmlElement : function(){
      this.parent();
   }.protect(),
   
   unmarshallTableCells: function(){
      this.columnHeaders.each( function( columnHeader, index ){
         var dataDefinition = columnHeader.selectDataDefinition( this.rowData );
         var tableCell = new TableCell( columnHeader.getDefinitionElement(), this.resourceBundle, dataDefinition, { 
            isEditable : this.isEditable(),
            onConstructed : this.onTableCellConstructed, 
            onConstructionError : this.onTableCellConstructionError 
         });
         tableCell.unmarshall();
         this.tableCells.add( tableCell );
      }, this );
   }.protect(),
   
});
/*
Name: UnconfiguredDocumentElementException

Description: Thrown when a DocuementElement's method is invoked but the object isn't configure appropriatelly.

Requires:

Provides:

Part of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. 
http://www.processpuzzle.com

Authors: 
	- Zsolt Zsuffa

Copyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the 
GNU General Public License as published by the Free Software Foundation, either version 3 of the License, 
or (at your option) any later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/




var UnconfiguredDocumentElementException = new Class({
   Extends: WebUIException,
   options: {
      description: "When calling method: '{methodName}' of a DocumentElement it should be in: '{statusName}' .",
      name: "UnconfiguredDocumentElementException"
   },
   
   //Constructor
   initialize : function( methodName, statusName, options ){
      this.setOptions( options );
      this.parent( options );
      this.parameters = { methodName : methodName, statusName : statusName };
   }	
});
/*
Name: 
    - SplashForm

Description: 
    - Shows an image animates the progress, while desktop load (or other long running task) finishes. 

Requires:

Provides:
    - SplashForm

Part of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. 
http://www.processpuzzle.com

Authors: 
    - Zsolt Zsuffa

Copyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the 
GNU General Public License as published by the Free Software Foundation, either version 3 of the License, 
or (at your option) any later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/




var SplashForm = new Class({
   Implements: [Events, Options],
   Binds: ['constructForm', 'finalizeConstruction', 'onImageLoaded', 'onImageLoadError', 'preloadImage'],
   options : {
      componentName : "SplashForm",
      containerElementId : "splashForm",
      imageId : "splashFormImage",
      imageTitle : "Splashform Image",
      imageUri : "Desktops/Images/SplashForm.png"
   },

   // Constructor
   initialize : function( options ) {
      this.setOptions( options );

      this.constructionChain = new Chain();
      this.containerElement = $( this.options.containerElementId );
      this.imageElement;
      this.splashFormElement;
   },

   // public accessor and mutator methods
   construct : function() {
      this.constructionChain.chain( this.preloadImage, this.constructForm, this.finalizeConstruction );
      this.constructionChain.callChain();
   },

   destroy : function() {
      this.destroyElement( this.imageElement );
      this.destroyElement( this.splashFormElement );
   },
   
   onImageLoaded : function(){
      this.constructionChain.callChain();
   },
   
   onImageLoadError : function( error ){
      this.error = error;
      this.fireEvent( 'error', error );
      this.destroy();
   },

   // Properties
   getContainerElement : function() { return this.containerElement; },
   getImageElement : function() { return this.imageElement; },
   getSplashFormElement : function() { return this.splashFormElement; },
   
   // private methods
   constructForm : function() {
      
      this.splashFormElement = new Element( 'div', {
         id : 'splashForm',
         styles : {
            left : '50%',
            position : 'absolute',
            visibility : 'hidden',
            top : '50%',
            zIndex : '999'
         }
      });
      
      this.containerElement.grab( this.splashFormElement, 'top' );
      this.splashFormElement.grab( this.imageElement );

      this.splashFormElement.setStyle( 'margin-left', -(this.splashFormElement.getStyle( 'width' ).toInt() / 2) );
      this.splashFormElement.setStyle( 'margin-top', -(this.splashFormElement.getStyle( 'height' ).toInt() / 2) );
      this.splashFormElement.setStyle( 'visibility', 'visible' );
      
      this.constructionChain.callChain();
   }.protect(),
   
   destroyElement : function( element ){
      if( element ){
         if( element.removeEvents ) element.removeEvents();
         if( element.destroy ) element.destroy();
      }
   }.protect(),
   
   finalizeConstruction : function(){
      this.constructionChain.clearChain();
      this.fireEvent( 'constructed', this );
   }.protect(),

   preloadImage : function() {
      this.imageElement = Asset.image( this.options.imageUri, { 
         id: this.options.imageId, 
         title: this.options.imageTitle,
         onAbort: function(){ this.onImageLoadError(); }.bind( this ),
         onError: function(){ this.onImageLoadError(); }.bind( this ),
         onLoad: function(){ this.onImageLoaded(); }.bind( this )
      });
   }.protect()
});
/*
ProcessPuzzle User Interface
Backend agnostic, desktop like configurable, browser font-end based on MochaUI.
Copyright (C) 2011  Joe Kueser, Zsolt Zsuffa

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/




var DuplicatedTabException = new Class({
   Extends: WebUIException,
   options: {
      description: "Tab name violates uniquness constraint.",
      name: "DuplicatedTabException",
      tabName: null
   },
   
   //Constructor
   initialize : function( options ){
      this.setOptions( options );
      this.parent( options );
   },
   
   //Properties
   getTabName: function() { return this.options.tabName; }
});
/*
 * ProcessPuzzle User Interface Backend agnostic, desktop like configurable,
 * browser font-end based on MochaUI. Copyright (C) 2012 Zsolt Zsuffa
 * 
 * This program is free software: you can redistribute it and/or modify it under
 * the terms of the GNU General Public License as published by the Free Software
 * Foundation, either version 3 of the License, or (at your option) any later
 * version.
 * 
 * This program is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
 * FOR A PARTICULAR PURPOSE. See the GNU General Public License for more
 * details.
 * 
 * You should have received a copy of the GNU General Public License along with
 * this program. If not, see <http://www.gnu.org/licenses/>.
 */




var Tab = new Class( {
   Implements : [Events, Options],
   Binds : ['onSelection'],

   options : {
      caption : null,
      captionSelector : "@caption",
      componentName : "Tab",
      currentTabId : "current",
      id : null,
      idPrefix : "tab_",
      idSelector : "@tabId",
      isDefaultSelector : "@isDefault",
      messagePropertiesSelector : "messageProperties",
      tabsStyle : "Tabs"},

   // Constructor
   initialize : function( definition, internationalization, options ) {
      // check parameter assertions
      assertThat( internationalization, not( nil() ));

      this.setOptions( options );

      // private instance variables
      this.active = false;
      this.anchorElement;
      this.caption = this.options.caption ? internationalization.getText( this.options.caption ) : null;
      this.defaultTab;
      this.definitionElement = definition;
      this.id = this.options.id;
      this.internationalization = internationalization;
      this.listItemElement;
      this.logger = Class.getInstanceOf( WebUILogger );
      this.messageProperties;
      this.visible = false;
   },

   // public mutators methods
   activate : function() {
      if( this.isVisible() ){
         this.active = true;
         this.setListItemId( this.options.currentTabId );
      }
   },

   changeCaption : function( controller ) {
      this.caption = controller.getText( this.id );
      if( this.anchorElement != null && this.anchorText != null ){
         this.anchorElement.removeChild( this.anchorText );
         var nb_caption = caption.replace( / /g, String.fromCharCode( 160 ) );
         this.anchorText = document.createTextNode( nb_caption );
         this.anchorElement.appendChild( this.anchorText );
      }
   },

   construct : function( parentElement ) {
      assertThat( parentElement, not( nil() ));
      this.createHtmlElements( parentElement );
      this.visible = true;
   },

   deActivate : function() {
      if( this.isVisible() ){
         this.active = false;
         this.setListItemId( "" );
      }
   },

   destroy : function() {
      if( this.isVisible() ) this.removeLIElement();
      this.visible = false;
      this.active = false;
   },

   equals : function( otherTab ) {
      if( !instanceOf( otherTab, Tab ) ) return false;
      return this.id.equals( otherTab.id );
   },

   onSelection : function() {
      this.activate();
      this.fireEvent( 'tabSelected', this );
   },

   unmarshall : function() {
      this.unmarshallProperties();
   },

   // Properties
   getCaption : function() { return this.caption; },
   getId : function() { return this.id; },
   getMessageProperties: function() { return this.messageProperties; },
   isActive : function() { return this.active; },
   isDefault : function() { return this.defaultTab; },
   isVisible : function() { return this.visible; },

   // private helper methods
   createHtmlElements : function( parentElement ) {
      var nb_caption = this.caption.replace( / /g, String.fromCharCode( 160 ) );
      this.anchorElement = new Element( 'a', { 'id' : this.id, 'href' : '#', events : { click : this.onSelection }});
      this.anchorElement.appendText( nb_caption );

      this.listItemElement = new Element( 'li' );
      this.listItemElement.appendChild( this.anchorElement );

      parentElement.grab( this.listItemElement, 'bottom' );
      this.logger.trace( this.options.componentName + ".createHtmlElements added a 'LI' element to represent tab: " + this.id );
   }.protect(),

   removeLIElement : function() {
      if( this.listItemElement != null ){
         if( this.anchorElement.destroy ){
            this.anchorElement.removeEvents();
            this.anchorElement.destroy();
         }else this.anchorElement.removeNode();
         
         this.anchorElement = null;

         if( this.listItemElement.destroy ) this.listItemElement.destroy();
         else this.listItemElement.removeNode();
         this.listItemElement = null;
      }else throw new UnconfiguredWidgetException({ message : "Can't remove tab's parent LI element.", source : "Tab.removeLIElement" });
   }.protect(),

   setListItemId : function( listItemId ) {
      if( this.listItemElement != null ){
         this.listItemElement.set( 'id',  listItemId );
      }else
         throw new UnconfiguredWidgetException( { message : "Can't set undefined LI element's id.", source : "Tab.setListItemId" });
   }.protect(),

   unmarshallProperties : function() {
      this.id = this.options.idPrefix + XmlResource.selectNodeText( this.options.idSelector, this.definitionElement );
      this.caption = this.internationalization.getText( XmlResource.selectNodeText( this.options.captionSelector, this.definitionElement ));
      this.defaultTab = parseBoolean( XmlResource.selectNodeText( this.options.isDefaultSelector, this.definitionElement, null, false ) );
      this.messageProperties = XmlResource.selectNodeText( this.options.messagePropertiesSelector, this.definitionElement );
   }.protect()} );
/*
Name: 
    - TabSelectedMessage

Description: 
    - Represents the event when a Tab of a TabWidget was selected.

Requires:
    - WebUIMessage
Provides:
    - TabSelectedMessage

Part of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. 
http://www.processpuzzle.com

Authors: 
    - Zsolt Zsuffa

Copyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the 
GNU General Public License as published by the Free Software Foundation, either version 3 of the License, 
or (at your option) any later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/





var TabSelectedMessage = new Class({
   Extends: WebUIMessage,
   options: {
      actionType: null,
      contextItemId : null,
      description: "A message about the event that a tab was selected.",
      documentContentURI: null,
      documentType: AbstractDocument.Types.SMART,
      documentURI: null,
      documentVariables: null,
      name: "TabSelectedMessage",
      tabId: null
   },
   
   //Constructors
   initialize: function( options ){
      this.setOptions( options );
      this.options.messageClass = TabSelectedMessage;
   },
   
   //Public accessors
   
   //Properties
   getActionType: function() { return this.options.actionType; },
   getActivityType: function() { return this.options.activityType; },
   getContextItemId: function() { return this.options.contextItemId; },
   getDocumentContentURI: function() { return this.options.documentContentURI; },
   getDocumentType: function() { return this.options.documentType; },
   getDocumentURI: function() { return this.options.documentURI; },
   getDocumentVariables: function() { return this.options.documentVariables; },
   getId: function() { return this.options.tabId; }
});

/*
 * ProcessPuzzle User Interface Backend agnostic, desktop like configurable,
 * browser font-end based on MochaUI. Copyright (C) 2011 Joe Kueser, Zsolt
 * Zsuffa
 * 
 * This program is free software: you can redistribute it and/or modify it under
 * the terms of the GNU General Public License as published by the Free Software
 * Foundation, either version 3 of the License, or (at your option) any later
 * version.
 * 
 * This program is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
 * FOR A PARTICULAR PURPOSE. See the GNU General Public License for more
 * details.
 * 
 * You should have received a copy of the GNU General Public License along with
 * this program. If not, see <http://www.gnu.org/licenses/>.
 */





var TabWidget = new Class( {
   Extends : BrowserWidget,
   Binds : ['activateDefaultTab', 'constructButtons', 'constructTabs', 'createHtmlElements', 'onClose', 'onTabSelected'],

   options : {
      TAB_LIST_STYLE : "Tabs",
      TAB_WIDGET_STYLE : "TabWidgetWrapper",
      BUTTONCLASSNAME : "Buttons",
      backgroundImage : "Images/bg.gif",
      buttonPrefix : "button_",
      closeButtonCaptionKey : "TabWidget.Close",
      componentName : "TabWidget",
      idDefault : "TabWidget",
      idSelector : "/pp:tabWidgetDefinition/tabWidget/@tabWidgetId",
      printButtonCaptionKey : "TabWidget.Print",
      selectedTabClassDefault : "selectedTab",
      selectedTabClassSelector : "/pp:tabWidgetDefinition/tabWidget/@selectedTabClass",
      showCloseButtonDefault : false,
      showCloseButtonSelector : "/pp:tabWidgetDefinition/tabWidget/@showCloseButton",
      showPrintButtonDefault : false,
      showPrintButtonSelector : "/pp:tabWidgetDefinition/tabWidget/@showPrintButton",
      tabCaptionSelector : "@caption",
      tabDefinitionSelector : "/pp:tabWidgetDefinition/tabWidget/tab",
      tabIdSelector : "@tabId",
      tabIsDefaultSelector : "@isDefault",
      tabLeftImage : "Images/DocumentTab-Left.gif",
      tabRightImage : "Images/DocumentTab-Right.gif",
      tabLeftOnImage : "Images/DocumentTab-Left-Selected.gif",
      tabRightOnImage : "Images/DocumentTab-Right-Selected.gif",
      tabsSelector : "tab",
      widgetContainerId : "TabWidget",
      widgetDefinitionSelector : "/pp:tabWidgetDefinition/tabWidget",
      widgetDefinitionURI : "TabsDefinition.xml"},

   // Constructor
   initialize : function( options, resourceBundle ) {
      this.setOptions( options );
      this.parent( options, resourceBundle );

      // Private instance variables
      this.activeTab = null;
      this.buttonsListElement;
      this.id;
      this.isVisible = false;
      this.selectedTabClass;
      this.showCloseButton;
      this.showPrintButton;
      this.tabListElement;
      this.tabs = new LinkedHashMap();
      this.tabsWrapperElement;
   },

   // Public accessor and mutator methods
   activateTab : function( tabName ) {
      if( this.activeTab != null ) this.activeTab.deActivate();
      
      var tabToActivate = this.tabs.get( tabName ); 
      tabToActivate.activate();
      this.activeTab = tabToActivate;
      this.storeComponentState();
      this.notifySubscribers();
   },

   addTab : function( id, caption, doNotActivate ) {
      if( this.state <= BrowserWidget.States.INITIALIZED ) throw new UnconfiguredWidgetException();
      if( this.tabs.get( id ) != null ) throw new DuplicatedTabException({ tabName : id });

      var newTab = new Tab( null, this.i18Resource, { id : id, caption : caption, onTabSelected : this.onTabSelected });
      this.tabs.put( newTab.getId(), newTab );
      if( this.state == BrowserWidget.States.CONSTRUCTED ) newTab.construct( this.tabListElement );

      if( doNotActivate == null || (doNotActivate != null && doNotActivate == false) )
         this.activateTab( id );
   },

   changeCaptions : function( controller ) {
      tabs.moveFirst();
      var aTab;
      while( aTab = tabs.getNext() ){
         if( aTab.changeCaption != null )
            aTab.changeCaption( controller );
      }
   },

   construct : function() {
      this.parent();
      this.isVisible = true;
   },

   destroy : function() {
      if( this.tabListElement ){
         this.tabs.each( function( entry, index ) {
            entry.getValue().destroy();
         }, this );
         if( this.tabListElement.destroy ){
            this.tabListElement.removeEvents();
            this.tabListElement.destroy();
         }else this.tabListElement.removeNode();
      }
      
      if( this.tabsWrapperElement && this.tabsWrapperElement.destroy ) this.tabsWrapperElement.destroy();

      if( this.buttonsListElement ){
         if( this.buttonsListElement.destroy ){
            this.buttonsListElement.removeEvents();
            this.buttonsListElement.destroy();
         }else this.buttonsListElement.removeNode();
      }

      this.parent();
      this.isVisible = false;
   },

   moveFirstToLast : function() {
      var tabList = null;
      if( htmlDivElement != null ){
         var tabLists = htmlDivElement.getElementsByTagName( "ul" );
         for( var i = 0; i < tabLists.length; i++ )
            if( tabLists[i].className == TAB_LIST_STYLE )
               tabList = tabLists[i];
      }
      if( tabList == null )
         return;
      var firstChild = tabList.firstChild;
      if( firstChild != null )
         tabList.appendChild( firstChild );
   },

   moveLastToFirst : function() {
      var tabList = null;
      if( htmlDivElement != null ){
         var tabLists = htmlDivElement.getElementsByTagName( "ul" );
         for( var i = 0; i < tabLists.length; i++ )
            if( tabLists[i].className == TAB_LIST_STYLE )
               tabList = tabLists[i];
      }
      if( tabList == null )
         return;
      var firstChild = tabList.firstChild;
      if( firstChild != null ){
         var lastChild = tabList.lastChild;
         if( firstChild != lastChild )
            tabList.insertBefore( lastChild, firstChild );
      }
   },

   onClose : function() {
      if( this.activeTab ){
         this.removeTab( this.activeTab.getId() );
      }
   },

   onPrint : function() {
   },

   onTabSelected : function( selectedTab ) {
      if( !selectedTab.getId().equals( this.activeTab.getId() ) ){
         this.activateTab( selectedTab.getId() );
      }
   },

   removeAllTabs : function() {
      this.tabs.each( function( entry, index ) {
         var tab = entry.getValue();
         tab.destroy();
      }, this );

      this.tabs.clear();
      this.activeTab = null;
   },

   removeTab : function( tabId ) {
      if( this.state <= BrowserWidget.States.INITIALIZED ) throw new UnconfiguredWidgetException();
      
      var nextTab = this.tabs.next( this.activeTab.getId() );
      var previousTab = this.tabs.previous( this.activeTab.getId() );

      if( nextTab != null && !nextTab.getId().equals( tabId )) this.activateTab( nextTab.getId() );
      else if( previousTab != null && !previousTab.getId().equals( tabId )) this.activateTab( previousTab.getId() );

      this.tabs.get( tabId ).destroy();
      this.tabs.remove( tabId );
      if( this.tabs.size() == 0 ) this.activeTab = null;
   },

   unmarshall: function(){
      this.unmarshallProperties();
      this.unmarshallTabs();
      this.parent();
   },

   // Properties
   activeTabId : function() { return(tabs.getCountOfObjects() > 0 ? activeTab.getId() : "undefined"); },
   getActiveTab : function() { return this.activeTab; },
   getCloseButtonId : function() { return this.options.buttonPrefix + this.options.closeButtonCaptionKey; },
   getId : function() { return this.id; },
   getPrintButtonId : function() { return this.options.buttonPrefix + this.options.printButtonCaptionKey; },
   getSelectedTabClass : function() { return this.selectedTabClass; },
   getShowCloseButton : function() { return this.showCloseButton; },
   getShowPrintButton : function() { return this.showPrintButton; },
   getTabById : function( tabId ) { return this.tabs.get( tabId ); },
   getTabCount : function() { return this.tabs.size(); },
   getTabExist : function( tabId ) { return tabs.exists( tabId ); },
   getTabs : function() { return this.tabs; },
   isCloseButtonVisible : function() { return this.showCloseButton; },
   isPrintButtonVisible : function() { return this.showPrintButton; },
   setCloseButtonVisibility : function( value ) { this.options.showCloseButton = value; },
   setPrintButtonVisibility : function( value ) { this.options.showPrintButton = value; },
   setBackgroundImage : function( image ) { backgroundImage = (image == null ? backgroundImage : image); },
   setTabLefImage : function( image ) { tabLeftImage = (image == null ? tabLeftImage : image); },
   setTabRightImage : function( image ) { tabRightImage = (image == null ? tabRightImage : image); },
   setTabLeftOnImage : function( image ) { tabLeftOnImage = (image == null ? tabLeftOnImage : image); },
   setTabRightOnImage : function( image ) { tabRightOnImage = (image == null ? tabRightOnImage : image); },

   // Private methods
   activateDefaultTab : function(){
      if( this.activeTab ) this.activateTab( this.activeTab.getId() );
      else this.activateTab( this.tabs.get( this.tabs.firstKey() ).getId() );
      this.constructionChain.callChain();
   }.protect(),

   compileConstructionChain: function(){
      this.constructionChain.chain( 
         this.createHtmlElements,
         this.constructTabs,
         this.constructButtons,
         this.activateDefaultTab,
         this.finalizeConstruction 
      );
   }.protect(),
   
   compileStateSpecification : function(){
      this.stateSpecification = { currentTabId : this.activeTab.getId() };
   }.protect(),
   
   constructButtons : function() {
      if( this.showCloseButton || this.showPrintButton ){
         this.buttonsListElement = this.elementFactory.create( 'ul', null, null, null, { 'class' : this.options.BUTTONCLASSNAME } );
         if( this.showCloseButton ) this.createButton( this.options.closeButtonCaptionKey, this.onClose );
         if( this.showPrintButton ) this.createButton( this.options.printButtonCaptionKey, this.onPrint );
      }
      this.constructionChain.callChain();
   }.protect(),

   constructTabs : function() {
      this.tabs.each( function( tabEntry, index ) {
         var tab = tabEntry.getValue();
         tab.construct( this.tabListElement );
      }, this );
      this.constructionChain.callChain();
   }.protect(),

   createButton : function( caption, onClickHandler ) {
      var listItem = this.elementFactory.create( 'li', null, this.buttonsListElement, WidgetElementFactory.Positions.LastChild );
      var anchorProperties = { href : "#", id : this.options.buttonPrefix + caption };
      this.elementFactory.createAnchor( caption.replace( / /g, String.fromCharCode( 160 ) ), null, onClickHandler, listItem, WidgetElementFactory.Positions.LastChild, anchorProperties );
   }.protect(),

   createHtmlElements : function() {
      this.tabsWrapperElement = this.elementFactory.create( 'div', null, null, null, { 'class' : this.options.TAB_WIDGET_STYLE } );
      this.tabListElement = this.elementFactory.create( 'ul', null, this.tabsWrapperElement, null, { 'class' : this.options.TAB_LIST_STYLE } );
      this.constructionChain.callChain();
   }.protect(),

   hideButtons : function() {
      if( htmlDivElement != null ){
         var tabLists = htmlDivElement.getElementsByTagName( "ul" );
         for( var i = 0; i < tabLists.length; i++ ){
            if( tabLists[i].className == BUTTONCLASSNAME ){
               var tabList = tabLists[i];
               htmlDivElement.removeChild( tabList ); // removes the list to
                                                      // 'tab' division
            }
         }
      }else
         throw new UserException( "Division not defined", "TabWidget._RemoveUnorderedListTag()" );
   }.protect(),
   
   notifySubscribers : function(){
      var argumentText = this.activeTab.getMessageProperties();
      var arguments = argumentText != null ? eval( "(" + argumentText + ")" ) : {};
      arguments['originator'] = this.options.componentName;
      arguments['tabId'] = this.activeTab.getId();
      
      var tabSelectedMessage = new TabSelectedMessage( arguments );
      this.messageBus.notifySubscribers( tabSelectedMessage );
      
   }.protect(),

   parseStateSpecification: function(){
      if( this.stateSpecification ){
         this.currentItemId = this.stateSpecification['currentTabId'];
      }
   }.protect(),
   
   removeUnorderedListTag : function() {
      if( htmlDivElement != null ){
         var tabLists = htmlDivElement.getElementsByTagName( "ul" );
         for( var i = 0; i < tabLists.length; i++ ){
            if( tabLists[i].className == this.options.TAB_LIST_STYLE ){
               var tabList = tabLists[i];
               htmlDivElement.removeChild( tabList ); // removes the list to
                                                      // 'tab' division
            }
         }
      }else
         throw new UserException( "Division not defined", "TabWidget._RemoveUnorderedListTag()" );
   }.protect(),
   
   saveComponentState : function( delimiter ) {
      var save = "";
      if( this.activeTab != null )
         save = save + delimiter + this.activeTab.caption;
      else
         save = save + delimiter + "null";
      for( var i = 1; i <= this.tabs.getCountOfObjects(); i++ ){
         var atab = this.tabs.getItemByIndex( i - 1 );
         save = save + delimiter + atab.caption + delimiter + atab.state + delimiter + atab.id;
      }
      return save;
   }.protect(),
   
   unmarshallProperties: function(){
      this.id = this.definitionXml.selectNodeText( this.options.idSelector, null, this.options.idDefault );
      this.selectedTabClass = this.definitionXml.selectNodeText( this.options.selectedTabClassSelector, null, this.options.selectedTabClassDefault );
      this.showCloseButton = parseBoolean( this.definitionXml.selectNodeText( this.options.showCloseButtonSelector, null, this.options.showCloseButtonDefault ));
      this.showPrintButton = parseBoolean( this.definitionXml.selectNodeText( this.options.showCloseButtonSelector, null, this.options.showCloseButtonDefault ));
   }.protect(),

   unmarshallTabs : function() {
      var tabDefinitions = this.definitionXml.selectNodes( this.options.tabDefinitionSelector );
      tabDefinitions.each( function( tabDefinition, index ){
         var newTab = new Tab( tabDefinition, this.i18Resource, { onTabSelected : this.onTabSelected });
         newTab.unmarshall();
         this.tabs.put( newTab.getId(), newTab );
         if( newTab.isDefault() ) this.activeTab = newTab;
      }, this );
   }.protect(),

});
/*
Name: 
    - MooEditableDialog

Description: 
    - Mediates user interactions between MooEditable and ProcessPuzzleUI. 

Requires:
    - 
    
Provides:
    - MooEditableDialog

Part of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. 
http://www.processpuzzle.com

Authors: 
    - Zsolt Zsuffa

Copyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the 
GNU General Public License as published by the Free Software Foundation, either version 3 of the License, 
or (at your option) any later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/




var MooEditableDialog = new Class({
   Implements: [Options],
   Binds: ['open'],
   options : {
      action : null,
      componentName : "MooEditableDialog",
      notification : null,
      windowName : null
   },

   //Constructor
   initialize: function( editor, options ){
      this.setOptions( options );
      
      //Private attributes
      this.editor = editor;
      this.name;
   },
   
   //Public accessor and mutator methods
   open: function(){
      switch( this.options.action ){
      case DesktopWindow.Activity.SHOW_NOTIFICATION:
         this.editor.showNotification( this.options.notification ); break;
      case DesktopWindow.Activity.SHOW_WINDOW:
         this.editor.showWindow( this.options.windowName ); break;
      }
   },
   
   prompt: function(){
      this.editor.showNotification( this.options.windowName );
   },
   
   //Properties
   isCollapsed: function() { return false; },
   
   //Protected and private helper methods
});
/*
Name: 
    - WebUIConfiguration

Description: 
    - Provides an intention revealing API to the application configuration xml.

Requires:
    - 
Provides:
    - WebUIConfiguration

Part of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. 
http://www.processpuzzle.com

Authors: 
    - Zsolt Zsuffa

Copyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the 
GNU General Public License as published by the Free Software Foundation, either version 3 of the License, 
or (at your option) any later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/





var WebUIConfiguration = new Class({
   Implements: [Class.Singleton, Options], 
   options: {
      appenderBatchSizeSelector : "wui:appenders/wui:ajaxAppender[@name='{appenderName}']/@batchSize | wui:appenders/wui:popUpAppender[@name='{appenderName}']/@batchSize | wui:appenders/wui:inPageAppender[@name='{appenderName}']/@batchSize | wui:appenders/wui:browserConsoleAppender[@name='{appenderName}']/@batchSize",
      appenderCommandLineObjectExpansionDepthSelector : "wui:appenders/wui:ajaxAppender[@name='{appenderName}']/@commandLineObjectExpansionDepth | wui:appenders/wui:popUpAppender[@name='{appenderName}']/@commandLineObjectExpansionDepth | wui:appenders/wui:inPageAppender[@name='{appenderName}']/@commandLineObjectExpansionDepth | wui:appenders/wui:browserConsoleAppender[@name='{appenderName}']/@commandLineObjectExpansionDepth",
      appenderComplainAboutPopUpBlockingSelector : "wui:appenders/wui:ajaxAppender[@name='{appenderName}']/@complainAboutPopUpBlocking | wui:appenders/wui:popUpAppender[@name='{appenderName}']/@complainAboutPopUpBlocking | wui:appenders/wui:inPageAppender[@name='{appenderName}']/@complainAboutPopUpBlocking | wui:appenders/wui:browserConsoleAppender[@name='{appenderName}']/@complainAboutPopUpBlocking",
      appenderContainerElementIdSelector : "wui:appenders/wui:ajaxAppender[@name='{appenderName}']/@containerElementId | wui:appenders/wui:popUpAppender[@name='{appenderName}']/@containerElementId | wui:appenders/wui:inPageAppender[@name='{appenderName}']/@containerElementId | wui:appenders/wui:browserConsoleAppender[@name='{appenderName}']/@containerElementId",
      appenderFailCallbackSelector : "wui:appenders/wui:ajaxAppender[@name='{appenderName}']/@failCallback | wui:appenders/wui:popUpAppender[@name='{appenderName}']/@failCallback | wui:appenders/wui:inPageAppender[@name='{appenderName}']/@failCallback | wui:appenders/wui:browserConsoleAppender[@name='{appenderName}']/@failCallback",
      appenderFocusPopUpSelector : "wui:appenders/wui:ajaxAppender[@name='{appenderName}']/@focusPopUp | wui:appenders/wui:popUpAppender[@name='{appenderName}']/@focusPopUp | wui:appenders/wui:inPageAppender[@name='{appenderName}']/@focusPopUp | wui:appenders/wui:browserConsoleAppender[@name='{appenderName}']/@focusPopUp",
      appenderHeightSelector : "wui:appenders/wui:ajaxAppender[@name='{appenderName}']/@height | wui:appenders/wui:popUpAppender[@name='{appenderName}']/@height | wui:appenders/wui:inPageAppender[@name='{appenderName}']/@height | wui:appenders/wui:browserConsoleAppender[@name='{appenderName}']/@height",
      appenderInitiallyMinimizedSelector : "wui:appenders/wui:ajaxAppender[@name='{appenderName}']/@initiallyMinimized | wui:appenders/wui:popUpAppender[@name='{appenderName}']/@initiallyMinimized | wui:appenders/wui:inPageAppender[@name='{appenderName}']/@initiallyMinimized | wui:appenders/wui:browserConsoleAppender[@name='{appenderName}']/@initiallyMinimized",
      appenderLayoutSelector : "wui:appenders/wui:ajaxAppender[@name='{appenderName}']/@layoutReference | wui:appenders/wui:popUpAppender[@name='{appenderName}']/@layoutReference | wui:appenders/wui:inPageAppender[@name='{appenderName}']/@layoutReference | wui:appenders/wui:browserConsoleAppender[@name='{appenderName}']/@layoutReference",
      appenderLazyInitSelector : "wui:appenders/wui:ajaxAppender[@name='{appenderName}']/@lazyInit | wui:appenders/wui:popUpAppender[@name='{appenderName}']/@lazyInit | wui:appenders/wui:inPageAppender[@name='{appenderName}']/@lazyInit | wui:appenders/wui:browserConsoleAppender[@name='{appenderName}']/@lazyInit",
      appenderMaxMessagesSelector : "wui:appenders/wui:ajaxAppender[@name='{appenderName}']/@maxMessages | wui:appenders/wui:popUpAppender[@name='{appenderName}']/@maxMessages | wui:appenders/wui:inPageAppender[@name='{appenderName}']/@maxMessages | wui:appenders/wui:browserConsoleAppender[@name='{appenderName}']/@maxMessages",
      appenderNameSelector : "@name",
      appenderNewestMessageAtTopSelector : "wui:appenders/wui:ajaxAppender[@name='{appenderName}']/@newestMessageAtTop | wui:appenders/wui:popUpAppender[@name='{appenderName}']/@newestMessageAtTop | wui:appenders/wui:inPageAppender[@name='{appenderName}']/@newestMessageAtTop | wui:appenders/wui:browserConsoleAppender[@name='{appenderName}']/@newestMessageAtTop",
      appenderPostVariableNameSelector : "wui:appenders/wui:ajaxAppender[@name='{appenderName}']/@postVariableName | wui:appenders/wui:popUpAppender[@name='{appenderName}']/@postVariableName | wui:appenders/wui:inPageAppender[@name='{appenderName}']/@postVariableName | wui:appenders/wui:browserConsoleAppender[@name='{appenderName}']/@postVariableName",
      appenderReopenWhenClosedSelector : "wui:appenders/wui:ajaxAppender[@name='{appenderName}']/@reopenWhenClosed | wui:appenders/wui:popUpAppender[@name='{appenderName}']/@reopenWhenClosed | wui:appenders/wui:inPageAppender[@name='{appenderName}']/@reopenWhenClosed | wui:appenders/wui:browserConsoleAppender[@name='{appenderName}']/@reopenWhenClosed",
      appenderRequestSuccessCallbackSelector : "wui:appenders/wui:ajaxAppender[@name='{appenderName}']/@requestSuccessCallback | wui:appenders/wui:popUpAppender[@name='{appenderName}']/@requestSuccessCallback | wui:appenders/wui:inPageAppender[@name='{appenderName}']/@requestSuccessCallback | wui:appenders/wui:browserConsoleAppender[@name='{appenderName}']/@requestSuccessCallback",
      appenderScrollToLatestMessageSelector : "wui:appenders/wui:ajaxAppender[@name='{appenderName}']/@scrollToLatestMessage | wui:appenders/wui:popUpAppender[@name='{appenderName}']/@scrollToLatestMessage | wui:appenders/wui:inPageAppender[@name='{appenderName}']/@scrollToLatestMessage | wui:appenders/wui:browserConsoleAppender[@name='{appenderName}']/@scrollToLatestMessage",
      appenderShowCommandLineSelector : "wui:appenders/ajaxAppender[@name='{appenderName}']/@showCommandLine | wui:appenders/wui:popUpAppender[@name='{appenderName}']/@showCommandLine | wui:appenders/wui:inPageAppender[@name='{appenderName}']/@showCommandLine | wui:appenders/wui:browserConsoleAppender[@name='{appenderName}']/@showCommandLine",
      appenderSendAllOnUnloadSelector : "wui:appenders/wui:ajaxAppender[@name='{appenderName}']/@sendAllOnUnload | wui:appenders/wui:popUpAppender[@name='{appenderName}']/@sendAllOnUnload | wui:appenders/wui:inPageAppender[@name='{appenderName}']/@sendAllOnUnload | wui:appenders/wui:browserConsoleAppender[@name='{appenderName}']/@sendAllOnUnload",
      appenderTimedSendingSelector : "wui:appenders/wui:ajaxAppender[@name='{appenderName}']/@timedSending | wui:appenders/wui:popUpAppender[@name='{appenderName}']/@timedSending | wui:appenders/wui:inPageAppender[@name='{appenderName}']/@timedSending | wui:appenders/wui:browserConsoleAppender[@name='{appenderName}']/@timedSending",
      appenderTimerIntervalSelector : "wui:appenders/wui:ajaxAppender[@name='{appenderName}']/@timerInterval | wui:appenders/wui:popUpAppender[@name='{appenderName}']/@timerInterval | wui:appenders/wui:inPageAppender[@name='{appenderName}']/@timerInterval | wui:appenders/wui:browserConsoleAppender[@name='{appenderName}']/@timerInterval",
      appenderThresholdSelector : "wui:appenders/wui:ajaxAppender[@name='{appenderName}']/@threshold | wui:appenders/wui:popUpAppender[@name='{appenderName}']/@threshold | wui:appenders/wui:inPageAppender[@name='{appenderName}']/@threshold | wui:appenders/wui:browserConsoleAppender[@name='{appenderName}']/@threshold",
      appenderTypeSelector : "wui:appenders/wui:ajaxAppender[@name='{appenderName}'] | wui:appenders/wui:popUpAppender[@name='{appenderName}'] | wui:appenders/wui:inPageAppender[@name='{appenderName}'] | wui:appenders/wui:browserConsoleAppender[@name='{appenderName}']",
      appenderURLSelector : "wui:appenders/wui:ajaxAppender[@name='{appenderName}']/@url | wui:appenders/wui:popUpAppender[@name='{appenderName}']/@url | wui:appenders/wui:inPageAppender[@name='{appenderName}']/@url | wui:appenders/wui:browserConsoleAppender[@name='{appenderName}']/@url",
      appenderUseDocumentWriteSelector : "wui:appenders/wui:ajaxAppender[@name='{appenderName}']/@useDocumentWrite | wui:appenders/wui:popUpAppender[@name='{appenderName}']/@useDocumentWrite | wui:appenders/wui:inPageAppender[@name='{appenderName}']/@useDocumentWrite | wui:appenders/wui:browserConsoleAppender[@name='{appenderName}']/@useDocumentWrite",
      appenderUseOldPopUpSelector : "wui:appenders/wui:ajaxAppender[@name='{appenderName}']/@useOldPopUp | wui:appenders/wui:popUpAppender[@name='{appenderName}']/@useOldPopUp | wui:appenders/wui:inPageAppender[@name='{appenderName}']/@useOldPopUp | wui:appenders/wui:browserConsoleAppender[@name='{appenderName}']/@useOldPopUp",
      appenderWaitForResponseSelector : "wui:appenders/wui:ajaxAppender[@name='{appenderName}']/@waitForResponse | wui:appenders/wui:popUpAppender[@name='{appenderName}']/@waitForResponse | wui:appenders/wui:inPageAppender[@name='{appenderName}']/@waitForResponse | wui:appenders/wui:browserConsoleAppender[@name='{appenderName}']/@waitForResponse",
      appenderWidthSelector : "wui:appenders/wui:ajaxAppender[@name='{appenderName}']/@width | wui:appenders/wui:popUpAppender[@name='{appenderName}']/@width | wui:appenders/wui:inPageAppender[@name='{appenderName}']/@width | wui:appenders/wui:browserConsoleAppender[@name='{appenderName}']/@width",
      applicationNameSelector : "/pp:processPuzzleConfiguration/ac:application/ac:applicationName",
      applicationVersionSelector : "/pp:processPuzzleConfiguration/ac:application/ac:version",
      availableSkinElementsSelector : "wui:desktop/wui:availableSkins/wui:skin",
      defaultSkinSelector : "wui:desktop/wui:defaultSkin/@name",
      desktopConfigurationURISelector : "/pp:processPuzzleConfiguration/wui:webUI/wui:desktop/@configurationURI",
      eraseStateWhenSkinChangeSelector : "/pp:processPuzzleConfiguration/wui:webUI/wui:desktop/@eraseStateOnSkinChange",
      i18DefaultLocaleSelector : "in:defaultLocale/text()",
      i18ElementSelector : "/pp:processPuzzleConfiguration/in:internationalization",
      i18LocaleSelector : "text()",
      i18LocaleElementsSelector : "in:availableLocales/in:locale",
      i18ResourceBundleElementsSelector : "in:resouceBundles/in:resourceBundle",
      i18ResourceBundleNameSelector : "text()",
      i18ResourceBundleNameSpaceSelector : "in:resouceBundles/@nameSpace",
      layoutElementsSelector : "wui:logging/wui:layouts/wui:patternLayout | wui:logging/wui:layouts/wui:xmlLayout",
      layoutNameSelector : "@name",
      layoutPatternSelector : "wui:layouts/wui:patternLayout[@name='{layoutName}']/@pattern | wui:layouts/wui:xmlLayout[@name='{layoutName}']/@pattern",
      loggerAppenderLayoutSelector : "wui:appender/@layout",
      loggerAppenderLevelSelector : "wui:appender/@level",
      loggerAppenderReferenceSelector : "wui:loggers/wui:logger[@name='{loggerName}']/wui:appenderReference/@name",
      loggerAppendersSelector : "wui:logging/wui:appenders/wui:ajaxAppender | wui:logging/wui:appenders/wui:popUpAppender | wui:logging/wui:appenders/wui:inPageAppender | wui:logging/wui:appenders/wui:browserConsoleAppender",
      loggerAppenderTypeSelector : "wui:appender/@type",
      loggerElementsSelector : "wui:logging/wui:loggers/wui:logger",
      loggerLayoutPatternSelector : "wui:layout/@pattern",
      loggerLayoutTypeSelector : "wui:layout/@type",
      loggerLevelSelector : "wui:loggers/wui:logger[@name='{loggerName}']/@level",
      loggerNameSelector : "@name",
      loggerIsDefaultSelector : "wui:loggers/wui:logger[@name='{loggerName}']/@isDefault",
      loggingSelector : "/pp:processPuzzleConfiguration/wui:webUI/wui:logging",
      menuDefinitionURISelector : "/pp:processPuzzleConfiguration/wui:webUI/wui:desktop/wui:menu/@definitionURI",
      nameSpaces: "xmlns:pp='http://www.processpuzzle.com' xmlns:ac='http://www.processpuzzle.com/ApplicationConfiguration' xmlns:bc='http://www.processpuzzle.com/BeanContainerConfiguration' xmlns:bd='http://www.processpuzzle.com/BusinessDefinitionsConfiguration' xmlns:bi='http://www.processpuzzle.com/BusinessImplementationsConfiguration' xmlns:dl='http://www.processpuzzle.com/DataLoadersConfiguration' xmlns:em='http://www.processpuzzle.com/EmailConfiguration' xmlns:fc='http://www.processpuzzle.com/FrontControllerConfiguration' xmlns:in='http://www.processpuzzle.com/InternationalizationConfiguration' xmlns:pr='http://www.processpuzzle.com/PersistenceConfiguration' xmlns:rt='http://www.processpuzzle.com/RuntimeConfiguration' xmlns:wui='http://www.processpuzzle.com/WebUIConfiguration'", 
      resourceBundleNameSpaceSelector : "xmlns:pp='http://www.processpuzzle.com'",
      skinConfigurationSelector : "wui:desktop/wui:availableSkins/wui:skin[@name='{skinName}']/@configurationURI",
      skinNameAttributeSelector : "@name",
      skinPathSelector : "wui:desktop/wui:availableSkins/wui:skin[@name='{skinName}']/@relativePath",
      skinPathAttributeSelector : "@relativePath",
      webUIElementSelector : "/pp:processPuzzleConfiguration/wui:webUI"
   },
   
   //Constructor
   initialize: function( configurationURI, options ) { return this.check() || this.setUp( configurationURI, options ); },
   setUp : function( configurationURI, options ) {
      this.setOptions( options );
      
      //Private instance variables
      this.applicationName;
      this.applicationVersion;
      this.availableLocales = new ArrayList();
      this.configurationURI = configurationURI;
      this.i18Element = null;
      this.isLoaded = false;
      this.loggingElement = null;
      this.xmlResource = null;
      this.webUIElement = null;
      
      this.load();
      this.determineAvailableLocales();
   },
   
   load : function(){
      if( this.isLoaded ) this.release();

      this.xmlResource = new XmlResource( this.configurationURI, { nameSpaces : this.options.nameSpaces } );
      this.i18Element = this.xmlResource.selectNode( this.options.i18ElementSelector );
      this.loggingElement = this.xmlResource.selectNode( this.options.loggingSelector );
      this.webUIElement = this.xmlResource.selectNode( this.options.webUIElementSelector );
         
      this.isLoaded = true;
   },
   
   release : function(){
      if( this.isLoaded ){
         this.i18Element = null;
         this.loggingElement = null;
         this.xmlResource = null;
         this.webUIElement = null;
         this.isLoaded = false;
      }
   },
   
   //Public mutators and accessors
   getApplicationName : function() { return this.xmlResource.selectNodeText( this.options.applicationNameSelector, this.webUIElement ); },
   getApplicationVersion : function() { return this.xmlResource.selectNodeText( this.options.applicationVersionSelector, this.webUIElement ); },
   getAvailableLocales : function() { return this.availableLocales; },
   getAvailableSkinElements : function() {return this.xmlResource.selectNodes( this.options.availableSkinElementsSelector, this.webUIElement );},
   getConfigurationElement : function() { return this.webUIElement; },
   getDefaultSkin : function() { return this.xmlResource.selectNode( this.options.defaultSkinSelector, this.webUIElement ).nodeValue; },
   getEraseStateWhenSkinChange : function() { return parseBoolean( this.xmlResource.selectNodeText( this.options.eraseStateWhenSkinChangeSelector, this.webUIElement, false )); },
   getI18DefaultLocale : function() { return this.xmlResource.selectNode( this.options.i18DefaultLocaleSelector, this.i18Element ).nodeValue; },
   getI18Element : function() { return this.i18Element; },
   getI18Locale : function( localeIndex ){
      return this.xmlResource.selectNode( this.options.i18LocaleSelector, this.getI18LocaleElements()[localeIndex] ).nodeValue;
   },
   
   getI18LocaleElements : function() {return this.xmlResource.selectNodes( this.options.i18LocaleElementsSelector, this.i18Element );},
   getI18ResourceBundleElements : function() { return this.xmlResource.selectNodes( this.options.i18ResourceBundleElementsSelector, this.i18Element ); },
   
   getI18ResourceBundleName : function( resourceBundleIndex ){
      return this.xmlResource.selectNode( this.options.i18ResourceBundleNameSelector, this.getI18ResourceBundleElements()[resourceBundleIndex] ).nodeValue;
   },
   
   getI18ResourceBundleNameSpace : function() {
      return this.xmlResource.selectNode( this.options.i18ResourceBundleNameSpaceSelector, this.i18Element ).value;
   },
   
   getLoggerAppenderElement : function() {
      return this.xmlResource.selectNode( this.options.loggerAppenderSelector, this.webUIElement );
   },
   
   getLoggerAppenderType : function() { 
      return this.xmlResource.selectNode( this.options.loggerAppenderTypeSelector, this.loggingElement ).value;
   },
   
   getLoggerElements : function() {
      return this.xmlResource.selectNodes( this.options.loggerElementsSelector, this.webUIElement );
   },
   
   getLoggerLayoutElement : function() { 
      return this.xmlResource.selectNode( this.options.loggerLayoutSelector, this.loggingElement );
   },
   
   getLoggerLayoutPattern : function() { 
      return this.xmlResource.selectNode( this.options.loggerLayoutPatternSelector, this.loggingElement ).value;
   },
   
   getLoggerLayoutType : function() { 
      return this.xmlResource.selectNode( this.options.loggerLayoutTypeSelector, this.loggingElement ).value;
   },
   
   getLoggerLevel : function( loggerName ) {
      var selectorExp = this.options.loggerLevelSelector.substitute( {loggerName : loggerName} );
      return this.xmlResource.selectNode( selectorExp, this.loggingElement ).value;
   },
   
   getLoggerName : function( loggerIndex ) {
      var loggerElements = this.getLoggerElements();
      return this.xmlResource.selectNode( this.options.loggerNameSelector, loggerElements[loggerIndex] ).value;
   },

   getLoggingAppenderBatchSize : function( appenderName ) {
      var selectorExp = this.options.appenderBatchSizeSelector.substitute( {appenderName : appenderName} );
      var selectedElement = this.xmlResource.selectNode( selectorExp, this.loggingElement ); 
      if( selectedElement ) return selectedElement.value;
      else return null;
	},
   
   getLoggingAppenderCommandLineObjectExpansionDepth : function( appenderName ) {
      var selectorExp = this.options.appenderCommandLineObjectExpansionDepthSelector.substitute( {appenderName : appenderName} );
      var selectedElement = this.xmlResource.selectNode( selectorExp, this.loggingElement ); 
      if( selectedElement ) return selectedElement.value;
      else return null;
   },
   
   getLoggingAppenderComplainAboutPopUpBlocking : function( appenderName ) {
      return this.determineLoggingElementValue( this.options.appenderComplainAboutPopUpBlockingSelector.substitute( {appenderName : appenderName} ) );
   },

   getLoggingAppenderContainerElementId : function( appenderName ) {
      return this.determineLoggingElementValue( this.options.appenderContainerElementIdSelector.substitute( {appenderName : appenderName} ) );
   },

   getLoggingAppenderElements : function() {
      return this.xmlResource.selectNodes( this.options.loggerAppendersSelector, this.webUIElement );
   },

   getLoggingAppenderFailCallback : function( appenderName ) {
      var selectorExp = this.options.appenderFailCallbackSelector.substitute( {appenderName : appenderName} );
      var selectedElement = this.xmlResource.selectNode( selectorExp, this.loggingElement ); 
      if( selectedElement ) return selectedElement.value;
      else return null;
	},
   
   getLoggingAppenderFocusPopUp : function( appenderName ) {
      var selectorExp = this.options.appenderFocusPopUpSelector.substitute( {appenderName : appenderName} );
      var selectedElement = this.xmlResource.selectNode( selectorExp, this.loggingElement ); 
      if( selectedElement ) return selectedElement.value;
      else return null;
   },

   getLoggingAppenderHeight : function( appenderName ) {
      return parseInt( this.determineLoggingElementValue( this.options.appenderHeightSelector.substitute( {appenderName : appenderName} )));
   },

   getLoggingAppenderInitiallyMinimized : function( appenderName ) {
      var configurationValue = this.determineLoggingElementValue( this.options.appenderInitiallyMinimizedSelector.substitute( {appenderName : appenderName} ));
      return new Boolean().parseBoolean( configurationValue );
   },

   getLoggingAppenderLazyInit : function( appenderName ) {
      var selectorExp = this.options.appenderLazyInitSelector.substitute( {appenderName : appenderName} );
      var selectedElement = this.xmlResource.selectNode( selectorExp, this.loggingElement ); 
      if( selectedElement ) return selectedElement.value;
      else return null;
   },

   getLoggingAppenderLayoutReference : function( appenderName ) { 
      var selectorExp = this.options.appenderLayoutSelector.substitute( {appenderName : appenderName} );
      return this.xmlResource.selectNode( selectorExp, this.loggingElement ).value;
   },
   
   getLoggingAppenderMaxMessages : function( appenderName ) {
      var selectorExp = this.options.appenderMaxMessagesSelector.substitute( {appenderName : appenderName} );
      var selectedElement = this.xmlResource.selectNode( selectorExp, this.loggingElement ); 
      if( selectedElement ) return selectedElement.value;
      else return null;
   },

   getLoggingAppenderName : function( appenderIndex ) {
      var appenderElements = this.getLoggingAppenderElements();
      return this.xmlResource.selectNode( this.options.appenderNameSelector, appenderElements[appenderIndex] ).value;
   },

   getLoggingAppenderNewestMessageAtTop : function( appenderName ) {
      var selectorExp = this.options.appenderNewestMessageAtTopSelector.substitute( {appenderName : appenderName} );
      var selectedElement = this.xmlResource.selectNode( selectorExp, this.loggingElement ); 
      if( selectedElement ) return selectedElement.value;
      else return null;
   },

   getLoggingAppenderPostVariableName : function( appenderName ) {
      var selectorExp = this.options.appenderPostVariableNameSelector.substitute( {appenderName : appenderName} );
      var selectedElement = this.xmlResource.selectNode( selectorExp, this.loggingElement ); 
      if( selectedElement ) return selectedElement.value;
      else return null;
	},

   getLoggingAppenderReopenWhenClosed : function( appenderName ) {
      var selectorExp = this.options.appenderReopenWhenClosedSelector.substitute( {appenderName : appenderName} );
      var selectedElement = this.xmlResource.selectNode( selectorExp, this.loggingElement ); 
      if( selectedElement ) return selectedElement.value;
      else return null;
   },

   getLoggingAppenderRequestSuccessCallback : function( appenderName ) {
      var selectorExp = this.options.appenderRequestSuccessCallbackSelector.substitute( {appenderName : appenderName} );
      var selectedElement = this.xmlResource.selectNode( selectorExp, this.loggingElement ); 
      if( selectedElement ) return selectedElement.value;
      else return null;
	},
	
   getLoggingAppenderScrollToLatestMessage : function( appenderName ) {
      var selectorExp = this.options.appenderScrollToLatestMessageSelector.substitute( {appenderName : appenderName} );
      var selectedElement = this.xmlResource.selectNode( selectorExp, this.loggingElement ); 
      if( selectedElement ) return selectedElement.value;
      else return null;
   },

   getLoggingAppenderSendAllOnUnload : function( appenderName ) {
      var selectorExp = this.options.appenderSendAllOnUnloadSelector.substitute( {appenderName : appenderName} );
      var selectedElement = this.xmlResource.selectNode( selectorExp, this.loggingElement ); 
      if( selectedElement ) return selectedElement.value;
      else return null;
   },

   getLoggingAppenderShowCommandLine : function( appenderName ) {
      var selectorExp = this.options.appenderShowCommandLineSelector.substitute( {appenderName : appenderName} );
      var selectedElement = this.xmlResource.selectNode( selectorExp, this.loggingElement ); 
      if( selectedElement ) return selectedElement.value;
      else return null;
   },

   getLoggingAppenderThreshold : function( appenderName ) { 
      return this.determineLoggingElementValue( this.options.appenderThresholdSelector.substitute( {appenderName : appenderName} ));
   },
   
   getLoggingAppenderTimedSending : function( appenderName ) {
      var selectorExp = this.options.appenderTimedSendingSelector.substitute( {appenderName : appenderName} );
      var selectedElement = this.xmlResource.selectNode( selectorExp, this.loggingElement ); 
      if( selectedElement ) return selectedElement.value;
      else return null;
	},

   getLoggingAppenderTimerInterval : function( appenderName ) {
      var selectorExp = this.options.appenderTimerIntervalSelector.substitute( {appenderName : appenderName} );
      var selectedElement = this.xmlResource.selectNode( selectorExp, this.loggingElement ); 
      if( selectedElement ) return selectedElement.value;
      else return null;
	},

   getLoggingAppenderType : function( appenderName ) {
      var selectorExp = this.options.appenderTypeSelector.substitute( {appenderName : appenderName} );
      var selectedElement = this.xmlResource.selectNode( selectorExp, this.loggingElement ); 
      if( selectedElement ) return selectedElement.nodeName;
      else return null;
   },
   
	getLoggingAppenderURL : function( appenderName ) {
      var selectorExp = this.options.appenderURLSelector.substitute( {appenderName : appenderName} );
      var selectedElement = this.xmlResource.selectNode( selectorExp, this.loggingElement ); 
      if( selectedElement ) return selectedElement.value;
      else return null;
   },

   getLoggingAppenderUseDocumentWrite : function( appenderName ) {
      return this.determineLoggingElementValue( this.options.appenderUseDocumentWriteSelector.substitute( {appenderName : appenderName} ) );
   },

   getLoggingAppenderUseOldPopUp : function( appenderName ) {
      var selectorExp = this.options.appenderUseOldPopUpSelector.substitute( {appenderName : appenderName} );
      var selectedElement = this.xmlResource.selectNode( selectorExp, this.loggingElement ); 
      if( selectedElement ) return selectedElement.value;
      else return null;
   },

   getLoggingAppenderWaitForResponse : function( appenderName ) {
      var selectorExp = this.options.appenderWaitForResponseSelector.substitute( {appenderName : appenderName} );
      var selectedElement = this.xmlResource.selectNode( selectorExp, this.loggingElement ); 
      if( selectedElement ) return selectedElement.value;
      else return null;
	},
   
   getLoggingAppenderWidth : function( appenderName ) {
      return parseInt( this.determineLoggingElementValue( this.options.appenderWidthSelector.substitute( {appenderName : appenderName} )));
   },

	getLoggingLayoutName : function( layoutIndex ) {
      var layoutElements = this.getLoggingLayoutElements();
      return this.xmlResource.selectNode( this.options.layoutNameSelector, layoutElements[layoutIndex] ).value;
   },
   
   getLoggingLayoutElements : function() {
      return this.xmlResource.selectNodes( this.options.layoutElementsSelector, this.webUIElement );
   },
   
   getLoggingLayoutPattern : function( layoutName ) { 
      var selectorExp = this.options.layoutPatternSelector.substitute( {layoutName : layoutName} );
      return this.xmlResource.selectNode( selectorExp, this.loggingElement ).value;
   },
   
   getLoggingLoggerAppenderReference : function( loggerName ) {
      var selectorExp = this.options.loggerAppenderReferenceSelector.substitute( {loggerName : loggerName} );
      return this.xmlResource.selectNode( selectorExp, this.loggingElement ).value;
   },
   
   getLoggingLoggerIsDefault : function( loggerName ) {
      return this.determineLoggingElementValue( this.options.loggerIsDefaultSelector.substitute( {loggerName : loggerName} ));
   },
   
   getMenuDefinitionURI : function() { return this.xmlResource.selectNode( this.options.menuDefinitionURISelector ).nodeValue; },
   
   getSkinConfiguration : function( skinName ) {
      var selectorExp = this.options.skinConfigurationSelector.substitute( {skinName : skinName} );
      return this.xmlResource.selectNode( selectorExp, this.webUIElement ).value;
   },
      
   getSkinNameByIndex : function( skinIndex ) {
      var skinElements = this.getAvailableSkinElements();
      return this.xmlResource.selectNode( this.options.skinNameAttributeSelector, skinElements[skinIndex] ).value;
   },
      
   getSkinPath : function( skinName ) {
      var selectorExp = this.options.skinPathSelector.substitute( {skinName : skinName} );
      return this.xmlResource.selectNode( selectorExp, this.webUIElement ).value;
   },
      
   getSkinPathByIndex : function( skinIndex ) {
      var skinElements = this.getAvailableSkinElements();
      return this.xmlResource.selectNode( this.options.skinPathAttributeSelector, skinElements[skinIndex] ).value;
   },
   
   isSupportedLocale: function( localeInQuestion ){
      var isSupported = false;
      this.availableLocales.each( function( locale, index ){
         if( localeInQuestion.equals( locale )) isSupported = true;
      }.bind( this ));
      return isSupported;
   },
      
   //Private helper methods
   determineAvailableLocales : function(){
      for( var i = 0; i < this.getI18LocaleElements().length; i++ ) {
         var i18LocaleText = this.getI18Locale( i );
         var locale = new ProcessPuzzleLocale();
         locale.parse( i18LocaleText );
         this.availableLocales.add( locale );
      }
   }.protect(),
   
   determineLoggingElementValue : function( selectorExp ) {
      var selectedElement = this.xmlResource.selectNode( selectorExp, this.loggingElement ); 
      if( selectedElement ) return selectedElement.value;
      else return null;
   } 
});

SYSTEM_WINDOWS = { 
   ABOUT : 'about',
   DOCUMENT_EXPLORER : 'documentExplorer'
};
/*
Name: 
    - TextAreaEditor

Description: 
    - Provides text editing features for text areas. The edited area can be a whole HTML document or just a text area component of a SmartDocument. 

Requires:
    - MooEditable, DocumentEditor
    
Provides:
    - TextAreaEditor

Part of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. 
http://www.processpuzzle.com

Authors: 
    - Zsolt Zsuffa

Copyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the 
GNU General Public License as published by the Free Software Foundation, either version 3 of the License, 
or (at your option) any later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/







var TextAreaEditor = new Class({
   Extends: DocumentEditor,
   Binds: ['onDocumentSelectedMessage', 'onEditorClick', 'onMooEditableAttach'],
   options : {
      componentName : "TextAreaEditor",
      createLinkAlert : "selectionNeeded",
      createLinkPromt : SYSTEM_WINDOWS.DOCUMENT_EXPLORER,
      dimensions : { x : 500, y : 100 },
      numberOfColumns : 120,
      numberOfRows : 50,
      urlImagePromt : SYSTEM_WINDOWS.DOCUMENT_EXPLORER,
   },

   //Constructor
   initialize: function( internationalization, options ){
      this.parent( internationalization, options );
      
      //Private attributes
      this.initialContent;
      this.mooEditable;
   },
   
   //Public accessor and mutator methods
   attach: function( subjectElement, initialContent ){
      this.initialContent = initialContent;
      this.parent( subjectElement );
   },
   
   detach: function(){
      this.mooEditable.detach();
      this.parent();
   },
   
   onContainerResize: function( newSize ){
      this.mooEditable.onContainerResize( newSize );
   },
   
   onDocumentSelectedMessage: function( webUIMessage ){
      this.mooEditable.execute( 'createlink', null, webUIMessage.getDocumentURI() );
   },
   
   onEditorClick: function( event, editor ){
      var subjectElement = event.target;
      
      if( subjectElement.get( 'tag' ).toUpperCase() != 'A' && subjectElement.getParent().get( 'tag' ).toUpperCase() == 'A' ){
         subjectElement = subjectElement.getParent();
      }
      
      if( subjectElement.get( 'tag' ).toUpperCase() == 'A' ){
         if( subjectElement.get( 'onclick' ) ){
            eval( subjectElement.get( 'onclick' ));
         }else if( subjectElement.get( 'href' )){
            document.location.href = subjectElement.get( 'href' );
         }
      }
   },
   
   onMooEditableAttach: function(){
      this.attachChain.callChain();
   },
   
   textAddImage: function(){ this.mooEditable.action( 'urlimage', [] ); },
   textAddLink: function(){ this.mooEditable.action( 'createlink', [] ); },
   textAlignCenter: function(){ this.mooEditable.action( 'justifycenter', [] ); },
   textAlignLeft: function(){ this.mooEditable.action( 'justifyleft', [] ); },
   textAlignJustify: function(){ this.mooEditable.action( 'justifyfull', [] ); },
   textAlignRight: function(){ this.mooEditable.action( 'justifyright', [] ); },
   textBold: function(){ this.mooEditable.action( 'bold', [] ); },
   textIndent: function(){ this.mooEditable.action( 'indent', [] ); },
   textItalic: function(){ this.mooEditable.action( 'italic', [] ); },
   textOrderedList: function(){ this.mooEditable.action( 'insertorderedlist', [] ); },
   textOutdent: function(){ this.mooEditable.action( 'outdent', [] ); },
   textRedo: function(){ this.mooEditable.action( 'redo', [] ); },
   textRemoveLink: function(){ this.mooEditable.action( 'unlink', [] ); },
   textStrikethrough: function(){ this.mooEditable.action( 'strikethrough', [] ); },
   textToggleView: function(){ this.mooEditable.action( 'toggleview', [] ); },
   textUnderline: function(){ this.mooEditable.action( 'underline', [] ); },
   textUndo: function(){ this.mooEditable.action( 'undo', [] ); },
   textUnorderedList: function(){ this.mooEditable.action( 'insertunorderedlist', [] ); },
   
   //Properties
   getMooEditable: function() { return this.mooEditable; },
   
   //Protected and private helper methods   
   defineDialogWindows: function(){
      MooEditable.Actions.createlink.dialogs.alert = function( callerObject ) { 
         return new MooEditableDialog( this, { action : DesktopWindow.Activity.SHOW_NOTIFICATION, notification : this.options.createLinkAlert }); 
      }.bind( this );
      
      MooEditable.Actions.createlink.dialogs.prompt = function(  callerObject ) { 
         return new MooEditableDialog( this, { action : DesktopWindow.Activity.SHOW_WINDOW, windowName : this.options.createLinkPromt }); 
      }.bind( this );
      
      MooEditable.Actions.urlimage.dialogs.prompt = function( callerObject ) { 
         return new MooEditableDialog( this, {  action : DesktopWindow.Activity.SHOW_WINDOW, windowName : this.options.urlImagePromt }); 
      }.bind( this );
   }.protect(),
   
   instantiateTools: function(){
      this.defineDialogWindows();
      var styleSheetLinks = "";
      this.styleSheets.each( function( styleSheetUri, index ){
         styleSheetLinks += "<link rel='stylesheet' type='text/css' href='" + styleSheetUri + "'>";
      }, this );
      
      this.mooEditable = new MooEditable( this.subjectElement, { 
         externalCSS : styleSheetLinks,
         handleDialogs : false, 
         handleLabel : false, 
         handleSubmit : false,
         onAttach: this.onMooEditableAttach,
         onEditorClick : this.onEditorClick,
         toolbar : false
      });
   }.protect(),
});
/*
Name: 
    - ToolBarButton

Description: 
    - Represents a button in a toolbar. It's a component of a ToolBar. 

Requires:

Provides:
    - ToolBarButton

Part of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. 
http://www.processpuzzle.com

Authors: 
    - Zsolt Zsuffa

Copyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the 
GNU General Public License as published by the Free Software Foundation, either version 3 of the License, 
or (at your option) any later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/




var ToolBarButton = new Class({
   Implements : [Events, Options],
   Binds: ['onSelection'],
   
   options : {
      buttonStyle : "toolBarButton",
      captionSelector : "caption",
      iconImageSelector : "iconImage",
      messagePropertiesSelector : "messageProperties",
      nameSelector : "@name",
      showCaption : false,
      toolTipStyle : "toolBarToolTip"
   },

   //Constructor
   initialize: function( definition, elementFactory, options ){
      this.setOptions( options );
      this.anchorElement;
      this.definitionXml = definition;
      this.caption;
      this.factory = elementFactory;
      this.iconImageUri;
      this.imageElement;
      this.listItemElement;
      this.messageProperties;
      this.name = new Date().getTime();
      this.parentElement;
      this.spanElement;
      this.state = ToolBarButton.States.INITIALIZED;
      this.toolTipElement;
   },
   
   //Public accessor and mutator methods
   construct: function( parentElement ){
      assertThat( parentElement, not( nil() ));
      this.parentElement = parentElement;
      this.instantiateHtmlElements();
      this.state = ToolBarButton.States.CONSTRUCTED;
   },
   
   destroy: function(){
      if( this.toolTipElement && this.toolTipElement.destroy ) this.toolTipElement.destroy();
      if( this.imageElement && this.imageElement.destroy ) this.imageElement.destroy();
      if( this.spanElement && this.spanElement.destroy ) this.spanElement.destroy();
      if( this.anchorElement && this.anchorElement.destroy ) this.anchorElement.destroy();
      if( this.listItemElement && this.listItemElement.destroy ) this.listItemElement.destroy();
      this.state = ToolBarButton.States.INITIALIZED;
   },
   
   onSelection: function(){
      this.fireEvent( 'onSelection', this );
   },
   
   unmarshall: function(){
      this.unmarshallProperties();
      this.state = ToolBarButton.States.UNMARSHALLED;
   },
   
   //Properties
   getCaption: function() { return this.caption; },
   getIconImage: function() { return this.iconImageUri; },
   getMessageProperties: function() { return this.messageProperties; },
   getName: function() { return this.name; },
   getParentElement: function() { return this.parentElement; },
   getState: function() { return this.state; },
   
   //Protected, private helper methods
   instantiateHtmlElements: function(){
      var buttonTitle = this.options.showCaption ? this.caption : "";
      this.listItemElement = this.factory.create( 'li', null, this.parentElement, WidgetElementFactory.Positions.lastChild, { id : this.name } );
      this.anchorElement = this.factory.createAnchor( buttonTitle, null, this.onSelection, this.listItemElement, WidgetElementFactory.Positions.lastChild );
      this.spanElement = this.factory.create( 'span', null, this.anchorElement, WidgetElementFactory.Positions.lastChild, { 'class' : this.options.buttonStyle });
      this.imageElement = this.factory.create( 'img', null, this.spanElement, WidgetElementFactory.Positions.lastChild, { src : this.iconImageUri, alt : buttonTitle });
      this.toolTipElement = this.factory.create( 'span', this.caption, this.anchorElement, WidgetElementFactory.Positions.lastChild, { 'class' : this.options.toolTipStyle });
   },
   
   unmarshallProperties: function(){
      this.caption = XmlResource.selectNodeText( this.options.captionSelector, this.definitionXml );
      this.iconImageUri = XmlResource.selectNodeText( this.options.iconImageSelector, this.definitionXml );
      this.messageProperties = XmlResource.selectNodeText( this.options.messagePropertiesSelector, this.definitionXml );
      this.name = XmlResource.selectNodeText( this.options.nameSelector, this.definitionXml );
   }.protect(),
});

ToolBarButton.States = { UNINITIALIZED : 0, INITIALIZED : 1, UNMARSHALLED : 2, CONSTRUCTED : 3 };
/*
Name: ToolBarButtonFactory

Description: Instantiates a new subclass of ToolBarButton according to the given XML element.

Requires:

Provides:
    - ToolBarButtonFactory

Part of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. 
http://www.processpuzzle.com

Authors: 
    - Zsolt Zsuffa

Copyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the 
GNU General Public License as published by the Free Software Foundation, either version 3 of the License, 
or (at your option) any later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/




var ToolBarButtonFactory = new Class({
   Implements: Options,
   
   options: {   
   },
   
   initialize: function(){
   },

   create: function( definitionXmlElement, htmlElementFactory, options ){
      var newButton;
      switch( definitionXmlElement.tagName.toUpperCase() ){
      case "DIVIDER": 
         newButton = new ToolBarDivider( definitionXmlElement, htmlElementFactory, options ); break;
      case "BUTTON":
      default:
         newButton = new ToolBarButton( definitionXmlElement, htmlElementFactory, options ); break;
      }
      
      return newButton;
   }
});

ToolBarButtonFactory.create = function(  definitionXmlElement, htmlElementFactory, options ){
   var factory = new ToolBarButtonFactory();
   var button = factory.create( definitionXmlElement, htmlElementFactory, options );
   return button;
};
/*
Name: 
    - ToolBarDivider

Description: 
    - Represents a divider in a tool bar. It's a component of a ToolBar. 

Requires:

Provides:
    - ToolBarDivider

Part of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. 
http://www.processpuzzle.com

Authors: 
    - Zsolt Zsuffa

Copyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the 
GNU General Public License as published by the Free Software Foundation, either version 3 of the License, 
or (at your option) any later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/




var ToolBarDivider = new Class({
   Implements : Options,
   
   options : {
      dividerStyle : "toolBarDivider",
      iconImageSelector : "iconImage",
      dividerIconImageUri : "Desktops/Images/ToolboxDivider.jpg",
      namePrefix : "divider_"
   },

   //Constructor
   initialize: function( definition, elementFactory, options ){
      this.setOptions( options );
      this.definitionXml = definition;
      this.factory = elementFactory;
      this.dividerIconImageUri;
      this.imageElement;
      this.listItemElement;
      this.name = UniqueId.generate( this.options.namePrefix );
      this.parentElement;
      this.state = ToolBarButton.States.INITIALIZED;
      this.toolTipElement;
   },
   
   //Public accessor and mutator methods
   construct: function( parentElement ){
      assertThat( parentElement, not( nil() ));
      this.parentElement = parentElement;
      this.instantiateHtmlElements();
      this.state = ToolBarButton.States.CONSTRUCTED;
   },
   
   destroy: function(){
      if( this.imageElement && this.imageElement.destroy ) this.imageElement.destroy();
      if( this.spanElement && this.spanElement.destroy ) this.spanElement.destroy();
      if( this.listItemElement && this.listItemElement.destroy ) this.listItemElement.destroy();
      this.state = ToolBarButton.States.INITIALIZED;
   },
   
   onSelection: function(){
      
   },
   
   unmarshall: function(){
      this.unmarshallProperties();
      this.state = ToolBarButton.States.UNMARSHALLED;
   },
   
   //Properties
   getIconImage: function() { return this.dividerIconImageUri; },
   getName: function() { return this.name; },
   getParentElement: function() { return this.parentElement; },
   getState: function() { return this.state; },
   
   //Protected, private helper methods
   instantiateHtmlElements: function(){
      this.listItemElement = this.factory.create( 'li', null, this.parentElement, WidgetElementFactory.Positions.lastChild, { id : this.name } );
      this.spanElement = this.factory.create( 'span', null, this.listItemElement, WidgetElementFactory.Positions.lastChild, { 'class' : this.options.dividerStyle });
      this.imageElement = this.factory.create( 'img', null, this.spanElement, WidgetElementFactory.Positions.lastChild, { src : this.dividerIconImageUri });
   },
   
   unmarshallProperties: function(){
      this.dividerIconImageUri = XmlResource.selectNodeText( this.options.iconImageSelector, this.definitionXml, null, this.options.dividerIconImageUri );
   }.protect(),
});
/*
Name: 
    - ToolBarWidget

Description: 
    - Represents a toolbar which is a user interface for user actions. 

Requires:
    - ToolBarButton
    
Provides:
    - ToolBarWidget

Part of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. 
http://www.processpuzzle.com

Authors: 
    - Zsolt Zsuffa

Copyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the 
GNU General Public License as published by the Free Software Foundation, either version 3 of the License, 
or (at your option) any later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */





var ToolBarWidget = new Class({
   Extends : BrowserWidget,
   Binds : ['onButtonSelection'],
   options : {
      buttonsSelector : "/toolBarDefinition/buttons/button | /toolBarDefinition/buttons/divider",
      componentName : "ToolBarWidget",
      descriptionSelector : "/toolBarDefinition/description", 
      dividerIconImageUri : "Desktops/Images/ToolboxDivider.jpg",
      listStyleSelector : "/toolBarDefinition/buttons/@elementStyle",
      nameSelector : "/toolBarDefinition/name",
      showCaptionsSelector : "/toolBarDefinition/showCaptions"
   },

   //Constructor
   initialize: function( options, internationalization ){
      //this.setOptions( options );
      this.parent( options, internationalization );
      
      //Private attributes
      this.buttons = new LinkedHashMap();
      this.description;
      this.dividers = new ArrayList();
      this.name;
      this.listElement;
      this.listStyle;
      this.showCaptions = false;
      this.wrapperElement;
   },
   
   //Public accessor and mutator methods
   construct: function(){
      this.constructHtmlElements();
      this.constructButtons();
      return this.parent();
   },
   
   destroy: function(){
      this.destroyButtons();
      this.destroyDividers();
      if( this.listElement && this.listElement.destroy ) this.listElement.destroy();
      if( this.wrapperElement && this.wrapperElement.destroy ) this.wrapperElement.destroy();
      this.parent();
   },
   
   onButtonSelection: function( button ){
      var argumentText = button.getMessageProperties();
      var arguments = argumentText != null ? eval( "(" + argumentText + ")" ) : null;
      arguments['originator'] = this.name;
      
      this.messageBus.notifySubscribers( new MenuSelectedMessage( arguments ));
   },
   
   unmarshall: function(){
      this.unmarshallProperties();
      this.unmarshallButtons();
      return this.parent();
   },
   
   //Properties
   getButtons: function() { return this.buttons; },
   getDescription: function() { return this.description; },
   getListStyle: function() { return this.listStyle; },
   getName: function() { return this.name; },
   
   //Protected and private helper methods
   constructButtons: function(){
      this.buttons.each( function( buttonEntry, index ){
         var toolBarButton = buttonEntry.getValue();
         toolBarButton.construct( this.listElement );
      }, this );
   }.protect(),
   
   constructHtmlElements: function(){
      this.wrapperElement = this.elementFactory.create( 'div', null, this.containerElement, WidgetElementFactory.Positions.LastChild, { id : this.name });
      this.listElement = this.elementFactory.create( 'ul', null, this.wrapperElement, WidgetElementFactory.Positions.LastChild, { 'class' : this.listStyle } );
   }.protect(),
   
   destroyButtons: function(){
      this.buttons.each( function( buttonEntry, index ) {
         var button = buttonEntry.getValue();
         button.destroy();
      }, this );
      
      this.buttons.clear();
   }.protect(),
   
   destroyDividers: function(){
      this.buttons.each( function( divider, index ) {
         divider.destroy();
      }, this );
      
      this.buttons.clear();
   }.protect(),
   
   unmarshallButtons: function(){
      var buttonDefinitions = this.definitionXml.selectNodes( this.options.buttonsSelector );
      buttonDefinitions.each( function( buttonDefinition, index ){
         var toolBarButton = ToolBarButtonFactory.create( buttonDefinition, this.elementFactory, { onSelection : this.onButtonSelection, showCaption : this.showCaptions, dividerIconImageUri : this.options.dividerIconImageUri } );
         toolBarButton.unmarshall();
         this.buttons.put( toolBarButton.getName(), toolBarButton );
      }, this );
   }.protect(),
   
   unmarshallProperties: function(){
      this.description = this.definitionXml.selectNodeText( this.options.descriptionSelector );
      this.listStyle = this.definitionXml.selectNodeText( this.options.listStyleSelector );
      this.name = this.definitionXml.selectNodeText( this.options.nameSelector );
      this.showCaptions = parseBoolean( this.definitionXml.selectNodeText( this.options.showCaptionsSelector, null, false ));
   }.protect()

});
/*
Name:
    - TreeNodeType
    
Description: 
    - Clamps shared properties of tree node instances.
    
Requires:
    - BrowserWidget
    
Provides:
    - TreeNodeType

Part of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. 
http://www.processpuzzle.com

Authors: 
    - Zsolt Zsuffa

Copyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the 
GNU General Public License as published by the Free Software Foundation, either version 3 of the License, 
or (at your option) any later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/





var TreeNodeType = new Class({

	//node images
	dMinusPicture: "minus.gif",
	dPlusPicture: "plus.gif",
	dMinus_lastPicture: "minus_last.gif",
	dPlus_lastPicture: "plus_last.gif",

	//line images
	dMinus_nolinesPicture: "minus_nolines.gif",
	dMinus_no_rootPicture: "minus_no_root.gif",
	dMinus_last_no_rootPicture: "minus_last_no_root.gif",
	dPlus_nolinesPicture: "plus_nolines.gif",
	dPlus_no_rootPicture: "plus_no_root.gif",
	dPlus_last_no_rootPicture: "plus_last_no_root.gif",
	dT_no_rootPicture: "t_no_root.gif",

	Implements: [Options],
	options: {
		captionClass : 'nodeCaption',
		captionClassWhenSelectable : 'selectedHover', 
		captionLinkClass : 'nodeCaptionLink',
		componentName : 'TreeNodeType',
		imagesFolder : 'Images/',
		nodeClassWhenHidden : 'hiddenNode', 
		nodeClassWhenVisible : 'nodeWrapper',
		nodeHandlerClass : 'nodeHandler',
      nodeHandlerSourceWhenHasNext : 't.gif',
      nodeHandlerSourceWhenLast : 'lastnode.gif',
		nodeIconClass : 'nodeIcon',
		nodeImageClass : 'nodeImage',
		nodeIconImages : { closedFolder: "folder_closed.gif", openedFolder: "folder_open.gif", help: "help_16x16.gif", page: "page16x16.gif", user: "user_16x16.gif" },
      trailingImageClass : 'trailingImage',
		trailingImageWhenParentHasNext : 'line.gif',
		trailingImageWhenParentIsLast : 'white.gif'
	},

	//Constructor
	initialize: function( options ) {
		this.setOptions( options );
	},
	
	//public accessor and mutator methods
   determineNodeHandlerImage : function( treeNode ){
      return treeNode.nextSibling ? this.getNodeHandlerSourceWhenHasNext() : this.getNodeHandlerSourceWhenLast();
   },
   
	determineNodeImage : function( treeNode ) {
		return this.options.imagesFolder + this.options.nodeIconImages.page;
	},
	
	//Properties
	getCaptionClass : function() { return this.options.captionClass; },
	getCaptionClassWhenSelectable : function() { return this.options.captionClassWhenSelectable; },
	getCaptionLinkClass : function() { return this.options.captionLinkClass; },
	getImagesFolder : function() { return this.options.imagesFolder; },
	getLineImageWhenLast : function() { return this.getImagesFolder() + this.options.lineImageWhenLast; },
	getLineImageWhenHasNext : function() { return this.getImagesFolder() + this.options.lineImageWhenHasNext; },
	getNodeHandlerClass : function() { return this.options.nodeHandlerClass; },
   getNodeHandlerSourceWhenLast : function() { return this.getImagesFolder() + this.options.nodeHandlerSourceWhenLast; },
   getNodeHandlerSourceWhenHasNext : function() { return this.getImagesFolder() + this.options.nodeHandlerSourceWhenHasNext; },
	getNodeIconClass : function() { return this.options.nodeIconClass; },
	getNodeIconSource : function() { return this.getImagesFolder() + this.options.nodeIconImages.page; },
	getNodeImageClass : function() { return this.options.nodeImageClass; },
   getNodeWrapperClass : function() { return this.options.nodeClassWhenVisible; },
	getTrailingImageClass : function() { return this.options.trailingImageClass; },
	getTrailingImageWhenParentHasNext : function() { return this.getImagesFolder() + this.options.trailingImageWhenParentHasNext; },
   getTrailingImageWhenParentIsLast : function() { return this.getImagesFolder() + this.options.trailingImageWhenParentIsLast; }
});
/*
Name:
    - CompositeTreeNodeType
    
Description: 
    - Clamps shared properties of composite tree node instances.
    
Requires:
    - TreeNodeType
    
Provides:
    - CompositeTreeNodeType

Part of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. 
http://www.processpuzzle.com

Authors: 
    - Zsolt Zsuffa

Copyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the 
GNU General Public License as published by the Free Software Foundation, either version 3 of the License, 
or (at your option) any later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/






var CompositeTreeNodeType = new Class ({
   Extends : TreeNodeType,
	
   options: {
      componentName : 'CompositeTreeNodeType',
      nodeHandlerSourceWhenFirstAndClosed : 'plus_last_no_root.gif',
      nodeHandlerSourceWhenFirstAndOpened : 'minus_last_no_root.gif',
      nodeHandlerSourceWhenFirstAndHasNextAndClosed : 'plus_no_root.gif',
      nodeHandlerSourceWhenFirstAndHasNextAndOpened : 'minus_no_root.gif',
      nodeHandlerSourceWhenHasNextAndClosed : 'plus.gif',
      nodeHandlerSourceWhenHasNextAndOpened : 'minus.gif',
      nodeHandlerSourceWhenLastAndClosed : 'plus_last.gif',
      nodeHandlerSourceWhenLastAndOpened : 'minus_last.gif'
	},
	
	//Constructor
	initialize: function( options ) {
		this.parent( options );
	},
	
	//public accessor and mutator methods
	determineNodeHandlerImage : function( treeNode ){
	   if( treeNode.isOpened ){
	      if( treeNode.previousSibling && treeNode.nextSibling ) return this.getNodeHandlerSourceWhenHasNextAndOpened();
	      else if( treeNode.previousSibling && !treeNode.nextSibling ) return this.getNodeHandlerSourceWhenLastAndOpened();
         else if( !treeNode.previousSibling && treeNode.nextSibling )return this.getNodeHandlerSourceWhenFirstAndHasNextAndOpened();
	   }else{
         if( treeNode.previousSibling && treeNode.nextSibling ) return this.getNodeHandlerSourceWhenHasNextAndClosed();
         else if( treeNode.previousSibling && !treeNode.nextSibling ) return this.getNodeHandlerSourceWhenLastAndClosed();
         else if( !treeNode.previousSibling && treeNode.nextSibling )return this.getNodeHandlerSourceWhenFirstAndHasNextAndClosed();
	   }
	},
	
	determineNodeImage : function( treeNode ) {
	   var imageUri;
	   
      if( treeNode.isOpened ) imageUri = this.options.nodeIconImages.openedFolder;
      else imageUri = this.options.nodeIconImages.closedFolder;

		return this.getImagesFolder() + imageUri;
	},
	
	//Properties
	getLineImageWhenLast : function( nodeState ) { 
		if( nodeState == this.getStateNameWhenClosed() )
			return this.getImagesFolder() + this.options.lineImageWhenLastAndCloseed; 
		else
			return this.getImagesFolder() + this.options.lineImageWhenLastAndOpened; 
	},
	
	getLineImageWhenHasNext : function( nodeState ) { 
		if( nodeState == this.getStateNameWhenClosed() )
			return this.getImagesFolder() + this.options.lineImageWhenHasNextAndClosed; 
		else
			return this.getImagesFolder() + this.options.lineImageWhenHasNextAndOpened; 
	},
	
   getNodeHandlerSourceWhenFirstAndClosed : function() { return this.getImagesFolder() + this.options.nodeHandlerSourceWhenFirstAndClosed; },
   getNodeHandlerSourceWhenFirstAndOpened : function() { return this.getImagesFolder() + this.options.nodeHandlerSourceWhenFirstAndOpened; },
   getNodeHandlerSourceWhenFirstAndHasNextAndClosed : function() { return this.getImagesFolder() + this.options.nodeHandlerSourceWhenFirstAndHasNextAndClosed; },
   getNodeHandlerSourceWhenFirstAndHasNextAndOpened : function() { return this.getImagesFolder() + this.options.nodeHandlerSourceWhenFirstAndHasNextAndOpened; },
   getNodeHandlerSourceWhenHasNextAndClosed : function() { return this.getImagesFolder() + this.options.nodeHandlerSourceWhenHasNextAndClosed; },
   getNodeHandlerSourceWhenHasNextAndOpened : function() { return this.getImagesFolder() + this.options.nodeHandlerSourceWhenHasNextAndOpened; },
   getNodeHandlerSourceWhenLastAndClosed : function() { return this.getImagesFolder() + this.options.nodeHandlerSourceWhenLastAndClosed; },
   getNodeHandlerSourceWhenLastAndOpened : function() { return this.getImagesFolder() + this.options.nodeHandlerSourceWhenLastAndOpened; },
	getStateNameWhenClosed : function() { return this.CLOSED_STATE; },
	getStateNameWhenOpened : function() { return this.OPENED_STATE; }
});

/*** TreeNodeType instances ***/
folderNodeType = new CompositeTreeNodeType( "folder", "folder_closed.gif", "folder_open.gif" );
userNodeType = new TreeNodeType( "user", "user_16x16.gif" );
pageNodeType = new TreeNodeType( "page", "page16x16.gif" );
helpNodeType = new TreeNodeType( "help", "help_16x16.gif" );

/*
Name:
    - TreeNode

Description: 
    - Displays a single node in the tree structure.

Requires:
    - BrowserWidget

Provides:
    - TreeNode

Part of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. 
http://www.processpuzzle.com

Authors: 
    - Zsolt Zsuffa

Copyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the 
GNU General Public License as published by the Free Software Foundation, either version 3 of the License, 
or (at your option) any later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/





var TreeNode = new Class({
   Implements : [Events, Options],
   Binds : ['addNodeEvents', 'createNodeCaption', 'createNodeHandlerImage', 'createNodeIcon', 'createNodeWrapperElement', 'finalizeConstruction', 'insertTrailingImages', 'onCaptionClick'],
   options : {
      captionSelector : '@caption',
      componentName : "TreeNode",
      dataXmlNameSpace : "xmlns:pp='http://www.processpuzzle.com'",
      imageUriSelector : '@image',
      messageSelector : 'messageProperties',
      nodeIDSelector : '@nodeId',
      orderNumberSelector : '@orderNumber',
      selectable : false,
      target : '_blank',
      url : null
   },

   // constructor
   initialize : function( parentNode, nodeType, nodeResource, elementFactory, options ) {
      // parameter assertions
      assertThat( nodeType, not( nil() ) );
      assertThat( nodeResource, not( nil() ) );
      assertThat( elementFactory, not( nil() ) );
      this.setOptions( options );

      // private instance variables
      this.caption;
      this.constructionChain = new Chain();
      this.containerElement;
      this.elementFactory = elementFactory;
      this.imageUri;
      this.message;
      this.nodeCaptionElement;
      this.nodeHandlerElement;
      this.nodeIconElement;
      this.nodeResource = nodeResource;
      this.nodeWrapperElement;
      this.nextSibling;
      this.nodeID;
      this.nodeType = nodeType;
      this.orderNumber;
      this.parentNode = parentNode;
      this.previousSibling;
      this.selectPicElement;
      this.state;
      this.trailingImages = new ArrayList();
      
      this.state = BrowserWidget.States.INITIALIZED;
   },

   // public accessor and mutator methods
   bubbleUpNames : function() {
      return this.parentNode ? this.parentNode.bubbleUpNames() + "/" + this.caption : this.caption;
   },

   changeCaption : function() {
      this.caption = this.webUiController.getText( this.name );

      if (this.nodeCaptionElement != null && this.captionTextNode != null) {
         this.nodeCaptionElement.removeChild( this.captionTextNode );
         this.captionTextNode = document.createTextNode( this.caption );
         this.nodeCaptionElement.appendChild( this.captionTextNode );
      }

      for ( var i = 0; i < this.childs.length; i++) {
         this.childs[i].changeCaption( this.webUiController );
      }
   },
   
   construct : function() {
      if( this.state == BrowserWidget.States.UNMARSHALLED ){
         this.compileConstructionChain();
         this.constructionChain.callChain();
      }
   },
   
   destroy : function(){
      this.destroyNodeElement( this.nodeHandlerElement );
      this.destroyNodeElement( this.nodeIconElement );
      this.destroyNodeElement( this.nodeCaptionElement );
      this.destroyNodeElement( this.nodeWrapperElement );
      this.destroyTrailingImages();
      
      this.state = BrowserWidget.States.INITIALIZED;
   },
   
   findNodeByPath : function( path ) {
      if( path == this.caption ) return this;
      else null;
   },
   

   onCaptionClick : function() {
      this.fireEvent( 'nodeSelected', this );
   },

   unmarshall : function(){
      this.unmarshallProperties();
      this.unmarshallMessage();
      this.state = BrowserWidget.States.UNMARSHALLED;
   },

   // Properties
   getCaption : function() { return this.caption; },
   getCaptionElement : function() { return this.nodeCaptionElement; },
   getContainerElement : function() { return this.containerElement; },
   getId : function() { return this.nodeID; },
   getImageUri : function() { return this.imageUri; },
   getMessage : function() { return this.message; },
   getNodeImageElement : function() { return this.nodeIconElement; },
   getNextSibling : function() { return this.nextSibling; },
   getNodeType : function() { return this.nodeType; },
   getNodeWrapperElement : function() { return this.nodeWrapperElement; },
   getOrderNumber : function() { return this.orderNumber; },
   getParentNode : function() { return this.parentNode; },
   getPreviousSibling : function() { return this.previousSibling; },
   hasNext : function() { return !(this.nextSibling == null); },
   isVisible : function() { return this.visible; },

   // private methods
   addNodeEvents : function(){
      this.nodeCaptionElement.addEvents({
         'click' : this.onCaptionClick
      });
      
      this.constructionChain.callChain();
   }.protect(),
   
   compileConstructionChain : function(){
      this.constructionChain.chain( 
         this.createNodeWrapperElement, 
         this.createNodeHandlerImage, 
         this.createNodeIcon, 
         this.createNodeCaption, 
         this.insertTrailingImages,
         this.addNodeEvents, 
         this.finalizeConstruction
      );
   }.protect(),
   
   createNodeCaption : function(nobrElement) {
      var elementOptions = { 'class' : this.nodeType.getCaptionClass(), 'id' : this.nodeID };
      this.nodeCaptionElement = this.elementFactory.create( 'span', this.caption, this.nodeWrapperElement, WidgetElementFactory.Positions.LastChild, elementOptions );
      this.constructionChain.callChain();
   }.protect(),

   createNodeHandlerImage : function() {
      var elementOptions = { 'class' : this.nodeType.getNodeHandlerClass() + " " + this.nodeType.getNodeImageClass(), 'src' : this.nodeType.determineNodeHandlerImage( this ) };
      this.nodeHandlerElement = this.elementFactory.create( 'img', null, this.nodeWrapperElement, WidgetElementFactory.Positions.LastChild, elementOptions );
      this.constructionChain.callChain();
   }.protect(),

   createNodeIcon : function() {
      var elementOptions = { 'class' : this.nodeType.getNodeIconClass() + " " + this.nodeType.getNodeImageClass(), 'src' : this.imageUri };
      this.nodeIconElement = this.elementFactory.create( 'img', null, this.nodeWrapperElement, WidgetElementFactory.Positions.LastChild, elementOptions );
      this.constructionChain.callChain();
   }.protect(),

   createNodeWrapperElement : function() {
      var contextElement = this.determineWrapperContextElement();
      var contextPosition = this.determinWrapperContextPosition();
      var elementOptions = { 'class' : this.nodeType.getNodeWrapperClass() };
      this.nodeWrapperElement = this.elementFactory.create( 'div', null, contextElement, contextPosition, elementOptions );
      this.constructionChain.callChain();
   }.protect(),

   destroyNodeElement: function( nodeElement ){
      if( nodeElement && nodeElement.removeEvents ) nodeElement.removeEvents();
      if( nodeElement && nodeElement.destroy ) nodeElement.destroy();
   }.protect(),
   
   destroyTrailingImages : function(){
      this.trailingImages.each( function( imageElement, index ){
         this.destroyNodeElement( imageElement );
      }.bind( this ));
      
      this.trailingImages.clear();
   }.protect(),
   
   determineWrapperContextElement : function(){
      if( this.previousSibling ) {
         if( instanceOf( this.previousSibling, CompositeTreeNode )) 
            return this.previousSibling.findLastVisibleChild().getNodeWrapperElement();
         else return this.previousSibling.getNodeWrapperElement();
      }else return this.parentNode.getNodeWrapperElement();
   }.protect(),
   
   determinWrapperContextPosition : function(){
      if( this.previousSibling || ( this.parentNode && !instanceOf( this.parentNode, RootTreeNode ))) 
         return WidgetElementFactory.Positions.After;
      else return WidgetElementFactory.Positions.LastChild;
   }.protect(),
   
   finalizeConstruction : function(){
      this.state = BrowserWidget.States.CONSTRUCTED;
      this.constructionChain.clearChain();
      this.fireEvent( 'constructed', this );
   }.protect(),
   
   implementCompositeIfChildNodesExists : function(){
      var childNodeElements = XmlResource.selectNodes( this.options.childNodesSelector, this.nodeResource );
      if( childNodeElements ){
         this.implement({ alert: function(text){ alert(text); }});
         this.unmarshallChildNodes();
      }
   }.protect(),

   insertTrailingImages : function(nobrElement, thePrefix) {
      var currentNode = this.getParentNode();
      while( currentNode ){
         var imageSource = currentNode.hasNext() ? this.nodeType.getTrailingImageWhenParentHasNext() : this.nodeType.getTrailingImageWhenParentIsLast();
         var elementOptions = { 'class' : this.nodeType.getTrailingImageClass() + " " + this.nodeType.getNodeImageClass(), 'src' : imageSource };
         this.trailingImages.add( this.elementFactory.create( 'img', null, this.nodeWrapperElement, WidgetElementFactory.Positions.FirstChild, elementOptions ));

         currentNode = currentNode.getParentNode();
      }
      this.constructionChain.callChain();
   }.protect(),
   
   unmarshallMessage: function(){
      var messageResource = XmlResource.selectNode( this.options.messageSelector, this.nodeResource );
      if( messageResource ){
         this.message = new MenuSelectedMessage({ messageResource : messageResource });
         this.message.unmarshall();
      } 
   }.protect(),
   
   unmarshallProperties: function(){
      this.nodeID = XmlResource.selectNodeText( this.options.nodeIDSelector, this.nodeResource );
      this.caption = XmlResource.selectNodeText( this.options.captionSelector, this.nodeResource );
      this.imageUri = XmlResource.selectNodeText( this.options.imageUriSelector, this.nodeResource, this.options.dataXmlNameSpace, this.nodeType.determineNodeImage( this ));
      this.orderNumber = XmlResource.selectNodeText( this.options.orderNumberSelector, this.nodeResource );
   }.protect()
});
/*
Name:
    - CompositeTreeNode

Description: 
    - Displays a composite (has child nodes) node in the tree structure.

Requires:
    - TreeNode
    - TreeNodeType
    - CompositeTreeNodeType

Provides:
    - CompositeTreeNode

Part of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. 
http://www.processpuzzle.com

Authors: 
    - Zsolt Zsuffa

Copyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the 
GNU General Public License as published by the Free Software Foundation, either version 3 of the License, 
or (at your option) any later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/







var CompositeTreeNode = new Class( {
   Extends : TreeNode,
   Binds : ['constructChildNodes', 'onChildNodeConstructed', 'onNodeHandlerClick', 'onNodeSelected'],

   constants : {
      NODE_PATH_SEPARATOR : "/"
   },
   
   options : {
      childNodesSelector : 'treeNode',
      componentName : "CompositeTreeNode",
      initialyOpened : false,
      isOpenedSelector : "@isOpened"
   },

   // Constructor
   initialize : function( parentNode, nodeType, nodeResource, elementFactory, options ) {
      this.parent( parentNode, nodeType, nodeResource, elementFactory, options );
      this.childNodes = new ArrayList();
      this.isOpened = this.options.initialyOpened;
      this.numberOfConstructedChildNodes = 0;
   },

   // public accessor and mutator methods
   close : function() {
      if( this.isOpened ){
         this.isOpened = false;
         this.destroyChildNodes();
         this.replaceNodeImage();
         this.replaceNodeHandlerImage();
      }
   },
   
   construct : function(){
      this.parent();
   },
   
   destroy : function(){
      this.destroyChildNodes();
      this.parent();
   },

   findChildNodeByName : function( caption ) {
      var searchedNode = null;
      this.childNodes.each( function( childNode, index ){
         if( childNode.getCaption() == caption ) searchedNode = childNode;
      }.bind( this )); 
      
      return searchedNode;
   },
   
   findLastVisibleChild : function(){
      if( this.isOpened ){
         var lastChild = this.childNodes.getLast();
         if( instanceOf( lastChild, CompositeTreeNode )) return lastChild.findLastVisibleChild(); 
         else return lastChild; 
      }
      else return this;
   },

   findNodeByPath : function( path ) {
      if( this.pathStartsWithThisNode( path )) {
         if( this.pathRefersToSubnode( path )){
            var nextNodeName = this.nextNodeNameInPath( path );
            var childNode = this.findChildNodeByName( nextNodeName );
            if( childNode != null ) return childNode.findNodeByPath( this.nextNodePathFragment( path ));
            else return null;
         }else return this;
      }else return this.findChildNodeByName( path );
   },
   
   onChildNodeConstructed : function( childNode ){
      this.numberOfConstructedChildNodes++;
      if( this.numberOfConstructedChildNodes == this.childNodes.size() ) this.constructionChain.callChain();

   },

   onNodeHandlerClick : function() {
      if( this.isOpened ) this.close();
      else this.open();
   },
   
   onNodeSelected : function( selectedNode ){
      this.fireEvent( 'nodeSelected', selectedNode );
   },

   open : function() {
      if( !this.isOpened ){
         this.isOpened = true;
         this.unmarshallChildNodes();
         this.constructChildNodes();
         this.replaceNodeImage();
         this.replaceNodeHandlerImage();
      }
   },

   unmarshall : function(){
      this.unmarshallChildNodes();
      this.parent();
   },

   // Properties
   getChildCount : function() { return this.childNodes.length; },
   getChildNodes : function() { return this.childNodes; },
   getFirstChild : function() { if (this.hasChilds()) return this.childNodes[0]; return null; },
   getLastChild : function() { if (this.hasChilds()) return this.childNodes[this.childNodes.length - 1]; return null; },
   getState : function() { return this.state; },
   hasChilds : function() { return (this.childNodes.length > 0); },

   // private methods
   appendNodeImage : function() {
      this.parent();
      this.nodeImageElement.set( "src", this.nodeType.determineNodeImage( this.options.state ) );
      this.nodeImageElement.addEvent( 'click', this.onFolderClickHandler );
   }.protect(),

   compileConstructionChain : function(){
      this.constructionChain.chain( 
         this.createNodeWrapperElement, 
         this.createNodeHandlerImage, 
         this.createNodeIcon, 
         this.createNodeCaption, 
         this.insertTrailingImages, 
         this.constructChildNodes,
         this.finalizeConstruction
      );
   }.protect(),
   
   constructChildNodes : function(){
      if( this.isOpened ){
         this.childNodes.each( function( childNode, index ){
            childNode.construct();
         }.bind( this ));
      }else this.constructionChain.callChain();
   }.protect(),
   
   createNodeHandlerImage : function() {
      this.parent();
      this.nodeHandlerElement.addEvent( 'click', this.onNodeHandlerClick );
   }.protect(),
   
   currentNodeNameInPath : function( path ){
      return path.indexOf( this.constants.NODE_PATH_SEPARATOR ) >= 0 ? path.substring( 0, path.indexOf( this.constants.NODE_PATH_SEPARATOR )) : path;
   }.protect(),

   destroyChildNodes : function(){
      this.childNodes.each( function( childNode, index ){
         childNode.destroy();
      }.bind( this ));
      
      this.childNodes.clear();
      this.numberOfConstructedChildNodes = 0;
   }.protect(),
   
   nextNodePathFragment : function( path ){
      return path.indexOf( this.constants.NODE_PATH_SEPARATOR ) >= 0 ? path.substring( path.indexOf( this.constants.NODE_PATH_SEPARATOR ) +1 ) : path;
   }.protect(),
   
   nextNodeNameInPath : function( path ){
      var nextPathFragment = path.substring( this.currentNodeNameInPath( path ).length +1 ); 
      return this.currentNodeNameInPath( nextPathFragment );
   }.protect(),
   
   pathRefersToSubnode : function( path ){ return path.indexOf( this.constants.NODE_PATH_SEPARATOR ) > 0 }.protect(),
   pathStartsWithThisNode : function( path ){ return this.currentNodeNameInPath( path ) == this.caption; }.protect(),
   
   replaceNodeHandlerImage : function(){
      this.nodeHandlerElement.set( 'src', this.nodeType.determineNodeHandlerImage( this ));
   }.protect(),
   
   replaceNodeImage : function(){
      this.nodeIconElement.set( 'src', this.nodeType.determineNodeImage( this ));
   }.protect(),
   
   unmarshallChildNodes : function(){
      this.childNodes.clear();
      var childNodeElements = XmlResource.selectNodes( this.options.childNodesSelector, this.nodeResource );
      if( childNodeElements ){
         childNodeElements.each( function( childNodeElement, index ){
            var treeNode = TreeNodeFactory.create( this, childNodeElement, this.elementFactory, { onConstructed : this.onChildNodeConstructed, onNodeSelected : this.onNodeSelected });
            if( index > 0 && index < childNodeElements.length ){
               this.childNodes.get( index -1 ).nextSibling = treeNode;
               treeNode.previousSibling = this.childNodes.get( index -1 );
            }
            treeNode.unmarshall();
            this.childNodes.add( treeNode );
         }.bind( this ));
      }      
   }.protect(),
   
   unmarshallProperties: function(){
      this.isOpened = parseBoolean( XmlResource.selectNodeText( this.options.isOpenedSelector, this.nodeResource, this.options.dataXmlNameSpace, this.options.initialyOpened ));
      this.parent();
   }.protect()
});

CompositeTreeNode.States = { CLOSED : 'closed', OPENED : 'opened' };
/*
Name:
    - LeafTreeNode

Description: 
    - Represents a leaf in a tree hierachy.

Requires:
    - TreeNode
    - TreeNodeType

Provides:
    - LeafTreeNode

Part of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. 
http://www.processpuzzle.com

Authors: 
    - Zsolt Zsuffa

Copyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the 
GNU General Public License as published by the Free Software Foundation, either version 3 of the License, 
or (at your option) any later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/





var LeafTreeNode = new Class({
	Extends : TreeNode,
	options : {
      componentName : "LeafTreeNode",
	},
	
	//Constructor
	initialize: function( parentNode, nodeType, nodeResource, elementFactory, options ) {
		this.parent( parentNode, nodeType, nodeResource, elementFactory, options );
	}

	//public accessor and mutator methods

	//Properties

	//private methods
});
/*
Name:
    - RootTreeNode

Description: 
    - A special composite node as it has no parent node.

Requires:
    - TreeNode
    - TreeNodeType
    - CompositeTreeNode
    - CompositeTreeNodeType

Provides:
    - RootTreeNode

Part of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. 
http://www.processpuzzle.com

Authors: 
    - Zsolt Zsuffa

Copyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the 
GNU General Public License as published by the Free Software Foundation, either version 3 of the License, 
or (at your option) any later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/







var RootTreeNode = new Class({
   Extends : CompositeTreeNode,
   options : {
      componentName : "RootTreeNode",
      initialyOpened : true,
      isVisible : false
   },

   // Constructor
   initialize : function( nodeType, nodeResource, elementFactory, options ) {
      this.parent( null, nodeType, nodeResource, elementFactory, options );

      // private instance variables
      this.containerElement;
      this.isVisible = false;
   },

   // public accessor and mutator methods
   construct : function( containerElement ){
      this.containerElement = containerElement;
      this.parent();
   },

   // Properties
   getNodeWrapperElement : function() { return this.isVisible ? this.nodeWrapperElement : this.containerElement; },
   getWidgetElement : function() { return widgetElement; },
   
   //Protected, private helper methods
   compileConstructionChain : function(){
      if( this.options.isVisible ){
         this.constructionChain.chain( this.createNodeWrapperElement, this.createNodeHandlerImage, this.createNodeIcon, this.createNodeCaption, this.insertTrailingImages, this.constructChildNodes, this.finalizeConstruction );
      }else{
         this.constructionChain.chain( this.constructChildNodes, this.finalizeConstruction );
      }
   }.protect(),
   
   determineWrapperContextElement : function(){
      return this.containerElement;
   }.protect(),
   
   determinWrapperContenxtPosition : function(){
      return WidgetElementFactory.Positions.LastChild;
   }.protect(),
   
   finalizeConstruction : function(){
      if( this.options.isVisible ) this.parent()
      else {
         this.state = BrowserWidget.States.UNMARSHALLED;
         this.constructionChain.clearChain();
         this.fireEvent( 'constructed', this );
      }
   }.protect() 
   
});
/*
Name:
    - RootTreeNodeType
    
Description: 
    - Clamps shared properties of root tree node instances.
    
Requires:
    - CompositeNodeType
    
Provides:
    - RottTreeNodeType

Part of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. 
http://www.processpuzzle.com

Authors: 
    - Zsolt Zsuffa

Copyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the 
GNU General Public License as published by the Free Software Foundation, either version 3 of the License, 
or (at your option) any later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/







var RootTreeNodeType = new Class ({
	Extends : CompositeTreeNodeType,
	
	options: {
      componentName : 'RootTreeNodeType',
      nodeHandlerSourceWhenHasNextAndClosed : 'plus_no_root.gif',
	   nodeHandlerSourceWhenHasNextAndOpened : 'minus_no_root.gif',
	},
	
	//Constructor
	initialize: function( options ) {
		this.parent( options );
	},
	
	//public accessor and mutator methods
	
	//Properties
});


/*
Name: TreeNodeFactory

Description: Instantiates a new subclass of TreeNode according to the given XML element.

Requires:

Provides:
    - TreeNodeFactory

Part of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. 
http://www.processpuzzle.com

Authors: 
    - Zsolt Zsuffa

Copyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the 
GNU General Public License as published by the Free Software Foundation, either version 3 of the License, 
or (at your option) any later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/




var TreeNodeFactory = new Class({
   Implements: Options,
   
   options: {
      nodeTypeOptions : {}
   },
   
   //Constructor
   initialize: function( options ){
      this.setOptions( options );
      
      this.treeNodeType = new TreeNodeType( this.options.nodeTypeOptions );
      this.compositeTreeNodeType = new CompositeTreeNodeType( this.options.nodeTypeOptions );
      this.rootTreeNodeType = new RootTreeNodeType( this.options.nodeTypeOptions );
   },

   //Public mutators and accessors
   create: function( parentNode, nodeResource, elementFactory, options ){
      var hasChildNodes = XmlResource.selectNodes( "treeNode", nodeResource ).length > 0 ? true : false;
      var treeNode;
      
      if( hasChildNodes ) treeNode = new CompositeTreeNode( parentNode, this.compositeTreeNodeType, nodeResource, elementFactory, options );
      else treeNode = new LeafTreeNode( parentNode, this.treeNodeType, nodeResource, elementFactory, options );
      
      return treeNode;
   },
   
   //Properties
   getCompositeTreeNodeType : function() { return this.compositeTreeNodeType; },
   getRootTreeNodeType : function() { return this.rootTreeNodeType; },
   getTreeNodeType : function() { return this.treeNodeType; }
});

TreeNodeFactory.create = function( parentNode, definitionXmlElement, htmlElementFactory, options ){
   if( !TreeNodeFactory.singleInstance ) TreeNodeFactory.singleInstance = new TreeNodeFactory();
   return TreeNodeFactory.singleInstance.create( parentNode, definitionXmlElement, htmlElementFactory, options );
};

TreeNodeFactory.singleInstance;
/*
Name:
    - TreeWidget
Description: 
    - Displays a tree structure - given by an xml - as a tree.
Requires:
    - BrowserWidget
Provides:
    - TreeWidget

Part of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. 
http://www.processpuzzle.com

Authors: 
    - Zsolt Zsuffa

Copyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the 
GNU General Public License as published by the Free Software Foundation, either version 3 of the License, 
or (at your option) any later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.

*/





var TreeWidget = new Class( {
   Extends : BrowserWidget,
   Binds : ['constructTreeNodes', 'destroyTreeNodes', 'onNodeSelected', 'onRootNodeConstructed'],
   constants : {
   },
   
   options : {
      componentName : "TreeWidget",
      imagesFolder : "",
      nodeOptions : {},
      nodeTypeOptions : {},
      pathSeparator : ".",
      rootNodeSelector : "//pp:treeDefinition/rootNode",
      showRootNode : false,
      widgetContainerId : "TreeWidget"
   },

   // constructor
   initialize : function( options, resourceBundle, elementFactoryOptions ) {
      this.parent( options, resourceBundle, elementFactoryOptions );

      this.compositeTreeNodeType;
      this.rootNode;
      this.rootNodeType;
      this.selectedNode;
      this.treeNodeType;
      
      this.instantiateNodeFactory();
      this.instantiateNodeTypes();
   },

   // public accessor and mutator methods
   changeCaptions : function() {
      if( this.rootNode != null ) this.rootNode.changeCaption( this.controller );
   },

   construct : function() {
      this.parent();
   },

   destroy : function() {
      this.parent();
   },
   
   findNodeByPath : function( path ){
      return this.rootNode ? this.rootNode.findNodeByPath( path ) : null;
   },

   getSelectedNode : function() {
      if (this.getSelectedNameListSize() == 0) return null;
      return this.rootNode.findNodeByPath( this.getSelectedNodeFullCaption() );
   },

   onNodeSelected : function( selectedNode ){
      this.selectedNode = selectedNode;
      this.messageBus.notifySubscribers( this.adjustMessage( selectedNode.getMessage() ));      
   },

   onRootNodeConstructed : function( rootNode ){
      this.constructionChain.callChain();
   },
   
   unmarshall : function() {
      this.unmarshallRootNode();
   },

   // Properties
   getCompositeTreeNodeType : function() { return this.compositeTreeNodeType; },
   getRootNode : function() { return this.rootNode; },
   getSelectedNameList : function() { return this.selectedNameList; },
   getSelectedNameListSize : function() { return this.selectedNameListSize; },
   getTreeNodeType : function() { return this.treeNodeType; },

   // Protected, private helper methods
   adjustMessage : function( message ){
      message.options.originator = this.options.componentName;
      return message;
   }.protect(),
   compileConstructionChain: function(){
      this.constructionChain.chain( this.constructTreeNodes, this.finalizeConstruction );
   }.protect(),
   
   compileDestructionChain : function(){
      this.destructionChain.chain( this.destroyTreeNodes, this.finalizeDestruction );
   }.protect(),
   
   constructTreeNodes : function(){
      this.rootNode.construct( this.containerElement );
   }.protect(),
   
   destroyTreeNodes : function(){
      this.rootNode.destroy();
      this.rootNode = null;
      this.destructionChain.callChain();
   }.protect(),
   
   instantiateNodeFactory : function(){
      TreeNodeFactory.singleInstance = new  TreeNodeFactory({ nodeTypeOptions : this.options.nodeTypeOptions });
   }.protect(),

   instantiateNodeTypes : function(){
      this.treeNodeType = TreeNodeFactory.singleInstance.getTreeNodeType();
      this.compositeTreeNodeType = TreeNodeFactory.singleInstance.getCompositeTreeNodeType();
      this.rootNodeType = TreeNodeFactory.singleInstance.getRootTreeNodeType();
   }.protect(),
   
   unmarshallRootNode : function(){
      var rootNodeElement = this.dataXml.selectNode( this.options.rootNodeSelector );
      if( rootNodeElement ){
         var nodeOptions = Object.merge( this.options.nodeOptions, { isVisible : this.options.showRootNode, onConstructed : this.onRootNodeConstructed, onNodeSelected : this.onNodeSelected });
         this.rootNode = new RootTreeNode( this.rootNodeType, rootNodeElement, this.elementFactory, this.options.nodeOptions );
         this.rootNode.unmarshall();
      }      
   }.protect()   
});
/*
Name: 
    - VideoPlayerWidget

Description: 
    - Plays specified video files. 

Requires:
    - BrowserWidget, WidgetElementFactory
    
Provides:
    - VideoPlayerWidget

Part of: ProcessPuzzle Browser UI, Back-end agnostic, desktop like, highly configurable, browser font-end, based on MochaUI and MooTools. 
http://www.processpuzzle.com

Authors: 
    - Zsolt Zsuffa

Copyright: (C) 2011 This program is free software: you can redistribute it and/or modify it under the terms of the 
GNU General Public License as published by the Free Software Foundation, either version 3 of the License, 
or (at your option) any later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/





var VideoPlayerWidget = new Class({
   Extends : ToolBarWidget,
   options : {
      componentName : "VideoPlayerWidget",
      descriptionSelector : "/pp:widgetDefinition/description", 
      nameSelector : "/pp:widgetDefinition/name"
   },

   //Constructor
   initialize: function( options, internationalization ){
      this.setOptions( options );
      this.parent( options, internationalization );
      
      //Private attributes
   },
   
   //Public accessor and mutator methods
   construct: function(){
      return this.parent();
   },
   
   destroy: function(){
      this.parent();
   },
   
   unmarshall: function(){
      return this.parent();
   },
   
   //Properties
   
   //Protected and private helper methods
});
// LoadUtility.js




function getWebUIController() {
	try {
		return parent.webUIController;
	}
	catch (e) {
		return null;
	}
}


function loadDocument(documentType, name, uri) {
	getWebUIController().loadDocument(documentType, name, uri);
}

function loadInfo(documentType, name, uri) {
	getWebUIController().loadInfoPanelDocument(documentType, name, uri);
}


function setToDirty() {
	getWebUIController().getDocumentManager().getActiveDocument().setToDirty();
}

function setToClean() {
	getWebUIController().getDocumentManager().getActiveDocument().setToClean();
}

function saveDocument() {
	getWebUIController().getDocumentManager().getActiveDocument().save();
}

function cancelModification() {
	getWebUIController().getDocumentManager().getActiveDocument().cancel();
}
;
/*
ProcessPuzzle User Interface
Backend agnostic, desktop like configurable, browser font-end based on MochaUI.
Copyright (C) 2011  Joe Kueser, Zsolt Zsuffa

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/




var UnconfiguredWebUIControllerException = new Class({
   Extends: WebUIException,
   options: {
      description: "WebUIController is unconfigured, therefore the requested operation can't be carried out.",
      name: "UnconfiguredWebUIControllerException"
   },
   
   //Constructor
   initialize : function( options ){
      this.setOptions( options );
      this.parent( options );
   }
});
/*
ProcessPuzzle User Interface
Backend agnostic, desktop like configurable, browser font-end based on MochaUI.
Copyright (C) 2011  Joe Kueser, Zsolt Zsuffa

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/


ROOT_LOGGER_NAME = "WebUI";
FRONT_CONTROLLER = "CommandControllerServlet";


//= require_directory ../MochaUI
//= require_directory ../FundamentalTypes
//= require ../Singleton/Singleton.js

var WebUIController = new Class({
   Implements: [Class.Singleton, Events, Options],
   Binds : ['changeLanguage', 
            'constructDesktop',
            'configureLogger',
            'destroySplashForm',
            'determineCurrentUserLocale',
            'finalizeConfiguration',
            'loadDocument', 
            'loadInternationalizations',
            'loadWebUIConfiguration',
            'onDesktopConstructed', 
            'onError', 
            'restoreComponentsState',
            'storeComponentsState',
            'storeWebUIState',
            'subscribeToWebUIMessages',
            'webUIMessageHandler'],
   
   options: {
      artifactTypesXslt : "Commons/JavaScript/WebUIController/TransformBusinessDefinitionToArtifactTypes.xsl",
      compatibleBrowserVersions : { ie : 8, firefox : 4, safari : 4, chrome : 10, opera : 10 },
      componentName : "WebUIController",
      configurationUri : "Configuration.xml",
      contextRootPrefix : "../../",
      eraseStateWhenSkinChange : false,
      errorPageUri : "Commons/FrontController/WebUiError.jsp",
      eventFireDelay : 5,
      languageSelectorElementId : "LanguageSelectorWidget",
      loggerGroupName : "WebUIController",
      messageOriginator : "webUIController",
      reConfigurationDelay: 500,
      showSplashForm : false,
      splashFormUri : "Desktops/Images/SplashForm.png",
      unsupportedBrowserMessage: "We appologize. This site utilizes more modern browsers, namely: Internet Explorer 8+, FireFox 4+, Chrome 10+, Safari 4+",
      urlRefreshPeriod : 3000
   },
   
   //Constructors
   initialize: function( options, usedWindow ) { return this.check() || this.setUp( options, usedWindow ); },
   setUp: function( options, usedWindow ){
      this.setOptions( options );
      if( usedWindow != null && usedWindow != 'undefined' ){
          this.options.window = usedWindow;
      } 

      //private instance variables
      this.configurationChain = new Chain();
      this.desktop;
      this.error;
      this.isConfigured = false;
      this.languageSelector;
      this.locale;
      this.logger;
      this.messageBus = new WebUIMessageBus();
      this.resourceBundle;
      this.prefferedLanguage;
      this.recentHash = this.determineCurrentHash();
      this.refreshUrlTimer;
      this.skin;
      this.splashForm;
      this.stateManager;
      this.userName;
      this.userLocation;
      this.warningContainer;
      this.webUIConfiguration;
      this.webUIException;

      if( this.browserIsSupported() ){
         if( this.options.showSplashForm ) this.showSplashForm();
         this.loadWebUIConfiguration();
         this.updateOptionsWithConfiguration();
         this.configureLogger();
         this.instantiateComponentStateManager();
         this.restoreComponentsState(),
         this.determineCurrentUserLocale();
         this.determineDefaultSkin();
         this.loadInternationalizations();

         this.logger.debug( "Browser Interface is initialized with context root prefix: "  + this.options.contextRootPrefix );
      }else{
         this.showWebUIExceptionPage( new Error( this.options.unsupportedBrowserMessage ));
      }
   }.protect(),

   //public accessor and mutator methods
   changeLanguage : function( locale ){
      this.logger.debug( this.options.componentName + ".changeLanguage()." );
      this.destroy();
      if( this.options.showSplashForm ) this.showSplashForm();
      this.locale = locale;
      this.configure.delay( this.options.reConfigurationDelay, this );
   },
   
   changeSkin : function( newSkinName ){
      this.logger.debug( this.options.componentName + ".changeSkin()." );
      if( newSkinName != this.getCurrentSkin() ){
         if( this.options.eraseStateWhenSkinChange ) this.stateManager.reset();
         this.destroy();
         if( this.options.showSplashForm ) this.showSplashForm();
         this.skin = newSkinName;
         this.configure.delay( this.options.reConfigurationDelay, this );
      }
   },
   
   configure : function() {
      this.configurationChain.chain( 
         this.loadWebUIConfiguration,
         this.configureLogger,
         this.restoreComponentsState,
         this.determineCurrentUserLocale,
         this.loadInternationalizations,
         this.constructDesktop,
         this.subscribeToWebUIMessages,
         this.storeWebUIState,
         this.destroySplashForm,
         this.finalizeConfiguration
      ).callChain();
   },
   
   destroy : function() {
      if( this.isConfigured ){
         this.locale = null;
         this.messageBus.tearDown();
         if( this.languageSelector ) this.languageSelector.destroy();
         this.desktop.destroy();
         this.webUIConfiguration.release();
         this.resourceBundle.release();
         window.location.hash = "";
         clearInterval( this.refreshUrlTimer );
         this.isConfigured = false;
      }
   },
   
   loadDocument : function( documentUri, contentUri, documentVariables, documentType ){
      this.logger.debug( this.options.componentName + ".loadDocument( '" + documentUri + "' )" );
      var message = new MenuSelectedMessage({ 
         activityType : AbstractDocument.Activity.LOAD_DOCUMENT, 
         documentType : documentType, 
         documentURI : documentUri, 
         documentContentURI : contentUri, 
         documentVariables : documentVariables,
         originator : this.options.messageOriginator });
      this.messageBus.notifySubscribers( message );
   },
   
   loadHtmlDocument : function( documentUri ){
      this.loadDocument( documentUri, null, null, AbstractDocument.Types.HTML );
   },
   
   loadSmartDocument : function( documentUri, contentUri, documentVariables ){
      this.loadDocument( documentUri, contentUri, documentVariables, AbstractDocument.Types.SMART );
   },
   
   onDesktopConstructed : function(){
      this.logger.debug( this.options.componentName + ", constructing desktop is finished." );
      this.configurationChain.callChain();
   },
   
   onError: function( error ){
      this.error = error;
      this.showWebUIExceptionPage( this.error );
   },
	
   restoreComponentsState : function(){
      this.logger.debug( this.options.componentName + ".restoreComponentsState() started." );
      this.stateManager.restore();
      if( window.location.hash.substring(2)) {
         var currentState = this.stateManager.toString();
         try {
            this.stateManager.parseUri( window.location.hash.substring(2) );
            this.messageBus.notifySubscribers( new WebUIStateRestoredMessage() );
         }catch( e ){
            this.stateManager.parse( currentState );
            this.logger.debug( "restoreComponentsState() exception: " + e );
         }
      }
      this.configurationChain.callChain();
   },
   
   storeComponentsState : function() {
      this.stateManager.persist();
      
	   var stateAsString = this.stateManager.toUri(); 
	   if( this.recentHash != stateAsString ){
	      this.recentHash = stateAsString;
	      window.location.hash = "!" + stateAsString;
	   }
   },
   
   webUIMessageHandler: function( webUIMessage ){
      if( !this.isConfigured ) throw new UnconfiguredWebUIControllerException({ source : 'WebUIController.webUIMessageHandler()' });
      
      if( instanceOf( webUIMessage, LanguageChangedMessage ) && webUIMessage.getNewLocale() != this.getCurrentLocale() ){
         this.changeLanguage( webUIMessage.getNewLocale() );
      }else if( instanceOf( webUIMessage, SkinChangedMessage )){
         this.changeSkin( webUIMessage.getNewSkin() );
      }else if( instanceOf( webUIMessage, MenuSelectedMessage ) && webUIMessage.getActionType() == 'changeSkin' ){
         this.changeSkin( webUIMessage.getProperty( 'skinName' ));
      }
      
      this.lastHandledMessage = webUIMessage;
   },

	//Properties
   getContextRootPrefix : function() { return this.contextRootPrefix; },
   getCurrentLocale : function () { return this.locale; },
   getCurrentSkin : function () { return this.skin; },
   getDesktop : function() { return this.desktop; },
   getIsConfigured : function() { return this.isConfigured; },
   getLanguageSelector : function() { return this.languageSelector; },
   getLocale : function() { return this.locale; },
   getLogger : function() { return this.logger; },
   getMessageBus : function() { return this.messageBus; },
   getPrefferedLanguage : function() { return this.prefferedLanguage; },
   getResourceBundle : function() { return this.resourceBundle; },
   getStateManager : function() { return this.stateManager; },
   getText : function( key, defaultValue ) { return this.getTextInternal( key, defaultValue  ); },
   getUserLocation : function() { return this.userLocation; },
   getUserName : function() { return this.userName; },
   getWebUIConfiguration : function() { return this.webUIConfiguration; },
   getWebUIException : function() { return this.webUiException; },
   setUserLocation : function( newLocation ) { this.userLocation = newLocation;},
   setUserName : function( newUserName ) { this.userName = newUserName;},
   setLanguage : function ( newLanguage ) { this.setLanguageInternal( newLanguage ); },
	
   //private methods
   browserIsSupported : function(){
      if( Browser.version >= this.options.compatibleBrowserVersions[Browser.name] ) return true;
      else return false;
   }.protect(),
   
   configureLogger : function() {		
      this.logger =  new WebUILogger( this.webUIConfiguration );
      this.logger.debug( this.options.componentName + ".configureLogger() started." );
      this.configurationChain.callChain();
   }.protect(),
	
   constructDesktop : function() {
      this.logger.debug( this.options.componentName + ".constructDesktop() started." );
      var desktopConfigurationUri = this.webUIConfiguration.getSkinConfiguration( this.skin );
      this.desktop = new Desktop( this.webUIConfiguration, this.resourceBundle, { configurationURI : desktopConfigurationUri, onConstructed : this.onDesktopConstructed, onError : this.onError } );
      this.desktop.unmarshall();
      try{
         this.desktop.construct();
      }catch( e ){
         this.onError( e );
      }
   }.protect(),
   
   destroySplashForm : function(){
      if( this.splashForm ) this.splashForm.destroy();
      this.configurationChain.callChain();
   }.protect(),
	
   determineCurrentHash: function() {
      if( window.location.hash.indexOf( "#" ) != -1 )
         return window.location.hash.substring(1);
      else return "";
   }.protect(),
	
   determineCurrentUserLocale : function() {
      this.logger.debug( this.options.componentName + ".determineCurrentUserLocale() started." );
      var browserLanguage = new ProcessPuzzleLocale();
      browserLanguage.parse( navigator.language || navigator.userLanguage );
      browserLanguage.options.country = null;
      browserLanguage.options.variant = null;
      if( this.locale == null ){
         var storedState = this.stateManager.retrieveComponentState( this.options.componentName ); 
         if( storedState ) {
            var localeString = storedState['locale'];
            this.locale = new ProcessPuzzleLocale();
            this.locale.parse( localeString );
         }else if( this.webUIConfiguration.isSupportedLocale( browserLanguage )){
            this.locale = browserLanguage;
         }else {
            this.locale = new ProcessPuzzleLocale();
            this.locale.parse( this.webUIConfiguration.getI18DefaultLocale() );
         }
      }
      this.configurationChain.callChain();
   }.protect(),
	
   determineDefaultSkin : function(){
      this.skin = this.webUIConfiguration.getDefaultSkin();
   }.protect(),
   
   finalizeConfiguration: function(){
      this.refreshUrlTimer = this.storeComponentsState.periodical( this.options.urlRefreshPeriod, this );
      this.isConfigured = true;
      this.fireEvent( 'configured', this, this.options.eventFireDelay );
   }.protect(),

   getTextInternal : function ( key, defaultValue ) {
      if( this.resourceBundle == null)
         if( defaultValue != null ) return defaultValue;
         else return key;
      var returnValue;
      try {
         returnValue = this.resourceBundle.getText(key);
      } catch (e) {
         if( e instanceof IllegalArgumentException ) {
            if(defaultValue != null) return defaultValue;
            return key;
         } else {
            var exception = new UserException( "Unknown problem occured.", "WebUIController getText()" );
            throw exception;
         }
      }
      return returnValue;	
   }.protect(),
   
   instantiateComponentStateManager : function(){
      var applicationSpecificName = this.webUIConfiguration.getApplicationName();
      applicationSpecificName += "." + this.webUIConfiguration.getApplicationVersion();
      applicationSpecificName += ".ComponentStateManager";
      this.stateManager = new ComponentStateManager({ componentName : applicationSpecificName });
   }.protect(),
	
   loadInternationalizations : function () {
      this.logger.debug( this.options.componentName + ".loadInternationalizations() started." );
      try{
         this.resourceBundle = new XMLResourceBundle( this.webUIConfiguration );
         this.resourceBundle.load( this.locale );
         this.logger.debug( "Resource bundles: " + this.options.contextRootPrefix + this.resourceBundle.getResourceBundleNames() + " was loaded." );
      }catch( e ) {
         this.onError( e );
      }
      this.configurationChain.callChain();
   }.protect(),
   
   loadWebUIConfiguration : function() {
      try{
         this.webUIConfiguration = new WebUIConfiguration( this.options.configurationUri );
         if( !this.webUIConfiguration.isLoaded ) this.webUIConfiguration.load();
      }catch( e ){
         this.onError( e );
      }
      this.configurationChain.callChain();
   }.protect(),

   setLanguage : function( newLanguage ) {
      this.logger.debug( this.options.componentName + ".setLanguage() started." );
      prefferedLanguage = newLanguage;
      if(newLanguage != null) {
         var locale = new ProcessPuzzleLocale(newLanguage);
         if( applicationConfiguration != null) {
            applicationConfiguration.setLocale(locale);
            this.loadInternationalizations(applicationConfiguration.getBundlePath(),locale);
         }
      }
   }.protect(),
   
   showSplashForm : function(){
      this.splashForm = new SplashForm({ imageUri : this.options.splashFormUri });
      this.splashForm.construct();
   }.protect(),
	
   showWebUIExceptionPage : function( exception ) {
      var bodyElement = $$( 'body' );
      this.warningContainer = new Element( 'div', { id: 'warning'} );
      bodyElement.grab( this.warningContainer, 'top' );
      
      var warningHeader = new Element( 'h1' );
      warningHeader.appendText( "Error Occured" );
      this.warningContainer.grab( warningHeader );
      
      var warningNameElement = new Element( 'h3' );
      warningNameElement.appendText( exception.name );
      this.warningContainer.grab( warningNameElement );
      
      var messageElement = new Element( 'p' );
      messageElement.appendText( exception.message );
      this.warningContainer.grab( messageElement );
      
      var stackElement = new Element( 'p' );
      if( exception.stack ) {
         stackElement.appendText( exception.stack );
         this.warningContainer.grab( stackElement );
      }
   }.protect(),
	
   storeWebUIState : function() {
      this.logger.debug( this.options.componentName + ".storeWebUIState() started." );
      this.stateManager.storeComponentState( this.options.componentName, {locale : this.locale.toString()} );
      this.configurationChain.callChain();
   }.protect(),
   
   subscribeToWebUIMessages: function() {
      this.logger.debug( this.options.componentName + ".subscribeToWebUIMessages() started." );
      this.messageBus.subscribeToMessage( LanguageChangedMessage, this.webUIMessageHandler );
      this.messageBus.subscribeToMessage( MenuSelectedMessage, this.webUIMessageHandler );
      this.messageBus.subscribeToMessage( SkinChangedMessage, this.webUIMessageHandler );
      //this.messageBus.subscribeToMessage( MenuSelectedMessage, this.webUIMessageHandler );
      this.configurationChain.callChain();
   }.protect(),
   
   updateOptionsWithConfiguration: function(){
      this.options.eraseStateWhenSkinChange = this.webUIConfiguration.getEraseStateWhenSkinChange();
   }
});
/*
ProcessPuzzle User Interface
Backend agnostic, desktop like configurable, browser font-end based on MochaUI.
Copyright (C) 2011  Joe Kueser, Zsolt Zsuffa

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/





var WebUIStateRestoredMessage = new Class({
   Extends: WebUIMessage,
   options: {
      description: "State of Web User Interface restored from URL.",
      name: "WebUIStateRestoredMessage"
   },
      
   initialize: function( options ){
      this.setOptions( options );
      this.options.messageClass = WebUIStateRestoredMessage;
   }
});

//TestMessageOne.js




var TestMessageOne = new Class({
   Extends: WebUIMessage,
   options: {
      description: "Test Message One description",
      name: "Test Message One"
   },
      
   initialize: function( options ){
      this.setOptions( options );
      this.options.messageClass = TestMessageOne;
   }
});

//TestMessageTwo.js




var TestMessageTwo = new Class({
   Extends: WebUIMessage,
   options: {
      description: "Test Message Two description",
      name: "Test Message Two"
   },
      
   initialize: function( options ){
      this.setOptions( options );
      this.options.messageClass = TestMessageTwo;
   }
});



































